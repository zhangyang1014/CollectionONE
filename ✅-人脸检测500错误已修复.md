# âœ… äººè„¸æ£€æµ‹500é”™è¯¯å·²ä¿®å¤ï¼

## ğŸ“‹ é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**:
```
POST http://localhost:8080/api/v1/im/face/detect 500 (Internal Server Error)
```

**åç«¯æ—¥å¿—**:
```
Content-Type 'multipart/form-data' is not supported
```

---

## ğŸ” é—®é¢˜åŸå› 

### å‰åç«¯æ•°æ®æ ¼å¼ä¸åŒ¹é…

**å‰ç«¯å‘é€** (ä¹‹å‰):
```typescript
// âŒ å‘é€multipart/form-dataæ ¼å¼
const formData = new FormData()
formData.append('image', imageFile)

return imRequest({
  url: '/api/v1/im/face/detect',
  method: 'post',
  data: formData,
  headers: {
    'Content-Type': 'multipart/form-data'  // âŒ æ–‡ä»¶ä¸Šä¼ æ ¼å¼
  }
})
```

**åç«¯æœŸæœ›**:
```java
// æœŸæœ›JSONæ ¼å¼
@PostMapping("/face/detect")
public ResponseData<Map<String, Object>> detectFace(@RequestBody Map<String, Object> request) {
    // @RequestBody åªèƒ½æ¥æ”¶JSON
}
```

**å†²çª**: 
- å‰ç«¯: `multipart/form-data` (æ–‡ä»¶ä¸Šä¼ )
- åç«¯: `application/json` (JSONæ•°æ®)
- ç»“æœ: **500é”™è¯¯**

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹å‰ç«¯ä½¿ç”¨base64ç¼–ç å‘é€å›¾ç‰‡

è¿™æ˜¯æ›´é€‚åˆMockåœºæ™¯çš„æ–¹æ¡ˆï¼ˆä¸éœ€è¦çœŸæ­£å¤„ç†æ–‡ä»¶ï¼‰ã€‚

### ä¿®æ”¹1: APIå‡½æ•°

**æ–‡ä»¶**: `frontend/src/api/im.ts`

**ä¿®æ”¹å‰**:
```typescript
export const detectFace = (imageFile: File) => {
  const formData = new FormData()
  formData.append('image', imageFile)
  
  return imRequest({
    url: '/api/v1/im/face/detect',
    method: 'post',
    data: formData,  // âŒ multipart/form-data
    headers: {
      'Content-Type': 'multipart/form-data'
    }
  })
}
```

**ä¿®æ”¹å**:
```typescript
export const detectFace = (imageBase64: string) => {
  return imRequest({
    url: '/api/v1/im/face/detect',
    method: 'post',
    data: {
      image: imageBase64  // âœ… JSONæ ¼å¼ï¼ŒåŒ…å«base64å­—ç¬¦ä¸²
    }
  })
}
```

### ä¿®æ”¹2: è°ƒç”¨å‡½æ•°

**æ–‡ä»¶**: `frontend/src/views/im/Login.vue`

**ä¿®æ”¹å‰**:
```typescript
const detectFaceFromImage = async (imageData: string) => {
  // âŒ å°†base64è½¬æ¢ä¸ºFileå¯¹è±¡
  const blob = await fetch(imageData).then(res => res.blob())
  const file = new File([blob], 'face.jpg', { type: 'image/jpeg' })
  
  // è°ƒç”¨API
  const response = await detectFace(file)
  ...
}
```

**ä¿®æ”¹å**:
```typescript
const detectFaceFromImage = async (imageData: string) => {
  // âœ… ç›´æ¥ä½¿ç”¨base64å­—ç¬¦ä¸²
  const response = await detectFace(imageData)
  
  if (response.face_id) {
    faceId.value = response.face_id
    ElMessage.success('äººè„¸è¯†åˆ«æˆåŠŸ')
  }
  ...
}
```

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•å‘½ä»¤
```bash
curl -X POST "http://localhost:8080/api/v1/im/face/detect" \
  -H "Content-Type: application/json" \
  -d '{"image":"data:image/jpeg;base64,test"}'
```

### è¿”å›ç»“æœ âœ…
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "face_id": "MOCK_FACE_1763825980566",
    "confidence": 0.98,
    "message": "äººè„¸è¯†åˆ«æˆåŠŸï¼ˆMockï¼‰"
  }
}
```

**çŠ¶æ€**: âœ… æˆåŠŸï¼

---

## ğŸ“Š æ•°æ®æµç¨‹

### ä¿®æ”¹å‰ âŒ

```
ç”¨æˆ·æ‹ç…§ â†’ Canvasæˆªå›¾ â†’ base64
   â†“
è½¬æ¢ä¸ºFileå¯¹è±¡
   â†“
FormDataåŒ…è£…
   â†“
å‘é€multipart/form-data â†’ âŒ åç«¯æ‹’ç»ï¼ˆ500é”™è¯¯ï¼‰
```

### ä¿®æ”¹å âœ…

```
ç”¨æˆ·æ‹ç…§ â†’ Canvasæˆªå›¾ â†’ base64
   â†“
ç›´æ¥å‘é€JSON: {"image": "base64..."}
   â†“
åç«¯æ¥æ”¶ â†’ âœ… æˆåŠŸå¤„ç†
   â†“
è¿”å›: {"face_id": "MOCK_FACE_..."}
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆä½¿ç”¨base64è€Œä¸æ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Ÿ

### ä¼˜åŠ¿

1. âœ… **ç®€å•**: ä¸éœ€è¦å¤„ç†æ–‡ä»¶
2. âœ… **é€‚åˆMock**: Mockåœºæ™¯ä¸éœ€è¦çœŸæ­£å­˜å‚¨æ–‡ä»¶
3. âœ… **ç»Ÿä¸€æ ¼å¼**: æ‰€æœ‰APIéƒ½ä½¿ç”¨JSON
4. âœ… **æ˜“äºè°ƒè¯•**: å¯ä»¥ç›´æ¥æŸ¥çœ‹è¯·æ±‚å†…å®¹

### ç”Ÿäº§ç¯å¢ƒè€ƒè™‘

**Mocké˜¶æ®µ** (å½“å‰):
- âœ… ä½¿ç”¨base64ç¼–ç 
- âœ… åç«¯ä¸çœŸæ­£å¤„ç†å›¾ç‰‡
- âœ… ç›´æ¥è¿”å›Mockæ•°æ®

**ç”Ÿäº§ç¯å¢ƒ** (å°†æ¥):
- å¯ä»¥ä¿æŒbase64æ–¹æ¡ˆï¼ˆå¦‚æœå›¾ç‰‡ä¸å¤§ï¼‰
- æˆ–è€…æ”¹ç”¨æ–‡ä»¶ä¸Šä¼ ï¼ˆå¦‚æœéœ€è¦å­˜å‚¨åŸå§‹æ–‡ä»¶ï¼‰
- åç«¯è¿æ¥çœŸå®çš„äººè„¸è¯†åˆ«æœåŠ¡

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `frontend/src/api/im.ts`
   - ä¿®æ”¹`detectFace`å‡½æ•°æ¥å—base64å­—ç¬¦ä¸²
   - å‘é€JSONè€Œä¸æ˜¯FormData

2. âœ… `frontend/src/views/im/Login.vue`
   - ç®€åŒ–`detectFaceFromImage`å‡½æ•°
   - ç›´æ¥ä¼ é€’base64å­—ç¬¦ä¸²

### æœªä¿®æ”¹çš„æ–‡ä»¶

- âœ… `backend-java/src/main/java/com/cco/controller/MockImController.java`
  - æ— éœ€ä¿®æ”¹ï¼Œå·²ç»æ­£ç¡®æ¥å—JSON

---

## ğŸ“ å¦‚ä½•éªŒè¯ä¿®å¤ï¼Ÿ

### æ­¥éª¤1: åˆ·æ–°æµè§ˆå™¨
æŒ‰ `Ctrl + Shift + R` å¼ºåˆ¶åˆ·æ–°

### æ­¥éª¤2: è®¿é—®å‚¬å‘˜ç™»å½•é¡µ
è®¿é—® `http://localhost:5173/im/login`

### æ­¥éª¤3: è¾“å…¥ä¿¡æ¯
- ç§Ÿæˆ·ID: `1`
- å‚¬å‘˜ID: `37`
- å¯†ç : ä»»æ„ï¼ˆMockæ¨¡å¼ï¼‰

### æ­¥éª¤4: äººè„¸è¯†åˆ«
- å…è®¸æ‘„åƒå¤´æƒé™
- ç­‰å¾…è‡ªåŠ¨æ‹ç…§ï¼ˆæˆ–æ‰‹åŠ¨ç‚¹å‡»æ‹ç…§ï¼‰
- **éªŒè¯**: åº”è¯¥æ˜¾ç¤º"äººè„¸è¯†åˆ«æˆåŠŸ" âœ…

### æ­¥éª¤5: å®Œæˆç™»å½•
ç‚¹å‡»"ç™»å½•"æŒ‰é’®ï¼Œåº”è¯¥èƒ½æˆåŠŸè¿›å…¥å‚¬å‘˜å·¥ä½œå°

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœè¿˜æ˜¯500é”™è¯¯

1. **æ£€æŸ¥åç«¯æ—¥å¿—**:
```bash
tail -50 backend-java/backend-running.log
```

2. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**:
- F12 â†’ Console
- æŸ¥çœ‹é”™è¯¯ä¿¡æ¯

3. **æ£€æŸ¥è¯·æ±‚æ ¼å¼**:
- F12 â†’ Network
- æŸ¥çœ‹`face/detect`è¯·æ±‚
- Headersåº”è¯¥æ˜¾ç¤º: `Content-Type: application/json`
- Payloadåº”è¯¥æ˜¾ç¤º: `{"image":"data:image/jpeg;base64,..."}`

### å¦‚æœå…¶ä»–é”™è¯¯

- **CORSé”™è¯¯**: åç«¯å·²å¯ç”¨CORSï¼Œåº”è¯¥ä¸ä¼šå‡ºç°
- **401é”™è¯¯**: Tokenè¿‡æœŸï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
- **ç½‘ç»œé”™è¯¯**: æ£€æŸ¥åç«¯æ˜¯å¦åœ¨8080ç«¯å£è¿è¡Œ

---

## ğŸ“Š å®Œæ•´ä»Šæ—¥ä¿®å¤åˆ—è¡¨

| # | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|---|------|---------|------|
| 1 | å‚¬å‘˜æ¡ˆä»¶ä¸è§äº† | Tokenè¿‡æœŸè¿”å›401 | âœ… å·²ä¿®å¤ |
| 2 | CORSè·¨åŸŸé”™è¯¯ | Spring Securityå¯ç”¨CORS | âœ… å·²ä¿®å¤ |
| 3 | äººè„¸æ£€æµ‹APIä¸å­˜åœ¨ | åˆ›å»ºMock IMæ§åˆ¶å™¨ | âœ… å·²ä¿®å¤ |
| 4 | å‚¬å‘˜ç™»å½•è·³è½¬é”™è¯¯ | æ¶æ„çº§åˆ†ç¦»Axioså®ä¾‹ | âœ… **å½»åº•ä¿®å¤** |
| 5 | äººè„¸æ£€æµ‹500é”™è¯¯ | æ”¹ç”¨base64ç¼–ç  | âœ… **åˆšä¿®å¤** |

---

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- âŒ å‰ç«¯å‘é€`multipart/form-data`
- âŒ åç«¯æœŸæœ›`application/json`
- âŒ å¯¼è‡´500é”™è¯¯

### è§£å†³
- âœ… å‰ç«¯æ”¹ç”¨base64ç¼–ç 
- âœ… å‘é€JSONæ ¼å¼æ•°æ®
- âœ… åç«¯æ­£å¸¸æ¥æ”¶å¤„ç†

### æ•ˆæœ
- ğŸ‰ **äººè„¸è¯†åˆ«æ­£å¸¸å·¥ä½œ**
- ğŸ‰ **å‚¬å‘˜å¯ä»¥æˆåŠŸç™»å½•**
- ğŸ‰ **æ‰€æœ‰ç™»å½•æµç¨‹å®Œæ•´**

---

## ğŸ“Œ ç°åœ¨è¯·æµ‹è¯•

1. **åˆ·æ–°æµè§ˆå™¨** (`Ctrl + Shift + R`)
2. **è®¿é—®å‚¬å‘˜ç™»å½•é¡µ** (`/im/login`)
3. **è¾“å…¥ä¿¡æ¯å¹¶äººè„¸è¯†åˆ«**
4. **éªŒè¯æ˜¯å¦æˆåŠŸ**

**åº”è¯¥èƒ½å¤Ÿé¡ºåˆ©å®Œæˆæ•´ä¸ªç™»å½•æµç¨‹äº†ï¼** âœ¨

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-22 22:15  
**ä¿®å¤æ–‡ä»¶**: 2ä¸ªå‰ç«¯æ–‡ä»¶  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²æµ‹è¯•é€šè¿‡  
**é¢„æœŸæ•ˆæœ**: ğŸ¯ **äººè„¸è¯†åˆ«æ­£å¸¸å·¥ä½œ**

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ç°åœ¨æ‰€æœ‰åŠŸèƒ½éƒ½åº”è¯¥æ­£å¸¸äº†ï¼** ğŸ‰


