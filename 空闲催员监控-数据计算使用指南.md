# ç©ºé—²å‚¬å‘˜ç›‘æ§ - æ•°æ®è®¡ç®—ä½¿ç”¨æŒ‡å—

## ğŸ‰ åŠŸèƒ½å·²å®Œæ•´é›†æˆï¼

æ•°æ®è®¡ç®—å¼•æ“ç°å·²å®Œæˆï¼Œæ‚¨å¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨ç©ºé—²å‚¬å‘˜ç›‘æ§åŠŸèƒ½ã€‚

---

## ğŸ“‹ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥éª¤ï¼‰

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“è¡¨

```bash
cd backend
python3 create_idle_monitor_tables.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… ç©ºé—²ç›‘æ§æ•°æ®è¡¨åˆ›å»ºæˆåŠŸï¼

åˆ›å»ºçš„è¡¨:
  - idle_monitor_configs (ç©ºé—²ç›‘æ§é…ç½®è¡¨)
  - collector_idle_records (å‚¬å‘˜ç©ºé—²è®°å½•è¡¨)
  - collector_idle_stats (å‚¬å‘˜ç©ºé—²ç»Ÿè®¡è¡¨)
```

### æ­¥éª¤2ï¼šç”Ÿæˆæµ‹è¯•æ•°æ®

```bash
# ä¸ºç”²æ–¹ID=1ç”Ÿæˆä»Šå¤©çš„æµ‹è¯•æ•°æ®ï¼ˆ5ä¸ªå‚¬å‘˜ï¼‰
python3 generate_test_idle_data.py --tenant-id 1

# æˆ–æŒ‡å®šæ—¥æœŸå’Œå‚¬å‘˜æ•°é‡
python3 generate_test_idle_data.py --tenant-id 1 --date 2025-11-20 --collectors 10
```

**é¢„æœŸè¾“å‡ºï¼š**
```
============================================================
ğŸ² å¼€å§‹ç”Ÿæˆæµ‹è¯•æ•°æ®
============================================================
ç”²æ–¹ID: 1
æµ‹è¯•æ—¥æœŸ: 2025-11-20
å‚¬å‘˜æ•°é‡: 5
============================================================

ğŸ“Š æ‰¾åˆ° 5 ä¸ªå‚¬å‘˜ç”¨äºæµ‹è¯•
   ç”Ÿæˆå‚¬å‘˜æ•°æ®: å¼ ä¸‰ (ID: 1)
   âœ… ç”Ÿæˆ 45 æ¡é€šä¿¡è®°å½•
   ç”Ÿæˆå‚¬å‘˜æ•°æ®: æå›› (ID: 2)
   âœ… ç”Ÿæˆ 38 æ¡é€šä¿¡è®°å½•
   ...

============================================================
âœ… ç”Ÿæˆå®Œæˆï¼
============================================================
æˆåŠŸ: 5/5 ä¸ªå‚¬å‘˜

ğŸ’¡ ä¸‹ä¸€æ­¥: è¿è¡Œè®¡ç®—è„šæœ¬
   python calculate_idle_data.py --tenant-id 1 --date 2025-11-20
============================================================
```

### æ­¥éª¤3ï¼šè®¡ç®—ç©ºé—²æ•°æ®

```bash
# è®¡ç®—ä»Šå¤©çš„æ•°æ®
python3 calculate_idle_data.py --tenant-id 1

# æˆ–æŒ‡å®šæ—¥æœŸ
python3 calculate_idle_data.py --tenant-id 1 --date 2025-11-20

# æˆ–è®¡ç®—æœ€è¿‘7å¤©
python3 calculate_idle_data.py --tenant-id 1 --days 7
```

**é¢„æœŸè¾“å‡ºï¼š**
```
============================================================
ğŸš€ å¼€å§‹è®¡ç®—ç©ºé—²æ•°æ®
============================================================
ç”²æ–¹ID: 1
è®¡ç®—æ—¥æœŸ: 2025-11-20
ç©ºé—²é˜ˆå€¼: 30 åˆ†é’Ÿ
ä¸Šç­æ—¶é—´: [{'start': '09:00', 'end': '12:00'}, {'start': '14:00', 'end': '18:00'}]
ç›‘æ§è¡Œä¸º: ['call', 'whatsapp', 'rcs', 'sms', 'email', 'case_update', 'login']
============================================================

ğŸ“Š æ‰¾åˆ° 5 ä¸ªæ´»è·ƒå‚¬å‘˜
   è®¡ç®—å‚¬å‘˜: å¼ ä¸‰ (ID: 1)
   å‚¬å‘˜ 1: æ‰¾åˆ° 45 æ¡è¡Œä¸ºè®°å½•
   âš ï¸  å‘ç° 2 ä¸ªç©ºé—²æ—¶æ®µ
   
   è®¡ç®—å‚¬å‘˜: æå›› (ID: 2)
   å‚¬å‘˜ 2: æ‰¾åˆ° 38 æ¡è¡Œä¸ºè®°å½•
   âš ï¸  å‘ç° 1 ä¸ªç©ºé—²æ—¶æ®µ
   ...

============================================================
âœ… è®¡ç®—å®Œæˆï¼
============================================================
æˆåŠŸ: 5/5 ä¸ªå‚¬å‘˜
============================================================
```

---

## ğŸ” æŸ¥çœ‹ç»“æœ

### æ–¹å¼1ï¼šé€šè¿‡Webç•Œé¢ï¼ˆæ¨èï¼‰

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:5173`
2. ç™»å½•ç³»ç»Ÿ
3. é€‰æ‹©ç”²æ–¹ï¼ˆå³ä¸Šè§’ä¸‹æ‹‰æ¡†ï¼‰
4. ç‚¹å‡»èœå•ï¼š**æ•°æ®çœ‹æ¿ > ç©ºé—²å‚¬å‘˜ç›‘æ§**

æ‚¨å°†çœ‹åˆ°ï¼š
- âœ… ç©ºé—²å‚¬å‘˜æ€»æ•°
- âœ… ç©ºé—²æ€»æ¬¡æ•°
- âœ… ç©ºé—²æ€»æ—¶é•¿
- âœ… è¶‹åŠ¿å›¾è¡¨
- âœ… è¯¦æƒ…åˆ—è¡¨ï¼ˆå¯å±•å¼€æŸ¥çœ‹ç©ºé—²æ—¶æ®µï¼‰

### æ–¹å¼2ï¼šé€šè¿‡æ•°æ®åº“æŸ¥è¯¢

```sql
-- æŸ¥çœ‹ç©ºé—²ç»Ÿè®¡
SELECT 
    c.collector_name,
    s.stat_date,
    s.idle_count,
    s.total_idle_minutes,
    s.idle_rate
FROM collector_idle_stats s
JOIN collectors c ON s.collector_id = c.id
WHERE s.stat_date = '2025-11-20'
ORDER BY s.idle_count DESC;

-- æŸ¥çœ‹ç©ºé—²æ—¶æ®µè¯¦æƒ…
SELECT 
    c.collector_name,
    r.idle_date,
    r.idle_start_time,
    r.idle_end_time,
    r.idle_duration_minutes
FROM collector_idle_records r
JOIN collectors c ON r.collector_id = c.id
WHERE r.idle_date = '2025-11-20'
ORDER BY r.idle_duration_minutes DESC;
```

---

## ğŸ“Š è„šæœ¬è¯¦ç»†è¯´æ˜

### 1. create_idle_monitor_tables.py

**åŠŸèƒ½**ï¼šåˆ›å»ºæ•°æ®åº“è¡¨

**ä½¿ç”¨åœºæ™¯**ï¼šé¦–æ¬¡å®‰è£…æ—¶æ‰§è¡Œä¸€æ¬¡

**è¡¨ç»“æ„**ï¼š
- `idle_monitor_configs` - ç©ºé—²å®šä¹‰é…ç½®
- `collector_idle_records` - ç©ºé—²æ—¶æ®µæ˜ç»†è®°å½•
- `collector_idle_stats` - æŒ‰æ—¥ç»Ÿè®¡æ•°æ®

---

### 2. generate_test_idle_data.py

**åŠŸèƒ½**ï¼šç”Ÿæˆæ¨¡æ‹Ÿçš„é€šä¿¡è®°å½•æ•°æ®

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼š
- æ–°ç³»ç»Ÿå¯èƒ½æ²¡æœ‰çœŸå®çš„é€šä¿¡è®°å½•
- å¯ä»¥å¿«é€ŸéªŒè¯åŠŸèƒ½
- å¯ä»¥æ¼”ç¤ºç»™å®¢æˆ·çœ‹

**ç”Ÿæˆçš„æ•°æ®**ï¼š
- æ¨¡æ‹Ÿä¸€å¤©çš„å·¥ä½œè¡Œä¸ºï¼ˆæ‰“ç”µè¯ã€å‘æ¶ˆæ¯ç­‰ï¼‰
- æ•…æ„åˆ¶é€ ä¸€äº›ç©ºé—²æ—¶æ®µï¼ˆ30-60åˆ†é’Ÿï¼‰
- çœŸå®çš„æ—¶é—´åˆ†å¸ƒï¼ˆä¸Šåˆ9-12ç‚¹ï¼Œä¸‹åˆ2-6ç‚¹ï¼‰

**å‚æ•°è¯´æ˜**ï¼š
```bash
python3 generate_test_idle_data.py \
  --tenant-id 1        # å¿…å¡«ï¼šç”²æ–¹ID
  --date 2025-11-20    # å¯é€‰ï¼šæ—¥æœŸï¼Œé»˜è®¤ä»Šå¤©
  --collectors 5       # å¯é€‰ï¼šå‚¬å‘˜æ•°é‡ï¼Œé»˜è®¤5ä¸ª
```

**æ³¨æ„äº‹é¡¹**ï¼š
1. éœ€è¦å·²æœ‰å‚¬å‘˜æ•°æ®ï¼ˆè‡³å°‘æœ‰1ä¸ªå‚¬å‘˜ï¼‰
2. éœ€è¦å·²æœ‰æ¡ˆä»¶æ•°æ®ï¼ˆè‡³å°‘æœ‰1ä¸ªæ¡ˆä»¶ï¼‰
3. éœ€è¦å·²æœ‰è”ç³»äººæ•°æ®ï¼ˆè‡³å°‘æœ‰1ä¸ªè”ç³»äººï¼‰
4. é‡å¤è¿è¡Œä¼šè¦†ç›–å½“å¤©çš„æ•°æ®

---

### 3. calculate_idle_data.py

**åŠŸèƒ½**ï¼šè®¡ç®—ç©ºé—²æ•°æ®çš„æ ¸å¿ƒå¼•æ“

**ç®—æ³•é€»è¾‘**ï¼š
1. è¯»å–ç©ºé—²é…ç½®ï¼ˆé˜ˆå€¼ã€ç›‘æ§è¡Œä¸ºã€ä¸Šç­æ—¶é—´ï¼‰
2. è·å–å‚¬å‘˜åˆ—è¡¨
3. å¯¹æ¯ä¸ªå‚¬å‘˜ï¼š
   - è·å–å½“å¤©æ‰€æœ‰è¡Œä¸ºè®°å½•
   - æŒ‰æ—¶é—´æ’åº
   - è®¡ç®—ç›¸é‚»è¡Œä¸ºçš„æ—¶é—´é—´éš”
   - å¦‚æœé—´éš” >= é˜ˆå€¼ï¼Œä¸”åœ¨ä¸Šç­æ—¶é—´å†…ï¼Œè®°å½•ä¸ºç©ºé—²
4. è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼ˆæ¬¡æ•°ã€æ—¶é•¿ã€ç©ºé—²ç‡ç­‰ï¼‰
5. ä¿å­˜åˆ°æ•°æ®åº“

**å‚æ•°è¯´æ˜**ï¼š
```bash
python3 calculate_idle_data.py \
  --tenant-id 1        # å¿…å¡«ï¼šç”²æ–¹ID
  --date 2025-11-20    # å¯é€‰ï¼šæ—¥æœŸï¼Œé»˜è®¤æ˜¨å¤©
  --days 7             # å¯é€‰ï¼šè®¡ç®—æœ€è¿‘Nå¤©ï¼Œé»˜è®¤1å¤©
```

**æ•°æ®æº**ï¼š
- é€šä¿¡è®°å½•è¡¨ï¼ˆ`communication_records`ï¼‰
- å¯æ‰©å±•ï¼šæ¡ˆä»¶æ“ä½œæ—¥å¿—ã€ç™»å½•æ—¥å¿—ç­‰

**è¾“å‡º**ï¼š
- ç©ºé—²è®°å½•è¡¨ï¼ˆ`collector_idle_records`ï¼‰
- ç©ºé—²ç»Ÿè®¡è¡¨ï¼ˆ`collector_idle_stats`ï¼‰

---

## ğŸ”„ å®šæ—¶ä»»åŠ¡è®¾ç½®

### æ–¹å¼1ï¼šä½¿ç”¨ Crontabï¼ˆLinux/Macï¼‰

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨00:30æ‰§è¡Œï¼‰
30 0 * * * cd /path/to/backend && python3 calculate_idle_data.py --tenant-id 1 >> /var/log/idle_calc.log 2>&1
```

### æ–¹å¼2ï¼šä½¿ç”¨ APSchedulerï¼ˆPythonï¼‰

åˆ›å»º `backend/scheduler_idle.py`ï¼š

```python
from apscheduler.schedulers.blocking import BlockingScheduler
from calculate_idle_data import IdleCalculator
from app.core.database import get_db
from datetime import date, timedelta

def daily_calculation():
    """æ¯æ—¥è®¡ç®—ä»»åŠ¡"""
    calc_date = date.today() - timedelta(days=1)
    db = next(get_db())
    try:
        calculator = IdleCalculator(db, tenant_id=1, calc_date=calc_date)
        calculator.run()
    finally:
        db.close()

scheduler = BlockingScheduler()
scheduler.add_job(daily_calculation, 'cron', hour=0, minute=30)

if __name__ == '__main__':
    print("å¯åŠ¨ç©ºé—²æ•°æ®è®¡ç®—è°ƒåº¦å™¨...")
    scheduler.start()
```

è¿è¡Œï¼š
```bash
python3 scheduler_idle.py
```

### æ–¹å¼3ï¼šä½¿ç”¨ Celeryï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

é…ç½® Celery ä»»åŠ¡åï¼Œæ·»åŠ ï¼š

```python
@celery.task
def calculate_idle_data_task(tenant_id: int, calc_date: str):
    from calculate_idle_data import IdleCalculator
    from datetime import datetime
    
    calc_date = datetime.strptime(calc_date, '%Y-%m-%d').date()
    db = next(get_db())
    try:
        calculator = IdleCalculator(db, tenant_id, calc_date)
        calculator.run()
    finally:
        db.close()
```

---

## ğŸ“ˆ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ—¥å¸¸ç›‘æ§

```bash
# æ¯å¤©æ‰‹åŠ¨è¿è¡Œä¸€æ¬¡ï¼Œè®¡ç®—æ˜¨å¤©çš„æ•°æ®
python3 calculate_idle_data.py --tenant-id 1
```

### åœºæ™¯2ï¼šå†å²æ•°æ®è¡¥ç®—

```bash
# è¡¥ç®—æœ€è¿‘30å¤©çš„æ•°æ®
python3 calculate_idle_data.py --tenant-id 1 --days 30
```

### åœºæ™¯3ï¼šç‰¹å®šæ—¥æœŸåˆ†æ

```bash
# åˆ†ææŸä¸ªç‰¹å®šæ—¥æœŸ
python3 calculate_idle_data.py --tenant-id 1 --date 2025-11-15
```

### åœºæ™¯4ï¼šå¤šç”²æ–¹è®¡ç®—

```bash
# ä¸ºå¤šä¸ªç”²æ–¹åˆ†åˆ«è®¡ç®—
python3 calculate_idle_data.py --tenant-id 1
python3 calculate_idle_data.py --tenant-id 2
python3 calculate_idle_data.py --tenant-id 3
```

---

## âš™ï¸ é…ç½®ç®¡ç†

### ä¿®æ”¹ç©ºé—²å®šä¹‰

**æ–¹å¼1ï¼šé€šè¿‡Webç•Œé¢ï¼ˆæ¨èï¼‰**
1. è¿›å…¥ç©ºé—²å‚¬å‘˜ç›‘æ§é¡µé¢
2. ç‚¹å‡»"ç©ºé—²é…ç½®"æŒ‰é’®
3. ä¿®æ”¹é…ç½®ï¼ˆé˜ˆå€¼ã€ç›‘æ§è¡Œä¸ºç­‰ï¼‰
4. ä¿å­˜

**æ–¹å¼2ï¼šç›´æ¥ä¿®æ”¹æ•°æ®åº“**
```sql
UPDATE idle_monitor_configs
SET idle_threshold_minutes = 45  -- ä¿®æ”¹é˜ˆå€¼ä¸º45åˆ†é’Ÿ
WHERE tenant_id = 1 AND is_active = true;
```

**æ–¹å¼3ï¼šåˆ›å»ºæ–°é…ç½®**
```sql
INSERT INTO idle_monitor_configs (
    tenant_id, config_name, work_time_slots, 
    idle_threshold_minutes, monitored_actions, 
    exclude_holidays, is_active
) VALUES (
    1, 'ä¸¥æ ¼ç›‘æ§è§„åˆ™',
    '[{"start":"08:30","end":"12:00"},{"start":"13:30","end":"18:30"}]',
    15,
    '["call","whatsapp","rcs","sms","email","case_update","login"]',
    true, true
);
```

### é…ç½®è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | å»ºè®®å€¼ |
|------|------|--------|--------|
| idle_threshold_minutes | ç©ºé—²é˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰ | 30 | 15-60 |
| work_time_slots | ä¸Šç­æ—¶é—´æ®µ | 9-12, 14-18 | æ ¹æ®å®é™…æƒ…å†µ |
| monitored_actions | ç›‘æ§è¡Œä¸º | å…¨éƒ¨ | è‡³å°‘åŒ…å«ä¸»è¦æ¸ é“ |
| exclude_holidays | æ’é™¤èŠ‚å‡æ—¥ | true | true |

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ²¡æœ‰æ•°æ®æ˜¾ç¤º

**å¯èƒ½åŸå› **ï¼š
1. æ²¡æœ‰è¿è¡Œè®¡ç®—è„šæœ¬
2. æ•°æ®åº“è¡¨æœªåˆ›å»º
3. æ²¡æœ‰è¡Œä¸ºè®°å½•æ•°æ®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
python3 -c "from app.core.database import engine; print(engine.table_names())"

# 2. ç”Ÿæˆæµ‹è¯•æ•°æ®
python3 generate_test_idle_data.py --tenant-id 1

# 3. è¿è¡Œè®¡ç®—
python3 calculate_idle_data.py --tenant-id 1

# 4. æŸ¥è¯¢ç»“æœ
python3 -c "from app.core.database import get_db; from app.models.collector_idle_record import CollectorIdleStats; db=next(get_db()); print(db.query(CollectorIdleStats).count())"
```

### é—®é¢˜2ï¼šè®¡ç®—å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
1. æ•°æ®åº“è¿æ¥å¤±è´¥
2. ç¼ºå°‘å¿…è¦çš„æ•°æ®ï¼ˆå‚¬å‘˜ã€æ¡ˆä»¶ç­‰ï¼‰
3. é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
python3 calculate_idle_data.py --tenant-id 1 2>&1 | tee calc.log

# æ£€æŸ¥å‚¬å‘˜æ•°æ®
python3 -c "from app.core.database import get_db; from app.models.collector import Collector; db=next(get_db()); print(f'å‚¬å‘˜æ•°é‡: {db.query(Collector).filter(Collector.tenant_id==1).count()}')"

# æ£€æŸ¥é€šä¿¡è®°å½•
python3 -c "from app.core.database import get_db; from app.models.communication_record import CommunicationRecord; db=next(get_db()); print(f'é€šä¿¡è®°å½•: {db.query(CommunicationRecord).count()}')"
```

### é—®é¢˜3ï¼šWebç•Œé¢æ˜¾ç¤ºä¸º0

**å¯èƒ½åŸå› **ï¼š
1. æ²¡æœ‰é€‰æ‹©ç”²æ–¹
2. æ—¥æœŸèŒƒå›´æ²¡æœ‰æ•°æ®
3. è®¡ç®—è„šæœ¬æœªè¿è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿å³ä¸Šè§’é€‰æ‹©äº†ç”²æ–¹
2. é€‰æ‹©æœ‰æ•°æ®çš„æ—¥æœŸèŒƒå›´
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. æ£€æŸ¥APIå“åº”ï¼š`curl "http://localhost:8000/api/v1/idle-monitor/summary?tenant_id=1&start_date=2025-11-20&end_date=2025-11-20"`

---

## ğŸ“ å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

### ä»é›¶å¼€å§‹çš„å®Œæ•´æµç¨‹

```bash
# 1. è¿›å…¥backendç›®å½•
cd backend

# 2. åˆ›å»ºæ•°æ®åº“è¡¨
python3 create_idle_monitor_tables.py

# 3. ç”Ÿæˆä»Šå¤©çš„æµ‹è¯•æ•°æ®ï¼ˆ10ä¸ªå‚¬å‘˜ï¼‰
python3 generate_test_idle_data.py --tenant-id 1 --collectors 10

# 4. è®¡ç®—ç©ºé—²æ•°æ®
python3 calculate_idle_data.py --tenant-id 1

# 5. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 6. åœ¨æ–°ç»ˆç«¯å¯åŠ¨å‰ç«¯ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
cd ../frontend
npm run dev

# 7. æ‰“å¼€æµè§ˆå™¨
# http://localhost:5173
# ç™»å½• > é€‰æ‹©ç”²æ–¹ > æ•°æ®çœ‹æ¿ > ç©ºé—²å‚¬å‘˜ç›‘æ§
```

---

## âœ¨ é«˜çº§åŠŸèƒ½

### 1. æ‰¹é‡å¤„ç†å¤šä¸ªç”²æ–¹

åˆ›å»ºè„šæœ¬ `batch_calculate.sh`ï¼š
```bash
#!/bin/bash
for tenant_id in 1 2 3 4 5; do
    echo "è®¡ç®—ç”²æ–¹ $tenant_id..."
    python3 calculate_idle_data.py --tenant-id $tenant_id
done
```

### 2. æ•°æ®å¯¼å‡º

```bash
# å¯¼å‡ºSQL
python3 -c "
from app.core.database import get_db
from app.models.collector_idle_record import CollectorIdleStats
import csv

db = next(get_db())
stats = db.query(CollectorIdleStats).all()

with open('idle_stats.csv', 'w') as f:
    writer = csv.writer(f)
    writer.writerow(['å‚¬å‘˜ID', 'æ—¥æœŸ', 'ç©ºé—²æ¬¡æ•°', 'æ€»æ—¶é•¿', 'ç©ºé—²ç‡'])
    for s in stats:
        writer.writerow([s.collector_id, s.stat_date, s.idle_count, 
                        s.total_idle_minutes, s.idle_rate])
"
```

### 3. æ€§èƒ½ç›‘æ§

```bash
# è®¡ç®—è€—æ—¶
time python3 calculate_idle_data.py --tenant-id 1 --days 30

# æŸ¥çœ‹æ•°æ®é‡
python3 -c "
from app.core.database import get_db
from app.models.collector_idle_record import CollectorIdleRecord, CollectorIdleStats

db = next(get_db())
print(f'ç©ºé—²è®°å½•: {db.query(CollectorIdleRecord).count()}')
print(f'ç»Ÿè®¡è®°å½•: {db.query(CollectorIdleStats).count()}')
"
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§å‘½ä»¤é€ŸæŸ¥

```bash
# åˆ›å»ºè¡¨
python3 create_idle_monitor_tables.py

# ç”Ÿæˆæµ‹è¯•æ•°æ®
python3 generate_test_idle_data.py --tenant-id 1

# è®¡ç®—ä»Šå¤©
python3 calculate_idle_data.py --tenant-id 1

# è®¡ç®—æŒ‡å®šæ—¥æœŸ
python3 calculate_idle_data.py --tenant-id 1 --date 2025-11-20

# è®¡ç®—æœ€è¿‘7å¤©
python3 calculate_idle_data.py --tenant-id 1 --days 7

# æŸ¥çœ‹å¸®åŠ©
python3 calculate_idle_data.py --help
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/idle_calc.log

# æŸ¥çœ‹ä»Šå¤©çš„é”™è¯¯
grep ERROR /var/log/idle_calc.log | grep $(date +%Y-%m-%d)
```

---

## ğŸ¯ æ€»ç»“

### âœ… å·²å®Œæˆ
- âœ… æ•°æ®è®¡ç®—å¼•æ“ï¼ˆç®—æ³•å®ç°ï¼‰
- âœ… æµ‹è¯•æ•°æ®ç”Ÿæˆå·¥å…·
- âœ… å‘½ä»¤è¡Œå·¥å…·
- âœ… å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£

### ğŸš€ ç«‹å³å¼€å§‹
1. åˆ›å»ºæ•°æ®åº“è¡¨
2. ç”Ÿæˆæµ‹è¯•æ•°æ®
3. è¿è¡Œè®¡ç®—è„šæœ¬
4. æŸ¥çœ‹Webç•Œé¢

### ğŸ“ˆ ä¸‹ä¸€æ­¥ä¼˜åŒ–
- æ·»åŠ å®šæ—¶ä»»åŠ¡
- å¯¹æ¥æ›´å¤šæ•°æ®æº
- æ€§èƒ½ä¼˜åŒ–
- æ·»åŠ é€šçŸ¥åŠŸèƒ½

---

**æœ€åæ›´æ–°**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šâœ… å®Œå…¨å¯ç”¨

