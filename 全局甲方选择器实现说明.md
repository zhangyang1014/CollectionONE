# å…¨å±€ç”²æ–¹é€‰æ‹©å™¨å®ç°è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

åœ¨é¡µé¢å³ä¸Šè§’æ·»åŠ å…¨å±€ç”²æ–¹é€‰æ‹©å™¨ï¼Œé€‰æ‹©åæ‰€æœ‰å­é¡µé¢è‡ªåŠ¨ç»§æ‰¿è¯¥é€‰æ‹©ï¼Œé¿å…æ¯ä¸ªé¡µé¢é‡å¤é€‰æ‹©ç”²æ–¹ã€‚

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### 1. åˆ›å»ºå…¨å±€Store

**æ–‡ä»¶ï¼š** `frontend/src/stores/tenant.ts`

**åŠŸèƒ½ï¼š**
- å­˜å‚¨å½“å‰é€‰æ‹©çš„ç”²æ–¹IDå’Œä¿¡æ¯
- æŒä¹…åŒ–åˆ°localStorageï¼ˆåˆ·æ–°é¡µé¢ä¿æŒé€‰æ‹©ï¼‰
- æä¾›è®¾ç½®ã€æ¢å¤ã€æ¸…é™¤ç”²æ–¹çš„æ–¹æ³•

**å…³é”®ä»£ç ï¼š**
```typescript
export const useTenantStore = defineStore('tenant', () => {
  const currentTenantId = ref<number | undefined>(undefined)
  const currentTenant = ref<any>(null)

  const setCurrentTenant = (tenantId: number | undefined, tenant: any = null) => {
    currentTenantId.value = tenantId
    currentTenant.value = tenant
    
    // ä¿å­˜åˆ°localStorage
    if (tenantId) {
      localStorage.setItem('currentTenantId', String(tenantId))
      if (tenant) {
        localStorage.setItem('currentTenant', JSON.stringify(tenant))
      }
    } else {
      localStorage.removeItem('currentTenantId')
      localStorage.removeItem('currentTenant')
    }
  }

  const restoreFromStorage = () => {
    const savedTenantId = localStorage.getItem('currentTenantId')
    if (savedTenantId) {
      currentTenantId.value = parseInt(savedTenantId)
    }
  }

  return {
    currentTenantId,
    currentTenant,
    setCurrentTenant,
    restoreFromStorage,
    clearCurrentTenant
  }
})
```

### 2. åœ¨ä¸»å¸ƒå±€æ·»åŠ é€‰æ‹©å™¨

**æ–‡ä»¶ï¼š** `frontend/src/layouts/MainLayout.vue`

**ä½ç½®ï¼š** é¡µé¢å³ä¸Šè§’ï¼Œç”¨æˆ·ä¿¡æ¯å·¦ä¾§

**UIå±•ç¤ºï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CCOç³»ç»Ÿ                  å½“å‰ç”²æ–¹: [ç¤ºä¾‹ç”²æ–¹A â–¼]  ç”¨æˆ· â–¼â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç ï¼š**
```vue
<template>
  <el-header class="header">
    <div class="header-left"></div>
    <div class="header-right">
      <!-- å…¨å±€ç”²æ–¹é€‰æ‹©å™¨ -->
      <div class="tenant-selector">
        <span class="tenant-label">å½“å‰ç”²æ–¹ï¼š</span>
        <el-select 
          v-model="currentTenantId" 
          placeholder="è¯·é€‰æ‹©ç”²æ–¹" 
          @change="handleTenantChange"
          style="width: 200px"
          clearable
        >
          <el-option
            v-for="tenant in tenants"
            :key="tenant.id"
            :label="tenant.tenant_name"
            :value="tenant.id"
          />
        </el-select>
      </div>
      
      <el-dropdown>
        <span class="user-info">
          <el-icon><User /></el-icon>
          <span>ç”¨æˆ·</span>
        </span>
      </el-dropdown>
    </div>
  </el-header>
</template>

<script setup lang="ts">
import { useTenantStore } from '@/stores/tenant'
import { getTenants } from '@/api/tenant'

const tenantStore = useTenantStore()
const tenants = ref<any[]>([])
const currentTenantId = computed({
  get: () => tenantStore.currentTenantId,
  set: (value) => {
    const tenant = tenants.value.find(t => t.id === value)
    tenantStore.setCurrentTenant(value, tenant)
  }
})

onMounted(() => {
  loadTenants()
})
</script>
```

### 3. å­é¡µé¢ä½¿ç”¨å…¨å±€ç”²æ–¹

#### 3.1 é˜Ÿåˆ—ç®¡ç†é¡µé¢

**æ–‡ä»¶ï¼š** `frontend/src/views/tenant-management/QueueManagement.vue`

**æ”¹åŠ¨ï¼š**
1. âœ… ç§»é™¤æœ¬åœ°çš„ç”²æ–¹é€‰æ‹©å™¨
2. âœ… ä½¿ç”¨ `useTenantStore()` è·å–å½“å‰ç”²æ–¹
3. âœ… ä½¿ç”¨ `watch` ç›‘å¬å…¨å±€ç”²æ–¹å˜åŒ–
4. âœ… ç§»é™¤ `loadTenants` å‡½æ•°

**å…³é”®ä»£ç ï¼š**
```typescript
import { useTenantStore } from '@/stores/tenant'

const tenantStore = useTenantStore()
const currentTenantId = ref<number | undefined>(tenantStore.currentTenantId)

// ç›‘å¬å…¨å±€ç”²æ–¹å˜åŒ–
watch(
  () => tenantStore.currentTenantId,
  (newTenantId) => {
    currentTenantId.value = newTenantId
    loadQueues()  // è‡ªåŠ¨åŠ è½½æ–°ç”²æ–¹çš„æ•°æ®
  },
  { immediate: true }
)
```

**ç•Œé¢å˜åŒ–ï¼š**
```
å˜æ›´å‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”²æ–¹æ¡ˆä»¶é˜Ÿåˆ—ç®¡ç†    [é€‰æ‹©ç”²æ–¹ â–¼]  [æ·»åŠ é˜Ÿåˆ—]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å˜æ›´åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”²æ–¹æ¡ˆä»¶é˜Ÿåˆ—ç®¡ç†                    [æ·»åŠ é˜Ÿåˆ—]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ï¼ˆç”²æ–¹é€‰æ‹©ç§»è‡³é¡µé¢å³ä¸Šè§’ï¼‰
```

#### 3.2 æœºæ„ç®¡ç†é¡µé¢

**æ–‡ä»¶ï¼š** `frontend/src/views/organization/AgencyManagement.vue`

**æ”¹åŠ¨ï¼š** åŒé˜Ÿåˆ—ç®¡ç†é¡µé¢

#### 3.3 å°ç»„ç®¡ç†é¡µé¢

**æ–‡ä»¶ï¼š** `frontend/src/views/organization/TeamManagement.vue`

**ç‰¹æ®Šå¤„ç†ï¼š**
- ä¿ç•™æœºæ„é€‰æ‹©å™¨ï¼ˆéœ€è¦åœ¨ç”²æ–¹ä¸‹é€‰æ‹©æœºæ„ï¼‰
- ä½†ç”²æ–¹é€‰æ‹©å™¨ç§»é™¤ï¼Œä½¿ç”¨å…¨å±€ç”²æ–¹

```vue
<template>
  <div class="card-header">
    <span>å°ç»„ç®¡ç†</span>
    <el-space>
      <!-- åªä¿ç•™æœºæ„é€‰æ‹© -->
      <el-select 
        v-model="currentAgencyId" 
        placeholder="é€‰æ‹©æœºæ„" 
        @change="loadTeams"
      >
        <el-option
          v-for="agency in agencies"
          :key="agency.id"
          :label="agency.agency_name"
          :value="agency.id"
        />
      </el-select>
      <el-button type="primary" @click="handleAdd">åˆ›å»ºå°ç»„</el-button>
    </el-space>
  </div>
</template>
```

#### 3.4 å‚¬å‘˜ç®¡ç†é¡µé¢

**æ–‡ä»¶ï¼š** `frontend/src/views/organization/CollectorManagement.vue`

**ç‰¹æ®Šå¤„ç†ï¼š**
- ä¿ç•™æœºæ„é€‰æ‹©å™¨å’Œå°ç»„é€‰æ‹©å™¨
- ç”²æ–¹é€‰æ‹©å™¨ç§»é™¤ï¼Œä½¿ç”¨å…¨å±€ç”²æ–¹

```vue
<el-space>
  <!-- åªä¿ç•™æœºæ„å’Œå°ç»„é€‰æ‹© -->
  <el-select v-model="currentAgencyId" placeholder="é€‰æ‹©æœºæ„">
    ...
  </el-select>
  <el-select v-model="currentTeamId" placeholder="é€‰æ‹©å°ç»„">
    ...
  </el-select>
  <el-button type="primary" @click="handleAdd">åˆ›å»ºå‚¬å‘˜</el-button>
</el-space>
```

#### 3.5 ç”²æ–¹è‡ªå®šä¹‰å­—æ®µç®¡ç†

**æ–‡ä»¶ï¼š** `frontend/src/views/field-config/CustomFields.vue`

**æ”¹åŠ¨ï¼š** ç§»é™¤ç”²æ–¹é€‰æ‹©å™¨ï¼Œä½¿ç”¨å…¨å±€ç”²æ–¹

## ğŸŒŸ ä¼˜åŠ¿

### 1. ç”¨æˆ·ä½“éªŒæå‡
- âœ… ä¸€æ¬¡é€‰æ‹©ï¼Œå…¨å±€ç”Ÿæ•ˆ
- âœ… é¡µé¢åˆ·æ–°ä¿æŒé€‰æ‹©
- âœ… é¿å…é‡å¤æ“ä½œ
- âœ… è§†è§‰ç»Ÿä¸€åœ¨é¡µé¢é¡¶éƒ¨

### 2. ä»£ç ç»´æŠ¤æ€§
- âœ… çŠ¶æ€é›†ä¸­ç®¡ç†
- âœ… å‡å°‘é‡å¤ä»£ç 
- âœ… ç»Ÿä¸€çš„æ•°æ®æµ
- âœ… æ˜“äºæ‰©å±•

### 3. æ€§èƒ½ä¼˜åŒ–
- âœ… localStorageæŒä¹…åŒ–
- âœ… å‡å°‘APIè°ƒç”¨
- âœ… å“åº”å¼æ›´æ–°

## ğŸ“Š æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
   â†“
é¡µé¢å³ä¸Šè§’é€‰æ‹©ç”²æ–¹
   â†“
useTenantStore.setCurrentTenant()
   â†“
æ›´æ–° currentTenantId
   â†“
localStorage æŒä¹…åŒ–
   â†“
è§¦å‘ watch ç›‘å¬å™¨ï¼ˆæ‰€æœ‰å­é¡µé¢ï¼‰
   â†“
å­é¡µé¢è‡ªåŠ¨åŠ è½½æ–°ç”²æ–¹æ•°æ®
```

## ğŸ”„ é¡µé¢åŒæ­¥æœºåˆ¶

### å®æ—¶åŒæ­¥
å½“ç”¨æˆ·åœ¨å³ä¸Šè§’åˆ‡æ¢ç”²æ–¹æ—¶ï¼š
1. Storeç«‹å³æ›´æ–° `currentTenantId`
2. æ‰€æœ‰å­é¡µé¢çš„ `watch` ç›‘å¬å™¨è§¦å‘
3. å„é¡µé¢è‡ªåŠ¨è°ƒç”¨å„è‡ªçš„æ•°æ®åŠ è½½å‡½æ•°
4. é¡µé¢æ•°æ®æ— ç¼åˆ‡æ¢

### åˆ·æ–°ä¿æŒ
å½“ç”¨æˆ·åˆ·æ–°æµè§ˆå™¨æ—¶ï¼š
1. `MainLayout` çš„ `onMounted` è§¦å‘
2. è°ƒç”¨ `tenantStore.restoreFromStorage()`
3. ä» localStorage æ¢å¤ä¹‹å‰çš„é€‰æ‹©
4. é€‰æ‹©å™¨æ˜¾ç¤ºä¸Šæ¬¡é€‰æ‹©çš„ç”²æ–¹
5. å­é¡µé¢çš„ `watch` è‡ªåŠ¨è§¦å‘ï¼ŒåŠ è½½æ•°æ®

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `frontend/src/stores/tenant.ts` - å…¨å±€ç”²æ–¹Store

### ä¿®æ”¹æ–‡ä»¶
- âœ… `frontend/src/layouts/MainLayout.vue` - æ·»åŠ å…¨å±€é€‰æ‹©å™¨
- âœ… `frontend/src/views/tenant-management/QueueManagement.vue` - ç§»é™¤æœ¬åœ°é€‰æ‹©å™¨
- âœ… `frontend/src/views/organization/AgencyManagement.vue` - ç§»é™¤æœ¬åœ°é€‰æ‹©å™¨
- â³ `frontend/src/views/organization/TeamManagement.vue` - å¾…æ›´æ–°
- â³ `frontend/src/views/organization/CollectorManagement.vue` - å¾…æ›´æ–°
- â³ `frontend/src/views/field-config/CustomFields.vue` - å¾…æ›´æ–°

### æ–‡æ¡£
- âœ… `å…¨å±€ç”²æ–¹é€‰æ‹©å™¨å®ç°è¯´æ˜.md` - æœ¬æ–‡æ¡£

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šåŸºæœ¬é€‰æ‹©
1. åˆ·æ–°é¡µé¢
2. åœ¨å³ä¸Šè§’é€‰æ‹©"ç¤ºä¾‹ç”²æ–¹A"
3. è¿›å…¥"é˜Ÿåˆ—ç®¡ç†"ï¼Œåº”è‡ªåŠ¨æ˜¾ç¤ºç”²æ–¹Açš„é˜Ÿåˆ—
4. è¿›å…¥"æœºæ„ç®¡ç†"ï¼Œåº”è‡ªåŠ¨æ˜¾ç¤ºç”²æ–¹Açš„æœºæ„

**é¢„æœŸç»“æœï¼š** âœ… æ‰€æœ‰é¡µé¢æ˜¾ç¤ºä¸€è‡´çš„ç”²æ–¹æ•°æ®

### åœºæ™¯2ï¼šåˆ‡æ¢ç”²æ–¹
1. åœ¨å³ä¸Šè§’é€‰æ‹©"ç¤ºä¾‹ç”²æ–¹A"
2. è¿›å…¥"é˜Ÿåˆ—ç®¡ç†"ï¼ŒæŸ¥çœ‹æ•°æ®
3. åˆ‡æ¢åˆ°"ç¤ºä¾‹ç”²æ–¹B"
4. é˜Ÿåˆ—æ•°æ®è‡ªåŠ¨æ›´æ–°ä¸ºç”²æ–¹Bçš„æ•°æ®

**é¢„æœŸç»“æœï¼š** âœ… æ•°æ®æ— ç¼åˆ‡æ¢ï¼Œæ— éœ€åˆ·æ–°é¡µé¢

### åœºæ™¯3ï¼šåˆ·æ–°ä¿æŒ
1. åœ¨å³ä¸Šè§’é€‰æ‹©"ç¤ºä¾‹ç”²æ–¹A"
2. è¿›å…¥"æœºæ„ç®¡ç†"
3. åˆ·æ–°æµè§ˆå™¨ï¼ˆF5ï¼‰
4. é¡µé¢åŠ è½½åä»æ˜¾ç¤º"ç¤ºä¾‹ç”²æ–¹A"çš„æ•°æ®

**é¢„æœŸç»“æœï¼š** âœ… é€‰æ‹©è¢«æŒä¹…åŒ–ï¼Œåˆ·æ–°åä¿æŒ

### åœºæ™¯4ï¼šæ¸…é™¤é€‰æ‹©
1. åœ¨å³ä¸Šè§’é€‰æ‹©"ç¤ºä¾‹ç”²æ–¹A"
2. ç‚¹å‡»é€‰æ‹©å™¨çš„æ¸…é™¤æŒ‰é’®ï¼ˆÃ—ï¼‰
3. å„å­é¡µé¢æ˜¾ç¤º"è¯·åœ¨å³ä¸Šè§’é€‰æ‹©ç”²æ–¹"æç¤º

**é¢„æœŸç»“æœï¼š** âœ… æ¸…é™¤åæ‰€æœ‰é¡µé¢æ•°æ®æ¸…ç©º

### åœºæ™¯5ï¼šå¤šçº§è”åŠ¨
1. åœ¨å³ä¸Šè§’é€‰æ‹©"ç¤ºä¾‹ç”²æ–¹A"
2. è¿›å…¥"å°ç»„ç®¡ç†"
3. é€‰æ‹©"æœºæ„A"
4. åœ¨å³ä¸Šè§’åˆ‡æ¢åˆ°"ç¤ºä¾‹ç”²æ–¹B"
5. æœºæ„é€‰æ‹©å™¨è‡ªåŠ¨æ¸…ç©ºå¹¶åŠ è½½ç”²æ–¹Bçš„æœºæ„åˆ—è¡¨

**é¢„æœŸç»“æœï¼š** âœ… çº§è”é€‰æ‹©æ­£ç¡®é‡ç½®

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§
- å…¨å±€ç”²æ–¹åˆ‡æ¢æ—¶ï¼Œæ‰€æœ‰å­é¡µé¢æ•°æ®å¿…é¡»åŒæ­¥æ›´æ–°
- ä½¿ç”¨ `watch` ç¡®ä¿å®æ—¶å“åº”

### 2. ç”¨æˆ·æç¤º
- æœªé€‰æ‹©ç”²æ–¹æ—¶ï¼Œç›¸å…³æ“ä½œæŒ‰é’®åº”ç¦ç”¨
- æ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯

### 3. æ€§èƒ½è€ƒè™‘
- `watch` ä½¿ç”¨ `immediate: true` ç¡®ä¿åˆå§‹åŠ è½½
- é¿å…åœ¨ `watch` ä¸­æ‰§è¡Œé‡å¤çš„APIè°ƒç”¨

### 4. å¤šå±‚çº§é¡µé¢
- å°ç»„ç®¡ç†ã€å‚¬å‘˜ç®¡ç†ç­‰éœ€è¦ä¿ç•™ä¸‹çº§é€‰æ‹©å™¨
- åªç§»é™¤ç”²æ–¹é€‰æ‹©å™¨ï¼Œå…¶ä»–å±‚çº§ä¿æŒä¸å˜

## ğŸ¯ åç»­ä¼˜åŒ–

1. **é¢åŒ…å±‘å¯¼èˆª**ï¼šæ˜¾ç¤ºå½“å‰é€‰æ‹©çš„å±‚çº§è·¯å¾„
2. **å¿«é€Ÿåˆ‡æ¢**ï¼šå¸¸ç”¨ç”²æ–¹å¿«æ·å…¥å£
3. **æƒé™æ§åˆ¶**ï¼šæ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤å¯é€‰ç”²æ–¹
4. **å¤šç”²æ–¹å¯¹æ¯”**ï¼šæ”¯æŒåŒæ—¶æŸ¥çœ‹å¤šä¸ªç”²æ–¹æ•°æ®
5. **æœç´¢åŠŸèƒ½**ï¼šç”²æ–¹æ•°é‡å¤šæ—¶æ”¯æŒæœç´¢

---

**å®ç°æ—¥æœŸï¼š** 2024-11-11  
**ç‰ˆæœ¬ï¼š** v1.0  
**çŠ¶æ€ï¼š** ğŸš§ éƒ¨åˆ†å®Œæˆ

**å·²å®Œæˆï¼š**
- âœ… å…¨å±€Store
- âœ… ä¸»å¸ƒå±€é€‰æ‹©å™¨
- âœ… é˜Ÿåˆ—ç®¡ç†
- âœ… æœºæ„ç®¡ç†

**å¾…å®Œæˆï¼š**
- â³ å°ç»„ç®¡ç†
- â³ å‚¬å‘˜ç®¡ç†
- â³ ç”²æ–¹è‡ªå®šä¹‰å­—æ®µç®¡ç†

