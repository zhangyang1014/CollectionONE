# 角色体系优化说明

## 变更日期

2025-01-11

---

## 一、变更概述

本次优化明确了系统的角色体系，简化了组织架构管理，主要变更包括：

1. **明确定义了两个核心系统角色**：SuperAdmin 和甲方管理员
2. **优化了甲方创建流程**：创建甲方时同时创建甲方管理员账号
3. **移除了"字段配置"按钮**：简化甲方列表操作
4. **简化了小组管理**：移除"小组组长"和"目标业绩"配置

---

## 二、详细变更内容

### 2.1 角色体系定义

#### 2.1.1 SuperAdmin（超级管理员）

**特点：**
- 系统创建，无界面编辑
- 通过环境变量或配置文件管理
- 不在数据库的常规用户表中存储

**权限：**
- 创建、编辑、删除甲方
- 创建甲方时，同时创建该甲方的管理员账号
- 管理系统级标准字段

#### 2.1.2 甲方管理员（TenantAdmin）

**创建方式：**
- 由 SuperAdmin 在创建甲方时同时创建
- 必须提供：账号名、登录ID、邮箱、密码

**权限：**
- 管理本甲方的所有组织架构（机构、小组、账号）
- 配置本甲方的自定义字段和案件队列
- 查看本甲方的所有数据和报表

### 2.2 前端变更

#### 2.2.1 甲方列表页面 (`frontend/src/views/tenant-management/TenantList.vue`)

**移除内容：**
- ❌ "字段配置"按钮
- ❌ `handleFieldConfig` 函数

**新增内容：**
- ✅ 创建/编辑甲方对话框
- ✅ 甲方基础信息表单
  - 甲方名称
  - 甲方编码
  - 国家代码
  - 时区
  - 货币代码
- ✅ 甲方管理员账号表单
  - 管理员账号名
  - 管理员登录ID
  - 管理员邮箱
  - 管理员密码
  - 确认密码
- ✅ 表单验证逻辑
  - 必填项验证
  - 邮箱格式验证
  - 密码长度验证（最少6位）
  - 密码确认一致性验证

**UI 效果：**

```
┌─────────────────────────────────────────────┐
│ 创建甲方                                 ×  │
├─────────────────────────────────────────────┤
│ ─────────── 甲方基础信息 ─────────────      │
│                                              │
│ 甲方名称：    [__________________]           │
│ 甲方编码：    [__________________]           │
│ 国家代码：    [__________________]           │
│ 时区：        [__________________]           │
│ 货币：        [__________________]           │
│                                              │
│ ─────────── 甲方管理员账号 ───────────       │
│                                              │
│ 管理员账号名：[__________________]           │
│ 管理员登录ID：[__________________]           │
│ 管理员邮箱：  [__________________]           │
│ 管理员密码：  [__________________]           │
│ 确认密码：    [__________________]           │
│                                              │
│                           [取消]  [保存]     │
└─────────────────────────────────────────────┘
```

#### 2.2.2 小组管理页面 (`frontend/src/views/organization/TeamManagement.vue`)

**移除内容：**
- ❌ "小组组长"列（表格）
- ❌ "小组组长"表单项（对话框）
- ❌ "目标业绩"表单项（对话框）

**理由：**
- "小组组长"现在通过"小组管理账号"（角色：小组长）来管理
- "目标业绩"不在小组创建时配置，可通过其他业绩管理模块单独设置

**变更前：**
```
┌────────────────────────────────────────────────────────┐
│ 小组ID │ 小组名 │ 所属甲方 │ 所属机构 │ 小组组长 │ 催员数量 │
├────────────────────────────────────────────────────────┤
│ ...                                                     │
└────────────────────────────────────────────────────────┘
```

**变更后：**
```
┌───────────────────────────────────────────────────┐
│ 小组ID │ 小组名 │ 所属甲方 │ 所属机构 │ 催员数量 │
├───────────────────────────────────────────────────┤
│ ...                                                │
└───────────────────────────────────────────────────┘
```

### 2.3 文档变更

#### 2.3.1 新增文档：`系统角色体系说明.md`

**内容：**
- 角色层级架构图
- 各角色详细说明（定义、权限、创建方式）
- 角色创建流程
- 数据库设计（含新表结构）
- 前端界面说明
- 安全考虑
- FAQ

**核心表设计：**

1. **tenant_admins 表**（甲方管理员）
   - 存储甲方管理员账号信息
   - 与 tenants 表一对一关系
   - 由 SuperAdmin 创建

2. **team_admin_accounts 表**（小组管理账号）
   - 存储小组长、质检员、统计员
   - 与 collection_teams 表关联
   - 由甲方管理员创建

---

## 三、数据库迁移

### 3.1 新增表：tenant_admins

```sql
CREATE TABLE tenant_admins (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '所属甲方ID',
    admin_name VARCHAR(50) NOT NULL COMMENT '管理员账号名',
    login_id VARCHAR(50) NOT NULL UNIQUE COMMENT '登录ID',
    email VARCHAR(100) NOT NULL COMMENT '邮箱',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_at TIMESTAMP NULL COMMENT '最近登录时间',
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_login_id (login_id)
) COMMENT '甲方管理员表';
```

### 3.2 修改表：team_admin_accounts

将原有的 `team_admin_accounts` 表结构规范化：

```sql
-- 如果表已存在，可能需要调整字段
ALTER TABLE team_admin_accounts 
  ADD COLUMN IF NOT EXISTS mobile VARCHAR(20) NULL COMMENT '手机号（可选）' AFTER email,
  MODIFY COLUMN role ENUM('小组长', '质检员', '统计员') NOT NULL COMMENT '角色';
```

### 3.3 移除表：collection_teams 中的 leader_id 字段

```sql
-- 移除 leader_id 字段（如果存在）
ALTER TABLE collection_teams 
  DROP COLUMN IF EXISTS leader_id,
  DROP COLUMN IF EXISTS target_performance;
```

---

## 四、API 设计

### 4.1 创建甲方（含管理员）

**接口：** `POST /api/v1/tenants`

**请求体：**
```json
{
  "tenant_name": "示例甲方A",
  "tenant_code": "TENANT001",
  "country_code": "CN",
  "timezone": "Asia/Shanghai",
  "currency_code": "CNY",
  "admin": {
    "admin_name": "张三",
    "login_id": "zhangsan001",
    "email": "zhangsan@example.com",
    "password": "SecurePass123"
  }
}
```

**响应体：**
```json
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "tenant": {
      "id": 1,
      "tenant_name": "示例甲方A",
      "tenant_code": "TENANT001",
      "country_code": "CN",
      "timezone": "Asia/Shanghai",
      "currency_code": "CNY",
      "created_at": "2025-01-11T10:00:00Z"
    },
    "admin": {
      "id": 1,
      "tenant_id": 1,
      "admin_name": "张三",
      "login_id": "zhangsan001",
      "email": "zhangsan@example.com",
      "created_at": "2025-01-11T10:00:00Z"
    }
  }
}
```

**后端逻辑（伪代码）：**
```python
async def create_tenant_with_admin(data: TenantCreateRequest):
    async with db.transaction():
        # 1. 创建甲方
        tenant = await create_tenant(data.tenant)
        
        # 2. 创建甲方管理员
        admin_data = data.admin
        admin_data.tenant_id = tenant.id
        admin_data.password_hash = hash_password(admin_data.password)
        admin = await create_tenant_admin(admin_data)
        
        # 3. 初始化标准字段配置（100%继承）
        await initialize_standard_fields(tenant.id)
        
        # 4. 创建默认案件队列
        await create_default_queues(tenant.id)
        
        return {
            "tenant": tenant,
            "admin": admin
        }
```

### 4.2 编辑甲方

**接口：** `PUT /api/v1/tenants/{tenant_id}`

**说明：**
- 只能编辑甲方基础信息
- 不能通过此接口修改管理员密码（需要单独的密码重置接口）

### 4.3 重置甲方管理员密码

**接口：** `POST /api/v1/tenants/{tenant_id}/admin/reset-password`

**请求体：**
```json
{
  "new_password": "NewSecurePass456"
}
```

---

## 五、待实现功能

### 5.1 后端

- [ ] 实现 `POST /api/v1/tenants` 接口（创建甲方 + 管理员）
- [ ] 实现 `PUT /api/v1/tenants/{tenant_id}` 接口（编辑甲方）
- [ ] 实现 `POST /api/v1/tenants/{tenant_id}/admin/reset-password` 接口
- [ ] SuperAdmin 认证中间件（环境变量验证）
- [ ] 甲方管理员认证中间件（JWT Token）
- [ ] 创建数据库迁移脚本
- [ ] 初始化标准字段配置逻辑
- [ ] 创建默认案件队列逻辑

### 5.2 前端

- [ ] 集成实际的 API 调用（创建甲方）
- [ ] SuperAdmin 登录页面
- [ ] 甲方管理员登录页面
- [ ] 根据登录角色显示不同菜单
- [ ] 密码强度提示（可选）

### 5.3 Mock Server

- [ ] 更新 `backend/simple_server.py`，添加创建甲方的 mock 接口

---

## 六、测试要点

### 6.1 功能测试

- [ ] SuperAdmin 可以创建甲方，并自动创建管理员
- [ ] 甲方管理员可以登录，并看到正确的菜单
- [ ] 甲方管理员可以创建机构、小组、小组管理账号、催员
- [ ] 甲方管理员不能访问其他甲方的数据
- [ ] 小组管理中不再显示"小组组长"和"目标业绩"

### 6.2 验证测试

- [ ] 创建甲方时，所有必填项验证正确
- [ ] 密码长度至少6位
- [ ] 两次输入的密码必须一致
- [ ] 邮箱格式正确
- [ ] 甲方编码不能重复

### 6.3 安全测试

- [ ] 密码使用哈希存储
- [ ] 甲方管理员无法访问其他甲方的数据
- [ ] SuperAdmin 的账号密码不存储在数据库
- [ ] JWT Token 过期机制

---

## 七、影响范围评估

### 7.1 数据库

- **影响程度：** 🔴 高
- **原因：** 新增 `tenant_admins` 表，修改 `collection_teams` 表
- **迁移难度：** 中等

### 7.2 后端 API

- **影响程度：** 🟠 中
- **原因：** 新增创建甲方接口，需要同时处理管理员账号
- **开发工作量：** 中等

### 7.3 前端界面

- **影响程度：** 🟢 低
- **原因：** 只修改了甲方列表和小组管理两个页面
- **用户影响：** 小（功能更清晰）

### 7.4 现有功能

- **影响程度：** 🟢 低
- **原因：** 移除了"字段配置"按钮和小组的部分字段，不影响核心流程

---

## 八、总结

本次优化的核心目标是**明确角色体系**，主要成果：

✅ **角色清晰**：SuperAdmin 管理甲方，甲方管理员管理组织  
✅ **流程简化**：创建甲方时自动创建管理员，一步到位  
✅ **权限分明**：不同角色有不同的操作权限和数据可见范围  
✅ **易于扩展**：后续可以方便地添加更多角色和权限  

下一步工作重点：
1. 实现后端 API（创建甲方 + 管理员）
2. 实现认证和权限中间件
3. 完善前端登录和权限控制

