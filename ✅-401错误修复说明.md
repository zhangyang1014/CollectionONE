# ✅ 401错误修复说明

## 📋 问题根源

**根本原因**: JWT过滤器验证Mock Token失败，返回401错误，导致前端跳回登录页。

### 问题流程

1. 登录成功，获得Mock Token: `MOCK_IM_TOKEN_...`
2. 前端使用该Token调用案件API: `/api/v1/cases?tenant_id=1&collector_id=1`
3. **JWT过滤器尝试验证Token**，但Mock Token不是真正的JWT格式
4. **验证失败，返回401错误**
5. 前端 `imRequest` 拦截器收到401，清除Token并跳转到登录页

---

## ✅ 已实施的修复

### 修改JWT过滤器

**文件**: `backend-java/src/main/java/com/cco/security/JwtAuthenticationFilter.java`

**修复内容**:
- ✅ 添加Mock Token检测
- ✅ 如果是Mock Token（以 `MOCK_` 开头），直接放行，不进行JWT验证
- ✅ 只有真正的JWT Token才进行验证

**关键代码**:
```java
if (StringUtils.hasText(jwt)) {
    // Mock模式：如果是Mock Token，直接放行（不验证JWT）
    if (jwt.startsWith("MOCK_")) {
        log.debug("Mock Token detected, skipping JWT validation");
        filterChain.doFilter(request, response);
        return;
    }
    
    // 验证真正的JWT Token
    if (tokenProvider.validateToken(jwt)) {
        // ... 正常JWT验证流程
    }
}
```

---

## 🧪 验证步骤

### 步骤1: 等待后端服务启动

后端服务正在重新启动，请等待约20-30秒。

### 步骤2: 测试案件API

```bash
curl -s "http://localhost:8080/api/v1/cases?tenant_id=1&collector_id=1" \
  -H "Authorization: Bearer MOCK_IM_TOKEN_TEST"
```

**预期结果**: 应该返回案件列表，而不是401错误

### 步骤3: 测试前端登录

1. **强制刷新页面**（`Ctrl+Shift+R` 或 `Cmd+Shift+R`）
2. 重新登录：
   - 机构ID: `1`
   - 催员ID: `BTQ001`
   - 密码: `123456`
3. **预期结果**:
   - ✅ 登录成功
   - ✅ 跳转到工作台
   - ✅ **不再跳回登录页**
   - ✅ 案件列表正常加载

### 步骤4: 检查Network面板

1. 打开开发者工具（F12）→ Network标签
2. 查找案件API请求: `/api/v1/cases?tenant_id=1&collector_id=1`
3. **检查状态码**: 应该是 `200`（不再是 `401`）
4. **检查Response**: 应该返回案件列表数据

---

## 🔍 修复前后对比

### 修复前

```
登录成功 → 获得Mock Token
调用案件API → JWT过滤器验证Token
Mock Token验证失败 → 返回401
前端收到401 → 清除Token → 跳转登录页 ❌
```

### 修复后

```
登录成功 → 获得Mock Token
调用案件API → JWT过滤器检测到Mock Token
Mock Token直接放行 → 不验证JWT
案件API正常返回 → 前端正常显示 ✅
```

---

## 📝 技术细节

### Mock Token格式

Mock Token格式: `MOCK_IM_TOKEN_<timestamp>`

例如: `MOCK_IM_TOKEN_1763833308692`

### JWT过滤器逻辑

1. **提取Token**: 从 `Authorization: Bearer <token>` 头中提取
2. **检测Mock Token**: 如果Token以 `MOCK_` 开头
3. **直接放行**: 不进行JWT验证，直接继续过滤链
4. **JWT验证**: 只有真正的JWT Token才进行验证

---

## ✅ 修复检查清单

- [x] JWT过滤器添加Mock Token检测
- [x] Mock Token直接放行，不验证JWT
- [x] 后端服务已重启
- [ ] 测试案件API不再返回401
- [ ] 测试前端登录后不再跳回登录页

---

## 🚨 如果仍然有问题

### 问题1: 仍然返回401

**可能原因**: 后端服务没有完全重启

**解决**:
1. 检查后端服务是否运行：
   ```bash
   lsof -i :8080
   ```
2. 查看后端日志：
   ```bash
   tail -f backend-java/backend-restart.log
   ```
3. 确认日志中有 "Mock Token detected" 的调试信息

### 问题2: 前端仍然跳回登录页

**可能原因**: 前端缓存了旧的错误处理逻辑

**解决**:
1. 强制刷新页面（`Ctrl+Shift+R`）
2. 清除浏览器缓存
3. 检查Console面板，查看是否有401错误

---

**修复时间**: 2025-11-22  
**状态**: ✅ JWT过滤器已修复，后端服务已重启

---

**请等待后端服务完全启动后（约20-30秒），再测试登录功能！** 🚀



