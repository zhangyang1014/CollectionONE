# IMç«¯ç™»å½•æ¥å£æµ‹è¯•è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†IMç«¯å‚¬å‘˜ç™»å½•æ¥å£çš„æµ‹è¯•è„šæœ¬å’Œæµ‹è¯•ç»“æœã€‚

## ğŸ§ª æµ‹è¯•è„šæœ¬

### 1. æµ‹è¯•æ–‡ä»¶

- **æµ‹è¯•è„šæœ¬**: `backend/test_im_login.py`
- **æ•°æ®åˆå§‹åŒ–**: `backend/create_im_collectors.py`

### 2. è¿è¡Œæµ‹è¯•

```bash
cd backend
python3 test_im_login.py
```

## ğŸ“Š æµ‹è¯•ç”¨ä¾‹

### æ­£å¸¸ç™»å½•æµ‹è¯•

æµ‹è¯•æ‰€æœ‰IMç«¯å‚¬å‘˜è´¦å·çš„ç™»å½•åŠŸèƒ½ï¼š

#### BTQï¼ˆå¢¨è¥¿å“¥ï¼‰å‚¬å‘˜è´¦å·

| è´¦å·åç§° | æœºæ„ID | å‚¬å‘˜ID | å¯†ç  | è§’è‰² |
|---------|-------|--------|------|------|
| Carlos MÃ©ndez | 1 | BTQ001 | 123456 | é«˜çº§å‚¬å‘˜ |
| MarÃ­a GonzÃ¡lez | 1 | BTQ002 | 123456 | å‚¬å‘˜ |
| JosÃ© RamÃ­rez | 1 | BTQ003 | 123456 | å‚¬å‘˜ |

#### BTSKï¼ˆå°åº¦ï¼‰å‚¬å‘˜è´¦å·

| è´¦å·åç§° | æœºæ„ID | å‚¬å‘˜ID | å¯†ç  | è§’è‰² |
|---------|-------|--------|------|------|
| Raj Sharma | 2 | BTSK001 | 123456 | å›¢é˜Ÿé•¿ |
| Priya Patel | 2 | BTSK002 | 123456 | é«˜çº§å‚¬å‘˜ |
| Amit Kumar | 2 | BTSK003 | 123456 | å‚¬å‘˜ |

### å¼‚å¸¸åœºæ™¯æµ‹è¯•

æµ‹è¯•é”™è¯¯å‡­æ®çš„å¤„ç†ï¼š

1. **é”™è¯¯çš„å¯†ç ** - é¢„æœŸè¿”å› 401
2. **ä¸å­˜åœ¨çš„å‚¬å‘˜ID** - é¢„æœŸè¿”å› 401
3. **é”™è¯¯çš„æœºæ„ID** - é¢„æœŸè¿”å› 401

## âœ… æµ‹è¯•ç»“æœ

### æœ€æ–°æµ‹è¯•ç»“æœï¼ˆ2025-11-20 11:24:58ï¼‰

```
======================================================================
æµ‹è¯•ç»“æœæ±‡æ€»
======================================================================
âœ… æˆåŠŸ: 6/6 ä¸ªè´¦å·
âŒ å¤±è´¥: 0/6 ä¸ªè´¦å·
======================================================================

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### éªŒè¯é¡¹

æ¯ä¸ªç™»å½•æµ‹è¯•éªŒè¯ä»¥ä¸‹å­—æ®µï¼š

1. âœ“ å“åº”code = 200
2. âœ“ dataå­—æ®µå­˜åœ¨
3. âœ“ tokenå­—æ®µå­˜åœ¨ä¸”æœ‰æ•ˆ
4. âœ“ userå­—æ®µå­˜åœ¨
5. âœ“ user.id å­˜åœ¨
6. âœ“ user.collectorId å­˜åœ¨
7. âœ“ user.collectorName å­˜åœ¨
8. âœ“ user.tenantId å­˜åœ¨
9. âœ“ user.tenantName å­˜åœ¨
10. âœ“ user.role å­˜åœ¨
11. âœ“ user.permissions æ•°ç»„å­˜åœ¨

### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 37,
      "collectorId": "BTQ001",
      "collectorCode": "BTQ001",
      "collectorName": "Carlos MÃ©ndez",
      "tenantId": "1",
      "tenantName": "ç™¾è…¾ä¼ä¸š",
      "agencyId": 1,
      "agencyName": "ç™¾è…¾ä¼ä¸š-æœºæ„1",
      "teamId": 1,
      "teamName": "ç™¾è…¾ä¼ä¸š-æœºæ„1-å°ç»„1",
      "mobile": "+52 55 1234 5001",
      "email": "carlos.mendez@btq.mx",
      "collectorLevel": "é«˜çº§å‚¬å‘˜",
      "status": "active",
      "currentCaseCount": 0,
      "maxCaseCount": 100,
      "role": "collector",
      "permissions": [
        "case:view",
        "case:call",
        "message:send"
      ]
    }
  }
}
```

## ğŸ”§ æ•°æ®åˆå§‹åŒ–

### åˆå§‹åŒ–IMç«¯å‚¬å‘˜æ•°æ®

å¦‚æœéœ€è¦é‡æ–°åˆå§‹åŒ–IMç«¯å‚¬å‘˜æ•°æ®ï¼š

```bash
cd backend
source venv/bin/activate
python create_im_collectors.py
```

è¯¥è„šæœ¬ä¼šï¼š
1. è¯»å– `collectors_data.json` ä¸­çš„å‚¬å‘˜ä¿¡æ¯
2. ä¸ºæ¯ä¸ªå‚¬å‘˜ç”ŸæˆSHA256å¯†ç å“ˆå¸Œï¼ˆå¯†ç ï¼š123456ï¼‰
3. åˆ›å»ºå‚¬å‘˜è®°å½•åˆ°æ•°æ®åº“
4. è‡ªåŠ¨å…³è”åˆ°å¯¹åº”çš„æœºæ„å’Œå°ç»„

### å¯†ç å“ˆå¸Œè¯´æ˜

ç”±äºbcryptæ¨¡å—å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œç³»ç»Ÿä½¿ç”¨SHA256å“ˆå¸Œå­˜å‚¨å¯†ç ï¼š

```python
import hashlib
password_hash = hashlib.sha256("123456".encode()).hexdigest()
# ç»“æœ: 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92
```

ç™»å½•éªŒè¯æ—¶ï¼Œåç«¯ä¼šè‡ªåŠ¨æ£€æµ‹å¯†ç å“ˆå¸Œé•¿åº¦ï¼ˆ64å­—ç¬¦ï¼‰å¹¶ä½¿ç”¨å¯¹åº”çš„éªŒè¯æ–¹å¼ã€‚

## ğŸ” æ¥å£è¯´æ˜

### ç™»å½•æ¥å£

- **URL**: `POST /api/v1/im/auth/login`
- **Content-Type**: `application/json`

#### è¯·æ±‚å‚æ•°

```json
{
  "tenantId": "1",
  "collectorId": "BTQ001",
  "password": "123456"
}
```

#### å“åº”å‚æ•°

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| code | int | çŠ¶æ€ç ï¼Œ200è¡¨ç¤ºæˆåŠŸ |
| message | string | å“åº”æ¶ˆæ¯ |
| data.token | string | JWTè®¿é—®ä»¤ç‰Œ |
| data.user | object | ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ |
| data.user.id | int | å‚¬å‘˜æ•°æ®åº“ID |
| data.user.collectorId | string | å‚¬å‘˜ç™»å½•ID |
| data.user.collectorName | string | å‚¬å‘˜å§“å |
| data.user.tenantId | string | æœºæ„ID |
| data.user.tenantName | string | æœºæ„åç§° |
| data.user.agencyId | int | æœºæ„ID |
| data.user.agencyName | string | æœºæ„åç§° |
| data.user.teamId | int | å°ç»„ID |
| data.user.teamName | string | å°ç»„åç§° |
| data.user.role | string | è§’è‰² |
| data.user.permissions | array | æƒé™åˆ—è¡¨ |

## ğŸ› é—®é¢˜è®°å½•

### é—®é¢˜1: bcryptå…¼å®¹æ€§é—®é¢˜

**é—®é¢˜æè¿°**:
```
ValueError: password cannot be longer than 72 bytes
```

**è§£å†³æ–¹æ¡ˆ**:
æ”¹ç”¨SHA256å“ˆå¸Œå­˜å‚¨å¯†ç ï¼Œåç«¯è‡ªåŠ¨æ£€æµ‹å“ˆå¸Œé•¿åº¦ï¼ˆ64å­—ç¬¦ï¼‰å¹¶ä½¿ç”¨SHA256éªŒè¯ã€‚

### é—®é¢˜2: å¯†ç å“ˆå¸Œä¸ä¸€è‡´

**é—®é¢˜æè¿°**:
åˆå§‹åˆ›å»ºçš„å‚¬å‘˜ä½¿ç”¨çš„å¯†ç å“ˆå¸Œä¸å…¶ä»–å‚¬å‘˜ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**:
ç»Ÿä¸€ä½¿ç”¨SHA256å“ˆå¸Œï¼Œç¡®ä¿æ‰€æœ‰å‚¬å‘˜ä½¿ç”¨ç›¸åŒçš„å¯†ç å“ˆå¸Œç®—æ³•ã€‚

## ğŸ“ ç»´æŠ¤è¯´æ˜

### æ·»åŠ æ–°çš„æµ‹è¯•è´¦å·

1. åœ¨ `collectors_data.json` ä¸­æ·»åŠ æ–°å‚¬å‘˜ä¿¡æ¯
2. è¿è¡Œ `create_im_collectors.py` å¯¼å…¥æ•°æ®
3. åœ¨ `test_im_login.py` çš„ `TEST_ACCOUNTS` ä¸­æ·»åŠ æµ‹è¯•ç”¨ä¾‹
4. è¿è¡Œæµ‹è¯•éªŒè¯

### æ›´æ–°æµ‹è¯•è„šæœ¬

æµ‹è¯•è„šæœ¬ä½¿ç”¨Pythonæ ‡å‡†åº“ï¼ˆ`urllib`ï¼‰ï¼Œæ— éœ€å®‰è£…ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¯ç›´æ¥è¿è¡Œï¼š

```bash
python3 test_im_login.py
```

## ğŸ¯ å¿«é€Ÿå¼€å§‹

å®Œæ•´çš„æµ‹è¯•æµç¨‹ï¼š

```bash
# 1. å¯åŠ¨åç«¯æœåŠ¡
cd backend
source venv/bin/activate
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 2. åˆå§‹åŒ–IMç«¯å‚¬å‘˜æ•°æ®ï¼ˆæ–°ç¯å¢ƒï¼‰
python create_im_collectors.py

# 3. è¿è¡Œç™»å½•æµ‹è¯•
python3 test_im_login.py
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‚¬å‘˜æµ‹è¯•è´¦å·è¯´æ˜](../è¯´æ˜æ–‡æ¡£/åç«¯/å‚¬å‘˜æµ‹è¯•è´¦å·.md)
- [IMç«¯ç™»å½•ç³»ç»Ÿå®ç°è¯´æ˜](../è¯´æ˜æ–‡æ¡£/å‰ç«¯/CCO-IMç«¯ç™»å½•ç³»ç»Ÿå®ç°è¯´æ˜.md)
- [å‚¬å‘˜ç™»å½•äººè„¸è¯†åˆ«åŠŸèƒ½å®ç°è¯´æ˜](../è¯´æ˜æ–‡æ¡£/åç«¯/å‚¬å‘˜ç™»å½•äººè„¸è¯†åˆ«åŠŸèƒ½å®ç°è¯´æ˜.md)

---

*æœ€åæ›´æ–°: 2025-11-20*
*æµ‹è¯•çŠ¶æ€: âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡*

