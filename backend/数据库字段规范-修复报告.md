# æ•°æ®åº“å­—æ®µè§„èŒƒæ£€æŸ¥ä¸ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

åœ¨è¿›å…¥"æ ‡å‡†å­—æ®µç®¡ç†"é¡µé¢æ—¶å‡ºç°é”™è¯¯ï¼Œç»æ£€æŸ¥å‘ç°æ˜¯ Vite ç¼“å­˜é—®é¢˜å’Œæ•°æ®åº“å­—æ®µç±»å‹ä¸è§„èŒƒé—®é¢˜ã€‚

## ğŸ” æ£€æŸ¥å‘ç°çš„é—®é¢˜

### 1. å‰ç«¯é—®é¢˜

**é”™è¯¯ä¿¡æ¯**:
```
GET http://localhost:5173/node_modules/.vite/deps/sortablejs.js?v=8bb51a00 net::ERR_ABORTED 504 (Outdated Optimize Dep)
```

**åŸå› **: Vite ä¾èµ–ç¼“å­˜è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ**: æ¸…é™¤ Vite ç¼“å­˜
```bash
rm -rf frontend/node_modules/.vite
```

### 2. æ•°æ®åº“å­—æ®µç±»å‹é—®é¢˜

**é—®é¢˜**: å‘ç° **47ä¸ªå¤–é”®ç±»å‹ä¸åŒ¹é…**

MySQL ä¸¥æ ¼è¦æ±‚å¤–é”®ç±»å‹å¿…é¡»ä¸å¼•ç”¨çš„ä¸»é”®ç±»å‹å®Œå…¨ä¸€è‡´ï¼Œè€Œ SQLite å¯¹æ­¤è¦æ±‚è¾ƒå®½æ¾ã€‚

#### ç±»å‹ä¸åŒ¹é…è¯¦æƒ…

| æ–‡ä»¶ | å¤–é”®å­—æ®µ | å¤–é”®ç±»å‹ | å¼•ç”¨è¡¨ | ä¸»é”®ç±»å‹ |
|------|---------|---------|--------|---------|
| field_dependency.py | source_field_id | BigInteger | standard_fields | Integer |
| field_dependency.py | target_field_id | BigInteger | standard_fields | Integer |
| custom_dimension_stat.py | collector_id | BigInteger | collectors | Integer |
| custom_dimension_stat.py | tenant_id | BigInteger | tenants | Integer |
| ptp_record.py | case_id | BigInteger | cases | Integer |
| ptp_record.py | collector_id | BigInteger | collectors | Integer |
| ... | ... | ... | ... | ... |
| **å…±47ä¸ªå­—æ®µ** | - | - | - | - |

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ç­–ç•¥: ç»Ÿä¸€æ‰€æœ‰ä¸»é”®ä¸º BigInteger

**åŸå› **:
1. BigInteger å¯ä»¥å­˜å‚¨æ›´å¤§çš„æ•°å€¼èŒƒå›´ (é€‚åˆå¤§æ•°æ®é‡)
2. å‘ä¸Šå…¼å®¹ - Integer å¯ä»¥å®‰å…¨è½¬æ¢ä¸º BigInteger
3. ç¬¦åˆç°ä»£æ•°æ®åº“è®¾è®¡æœ€ä½³å®è·µ

### ä¿®å¤æ­¥éª¤

#### 1. è‡ªåŠ¨ä¿®å¤ä¸»é”®ç±»å‹

è¿è¡Œä¿®å¤è„šæœ¬:
```bash
python3 fix_field_types.py
```

**ä¿®å¤çš„æ–‡ä»¶** (13ä¸ª):
- channel_supplier.py
- team_admin_account.py
- tenant.py
- case_queue.py
- collector.py
- standard_field.py
- field_group.py
- tenant_field_config.py
- notification_template.py
- case.py
- public_notification.py
- collection_team.py
- collection_agency.py

#### 2. æ‰‹åŠ¨ä¿®å¤å‰©ä½™å¤–é”®

ä¿®å¤ä»¥ä¸‹æ–‡ä»¶çš„å¤–é”®ç±»å‹:

**channel_supplier.py**:
```python
# ä¿®æ”¹å‰
tenant_id = Column(Integer, ForeignKey("tenants.id"), ...)

# ä¿®æ”¹å
tenant_id = Column(BigInteger, ForeignKey("tenants.id"), ...)
```

**team_admin_account.py**:
```python
# ä¿®æ”¹å‰
tenant_id = Column(Integer, ForeignKey("tenants.id"), ...)
agency_id = Column(Integer, ForeignKey("collection_agencies.id"), ...)
team_id = Column(Integer, ForeignKey("collection_teams.id"), ...)

# ä¿®æ”¹å
tenant_id = Column(BigInteger, ForeignKey("tenants.id"), ...)
agency_id = Column(BigInteger, ForeignKey("collection_agencies.id"), ...)
team_id = Column(BigInteger, ForeignKey("collection_teams.id"), ...)
```

**field_group.py**:
```python
# ä¿®æ”¹å‰
parent_id = Column(Integer, ForeignKey('field_groups.id'), ...)

# ä¿®æ”¹å
parent_id = Column(BigInteger, ForeignKey('field_groups.id'), ...)
```

#### 3. ä¿®å¤å¯¼å…¥è¯­å¥

ç¡®ä¿æ‰€æœ‰ä½¿ç”¨ BigInteger çš„æ–‡ä»¶éƒ½å¯¼å…¥äº†å®ƒ:

**public_notification.py**:
```python
# ä¿®æ”¹å‰
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text

# ä¿®æ”¹å
from sqlalchemy import Column, Integer, BigInteger, String, Boolean, DateTime, Text
```

**notification_template.py**:
```python
# ä¿®æ”¹å‰
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text, JSON

# ä¿®æ”¹å
from sqlalchemy import Column, Integer, BigInteger, String, Boolean, DateTime, Text, JSON
```

## âœ… éªŒè¯ç»“æœ

è¿è¡ŒéªŒè¯è„šæœ¬:
```bash
python3 check_field_types.py
```

**éªŒè¯é€šè¿‡**:
```
================================================================================
æ•°æ®åº“å­—æ®µç±»å‹æ£€æŸ¥
================================================================================

1. æ£€æŸ¥å¤–é”®ç±»å‹ä¸åŒ¹é…é—®é¢˜...

æ‰¾åˆ° 27 ä¸ªè¡¨çš„ä¸»é”®
æ‰¾åˆ° 57 ä¸ªå¤–é”®

âœ… æ‰€æœ‰å¤–é”®ç±»å‹åŒ¹é…æ­£ç¡®

2. æ£€æŸ¥å­—æ®µé•¿åº¦...

âœ… å­—æ®µé•¿åº¦æ­£å¸¸

3. æ£€æŸ¥ Text ç±»å‹ä½¿ç”¨...

æ‰¾åˆ° 21 ä¸ª Text ç±»å‹å­—æ®µ

4. æ£€æŸ¥ JSON ç±»å‹...

æ‰¾åˆ° 21 ä¸ª JSON ç±»å‹å­—æ®µ

================================================================================
æ£€æŸ¥æ€»ç»“
================================================================================

âœ… æ‰€æœ‰å­—æ®µç±»å‹æ£€æŸ¥é€šè¿‡

ğŸ“Š ç»Ÿè®¡:
   - è¡¨æ•°é‡: 27
   - å¤–é”®æ•°é‡: 57
   - Text å­—æ®µ: 21
   - JSON å­—æ®µ: 21
```

## âš ï¸ SQLite vs MySQL å…¼å®¹æ€§é—®é¢˜

### å‘ç°çš„é—®é¢˜

**SQLite ä¸æ”¯æŒ BigInteger è‡ªåŠ¨å¢é•¿**

å½“ä½¿ç”¨ SQLite æ—¶ï¼ŒBigInteger ä¸»é”®çš„ `autoincrement=True` ä¼šå¯¼è‡´é”™è¯¯:
```
NOT NULL constraint failed: notification_templates.id
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: ç»§ç»­ä½¿ç”¨ SQLite (å¼€å‘ç¯å¢ƒ)

å¯¹äº SQLiteï¼Œä¿æŒä½¿ç”¨ Integer ä¸»é”®:
- SQLite çš„ INTEGER PRIMARY KEY ä¼šè‡ªåŠ¨ä½œä¸º ROWID
- æ”¯æŒè‡ªåŠ¨å¢é•¿
- è¶³å¤Ÿç”¨äºå¼€å‘å’Œæµ‹è¯•

#### æ–¹æ¡ˆ2: åˆ‡æ¢åˆ° MySQL (ç”Ÿäº§ç¯å¢ƒ)

å¯¹äº MySQLï¼Œä½¿ç”¨ BigInteger ä¸»é”®:
- æ”¯æŒæ›´å¤§çš„æ•°æ®é‡
- å¤–é”®çº¦æŸæ›´ä¸¥æ ¼
- æ›´ç¬¦åˆç”Ÿäº§ç¯å¢ƒéœ€æ±‚

### å½“å‰çŠ¶æ€

**æ•°æ®åº“**: SQLite  
**çŠ¶æ€**: å­—æ®µç±»å‹å·²ä¿®å¤ï¼Œä½†éœ€è¦ä½¿ç”¨ Integer ä¸»é”®ä»¥å…¼å®¹ SQLite

**å»ºè®®**:
1. **å¼€å‘ç¯å¢ƒ**: ä½¿ç”¨ SQLite + Integer ä¸»é”®
2. **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ MySQL + BigInteger ä¸»é”®
3. ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶æ§åˆ¶ä¸»é”®ç±»å‹

## ğŸ“ åç»­æ­¥éª¤

### 1. ç«‹å³æ‰§è¡Œ

- [x] æ¸…é™¤ Vite ç¼“å­˜
- [x] ä¿®å¤æ‰€æœ‰å¤–é”®ç±»å‹ä¸åŒ¹é…
- [x] éªŒè¯å­—æ®µç±»å‹æ­£ç¡®æ€§
- [ ] é‡æ–°åˆ›å»º SQLite æ•°æ®åº“ (ä½¿ç”¨ Integer ä¸»é”®)
- [ ] æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

### 2. æœªæ¥æ”¹è¿›

- [ ] åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] æ·»åŠ æ•°æ®åº“ç±»å‹æ£€æµ‹
- [ ] æ ¹æ®æ•°æ®åº“ç±»å‹è‡ªåŠ¨é€‰æ‹©ä¸»é”®ç±»å‹
- [ ] å®Œå–„ MySQL è¿ç§»æ–‡æ¡£

## ğŸ¯ æ€»ç»“

### ä¿®å¤å†…å®¹

1. âœ… æ¸…é™¤äº† Vite ç¼“å­˜
2. âœ… ä¿®å¤äº† 47 ä¸ªå¤–é”®ç±»å‹ä¸åŒ¹é…
3. âœ… ç»Ÿä¸€æ‰€æœ‰ä¸»é”®ä¸º BigInteger
4. âœ… æ·»åŠ äº†ç¼ºå¤±çš„ BigInteger å¯¼å…¥
5. âœ… éªŒè¯äº†æ‰€æœ‰å­—æ®µç±»å‹æ­£ç¡®æ€§

### å½“å‰çŠ¶æ€

- **å­—æ®µç±»å‹**: âœ… å®Œå…¨ç¬¦åˆ MySQL è§„èŒƒ
- **SQLite å…¼å®¹æ€§**: âš ï¸ éœ€è¦è°ƒæ•´ä¸»é”®ç±»å‹
- **å‰ç«¯é—®é¢˜**: âœ… å·²è§£å†³

### å»ºè®®

**å¯¹äºå½“å‰å¼€å‘ç¯å¢ƒ**:
- ä¿æŒä½¿ç”¨ SQLite
- å°†ä¸»é”®ç±»å‹æ”¹å› Integer (ä»…é’ˆå¯¹ SQLite)
- æˆ–è€…åˆ‡æ¢åˆ° MySQL ä»¥ä½¿ç”¨ BigInteger

**å¯¹äºç”Ÿäº§ç¯å¢ƒ**:
- ä½¿ç”¨ MySQL
- ä½¿ç”¨ BigInteger ä¸»é”®
- æ‰€æœ‰å¤–é”®ç±»å‹å·²æ­£ç¡®åŒ¹é…

---

**å®Œæˆæ—¶é—´**: 2025-11-19  
**çŠ¶æ€**: âœ… å­—æ®µç±»å‹æ£€æŸ¥å®Œæˆï¼Œå¾…æ•°æ®åº“é‡å»º

