# æ¡ˆä»¶è¯¦æƒ…å­—æ®µé…ç½® - ä»£ç é—®é¢˜æ£€æŸ¥æŠ¥å‘Š

## æ£€æŸ¥æ—¶é—´ï¼š2025-12-08

## æ£€æŸ¥èŒƒå›´

- `DetailFieldGroups.vue` - åˆ†ç»„ç®¡ç†
- `DetailStandardFields.vue` - æ ‡å‡†å­—æ®µ
- `DetailTenantFieldsView.vue` - ç”²æ–¹å­—æ®µæŸ¥çœ‹
- `DetailCustomFields.vue` - å­—æ®µæ˜ å°„é…ç½®
- `FieldDetailConfig.vue` - å­—æ®µå±•ç¤ºé…ç½®
- ç›¸å…³APIæ–‡ä»¶

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### é—®é¢˜1ï¼šå­—æ®µç±»å‹å±æ€§åç§°ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
ä¸åŒé¡µé¢å¯¹å­—æ®µç±»å‹ä½¿ç”¨äº†ä¸åŒçš„å±æ€§åï¼š

| æ–‡ä»¶ | ä½¿ç”¨çš„å±æ€§å | æ¥æº |
|------|-------------|------|
| `DetailTenantFieldsView.vue` | `field_type` | ç”²æ–¹ä¸Šä¼ JSON |
| `DetailCustomFields.vue` (æ ‡å‡†å­—æ®µ) | `field_data_type` | æ ‡å‡†å­—æ®µAPI |
| `DetailCustomFields.vue` (ç”²æ–¹å­—æ®µ) | `field_type` | ç”²æ–¹ä¸Šä¼ JSON |
| `FieldDetailConfig.vue` | `field_data_type` | å±•ç¤ºé…ç½® |

**å½±å“**ï¼š
- åœ¨æ˜ å°„é…ç½®é¡µé¢ï¼Œæ ‡å‡†å­—æ®µæ˜¾ç¤º `field_data_type`ï¼Œç”²æ–¹å­—æ®µæ˜¾ç¤º `field_type`
- ç±»å‹åŒ¹é…æ¯”è¾ƒæ—¶å¯èƒ½å‡ºé”™

**å»ºè®®ä¿®å¤**ï¼š
åœ¨æ•°æ®è§£ææ—¶ç»Ÿä¸€å­—æ®µåç§°ï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨ `field_type`

---

### é—®é¢˜2ï¼šåˆ†ç»„ç­›é€‰é€»è¾‘ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š

| æ–‡ä»¶ | ç­›é€‰å­—æ®µ | è¯´æ˜ |
|------|---------|------|
| `DetailTenantFieldsView.vue` | `field_group_id` | ä½¿ç”¨åˆ†ç»„IDç­›é€‰ |
| `DetailCustomFields.vue` | `group_key` | ä½¿ç”¨åˆ†ç»„Keyç­›é€‰ |

**ä»£ç ä½ç½®**ï¼š

`DetailTenantFieldsView.vue` (Line 660):
```javascript
result = result.filter(f => f.field_group_id && groupIds.includes(f.field_group_id))
```

`DetailCustomFields.vue` (Line 705):
```javascript
result = result.filter(m => m.group_key === group.group_key)
```

**å½±å“**ï¼š
- æ•°æ®ç»“æ„ä¸ç»Ÿä¸€ï¼Œå¯èƒ½å¯¼è‡´åˆ†ç»„ç­›é€‰å¤±æ•ˆ
- ä¸¤ä¸ªé¡µé¢çš„åˆ†ç»„é€»è¾‘ä¸ä¸€è‡´

**å»ºè®®ä¿®å¤**ï¼š
ç»Ÿä¸€ä½¿ç”¨ `group_key` è¿›è¡Œç­›é€‰ï¼Œå› ä¸ºJSONä¸Šä¼ æ—¶åˆ†ç»„ä¿¡æ¯ä»¥ `group_key` ä¸ºä¸»

---

### é—®é¢˜3ï¼šDetailCustomFields.vue - æ ‡å‡†å­—æ®µè§£æç¼ºå°‘å­—æ®µå±æ€§è½¬æ¢

**é—®é¢˜æè¿°**ï¼š
åœ¨ `loadStandardFields` å‡½æ•°ä¸­ï¼Œæ ‡å‡†å­—æ®µAPIè¿”å›çš„æ˜¯ `field_data_type`ï¼Œä½†é¡µé¢æ¨¡æ¿ä¸­ä½¿ç”¨çš„æ˜¯ `field_data_type`ï¼Œè€Œç”²æ–¹å­—æ®µä½¿ç”¨ `field_type`ã€‚

**ä»£ç ä½ç½®** (Line 881-903):
```javascript
const loadStandardFields = async () => {
  const res = await getCaseDetailStandardFields()
  const groups = res?.groups || []
  
  const fields: any[] = []
  groups.forEach(group => {
    if (group.fields && Array.isArray(group.fields)) {
      group.fields.forEach((field: any) => {
        fields.push({
          ...field,  // âš ï¸ è¿™é‡Œæ²¡æœ‰è½¬æ¢ field_data_type â†’ field_type
          group_key: group.group_key,
          group_name: group.group_name
        })
      })
    }
  })
  standardFields.value = fields
}
```

**å»ºè®®ä¿®å¤**ï¼š
æ·»åŠ å­—æ®µç±»å‹è½¬æ¢ï¼š
```javascript
fields.push({
  ...field,
  field_type: field.field_data_type || field.field_type, // ç»Ÿä¸€å­—æ®µå
  group_key: group.group_key,
  group_name: group.group_name
})
```

---

### é—®é¢˜4ï¼šDetailCustomFields.vue - æ™ºèƒ½åŒ¹é…ç±»å‹æ¯”è¾ƒé€»è¾‘

**é—®é¢˜æè¿°**ï¼š
åœ¨æ™ºèƒ½åŒ¹é…çš„ç±»å‹æ¯”è¾ƒä¸­ï¼Œä½¿ç”¨äº†ä¸ä¸€è‡´çš„å­—æ®µåï¼š

**ä»£ç ä½ç½®** (Line 1015):
```javascript
type_match: sm.field_data_type === tenantField.field_type,
```

è¿™é‡Œ `sm.field_data_type` æ¥è‡ªæ ‡å‡†å­—æ®µï¼Œ`tenantField.field_type` æ¥è‡ªç”²æ–¹å­—æ®µã€‚
å¦‚æœæ ‡å‡†å­—æ®µæ²¡æœ‰è¢«æ­£ç¡®è½¬æ¢ï¼Œæ¯”è¾ƒå¯èƒ½å¤±è´¥ã€‚

---

### é—®é¢˜5ï¼šAPIè·¯å¾„éœ€è¦ä¸åç«¯ç¡®è®¤

**éœ€è¦ç¡®è®¤çš„APIè·¯å¾„**ï¼š

| API | è·¯å¾„ | çŠ¶æ€ |
|-----|------|------|
| è·å–è¯¦æƒ…å­—æ®µåˆ†ç»„ | `GET /api/v1/detail-field-groups` | âš ï¸ å¾…ç¡®è®¤ |
| æ‰¹é‡æ›´æ–°åˆ†ç»„æ’åº | `POST /api/v1/detail-field-groups/batch-sort` | âš ï¸ å¾…ç¡®è®¤ |
| è·å–ç”²æ–¹è¯¦æƒ…å­—æ®µJSON | `GET /api/v1/tenants/{tenantId}/detail-fields-json` | âš ï¸ å¾…ç¡®è®¤ |
| ä¸Šä¼ ç”²æ–¹è¯¦æƒ…å­—æ®µJSON | `POST /api/v1/tenants/{tenantId}/detail-fields-json/upload` | âš ï¸ å¾…ç¡®è®¤ |
| è·å–ç‰ˆæœ¬å†å² | `GET /api/v1/tenants/{tenantId}/detail-fields-json/versions` | âš ï¸ å¾…ç¡®è®¤ |
| è·å–ç‰ˆæœ¬è¯¦æƒ… | `GET /api/v1/tenants/{tenantId}/detail-fields-json/versions/{id}` | âš ï¸ å¾…ç¡®è®¤ |
| æ¿€æ´»ç‰ˆæœ¬ | `POST /api/v1/tenants/{tenantId}/detail-fields-json/versions/{id}/activate` | âš ï¸ å¾…ç¡®è®¤ |
| å¯¹æ¯”ç‰ˆæœ¬ | `GET /api/v1/tenants/{tenantId}/detail-fields-json/versions/compare` | âš ï¸ å¾…ç¡®è®¤ |
| ä¸‹è½½JSONæ¨¡æ¿ | `GET /api/v1/detail-fields-json/template` | âš ï¸ å¾…ç¡®è®¤ |
| éªŒè¯JSON | `POST /api/v1/detail-fields-json/validate` | âš ï¸ å¾…ç¡®è®¤ |
| æ¡ˆä»¶è¯¦æƒ…æ ‡å‡†å­—æ®µ | `GET /api/v1/standard-fields/case-detail` | âœ… å·²å­˜åœ¨ |

---

## âœ… å·²ç¡®è®¤æ­£ç¡®çš„éƒ¨åˆ†

### 1. APIå¯¼å…¥å’Œè°ƒç”¨

æ‰€æœ‰é¡µé¢çš„APIå¯¼å…¥éƒ½æ˜¯æ­£ç¡®çš„ï¼š
- `import { getDetailFieldGroups } from '@/api/detailFieldGroup'`
- `import { getDetailTenantFieldsJson } from '@/api/detailTenantFields'`
- `import { getCaseDetailStandardFields } from '@/api/field'`

### 2. åˆ†ç»„æ ‘æ„å»ºé€»è¾‘

æ‰€æœ‰é¡µé¢çš„åˆ†ç»„æ ‘æ„å»ºé€»è¾‘ä¸€è‡´ï¼Œä½¿ç”¨é€’å½’æ–¹å¼æ„å»ºå­åˆ†ç»„ï¼š
```javascript
const groupTree = computed(() => {
  const roots = allGroups.value.filter(g => !g.parent_id)
  const buildChildren = (parentId: number) => {
    return allGroups.value
      .filter(g => g.parent_id === parentId)
      .sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0))
      .map(g => ({ /* ... */ }))
  }
  // ...
})
```

### 3. Lintæ£€æŸ¥

æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶é€šè¿‡äº†ESLintæ£€æŸ¥ï¼Œæ— è¯­æ³•é”™è¯¯ã€‚

### 4. æ•°æ®å…œåº•æœºåˆ¶

`DetailTenantFieldsView.vue` æ­£ç¡®å®ç°äº†æ•°æ®å…œåº•ï¼š
```javascript
if (res?.groups && res.groups.length > 0) {
  // æ˜¾ç¤ºç”²æ–¹ä¸Šä¼ çš„å­—æ®µ
} else {
  // å…œåº•ï¼šä½¿ç”¨æ ‡å‡†å­—æ®µ
  const standardRes = await getCaseDetailStandardFields()
}
```

---

## ğŸ”§ ä¿®å¤å»ºè®®

### å»ºè®®1ï¼šç»Ÿä¸€å­—æ®µç±»å‹å±æ€§å

åœ¨æ•°æ®è§£ææ—¶ç»Ÿä¸€è½¬æ¢ä¸º `field_type`ï¼š

**ä¿®æ”¹ `DetailCustomFields.vue` çš„ `loadStandardFields` å‡½æ•°**ï¼š

```javascript
const loadStandardFields = async () => {
  const res = await getCaseDetailStandardFields()
  const groups = res?.groups || []
  
  const fields: any[] = []
  groups.forEach(group => {
    if (group.fields && Array.isArray(group.fields)) {
      group.fields.forEach((field: any) => {
        fields.push({
          ...field,
          // ç»Ÿä¸€å­—æ®µç±»å‹å±æ€§å
          field_type: field.field_data_type || field.field_type,
          field_data_type: field.field_data_type || field.field_type,
          group_key: group.group_key,
          group_name: group.group_name
        })
      })
    }
  })
  standardFields.value = fields
}
```

### å»ºè®®2ï¼šç»Ÿä¸€åˆ†ç»„ç­›é€‰é€»è¾‘

å»ºè®®éƒ½ä½¿ç”¨ `group_key` è¿›è¡Œç­›é€‰ï¼Œå¹¶åœ¨è§£ææ•°æ®æ—¶ç¡®ä¿å­—æ®µåŒ…å« `group_key`ã€‚

### å»ºè®®3ï¼šæ·»åŠ TypeScriptç±»å‹å®šä¹‰

ä¸ºå­—æ®µæ•°æ®æ·»åŠ æ˜ç¡®çš„ç±»å‹å®šä¹‰ï¼Œé¿å…å±æ€§åæ··ä¹±ï¼š

```typescript
interface DetailField {
  field_key: string
  field_name: string
  field_type: string       // ç»Ÿä¸€ä½¿ç”¨ field_type
  field_data_type?: string // å…¼å®¹æ—§å±æ€§
  group_key: string
  group_name: string
  is_required?: boolean
  sort_order?: number
  enum_values?: string[]
  description?: string
}
```

---

## ğŸ“‹ ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“ |
|--------|------|------|
| ğŸ”´ é«˜ | å­—æ®µç±»å‹å±æ€§ä¸ä¸€è‡´ | å¯èƒ½å¯¼è‡´ç±»å‹åŒ¹é…å¤±è´¥ |
| ğŸŸ¡ ä¸­ | åˆ†ç»„ç­›é€‰é€»è¾‘ä¸ä¸€è‡´ | å¯èƒ½å¯¼è‡´ç­›é€‰åŠŸèƒ½å¼‚å¸¸ |
| ğŸŸ¢ ä½ | APIè·¯å¾„å¾…ç¡®è®¤ | éœ€ä¸åç«¯è”è°ƒç¡®è®¤ |

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³ä¿®å¤**ï¼šç»Ÿä¸€å­—æ®µç±»å‹å±æ€§å
2. **è”è°ƒç¡®è®¤**ï¼šä¸åç«¯ç¡®è®¤APIè·¯å¾„
3. **æµ‹è¯•éªŒè¯**ï¼šå®Œæˆä¿®å¤åè¿›è¡ŒåŠŸèƒ½æµ‹è¯•

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### ä¿®å¤1ï¼šç»Ÿä¸€å­—æ®µç±»å‹å±æ€§åï¼ˆå·²å®Œæˆï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`frontend/src/views/field-config/DetailCustomFields.vue`

**ä¿®æ”¹å†…å®¹**ï¼š

1. **loadStandardFields å‡½æ•°**ï¼šæ·»åŠ å­—æ®µç±»å‹è½¬æ¢
```javascript
fields.push({
  ...field,
  // ç»Ÿä¸€å­—æ®µç±»å‹å±æ€§åï¼šæ ‡å‡†å­—æ®µAPIè¿”å›field_data_typeï¼Œç»Ÿä¸€è½¬æ¢ä¸ºfield_type
  field_type: field.field_data_type || field.field_type,
  group_key: group.group_key,
  group_name: group.group_name
})
```

2. **æ¨¡æ¿ä¸­çš„å­—æ®µç±»å‹æ˜¾ç¤º**ï¼šä½¿ç”¨å…¼å®¹å†™æ³•
```html
<el-tag size="small" type="info">{{ row.field_type || row.field_data_type }}</el-tag>
```

3. **ç¼–è¾‘æ˜ å°„å¯¹è¯æ¡†**ï¼šä½¿ç”¨å…¼å®¹å†™æ³•
```html
<el-descriptions-item label="å­—æ®µç±»å‹">{{ editingMapping.field_type || editingMapping.field_data_type }}</el-descriptions-item>
```

4. **æ™ºèƒ½åŒ¹é…ç±»å‹æ¯”è¾ƒ**ï¼šä½¿ç”¨å…¼å®¹å†™æ³•
```javascript
type_match: (sm.field_type || sm.field_data_type) === tenantField.field_type,
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-12-08  
**çŠ¶æ€**ï¼šâœ… å…³é”®é—®é¢˜å·²ä¿®å¤
