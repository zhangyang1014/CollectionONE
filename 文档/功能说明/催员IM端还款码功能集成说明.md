# 催员IM端 - 还款码功能集成说明

## 更新时间
2025年11月21日

## 功能概述

已在催员IM端的案件详情页面集成了"还款码"功能入口，催员可以直接在案件详情中请求和管理还款码。

## 更新内容

### 1. 新增Tab页

在案件详情页面的Tab列表中新增了"还款码"Tab，位于"还款记录"Tab之后。

**Tab列表：**
1. 客户信息
2. 影像资料
3. 贷款信息
4. 历史借款
5. 还款记录
6. **还款码** ⭐（新增）

### 2. 文件修改

#### 修改的文件：
```
/frontend/src/components/CaseDetail.vue
```

**主要修改点：**
1. 导入PaymentCodeTab组件
2. 在el-tabs中新增"还款码"tab-pane
3. 传递案件数据给PaymentCodeTab组件

#### 更新的文件：
```
/frontend/src/views/im/components/PaymentCodeTab.vue
```

**优化点：**
1. 增强了案件数据兼容性（支持id/case_id、tenant_id/party_id等字段）
2. 改进错误处理和日志记录
3. 优化用户提示信息

### 3. 功能入口

催员使用流程：

```
催员工作台
    ↓
选择案件
    ↓
案件详情页面
    ↓
点击"还款码"Tab
    ↓
查看/请求还款码
```

## 功能特性

### 3.1 请求还款码

1. **点击"请求还款码"按钮**
   - 显示所有可用的支付渠道卡片
   - 每个卡片显示渠道图标、名称、类型

2. **选择支付渠道**
   - 点击渠道卡片
   - 弹出金额输入对话框

3. **选择期数和金额**
   - 自动加载案件的分期信息
   - 选择需要还款的期数
   - 自动填充该期应还金额（本金+利息+罚息+费用）
   - 可手动调整还款金额

4. **生成还款码**
   - 点击"确认生成"
   - 系统调用第三方接口生成还款码
   - 弹窗展示还款码详情

### 3.2 查看还款码列表

**筛选功能：**
- 全部
- 待支付
- 已支付
- 已过期

**列表信息：**
- 渠道图标和名称
- 支付类型（VA码/H5链接/二维码）
- 期数
- 金额
- 状态
- 有效期倒计时（待支付状态）
- 创建时间

**操作：**
- 查看详情

### 3.3 还款码详情

根据支付类型显示不同内容：

**VA码（虚拟账户）：**
- 显示虚拟账户号（大字体）
- 复制按钮
- 有效期信息

**H5链接：**
- 显示支付链接
- 复制链接按钮
- 打开链接按钮
- 有效期信息

**二维码：**
- 显示二维码图片
- 支持预览放大
- 有效期信息

## 使用示例

### 场景1：为逾期案件生成还款码

```
催员登录 → 选择逾期案件 → 切换到"还款码"Tab →
点击"请求还款码" → 选择"GCash"渠道 →
系统自动选择逾期期数（第2期） → 自动填充应还金额 ₱5,350 →
确认生成 → 获得VA码：8808123456789012 →
复制发送给客户
```

### 场景2：查看历史还款码

```
催员登录 → 选择案件 → 切换到"还款码"Tab →
查看已生成的还款码列表 →
筛选"待支付"状态 →
点击"查看详情" →
查看还款码信息和有效期
```

## 技术说明

### 数据兼容性

PaymentCodeTab组件支持多种案件数据格式：

```typescript
// 案件ID
caseInfo.id || caseInfo.case_id

// 甲方ID
caseInfo.tenant_id || caseInfo.party_id

// 客户姓名
caseInfo.customer_name || caseInfo.user_name
```

### 错误处理

- 网络错误：显示友好提示信息
- 数据缺失：自动使用默认值或占位符
- API失败：记录详细日志便于排查

### 数据刷新

- 生成还款码后自动刷新列表
- 切换筛选条件时重新加载
- 支持手动刷新

## 配置要求

### 后端配置

1. **数据库表已创建**
   - payment_channels（还款渠道配置）
   - payment_codes（还款码记录）

2. **API接口可用**
   - `/api/im/payment-channels` - 获取可用渠道
   - `/api/im/cases/{case_id}/installments` - 获取期数信息
   - `/api/im/payment-codes/request` - 请求还款码
   - `/api/im/payment-codes` - 查询还款码列表
   - `/api/im/payment-codes/{code_no}` - 查询还款码详情

3. **权限配置**
   - `payment_code:request` - 请求还款码
   - `payment_code:view` - 查看还款码

### 前端配置

无需额外配置，已集成到现有案件详情页面。

## 测试建议

### 1. 功能测试

✅ **Tab显示测试**
- 进入案件详情页面
- 确认"还款码"Tab显示正常
- 点击切换到"还款码"Tab

✅ **渠道加载测试**
- 点击"请求还款码"
- 确认渠道列表加载正常
- 验证渠道图标、名称、类型显示

✅ **请求还款码测试**
- 选择渠道
- 选择期数
- 验证金额自动填充
- 生成还款码
- 验证还款码显示

✅ **列表筛选测试**
- 切换不同状态筛选
- 验证列表更新
- 检查有效期倒计时

✅ **详情查看测试**
- 点击"查看详情"
- 验证详情信息完整
- 测试复制功能（VA码/H5链接）

### 2. 兼容性测试

- 测试不同案件数据格式
- 测试无渠道配置情况
- 测试网络错误情况
- 测试空数据情况

### 3. 性能测试

- 大量还款码列表加载
- 频繁切换Tab
- 并发请求还款码

## 已知限制

1. **期数数据为模拟数据**
   - 当前返回的期数信息是模拟数据
   - 需要后续对接真实的分期表

2. **第三方接口为模拟调用**
   - 当前使用模拟的第三方响应
   - 需要后续对接真实的支付网关

3. **无实时状态同步**
   - 支付状态需要手动刷新
   - 待实现Webhook实时推送

## 后续优化

### 短期优化

1. 对接真实的分期表数据
2. 集成真实的支付网关API
3. 实现Webhook状态推送
4. 添加还款码生成通知

### 中期优化

1. 支持批量生成还款码
2. 添加还款码分享功能
3. 支持自定义有效期
4. 添加还款提醒功能

### 长期优化

1. 智能推荐支付渠道
2. 还款码使用统计
3. 客户支付行为分析
4. 多语言支持

## 截图示例

### 还款码Tab位置

```
┌─────────────────────────────────────┐
│ 案件详情                             │
├─────────────────────────────────────┤
│ [客户信息] [影像资料] [贷款信息]      │
│ [历史借款] [还款记录] [还款码] ⭐     │
├─────────────────────────────────────┤
│ 还款码内容区域                        │
│ [请求还款码] 按钮                     │
│                                       │
│ 还款码列表...                         │
└─────────────────────────────────────┘
```

### 渠道选择界面

```
┌─────────────────────────────────────┐
│ 选择还款渠道                          │
├─────────────────────────────────────┤
│ ┌─────────┐  ┌─────────┐            │
│ │ [图标]  │  │ [图标]  │            │
│ │ GCash   │  │ BCA VA  │            │
│ │ VA码    │  │ VA码    │            │
│ │ Xendit  │  │ Midtrans│            │
│ └─────────┘  └─────────┘            │
└─────────────────────────────────────┘
```

## 问题排查

### 问题1：还款码Tab不显示

**可能原因：**
- 组件未正确导入
- Tab配置错误

**解决方案：**
```bash
# 检查浏览器控制台错误
# 确认文件修改已保存
# 清理缓存重新加载
```

### 问题2：无法加载渠道列表

**可能原因：**
- 后端API未启动
- 甲方未配置渠道
- 网络请求失败

**解决方案：**
```bash
# 检查后端服务状态
# 登录管理控台配置测试渠道
# 查看网络请求日志
```

### 问题3：生成还款码失败

**可能原因：**
- 第三方API配置错误
- 案件数据不完整
- 权限不足

**解决方案：**
```bash
# 检查后端日志
# 验证案件数据完整性
# 确认催员权限配置
```

## 联系方式

如有问题或建议，请联系开发团队或查看：
- 功能说明文档：`/说明文档/功能说明/还款渠道配置功能说明.md`
- 完成报告：`/文档/功能说明/还款渠道配置完成报告.md`

---

**更新日期：** 2025年11月21日  
**版本：** v1.0.0  
**状态：** ✅ 已完成并集成

