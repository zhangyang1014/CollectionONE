# 通知模板 - 最终解决方案

## ⚠️ 核心问题

**后端服务没有重启，新的API路由未加载！**

所有404错误都是因为后端服务需要重启才能加载 `notification_template` 路由。

## 🎯 完整解决方案（按顺序执行）

### 第一步：创建数据库表和数据

打开终端，执行：

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
mysql -u root -p cco_system < mock_notification_templates.sql
```

输入MySQL密码后回车。

**验证**：
```bash
mysql -u root -p cco_system -e "SELECT COUNT(*) FROM notification_templates;"
```

应该显示 `10`。

---

### 第二步：重启后端服务（关键！）

#### 方法A：使用自动脚本（推荐）

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
./restart_backend.sh
```

脚本会自动：
- 停止旧服务
- 检查环境
- 安装依赖
- 启动新服务
- 测试API

#### 方法B：手动重启

```bash
# 1. 停止所有后端服务
pkill -f "uvicorn app.main:app"

# 2. 进入backend目录
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend

# 3. 启动服务
venv/bin/python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**等待看到**：
```
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

---

### 第三步：验证API

打开**新的终端窗口**，测试API：

```bash
# 测试基础API
curl http://localhost:8000/

# 应该返回：
# {"message":"CCO System API","version":"1.0.0"}

# 测试通知模板API
curl http://localhost:8000/api/v1/notification-templates

# 应该返回JSON数组（10条模板数据）
# 如果返回 {"detail":"Not Found"} 说明服务未重启或数据库表未创建
```

---

### 第四步：刷新前端

1. **强制刷新浏览器**：
   - Mac: `Cmd + Shift + R`
   - Windows: `Ctrl + Shift + R`

2. **访问通知模板页面**：
   - 登录：`http://localhost:5173/admin/login`
   - 进入：系统管理 -> 通知配置 -> 通知模板

3. **应该看到10条模板**！

---

## ✅ 成功标志

- [ ] SQL执行成功，数据库有10条数据
- [ ] 后端服务已重启（看到启动日志）
- [ ] `curl http://localhost:8000/api/v1/notification-templates` 返回JSON数组
- [ ] 前端页面显示10条模板数据
- [ ] 没有404错误

---

## 🔍 故障排查

### 问题1：后端启动失败

**错误**: `No module named 'uvicorn'`

**解决**:
```bash
cd backend
venv/bin/pip install -r requirements.txt
```

---

### 问题2：API仍然返回404

**原因**: 后端服务没有在正确的目录运行

**检查**:
```bash
ps aux | grep uvicorn
```

应该看到路径包含：`/Users/zhangyang/Documents/GitHub/CollectionONE/backend`

**解决**: 停止错误的服务，在正确目录重新启动

---

### 问题3：数据库连接失败

**错误**: `Can't connect to MySQL server`

**解决**:
1. 确保MySQL服务正在运行
2. 检查数据库配置：`backend/app/core/config.py`
3. 确保数据库 `cco_system` 存在

---

### 问题4：前端仍然显示"暂无数据"

**检查清单**:
1. 后端API测试通过（curl返回JSON）
2. 浏览器已强制刷新
3. 浏览器控制台没有404错误
4. 前端服务正在运行

**解决**:
```bash
# 清除Vite缓存
cd frontend
rm -rf node_modules/.vite

# 重启前端
npm run dev
```

---

## 📋 快速检查清单

执行以下命令快速检查所有环节：

```bash
# 1. 检查数据库
mysql -u root -p cco_system -e "SELECT COUNT(*) FROM notification_templates;"
# 应该返回: 10

# 2. 检查后端进程
ps aux | grep uvicorn | grep -v grep
# 应该看到进程在运行

# 3. 测试API
curl http://localhost:8000/api/v1/notification-templates | head -20
# 应该看到JSON数据

# 4. 测试模板类型API
curl http://localhost:8000/api/v1/notification-templates/types/list
# 应该看到types数组
```

全部通过后，刷新浏览器即可看到数据。

---

## 🎁 预期结果

成功后应该看到10条模板：

| # | 模板名称 | 模板ID | 优先级 | 发送对象 | 状态 |
|---|---------|--------|--------|---------|------|
| 1 | 案件标签变化通知 | case_tag_change | 中 | 机构 | ✅ |
| 2 | 案件还款到账通知 | case_payment | 高 | 催员 | ✅ |
| 3 | 用户APP访问提醒 | user_app_visit | 中 | 催员 | ✅ |
| 4 | 用户还款页访问通知 | user_payment_page_visit | 高 | 催员 | ✅ |
| 5 | 新案件分配通知 | case_assigned | 高 | 催员 | ✅ |
| 6 | PTP承诺到期提醒 | ptp_reminder | 高 | 催员 | ✅ |
| 7 | 案件逾期升级警告 | overdue_escalation | 高 | 小组 | ✅ |
| 8 | 小组业绩达成通知 | team_performance | 中 | 小组 | ✅ |
| 9 | 催员日报提交提醒 | daily_report_reminder | 低 | 催员 | ✅ |
| 10 | 系统维护公告 | system_maintenance | 高 | 机构 | ❌ 已禁用 |

---

## 📞 仍然有问题？

如果按照以上步骤操作后仍有问题，请提供：

1. **SQL执行结果**：
   ```bash
   mysql -u root -p cco_system -e "SELECT * FROM notification_templates;"
   ```

2. **后端进程信息**：
   ```bash
   ps aux | grep uvicorn
   ```

3. **API测试结果**：
   ```bash
   curl -v http://localhost:8000/api/v1/notification-templates
   ```

4. **浏览器控制台截图**（F12 -> Console标签）

---

## 🎯 核心要点

1. **必须重启后端服务**：热重载不会加载新的路由模块
2. **必须在正确目录启动**：确保在 `/Users/zhangyang/Documents/GitHub/CollectionONE/backend`
3. **必须先创建数据库表**：否则API会报错
4. **必须强制刷新浏览器**：清除前端缓存

---

**最终解决方案** | 版本 v2.0 | 更新时间：2025-11-19

