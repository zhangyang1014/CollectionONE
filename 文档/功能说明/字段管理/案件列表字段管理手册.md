# 案件列表字段管理手册

> **版本**: v1.0  
> **更新时间**: 2025-12-08  
> **适用场景**: 控台案件列表、IM端案件列表

---

## 一、架构概述

### 1.1 整体架构

案件列表字段管理系统采用**四层架构**，实现从甲方原始数据到前端展示的完整链路：

```text
甲方字段（JSON文件）
    ↓
标准字段映射（mapping）
    ↓
字段展示配置（display config）
    ↓
前端列表展示
```

### 1.2 核心概念

| 层级 | 名称 | 作用 | 数据来源 |
|------|------|------|----------|
| **Layer 1** | 标准字段 | 系统预定义的字段规范 | 系统内置（`standard_fields`表） |
| **Layer 2** | 甲方字段 | 各甲方的原始字段数据 | 甲方上传JSON文件 |
| **Layer 3** | 映射配置 | 将甲方字段映射到标准字段 | 人工配置（`tenant_field_uploads`表） |
| **Layer 4** | 展示配置 | 控制字段在列表中的展示 | 管理员配置（本地JSON文件） |

---

## 二、标准字段（Layer 1）

### 2.1 定义

**标准字段**是CCO系统预定义的字段规范，用于统一不同甲方的字段命名和数据类型。

### 2.2 核心属性

```typescript
{
  field_key: string        // 字段标识（唯一，如 case_id）
  field_name: string       // 字段名称（如 案件编号）
  field_type: string       // 数据类型（String/Integer/Enum/Date等）
  description: string      // 字段说明
  is_required: boolean     // 是否必填
  enum_values?: string[]   // 枚举选项（仅Enum类型）
}
```

### 2.3 数据类型

| 类型 | 说明 | 支持功能 | 示例 |
|------|------|----------|------|
| **String** | 文本 | 可搜索 | 案件编号、客户姓名 |
| **Integer** | 整数 | 范围检索 | 逾期天数、期数 |
| **Number** | 数字（含小数） | 范围检索 | 借款金额、未还金额 |
| **Decimal** | 精确小数 | 范围检索 | 利率、费率 |
| **Enum** | 枚举 | 可筛选 | 案件状态、还款状态 |
| **Date** | 日期 | 范围检索 | 到期日期、分配日期 |
| **Datetime** | 日期时间 | 范围检索 | 创建时间、更新时间 |
| **Boolean** | 布尔值 | 可筛选 | 是否逾期、是否首逾 |

### 2.4 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件列表标准字段管理
- **路由**: `/field-config/standard`
- **权限**: SuperAdmin（仅超级管理员）

---

## 三、甲方字段（Layer 2）

### 3.1 定义

**甲方字段**是各甲方系统中的原始字段数据，通过JSON文件上传到CCO系统。

### 3.2 JSON格式规范

```json
{
  "version": "1.0",
  "scene": "admin_case_detail",
  "tenant_id": "1",
  "tenant_name": "示例甲方",
  "updated_at": "2025-12-08T10:00:00",
  "description": "案件列表字段配置",
  "fields": [
    {
      "field_name": "案件编号",
      "field_key": "case_id",
      "field_type": "String",
      "enum_values": null,
      "is_required": true,
      "sort_order": 1,
      "description": "案件唯一标识"
    },
    {
      "field_name": "案件状态",
      "field_key": "case_status",
      "field_type": "Enum",
      "enum_values": ["待分配", "催收中", "已完成", "已关闭"],
      "is_required": true,
      "sort_order": 2,
      "description": "案件当前状态"
    }
  ]
}
```

### 3.3 上传方式

1. **手动上传**: 通过管理控台上传JSON文件
2. **API对接**: 通过API接口推送字段配置（需开启功能开关）

### 3.4 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件列表甲方字段查看
- **路由**: `/field-config/tenant-fields`
- **权限**: SuperAdmin / TenantAdmin

---

## 四、映射配置（Layer 3）

### 4.1 定义

**映射配置**将甲方字段映射到标准字段，实现字段的统一化和标准化。

### 4.2 映射关系

```text
甲方字段             →    标准字段
case_no             →    case_id
borrower_name       →    customer_name
overdue_day_count   →    overdue_days
loan_amt            →    loan_amount
```

### 4.3 映射类型

| 映射类型 | 说明 | 示例 |
|---------|------|------|
| **1:1映射** | 一个甲方字段映射到一个标准字段 | `case_no` → `case_id` |
| **标准字段** | 直接使用标准字段（字段key相同） | `case_id` → `case_id` |
| **自定义字段** | 不映射到标准字段，作为拓展字段 | `custom_field_1` → 无映射 |

### 4.4 映射配置流程

```text
上传甲方JSON
    ↓
系统自动提取字段列表
    ↓
管理员配置映射关系（选择标准字段）
    ↓
保存为新版本（版本号自增）
    ↓
激活版本（设为当前生效版本）
```

### 4.5 版本管理

- **版本存储**: `tenant_field_uploads` 表
- **版本号**: 整数，从1开始自增
- **激活机制**: 同一甲方+场景只能有一个激活版本
- **历史查看**: 支持查看所有历史版本
- **版本恢复**: 支持恢复到任意历史版本

### 4.6 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件列表字段映射配置
- **路由**: `/field-config/mapping`
- **权限**: SuperAdmin / TenantAdmin

---

## 五、展示配置（Layer 4）

### 5.1 定义

**展示配置**控制字段在案件列表中的展示方式，包括显示顺序、宽度、颜色、筛选等。

### 5.2 核心属性

```typescript
{
  field_key: string           // 字段标识
  field_name: string          // 字段名称
  field_data_type: string     // 数据类型
  sort_order: number          // 显示顺序
  display_width: number       // 列宽（0=自动）
  color_type: string          // 颜色类型（normal/red/yellow/green）
  is_filterable: boolean      // 是否可筛选（Enum类型）
  is_range_searchable: boolean // 是否支持范围检索（数字/日期类型）
  enum_options?: any[]        // 枚举选项（仅Enum类型）
}
```

### 5.3 支持的配置项

| 配置项 | 适用类型 | 说明 |
|--------|---------|------|
| **显示顺序** | 全部 | 通过拖拽调整字段顺序 |
| **列宽** | 全部 | 设置字段列宽（0=自动，单位px） |
| **颜色标记** | 全部 | 设置字段颜色（普通/红/黄/绿） |
| **可筛选** | Enum | 启用下拉筛选功能 |
| **范围检索** | Integer/Number/Decimal/Date/Datetime | 启用范围搜索（如逾期天数 > 30） |

### 5.4 数据来源优先级

```text
优先级1: 本地激活版本（~/.cco-storage/case-list-display-versions/）
    ↓ 如果不存在
优先级2: 映射配置最新版本（tenant_field_uploads表）
    ↓ 如果不存在
优先级3: 内置Mock字段（12个基础字段）
```

### 5.5 Mock字段列表

系统内置12个基础字段作为兜底数据：

| 序号 | 字段名称 | 字段标识 | 类型 | 必填 |
|------|---------|---------|------|------|
| 1 | 案件编号 | case_id | String | ✓ |
| 2 | 案件状态 | case_status | Enum | ✓ |
| 3 | 逾期天数 | overdue_days | Integer | ✗ |
| 4 | 借款金额 | loan_amount | Number | ✓ |
| 5 | 未还金额 | outstanding_amount | Number | ✓ |
| 6 | 客户姓名 | customer_name | String | ✓ |
| 7 | 联系电话 | phone | String | ✓ |
| 8 | 产品名称 | product_name | String | ✗ |
| 9 | APP名称 | app_name | String | ✗ |
| 10 | 商户名称 | merchant_name | String | ✗ |
| 11 | 到期日期 | due_date | Date | ✓ |
| 12 | 催收员 | collector | String | ✗ |

### 5.6 版本管理

- **版本存储**: 本地JSON文件（`~/.cco-storage/case-list-display-versions/{tenantId}_{sceneType}.json`）
- **版本号**: 整数，从1开始自增
- **激活机制**: 同一甲方+场景只能有一个激活版本
- **版本内容**: 完整的字段配置快照（包括顺序、宽度、开关等）

### 5.7 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件列表字段展示配置
- **路由**: `/field-config/list`
- **权限**: SuperAdmin / TenantAdmin

---

## 六、场景类型

### 6.1 支持的场景

| 场景Key | 场景名称 | 说明 |
|---------|---------|------|
| `admin_case_detail` | 控台案件列表 | 管理控台的案件列表页面字段配置 |
| `collector_case_detail` | IM端案件列表 | 催员端的案件列表页面字段配置 |

> **注意**: 场景类型命名保留了历史的 `_detail` 后缀，但实际用于列表页面配置。

### 6.2 场景隔离

- 每个场景的配置**完全独立**
- 控台和IM端可以配置不同的字段、不同的顺序
- 版本管理按场景分别存储

---

## 七、完整数据流转

### 7.1 初次配置流程

```text
【步骤1】上传甲方字段JSON
  操作: 管理控台 → 案件列表甲方字段查看 → 上传文件
  结果: 系统解析JSON，提取字段列表
    ↓

【步骤2】配置字段映射
  操作: 管理控台 → 案件列表字段映射配置 → 选择标准字段
  结果: 生成映射关系，保存为v1版本并激活
    ↓

【步骤3】配置字段展示
  操作: 管理控台 → 案件列表字段展示配置 → 调整顺序/宽度/开关
  结果: 从映射配置读取字段列表，显示在页面
    ↓

【步骤4】保存展示配置版本
  操作: 点击"保存为新版本"按钮
  结果: 生成展示配置v1版本，保存到本地文件并激活
    ↓

【步骤5】前端展示
  操作: 前端案件列表页面加载
  结果: 读取展示配置v1，渲染案件列表
```

### 7.2 更新配置流程

```text
【场景A】甲方字段变更
  甲方上传新的JSON（新增/删除字段）
    ↓
  重新配置映射关系
    ↓
  保存为映射配置v2并激活
    ↓
  展示配置自动读取新的映射配置
    ↓
  管理员调整展示配置（如果需要）
    ↓
  保存为展示配置v2

【场景B】仅调整展示配置
  管理员修改字段顺序/宽度/颜色/开关
    ↓
  保存为展示配置v2
    ↓
  前端立即生效
```

### 7.3 版本恢复流程

```text
【映射配置恢复】
  查看映射配置版本历史
    ↓
  选择某个历史版本
    ↓
  点击"恢复此版本"
    ↓
  该版本被设为激活版本
    ↓
  展示配置自动读取恢复后的映射配置

【展示配置恢复】
  查看展示配置版本历史
    ↓
  选择某个历史版本
    ↓
  点击"恢复此版本"
    ↓
  该版本被设为激活版本
    ↓
  前端立即生效
```

---

## 八、API接口

### 8.1 映射配置相关

```typescript
// 获取当前激活的映射配置版本
GET /api/v1/tenants/{tenantId}/fields/{sceneType}/current

// 保存映射配置为新版本
POST /api/v1/tenants/{tenantId}/fields/{sceneType}/upload

// 获取映射配置版本历史
GET /api/v1/tenants/{tenantId}/fields/{sceneType}/history

// 激活指定版本
POST /api/v1/tenants/{tenantId}/fields/{sceneType}/activate
```

### 8.2 展示配置相关

```typescript
// 获取字段展示配置列表
GET /api/v1/case-list-field-configs?tenantId=1&sceneType=admin_case_detail

// 获取当前展示配置版本信息
GET /api/v1/case-list-field-configs/version?tenantId=1&sceneType=admin_case_detail

// 保存展示配置为新版本
POST /api/v1/case-list-field-configs/version/save

// 获取展示配置版本历史
GET /api/v1/case-list-field-configs/version/history?tenantId=1&sceneType=admin_case_detail

// 激活展示配置版本
POST /api/v1/case-list-field-configs/version/activate

// 获取场景类型列表
GET /api/v1/case-list-field-configs/scene-types
```

---

## 九、常见问题

### 9.1 为什么分成映射配置和展示配置两层？

**原因**:
- **映射配置**: 关注字段的语义对齐（甲方字段 → 标准字段）
- **展示配置**: 关注前端展示效果（顺序、宽度、颜色等）
- **解耦**: 甲方字段变更时，只需更新映射配置，展示配置可保持不变

### 9.2 页面显示"基于映射配置版本：v0，来源：内置Mock"是什么意思？

**含义**:
- **v0**: 表示没有找到映射配置版本，使用Mock数据
- **内置Mock**: 系统内置的12个基础字段
- **解决**: 上传甲方JSON并配置映射关系

### 9.3 修改展示配置后，前端没有立即生效？

**检查步骤**:
1. 是否点击了"保存为新版本"？
2. 版本是否被激活？
3. 前端是否刷新了页面？
4. 浏览器缓存是否清除？

### 9.4 如何查看当前使用的是哪个版本？

**查看方式**:
- **映射配置**: 页面顶部显示"当前版本：v3"
- **展示配置**: 页面顶部显示"基于映射配置版本：v3，来源：数据库"

### 9.5 版本号是如何生成的？

**生成规则**:
- 版本号从**1**开始
- 每次保存新版本，版本号**自动加1**
- 版本号**不会重复**，即使删除了某个版本

### 9.6 删除本地版本文件会怎样？

**影响**:
- 展示配置会回退到**映射配置**
- 如果映射配置也不存在，则回退到**Mock数据**
- 不会影响数据库中的映射配置

### 9.7 枚举字段的枚举值从哪里来？

**来源**:
1. **甲方JSON**: 如果甲方JSON中定义了 `enum_values`，则使用甲方的枚举值
2. **标准字段**: 如果映射到了标准字段，则使用标准字段的枚举值
3. **Mock数据**: 如果使用Mock数据，则使用系统预定义的枚举值

---

## 十、操作指南

### 10.1 初次配置（从零开始）

**步骤1：准备甲方字段JSON**
```json
{
  "version": "1.0",
  "scene": "admin_case_detail",
  "tenant_id": "1",
  "fields": [
    {"field_name": "案件编号", "field_key": "case_id", "field_type": "String", ...},
    {"field_name": "案件状态", "field_key": "status", "field_type": "Enum", ...}
  ]
}
```

**步骤2：上传并配置映射**
1. 进入"案件列表字段映射配置"页面
2. 点击"上传新版本"
3. 上传JSON文件
4. 为每个字段选择对应的标准字段（或标记为自定义字段）
5. 填写版本备注
6. 点击"保存并激活"

**步骤3：配置展示**
1. 进入"案件列表字段展示配置"页面
2. 系统自动加载映射配置的字段列表
3. 拖拽调整字段顺序
4. 设置字段宽度、颜色
5. 配置筛选和范围检索开关
6. 点击"保存为新版本"
7. 填写版本备注
8. 确认保存

**步骤4：验证**
1. 刷新前端案件列表页面
2. 检查字段顺序、宽度、筛选功能是否正确
3. 测试范围检索功能

### 10.2 更新甲方字段

**步骤1：准备新的JSON**
- 新增/删除/修改字段
- 版本号保持为"1.0"（系统会自动递增数据库版本）

**步骤2：上传新版本**
1. 进入"案件列表字段映射配置"页面
2. 点击"上传新版本"
3. 上传新的JSON文件
4. 系统自动生成v2版本并激活

**步骤3：调整展示配置**
1. 进入"案件列表字段展示配置"页面
2. 页面会显示"基于映射配置版本：v2"
3. 调整新增字段的顺序和配置
4. 保存为展示配置新版本

### 10.3 恢复历史版本

**恢复映射配置**
1. 进入"案件列表字段映射配置"页面
2. 点击"版本历史"
3. 在历史列表中找到目标版本
4. 点击"恢复此版本"
5. 确认恢复操作

**恢复展示配置**
1. 进入"案件列表字段展示配置"页面
2. 点击"版本历史"
3. 在历史列表中找到目标版本
4. 点击"恢复此版本"
5. 确认恢复操作

---

## 十一、技术实现

### 11.1 后端技术栈

- **框架**: Spring Boot 3.3.5
- **ORM**: MyBatis-Plus 3.5.8
- **数据库**: MySQL 8.0
- **存储**: 
  - 映射配置：MySQL数据库（`tenant_field_uploads`表）
  - 展示配置：本地JSON文件（`~/.cco-storage/`）

### 11.2 前端技术栈

- **框架**: Vue 3 + TypeScript
- **UI库**: Element Plus
- **状态管理**: Pinia
- **拖拽**: Sortable.js

### 11.3 核心表结构

**tenant_field_uploads（映射配置）**
```sql
CREATE TABLE tenant_field_uploads (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  tenant_id VARCHAR(50),
  scene VARCHAR(100),
  version INT,
  json_content JSON,
  is_active BOOLEAN DEFAULT FALSE,
  uploaded_by VARCHAR(100),
  uploaded_at DATETIME
);
```

**展示配置版本文件格式**
```json
{
  "versions": [
    {
      "version": 1,
      "saved_at": "2025-12-08T10:00:00",
      "operator": "admin",
      "note": "初始版本",
      "configs": [...]
    }
  ],
  "activeVersion": 1
}
```

---

## 十二、注意事项

### 12.1 权限控制

- **SuperAdmin**: 可管理所有甲方的字段配置
- **TenantAdmin**: 只能管理自己甲方的字段配置
- **其他角色**: 无权限访问字段管理功能

### 12.2 数据安全

- 版本文件存储在服务器本地磁盘
- 建议定期备份 `~/.cco-storage/` 目录
- 删除版本是软删除，可以恢复

### 12.3 性能优化

- 字段列表支持分页（单页最多250条）
- 枚举选项建议不超过100个
- 字段总数建议不超过50个

### 12.4 兼容性

- 场景类型命名（`admin_case_detail`）保留历史兼容性
- Mock字段确保系统在无配置时也能正常运行
- 版本恢复不会删除历史数据

---

## 十三、更新日志

### v1.0 (2025-12-08)
- ✅ 初始版本
- ✅ 完整的四层架构说明
- ✅ 映射配置和展示配置的版本管理
- ✅ 12个内置Mock字段
- ✅ 支持控台和IM端两个场景
- ✅ 枚举字段支持（`enum_values`/`enum_options`）
- ✅ 范围检索支持（Integer/Number/Decimal/Date/Datetime）

---

## 附录

### A. 标准字段参考

详见：`PRD需求文档/CCO管理控台/字段管理/1-案件列表标准字段管理-PRD.md`

### B. PRD文档

- [案件列表标准字段管理PRD](../../../PRD需求文档/CCO管理控台/字段管理/1-案件列表标准字段管理-PRD.md)
- [案件列表甲方字段查看PRD](../../../PRD需求文档/CCO管理控台/字段管理/2-案件列表甲方字段查看-PRD.md)
- [案件列表字段映射配置PRD](../../../PRD需求文档/CCO管理控台/字段管理/3-案件列表字段映射配置-PRD.md)
- [案件列表字段展示配置PRD](../../../PRD需求文档/CCO管理控台/字段管理/4-案件列表字段展示配置PRD.md)

### C. 联系方式

如有问题，请联系CCO开发团队。

---

**文档结束**
