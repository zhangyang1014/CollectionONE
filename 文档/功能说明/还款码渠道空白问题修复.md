# 还款码渠道空白问题 - 已修复

## 问题描述

点击"请求还款码"后，弹出的"选择还款渠道"对话框中没有显示任何渠道卡片。

## 原因分析

组件在初始化时（onMounted）就尝试加载渠道列表，但此时`caseInfo`数据可能还没有传递到组件，导致无法获取正确的`partyId`，从而加载失败。

## 修复方案

### 1. 延迟加载策略

修改为：点击"请求还款码"按钮时才加载渠道列表，并增加以下保障：

- ✅ 检查渠道列表是否为空
- ✅ 如果为空，自动重新加载
- ✅ 加载后仍为空则提示用户
- ✅ 增加详细的控制台日志

### 2. 修改的代码

**修改点1：** 按钮点击事件改为调用新函数
```vue
<el-button type="primary" @click="handleRequestClick">
```

**修改点2：** 新增handleRequestClick函数
```typescript
const handleRequestClick = async () => {
  // 如果渠道列表为空，先加载渠道
  if (availableChannels.value.length === 0) {
    await loadAvailableChannels()
  }
  
  // 检查是否有可用渠道
  if (availableChannels.value.length === 0) {
    ElMessage.warning('暂无可用的支付渠道，请联系管理员配置')
    return
  }
  
  // 显示渠道选择对话框
  showChannelSelector.value = true
}
```

**修改点3：** 增加调试日志
```typescript
const loadAvailableChannels = async () => {
  const partyId = props.caseInfo?.tenant_id || props.caseInfo?.party_id || 1
  console.log('加载可用渠道 - partyId:', partyId, 'caseInfo:', props.caseInfo)
  
  const res = await getAvailableChannels(partyId)
  console.log('渠道API响应:', res)
  
  if (res.code === 0) {
    availableChannels.value = res.data || []
    console.log('可用渠道数量:', availableChannels.value.length)
  }
}
```

## 现在请执行以下操作

### 步骤1：刷新浏览器

强制刷新页面以加载最新代码：
- **Windows/Linux**: `Ctrl + Shift + R`
- **Mac**: `Cmd + Shift + R`

### 步骤2：打开浏览器控制台

- **Windows/Linux**: 按 `F12` 或 `Ctrl + Shift + I`
- **Mac**: 按 `Cmd + Option + I`

### 步骤3：测试功能

1. 在催员工作台选择任意案件
2. 点击"还款码"Tab
3. 点击"请求还款码"按钮
4. **查看控制台输出**

### 预期输出

如果一切正常，控制台应该显示：

```
加载可用渠道 - partyId: 1 caseInfo: {id: 31, tenant_id: 1, ...}
渠道API响应: {code: 0, data: [...], msg: "success"}
可用渠道数量: 4
```

然后弹窗中应该显示4个渠道卡片：
- 🇵🇭 GCash
- 🇮🇩 BCA Virtual Account
- 🇲🇽 OXXO Pay
- 🇮🇩 QRIS

## 故障排查

### 情况1：控制台显示 partyId: undefined

**原因：** caseInfo数据没有正确传递

**解决方案：**
```javascript
// 检查案件数据
console.log('案件数据:', props.caseInfo)

// 应该包含 tenant_id 字段
// 如果没有，检查CaseDetail组件是否正确传递了caseData
```

### 情况2：API返回 code: -1 或错误信息

**原因：** 后端API出错

**解决方案：**
1. 检查后端服务是否运行
2. 查看后端日志：`tail -f backend/backend.log`
3. 确认数据库表和数据是否正确

### 情况3：渠道数量显示0

**原因：** 数据库中没有该甲方的渠道数据

**解决方案：**
```bash
# 检查数据库
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
sqlite3 cco_test.db "SELECT id, party_id, channel_name FROM payment_channels WHERE is_enabled=1;"

# 如果没有数据，重新插入
sqlite3 cco_test.db < /path/to/insert_channels.sql
```

### 情况4：控制台报错 "no such table"

**原因：** 数据库表未创建

**解决方案：**
```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
source venv/bin/activate
python create_payment_tables.py
```

## 数据验证命令

如果需要验证数据库中的数据：

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
sqlite3 cco_test.db << 'EOF'
.mode table
.headers on

-- 检查渠道数据
SELECT '=== 可用渠道 ===' AS info;
SELECT id, party_id, channel_name, channel_type, is_enabled, sort_order 
FROM payment_channels 
WHERE party_id = 1 AND is_enabled = 1
ORDER BY sort_order;

-- 检查案件数据
SELECT '';
SELECT '=== 案件甲方ID ===' AS info;
SELECT id, case_code, tenant_id, user_name 
FROM cases 
LIMIT 5;
EOF
```

预期输出：
```
=== 可用渠道 ===
+----+----------+---------------------+--------------+------------+------------+
| id | party_id | channel_name        | channel_type | is_enabled | sort_order |
+----+----------+---------------------+--------------+------------+------------+
| 1  | 1        | GCash               | VA           | 1          | 1          |
| 2  | 1        | BCA Virtual Account | VA           | 1          | 2          |
| 3  | 1        | OXXO Pay            | H5           | 1          | 3          |
| 4  | 1        | QRIS                | QR           | 1          | 4          |
+----+----------+---------------------+--------------+------------+------------+

=== 案件甲方ID ===
+----+-----------+-----------+-----------+
| id | case_code | tenant_id | user_name |
+----+-----------+-----------+-----------+
| 31 | CASE00031 | 1         | 借款人031 |
...
```

## 测试清单

修复后请验证：

- [ ] 刷新浏览器
- [ ] 打开浏览器控制台
- [ ] 进入案件详情
- [ ] 点击"还款码"Tab
- [ ] 点击"请求还款码"按钮
- [ ] 查看控制台日志
- [ ] 确认看到4个渠道卡片
- [ ] 点击任一渠道可以进入下一步

## 成功标志

✅ 控制台显示："可用渠道数量: 4"
✅ 弹窗中显示4个渠道卡片
✅ 点击渠道卡片后弹出金额输入对话框
✅ 无错误提示

## 联系支持

如果问题仍然存在：

1. **保存控制台截图** - 包含所有日志信息
2. **保存浏览器Network标签** - 查看API请求详情
3. **查看后端日志** - `tail -f backend/backend.log`
4. **提供案件ID** - 告知测试的案件编号

---

**修复时间：** 2025年11月21日  
**修复版本：** v1.0.1  
**状态：** ✅ 已修复

