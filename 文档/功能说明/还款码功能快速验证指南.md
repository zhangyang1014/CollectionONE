# 还款码功能 - 快速验证指南

## 验证目的

快速验证催员IM端还款码功能是否正常工作。

## 前置条件

✅ 后端服务已启动  
✅ 前端服务已启动  
✅ 数据库表已创建  
✅ 有可登录的催员测试账号

## 验证步骤

### 步骤1：初始化数据库（如果还没有执行）

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
mysql -u root -p cco_test < migrations/create_payment_channels_and_codes.sql
```

**预期结果：**
- 成功创建`payment_channels`表
- 成功创建`payment_codes`表
- 插入4条测试渠道数据

### 步骤2：启动服务

**后端：**
```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
./restart_backend.sh
```

**前端：**
```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/frontend
npm run dev
```

**预期结果：**
- 后端服务运行在 http://localhost:8000
- 前端服务运行在 http://localhost:5173

### 步骤3：登录催员IM端

1. 打开浏览器访问 http://localhost:5173/im/login
2. 使用催员测试账号登录

**测试账号示例：**
```
账号：collector001
密码：123456
```

**预期结果：**
- 成功登录
- 进入催员工作台页面

### 步骤4：查看案件详情

1. 在催员工作台左侧案件列表中选择任意案件
2. 右侧显示案件详情

**预期结果：**
- 案件详情页面正常显示
- 顶部显示案件概览信息

### 步骤5：验证"还款码"Tab显示

1. 在案件详情页面查看Tab列表
2. 找到"还款码"Tab

**预期结果：**
```
Tab列表应该包含：
☑️ 客户信息
☑️ 影像资料
☑️ 贷款信息
☑️ 历史借款
☑️ 还款记录
☑️ 还款码 ⭐（新增）
```

### 步骤6：点击"还款码"Tab

1. 点击"还款码"Tab
2. 查看Tab内容

**预期结果：**
- Tab切换成功
- 显示"请求还款码"按钮
- 显示筛选器（全部/待支付/已支付/已过期）
- 显示还款码列表（初始为空）

### 步骤7：点击"请求还款码"按钮

1. 点击"请求还款码"按钮
2. 查看渠道选择对话框

**预期结果：**
- 弹出"选择还款渠道"对话框
- 显示4个测试渠道卡片：
  - GCash（VA码）
  - BCA Virtual Account（VA码）
  - OXXO Pay（H5链接）
  - QRIS（二维码）

### 步骤8：选择支付渠道

1. 点击任意渠道卡片（如"GCash"）
2. 查看金额输入对话框

**预期结果：**
- 关闭渠道选择对话框
- 弹出金额输入对话框
- 显示案件编号（只读）
- 显示客户姓名（只读）
- 显示期数选择下拉框
- 显示本期应还金额明细
- 显示实际还款金额输入框

### 步骤9：选择期数

1. 点击"期数选择"下拉框
2. 选择任意期数（如"第2期"）

**预期结果：**
- 显示该期的应还金额明细：
  - 本金：5,000
  - 利息：200
  - 罚息：100
  - 费用：50
  - 合计：5,350
- 实际还款金额自动填充为 5350.00

### 步骤10：生成还款码

1. 确认或修改还款金额
2. 点击"确认生成"按钮

**预期结果：**
- 显示加载状态
- 关闭金额输入对话框
- 弹出还款码详情对话框
- 显示还款码信息：
  - 渠道图标和名称
  - 支付类型标签
  - VA码号（如：8808123456789012）或链接或二维码
  - 还款金额
  - 有效期至
  - 创建时间
- 还款码列表自动刷新，新增一条记录

### 步骤11：查看还款码详情

1. 在还款码列表中找到刚生成的还款码
2. 点击"查看详情"按钮

**预期结果：**
- 弹出详情对话框
- 显示完整的还款码信息
- VA码类型：显示虚拟账户号和复制按钮
- H5类型：显示链接、打开按钮和复制按钮
- 二维码类型：显示二维码图片

### 步骤12：测试复制功能

1. 点击"复制"按钮（VA码或H5链接）

**预期结果：**
- 显示"已复制到剪贴板"成功提示
- 内容已复制到系统剪贴板

### 步骤13：测试筛选功能

1. 关闭详情对话框
2. 点击"待支付"筛选按钮

**预期结果：**
- 列表刷新
- 只显示状态为"待支付"的还款码
- 显示有效期倒计时

### 步骤14：验证状态标签

查看列表中的还款码状态标签：

**预期结果：**
- 待支付：蓝色标签 + 倒计时
- 已支付：绿色标签 + 支付时间
- 已过期：灰色标签

## 验证检查清单

### UI显示 ✅

- [ ] "还款码"Tab显示在正确位置
- [ ] Tab内容区域显示正常
- [ ] "请求还款码"按钮显示
- [ ] 筛选器显示正常
- [ ] 列表表格显示正常

### 渠道选择 ✅

- [ ] 渠道选择对话框正常弹出
- [ ] 渠道卡片显示正常（图标、名称、类型）
- [ ] 点击卡片可以选择
- [ ] 对话框可以关闭

### 金额输入 ✅

- [ ] 金额输入对话框正常弹出
- [ ] 案件信息显示正确
- [ ] 期数下拉框加载正常
- [ ] 选择期数后自动填充金额
- [ ] 金额明细显示正确（本金、利息、罚息、费用）
- [ ] 可以手动修改金额
- [ ] 对话框可以关闭

### 还款码生成 ✅

- [ ] 点击生成后显示加载状态
- [ ] 生成成功显示提示
- [ ] 还款码详情对话框正常显示
- [ ] 还款码信息完整（编号、金额、有效期等）
- [ ] VA码/链接/二维码正确显示
- [ ] 列表自动刷新

### 列表功能 ✅

- [ ] 还款码列表正常显示
- [ ] 列表项信息完整
- [ ] 状态标签显示正确
- [ ] 有效期倒计时正常（待支付状态）
- [ ] "查看详情"按钮可用

### 详情查看 ✅

- [ ] 详情对话框正常弹出
- [ ] 信息显示完整
- [ ] 复制按钮可用
- [ ] 打开链接按钮可用（H5类型）
- [ ] 二维码图片显示正常（QR类型）

### 筛选功能 ✅

- [ ] 全部筛选正常
- [ ] 待支付筛选正常
- [ ] 已支付筛选正常
- [ ] 已过期筛选正常

## 常见问题排查

### 问题1：看不到"还款码"Tab

**排查步骤：**
```bash
# 1. 检查文件是否修改成功
cat /Users/zhangyang/Documents/GitHub/CollectionONE/frontend/src/components/CaseDetail.vue | grep "还款码"

# 2. 清理浏览器缓存
# Chrome: Ctrl+Shift+Delete

# 3. 重启前端服务
cd /Users/zhangyang/Documents/GitHub/CollectionONE/frontend
npm run dev
```

### 问题2：渠道列表为空

**排查步骤：**
```bash
# 1. 检查数据库中是否有测试数据
mysql -u root -p cco_test -e "SELECT id, channel_name, is_enabled FROM payment_channels;"

# 2. 检查后端API
curl http://localhost:8000/api/im/payment-channels?party_id=1

# 3. 查看浏览器控制台错误
```

### 问题3：生成还款码失败

**排查步骤：**
```bash
# 1. 查看后端日志
tail -f /Users/zhangyang/Documents/GitHub/CollectionONE/backend/backend.log

# 2. 检查后端API
curl -X POST http://localhost:8000/api/im/payment-codes/request \
  -H "Content-Type: application/json" \
  -d '{"case_id": 1, "loan_id": 1, "channel_id": 1, "amount": 5350}'

# 3. 查看浏览器网络请求
```

### 问题4：期数信息加载失败

**说明：**
期数信息当前返回的是模拟数据，如果看到加载失败是正常的。不影响还款码的生成，可以不选择期数直接输入金额。

## 验证完成标准

✅ 所有检查清单项目通过  
✅ 能够成功生成还款码  
✅ 能够查看还款码详情  
✅ 能够复制还款码信息  
✅ 筛选功能正常工作  
✅ 无明显UI错误  
✅ 无浏览器控制台错误

## 下一步

验证完成后，可以：

1. **配置真实支付渠道**
   - 登录管理控台
   - 进入"还款渠道配置"
   - 添加真实的支付渠道配置

2. **对接真实接口**
   - 修改后端代码对接真实支付网关
   - 实现Webhook接收
   - 对接真实的分期表数据

3. **用户培训**
   - 培训催员使用还款码功能
   - 准备操作手册
   - 收集用户反馈

## 技术支持

如遇到问题，请：

1. 查看浏览器控制台错误
2. 查看后端日志文件
3. 参考相关文档：
   - `/说明文档/功能说明/还款渠道配置功能说明.md`
   - `/文档/功能说明/催员IM端还款码功能集成说明.md`

---

**编写日期：** 2025年11月21日  
**适用版本：** v1.0.0  
**预计验证时间：** 10-15分钟

