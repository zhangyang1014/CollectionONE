# 小组群功能说明

## 功能概述

本次更新新增了"小组群"概念和"小组群长SPV"角色，完善了组织架构的层级管理。

## 组织架构层级

更新后的组织架构层级为：

```
甲方(Tenant) 
  └── 催收机构(CollectionAgency)
      └── 小组群(TeamGroup) ⭐ 新增
          └── 催收小组(CollectionTeam)
              └── 催员(Collector)
```

## 新增内容

### 1. 数据库模型

#### TeamGroup 模型（小组群表）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BigInteger | 主键 |
| tenant_id | BigInteger | 所属甲方ID |
| agency_id | BigInteger | 所属催收机构ID |
| group_code | String(100) | 小组群编码 |
| group_name | String(200) | 小组群名称 |
| group_name_en | String(200) | 小组群名称（英文）|
| spv_id | BigInteger | 小组群长SPV ID |
| description | Text | 小组群描述 |
| sort_order | Integer | 排序顺序 |
| is_active | Boolean | 是否启用 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### CollectionTeam 模型更新

在原有的 `collection_teams` 表中新增字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| team_group_id | BigInteger | 所属小组群ID（可选）|

### 2. API接口

#### 小组群管理接口

**基础路径**: `/api/v1/team-groups`

- `GET /` - 获取小组群列表
  - 参数: `tenant_id`, `agency_id`, `is_active`, `skip`, `limit`
  
- `POST /` - 创建小组群
  - 请求体: `TeamGroupCreate`
  
- `GET /{team_group_id}` - 获取小组群详情
  
- `PUT /{team_group_id}` - 更新小组群
  - 请求体: `TeamGroupUpdate`
  
- `DELETE /{team_group_id}` - 删除小组群
  - 注意：删除前会检查是否有关联的小组
  
- `GET /{team_group_id}/teams` - 获取小组群下的所有小组

### 3. 前端页面

#### 小组群管理页面

路径: `/organization/team-groups`

功能：
- 查看小组群列表
- 创建/编辑小组群
- 设置小组群长SPV
- 启用/禁用小组群
- 查看小组群下的小组数量和催员数量

#### 小组管理页面更新

在小组管理页面中新增：
- 小组列表增加"所属小组群"列
- 创建/编辑小组时可以选择所属小组群

### 4. SPV角色说明

#### 什么是SPV？

SPV（Supervisor）即小组群长，是介于机构管理员和小组组长之间的管理角色。

#### SPV的职责

- 管理多个小组
- 监督小组群内所有催员的工作
- 查看小组群的整体业绩
- 协调小组间的资源分配

#### 如何设置SPV

1. 在催员管理中创建催员账号，建议将其 `collector_level` 设置为 "SPV"
2. 在小组群管理中创建或编辑小组群时，选择该催员作为小组群长SPV
3. 一个催员可以同时担任SPV和普通催员的工作

#### SPV与其他角色的区别

| 角色 | 管理范围 | 账号类型 |
|------|----------|----------|
| 机构管理员 | 整个机构 | TeamAdminAccount |
| SPV（小组群长）| 多个小组 | Collector |
| 组长 | 单个小组 | Collector |
| 催员 | 个人案件 | Collector |

## 使用场景

### 场景1：大型催收机构

```
催收机构A
  ├── 小组群1 - 高额案件组（SPV: 张三）
  │   ├── 小组A1 - 高额逾期组
  │   └── 小组A2 - 高额法务组
  ├── 小组群2 - 普通案件组（SPV: 李四）
  │   ├── 小组B1 - 短期逾期组
  │   ├── 小组B2 - 中期逾期组
  │   └── 小组B3 - 长期逾期组
  └── 小组群3 - 特殊案件组（SPV: 王五）
      └── 小组C1 - 特殊处理组
```

### 场景2：按地区划分

```
催收机构B
  ├── 小组群1 - 华东区（SPV: 赵六）
  │   ├── 小组1 - 上海组
  │   ├── 小组2 - 杭州组
  │   └── 小组3 - 南京组
  └── 小组群2 - 华南区（SPV: 钱七）
      ├── 小组4 - 广州组
      └── 小组5 - 深圳组
```

## 数据库迁移

运行以下命令创建小组群表和更新小组表结构：

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
python create_team_groups_table.py
```

## 注意事项

1. **向下兼容**: 小组的 `team_group_id` 字段是可选的，现有的小组可以不分配到小组群
2. **删除限制**: 删除小组群前，必须先将其下的所有小组移除或分配到其他小组群
3. **SPV权限**: 目前SPV使用Collector账号，未来可以扩展专门的权限系统
4. **数据统计**: 小组群会自动统计下属小组数量和催员数量

## 后续扩展建议

1. **权限系统**: 为SPV角色添加专门的权限配置
2. **数据看板**: 为SPV提供小组群维度的数据看板
3. **绩效管理**: 支持按小组群进行绩效考核和统计
4. **案件分配**: 支持按小组群进行批量案件分配

## 技术实现

### 后端

- **模型文件**: `backend/app/models/team_group.py`
- **Schema文件**: `backend/app/schemas/organization.py`
- **API文件**: `backend/app/api/team_groups.py`
- **路由注册**: `backend/app/main.py`

### 前端

- **管理页面**: `frontend/src/views/organization/TeamGroupManagement.vue`
- **路由配置**: `frontend/src/router/index.ts`
- **小组管理更新**: `frontend/src/views/organization/TeamManagement.vue`

## 测试建议

1. 创建测试小组群
2. 分配小组到小组群
3. 设置SPV并测试权限
4. 验证数据统计是否正确
5. 测试小组群的启用/禁用功能
6. 测试删除小组群的限制

## 联系支持

如有问题，请参考项目文档或联系技术支持。

