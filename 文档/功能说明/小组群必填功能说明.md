# 小组群必填功能说明

## 📋 需求

在小组编辑时，必须配置选择一个"小组群"，不能为空。

## ✅ 实现的修改

### 1. 前端验证（`frontend/src/views/organization/TeamManagement.vue`）

#### 添加表单验证规则
```javascript
const rules = reactive({
  team_code: [
    { required: true, message: '请输入小组编码', trigger: 'blur' }
  ],
  team_name: [
    { required: true, message: '请输入小组名称', trigger: 'blur' }
  ],
  agency_id: [
    { required: true, message: '请选择所属机构', trigger: 'change' }
  ],
  team_group_id: [
    { required: true, message: '请选择所属小组群', trigger: 'change' }  // ✨ 新增必填验证
  ],
  queue_id: [
    { required: true, message: '请选择催收队列', trigger: 'change' }
  ]
})
```

#### 修改下拉框配置
```vue
<!-- 修改前 -->
<el-form-item label="所属小组群" prop="team_group_id">
  <el-select v-model="form.team_group_id" placeholder="选择小组群（可选）" clearable>
    ...
  </el-select>
</el-form-item>

<!-- 修改后 -->
<el-form-item label="所属小组群" prop="team_group_id">
  <el-select v-model="form.team_group_id" placeholder="请选择所属小组群（必选）">
    ...
  </el-select>
</el-form-item>
```

**变更说明**：
- ✅ 去掉了 `clearable` 属性，不允许清空选择
- ✅ 修改placeholder文本，明确标注"必选"
- ✅ 添加了表单验证规则

### 2. 后端Schema验证（`backend/app/schemas/organization.py`）

#### 修改CollectionTeamBase
```python
class CollectionTeamBase(BaseModel):
    """催收小组基础Schema"""
    agency_id: int = Field(..., description="所属催收机构ID")
    team_group_id: int = Field(..., description="所属小组群ID（必选）")  # ✨ 从Optional改为必填
    queue_id: int = Field(..., description="关联的催收队列ID（必选）")
    team_code: str = Field(..., max_length=100, description="小组编码")
    team_name: str = Field(..., max_length=200, description="小组名称")
    # ... 其他字段
```

**变更说明**：
- ✅ `team_group_id` 从 `Optional[int]` 改为 `int`
- ✅ 字段描述明确标注"必选"
- ✅ 使用 `Field(...)` 表示必填

## 🎯 验证效果

### 创建小组时
1. 填写小组编码、小组名称
2. 选择所属机构
3. **必须选择所属小组群** ⭐
4. 必须选择催收队列
5. 如果未选择小组群，点击"保存"会提示：**"请选择所属小组群"**

### 编辑小组时
1. 打开编辑对话框
2. 显示当前关联的小组群
3. **不能清空小组群选择** ⭐
4. 可以更改为其他小组群
5. 如果试图提交空值，会被前端验证拦截

## 📊 必填字段汇总

| 字段 | 是否必填 | 说明 |
|------|---------|------|
| 小组编码 | ✅ 必填 | 唯一标识 |
| 小组名称 | ✅ 必填 | 显示名称 |
| 所属机构 | ✅ 必填 | 必须归属某个机构 |
| **所属小组群** | ✅ **必填** | ⭐ 本次新增的必填项 |
| 催收队列 | ✅ 必填 | 必须关联队列 |
| 组长 | ❌ 可选 | 可以暂不设置 |
| 备注 | ❌ 可选 | 可以为空 |

## ⚠️ 注意事项

### 1. 数据完整性
所有小组必须关联到一个小组群，这样才能确保：
- SPV（小组群长）能够管理小组
- 组织架构层级完整
- 数据统计准确

### 2. 旧数据处理
如果系统中存在没有关联小组群的旧数据：
- 需要先为这些小组分配小组群
- 或者在数据库层面进行数据修复
- 建议运行数据修复脚本确保所有小组都有小组群

### 3. 下拉选项
下拉框只显示所选机构下的小组群：
- 机构1的小组只能选择机构1的小组群
- 机构2的小组只能选择机构2的小组群
- 避免跨机构错误关联

### 4. 创建顺序
建议的创建顺序：
1. 创建甲方
2. 创建机构
3. **创建小组群** ⭐ 必须先创建
4. 创建小组（关联到小组群）
5. 创建催员

## 🐛 错误处理

### 前端验证
```javascript
// 提交表单时自动验证
await formRef.value.validate()
// 如果team_group_id为空，会显示错误提示
```

### 后端验证
```python
# Pydantic会自动验证
# 如果team_group_id为None或缺失，会返回422错误
{
  "detail": [
    {
      "loc": ["body", "team_group_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

## 📝 API变更

### 创建小组 API
```bash
POST /api/v1/teams
Content-Type: application/json

{
  "agency_id": 1,
  "team_group_id": 1,           # ✨ 必填，不能为null
  "queue_id": 1,
  "team_code": "TEAM001",
  "team_name": "测试小组",
  "is_active": true
}
```

### 更新小组 API
```bash
PUT /api/v1/teams/{team_id}
Content-Type: application/json

{
  "team_group_id": 2,           # 可以更改小组群
  "team_name": "新名称"
  # 其他可选字段...
}
```

## 🔄 部署步骤

1. ✅ 修改前端表单验证规则
2. ✅ 修改前端下拉框配置
3. ✅ 修改后端Schema定义
4. ✅ 重启后端服务
5. ✅ 刷新前端页面

## 🎉 测试场景

### 测试1：创建小组不选小组群
1. 点击"创建小组"
2. 填写必填字段，但不选择小组群
3. 点击"保存"
4. ✅ 预期：显示错误提示"请选择所属小组群"

### 测试2：编辑小组更改小组群
1. 点击"编辑"某个小组
2. 更改"所属小组群"为另一个
3. 点击"保存"
4. ✅ 预期：保存成功，小组群更新

### 测试3：API直接调用
1. 使用curl或Postman调用创建API
2. 不传team_group_id字段
3. ✅ 预期：返回422错误，提示字段必填

## 📅 更新日期
2025年11月20日

## 🔗 相关文档
- [小组保存功能实现说明.md](./小组保存功能实现说明.md)
- [机构2小组群Mock数据说明.md](./机构2小组群Mock数据说明.md)
- [小组群Mock数据说明.md](./小组群Mock数据说明.md)

