# 还款码功能初始化指南

## 问题说明

如果遇到以下错误：
```
sqlite3.OperationalError: no such table: payment_codes
sqlite3.OperationalError: no such table: payment_channels
```

说明数据库中还没有创建还款相关的表。请按照本指南完成初始化。

## 快速修复（3步）

### 步骤1：创建数据库表

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
python create_payment_tables.py
```

**预期输出：**
```
============================================================
还款渠道和还款码表初始化脚本
============================================================
开始创建还款相关表...
✅ 表创建成功！
✅ payment_channels 表已创建
✅ payment_codes 表已创建

开始插入测试数据...
✅ 成功插入 4 条测试渠道数据

============================================================
✅ 初始化完成！
============================================================

可以开始使用还款码功能了！
- 管理控台：配置更多渠道
- IM端：为案件请求还款码
```

### 步骤2：创建Mock数据（可选）

如果需要测试数据来验证功能：

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
python mock_payment_codes.py
```

**预期输出：**
```
============================================================
还款码Mock数据生成脚本
============================================================
开始创建Mock还款码数据...
找到 4 个可用渠道
找到 10 个案件
✅ 成功创建 23 条Mock还款码数据

统计信息:
  待支付: 12
  已支付: 7
  已过期: 4

============================================================
✅ Mock数据生成完成！
============================================================

现在可以在IM端查看还款码列表了！
```

### 步骤3：运行测试验证

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/测试
python test_payment_api.py
```

**预期输出：**
```
============================================================
  还款码功能完整测试
============================================================

测试时间: 2025-11-21 10:00:00
后端地址: http://localhost:8000

============================================================
  测试1：获取可用还款渠道
============================================================

ℹ️  请求: GET http://localhost:8000/api/im/payment-channels
ℹ️  参数: {'party_id': 1}
ℹ️  状态码: 200
✅ 获取渠道成功，共 4 个渠道
  - GCash (VA)
  - BCA Virtual Account (VA)
  - OXXO Pay (H5)
  - QRIS (QR)

...（更多测试输出）
```

## 详细说明

### 创建的文件

我创建了3个新文件来解决这个问题：

1. **`create_payment_tables.py`** - 数据库表创建脚本
   - 创建 `payment_channels` 表
   - 创建 `payment_codes` 表
   - 插入4条测试渠道数据

2. **`mock_payment_codes.py`** - Mock数据生成脚本
   - 为现有案件生成模拟还款码记录
   - 包含不同状态（待支付/已支付/已过期）
   - 用于功能测试和演示

3. **`test_payment_api.py`** - API测试用例
   - 测试所有还款码相关接口
   - 验证功能是否正常工作
   - 提供详细的测试报告

### 测试渠道数据

初始化后会自动创建4个测试渠道：

| 渠道名称 | 类型 | 服务商 | 排序 |
|---------|------|--------|------|
| GCash | VA码 | Xendit | 1 |
| BCA Virtual Account | VA码 | Midtrans | 2 |
| OXXO Pay | H5链接 | Conekta | 3 |
| QRIS | 二维码 | Xendit | 4 |

### 测试用例覆盖

`test_payment_api.py` 包含以下测试：

✅ 测试1：获取可用还款渠道  
✅ 测试2：获取案件期数信息  
✅ 测试3：请求还款码  
✅ 测试4：查询还款码列表  
✅ 测试4.1：查询待支付还款码  
✅ 测试4.2：查询指定案件的还款码  
✅ 测试5：查询还款码详情  
✅ 测试6：管理控台获取渠道列表  

## 常见问题

### Q1: 执行脚本时报错 "No module named 'app'"

**解决方案：**
```bash
# 确保在backend目录下执行
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend

# 确认Python环境
which python

# 如果使用虚拟环境，先激活
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows
```

### Q2: 表已存在，需要重新创建

如果需要重新创建表：

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend

# 进入Python交互环境
python

# 执行以下代码
from app.core.database import engine
from sqlalchemy import text

with engine.connect() as conn:
    conn.execute(text("DROP TABLE IF EXISTS payment_codes"))
    conn.execute(text("DROP TABLE IF EXISTS payment_channels"))
    conn.commit()

exit()

# 重新运行初始化脚本
python create_payment_tables.py
```

### Q3: Mock数据已存在，需要重新生成

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
python mock_payment_codes.py

# 脚本会询问：是否清除现有数据并重新生成？(y/n)
# 输入 y 回车
```

### Q4: 测试失败，后端服务未启动

确保后端服务正在运行：

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend

# 检查服务状态
ps aux | grep python

# 如果没有运行，启动服务
./start_backend.sh

# 或者
python -m uvicorn app.main:app --reload --port 8000
```

### Q5: 前端仍然报错

如果完成初始化后前端仍然报错：

1. **刷新浏览器缓存**
   - Chrome: Ctrl + Shift + R (Mac: Cmd + Shift + R)
   - 或清除所有缓存

2. **重启后端服务**
   ```bash
   cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
   ./restart_backend.sh
   ```

3. **检查数据库**
   ```bash
   cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
   python
   
   from app.core.database import engine
   from sqlalchemy import text
   
   with engine.connect() as conn:
       result = conn.execute(text("SELECT name FROM sqlite_master WHERE type='table'"))
       tables = [row[0] for row in result]
       print("数据库中的表:", tables)
   ```

## 验证成功的标志

完成初始化后，你应该能够：

✅ 在IM端看到"还款码"Tab  
✅ 点击"请求还款码"能看到4个测试渠道  
✅ 能够成功生成还款码  
✅ 能够查看还款码列表  
✅ 能够查看还款码详情  
✅ 所有测试用例通过  

## 下一步

初始化完成后：

1. **配置真实渠道**
   - 登录管理控台
   - 进入"还款渠道配置"
   - 添加真实的支付渠道

2. **测试完整流程**
   - 在IM端选择案件
   - 请求还款码
   - 验证功能正常

3. **对接真实接口**
   - 修改后端代码
   - 对接真实支付网关
   - 实现Webhook

## 脚本位置

所有脚本都位于项目中：

```
CollectionONE/
├── backend/
│   ├── create_payment_tables.py    # 表创建脚本
│   ├── mock_payment_codes.py       # Mock数据生成
│   └── ...
└── 测试/
    └── test_payment_api.py          # API测试用例
```

## 技术支持

如果遇到其他问题：

1. 查看后端日志
   ```bash
   tail -f /Users/zhangyang/Documents/GitHub/CollectionONE/backend/backend.log
   ```

2. 查看浏览器控制台错误

3. 运行测试脚本诊断
   ```bash
   cd /Users/zhangyang/Documents/GitHub/CollectionONE/测试
   python test_payment_api.py
   ```

4. 参考其他文档：
   - `/说明文档/功能说明/还款渠道配置功能说明.md`
   - `/文档/功能说明/还款码功能快速验证指南.md`

---

**编写日期：** 2025年11月21日  
**适用场景：** 首次部署或数据库迁移后  
**预计执行时间：** 5-10分钟

