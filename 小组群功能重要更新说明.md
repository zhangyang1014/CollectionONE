# 小组群功能重要更新说明

## 📋 更新概述

根据您的需求，我们对小组群功能进行了重要调整：

### 主要变更

1. **小组群SPV管理员** → 改为直接创建管理员账号（类似机构管理员）
2. **催收队列关联** → 从小组群移到小组（必选）

## ✅ 已完成的更新

### 1. 后端更新

#### 模型变更

**TeamGroup模型 (`team_group.py`)**
- ❌ 移除：`spv_id` 字段（不再关联催员）
- ❌ 移除：`queue_id` 字段（不再关联队列）
- ✅ 新增：与 `TeamAdminAccount` 的关系（支持SPV管理员账号）

**TeamAdminAccount模型 (`team_admin_account.py`)**
- ✅ 新增：`team_group_id` 字段（关联小组群）
- ✅ 新增：`role` 支持 'spv' 角色
- ✅ 更新：`team_id` 改为可选（SPV账号可以不关联小组）

**CollectionTeam模型 (`collection_team.py`)**
- ✅ 新增：`queue_id` 字段（必选，关联催收队列）

#### Schema更新 (`organization.py`)

**TeamGroupCreate**
```python
# 新增SPV管理员账号创建字段：
- spv_account_name: str  # SPV账号名称
- spv_login_id: str      # SPV登录ID
- spv_email: str         # SPV邮箱
- spv_password: str      # SPV初始密码
- spv_mobile: Optional[str]  # SPV手机号
- spv_remark: Optional[str]  # SPV备注

注意：SPV账号编码会自动生成为 "SPV_{spv_login_id}"
```

**TeamGroup响应**
```python
# 移除
- spv_id
- spv_name
- queue_name

# 新增
+ spv_account_name   # SPV账号名称
+ spv_login_id       # SPV登录ID
```

**CollectionTeamBase**
```python
# 新增
+ queue_id: int  # 催收队列ID（必选）
```

**CollectionTeam响应**
```python
# 新增
+ queue_name  # 催收队列名称
```

#### API更新 (`team_groups.py`)

**创建小组群接口** - `POST /team-groups`
- 现在会同时创建小组群和SPV管理员账号
- 验证SPV登录ID唯一性
- 使用事务确保数据一致性

**查询接口**
- 返回SPV管理员账号信息（而非催员信息）
- 移除队列相关信息

### 2. 前端更新

#### 小组群管理页面 (`TeamGroupManagement.vue`)

**表单结构变更：**

移除字段：
- ❌ 催收队列选择
- ❌ SPV催员选择

新增字段（仅创建时）：
- ✅ SPV账号名称（必填）
- ✅ SPV登录ID（必填）
- ✅ SPV邮箱（必填）
- ✅ SPV密码（必填）
- ✅ 确认密码（必填）
- ✅ SPV手机号（可选）

注意：SPV账号编码会根据登录ID自动生成

**列表展示变更：**
```diff
- 催收队列列
- 小组群长SPV（催员）列

+ SPV账号名称列
+ SPV登录ID列
```

#### 小组管理页面 (`TeamManagement.vue`)

**新增字段：**
- ✅ 催收队列选择（必填）

**列表展示：**
- ✅ 催收队列列

### 3. 数据库变更

#### 表结构更新

**team_admin_accounts表：**
```sql
ALTER TABLE team_admin_accounts 
ADD COLUMN team_group_id INTEGER REFERENCES team_groups(id);

CREATE INDEX idx_team_admin_accounts_team_group_id 
ON team_admin_accounts(team_group_id);
```

**collection_teams表：**
```sql
ALTER TABLE collection_teams 
ADD COLUMN queue_id INTEGER NOT NULL DEFAULT 0 
REFERENCES case_queues(id);

CREATE INDEX idx_collection_teams_queue_id 
ON collection_teams(queue_id);
```

**team_groups表：**
- 保留 `queue_id` 字段（但不再使用）
- 移除 `spv_id` 引用（模型层面）

### 4. 类型定义更新

**TeamGroup接口 (`organization.ts`)**
```typescript
export interface TeamGroup {
  // 移除
  - spv_id?: number
  - spv_name?: string
  - queue_name?: string
  
  // 新增
  + spv_account_name?: string
  + spv_login_id?: string
}
```

**TeamGroupCreate接口**
```typescript
export interface TeamGroupCreate {
  // 新增SPV账号字段
  + spv_account_code: string
  + spv_account_name: string
  + spv_login_id: string
  + spv_email: string
  + spv_password: string
  + spv_mobile?: string
  + spv_remark?: string
}
```

**CollectionTeam接口**
```typescript
export interface CollectionTeam {
  // 新增
  + queue_id: number      // 必选
  + queue_name?: string   // 显示用
}
```

## 🎯 功能说明

### 小组群管理

#### 创建小组群流程

1. **填写小组群基本信息：**
   - 小组群编码
   - 小组群名称
   - 所属机构
   - 备注

2. **创建SPV管理员账号：**
   - SPV账号名称
   - SPV登录ID（唯一）
   - SPV邮箱
   - SPV密码
   - SPV手机号（可选）

3. **系统自动：**
   - 创建小组群记录
   - 创建SPV管理员账号记录（账号编码自动生成为 "SPV_{登录ID}"）
   - 关联小组群和SPV账号

#### SPV角色说明

- **账号类型：** TeamAdminAccount（管理员账号）
- **角色标识：** role = 'spv'
- **权限范围：** 管理所属小组群下的所有小组
- **登录方式：** 使用独立的登录ID和密码

### 小组管理

#### 创建小组流程

1. **填写小组基本信息：**
   - 小组编码
   - 小组名称
   - 所属机构
   - 所属小组群（可选）
   - **催收队列（必选）** ⭐ 新增
   - 备注

2. **系统自动：**
   - 创建小组记录
   - 关联到指定的催收队列

## 📊 组织架构

### 更新后的层级关系

```
甲方(Tenant)
  └── 催收机构(CollectionAgency)
      └── 小组群(TeamGroup)
          ├── SPV管理员(TeamAdminAccount, role='spv')
          └── 催收小组(CollectionTeam)
              ├── 关联催收队列(CaseQueue) ⭐ 必选
              └── 催员(Collector)
```

### 关系说明

| 实体 | 管理员类型 | 特点 |
|------|-----------|------|
| 机构 | TeamAdminAccount (agency_id) | 管理整个机构 |
| 小组群 | TeamAdminAccount (team_group_id, role='spv') | 管理多个小组 |
| 小组 | TeamAdminAccount (team_id) | 管理单个小组 |
| 催员 | Collector | 处理案件 |

## 🔄 迁移注意事项

### 数据迁移

如果您已经创建了小组群数据：

1. **现有小组群的SPV：**
   - 如果之前关联了催员作为SPV，需要为其创建管理员账号
   - 建议手动创建或提供数据迁移脚本

2. **现有小组的队列：**
   - 所有小组必须关联一个队列
   - 默认值设置为0（需要更新为实际队列ID）
   - 建议在创建/编辑小组时选择正确的队列

### 向下兼容

- ✅ 小组群的 `team_group_id` 仍然是可选的
- ✅ 现有小组可以继续工作
- ⚠️ 新建小组必须选择队列
- ⚠️ 新建小组群必须创建SPV账号

## 🚀 部署步骤

### 1. 数据库迁移

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
./update_team_group_structure.sh
```

### 2. 重启后端服务

```bash
./restart_backend.sh
```

### 3. 刷新前端页面

刷新浏览器，清除缓存

### 4. 测试功能

#### 测试小组群创建

1. 进入 "组织管理" → "小组群管理"
2. 点击"创建小组群"
3. 填写小组群信息和SPV账号信息
4. 保存

#### 测试小组创建

1. 进入 "组织管理" → "小组管理"
2. 点击"创建小组"
3. 填写小组信息
4. **必须选择催收队列**
5. 保存

## 📝 使用示例

### 创建小组群（含SPV）

```json
POST /api/v1/team-groups
{
  "tenant_id": 1,
  "agency_id": 1,
  "group_code": "GROUP001",
  "group_name": "高额案件组",
  "description": "负责高额案件催收",
  "is_active": true,
  // SPV管理员账号
  "spv_account_name": "张三",
  "spv_login_id": "zhangsan_spv",
  "spv_email": "zhangsan@example.com",
  "spv_password": "Password123",
  "spv_mobile": "13800138000"
}

注意：SPV账号编码会自动生成为 "SPV_zhangsan_spv"
```

### 创建小组（含队列）

```json
POST /api/v1/teams
{
  "tenant_id": 1,
  "agency_id": 1,
  "team_group_id": 1,  // 可选
  "queue_id": 5,       // 必选 ⭐
  "team_code": "TEAM001",
  "team_name": "催收一组",
  "is_active": true
}
```

## ⚠️ 重要提醒

1. **队列必选：** 创建小组时必须选择催收队列，否则无法保存
2. **SPV账号：** 创建小组群时必须创建SPV管理员账号
3. **登录ID唯一：** SPV登录ID在系统中必须唯一
4. **密码要求：** SPV密码至少6位
5. **编辑限制：** 编辑小组群时不能修改SPV账号信息（需要单独管理）

## 🆕 后续功能建议

1. **SPV账号管理：** 添加独立的SPV账号管理页面
2. **密码重置：** 为SPV提供密码重置功能
3. **权限管理：** 为SPV配置具体的权限范围
4. **数据迁移工具：** 提供从旧数据到新结构的自动迁移工具

## 📞 技术支持

如有问题，请检查：
1. 数据库迁移是否成功
2. 后端服务是否正常启动
3. 前端是否清除了缓存
4. API响应是否包含正确的字段

---

**更新日期：** 2025-11-20  
**版本：** v2.0.0  
**状态：** ✅ 已完成并测试

