# 执行停留字段迁移 - 彻底解决500错误

## 问题
访问停留案件列表时出现500错误，原因是数据库表缺少停留相关字段。

## 解决步骤

### 步骤1：执行数据库迁移

**方法A：使用MySQL命令行（推荐）**

```bash
cd backend-java
mysql -u root -p cco_system < src/main/resources/db/migration/add_case_stay_fields.sql
```

输入数据库密码后执行。

**方法B：使用MySQL客户端**

1. 打开MySQL客户端（如MySQL Workbench、Navicat等）
2. 连接到数据库 `cco_system`
3. 执行以下SQL：

```sql
USE cco_system;

-- 添加停留相关字段
ALTER TABLE `cases` 
ADD COLUMN `is_stay` TINYINT(1) DEFAULT 0 COMMENT '是否停留（独立状态字段，与case_status分离）' AFTER `next_follow_up_at`,
ADD COLUMN `stay_at` DATETIME NULL COMMENT '停留时间' AFTER `is_stay`,
ADD COLUMN `stay_by` BIGINT NULL COMMENT '停留操作人ID' AFTER `stay_at`,
ADD COLUMN `stay_released_at` DATETIME NULL COMMENT '解放停留时间' AFTER `stay_by`,
ADD COLUMN `stay_released_by` BIGINT NULL COMMENT '解放停留操作人ID' AFTER `stay_released_at`;

-- 添加索引
ALTER TABLE `cases` 
ADD INDEX `idx_is_stay` (`is_stay`),
ADD INDEX `idx_stay_at` (`stay_at`),
ADD INDEX `idx_stay_by` (`stay_by`);

-- 更新现有数据
UPDATE `cases` SET `is_stay` = 0 WHERE `is_stay` IS NULL;
```

**如果字段已存在，会报错，可以忽略或使用安全版本：**

```bash
mysql -u root -p cco_system < src/main/resources/db/migration/add_case_stay_fields_safe.sql
```

### 步骤2：验证字段是否添加成功

```sql
DESC cases;
```

应该能看到以下字段：
- `is_stay` - TINYINT(1)
- `stay_at` - DATETIME
- `stay_by` - BIGINT
- `stay_released_at` - DATETIME
- `stay_released_by` - BIGINT

### 步骤3：重启后端服务

```bash
cd backend-java

# 停止当前服务（如果正在运行）
lsof -ti :8080 | xargs kill

# 重新启动
./start.sh
```

或者如果使用Maven直接运行：

```bash
cd backend-java
JAVA_HOME=/opt/homebrew/opt/openjdk@17 \
PATH=/opt/homebrew/opt/openjdk@17/bin:$PATH \
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

### 步骤4：验证功能

1. 访问停留案件列表：`http://localhost:5173/cases/stay`
2. 应该能正常显示页面（即使没有停留案件，也应该显示空列表，而不是500错误）

## 如果仍然报错

### 检查后端日志

```bash
tail -f backend-java/backend.log
```

查看是否有SQL错误信息。

### 临时解决方案（如果无法执行迁移）

代码已经添加了异常处理，即使字段不存在也会返回空列表。但为了功能正常，**强烈建议执行数据库迁移**。

## 注意事项

- 执行迁移前建议备份数据库
- 如果表中有大量数据，ALTER TABLE可能需要一些时间
- 迁移后，现有案件的`is_stay`字段默认为0（false），表示未停留

