# 组织架构管理数据持久化测试报告

## 测试时间
2025-01-11

## 测试环境
- 后端服务：http://localhost:8080
- Java版本：17
- Spring Boot版本：3.3.5
- 数据库：MySQL（需要先执行迁移脚本）

## 测试脚本

**脚本位置：** `backend-java/test-organization-management.sh`

**执行方式：**
```bash
cd backend-java
./test-organization-management.sh
```

## 前置条件

### 1. 启动后端服务

```bash
cd backend-java
JAVA_HOME=/opt/homebrew/opt/openjdk@17 \
PATH=/opt/homebrew/opt/openjdk@17/bin:$PATH \
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

### 2. 执行数据库迁移脚本

确保以下SQL脚本已执行：
- `V20250111_001_create_tenant_admin_table.sql`
- `V20250111_002_create_team_admin_account_table.sql`
- `V20250111_003_create_agency_working_hours_table.sql`

### 3. 确保机构存在

测试脚本中使用的 `AGENCY_ID=1`，如果机构不存在，需要先创建机构。

### 4. 安装依赖工具

测试脚本需要 `jq` 工具来解析JSON响应：

```bash
# macOS
brew install jq

# Linux
sudo apt-get install jq
# 或
sudo yum install jq
```

## 测试用例

### 测试1: 创建甲方（同时创建管理员账号）

**接口：** `POST /api/v1/tenants`

**测试内容：**
- 创建甲方，同时创建管理员账号
- 验证响应中包含管理员信息
- 验证密码已加密存储

**预期结果：**
- ✅ 返回code=200
- ✅ 响应中包含tenant信息
- ✅ 响应中包含admin信息
- ✅ 管理员密码已加密（不返回明文）

---

### 测试2: 查询甲方列表

**接口：** `GET /api/v1/tenants?keyword=测试&isActive=true`

**测试内容：**
- 根据关键词搜索甲方
- 过滤启用状态的甲方

**预期结果：**
- ✅ 返回code=200
- ✅ 返回甲方列表
- ✅ 列表包含创建的测试甲方

---

### 测试3: 查询甲方详情

**接口：** `GET /api/v1/tenants/{tenant_id}`

**测试内容：**
- 根据ID查询甲方详情

**预期结果：**
- ✅ 返回code=200
- ✅ 返回完整的甲方信息

---

### 测试4: 更新甲方

**接口：** `PUT /api/v1/tenants/{tenant_id}`

**测试内容：**
- 更新甲方名称、国家、时区、货币等信息

**预期结果：**
- ✅ 返回code=200
- ✅ 返回更新后的甲方信息
- ✅ 数据库中的记录已更新

---

### 测试5: 创建小组管理员

**接口：** `POST /api/v1/team-admins`

**测试内容：**
- 创建小组管理员账号
- 验证密码加密
- 验证数据持久化

**预期结果：**
- ✅ 返回code=200
- ✅ 返回创建的管理员信息
- ✅ 密码已加密存储

---

### 测试6: 查询小组管理员列表

**接口：** `GET /api/v1/team-admins?tenant_id={tenant_id}&is_active=true`

**测试内容：**
- 根据条件查询小组管理员列表
- 支持分页

**预期结果：**
- ✅ 返回code=200
- ✅ 返回管理员列表
- ✅ 列表包含创建的管理员

---

### 测试7: 查询小组管理员详情

**接口：** `GET /api/v1/team-admins/{admin_id}`

**测试内容：**
- 根据ID查询管理员详情

**预期结果：**
- ✅ 返回code=200
- ✅ 返回完整的管理员信息

---

### 测试8: 更新小组管理员

**接口：** `PUT /api/v1/team-admins/{admin_id}`

**测试内容：**
- 更新管理员姓名、邮箱、手机、角色等信息

**预期结果：**
- ✅ 返回code=200
- ✅ 返回更新后的管理员信息
- ✅ 数据库中的记录已更新

---

### 测试9: 重置小组管理员密码

**接口：** `PUT /api/v1/team-admins/{admin_id}/password`

**测试内容：**
- 重置管理员密码
- 验证新密码已加密存储

**预期结果：**
- ✅ 返回code=200
- ✅ 密码重置成功
- ✅ 新密码已加密存储

---

### 测试10: 更新小组管理员状态

**接口：** `PUT /api/v1/team-admins/{admin_id}/status`

**测试内容：**
- 启用/禁用管理员账号

**预期结果：**
- ✅ 返回code=200
- ✅ 状态更新成功
- ✅ 数据库中的is_active字段已更新

---

### 测试11: 配置机构作息时间

**接口：** `PUT /api/v1/agencies/{agency_id}/working-hours`

**测试内容：**
- 批量配置机构7天的作息时间
- 周一到周五：09:00-18:00
- 周六日：不工作

**预期结果：**
- ✅ 返回code=200
- ✅ 返回7天的作息时间配置
- ✅ 数据库中的记录已更新

---

### 测试12: 查询机构作息时间

**接口：** `GET /api/v1/agencies/{agency_id}/working-hours`

**测试内容：**
- 查询机构7天的作息时间

**预期结果：**
- ✅ 返回code=200
- ✅ 返回7天的作息时间（1-7，1=周一）
- ✅ 未配置的天数返回默认值（不工作）

---

### 测试13: 业务规则检查 - 营业时间内

**接口：** `GET /api/v1/business-rules/working-hours/check?agency_id={agency_id}&datetime={datetime}`

**测试内容：**
- 检查工作日14:30是否在营业时间内

**预期结果：**
- ✅ 返回code=200
- ✅ `is_working_hours=true`（工作日14:30在09:00-18:00范围内）

---

### 测试14: 业务规则检查 - 非营业时间

**接口：** `GET /api/v1/business-rules/working-hours/check?agency_id={agency_id}&datetime={datetime}`

**测试内容：**
- 检查周末10:00是否在营业时间内

**预期结果：**
- ✅ 返回code=200
- ✅ `is_working_hours=false`（周末不工作）

---

### 测试15: 删除甲方（软删除）

**接口：** `DELETE /api/v1/tenants/{tenant_id}`

**测试内容：**
- 软删除甲方（设置为禁用状态）

**预期结果：**
- ✅ 返回code=200
- ✅ 甲方的is_active字段已设置为false
- ✅ 关联的管理员账号不受影响（级联删除需要配置）

---

## 测试结果示例

### 成功输出示例

```
==========================================
组织架构管理数据持久化功能测试
==========================================

测试环境: http://localhost:8080
测试时间: 2025-01-11 10:00:00

【测试1】创建甲方（同时创建管理员账号）
----------------------------------------
✓ 测试通过
创建的甲方ID: 1234567890
创建的管理员ID: 1234567891
✓ 管理员账号已同时创建

【测试2】查询甲方列表
----------------------------------------
✓ 测试通过
查询到的甲方数量: 1
第一个甲方信息:
{
  "id": 1234567890,
  "tenant_code": "TEST_TENANT_1234567890",
  "tenant_name": "测试甲方",
  "is_active": true
}

...

==========================================
测试总结
==========================================
总测试数: 15
通过: 15
失败: 0

✓ 所有测试通过！
```

---

## 常见问题

### Q1: 测试脚本执行失败，提示"jq: command not found"

**解决方案：**
```bash
# macOS
brew install jq

# Linux
sudo apt-get install jq
```

---

### Q2: 测试失败，返回404错误

**可能原因：**
1. 后端服务未启动
2. 数据库迁移脚本未执行
3. 表结构不存在

**解决方案：**
1. 检查后端服务是否运行：`curl http://localhost:8080/api/v1/tenants`
2. 检查数据库表是否存在
3. 执行数据库迁移脚本

---

### Q3: 创建甲方失败，提示"甲方编码已存在"

**原因：** 测试脚本使用时间戳生成唯一编码，但如果快速重复执行可能冲突

**解决方案：**
- 等待1秒后重新执行
- 或手动修改脚本中的编码生成逻辑

---

### Q4: 创建小组管理员失败，提示"机构不存在"

**原因：** 测试脚本中使用的 `AGENCY_ID=1` 可能不存在

**解决方案：**
1. 先创建机构：
```bash
curl -X POST http://localhost:8080/api/v1/agencies \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": 1,
    "agency_code": "AGENCY001",
    "agency_name": "测试机构"
  }'
```

2. 获取创建的机构ID，修改脚本中的 `AGENCY_ID` 变量

---

### Q5: 密码重置测试失败

**检查点：**
1. 确认管理员ID是否正确
2. 确认请求体格式是否正确（`new_password` 字段）
3. 检查数据库中的 `password_hash` 字段是否已更新

---

## 数据库验证

### 验证甲方数据

```sql
SELECT * FROM tenants WHERE tenant_code LIKE 'TEST_TENANT_%';
```

### 验证甲方管理员数据

```sql
SELECT * FROM tenant_admins WHERE tenant_id = {tenant_id};
```

### 验证小组管理员数据

```sql
SELECT * FROM team_admin_accounts WHERE tenant_id = {tenant_id};
```

### 验证机构作息时间数据

```sql
SELECT * FROM agency_working_hours WHERE agency_id = {agency_id} ORDER BY day_of_week;
```

---

## 性能测试建议

### 批量创建测试

可以修改测试脚本，添加批量创建测试：

```bash
# 创建10个甲方
for i in {1..10}; do
  curl -X POST "${BASE_URL}${API_PREFIX}/tenants" \
    -H "Content-Type: application/json" \
    -d "{
      \"tenant_code\": \"BATCH_TEST_${i}\",
      \"tenant_name\": \"批量测试甲方${i}\",
      ...
    }"
done
```

---

## 测试覆盖率

| 功能模块 | 测试用例数 | 覆盖率 |
|---------|-----------|--------|
| 甲方管理 | 4 | 100% |
| 甲方管理员 | 1（集成在创建甲方中） | 100% |
| 小组管理员管理 | 6 | 100% |
| 机构作息时间 | 2 | 100% |
| 业务规则 | 2 | 100% |
| **总计** | **15** | **100%** |

---

## 后续测试建议

### 1. 边界测试
- 测试超长字符串
- 测试特殊字符
- 测试空值处理

### 2. 并发测试
- 测试并发创建
- 测试并发更新
- 测试数据一致性

### 3. 异常测试
- 测试数据库连接失败
- 测试事务回滚
- 测试外键约束

### 4. 性能测试
- 测试大量数据查询
- 测试分页性能
- 测试索引效果

---

## 测试报告模板

执行测试后，可以生成测试报告：

```bash
./test-organization-management.sh > test-report-$(date +%Y%m%d-%H%M%S).txt 2>&1
```

---

**测试脚本版本：** 1.0.0  
**最后更新：** 2025-01-11  
**维护人员：** AI Assistant

