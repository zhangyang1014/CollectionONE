# 案件重新分案配置功能 - 部署说明

## 问题说明

如果访问界面时出现 500 错误：`No static resource api/v1/case-reassign-configs`，说明需要执行以下步骤：

## 解决步骤

### 1. 创建数据库表

执行以下SQL脚本创建数据库表：

```sql
-- 在MySQL中执行
USE cco_system;

CREATE TABLE IF NOT EXISTS `case_reassign_configs` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `tenant_id` BIGINT NOT NULL COMMENT '所属甲方ID',
  `config_type` VARCHAR(20) NOT NULL COMMENT '配置类型: queue/agency/team',
  `target_id` BIGINT NOT NULL COMMENT '目标ID（队列ID/机构ID/小组ID）',
  `reassign_days` INT NOT NULL COMMENT '重新分案天数（整数）',
  `is_active` TINYINT(1) DEFAULT 1 COMMENT '是否启用',
  `effective_date` DATE COMMENT '生效日期（T+1日）',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tenant_type_target` (`tenant_id`, `config_type`, `target_id`),
  KEY `idx_tenant_id` (`tenant_id`),
  KEY `idx_effective_date` (`effective_date`),
  KEY `idx_config_type` (`config_type`),
  KEY `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='案件重新分案配置表';
```

或者使用SQL文件：
```bash
mysql -uroot -p cco_system < src/main/resources/db/migration/create_case_reassign_configs_table.sql
```

### 2. 重新编译后端代码

```bash
cd backend-java
mvn clean compile
```

### 3. 重启后端服务

**重要：必须重启后端服务才能加载新的Controller！**

```bash
# 停止当前运行的后端服务
# 然后重新启动
./start.sh

# 或者使用Maven启动
JAVA_HOME=/opt/homebrew/opt/openjdk@17 \
PATH=/opt/homebrew/opt/openjdk@17/bin:$PATH \
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

### 4. 验证

重启后，访问以下URL应该能正常返回数据（空数组表示没有配置，这是正常的）：

```bash
curl http://localhost:8080/api/v1/case-reassign-configs?tenant_id=1
```

如果返回JSON格式的数据（即使是空数组），说明接口已经正常工作了。

## 常见问题

### Q: 为什么会出现 "No static resource" 错误？

A: 这是因为Spring Boot在启动时扫描并注册Controller。新添加的Controller需要重启服务才能被识别。

### Q: 数据库表已存在，但还是报错？

A: 检查以下几点：
1. 确认后端服务已重启
2. 检查日志中是否有编译错误
3. 确认Controller类在正确的包路径下（`com.cco.controller`）

### Q: 如何确认Controller已加载？

A: 查看后端启动日志，应该能看到类似这样的信息：
```
Mapped "{[/api/v1/case-reassign-configs],methods=[GET]}"
```

## 功能说明

配置创建后：
- **生效时间**：T+1日（明天）生效
- **执行时间**：每天 02:00 自动执行重新分案
- **筛选条件**：
  - 排除"承诺还款"状态的案件（通过PTP表判断）
  - 排除已结清的案件
  - 案件在催员手里超过配置天数
- **分配规则**：平均分配给其他催员（排除当前催员）


