<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cco.mapper.TenantFieldsJsonMapper">

    <!-- 获取当前版本的JSON数据 -->
    <select id="selectCurrentVersion" resultType="com.cco.model.entity.TenantFieldsJson">
        SELECT * FROM tenant_fields_json
        WHERE tenant_id = #{tenantId} AND is_current = 1
        LIMIT 1
    </select>

    <!-- 获取历史版本列表（不包括当前版本） -->
    <select id="selectHistoryVersions" resultType="com.cco.model.entity.TenantFieldsJson">
        SELECT * FROM tenant_fields_json
        WHERE tenant_id = #{tenantId} AND is_current = 0
        ORDER BY uploaded_at DESC
    </select>

    <!-- 将当前版本标记为历史版本 -->
    <update id="updateCurrentToHistory">
        UPDATE tenant_fields_json
        SET is_current = 0
        WHERE tenant_id = #{tenantId} AND is_current = 1
    </update>

    <!-- 删除最旧的历史版本（只保留1个历史版本） -->
    <delete id="deleteOldestHistoryVersion">
        DELETE FROM tenant_fields_json
        WHERE tenant_id = #{tenantId} AND is_current = 0
        AND id NOT IN (
            SELECT id FROM (
                SELECT id FROM tenant_fields_json
                WHERE tenant_id = #{tenantId} AND is_current = 0
                ORDER BY uploaded_at DESC
                LIMIT 1
            ) AS keep_one
        )
    </delete>

</mapper>

