# 执行数据库迁移 - 添加停留字段

## 重要提示

数据库密码可能不是 "root"，请根据实际情况修改下面的命令。

## 执行步骤

### 方法1：使用MySQL命令行（推荐）

```bash
cd backend-java

# 请将 YOUR_PASSWORD 替换为实际的MySQL密码
mysql -u root -pYOUR_PASSWORD cco_system < src/main/resources/db/migration/add_case_stay_fields_safe.sql
```

或者交互式输入密码：

```bash
cd backend-java
mysql -u root -p cco_system < src/main/resources/db/migration/add_case_stay_fields_safe.sql
```

### 方法2：使用MySQL客户端

1. 打开MySQL客户端（MySQL Workbench、Navicat、DBeaver等）
2. 连接到数据库 `cco_system`
3. 执行以下SQL：

```sql
USE cco_system;

-- 添加停留相关字段（如果不存在）
-- 注意：如果字段已存在，会报错，可以忽略或使用安全版本SQL

ALTER TABLE `cases` 
ADD COLUMN IF NOT EXISTS `is_stay` TINYINT(1) DEFAULT 0 COMMENT '是否停留（独立状态字段，与case_status分离）' AFTER `next_follow_up_at`,
ADD COLUMN IF NOT EXISTS `stay_at` DATETIME NULL COMMENT '停留时间' AFTER `is_stay`,
ADD COLUMN IF NOT EXISTS `stay_by` BIGINT NULL COMMENT '停留操作人ID' AFTER `stay_at`,
ADD COLUMN IF NOT EXISTS `stay_released_at` DATETIME NULL COMMENT '解放停留时间' AFTER `stay_by`,
ADD COLUMN IF NOT EXISTS `stay_released_by` BIGINT NULL COMMENT '解放停留操作人ID' AFTER `stay_released_at`;

-- 添加索引（如果不存在，会报错但可以忽略）
ALTER TABLE `cases` ADD INDEX `idx_is_stay` (`is_stay`);
ALTER TABLE `cases` ADD INDEX `idx_stay_at` (`stay_at`);
ALTER TABLE `cases` ADD INDEX `idx_stay_by` (`stay_by`);

-- 更新现有数据
UPDATE `cases` SET `is_stay` = 0 WHERE `is_stay` IS NULL;
```

**注意**：MySQL 5.7及以下版本不支持 `IF NOT EXISTS`，请使用安全版本SQL脚本。

### 方法3：使用安全版本SQL（推荐，自动检查字段是否存在）

```bash
cd backend-java
mysql -u root -p cco_system < src/main/resources/db/migration/add_case_stay_fields_safe.sql
```

## 验证迁移是否成功

执行以下SQL查询，应该能看到5个字段：

```sql
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_COMMENT 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_SCHEMA = 'cco_system' 
  AND TABLE_NAME = 'cases' 
  AND COLUMN_NAME IN ('is_stay', 'stay_at', 'stay_by', 'stay_released_at', 'stay_released_by')
ORDER BY COLUMN_NAME;
```

应该返回：
- is_stay
- stay_at
- stay_by
- stay_released_at
- stay_released_by

## 迁移后需要做的

1. **重启后端服务**（如果正在运行）
2. **测试停留功能**：
   - 访问停留案件列表：`http://localhost:5173/cases/stay`
   - 在案件列表中测试"标记停留"功能

## 如果迁移失败

1. 检查数据库连接和权限
2. 检查字段是否已存在（如果已存在，可以忽略错误）
3. 查看具体错误信息，根据错误调整SQL

