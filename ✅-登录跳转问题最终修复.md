# âœ… ç™»å½•è·³è½¬é—®é¢˜æœ€ç»ˆä¿®å¤

## ğŸ“‹ é—®é¢˜æ ¹æº

ä» Network é¢æ¿å‘ç°ï¼š
- ç™»å½•è¯·æ±‚æˆåŠŸï¼š`http://localhost:8080/api/v1/im/auth/login`
- å·¥ä½œå°é¡µé¢åŠ è½½ï¼š`CollectorWorkspace.vue`
- **å…³é”®é—®é¢˜**ï¼š`http://localhost:8080/api/v1/cases?tenant_id=1&collector_id=NaN`

**æ ¹æœ¬åŸå› **ï¼š
1. åç«¯ç™»å½•APIè¿”å›çš„ `collectorId` æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚ "BTQ001"ï¼‰
2. å‰ç«¯ä»£ç ä½¿ç”¨ `parseInt("BTQ001")` å¯¼è‡´è¿”å› `NaN`
3. åç«¯APIæ”¶åˆ° `collector_id=NaN` åå¯èƒ½è¿”å›é”™è¯¯æˆ–ç©ºæ•°æ®
4. è¿™å¯èƒ½å¯¼è‡´åç»­çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œè§¦å‘è·³å›ç™»å½•é¡µ

---

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. ä¿®æ”¹åç«¯ç™»å½•API

**æ–‡ä»¶**: `backend-java/src/main/java/com/cco/controller/MockImController.java`

**æ”¹è¿›**:
- âœ… æ·»åŠ  `collectorIdNumeric` å­—æ®µï¼Œè¿”å›æ•°å­—æ ¼å¼çš„ID
- âœ… åŸºäºå­—ç¬¦ä¸²IDç”Ÿæˆæ•°å­—IDï¼ˆBTQ -> 1, BTSK -> 2ï¼‰

```java
// å°†å­—ç¬¦ä¸²æ ¼å¼çš„collectorIdè½¬æ¢ä¸ºæ•°å­—ID
Long numericCollectorId = 1L; // é»˜è®¤å€¼
if (collectorIdStr.startsWith("BTQ")) {
    numericCollectorId = 1L;
} else if (collectorIdStr.startsWith("BTSK")) {
    numericCollectorId = 2L;
} else {
    numericCollectorId = (long) Math.abs(collectorIdStr.hashCode() % 100);
}

user.put("collectorIdNumeric", numericCollectorId); // æ·»åŠ æ•°å­—æ ¼å¼çš„ID
```

### 2. æ›´æ–°å‰ç«¯ç”¨æˆ·æ¥å£

**æ–‡ä»¶**: `frontend/src/stores/imUser.ts`

**æ”¹è¿›**:
- âœ… æ·»åŠ  `collectorIdNumeric?: number` å­—æ®µ

```typescript
export interface ImUser {
  id: string
  collectorId: string
  collectorIdNumeric?: number // æ•°å­—æ ¼å¼çš„collectorIdï¼Œç”¨äºAPIè°ƒç”¨
  // ...
}
```

### 3. ä¿®å¤å‰ç«¯æ¡ˆä»¶åŠ è½½é€»è¾‘

**æ–‡ä»¶**: `frontend/src/views/im/CollectorWorkspace.vue`

**æ”¹è¿›**:
- âœ… ä¼˜å…ˆä½¿ç”¨ `collectorIdNumeric`
- âœ… å¦‚æœæ²¡æœ‰ï¼Œå°è¯•ä»å­—ç¬¦ä¸²ä¸­æå–æ•°å­—
- âœ… å¦‚æœéƒ½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼1

```typescript
// ä½¿ç”¨æ•°å­—æ ¼å¼çš„collectorIdï¼ˆå¦‚æœåç«¯è¿”å›äº†collectorIdNumericï¼‰
if (user.value.collectorIdNumeric) {
  params.collector_id = user.value.collectorIdNumeric
} else {
  // é™çº§å¤„ç†...
}
```

### 4. å¢å¼ºåç«¯æ¡ˆä»¶API

**æ–‡ä»¶**: `backend-java/src/main/java/com/cco/controller/MockCaseController.java`

**æ”¹è¿›**:
- âœ… æ·»åŠ  `collectorId` å‚æ•°æ”¯æŒ
- âœ… å¦‚æœæŒ‡å®šäº† `collectorId`ï¼Œåªè¿”å›è¯¥å‚¬å‘˜çš„æ¡ˆä»¶

```java
@GetMapping
public ResponseData<Map<String, Object>> getCases(
    @RequestParam(required = false) Long tenantId,
    @RequestParam(required = false) Long queueId,
    @RequestParam(required = false) Long collectorId, // æ–°å¢
    // ...
) {
    // å¦‚æœæŒ‡å®šäº†collectorIdï¼Œæ‰€æœ‰æ¡ˆä»¶éƒ½åˆ†é…ç»™è¯¥å‚¬å‘˜
    if (collectorId != null) {
        caseData.put("collector_id", collectorId);
        caseData.put("collector_name", "å‚¬å‘˜" + collectorId);
    }
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: æ­£å¸¸ç™»å½•

1. è®¿é—® `http://localhost:5173/im/login`
2. å¡«å†™è¡¨å•ï¼š
   - æœºæ„ID: `1`
   - å‚¬å‘˜ID: `BTQ001`
   - å¯†ç : `123456`
   - éªŒè¯ç : è¾“å…¥æ˜¾ç¤ºçš„éªŒè¯ç 
3. ç‚¹å‡»"ç™»å½•"æŒ‰é’®
4. **é¢„æœŸç»“æœ**: 
   - ç™»å½•æˆåŠŸ
   - è·³è½¬åˆ°å·¥ä½œå° `/im/workspace`
   - ä¸å†è·³å›ç™»å½•é¡µ
   - Network é¢æ¿ä¸­ `collector_id` ä¸å†æ˜¯ `NaN`

### æµ‹è¯•2: æ£€æŸ¥ Network é¢æ¿

ç™»å½•åï¼Œæ£€æŸ¥ä»¥ä¸‹è¯·æ±‚ï¼š

**ç™»å½•è¯·æ±‚**:
```
POST /api/v1/im/auth/login
Response: {
  "code": 200,
  "data": {
    "token": "...",
    "user": {
      "id": "BTQ001",
      "collectorId": "BTQ001",
      "collectorIdNumeric": 1,  // âœ… æ–°å¢å­—æ®µ
      ...
    }
  }
}
```

**æ¡ˆä»¶åˆ—è¡¨è¯·æ±‚**:
```
GET /api/v1/cases?tenant_id=1&collector_id=1  // âœ… ä¸å†æ˜¯NaN
Response: {
  "code": 200,
  "data": {
    "items": [...],
    "total": 5
  }
}
```

### æµ‹è¯•3: æ£€æŸ¥ Console æ—¥å¿—

æ‰“å¼€ Console é¢æ¿ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[IM Store] ç™»å½•æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°: { isLoggedIn: true, ... }
[Login] ç™»å½•æˆåŠŸï¼Œå‡†å¤‡è·³è½¬ï¼Œå½“å‰çŠ¶æ€: { isLoggedIn: true, ... }
[IMè·¯ç”±å®ˆå«] æ£€æŸ¥é€šè¿‡ï¼Œæ”¾è¡Œåˆ°: /im/workspace
å¼€å§‹åŠ è½½æ¡ˆä»¶, tenantId: 1, collectorId: BTQ001
ä½¿ç”¨æ•°å­—æ ¼å¼çš„collectorId: 1  // âœ… ä¸å†æ˜¯NaN
æ¡ˆä»¶åŠ è½½å“åº”: { items: [...], total: 5 }
```

---

## ğŸ” ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

```
ç™»å½•è¯·æ±‚ â†’ æˆåŠŸ
è·³è½¬åˆ°å·¥ä½œå° â†’ æˆåŠŸ
åŠ è½½æ¡ˆä»¶ â†’ collector_id=NaN â†’ é”™è¯¯ â†’ è·³å›ç™»å½•é¡µ âŒ
```

### ä¿®å¤å

```
ç™»å½•è¯·æ±‚ â†’ æˆåŠŸï¼ˆè¿”å›collectorIdNumeric: 1ï¼‰
è·³è½¬åˆ°å·¥ä½œå° â†’ æˆåŠŸ
åŠ è½½æ¡ˆä»¶ â†’ collector_id=1 â†’ æˆåŠŸ â†’ æ˜¾ç¤ºæ¡ˆä»¶ âœ…
```

---

## ğŸ“ å…³é”®æ”¹è¿›ç‚¹

### 1. åç«¯è¿”å›æ•°å­—æ ¼å¼ID

**ä¹‹å‰**: åªè¿”å›å­—ç¬¦ä¸²æ ¼å¼çš„ `collectorId`  
**ç°åœ¨**: åŒæ—¶è¿”å› `collectorId`ï¼ˆå­—ç¬¦ä¸²ï¼‰å’Œ `collectorIdNumeric`ï¼ˆæ•°å­—ï¼‰

### 2. å‰ç«¯ä½¿ç”¨æ•°å­—æ ¼å¼ID

**ä¹‹å‰**: `parseInt("BTQ001")` â†’ `NaN`  
**ç°åœ¨**: ä½¿ç”¨ `collectorIdNumeric` â†’ `1`

### 3. åç«¯APIæ”¯æŒcollectorIdè¿‡æ»¤

**ä¹‹å‰**: ä¸æ”¯æŒ `collectorId` å‚æ•°  
**ç°åœ¨**: æ”¯æŒ `collectorId` å‚æ•°ï¼Œå¯ä»¥è¿‡æ»¤ç‰¹å®šå‚¬å‘˜çš„æ¡ˆä»¶

---

## âœ… ä¿®å¤æ£€æŸ¥æ¸…å•

- [x] åç«¯ç™»å½•APIè¿”å› `collectorIdNumeric`
- [x] å‰ç«¯ç”¨æˆ·æ¥å£æ·»åŠ  `collectorIdNumeric` å­—æ®µ
- [x] å‰ç«¯æ¡ˆä»¶åŠ è½½ä½¿ç”¨æ•°å­—æ ¼å¼ID
- [x] åç«¯æ¡ˆä»¶APIæ”¯æŒ `collectorId` å‚æ•°
- [x] ä¿®å¤ `collector_id=NaN` é—®é¢˜

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `backend-java/src/main/java/com/cco/controller/MockImController.java` - ç™»å½•API
- `backend-java/src/main/java/com/cco/controller/MockCaseController.java` - æ¡ˆä»¶API
- `frontend/src/stores/imUser.ts` - ç”¨æˆ·çŠ¶æ€ç®¡ç†
- `frontend/src/views/im/CollectorWorkspace.vue` - å·¥ä½œå°é¡µé¢

---

**ä¿®å¤æ—¶é—´**: 2025-11-22  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

**ç°åœ¨ç™»å½•ååº”è¯¥å¯ä»¥æ­£å¸¸è¿›å…¥å·¥ä½œå°ï¼Œä¸å†è·³å›ç™»å½•é¡µäº†ï¼** ğŸš€






