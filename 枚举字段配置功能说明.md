# 枚举字段配置功能说明

## 变更日期

2025-01-11

---

## 一、功能概述

为标准字段管理和甲方自定义字段管理添加了枚举类型字段的配置功能，支持为每个枚举项配置标准值和甲方映射值。

---

## 二、主要功能

### 2.1 列表页新增"枚举值"列

**标准字段管理** 和 **甲方自定义字段管理** 的列表中新增"枚举值"列：

- 显示枚举类型字段的前2个枚举项
- 如果枚举项超过2个，显示"+N"标签
- 非枚举类型字段显示"-"

**效果示例：**
```
字段类型：Enum
枚举值：  [待还款] [部分还款] +2
```

### 2.2 编辑对话框新增枚举值配置

当字段类型为"枚举"时，显示枚举值配置区域，包含：

#### 2.2.1 配置表格

一个表格用于配置所有枚举项，包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| 标准名称 | 系统标准的枚举值名称 | 待还款 |
| 标准ID | 系统标准的枚举值标识 | pending |
| 甲方名称 | 甲方系统中的枚举值名称 | 未还款 |
| 甲方ID | 甲方系统中的枚举值标识 | unpaid |
| 操作 | 删除该枚举项 | [删除] |

#### 2.2.2 操作按钮

- **添加枚举项**：添加一行空白的枚举配置
- **编辑枚举值**（仅标准字段）：允许编辑标准字段的标准名称和标准ID

---

## 三、交互规则

### 3.1 标准字段管理

#### 3.1.1 列表显示
- 所有枚举类型字段显示其枚举值（前2项）

#### 3.1.2 编辑枚举值
- 枚举值的"标准名称"和"标准ID"可以编辑和管理
- 新增、删除枚举项

### 3.2 甲方自定义字段管理

#### 3.2.1 列表显示
- 所有枚举类型字段（包括标准字段和自定义字段）显示其枚举值

#### 3.2.2 标准字段的枚举配置
- 默认状态下，标准字段的"标准名称"和"标准ID"不可编辑
- 点击"编辑枚举值"按钮后，可以编辑标准字段的标准名称和标准ID
- "甲方名称"和"甲方ID"始终可以编辑（用于映射）
- 不可删除标准字段的枚举项（编辑模式除外）

#### 3.2.3 自定义字段的枚举配置
- 所有字段均可编辑
- 可自由添加、编辑、删除枚举项

---

## 四、数据结构

### 4.1 枚举值数据格式

```typescript
{
  enum_values: [
    {
      standard_name: string,  // 标准名称
      standard_id: string,    // 标准ID
      tenant_name: string,    // 甲方名称
      tenant_id: string       // 甲方ID
    }
  ]
}
```

### 4.2 示例数据

**案件状态字段（case_status）：**

```json
{
  "field_name": "案件状态",
  "field_key": "case_status",
  "field_type": "Enum",
  "enum_values": [
    {
      "standard_name": "待还款",
      "standard_id": "pending",
      "tenant_name": "未还款",
      "tenant_id": "unpaid"
    },
    {
      "standard_name": "部分还款",
      "standard_id": "partial",
      "tenant_name": "部分支付",
      "tenant_id": "partial_paid"
    },
    {
      "standard_name": "正常结清",
      "standard_id": "settled",
      "tenant_name": "已结清",
      "tenant_id": "paid_off"
    },
    {
      "standard_name": "展期结清",
      "standard_id": "extended_settled",
      "tenant_name": "延期结清",
      "tenant_id": "extension_paid"
    }
  ]
}
```

---

## 五、技术实现

### 5.1 文件变更

#### 5.1.1 标准字段管理
**文件：** `frontend/src/views/field-config/StandardFields.vue`

**变更内容：**
- 表格新增"枚举值"列（200px宽）
- 对话框宽度从600px增加到800px
- 表单新增"枚举值配置"部分（仅当field_type为Enum时显示）
- 添加`enum_values`字段到form数据结构
- 添加处理函数：
  - `handleFieldTypeChange`：字段类型变更处理
  - `handleAddEnumValue`：添加枚举项
  - `handleRemoveEnumValue`：删除枚举项

#### 5.1.2 甲方自定义字段管理
**文件：** `frontend/src/views/field-config/CustomFields.vue`

**变更内容：**
- 表格新增"枚举值"列（200px宽）
- 对话框宽度从600px增加到800px
- 表单新增"枚举值配置"部分（仅当field_type为Enum时显示）
- 添加`enum_values`字段到form数据结构
- 添加`editingEnum`状态（控制标准字段枚举值编辑）
- 添加处理函数（同标准字段管理）
- 枚举值配置表格支持条件禁用（标准字段需点击"编辑枚举值"）

### 5.2 核心代码

#### Form数据结构

```typescript
const form = ref({
  // ... 其他字段
  enum_values: [] as Array<{
    standard_name: string
    standard_id: string
    tenant_name: string
    tenant_id: string
  }>
})
```

#### 字段类型变更处理

```typescript
const handleFieldTypeChange = (value: string) => {
  if (value === 'Enum' && form.value.enum_values.length === 0) {
    // 如果切换到枚举类型且没有枚举值，添加一个默认项
    form.value.enum_values = [{
      standard_name: '',
      standard_id: '',
      tenant_name: '',
      tenant_id: ''
    }]
  }
}
```

#### 添加枚举项

```typescript
const handleAddEnumValue = () => {
  form.value.enum_values.push({
    standard_name: '',
    standard_id: '',
    tenant_name: '',
    tenant_id: ''
  })
}
```

#### 删除枚举项

```typescript
const handleRemoveEnumValue = (index: number) => {
  form.value.enum_values.splice(index, 1)
}
```

### 5.3 样式定义

```css
/* 枚举配置样式 */
.enum-config {
  width: 100%;
}

.enum-header {
  margin-bottom: 10px;
}

.enum-config :deep(.el-table) {
  font-size: 13px;
}

.enum-config :deep(.el-input__inner) {
  font-size: 12px;
}
```

---

## 六、使用场景

### 6.1 创建新的枚举字段

1. 点击"添加字段"按钮
2. 填写字段名称和字段标识
3. 选择字段类型为"枚举"
4. 点击"添加枚举项"按钮
5. 填写每个枚举项的：
   - 标准名称（系统内部使用）
   - 标准ID（系统内部标识）
   - 甲方名称（显示给甲方用户）
   - 甲方ID（甲方系统中的值）
6. 点击"保存"

### 6.2 编辑枚举字段（标准字段）

1. 点击枚举字段的"编辑"按钮
2. 查看枚举值配置（标准名称和标准ID默认不可编辑）
3. 如需修改标准值，点击"编辑枚举值"按钮
4. 编辑标准名称、标准ID
5. 点击"保存"

### 6.3 配置甲方枚举映射

1. 在"甲方自定义字段管理"页面
2. 选择一个甲方
3. 编辑枚举类型的标准字段
4. 修改"甲方名称"和"甲方ID"，将甲方系统的枚举值映射到标准值
5. 点击"保存"

**示例：**
假设甲方系统中案件状态有以下值：
- "NOT_PAID"（未支付）
- "PARTIAL_PAID"（部分支付）
- "PAID"（已支付）

配置映射：
```
标准名称    标准ID              甲方名称      甲方ID
待还款      pending            未支付        NOT_PAID
部分还款    partial            部分支付      PARTIAL_PAID
正常结清    settled            已支付        PAID
```

---

## 七、API设计建议

### 7.1 标准字段API

**创建/更新标准字段：**
```
POST   /api/v1/standard-fields
PUT    /api/v1/standard-fields/{field_id}
```

**请求体示例：**
```json
{
  "field_name": "案件状态",
  "field_key": "case_status",
  "field_type": "Enum",
  "field_group_id": 2,
  "is_required": true,
  "sort_order": 1,
  "enum_values": [
    {
      "standard_name": "待还款",
      "standard_id": "pending",
      "tenant_name": "待还款",
      "tenant_id": "pending"
    },
    {
      "standard_name": "部分还款",
      "standard_id": "partial",
      "tenant_name": "部分还款",
      "tenant_id": "partial"
    }
  ]
}
```

### 7.2 甲方字段配置API

**更新甲方字段配置（包含枚举值映射）：**
```
PUT    /api/v1/tenants/{tenant_id}/fields/{field_id}
```

**请求体示例：**
```json
{
  "tenant_field_key": "CASE_STATUS",
  "tenant_field_id": "case_status_036",
  "is_required": true,
  "sort_order": 2,
  "enum_values": [
    {
      "standard_name": "待还款",
      "standard_id": "pending",
      "tenant_name": "未还款",
      "tenant_id": "unpaid"
    },
    {
      "standard_name": "部分还款",
      "standard_id": "partial",
      "tenant_name": "部分支付",
      "tenant_id": "partial_paid"
    }
  ]
}
```

---

## 八、数据库设计建议

### 8.1 standard_fields 表

添加 `enum_values` 字段：

```sql
ALTER TABLE standard_fields 
ADD COLUMN enum_values JSON NULL COMMENT '枚举值配置（仅Enum类型使用）';
```

### 8.2 tenant_field_configs 表

添加 `enum_values` 字段：

```sql
ALTER TABLE tenant_field_configs 
ADD COLUMN enum_values JSON NULL COMMENT '枚举值配置（含甲方映射）';
```

### 8.3 JSON数据格式示例

```json
[
  {
    "standard_name": "待还款",
    "standard_id": "pending",
    "tenant_name": "未还款",
    "tenant_id": "unpaid"
  },
  {
    "standard_name": "部分还款",
    "standard_id": "partial",
    "tenant_name": "部分支付",
    "tenant_id": "partial_paid"
  }
]
```

---

## 九、测试要点

### 9.1 功能测试

- [ ] 创建枚举类型字段，正确保存枚举值
- [ ] 编辑枚举字段，修改枚举值
- [ ] 添加枚举项
- [ ] 删除枚举项
- [ ] 列表正确显示枚举值（前2项+标签）
- [ ] 切换字段类型到Enum，自动添加默认枚举项
- [ ] 切换字段类型从Enum到其他，枚举配置区域隐藏

### 9.2 甲方字段管理测试

- [ ] 标准枚举字段默认不可编辑标准名称和标准ID
- [ ] 点击"编辑枚举值"后可以编辑
- [ ] 甲方名称和甲方ID始终可编辑
- [ ] 自定义枚举字段所有字段可编辑

### 9.3 数据验证

- [ ] 枚举值正确保存到数据库
- [ ] 甲方映射正确保存
- [ ] 枚举值数据在列表和编辑时正确加载

---

## 十、总结

本次功能添加为枚举类型字段提供了完整的配置能力，核心特性：

✅ **可视化配置**：通过表格直观配置枚举值  
✅ **标准值管理**：系统级标准枚举值统一管理  
✅ **甲方映射**：支持甲方系统枚举值映射  
✅ **灵活编辑**：标准字段和自定义字段分别控制编辑权限  
✅ **列表展示**：在列表中快速查看枚举值  

现在可以轻松管理枚举类型字段，满足不同甲方的个性化枚举值需求！

