# 催员IM端 - 还款码管理功能 PRD

## 1. 功能概述

催员可以在IM端为所负责的案件请求还款码，支持多种支付渠道（VA码、H5链接、二维码），并可查看历史还款码记录及支付状态。

## 2. 功能入口

**位置：** 案件详情页面 -> "还款码"Tab页

**权限：** 仅催员角色可访问，且仅能操作分配给自己的案件

## 3. 核心功能

### 3.1 请求还款码

#### 3.1.1 触发方式

1. 进入案件详情页面
2. 点击"还款码"Tab
3. 点击"请求还款码"按钮

#### 3.1.2 渠道选择界面

**展示形式：** 卡片式布局，横向或网格排列

**卡片内容：**
- 渠道图标（64x64px）
- 渠道名称
- 支付类型标签（VA码/H5链接/二维码）
- 服务商名称（小字）

**排序规则：** 按照管理控台配置的sort_order排序

**筛选规则：** 仅显示该甲方已启用的渠道

#### 3.1.3 金额输入弹窗

**触发：** 点击某个渠道卡片后弹出

**弹窗内容：**

| 字段 | 说明 | 交互 |
|------|------|------|
| 案件信息 | 显示案件编号、客户姓名 | 只读 |
| 借款信息 | 显示借款编号、总金额 | 只读 |
| 期数选择 | 显示所有期数，标注当前逾期期数 | 下拉选择 |
| 本期应还金额 | 根据期数自动计算 | 自动填充，可修改 |
| 实际还款金额 | 催员可调整的金额 | 数字输入框 |

**快速选择功能：**
- 默认显示当前逾期期数
- 自动填充该期的应还金额（本金+利息+罚息+费用）
- 催员可手动修改金额（支持部分还款或超额还款）

**按钮：**
- 确认生成：调用接口请求还款码
- 取消：关闭弹窗

**示例界面：**
```
┌─────────────────────────────────────┐
│  请求还款码 - GCash                    │
├─────────────────────────────────────┤
│  案件编号：CASE-2024-001              │
│  客户姓名：Juan Dela Cruz             │
│  借款编号：LOAN-2024-001              │
│  借款总额：₱ 50,000                   │
│                                       │
│  期数选择：[▼ 第2期（逾期）]           │
│                                       │
│  本期应还：                            │
│  - 本金：₱ 5,000                      │
│  - 利息：₱ 200                        │
│  - 罚息：₱ 100                        │
│  - 费用：₱ 50                         │
│  合计：₱ 5,350                        │
│                                       │
│  实际还款金额：[5350.00]              │
│                                       │
│  [取消]              [确认生成]       │
└─────────────────────────────────────┘
```

#### 3.1.4 还款码展示

**请求成功后：**

根据支付类型不同，展示不同内容：

**VA码类型：**
- 显示虚拟账户号（大字体）
- 复制按钮
- 有效期倒计时
- 使用说明

**H5链接类型：**
- 显示短链接
- 复制链接按钮
- 打开链接按钮
- 分享按钮
- 有效期倒计时

**二维码类型：**
- 显示二维码图片（可放大）
- 下载按钮
- 分享按钮
- 有效期倒计时

**示例界面（VA码）：**
```
┌─────────────────────────────────────┐
│  ✓ 还款码生成成功                     │
├─────────────────────────────────────┤
│  [GCash图标] GCash                   │
│  VA码                                 │
│                                       │
│  虚拟账户号                            │
│  ┌─────────────────────────────┐    │
│  │  8808 1234 5678 9012       │    │
│  └─────────────────────────────┘    │
│  [复制]                              │
│                                       │
│  还款金额：₱ 5,350.00                │
│  有效期至：2025-11-22 18:00          │
│  剩余时间：23小时59分                 │
│                                       │
│  使用说明：                            │
│  请客户通过GCash转账至以上虚拟账户号   │
│                                       │
│  [关闭]                              │
└─────────────────────────────────────┘
```

### 3.2 还款码列表

#### 3.2.1 列表展示

**位置：** "还款码"Tab页的主要内容区域

**列表项内容：**
- 渠道图标 + 名称
- 支付类型标签
- 还款金额（大字体，突出显示）
- 期数标签
- 状态徽章（待支付/已支付/已过期）
- 有效期倒计时（仅待支付状态）
- 创建时间
- 操作按钮（查看详情）

**状态说明：**
- 待支付（蓝色）：还款码有效期内，未支付
- 已支付（绿色）：已完成支付
- 已过期（灰色）：超过有效期未支付

**排序：** 按创建时间倒序（最新的在上面）

**筛选器：**
- 全部
- 待支付
- 已支付
- 已过期

#### 3.2.2 详情查看

**触发：** 点击列表项或"查看详情"按钮

**详情页面包含：**

**基础信息：**
- 还款码编号
- 渠道名称 + 图标
- 支付类型
- 服务商

**案件信息：**
- 案件编号
- 客户姓名
- 借款编号
- 期数

**金额信息：**
- 还款金额
- 币种

**支付码信息：**
- VA码号/H5链接/二维码图片
- 复制/分享/下载按钮

**时间信息：**
- 创建时间
- 有效期至
- 支付时间（已支付状态）

**状态信息：**
- 当前状态
- 剩余有效期（待支付状态）

### 3.3 数据库设计

**payment_codes 表（还款码记录表）：**

```sql
CREATE TABLE payment_codes (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  code_no VARCHAR(100) UNIQUE NOT NULL COMMENT '还款码编号',
  party_id BIGINT NOT NULL COMMENT '甲方ID',
  channel_id BIGINT NOT NULL COMMENT '渠道ID',
  case_id BIGINT NOT NULL COMMENT '案件ID',
  loan_id BIGINT NOT NULL COMMENT '借款ID',
  customer_id BIGINT NOT NULL COMMENT '客户ID',
  collector_id BIGINT NOT NULL COMMENT '催员ID',
  installment_number INT COMMENT '期数',
  amount DECIMAL(15,2) NOT NULL COMMENT '还款金额',
  currency VARCHAR(10) DEFAULT 'IDR' COMMENT '币种',
  payment_type ENUM('VA', 'H5', 'QR') NOT NULL COMMENT '支付类型：VA-虚拟账户，H5-H5链接，QR-二维码',
  payment_code VARCHAR(500) COMMENT '支付码内容（VA码/链接地址）',
  qr_image_url VARCHAR(500) COMMENT '二维码图片URL',
  status ENUM('PENDING', 'PAID', 'EXPIRED') DEFAULT 'PENDING' COMMENT '状态：PENDING-待支付，PAID-已支付，EXPIRED-已过期',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  expired_at TIMESTAMP COMMENT '过期时间（由第三方接口返回）',
  paid_at TIMESTAMP COMMENT '支付时间',
  third_party_order_id VARCHAR(200) COMMENT '第三方订单ID',
  third_party_response JSON COMMENT '第三方接口完整返回',
  request_params JSON COMMENT '请求参数快照',
  INDEX idx_case_loan (case_id, loan_id),
  INDEX idx_collector_time (collector_id, created_at),
  INDEX idx_status_expired (status, expired_at),
  INDEX idx_code_no (code_no),
  INDEX idx_third_party_order (third_party_order_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='还款码记录表';
```

### 3.4 API接口设计

**接口1：获取可用还款渠道**
```
GET /api/im/payment-channels
请求参数：
  - party_id: 甲方ID（从案件信息获取）

返回示例：
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "channel_name": "GCash",
      "channel_icon": "https://...",
      "channel_type": "VA",
      "service_provider": "Xendit",
      "sort_order": 1
    }
  ]
}
```

**接口2：获取期数信息**
```
GET /api/im/cases/{case_id}/installments
返回示例：
{
  "code": 0,
  "msg": "success",
  "data": {
    "total_installments": 12,
    "current_overdue": 2,
    "installments": [
      {
        "number": 1,
        "status": "PAID",
        "due_date": "2025-10-01",
        "principal": 5000,
        "interest": 200,
        "penalty": 0,
        "fee": 50,
        "total": 5250
      },
      {
        "number": 2,
        "status": "OVERDUE",
        "due_date": "2025-11-01",
        "overdue_days": 20,
        "principal": 5000,
        "interest": 200,
        "penalty": 100,
        "fee": 50,
        "total": 5350
      }
    ]
  }
}
```

**接口3：请求还款码**
```
POST /api/im/payment-codes/request
请求体：
{
  "case_id": 123,
  "loan_id": 456,
  "channel_id": 1,
  "installment_number": 2,
  "amount": 5350.00
}

返回示例：
{
  "code": 0,
  "msg": "success",
  "data": {
    "code_no": "PAY20251121001",
    "payment_type": "VA",
    "payment_code": "8808123456789012",
    "qr_image_url": null,
    "channel_name": "GCash",
    "channel_icon": "https://...",
    "amount": 5350.00,
    "currency": "PHP",
    "expired_at": "2025-11-22T18:00:00Z",
    "created_at": "2025-11-21T18:00:00Z"
  }
}
```

**接口4：查询还款码列表**
```
GET /api/im/payment-codes
请求参数：
  - case_id: 案件ID（可选，不传则查询该催员所有还款码）
  - status: 状态（可选：PENDING/PAID/EXPIRED）
  - page: 页码
  - page_size: 每页数量

返回示例：
{
  "code": 0,
  "msg": "success",
  "data": {
    "total": 15,
    "list": [
      {
        "id": 1,
        "code_no": "PAY20251121001",
        "channel_name": "GCash",
        "channel_icon": "https://...",
        "payment_type": "VA",
        "installment_number": 2,
        "amount": 5350.00,
        "currency": "PHP",
        "status": "PENDING",
        "created_at": "2025-11-21T18:00:00Z",
        "expired_at": "2025-11-22T18:00:00Z",
        "remaining_seconds": 86400
      }
    ]
  }
}
```

**接口5：查询还款码详情**
```
GET /api/im/payment-codes/{code_no}
返回示例：
{
  "code": 0,
  "msg": "success",
  "data": {
    "code_no": "PAY20251121001",
    "party_id": 1,
    "channel_id": 1,
    "channel_name": "GCash",
    "channel_icon": "https://...",
    "service_provider": "Xendit",
    "payment_type": "VA",
    "payment_code": "8808123456789012",
    "qr_image_url": null,
    "case_id": 123,
    "case_no": "CASE-2024-001",
    "loan_id": 456,
    "loan_no": "LOAN-2024-001",
    "customer_name": "Juan Dela Cruz",
    "installment_number": 2,
    "amount": 5350.00,
    "currency": "PHP",
    "status": "PENDING",
    "created_at": "2025-11-21T18:00:00Z",
    "expired_at": "2025-11-22T18:00:00Z",
    "paid_at": null
  }
}
```

### 3.5 支付状态同步

#### 3.5.1 Webhook接收

**接口：** `POST /api/webhook/payment-callback`

**功能：**
1. 接收第三方支付平台的支付通知
2. 验证签名（根据不同服务商的规则）
3. 更新payment_codes表的状态
4. 如果已支付，同步更新案件还款记录
5. 返回确认响应

**状态更新逻辑：**
- 支付成功 -> 更新status为PAID，记录paid_at
- 支付失败 -> 不更新状态
- 订单过期 -> 更新status为EXPIRED

#### 3.5.2 定时任务

**任务1：检查过期还款码**
- 频率：每小时执行一次
- 逻辑：查询status=PENDING且expired_at < 当前时间的记录，更新为EXPIRED

**任务2：主动查询支付状态**
- 频率：每30分钟执行一次
- 逻辑：查询最近7天内status=PENDING的记录，调用第三方接口查询状态

## 4. 权限设计

**催员权限：**
- `payment_code:request` - 请求还款码
- `payment_code:view` - 查看还款码

**权限约束：**
- 催员只能为分配给自己的案件请求还款码
- 催员只能查看自己请求的还款码记录
- 不支持取消已生成的还款码

## 5. 前端实现

### 5.1 页面组件结构

```
PaymentCode/
├── index.vue                    # 还款码Tab主页面
├── components/
│   ├── ChannelSelector.vue      # 渠道选择卡片
│   ├── AmountInputDialog.vue    # 金额输入弹窗
│   ├── CodeDisplay.vue          # 还款码展示组件
│   ├── CodeList.vue             # 还款码列表
│   ├── CodeDetail.vue           # 还款码详情
│   └── CountdownTimer.vue       # 倒计时组件
└── types.ts                     # 类型定义
```

### 5.2 关键技术实现

1. **倒计时组件**
   - 实时显示剩余时间
   - 到期自动刷新状态
   - 支持时分秒显示

2. **二维码显示**
   - 使用qrcode.js或vue-qrcode组件
   - 支持放大预览
   - 支持下载保存

3. **复制功能**
   - 使用clipboard.js
   - 复制成功提示

4. **分享功能**
   - 生成分享文本
   - 调用系统分享API

## 6. 异常处理

### 6.1 接口调用失败

**场景：** 第三方支付接口不可用

**处理：**
- 显示友好的错误提示
- 提供重试按钮
- 记录错误日志供排查

### 6.2 有效期已过

**场景：** 查看已过期的还款码

**处理：**
- 显示"已过期"状态
- 提示可重新生成
- 不显示支付码内容

### 6.3 权限不足

**场景：** 催员查看其他人的还款码

**处理：**
- 返回403错误
- 提示无权限访问

## 7. 测试用例

### 7.1 功能测试

1. 请求VA码类型还款码
2. 请求H5链接类型还款码
3. 请求二维码类型还款码
4. 选择不同期数
5. 修改还款金额
6. 查看还款码列表
7. 筛选不同状态
8. 查看还款码详情
9. 复制支付码
10. 分享还款码

### 7.2 边界测试

1. 输入金额为0
2. 输入金额超过借款总额
3. 第三方接口超时
4. 第三方接口返回错误
5. 有效期倒计时到0
6. 无可用渠道

## 8. 注意事项

1. **安全性**
   - 所有接口需验证催员身份
   - 验证案件是否分配给该催员
   - 敏感信息不在前端缓存

2. **用户体验**
   - 金额输入支持计算器
   - 支付码大字体显示，便于查看
   - 倒计时醒目提示
   - 操作反馈及时

3. **性能优化**
   - 列表分页加载
   - 图片懒加载
   - 接口请求防抖

4. **兼容性**
   - 支持移动端和PC端
   - 适配不同屏幕尺寸
   - 支持主流浏览器

