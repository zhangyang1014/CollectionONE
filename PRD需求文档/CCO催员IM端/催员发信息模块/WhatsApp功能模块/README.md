# WhatsApp功能模块 - 需求文档总览

本目录包含WhatsApp信息收发功能的完整需求拆分，从主需求文档中拆分为5个独立的子需求PRD，便于开发和迭代。

---

## 📁 文档结构

```
WhatsApp功能模块/
├── README.md                                   # 本文档（总览）
├── 1-催员端发送WA信息PRD.md                     # 发送功能
├── 2-催员端接收WA信息PRD.md                     # 接收功能
├── 3-记录WA信息发送状态PRD.md                   # 状态记录
├── 4-催员端账号管理-添加个人WA和个人WA掉线PRD.md  # 账号管理
└── 5-智能Chatting状态判断优化PRD.md             # 性能优化
```

---

## 📄 子需求文档清单

### 1. [催员端发送WA信息PRD.md](./1-催员端发送WA信息PRD.md)

**功能概述**：
- 发送文本消息（最大1000字符）
- 发送图片消息（支持JPG/PNG/GIF，最大10MB）
- WA账号选择（公司WA/个人WA）
- 渠道触达限制校验
- 发送失败错误处理

**核心场景**：
- 场景1：发送文本消息
- 场景2：发送图片消息

**范围边界**：
- ✅ 文本消息发送
- ✅ 图片消息发送
- ❌ 视频消息发送（仅接收）
- ❌ 音频消息发送（仅接收）

---

### 2. [催员端接收WA信息PRD.md](./2-催员端接收WA信息PRD.md)

**功能概述**：
- 接收文本消息
- 接收图片消息（预览、放大、下载）
- 接收视频消息（在线播放、播放控制）
- 接收音频消息（播放、倍速播放）
- 接收其他催员发送的消息
- 桌面通知

**核心场景**：
- 场景1：接收文本消息
- 场景2：接收图片消息
- 场景3：接收视频消息
- 场景4：接收音频消息
- 场景5：接收其他催员发送的消息

**范围边界**：
- ✅ 接收多种消息类型（文本/图片/视频/音频）
- ✅ 媒体消息在线播放
- ✅ 桌面通知
- ❌ 文件消息接收（待实现）

---

### 3. [记录WA信息发送状态PRD.md](./3-记录WA信息发送状态PRD.md)

**功能概述**：
- 5种消息状态显示（sending/sent/delivered/read/failed）
- 状态图标实时更新
- 轮询查询消息状态
- Tooltip提示状态含义
- 失败消息重试功能

**消息状态生命周期**：
1. **sending**（发送中）- 钟表图标 ⏰
2. **sent**（已发送）- 单灰色对勾 ✓
3. **delivered**（已送达）- 双灰色对勾 ✓✓
4. **read**（已读）- 双蓝色对勾 ✓✓（蓝色）
5. **failed**（失败）- 红色感叹号 !

**范围边界**：
- ✅ 5种状态显示和更新
- ✅ 状态轮询机制
- ✅ 失败消息重试
- ❌ 消息撤回功能

---

### 4. [催员端账号管理-添加个人WA和个人WA掉线PRD.md](./4-催员端账号管理-添加个人WA和个人WA掉线PRD.md)

**功能概述**：
- 添加个人WA账号（最多3个）
- 二维码绑定流程
- 绑定状态轮询
- 个人WA掉线检测（每30秒）
- 掉线账号标识显示
- 个人WA重新绑定

**核心场景**：
- 场景1：添加个人WA账号
- 场景2：查看个人WA账号列表
- 场景3：切换个人WA账号
- 场景4：个人WA掉线检测
- 场景5：个人WA掉线重新绑定

**账号状态**：
- `pending`：待绑定
- `paired`：已绑定（正常可用）
- `unpaired`：已掉线（需重新绑定）
- `binding`：绑定中
- `failed`：绑定失败

**范围边界**：
- ✅ 添加个人WA（最多3个）
- ✅ 二维码绑定
- ✅ 掉线检测和重新绑定
- ❌ 手动解绑功能（待实现）

---

### 5. [智能Chatting状态判断优化PRD.md](./5-智能Chatting状态判断优化PRD.md)

**功能概述**：
- 三级缓存机制（wa_relation表 → message表 → CWA API）
- wa_relation表缓存层（7天有效期）
- message表历史回复记录查询
- 跨甲方缓存查询
- 定时缓存清理（30天）

**三级查询逻辑**：
1. **查询1**：wa_relation表缓存（7天内）- 最快，约100ms
2. **查询2**：message表历史回复（7天内）- 较快，约200ms
3. **查询3**：CWA checkPhone接口 - 较慢，约1-2秒

**优化效果**：
- CWA API调用减少率：≥90%
- Chatting状态缓存命中率：≥85%
- 查询响应时间：≤500ms（缓存命中）
- WhatsApp风控风险：显著降低

**范围边界**：
- ✅ 三级缓存机制
- ✅ 跨甲方缓存
- ✅ 定时缓存清理
- ❌ 手动刷新缓存（待实现）

---

## 🔗 功能依赖关系

```
┌─────────────────────────────────────────────────────────┐
│                   主需求文档                             │
│         WhatsApp信息收发功能PRD.md                       │
└─────────────────────────────────────────────────────────┘
                           │
           ┌───────────────┼───────────────┬───────────────┐
           │               │               │               │
           ▼               ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │ 1.发送   │    │ 2.接收   │    │ 3.状态   │    │ 4.账号   │
    │   功能   │◄──►│   功能   │◄──►│   记录   │◄──►│   管理   │
    └──────────┘    └──────────┘    └──────────┘    └──────────┘
           │               │               │               │
           └───────────────┴───────────────┴───────────────┘
                                   │
                                   ▼
                            ┌──────────┐
                            │ 5.性能   │
                            │   优化   │
                            └──────────┘
```

**依赖说明**：
- **1.发送功能** ← 依赖 **4.账号管理**（需要选择WA账号）
- **1.发送功能** → 产生 **3.状态记录**（发送后需要记录状态）
- **2.接收功能** ← 被 **1.发送功能** 触发（客户回复）
- **5.性能优化** → 优化 **1.发送功能**和**2.接收功能**（减少API调用）

---

## 📊 核心数据表

### 1. messages表（消息记录）

用于存储所有消息（发送和接收）。

**关键字段**：
- `id`：消息ID
- `contact_id`：联系人ID
- `type`：消息类型（text/image/video/audio）
- `content`：消息内容
- `sender_type`：发送者类型（collector/customer）
- `channel`：渠道（whatsapp）
- `status`：状态（sending/sent/delivered/read/failed）
- `sent_at`：发送时间

### 2. wa_relation表（Chatting状态缓存）

用于缓存手机号WhatsApp注册状态。

**关键字段**：
- `id`：主键ID
- `phone_number`：手机号
- `status`：状态（chatting/not_registered）
- `checked_at`：查询时间（判断7天有效期）
- `last_used_at`：最后使用时间
- `source`：来源（cwa_api/message_history）
- `tenant_id`：甲方ID（NULL表示跨甲方）

### 3. wa_devices表（WA云设备）

用于管理个人WA账号。

**关键字段**：
- `device_id`：云设备ID
- `collector_id`：催员ID
- `phone_number`：绑定的手机号
- `status`：状态（pending/paired/unpaired/binding/failed）
- `paired_at`：绑定成功时间
- `unpaired_at`：掉线时间

---

## 🧪 测试覆盖

| 子需求 | 功能测试用例 | 性能测试用例 | 总计 |
|-------|------------|------------|------|
| 1.发送功能 | 10个 | - | 10个 |
| 2.接收功能 | 15个 | - | 15个 |
| 3.状态记录 | 10个 | - | 10个 |
| 4.账号管理 | 11个 | - | 11个 |
| 5.性能优化 | 10个 | 5个 | 15个 |
| **总计** | **56个** | **5个** | **61个** |

---

## 📈 性能指标

| 指标 | 目标值 | 所属子需求 |
|------|--------|----------|
| 消息发送成功率 | ≥95% | 1.发送功能 |
| 消息接收延迟 | ≤3秒 | 2.接收功能 |
| 状态更新延迟 | ≤5秒 | 3.状态记录 |
| 个人WA绑定成功率 | ≥90% | 4.账号管理 |
| CWA API调用减少率 | ≥90% | 5.性能优化 |
| Chatting状态缓存命中率 | ≥85% | 5.性能优化 |

---

## 🛠️ 开发建议

### 开发顺序

**第一阶段**：基础功能（优先级：高）
1. **4.账号管理** - 添加个人WA账号
2. **1.发送功能** - 文本和图片发送
3. **2.接收功能** - 文本和图片接收

**第二阶段**：状态跟踪（优先级：高）
4. **3.状态记录** - 消息状态显示和更新

**第三阶段**：高级功能（优先级：中）
5. **2.接收功能** - 视频和音频接收
6. **4.账号管理** - 个人WA掉线检测和重新绑定

**第四阶段**：性能优化（优先级：中）
7. **5.性能优化** - 智能Chatting状态判断

### 技术栈

**前端**：
- Vue 3 + TypeScript
- Element Plus（UI组件库）
- Axios（HTTP请求）
- WebSocket（实时通知，可选）

**后端**：
- Java 17 + Spring Boot 3.3.5
- MyBatis-Plus 3.5.8
- MySQL 8.0
- CWA API（WhatsApp云服务）

---

## 📝 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0.0 | 2025-01-20 | 初始版本，拆分主需求为5个子需求 |
| 1.1.0 | 2025-12-03 | 新增开发注意事项，基于实际开发中的BUG修复经验 |

---

## ⚠️ 开发注意事项（必读）

### 关键技术要点

基于实际开发和BUG修复经验，开发者必须注意以下要点：

#### 1. 代码质量红线 🔴

**绝对禁止**：
- ❌ 重复定义函数名（会导致功能失效）
- ❌ 多次定义同一个生命周期钩子（会导致内存泄漏）
- ❌ 在catch块中忘记关闭loading消息
- ❌ 使用any类型（降低代码安全性）

#### 2. 资源管理必做 ✅

**必须在`onUnmounted`中清理**：
- ✅ 所有定时器（`clearInterval`）
- ✅ 所有弹窗（设为false）
- ✅ 所有事件监听（`removeEventListener`）

**示例**：
```typescript
onUnmounted(() => {
  // 清理定时器
  stopMessagePolling()
  stopBindingStatusPolling()
  
  // 关闭弹窗
  qrCodeDialogVisible.value = false
  
  // 移除监听
  window.removeEventListener('online', handleNetworkOnline)
})
```

#### 3. 网络异常处理 🌐

**必须实现**：
- 连续失败计数（建议MAX=3）
- 达到上限后停止轮询
- 监听网络恢复事件
- 恢复后自动重启

#### 4. 性能优化建议 ⚡

- 快速切换时添加防抖（100-300ms）
- 过期资源及时停止（如二维码过期后停止轮询）
- 使用明确的TypeScript类型

#### 5. 详细技术文档 📚

完整的技术实现注意事项请参考：
- [PRD-4: 技术实现注意事项章节](./4-催员端账号管理-添加个人WA和个人WA掉线PRD.md#3-技术实现注意事项implementation-notes)
- [WhatsApp功能BUG修复完成报告](../../../说明文档/前端/WhatsApp功能BUG修复完成报告.md)
- [WhatsApp功能BUG修复和优化计划](../../../说明文档/前端/WhatsApp功能BUG修复和优化计划.md)

#### 6. 代码审查清单 ✓

提交代码前必须检查：
- [ ] 运行Linter无错误
- [ ] 无重复函数定义
- [ ] 资源清理完整
- [ ] 错误处理完善
- [ ] 类型定义明确
- [ ] 网络异常处理完整

---

## 👥 联系方式

**文档作者**：CCO产品团队  
**最后更新**：2025-12-03  
**主需求文档**：[WhatsApp信息收发功能PRD.md](../WhatsApp信息收发功能PRD.md)

