# 小组群管理PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

随着催收业务规模的扩大，催收机构下需要管理大量的小组。为了更好地组织和管理这些小组，引入小组群（TeamGroup）概念，作为机构和小组之间的中间层级，由小组群管理员（SPV - Supervisor）进行管理。本需求旨在构建小组群管理功能，支持小组群的创建、编辑、启用/禁用等全生命周期管理，为后续的小组管理、案件分配、业绩统计等功能提供基础支撑。

### 2. 业务场景与用户画像（Business Scenario & User）

**典型使用场景：**

1. **小组群创建场景**：机构管理员创建小组群，并创建小组群管理员账号（SPV）。

2. **日常管理场景**：机构管理员查看和管理本机构下的所有小组群；小组群管理员查看和管理本小组群下的所有小组。

3. **组织调整场景**：因业务调整需要禁用某个小组群，系统会级联影响其下所有小组和催员。

**主要用户类型：**

- **机构管理员（AgencyAdmin）**：机构级别的管理员，负责管理本机构下的所有小组群，创建小组群和小组群管理员账号。
- **小组群管理员（TeamGroupAdmin/SPV）**：小组群级别的管理员，负责管理本小组群下的所有小组。

**核心诉求：**

- 能够清晰地查看和管理小组群信息
- 能够快速创建和配置小组群
- 能够灵活调整小组群状态（启用/禁用）
- 能够查看小组群的统计信息（小组数量、催员数量等）

### 3. 关键业务流程（Business Flow）

#### 3.1 小组群创建流程

```mermaid
[机构管理员登录]
    ↓ 创建小组群
[小组群] + [小组群管理员账号(SPV)]
    ↓ 小组群管理员登录
[管理本小组群下的小组]
```

**详细步骤：**

1. **创建小组群**（机构管理员操作）
   - 选择所属甲方和机构
   - 输入小组群信息：小组群编码（自动填充"甲方编码-"前缀）、名称、描述
   - 输入小组群管理员信息：账号名、登录ID（自动填充"甲方编码-"前缀）、邮箱、密码、确认密码（必填）
   - 系统同时创建小组群记录和小组群管理员账号
   - 小组群管理员收到账号信息

#### 3.2 小组群查询流程

```
[用户登录]
    ↓ 根据角色权限
[查看小组群列表]
    ├── 机构管理员：查看本机构下所有小组群
    └── 小组群管理员：查看本小组群信息
    ↓ 筛选和搜索
[展示列表]
    ├── 统计信息（小组数量、催员数量）
    ├── 状态信息（启用/禁用）
    └── 操作按钮（编辑、启用/禁用、删除）
```

#### 3.3 小组群调整流程

```
[选择目标小组群]
    ↓
[执行操作]
    ├── 编辑：修改基本信息
    ├── 启用/禁用：改变状态
    └── 删除：移除小组群
    ↓
[系统验证]
    ├── 检查是否有下级组织单元
    └── 检查权限是否允许
    ↓
[执行操作并级联影响]
    └── 禁用小组群 → 禁用其下所有小组、催员
```

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 小组群基本规则

- **唯一性规则**：
  - 小组群编码在系统内唯一（通过"甲方编码-"前缀保证）
- **必填字段**：
  - 小组群：编码（含甲方前缀）、名称、所属机构、管理员密码、管理员确认密码

#### 4.2 启用/禁用规则

- **禁用小组群**：会级联禁用其下所有小组和催员，但不会删除数据
- **启用规则**：启用小组群时，不会自动启用下级组织单元，需要手动启用

#### 4.3 删除规则

- **小组群**：支持删除，但有以下限制：
  - 如果小组群下有关联的小组或催员，不允许删除
  - 必须先删除或转移所有下级组织单元，才能删除小组群
- **软删除**：系统采用软删除机制，禁用而非物理删除

#### 4.4 权限规则

- **机构管理员**：只能管理本机构下的小组群
- **小组群管理员**：只能管理本小组群的信息
- **数据隔离**：不同甲方的数据完全隔离，无法跨甲方查看或操作

#### 4.5 账号管理规则

- **账号创建**：
  - 创建小组群时，必须同时创建小组群管理员账号，密码和确认密码为必填项
- **密码规则**：
  - 最少6位字符
  - 密码和确认密码必须一致
  - 建议包含字母和数字
  - 支持管理员重置密码
- **账号唯一性**：登录账号在系统内唯一，不能重复
- **手机号字段**：所有管理员角色均不包含手机号字段

#### 4.6 编码规范

**编码前缀规则**

- **小组群编码**：必须以"甲方编码-"开头，后接自定义部分（如：`TENA-GROUP01`）
- **小组群管理员登录ID**：必须以"甲方编码-"开头（如：`TENA-spv01`）

**编码示例**

假设甲方编码为 `ABC`，则小组群编码示例：

```
甲方: ABC
  └── 机构: ABC-AG001
      ├── 小组群: ABC-GP001 (一组群)
      │   └── 管理员: ABC-spv001
      └── 小组群: ABC-GP002 (二组群)
          └── 管理员: ABC-spv002
```

**系统实现**

- **前端自动填充**：在创建表单中，小组群编码和管理员登录ID字段默认自动填入"甲方编码-"前缀
- **后端验证**：创建时验证编码格式是否符合规范，不符合则拒绝创建
- **编码唯一性**：在符合前缀规范的基础上，确保编码在对应范围内唯一

#### 4.7 范围边界

**本次需求范围内：**
- 小组群的创建、编辑、查询、启用/禁用、删除
- 小组群的统计信息展示
- 基本的权限控制（基于角色的数据隔离）
- 编码规范的系统实现和验证

**本次需求范围外：**
- 小组群的批量导入/导出（后续需求）
- 小组群的历史记录和审计日志（后续需求）

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据隐私保护

- **敏感信息加密**：密码必须加密存储，使用安全的哈希算法（如BCrypt）
- **数据脱敏**：在日志和监控中，敏感信息（如密码）需要脱敏处理
- **访问控制**：只有授权用户才能查看和管理小组群信息

#### 5.2 账号安全

- **密码策略**：强制要求密码符合安全策略，支持密码强度验证
- **登录审计**：记录所有账号的登录时间、IP地址等信息
- **账号锁定**：支持账号锁定机制，防止暴力破解

#### 5.3 操作审计

- **操作日志**：记录所有小组群的创建、编辑、启用/禁用、删除操作
- **操作人记录**：记录每次操作的执行人、时间、操作内容
- **数据变更历史**：保留关键字段的变更历史（如小组群名称）

#### 5.4 数据备份与恢复

- **数据备份**：定期备份小组群数据，确保数据安全
- **数据恢复**：支持从备份恢复数据，支持误操作的快速回滚

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**无**：小组群管理功能不涉及资金流转，本节不适用。

### 7. 数据字段与口径（Data Definition）

#### 7.1 小组群（TeamGroup）核心字段

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| id | BigInteger | 主键 | 系统生成 | 不变 |
| tenant_id | BigInteger | 所属甲方ID | 关联选择 | 创建时设置 |
| agency_id | BigInteger | 所属机构ID | 关联选择 | 创建时设置，不可修改 |
| group_code | String(100) | 小组群编码（唯一） | 用户输入 | 创建时设置，不可修改 |
| group_name | String(200) | 小组群名称 | 用户输入 | 可编辑 |
| group_name_en | String(200) | 小组群名称（英文） | 用户输入 | 可编辑 |
| admin_id | BigInteger | 小组群管理员ID | 关联选择 | 可编辑 |
| description | Text | 小组群描述 | 用户输入 | 可编辑 |
| sort_order | Integer | 排序顺序 | 用户设置 | 可编辑 |
| is_active | Boolean | 是否启用 | 系统设置 | 可编辑 |
| created_at | DateTime | 创建时间 | 系统生成 | 自动 |
| updated_at | DateTime | 更新时间 | 系统生成 | 自动 |

**统计字段（实时计算）：**
- team_count：小组数量（统计该小组群下所有小组）
- collector_count：催员数量（统计该小组群下所有催员）

#### 7.2 小组群管理员（TeamGroupAdmin）核心字段

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| id | BigInteger | 主键ID | 系统生成 | 不变 |
| tenant_id | BigInteger | 所属甲方ID | 关联选择 | 创建时设置 |
| agency_id | BigInteger | 所属机构ID | 关联选择 | 创建时设置 |
| team_group_id | BigInteger | 所属小组群ID | 关联选择 | 创建时设置 |
| account_code | String(100) | 账号编码（唯一） | 系统生成 | 创建时设置，不可修改 |
| account_name | String(200) | 账号名称（管理员姓名） | 用户输入 | 可编辑 |
| login_id | String(100) | 登录ID（唯一） | 用户输入 | 创建时设置，不可修改 |
| password_hash | String(255) | 密码哈希（BCrypt加密） | 系统生成 | 可编辑（重置密码） |
| role | String(50) | 角色（spv） | 系统设置 | 不可修改 |
| email | String(100) | 邮箱 | 用户输入 | 可编辑 |
| remark | Text | 备注 | 用户输入 | 可编辑 |
| is_active | Boolean | 是否启用 | 系统设置 | 可编辑 |
| last_login_at | DateTime | 最近登录时间 | 系统更新 | 登录时更新 |
| created_at | DateTime | 创建时间 | 系统生成 | 自动 |
| updated_at | DateTime | 更新时间 | 系统生成 | 自动 |

**说明**：小组群管理员（SPV）在创建小组群时同时创建，密码和确认密码为必填项，不包含手机号字段。

#### 7.3 统计口径说明

- **小组数量**：统计指定小组群下直接关联的小组数量
- **催员数量**：统计指定小组群下所有催员数量（包括所有小组的催员）
- **统计更新频率**：实时计算，每次查询时重新统计
- **统计范围**：只统计启用状态的组织单元和催员

### 8. 交互与信息展示（UX & UI Brief）

本项目前端交互已由 Web 团队实现，本节仅补充关键信息展示要求：

#### 8.1 小组群管理页面

- **列表展示**：小组群编码、名称、所属机构、管理员、小组数量、催员数量、状态、操作
- **筛选功能**：按甲方、机构筛选
- **操作按钮**：创建小组群、编辑、启用/禁用、删除
- **创建表单**：
  - 必须同时填写小组群信息和管理员信息（包括密码和确认密码）
  - 小组群编码和管理员登录ID自动填充"甲方编码-"前缀，用户补充后续部分

#### 8.2 通用交互要求

- **状态提示**：启用/禁用操作前显示确认提示，说明级联影响
- **统计信息**：实时显示统计信息，支持点击查看详情
- **删除确认**：删除前显示确认提示，警告数据不可恢复

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 功能开关

| 开关名称 | 说明 | 默认状态 | 影响范围 |
|--------|------|----------|----------|
| 小组群功能开关 | 是否启用小组群功能 | 开启 | 全局 |

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 创建小组群时 | 小组群创建埋点 | team_group_created | user_id、team_group_id（小组群ID）、agency_id、group_code（小组群编码） |
| 编辑小组群时 | 小组群编辑埋点 | team_group_updated | user_id、team_group_id、changed_fields |
| 启用/禁用小组群时 | 小组群状态变更埋点 | team_group_status_changed | user_id、team_group_id、old_status、new_status |
| 删除小组群时 | 小组群删除埋点 | team_group_deleted | user_id、team_group_id |
| 查看小组群列表时 | 小组群列表查看埋点 | team_group_list_viewed | user_id、filter_params（筛选参数） |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     前端管理控台                              │
│  ┌──────────┐                                               │
│  │ 小组群管理 │                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Java后端服务 (Spring Boot)                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           小组群管理模块 (TeamGroup Module)           │  │
│  │  ┌──────────┐                                       │  │
│  │  │ 小组群服务 │                                       │  │
│  │  └──────────┘                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ MyBatis-Plus
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      MySQL数据库                              │
│  ┌──────────┐                                               │
│  │team_groups│                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
```

#### 1.2 模块职责边界

**前端模块：**
- **小组群管理页面**：提供用户界面，处理用户交互，调用后端API
- **权限控制**：根据用户角色显示/隐藏功能按钮

**后端模块：**
- **小组群服务层**：处理业务逻辑，包括创建、编辑、查询、启用/禁用、删除等操作
- **数据访问层**：使用MyBatis-Plus进行数据库操作

**数据库层：**
- **小组群表**：存储小组群数据

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 小组群管理接口

**基础路径**: `/api/v1/team-groups`

| 方法 | 路径 | 说明 | 主要入参 | 主要出参 | 超时/重试 | 幂等性 |
|------|------|------|---------|---------|----------|--------|
| GET | `/` | 获取小组群列表 | tenant_id（必填）、agency_id（必填）、is_active（可选）、skip、limit | 小组群列表（含统计信息） | 3s/不重试 | 是 |
| POST | `/` | 创建小组群（同时创建管理员） | tenant_id、agency_id、group_code、group_name、admin_info（包含password、confirm_password） | 创建的小组群信息 | 5s/不重试 | 是（基于group_code） |
| GET | `/{team_group_id}` | 获取小组群详情 | team_group_id | 小组群详情 | 3s/不重试 | 是 |
| PUT | `/{team_group_id}` | 更新小组群 | team_group_id、更新字段 | 更新后的小组群信息 | 5s/不重试 | 是 |
| PUT | `/{team_group_id}/status` | 启用/禁用小组群 | team_group_id、is_active | 操作结果 | 3s/不重试 | 是 |
| DELETE | `/{team_group_id}` | 删除小组群 | team_group_id | 操作结果 | 5s/不重试 | 是（需先移除关联小组） |
| GET | `/{team_group_id}/teams` | 获取小组群下的小组 | team_group_id | 小组列表 | 3s/不重试 | 是 |
| GET | `/{team_group_id}/statistics` | 获取小组群统计信息 | team_group_id | 统计信息 | 3s/不重试 | 是 |

**请求示例（创建小组群）：**
```json
{
  "tenant_id": 1,
  "agency_id": 1001,
  "group_code": "ABC-GP001",
  "group_name": "一组群",
  "description": "负责A区域催收业务",
  "admin_info": {
    "username": "ABC-spv001",
    "name": "小组群长",
    "email": "spv001@example.com",
    "password": "password123",
    "confirm_password": "password123"
  }
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "tenant_id": 1,
    "agency_id": 1001,
    "group_code": "ABC-GP001",
    "group_name": "一组群",
    "description": "负责A区域催收业务",
    "team_count": 0,
    "collector_count": 0,
    "is_active": true,
    "created_at": "2025-01-11T10:00:00",
    "updated_at": "2025-01-11T10:00:00"
  }
}
```

#### 2.2 接口通用规范

**请求头：**
- `Content-Type: application/json`
- `Authorization: Bearer {token}`（需要认证的接口）

**响应格式：**
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

**错误响应：**
```json
{
  "code": 400,
  "message": "错误描述",
  "data": null
}
```

#### 2.3 系统依赖

**内部依赖：**
- 权限管理模块：验证用户权限，实现数据隔离
- 账号管理模块：管理小组群管理员账号
- 机构管理模块：获取机构信息

**外部依赖：**
- 无外部系统依赖

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据库表结构

**3.1.1 team_groups表（小组群表）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| tenant_id | BIGINT | NOT NULL, FOREIGN KEY | 所属甲方ID |
| agency_id | BIGINT | NOT NULL, FOREIGN KEY | 所属机构ID |
| group_code | VARCHAR(100) | NOT NULL | 小组群编码 |
| group_name | VARCHAR(200) | NOT NULL | 小组群名称 |
| group_name_en | VARCHAR(200) | NULL | 小组群名称（英文） |
| admin_id | BIGINT | NULL, FOREIGN KEY | 小组群管理员ID |
| description | TEXT | NULL | 小组群描述 |
| sort_order | INT | DEFAULT 0 | 排序顺序 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_agency_group_code` (`agency_id`, `group_code`)
- KEY: `idx_tenant_id` (`tenant_id`)
- KEY: `idx_agency_id` (`agency_id`)
- KEY: `idx_is_active` (`is_active`)
- FOREIGN KEY: `fk_team_group_tenant` (`tenant_id`) REFERENCES `tenants` (`tenant_id`)
- FOREIGN KEY: `fk_team_group_agency` (`agency_id`) REFERENCES `collection_agencies` (`agency_id`)

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| QPS | 1000+ | 单个接口的每秒查询数 |
| 响应时间 | < 200ms（查询）< 500ms（创建/更新） | P95响应时间 |

#### 4.2 可用性要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| SLA | 99.9% | 系统可用性目标 |

#### 4.3 安全要求

| 要求 | 说明 |
|------|------|
| 加密存储 | 密码使用BCrypt加密存储 |
| 接口鉴权 | 所有接口需要JWT Token认证 |
| 数据隔离 | 基于tenant_id实现数据隔离 |

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 记录内容 | 日志级别 |
|---------|---------|---------|
| 请求日志 | 请求URL、方法、参数、响应时间、响应状态 | INFO |
| 操作日志 | 操作类型、操作人、操作对象、操作结果 | INFO |
| 错误日志 | 错误类型、错误信息、堆栈信息、请求参数 | ERROR |

**日志格式示例：**
```
[2025-01-11 10:00:00] [INFO] [TeamGroupService] 创建小组群成功: team_group_id=1, agency_id=1001, operator=agadmin001
[2025-01-11 10:00:01] [ERROR] [TeamGroupService] 创建小组群失败: agency_id=1001, error=小组群编码已存在, operator=agadmin001
```

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 关键验收标准

1. **功能完整性**
   - ✅ 能够创建、编辑、查询、启用/禁用、删除小组群
   - ✅ 能够正确显示小组群的统计信息（小组数量、催员数量）

2. **数据一致性**
   - ✅ 小组群编码唯一性验证正确
   - ✅ 启用/禁用操作能够正确级联影响下级组织单元
   - ✅ 统计信息实时准确，与实际情况一致

3. **权限控制**
   - ✅ 机构管理员只能管理本机构下的小组群
   - ✅ 数据隔离正确，不同甲方的数据完全隔离

4. **性能要求**
   - ✅ 查询接口响应时间 < 200ms（P95）
   - ✅ 创建/更新接口响应时间 < 500ms（P95）

5. **安全性**
   - ✅ 密码加密存储，无法明文查看
   - ✅ 接口需要认证，未授权访问被拒绝

---

## 附录

### A. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 小组群 | TeamGroup | 小组的集合，属于机构 |
| 小组群管理员 | TeamGroupAdmin/SPV | 小组群长，管理多个小组 |

### B. 参考文档

- [组织架构管理PRD](./组织架构管理PRD.md)
- [机构管理PRD](./机构管理PRD.md)

### C. 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2025-12-04 | 产品团队 | 从组织架构管理PRD拆分 |

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-12-04  
**审核状态：** 待审核



















