# 机构管理PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

随着催收业务规模的扩大和复杂度的提升，需要建立清晰、灵活的组织架构管理体系。机构作为组织架构的第二层级，承担着催收业务的核心管理职能。本需求旨在构建机构管理功能，支持机构的创建、编辑、启用/禁用等全生命周期管理，并支持机构级别的业务规则配置（如作息时间），为后续的案件分配、业绩统计、权限管理等核心功能提供基础支撑。预期通过本功能提升组织管理效率30%以上，减少因组织架构不清晰导致的案件分配错误率，并为精细化运营提供数据基础。

### 2. 业务场景与用户画像（Business Scenario & User）

**典型使用场景：**

1. **机构创建场景**：甲方管理员创建催收机构，并创建机构管理员账号。

2. **日常管理场景**：甲方管理员查看和管理本甲方下的所有机构；机构管理员查看和管理本机构下的所有小组群、小组和催员。

3. **业务配置场景**：机构管理员配置机构的作息时间，用于质检、通知等环节的时间控制；系统根据机构作息时间判断是否在营业时间内，决定是否发送通知、是否进行质检等。

4. **组织调整场景**：因业务调整需要禁用某个机构，系统会级联影响其下所有小组群、小组和催员。

**主要用户类型：**

- **甲方管理员（TenantAdmin）**：甲方级别的管理员，负责管理本甲方的所有催收机构，创建机构和机构管理员账号。
- **机构管理员（AgencyAdmin）**：机构级别的管理员，负责管理本机构下的所有小组群、小组和催员，配置机构的作息时间等业务规则。

**核心诉求：**

- 能够清晰地查看和管理机构信息
- 能够快速创建和配置机构
- 能够灵活调整机构状态（启用/禁用）
- 能够配置机构级别的业务规则（如作息时间）
- 能够查看机构的统计信息（小组数量、催员数量等）

### 3. 关键业务流程（Business Flow）

#### 3.1 机构创建流程

```mermaid
[甲方管理员登录]
    ↓ 创建机构
[催收机构] + [机构管理员账号]
    ↓ 机构管理员登录
[管理本机构下的组织架构]
```

**详细步骤：**

1. **创建机构**（甲方管理员操作）
   - 选择所属甲方（通常为当前登录用户的甲方）
   - 输入机构信息：机构编码（自动填充"甲方编码-"前缀）、机构名称、机构类型（必填）、时区（必填）、联系方式
   - 输入机构管理员信息：账号名、登录ID（自动填充"甲方编码-"前缀）、邮箱、密码、确认密码（必填）
   - 系统同时创建机构记录和机构管理员账号
   - 机构管理员收到账号信息

2. **配置机构作息时间**（机构管理员操作）
   - 进入机构管理页面
   - 选择目标机构，点击"配置作息时间"
   - 设置工作日、工作时间段（如：周一至周五 09:00-18:00）
   - 可设置多个时间段（如：上午 09:00-12:00，下午 14:00-18:00）
   - 保存配置，系统应用于质检、通知等环节

#### 3.2 机构查询流程

```
[用户登录]
    ↓ 根据角色权限
[查看机构列表]
    ├── 甲方管理员：查看本甲方下所有机构
    └── 机构管理员：查看本机构信息
    ↓ 筛选和搜索
[展示列表]
    ├── 统计信息（小组数量、催员数量）
    ├── 状态信息（启用/禁用）
    └── 操作按钮（编辑、配置作息时间、启用/禁用）
```

#### 3.3 机构调整流程

```
[选择目标机构]
    ↓
[执行操作]
    ├── 编辑：修改基本信息
    ├── 配置作息时间：设置工作时间
    └── 启用/禁用：改变状态
    ↓
[系统验证]
    ├── 检查是否有下级组织单元
    └── 检查权限是否允许
    ↓
[执行操作并级联影响]
    └── 禁用机构 → 禁用其下所有小组群、小组、催员
```

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 机构基本规则

- **唯一性规则**：
  - 机构编码在系统内唯一（通过"甲方编码-"前缀保证）
- **必填字段**：
  - 机构：编码（含甲方前缀）、名称、所属甲方、机构类型、时区、管理员密码、管理员确认密码

#### 4.2 启用/禁用规则

- **禁用机构**：会级联禁用其下所有小组群、小组和催员，但不会删除数据
- **启用规则**：启用机构时，不会自动启用下级组织单元，需要手动启用

#### 4.3 删除规则

- **机构**：支持删除，但有以下限制：
  - 如果机构下有关联的小组、催员或案件，不允许删除
  - 必须先删除或转移所有下级组织单元，才能删除机构
- **软删除**：系统采用软删除机制，禁用而非物理删除

#### 4.4 机构作息时间规则

- **配置范围**：每个机构可以独立配置作息时间
- **时间格式**：支持设置工作日（周一至周日）和工作时间段（如 09:00-18:00）
- **多时间段**：支持设置多个时间段（如：上午 09:00-12:00，下午 14:00-18:00）
- **应用场景**：
  - 质检：只在营业时间内进行质检
  - 通知：只在营业时间内发送通知
  - 案件分配：优先在营业时间内分配案件
- **默认值**：如果机构未配置作息时间，使用系统默认值（周一至周五 09:00-18:00）

#### 4.5 权限规则

- **甲方管理员**：只能管理本甲方下的机构
- **机构管理员**：只能管理本机构的信息和配置
- **数据隔离**：不同甲方的数据完全隔离，无法跨甲方查看或操作

#### 4.6 账号管理规则

- **账号创建**：
  - 创建机构时，必须同时创建机构管理员账号，密码和确认密码为必填项
- **密码规则**：
  - 最少6位字符
  - 密码和确认密码必须一致
  - 建议包含字母和数字
  - 支持管理员重置密码
- **账号唯一性**：登录账号在系统内唯一，不能重复
- **手机号字段**：所有管理员角色均不包含手机号字段

#### 4.7 编码规范

**编码前缀规则**

- **机构编码**：必须以"甲方编码-"开头，后接自定义部分（如：`TENA-AGENCY01`）
- **机构管理员登录ID**：必须以"甲方编码-"开头（如：`TENA-agadmin01`）

**编码示例**

假设甲方编码为 `ABC`，则机构编码示例：

```
甲方: ABC
  ├── 机构: ABC-AG001 (北京机构)
  │   └── 管理员: ABC-agadmin001
  └── 机构: ABC-AG002 (上海机构)
      └── 管理员: ABC-agadmin002
```

**系统实现**

- **前端自动填充**：在创建表单中，机构编码和管理员登录ID字段默认自动填入"甲方编码-"前缀
- **后端验证**：创建时验证编码格式是否符合规范，不符合则拒绝创建
- **编码唯一性**：在符合前缀规范的基础上，确保编码在对应范围内唯一

#### 4.8 范围边界

**本次需求范围内：**
- 机构的创建、编辑、查询、启用/禁用、删除
- 机构作息时间的配置
- 机构的统计信息展示
- 基本的权限控制（基于角色的数据隔离）
- 编码规范的系统实现和验证

**本次需求范围外：**
- 机构的批量导入/导出（后续需求）
- 机构的历史记录和审计日志（后续需求）

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据隐私保护

- **敏感信息加密**：密码必须加密存储，使用安全的哈希算法（如BCrypt）
- **数据脱敏**：在日志和监控中，敏感信息（如密码）需要脱敏处理
- **访问控制**：只有授权用户才能查看和管理机构信息

#### 5.2 账号安全

- **密码策略**：强制要求密码符合安全策略，支持密码强度验证
- **登录审计**：记录所有账号的登录时间、IP地址等信息
- **账号锁定**：支持账号锁定机制，防止暴力破解

#### 5.3 操作审计

- **操作日志**：记录所有机构的创建、编辑、启用/禁用操作
- **操作人记录**：记录每次操作的执行人、时间、操作内容
- **数据变更历史**：保留关键字段的变更历史（如机构名称、作息时间）

#### 5.4 数据备份与恢复

- **数据备份**：定期备份机构数据，确保数据安全
- **数据恢复**：支持从备份恢复数据，支持误操作的快速回滚

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**无**：机构管理功能不涉及资金流转，本节不适用。

### 7. 数据字段与口径（Data Definition）

#### 7.1 机构（CollectionAgency）核心字段

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| agency_id | BigInteger | 机构ID（主键） | 系统生成 | 不变 |
| tenant_id | BigInteger | 所属甲方ID | 关联选择 | 创建时设置，不可修改 |
| agency_code | String(100) | 机构编码（唯一） | 用户输入 | 创建时设置，不可修改 |
| agency_name | String(200) | 机构名称 | 用户输入 | 可编辑 |
| agency_name_en | String(200) | 机构名称（英文） | 用户输入 | 可编辑 |
| timezone | Integer | 时区偏移量（必填） | 用户输入 | 可编辑 |
| contact_person | String(100) | 联系人 | 用户输入 | 可编辑 |
| contact_phone | String(50) | 联系电话 | 用户输入 | 可编辑 |
| contact_email | String(100) | 联系邮箱 | 用户输入 | 可编辑 |
| address | String(500) | 机构地址 | 用户输入 | 可编辑 |
| description | Text | 机构描述 | 用户输入 | 可编辑 |
| agency_type | String(20) | 机构类型（real/virtual，必填） | 用户选择 | 可编辑 |
| sort_order | Integer | 排序顺序 | 用户设置 | 可编辑 |
| is_active | Boolean | 是否启用 | 系统设置 | 可编辑 |
| created_at | DateTime | 创建时间 | 系统生成 | 自动 |
| updated_at | DateTime | 更新时间 | 系统生成 | 自动 |

**统计字段（实时计算）：**
- team_count：小组数量（统计该机构下所有小组）
- collector_count：催员数量（统计该机构下所有催员）

#### 7.2 机构管理员（AgencyAdmin）核心字段

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| id | BigInteger | 主键ID | 系统生成 | 不变 |
| tenant_id | BigInteger | 所属甲方ID | 关联选择 | 创建时设置 |
| agency_id | BigInteger | 所属机构ID | 关联选择 | 创建时设置 |
| account_code | String(100) | 账号编码（唯一） | 系统生成 | 创建时设置，不可修改 |
| account_name | String(200) | 账号名称（管理员姓名） | 用户输入 | 可编辑 |
| login_id | String(100) | 登录ID（唯一） | 用户输入 | 创建时设置，不可修改 |
| password_hash | String(255) | 密码哈希（BCrypt加密） | 系统生成 | 可编辑（重置密码） |
| role | String(50) | 角色（agency_admin） | 系统设置 | 不可修改 |
| email | String(100) | 邮箱 | 用户输入 | 可编辑 |
| remark | Text | 备注 | 用户输入 | 可编辑 |
| is_active | Boolean | 是否启用 | 系统设置 | 可编辑 |
| last_login_at | DateTime | 最近登录时间 | 系统更新 | 登录时更新 |
| created_at | DateTime | 创建时间 | 系统生成 | 自动 |
| updated_at | DateTime | 更新时间 | 系统生成 | 自动 |

**说明**：机构管理员在创建机构时同时创建，密码和确认密码为必填项，不包含手机号字段。

#### 7.3 机构作息时间（AgencyWorkingHours）核心字段

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| id | BigInteger | 主键 | 系统生成 | 不变 |
| agency_id | BigInteger | 机构ID | 关联选择 | 创建时设置 |
| day_of_week | Integer | 星期几（1-7，1=周一） | 用户选择 | 可编辑 |
| start_time | Time | 开始时间（HH:MM） | 用户输入 | 可编辑 |
| end_time | Time | 结束时间（HH:MM） | 用户输入 | 可编辑 |
| is_active | Boolean | 是否启用 | 系统设置 | 可编辑 |
| created_at | DateTime | 创建时间 | 系统生成 | 自动 |
| updated_at | DateTime | 更新时间 | 系统生成 | 自动 |

#### 7.4 统计口径说明

- **小组数量**：统计指定机构下直接关联的小组数量（不包括下级组织单元的小组）
- **催员数量**：统计指定机构下所有催员数量（包括所有下级组织单元的催员）
- **统计更新频率**：实时计算，每次查询时重新统计
- **统计范围**：只统计启用状态的组织单元和催员

### 8. 交互与信息展示（UX & UI Brief）

本项目前端交互已由 Web 团队实现，本节仅补充关键信息展示要求：

#### 8.1 机构管理页面

- **列表展示**：机构编码、名称、所属甲方、时区、管理员、小组数量、催员数量、状态、操作
- **筛选功能**：按甲方筛选
- **操作按钮**：创建机构、编辑、配置作息时间、启用/禁用
- **创建表单**：
  - 必须同时填写机构信息（包括机构类型、时区）和管理员信息（包括密码和确认密码）
  - 机构编码和管理员登录ID自动填充"甲方编码-"前缀，用户补充后续部分
- **作息时间配置**：弹窗展示，支持设置工作日和工作时间段

#### 8.2 通用交互要求

- **状态提示**：启用/禁用操作前显示确认提示，说明级联影响
- **统计信息**：实时显示统计信息，支持点击查看详情

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 系统级配置

| 配置项 | 说明 | 默认值 | 配置入口 | 变更流程 |
|--------|------|--------|----------|----------|
| 默认作息时间 | 机构未配置时的默认作息时间 | 周一至周五 09:00-18:00 | 系统配置 | 系统管理员修改 |

#### 9.2 机构级配置

| 配置项 | 说明 | 默认值 | 配置入口 | 变更流程 |
|--------|------|--------|----------|----------|
| 机构作息时间 | 机构的工作时间配置 | 使用系统默认值 | 机构管理页面 | 机构管理员修改 |
| 机构时区 | 机构的时区设置 | 继承甲方时区 | 机构编辑页面 | 机构管理员修改 |

#### 9.3 功能开关

| 开关名称 | 说明 | 默认状态 | 影响范围 |
|--------|------|----------|----------|
| 机构作息时间功能开关 | 是否启用机构作息时间功能 | 开启 | 全局 |

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 创建机构时 | 机构创建埋点 | agency_created | user_id、agency_id（机构ID）、tenant_id、agency_code（机构编码） |
| 编辑机构时 | 机构编辑埋点 | agency_updated | user_id、agency_id、changed_fields |
| 配置机构作息时间时 | 机构作息时间配置埋点 | agency_working_hours_configured | user_id、agency_id、working_hours（作息时间配置） |
| 启用/禁用机构时 | 机构状态变更埋点 | agency_status_changed | user_id、agency_id、old_status、new_status |
| 查看机构列表时 | 机构列表查看埋点 | agency_list_viewed | user_id、filter_params（筛选参数） |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     前端管理控台                              │
│  ┌──────────┐                                               │
│  │ 机构管理  │                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Java后端服务 (Spring Boot)                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           机构管理模块 (Agency Module)                │  │
│  │  ┌──────────┐                                       │  │
│  │  │ 机构服务  │                                       │  │
│  │  └──────────┘                                       │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           业务规则模块 (Business Rules Module)          │  │
│  │  - 机构作息时间管理                                    │  │
│  │  - 作息时间判断（用于质检、通知）                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ MyBatis-Plus
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      MySQL数据库                              │
│  ┌──────────┐  ┌──────────┐                                │
│  │agencies  │  │agency_   │                                │
│  │          │  │working_  │                                │
│  │          │  │hours     │                                │
│  └──────────┘  └──────────┘                                │
└─────────────────────────────────────────────────────────────┘
```

#### 1.2 模块职责边界

**前端模块：**
- **机构管理页面**：提供用户界面，处理用户交互，调用后端API
- **权限控制**：根据用户角色显示/隐藏功能按钮

**后端模块：**
- **机构服务层**：处理业务逻辑，包括创建、编辑、查询、启用/禁用等操作
- **数据访问层**：使用MyBatis-Plus进行数据库操作
- **业务规则层**：管理机构作息时间，提供作息时间判断服务

**数据库层：**
- **机构表**：存储机构数据
- **业务规则表**：存储机构作息时间等配置

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 机构管理接口

**基础路径**: `/api/v1/agencies`

| 方法 | 路径 | 说明 | 主要入参 | 主要出参 | 超时/重试 | 幂等性 |
|------|------|------|---------|---------|----------|--------|
| GET | `/` | 获取机构列表 | tenant_id（必填）、is_active（可选）、skip、limit | 机构列表（含统计信息） | 3s/不重试 | 是 |
| POST | `/` | 创建机构（同时创建管理员） | tenant_id、agency_code、agency_name、agency_type、timezone（必填）、admin_info（包含password、confirm_password） | 创建的机构信息 | 5s/不重试 | 是（基于agency_code） |
| GET | `/{agency_id}` | 获取机构详情 | agency_id | 机构详情 | 3s/不重试 | 是 |
| PUT | `/{agency_id}` | 更新机构 | agency_id、更新字段 | 更新后的机构信息 | 5s/不重试 | 是 |
| PUT | `/{agency_id}/status` | 启用/禁用机构 | agency_id、is_active | 操作结果 | 3s/不重试 | 是 |
| GET | `/{agency_id}/working-hours` | 获取机构作息时间 | agency_id | 作息时间配置 | 3s/不重试 | 是 |
| PUT | `/{agency_id}/working-hours` | 配置机构作息时间 | agency_id、working_hours | 操作结果 | 5s/不重试 | 是 |
| GET | `/{agency_id}/statistics` | 获取机构统计信息 | agency_id | 统计信息（小组数、催员数） | 3s/不重试 | 是 |

**请求示例（创建机构）：**
```json
{
  "tenant_id": 1,
  "agency_code": "ABC-AG001",
  "agency_name": "北京催收机构",
  "agency_type": "real",
  "timezone": 8,
  "contact_person": "张三",
  "contact_phone": "13800138000",
  "contact_email": "agency@example.com",
  "admin_info": {
    "username": "ABC-agadmin001",
    "name": "机构管理员",
    "email": "agadmin@example.com",
    "password": "password123",
    "confirm_password": "password123"
  }
}
```

**请求示例（配置机构作息时间）：**
```json
{
  "working_hours": [
    {
      "day_of_week": 1,
      "start_time": "09:00",
      "end_time": "12:00",
      "is_active": true
    },
    {
      "day_of_week": 1,
      "start_time": "14:00",
      "end_time": "18:00",
      "is_active": true
    },
    {
      "day_of_week": 2,
      "start_time": "09:00",
      "end_time": "18:00",
      "is_active": true
    }
  ]
}
```

#### 2.2 业务规则接口

**基础路径**: `/api/v1/business-rules`

| 方法 | 路径 | 说明 | 主要入参 | 主要出参 | 超时/重试 | 幂等性 |
|------|------|------|---------|---------|----------|--------|
| GET | `/working-hours/check` | 检查是否在营业时间内 | agency_id、datetime | 是否在营业时间内 | 1s/不重试 | 是 |

#### 2.3 接口通用规范

**请求头：**
- `Content-Type: application/json`
- `Authorization: Bearer {token}`（需要认证的接口）

**响应格式：**
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

**错误响应：**
```json
{
  "code": 400,
  "message": "错误描述",
  "data": null
}
```

#### 2.4 系统依赖

**内部依赖：**
- 权限管理模块：验证用户权限，实现数据隔离
- 账号管理模块：管理机构管理员账号
- 甲方管理模块：获取甲方信息

**外部依赖：**
- 无外部系统依赖

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据库表结构

**3.1.1 collection_agencies表（机构表）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| agency_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 机构ID |
| tenant_id | BIGINT | NOT NULL, FOREIGN KEY | 所属甲方ID |
| agency_code | VARCHAR(100) | NOT NULL | 机构编码 |
| agency_name | VARCHAR(200) | NOT NULL | 机构名称 |
| agency_type | VARCHAR(20) | NOT NULL | 机构类型（real/virtual） |
| admin_id | BIGINT | NULL, FOREIGN KEY | 机构管理员ID |
| contact_phone | VARCHAR(50) | NULL | 联系电话 |
| contact_email | VARCHAR(100) | NULL | 联系邮箱 |
| timezone | INT | NOT NULL | 时区偏移量 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY: `agency_id`
- UNIQUE KEY: `uk_tenant_agency_code` (`tenant_id`, `agency_code`)
- KEY: `idx_tenant_id` (`tenant_id`)
- KEY: `idx_is_active` (`is_active`)
- FOREIGN KEY: `fk_agency_tenant` (`tenant_id`) REFERENCES `tenants` (`tenant_id`)

**3.1.2 agency_working_hours表（机构作息时间表）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 主键ID |
| agency_id | BIGINT | NOT NULL, FOREIGN KEY | 机构ID |
| day_of_week | TINYINT | NOT NULL | 星期几（1-7，1=周一） |
| start_time | TIME | NOT NULL | 开始时间 |
| end_time | TIME | NOT NULL | 结束时间 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- KEY: `idx_agency_id` (`agency_id`)
- KEY: `idx_agency_day` (`agency_id`, `day_of_week`)
- FOREIGN KEY: `fk_working_hours_agency` (`agency_id`) REFERENCES `collection_agencies` (`agency_id`)

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| QPS | 1000+ | 单个接口的每秒查询数 |
| 响应时间 | < 200ms（查询）< 500ms（创建/更新） | P95响应时间 |
| 数据库查询 | < 100ms | 单次数据库查询时间 |

#### 4.2 可用性要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| SLA | 99.9% | 系统可用性目标 |
| 降级策略 | 查询接口降级为缓存数据 | 当数据库不可用时 |

#### 4.3 安全要求

| 要求 | 说明 |
|------|------|
| 加密存储 | 密码使用BCrypt加密存储 |
| 接口鉴权 | 所有接口需要JWT Token认证 |
| 数据隔离 | 基于tenant_id实现数据隔离 |

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 记录内容 | 日志级别 |
|---------|---------|---------|
| 请求日志 | 请求URL、方法、参数、响应时间、响应状态 | INFO |
| 操作日志 | 操作类型、操作人、操作对象、操作结果 | INFO |
| 错误日志 | 错误类型、错误信息、堆栈信息、请求参数 | ERROR |

**日志格式示例：**
```
[2025-01-11 10:00:00] [INFO] [AgencyService] 创建机构成功: agency_id=1001, tenant_id=1, operator=admin001
[2025-01-11 10:00:01] [ERROR] [AgencyService] 创建机构失败: tenant_id=1, error=机构编码已存在, operator=admin001
```

#### 5.2 监控指标

| 指标名称 | 指标类型 | 告警阈值 | 说明 |
|---------|---------|---------|------|
| 接口成功率 | 成功率 | < 99% | 接口调用成功率 |
| 接口响应时间 | 响应时间 | P95 > 500ms | 接口响应时间 |
| 错误率 | 错误率 | > 1% | 接口错误率 |

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 关键验收标准

1. **功能完整性**
   - ✅ 能够创建、编辑、查询、启用/禁用机构
   - ✅ 能够配置机构作息时间，并正确应用于质检、通知等环节
   - ✅ 能够正确显示机构的统计信息（小组数量、催员数量）

2. **数据一致性**
   - ✅ 机构编码唯一性验证正确
   - ✅ 启用/禁用操作能够正确级联影响下级组织单元
   - ✅ 统计信息实时准确，与实际情况一致

3. **权限控制**
   - ✅ 甲方管理员只能管理本甲方下的机构
   - ✅ 数据隔离正确，不同甲方的数据完全隔离

4. **性能要求**
   - ✅ 查询接口响应时间 < 200ms（P95）
   - ✅ 创建/更新接口响应时间 < 500ms（P95）

5. **安全性**
   - ✅ 密码加密存储，无法明文查看
   - ✅ 接口需要认证，未授权访问被拒绝

---

## 附录

### A. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 机构 | Agency | 催收机构，属于甲方 |
| 机构管理员 | AgencyAdmin | 机构级别的管理员账号 |
| 作息时间 | Working Hours | 机构的工作时间配置 |

### B. 参考文档

- [组织架构管理PRD](./组织架构管理PRD.md)
- [甲方管理PRD](./甲方管理PRD.md)

### C. 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2025-12-04 | 产品团队 | 从组织架构管理PRD拆分 |

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-12-04  
**审核状态：** 待审核

