# 小组管理PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

小组是催收业务的基本执行单元，每个小组由若干催员组成，由小组组长带领完成催收任务。本需求旨在构建小组管理功能，支持小组的创建、编辑、启用/禁用等全生命周期管理，为后续的案件分配、业绩统计等功能提供基础支撑。

### 2. 业务场景与用户画像（Business Scenario & User）

**典型使用场景：**

1. **小组创建场景**：机构管理员创建催收小组，分配给小组群（可选）。

2. **日常管理场景**：机构管理员查看和管理本机构下的所有小组；小组管理员管理本小组的催员。

3. **小组调整场景**：调整小组的组长、小组群归属关系；因业务调整需要禁用某个小组，系统会级联影响其下所有催员。

**主要用户类型：**

- **机构管理员（AgencyAdmin）**：机构级别的管理员，负责管理本机构下的所有小组。
- **小组群管理员（SPV）**：小组群级别的管理员，负责管理本小组群下的所有小组。
- **小组管理员（TeamAdmin）**：小组级别的管理员，负责管理本小组下的催员。

**核心诉求：**

- 能够清晰地查看和管理小组信息
- 能够快速创建和配置小组
- 能够灵活调整小组状态（启用/禁用）
- 能够查看小组的统计信息（催员数量）

### 3. 关键业务流程（Business Flow）

#### 3.1 小组创建流程

```mermaid
[机构管理员登录]
    ↓ 创建小组
[催收小组]
    ↓ 分配小组组长
[小组开始运营]
```

**详细步骤：**

1. **创建小组**（机构管理员操作）
   - 选择所属甲方、机构和小组群（可选）
   - 输入小组信息：小组编码（自动填充"甲方编码-"前缀）、名称
   - 选择小组组长（从催员中选择，可选）
   - 系统创建小组记录

#### 3.2 小组查询流程

```
[用户登录]
    ↓ 根据角色权限
[查看小组列表]
    ├── 机构管理员：查看本机构下所有小组
    └── 小组群管理员：查看本小组群下所有小组
    ↓ 筛选和搜索
[展示列表]
    ├── 统计信息（催员数量）
    ├── 状态信息（启用/禁用）
    └── 操作按钮（编辑、启用/禁用）
```

#### 3.3 小组调整流程

```
[选择目标小组]
    ↓
[执行操作]
    ├── 编辑：修改基本信息、调整小组群归属
    └── 启用/禁用：改变状态
    ↓
[系统验证]
    ├── 检查是否有催员
    └── 检查权限是否允许
    ↓
[执行操作并级联影响]
    └── 禁用小组 → 禁用其下所有催员
```

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 小组基本规则

- **层级关系**：小组可以直接属于机构，也可以属于小组群
- **唯一性规则**：
  - 小组编码在系统内唯一（通过"甲方编码-"前缀保证）
- **必填字段**：
  - 小组：编码（含甲方前缀）、名称、所属机构

#### 4.2 启用/禁用规则

- **禁用小组**：会级联禁用其下所有催员，但不会删除数据
- **启用规则**：启用小组时，不会自动启用下级催员，需要手动启用

#### 4.3 删除规则

- **小组**：支持删除，但有以下限制：
  - 如果小组下有关联的催员或案件，不允许删除
  - 必须先删除或转移所有催员，才能删除小组
- **软删除**：系统采用软删除机制，禁用而非物理删除

#### 4.4 权限规则

- **机构管理员**：只能管理本机构下的小组
- **小组群管理员**：只能管理本小组群下的小组
- **小组管理员**：只能管理本小组的信息
- **数据隔离**：不同甲方的数据完全隔离，无法跨甲方查看或操作

#### 4.5 编码规范

**编码前缀规则**

- **小组编码**：必须以"甲方编码-"开头，后接自定义部分（如：`TENA-TEAM01`）

**编码示例**

假设甲方编码为 `ABC`，则小组编码示例：

```
甲方: ABC
  └── 机构: ABC-AG001
      └── 小组群: ABC-GP001
          ├── 小组: ABC-TM001 (第一小组)
          └── 小组: ABC-TM002 (第二小组)
```

**系统实现**

- **前端自动填充**：在创建表单中，小组编码字段默认自动填入"甲方编码-"前缀
- **后端验证**：创建时验证编码格式是否符合规范，不符合则拒绝创建
- **编码唯一性**：在符合前缀规范的基础上，确保编码在对应范围内唯一

#### 4.6 范围边界

**本次需求范围内：**
- 小组的创建、编辑、查询、启用/禁用
- 小组的统计信息展示
- 基本的权限控制（基于角色的数据隔离）
- 编码规范的系统实现和验证

**本次需求范围外：**
- 小组的批量导入/导出（后续需求）
- 小组的历史记录和审计日志（后续需求）
- 小组业绩统计（后续需求）

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据隐私保护

- **访问控制**：只有授权用户才能查看和管理小组信息

#### 5.2 操作审计

- **操作日志**：记录所有小组的创建、编辑、启用/禁用操作
- **操作人记录**：记录每次操作的执行人、时间、操作内容
- **数据变更历史**：保留关键字段的变更历史（如小组名称、组长）

#### 5.3 数据备份与恢复

- **数据备份**：定期备份小组数据，确保数据安全
- **数据恢复**：支持从备份恢复数据，支持误操作的快速回滚

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**无**：小组管理功能不涉及资金流转，本节不适用。

### 7. 数据字段与口径（Data Definition）

#### 7.1 小组（CollectionTeam）核心字段

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| team_id | BigInteger | 小组ID（主键） | 系统生成 | 不变 |
| tenant_id | BigInteger | 所属甲方ID | 关联选择 | 创建时设置 |
| agency_id | BigInteger | 所属机构ID | 关联选择 | 创建时设置，不可修改 |
| team_group_id | BigInteger | 所属小组群ID（可选） | 关联选择 | 可编辑 |
| team_code | String(100) | 小组编码（唯一） | 用户输入 | 创建时设置，不可修改 |
| team_name | String(200) | 小组名称 | 用户输入 | 可编辑 |
| team_name_en | String(200) | 小组名称（英文） | 用户输入 | 可编辑 |
| leader_id | BigInteger | 小组组长ID | 关联选择 | 可编辑 |
| target_performance | Decimal | 业绩目标 | 用户输入 | 可编辑 |
| description | Text | 小组描述 | 用户输入 | 可编辑 |
| sort_order | Integer | 排序顺序 | 用户设置 | 可编辑 |
| is_active | Boolean | 是否启用 | 系统设置 | 可编辑 |
| created_at | DateTime | 创建时间 | 系统生成 | 自动 |
| updated_at | DateTime | 更新时间 | 系统生成 | 自动 |

**统计字段（实时计算）：**
- collector_count：催员数量（统计该小组下所有催员）

#### 7.2 统计口径说明

- **催员数量**：统计指定小组下所有催员数量
- **统计更新频率**：实时计算，每次查询时重新统计
- **统计范围**：只统计启用状态的催员

### 8. 交互与信息展示（UX & UI Brief）

本项目前端交互已由 Web 团队实现，本节仅补充关键信息展示要求：

#### 8.1 小组管理页面

- **列表展示**：小组编码、名称、所属机构、所属小组群、组长、催员数量、状态、操作
- **筛选功能**：按甲方、机构、小组群筛选（三级联动）
- **操作按钮**：创建小组、编辑、启用/禁用
- **创建表单**：小组编码自动填充"甲方编码-"前缀，用户补充后续部分

#### 8.2 通用交互要求

- **级联筛选**：上级筛选条件变化时，自动更新下级筛选选项
- **状态提示**：启用/禁用操作前显示确认提示，说明级联影响
- **统计信息**：实时显示统计信息，支持点击查看详情

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 功能开关

| 开关名称 | 说明 | 默认状态 | 影响范围 |
|--------|------|----------|----------|
| 小组管理编辑开关 | 是否允许编辑小组 | 开启 | 全局 |

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 创建小组时 | 小组创建埋点 | team_created | user_id、team_id（小组ID）、agency_id、team_code（小组编码） |
| 编辑小组时 | 小组编辑埋点 | team_updated | user_id、team_id、changed_fields |
| 启用/禁用小组时 | 小组状态变更埋点 | team_status_changed | user_id、team_id、old_status、new_status |
| 查看小组列表时 | 小组列表查看埋点 | team_list_viewed | user_id、filter_params（筛选参数） |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     前端管理控台                              │
│  ┌──────────┐                                               │
│  │ 小组管理  │                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Java后端服务 (Spring Boot)                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           小组管理模块 (Team Module)                  │  │
│  │  ┌──────────┐                                       │  │
│  │  │ 小组服务  │                                       │  │
│  │  └──────────┘                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ MyBatis-Plus
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      MySQL数据库                              │
│  ┌──────────┐                                               │
│  │  teams   │                                               │
│  └──────────┘                                               │
└─────────────────────────────────────────────────────────────┘
```

#### 1.2 模块职责边界

**前端模块：**
- **小组管理页面**：提供用户界面，处理用户交互，调用后端API
- **权限控制**：根据用户角色显示/隐藏功能按钮

**后端模块：**
- **小组服务层**：处理业务逻辑，包括创建、编辑、查询、启用/禁用等操作
- **数据访问层**：使用MyBatis-Plus进行数据库操作

**数据库层：**
- **小组表**：存储小组数据

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 小组管理接口

**基础路径**: `/api/v1/teams`

| 方法 | 路径 | 说明 | 主要入参 | 主要出参 | 超时/重试 | 幂等性 |
|------|------|------|---------|---------|----------|--------|
| GET | `/` | 获取小组列表 | tenant_id（必填）、agency_id（必填）、team_group_id（可选）、is_active（可选）、skip、limit | 小组列表（含统计信息） | 3s/不重试 | 是 |
| POST | `/` | 创建小组 | tenant_id、agency_id、team_group_id（可选）、team_code、team_name、leader_id（可选） | 创建的小组信息 | 5s/不重试 | 是（基于team_code） |
| GET | `/{team_id}` | 获取小组详情 | team_id | 小组详情 | 3s/不重试 | 是 |
| PUT | `/{team_id}` | 更新小组 | team_id、更新字段 | 更新后的小组信息 | 5s/不重试 | 是 |
| PUT | `/{team_id}/status` | 启用/禁用小组 | team_id、is_active | 操作结果 | 3s/不重试 | 是 |
| GET | `/{team_id}/statistics` | 获取小组统计信息 | team_id | 统计信息（催员数） | 3s/不重试 | 是 |

**请求示例（创建小组）：**
```json
{
  "tenant_id": 1,
  "agency_id": 1001,
  "team_group_id": 1,
  "team_code": "ABC-TM001",
  "team_name": "第一小组",
  "leader_id": 5001,
  "target_performance": 1000000.00,
  "description": "负责A区域催收"
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "team_id": 1,
    "tenant_id": 1,
    "agency_id": 1001,
    "team_group_id": 1,
    "team_code": "ABC-TM001",
    "team_name": "第一小组",
    "leader_id": 5001,
    "collector_count": 5,
    "is_active": true,
    "created_at": "2025-01-11T10:00:00",
    "updated_at": "2025-01-11T10:00:00"
  }
}
```

#### 2.2 接口通用规范

**请求头：**
- `Content-Type: application/json`
- `Authorization: Bearer {token}`（需要认证的接口）

**响应格式：**
```json
{
  "code": 200,
  "message": "success",
  "data": { ... }
}
```

**错误响应：**
```json
{
  "code": 400,
  "message": "错误描述",
  "data": null
}
```

#### 2.3 系统依赖

**内部依赖：**
- 权限管理模块：验证用户权限，实现数据隔离
- 机构管理模块：获取机构信息
- 小组群管理模块：获取小组群信息
- 催员管理模块：获取催员信息

**外部依赖：**
- 无外部系统依赖

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据库表结构

**3.1.1 collection_teams表（小组表）**

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| team_id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 小组ID |
| tenant_id | BIGINT | NOT NULL, FOREIGN KEY | 所属甲方ID |
| agency_id | BIGINT | NOT NULL, FOREIGN KEY | 所属机构ID |
| team_group_id | BIGINT | NULL, FOREIGN KEY | 所属小组群ID（可选） |
| team_code | VARCHAR(100) | NOT NULL | 小组编码 |
| team_name | VARCHAR(200) | NOT NULL | 小组名称 |
| leader_id | BIGINT | NULL, FOREIGN KEY | 小组组长ID |
| target_performance | DECIMAL(10,2) | NULL | 业绩目标 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否启用 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY: `team_id`
- UNIQUE KEY: `uk_agency_team_code` (`agency_id`, `team_code`)
- KEY: `idx_tenant_id` (`tenant_id`)
- KEY: `idx_agency_id` (`agency_id`)
- KEY: `idx_team_group_id` (`team_group_id`)
- KEY: `idx_is_active` (`is_active`)
- FOREIGN KEY: `fk_team_tenant` (`tenant_id`) REFERENCES `tenants` (`tenant_id`)
- FOREIGN KEY: `fk_team_agency` (`agency_id`) REFERENCES `collection_agencies` (`agency_id`)
- FOREIGN KEY: `fk_team_group` (`team_group_id`) REFERENCES `team_groups` (`id`)

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| QPS | 1000+ | 单个接口的每秒查询数 |
| 响应时间 | < 200ms（查询）< 500ms（创建/更新） | P95响应时间 |

#### 4.2 可用性要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| SLA | 99.9% | 系统可用性目标 |

#### 4.3 安全要求

| 要求 | 说明 |
|------|------|
| 接口鉴权 | 所有接口需要JWT Token认证 |
| 数据隔离 | 基于tenant_id实现数据隔离 |

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 记录内容 | 日志级别 |
|---------|---------|---------|
| 请求日志 | 请求URL、方法、参数、响应时间、响应状态 | INFO |
| 操作日志 | 操作类型、操作人、操作对象、操作结果 | INFO |
| 错误日志 | 错误类型、错误信息、堆栈信息、请求参数 | ERROR |

**日志格式示例：**
```
[2025-01-11 10:00:00] [INFO] [TeamService] 创建小组成功: team_id=1, agency_id=1001, operator=agadmin001
[2025-01-11 10:00:01] [ERROR] [TeamService] 创建小组失败: agency_id=1001, error=小组编码已存在, operator=agadmin001
```

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 关键验收标准

1. **功能完整性**
   - ✅ 能够创建、编辑、查询、启用/禁用小组
   - ✅ 能够正确显示小组的统计信息（催员数量）

2. **数据一致性**
   - ✅ 小组编码唯一性验证正确
   - ✅ 启用/禁用操作能够正确级联影响下级催员
   - ✅ 统计信息实时准确，与实际情况一致

3. **权限控制**
   - ✅ 机构管理员只能管理本机构下的小组
   - ✅ 数据隔离正确，不同甲方的数据完全隔离

4. **性能要求**
   - ✅ 查询接口响应时间 < 200ms（P95）
   - ✅ 创建/更新接口响应时间 < 500ms（P95）

5. **安全性**
   - ✅ 接口需要认证，未授权访问被拒绝

---

## 附录

### A. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 小组 | Team | 催收小组，属于机构或小组群 |
| 小组组长 | Team Leader | 小组的领导者，通常是资深催员 |

### B. 参考文档

- [组织架构管理PRD](./组织架构管理PRD.md)
- [机构管理PRD](./机构管理PRD.md)
- [小组群管理PRD](./小组群管理PRD.md)

### C. 版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2025-12-04 | 产品团队 | 从组织架构管理PRD拆分 |

---

**文档状态：** ✅ 已完成  
**最后更新：** 2025-12-04  
**审核状态：** 待审核

