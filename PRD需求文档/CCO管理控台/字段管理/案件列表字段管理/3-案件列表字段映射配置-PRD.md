# 案件列表字段映射配置 PRD

## 版本记录

| 版本号 | 日期 | 作者 | 变更说明 |
|--------|------|------|---------|
| v2.0.0 | 2025-12-08 | 产品大象 | 新增快速开始章节、页面入口说明、完善版本管理 |
| v1.0.0 | 2025-12-07 | 产品大象 | 初始版本，包含智能匹配、手动映射、未使用字段处理 |

---

## 1. 背景与目标

### 1.1 业务背景
字段映射配置是CCO管理控台的核心功能，用于将甲方通过API推送或上传的字段与系统标准字段建立映射关系。不同甲方客户的字段命名和结构差异很大，系统需要支持灵活的字段映射机制，确保数据的一致性和可处理性。

### 1.2 核心目标
1. **统一数据标准**：将甲方多样化的字段映射到系统标准字段，确保数据处理逻辑统一
2. **灵活扩展**：对无法映射到标准字段的甲方特有字段，支持创建拓展字段
3. **版本控制**：支持甲方字段的多版本管理，可随时切换和对比
4. **自动匹配**：提供智能匹配算法，减少人工配置工作量
5. **完整留痕**：所有映射操作、版本变更都完整记录

### 1.3 业务痛点
- 不同甲方字段命名和结构差异大，需要灵活的映射机制
- 字段映射配置复杂，需要高效的匹配和配置工具
- 未映射字段可能导致数据丢失，需要强提醒机制
- 手动映射效率低，需要自动匹配建议功能
- 字段映射关系变更频繁，需要版本管理和变更追踪

### 1.4 预期指标
- 字段映射效率：单个字段映射完成时间 ≤ 30秒
- 自动匹配准确率：自动匹配建议准确率 ≥ 80%
- 字段映射覆盖率：必填字段映射覆盖率 = 100%
- 未映射字段处理率：未映射字段处理率 ≥ 95%
- 用户满意度：管理员对字段映射功能满意度 ≥ 90%

### 1.5 快速开始

**最小化配置流程**（5步快速上手）：

1. **准备数据**
   - 在"案件列表甲方字段查看"上传JSON文件
   - 系统自动设为当前生效版本

2. **点击智能匹配**
   - 一键获取AI推荐的映射关系
   - 勾选高置信度的建议（相似度≥80%）
   - 点击"确认选中项"批量应用

3. **手动补充未匹配字段**
   - 对未匹配的必填字段点击"选择映射"
   - 从下拉列表选择对应的甲方字段
   - 确认保存

4. **处理未使用字段**
   - 切换到"未使用的甲方字段"标签页
   - 选择"匹配到目标字段"或"设为拓展字段"
   - 完成所有字段的处理

5. **验证完成**
   - 检查必填字段覆盖率 = 100%
   - 配置自动生效，案件列表可正常展示

**预计耗时**：5-10分钟（取决于字段数量和匹配准确度）

**成功标志**：
- ✅ 所有必填字段已映射
- ✅ 无未处理的甲方字段警告
- ✅ 案件列表页面数据正常显示

---

## 2. 页面入口

### 2.1 页面路由与标题
- **路由**: `/field-config/mapping-list`
- **页面标题**: 案件列表字段映射配置
- **面包屑**: 字段管理 / 案件列表字段映射配置

### 2.2 菜单位置
- **一级菜单**: 字段管理
- **二级菜单**: 案件列表字段映射配置
- **菜单图标**: 🔗（映射关联）

### 2.3 访问权限
- **角色要求**: SuperAdmin / TenantAdmin
- **权限标识**: `field:mapping:view`
- **操作权限**:
  - 查看映射配置：`field:mapping:view`
  - 编辑映射配置：`field:mapping:edit`
  - 版本管理：`field:mapping:version`

### 2.4 页面适用场景
- **场景参数**: `scene=list`（案件列表场景）
- **甲方切换**: 通过页面顶部下拉选择器切换不同甲方
- **版本切换**: 通过版本管理查看和切换历史版本

---

## 3. 数据源说明

### 3.1 数据源构成

案件列表字段映射配置涉及**两个核心数据源**：

```text
字段映射数据源
│
├── 数据源1：标准字段（系统统一配置）
│   ├── 来源：系统内置，所有甲方继承
│   ├── 数量：15个必填字段
│   ├── 接口：GET /api/v1/standard-fields/case-list
│   ├── 特点：只读，不可编辑，不可删除
│   └── 用途：作为映射的"目标字段"
│
└── 数据源2：甲方字段（甲方上传的字段配置）
    ├── 来源：甲方上传JSON文件
    ├── 数量：可变（通常10-50个）
    ├── 接口：GET /api/v1/tenants/{tenantId}/fields-json?scene=list
    ├── 特点：支持多版本管理，可随时切换版本
    └── 用途：作为映射的"源字段"
```

### 3.2 标准字段详情

系统提供**15个标准字段**，所有甲方必须映射这些字段：

| 序号 | 字段标识 | 字段名称 | 数据类型 | 必填 | 说明 |
|------|----------|----------|----------|------|------|
| 1 | case_code | 案件编号 | String | ✓ | 案件唯一标识 |
| 2 | user_name | 客户姓名 | String | ✓ | 借款人姓名 |
| 3 | mobile_number | 手机号 | String | ✓ | 借款人联系电话 |
| 4 | loan_amount | 贷款金额 | Decimal | ✓ | 借款本金 |
| 5 | outstanding_amount | 未还金额 | Decimal | ✓ | 当前未还余额 |
| 6 | overdue_days | 逾期天数 | Integer | ✓ | 当前逾期天数 |
| 7 | case_status | 案件状态 | Enum | ✓ | 待分配/催收中/已完成等 |
| 8 | due_date | 到期日期 | Date | ✓ | 借款到期日 |
| 9 | total_installments | 期数 | Integer | ✓ | 总期数 |
| 10 | term_days | 当期天数 | Integer | ✓ | 当前期天数 |
| 11 | system_name | 所属系统 | String | ✓ | 业务系统名称 |
| 12 | product_name | 产品名称 | String | ✓ | 贷款产品 |
| 13 | app_name | APP名称 | String | ✓ | 应用名称 |
| 14 | merchant_name | 商户名称 | String | ✓ | 商户信息 |
| 15 | loan_id | 关联借款ID | String | ✓ | 关联主数据 |

**标准字段特性**：
- ✅ 来源：`system_unified`（系统统一配置）
- ✅ 所有甲方继承，不可覆盖
- ✅ 不支持新增、编辑、删除、排序
- ✅ 用于与甲方字段做映射匹配

### 3.3 甲方字段详情

甲方通过上传JSON文件配置字段，支持**多版本管理**：

#### 3.3.1 甲方字段上传方式
```text
上传入口
    ↓
字段管理 → 案件列表甲方字段查看 → [上传JSON文件]
    ↓
上传弹窗（显示当前版本信息 + 历史记录）
    ↓
选择JSON文件（拖拽或点击）
    ↓
验证JSON格式和内容
    ↓
保存文件并创建新版本
    ↓
自动设为当前生效版本
```

#### 3.3.2 版本管理机制

**版本号规则**：
- 按甲方维度自增：v1, v2, v3, ...
- 场景独立：案件列表和案件详情的版本号独立
- 示例：同一甲方，列表可能是v5，详情可能是v3

**版本状态**：
- **当前生效版本**（`is_active = true`）：用于字段映射的版本
- **历史版本**（`is_active = false`）：保留记录，可随时切换

**版本操作**：
- 查看任意版本详情
- 下载任意版本JSON文件
- 对比两个版本的差异
- 切换到历史版本
- 导出版本对比报告

#### 3.3.3 甲方字段JSON格式示例

```json
{
  "version": "1.0",
  "scene": "list",
  "tenant_id": "tenant_001",
  "tenant_name": "XX金融",
  "updated_at": "2025-12-08T10:00:00Z",
  "description": "案件列表字段配置",
  "fields": [
    {
      "field_name": "案件编号",
      "field_key": "CASE_ID",
      "field_type": "String",
      "enum_values": null,
      "is_required": true,
      "sort_order": 1,
      "description": "案件唯一标识"
    },
    {
      "field_name": "借款状态",
      "field_key": "LOAN_STATUS",
      "field_type": "Enum",
      "enum_values": ["正常", "逾期", "结清"],
      "is_required": true,
      "sort_order": 2,
      "description": "当前借款状态"
    },
    {
      "field_name": "客户等级",
      "field_key": "CUSTOMER_LEVEL",
      "field_type": "String",
      "enum_values": null,
      "is_required": false,
      "sort_order": 3,
      "description": "甲方特有字段：VIP/普通/黑名单"
    }
  ]
}
```

### 3.4 数据源选择逻辑

系统在进行字段映射时，自动选择**当前生效版本**的甲方字段：

```sql
-- 获取当前生效版本
SELECT * FROM tenant_field_uploads
WHERE tenant_id = ?
  AND scene = 'list'
  AND is_active = true
ORDER BY version DESC
LIMIT 1
```

**选择规则**：
1. 优先使用 `is_active = true` 的版本
2. 如果有多个（理论上不应该），取版本号最大的
3. 如果甲方未上传任何版本，使用标准字段作为兜底

---

## 3. 字段映射配置流程

### 3.1 映射配置总览

```text
字段映射配置流程
│
├── 步骤1：准备数据源
│   ├── 1.1 加载标准字段（15个）
│   └── 1.2 加载甲方当前生效版本字段
│
├── 步骤2：自动匹配（可选）
│   ├── 2.1 执行智能匹配算法
│   ├── 2.2 生成匹配建议
│   └── 2.3 管理员确认建议
│
├── 步骤3：手动映射
│   ├── 3.1 选择标准字段
│   ├── 3.2 选择甲方字段
│   ├── 3.3 配置枚举值映射（如果是Enum类型）
│   └── 3.4 保存映射关系
│
├── 步骤4：处理未映射字段
│   ├── 4.1 识别未使用的甲方字段
│   ├── 4.2 选择处理方式
│   │   ├── 方式A：映射到标准字段
│   │   └── 方式B：创建拓展字段
│   └── 4.3 保存处理结果
│
└── 步骤5：验证与发布
    ├── 5.1 检查必填字段映射覆盖率
    ├── 5.2 检查未映射字段数量
    └── 5.3 完成映射配置
```

### 3.2 步骤1：准备数据源

#### 3.2.1 加载标准字段

**入口**：字段管理 → 字段映射配置 → 选择甲方

**操作流程**：
```text
1. 管理员进入字段映射配置页面
   ↓
2. 选择要配置的甲方（必选）
   ↓
3. 系统自动加载15个标准字段
   接口：GET /api/v1/standard-fields/case-list
   ↓
4. 标准字段按分组展示（可折叠）
   - 基本信息组：案件编号、客户姓名、手机号等
   - 金额信息组：贷款金额、未还金额等
   - 状态信息组：案件状态、逾期天数等
   - 产品信息组：产品名称、APP名称等
```text

**标准字段加载结果示例**：

| 目标字段 | 字段标识 | 类型 | 必填 | 来源 | 匹配状态 |
|----------|----------|------|------|------|----------|
| 案件编号 | case_code | String | ✓ | 标准 | 未映射 |
| 客户姓名 | user_name | String | ✓ | 标准 | 未映射 |
| 手机号 | mobile_number | String | ✓ | 标准 | 未映射 |
| ... | ... | ... | ... | ... | ... |

#### 3.2.2 加载甲方字段

**操作流程**：
```text
1. 系统自动获取该甲方的当前生效版本
   接口：GET /api/v1/tenants/{tenantId}/fields-json?scene=list
   ↓
2. 解析JSON，提取fields数组
   ↓
3. 加载甲方字段列表（用于映射选择）
   ↓
4. 显示当前版本信息：
   - 版本号：v3
   - 上传时间：2025-12-07 15:30:00
   - 字段数：14个
   - 上传人：管理员
```text

**甲方字段下拉列表示例**：
```text
下拉选项（可搜索）
├── CASE_ID - 案件编号 (String)
├── CUSTOMER_NAME - 客户姓名 (String)
├── PHONE - 手机号 (String)
├── LOAN_AMT - 借款金额 (Number)
├── OVERDUE_DAYS - 逾期天数 (Integer)
├── CUSTOMER_LEVEL - 客户等级 (String) [甲方特有]
└── ... 更多字段
```

#### 3.2.3 版本切换（可选）

如果管理员需要使用其他版本的甲方字段：

```text
1. 点击页面右上角 [版本管理] 按钮
   ↓
2. 打开版本管理面板
   ↓
3. 查看历史版本列表：
   ● v3 - 2025-12-07 15:30:00（当前使用）14个字段
   ○ v2 - 2025-12-05 10:20:00  12个字段
   ○ v1 - 2025-12-01 09:00:00  10个字段
   ↓
4. 点击历史版本的 [设为当前版本] 按钮
   ↓
5. 确认切换
   ↓
6. 系统更新 is_active 标识
   ↓
7. 刷新页面，使用新版本进行映射
```

**版本切换确认弹窗**：
```text
┌─────────────────────────────────────┐
│  确认切换版本                        │
├─────────────────────────────────────┤
│  当前版本：v3（14个字段）             │
│  目标版本：v2（12个字段）             │
│                                      │
│  切换后，字段映射配置将使用v2的字段。 │
│                                      │
│  ⚠️ 注意：已配置的映射关系不会丢失，  │
│     但v3独有的字段将无法映射。        │
│                                      │
│      [取消]        [确认切换]        │
└─────────────────────────────────────┘
```

### 3.3 步骤2：自动匹配（推荐）

自动匹配功能可以大幅减少人工配置工作量。

#### 3.3.1 触发自动匹配

**入口**：字段映射配置页面 → [一键建议映射未匹配字段] 按钮

**操作流程**：
```text
1. 管理员点击 [一键建议映射未匹配字段] 按钮
   ↓
2. 系统调用自动匹配接口
   接口：POST /api/v1/tenants/{tenantId}/field-configs/auto-suggest
   ↓
3. 后端执行匹配算法（详见3.3.2）
   ↓
4. 返回匹配建议列表
   ↓
5. 前端显示匹配建议弹窗
```

#### 3.3.2 自动匹配算法

**匹配维度与权重**：

| 匹配维度 | 权重 | 说明 |
|----------|------|------|
| 字段名称完全匹配 | 100% | field_key完全相同（忽略大小写、下划线/中划线） |
| 字段名称包含匹配 | 80% | field_key包含关系 |
| 同义词匹配 | 70% | 预置同义词表匹配 |
| 编辑距离匹配 | 60-80% | 基于Levenshtein距离算法 |
| 字段类型匹配 | +10% | 类型完全匹配加分 |
| 字段类型兼容 | +5% | 类型兼容加分 |

**匹配示例**：

| 标准字段 | 甲方字段 | 匹配维度 | 相似度 | 结果 |
|----------|----------|----------|--------|------|
| case_code | CASE_ID | 同义词匹配 | 70% | 建议映射 |
| mobile_number | PHONE_NUMBER | 同义词匹配 | 70% | 建议映射 |
| loan_amount | LOAN_AMT | 编辑距离匹配 | 75% | 建议映射 |
| user_name | CUSTOMER_NAME | 同义词匹配 | 70% | 建议映射 |
| overdue_days | OVERDUE_DAYS | 完全匹配 | 100% | 自动映射 |

**匹配规则**：
- **相似度 ≥ 80%**：自动映射，直接保存
- **相似度 60-80%**：建议映射，需管理员确认
- **相似度 < 60%**：不建议映射，需手动配置

**同义词表（部分）**：
```json
{
  "case_code": ["CASE_ID", "CASE_NO", "案件编号", "LOAN_CASE_ID"],
  "mobile_number": ["PHONE", "PHONE_NUMBER", "MOBILE", "CELL_PHONE", "手机号"],
  "loan_amount": ["LOAN_AMT", "PRINCIPAL", "BORROW_AMT", "借款金额"],
  "user_name": ["CUSTOMER_NAME", "BORROWER_NAME", "USER", "客户姓名"],
  "overdue_days": ["OVERDUE_DAYS", "DPD", "DAYS_PAST_DUE", "逾期天数"]
}
```

#### 3.3.3 确认匹配建议

**匹配建议弹窗**：
```text
┌────────────────────────────────────────────────────────────┐
│  自动匹配建议 - 发现 12 个匹配建议                     [×]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  匹配摘要：                                                  │
│  ✅ 自动映射（相似度≥80%）：8个                              │
│  🔍 建议映射（相似度60-80%）：4个                            │
│  ❌ 未匹配：3个标准字段                                       │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  ✅ 自动映射（8个）                          [全部确认]     │
│  ┌──────────────────────────────────────────────┐         │
│  │ ☑ overdue_days → OVERDUE_DAYS (100%)          │         │
│  │   类型匹配：Integer ✓                          │         │
│  │                                                │         │
│  │ ☑ system_name → SYSTEM_NAME (100%)            │         │
│  │   类型匹配：String ✓                           │         │
│  │                                                │         │
│  │ ... 更多自动映射                                │         │
│  └──────────────────────────────────────────────┘         │
│                                                             │
│  🔍 建议映射（4个）                                          │
│  ┌──────────────────────────────────────────────┐         │
│  │ ☑ case_code → CASE_ID (70%)                   │         │
│  │   匹配方式：同义词匹配                          │         │
│  │   类型匹配：String ✓                           │         │
│  │   [修改] [取消]                                │         │
│  │                                                │         │
│  │ ☑ mobile_number → PHONE_NUMBER (70%)          │         │
│  │   匹配方式：同义词匹配                          │         │
│  │   类型匹配：String ✓                           │         │
│  │   [修改] [取消]                                │         │
│  │                                                │         │
│  │ ☑ loan_amount → LOAN_AMT (75%)                │         │
│  │   匹配方式：编辑距离匹配                        │         │
│  │   类型匹配：Decimal ✓                          │         │
│  │   [修改] [取消]                                │         │
│  │                                                │         │
│  │ ☐ user_name → CUSTOMER_NAME (70%)             │         │
│  │   匹配方式：同义词匹配                          │         │
│  │   类型匹配：String ✓                           │         │
│  │   [修改] [取消]                                │         │
│  └──────────────────────────────────────────────┘         │
│                                                             │
│  ❌ 未匹配的标准字段（3个）                                   │
│  ┌──────────────────────────────────────────────┐         │
│  │ • outstanding_amount (未还金额) - 必填         │         │
│  │ • due_date (到期日期) - 必填                   │         │
│  │ • total_installments (期数) - 必填             │         │
│  └──────────────────────────────────────────────┘         │
│                                                             │
│  ⚠️ 提示：未匹配的必填字段需要手动配置映射关系               │
│                                                             │
│              [取消]  [确认选中项]  [确认全部]               │
└────────────────────────────────────────────────────────────┘
```text

**操作说明**：
- **勾选/取消勾选**：选择要应用的映射建议
- **修改**：修改匹配的甲方字段
- **取消**：取消该条建议
- **确认选中项**：仅应用勾选的映射建议
- **确认全部**：应用所有勾选的映射建议

#### 3.3.4 批量确认映射

```text
1. 管理员勾选要确认的映射建议
   ↓
2. 点击 [确认选中项] 或 [确认全部]
   ↓
3. 系统调用批量确认接口
   接口：POST /api/v1/tenants/{tenantId}/field-configs/batch-confirm
   请求体：
   {
     "mappings": [
       {
         "field_key": "case_code",
         "tenant_field_key": "CASE_ID",
         "mapping_status": "auto_mapped"
       },
       ...
     ]
   }
   ↓
4. 后端保存映射关系到数据库
   ↓
5. 返回成功结果
   ↓
6. 前端刷新字段映射列表
   ↓
7. 显示成功提示："已成功映射 12 个字段"
```

### 3.4 步骤3：手动映射

对于自动匹配无法处理的字段，需要手动配置映射。

#### 3.4.1 手动选择甲方字段

**操作流程**：
```text
1. 在字段映射列表中找到未映射的标准字段
   ↓
2. 点击"甲方字段"下拉选择框
   ↓
3. 显示甲方字段列表（可搜索）
   ↓
4. 搜索或浏览选择合适的甲方字段
   ↓
5. 选择后自动保存映射关系
   接口：PUT /api/v1/tenants/{tenantId}/field-configs
   ↓
6. 更新映射状态为"手动映射"
   ↓
7. 刷新列表显示
```

**优化后的字段映射表格设计**：

**表格列设计**：

| 列名 | 说明 | 宽度 | 内容 |
|------|------|------|------|
| 序号 | 自动编号 | 60px | 1, 2, 3... |
| 标准字段 | 字段详情 | 250px | 字段名称（加粗）<br>字段Key（灰色小字）<br>类型标签 |
| 映射关系 | 图标标识 | 80px | ✓ 绿色（已映射）<br>✗ 灰色（未映射） |
| 甲方字段 | 字段详情 | 250px | 字段名称（加粗）<br>字段Key（灰色小字）<br>或"未映射"标签 |
| 映射状态 | 状态标签 | 120px | 自动匹配 🟢<br>手动映射 🔵<br>未映射 ⚪ |
| 操作 | 操作按钮 | 200px | 选择映射/重新映射<br>清除 |

**UI示例**：

```text
┌─────────────────────────────────────────────────────────────────────┐
│  字段映射配置 - XX金融                                               │
│                                                                      │
│  当前版本：v3 | 上传时间：2025-12-07 15:30:00 | 字段数：14个          │
│  [管理版本]                                                          │
│                                                                      │
│  ⚠️ 发现 3 个未使用的甲方字段，请尽快处理！ [立即处理]                │
│                                                                      │
│  [✨ 智能匹配建议]  [+ 添加映射]                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Tab: [匹配目标字段]  [拓展字段]  [未使用的甲方字段]                 │
│                                                                      │
│  ┌───┬──────────────┬────┬──────────────┬──────────┬─────────────┐ │
│  │序│  标准字段     │映射│  甲方字段     │  状态    │   操作      │ │
│  │号│              │关系│              │          │             │ │
│  ├───┼──────────────┼────┼──────────────┼──────────┼─────────────┤ │
│  │ 1 │ 案件编号      │ ✓ │ 案件编号      │🟢自动匹配│[重新映射]   │ │
│  │   │ case_code    │    │ CASE_ID      │          │[清除]       │ │
│  │   │ [String]     │    │              │          │             │ │
│  ├───┼──────────────┼────┼──────────────┼──────────┼─────────────┤ │
│  │ 2 │ 债务人姓名    │ ✓ │ 客户姓名      │🔵手动映射│[重新映射]   │ │
│  │   │ debtor_name  │    │ CUSTOMER_NAME│          │[清除]       │ │
│  │   │ [String]     │    │              │          │             │ │
│  ├───┼──────────────┼────┼──────────────┼──────────┼─────────────┤ │
│  │ 3 │ 逾期天数      │ ✗ │ 未映射        │⚪未映射  │[选择映射]   │ │
│  │   │ overdue_days │    │              │          │             │ │
│  │   │ [Integer]    │    │              │          │             │ │
│  └───┴──────────────┴────┴──────────────┴──────────┴─────────────┘ │
│                                                                      │
│  暂无数据时显示：                                                     │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                      暂无标准字段数据                            │ │
│  │                      [刷新数据]                                  │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**映射关系列图标说明**：
- ✓（绿色）：已建立映射关系
- ✗（灰色）：未建立映射关系

**映射状态标识**：
- 🟢 **自动匹配**：绿色标签 + 魔法棒图标，系统智能匹配生成
- 🔵 **手动映射**：蓝色标签 + 编辑图标，管理员手动配置
- ⚪ **未映射**：灰色标签，需要配置（必填字段会在整行高亮显示）

**操作按钮说明**：
- **选择映射**：未映射字段的操作，打开编辑映射对话框
- **重新映射**：已映射字段的操作，修改现有映射关系
- **清除**：删除已有的映射关系，字段恢复为未映射状态

#### 3.4.2 编辑映射对话框（重要）

**功能说明**：
编辑映射对话框是手动配置字段映射的核心功能，用于建立标准字段与甲方字段之间的映射关系。

**使用场景**：
- 为未映射的标准字段选择甲方字段
- 重新映射已有的字段关系
- 查看和修改字段映射详情

**对话框组成部分**：

1. **标准字段信息展示区**
   ```
   ┌────────────────────────────────────────┐
   │  标准字段信息                           │
   ├────────────────────────────────────────┤
   │  字段名称：案件编号                     │
   │  字段Key：case_code                    │
   │  字段类型：String                       │
   │  是否必填：✓ 必填                       │
   └────────────────────────────────────────┘
   ```

2. **甲方字段选择区**
   - 下拉列表展示所有可用甲方字段
   - 支持搜索和筛选
   - 显示字段名称、Key、类型标签
   - 示例：`案件编号 (CASE_ID) [String]`

3. **已选择字段信息区**（选择后显示）
   ```
   ┌────────────────────────────────────────┐
   │  已选择的甲方字段                       │
   ├────────────────────────────────────────┤
   │  字段名称：案件编号                     │
   │  字段Key：CASE_ID                      │
   │  字段类型：String                       │
   │  数据示例：CASE20251208001             │
   └────────────────────────────────────────┘
   ```

4. **智能检查提示区**
   - **类型兼容性检查**：
     ```
     ⚠️ 字段类型不匹配
     标准字段类型 (Decimal) 与甲方字段类型 (String) 不一致。
     这可能导致数据转换错误，请确认是否继续映射。
     ```

   - **枚举类型提示**：
     ```
     📋 枚举类型字段
     此字段为枚举类型，映射后需要进一步配置枚举值映射关系。
     ```

**操作流程**：
```text
点击"选择映射"或"重新映射"按钮
  ↓
打开编辑映射对话框
  ↓
查看标准字段详细信息
  ↓
从下拉列表选择甲方字段
  ↓
系统自动检查类型兼容性
  ↓
显示已选字段详情
  ↓
如有类型不匹配警告，确认是否继续
  ↓
点击"确认映射"保存
  ↓
调用API保存映射关系
  ↓
对话框关闭，刷新主列表
  ↓
如为枚举类型，提示需配置枚举值映射
```

**按钮说明**：
- **取消**：关闭对话框，不保存任何更改
- **确认映射**：保存映射关系，刷新列表

**API调用**：
```http
PUT /api/v1/tenants/{tenantId}/field-configs
{
  "field_key": "case_code",
  "tenant_field_key": "CASE_ID",
  "mapping_status": "manual_mapped"
}
```

#### 3.4.3 枚举值映射配置

对于枚举类型（Enum）字段，需要额外配置枚举值映射。

**触发条件**：
- 标准字段类型 = Enum
- 甲方字段类型 = Enum
- 两者的枚举值列表不完全一致

**操作流程**：
```text
1. 手动映射Enum类型字段后
   ↓
2. 点击"枚举值"列的 [配置] 按钮
   ↓
3. 打开枚举值映射配置弹窗
   ↓
4. 系统自动匹配枚举值（按value或label）
   ↓
5. 管理员调整未匹配的枚举值
   ↓
6. 保存枚举值映射关系
```

**枚举值映射配置弹窗**：
```text
┌────────────────────────────────────────────────────────────┐
│  枚举值映射配置 - 案件状态                             [×]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  标准字段：case_status（案件状态）                           │
│  甲方字段：LOAN_STATUS（借款状态）                           │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  标准枚举值                甲方枚举值                        │
│  ┌───────────────────┐  ┌───────────────────┐            │
│  │ ✓ 待分配           │→ │ 待分配             │  [已匹配]   │
│  │   (unassigned)    │  │ (pending)         │            │
│  └───────────────────┘  └───────────────────┘            │
│                                                             │
│  ┌───────────────────┐  ┌───────────────────┐            │
│  │ ✓ 催收中           │→ │ [选择甲方枚举值▼]  │  [未匹配]   │
│  │   (collecting)    │  │                   │            │
│  └───────────────────┘  └───────────────────┘            │
│       ↓ 可选择                                              │
│       • 正常                                                │
│       • 逾期                                                │
│       • 结清                                                │
│                                                             │
│  ┌───────────────────┐  ┌───────────────────┐            │
│  │ ✓ 已完成           │→ │ 结清               │  [已匹配]   │
│  │   (completed)     │  │ (settled)         │            │
│  └───────────────────┘  └───────────────────┘            │
│                                                             │
│  ┌───────────────────┐  ┌───────────────────┐            │
│  │ ✓ 已关闭           │→ │ [选择甲方枚举值▼]  │  [未匹配]   │
│  │   (closed)        │  │                   │            │
│  └───────────────────┘  └───────────────────┘            │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  未使用的甲方枚举值：                                         │
│  • 正常 (normal) - 未映射                                   │
│  • 逾期 (overdue) - 未映射                                  │
│                                                             │
│  ⚠️ 提示：所有标准枚举值必须映射到甲方枚举值                  │
│                                                             │
│                    [取消]  [保存]                           │
└────────────────────────────────────────────────────────────┘
```

**枚举值映射规则**：
- ✅ 每个标准枚举值必须映射到一个甲方枚举值
- ✅ 甲方枚举值可以不全部使用（允许有未映射的甲方枚举值）
- ✅ 一对一映射：一个标准枚举值只能映射一个甲方枚举值
- ✅ 自动匹配：按value或label进行初始匹配
- ✅ 手动调整：管理员可修改自动匹配结果

**保存格式**：
```json
{
  "field_key": "case_status",
  "tenant_field_key": "LOAN_STATUS",
  "enum_mapping": {
    "unassigned": "pending",
    "collecting": "overdue",
    "completed": "settled",
    "closed": "settled"
  }
}
```

**当前实现状态**：
- ✅ 枚举类型字段识别
- ✅ 枚举映射需求提示
- ⏳ 枚举值详细映射配置对话框（后续迭代实现）

**临时处理方式**：
当前版本在映射枚举类型字段时，会：
1. 在编辑映射对话框中显示"📋 枚举类型字段"提示
2. 映射成功后提示："枚举类型字段映射成功，请继续配置枚举值映射"
3. 管理员需知悉后续需手动配置枚举值对应关系（通过后续功能迭代）

### 3.5 步骤4：处理未映射字段

完成标准字段映射后，需要处理**未使用的甲方字段**。

#### 3.5.1 识别未使用字段

**未使用字段定义**：
```text
未使用的甲方字段 = 甲方全部字段 - 已映射到标准字段的字段 - 已创建拓展字段的字段
```

**检测逻辑**：
```sql
-- 1. 获取甲方当前版本的全部字段
SELECT field_key FROM tenant_field_uploads
WHERE tenant_id = ? AND scene = 'list' AND is_active = true

-- 2. 获取已映射的字段
SELECT tenant_field_key FROM tenant_field_configs
WHERE tenant_id = ? AND mapping_status IN ('auto_mapped', 'manual_mapped')

-- 3. 获取已创建拓展字段的字段
SELECT tenant_field_key FROM custom_fields
WHERE tenant_id = ? AND is_active = true

-- 4. 计算未使用字段（集合差）
未使用字段 = 甲方全部字段 - 已映射字段 - 拓展字段
```

#### 3.5.2 未使用字段提醒

在字段映射配置页面顶部显示红色警告：

```text
┌────────────────────────────────────────────────────────────┐
│  ⚠️ 警告：发现 3 个未使用的甲方字段，请尽快处理！              │
│                                                             │
│  未处理的字段可能导致数据丢失或无法正确展示。                  │
│  [查看详情]  [批量处理]                                      │
└────────────────────────────────────────────────────────────┘
```

#### 3.5.3 查看未使用字段

点击 [查看详情] 或切换到"未使用的甲方字段"Tab：

```text
┌────────────────────────────────────────────────────────────────────┐
│  未使用的甲方字段（3个）                                             │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  字段名称 | 字段标识 | 类型 | 枚举值 | 必填 | 更新时间 | 操作        │
│  ─────────────────────────────────────────────────────────────────│
│  客户等级  | CUSTOMER_LEVEL | String | - | - | 2025-12-07 | [处理] │
│                                                                     │
│  逾期等级  | OVERDUE_LEVEL | Enum | A/B/C | - | 2025-12-07 | [处理] │
│                                                                     │
│  备注信息  | REMARK | Text | - | - | 2025-12-07 | [处理]            │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

#### 3.5.4 处理未使用字段

点击 [处理] 按钮，打开处理弹窗：

```text
┌────────────────────────────────────────────────────────────┐
│  处理未使用字段 - CUSTOMER_LEVEL                       [×]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  字段信息：                                                  │
│  • 字段名称：客户等级                                        │
│  • 字段标识：CUSTOMER_LEVEL                                 │
│  • 字段类型：String                                         │
│  • 是否必填：否                                             │
│  • 说明：甲方特有字段，用于标识客户等级（VIP/普通/黑名单）   │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  请选择处理方式：                                            │
│                                                             │
│  ○ 方式一：匹配到目标字段（映射到标准字段）                   │
│     ┌──────────────────────────────────────────┐          │
│     │ 选择标准字段：[请选择 ▼]                  │          │
│     │                                            │          │
│     │ 可选标准字段：                              │          │
│     │ • case_code - 案件编号                     │          │
│     │ • user_name - 客户姓名                     │          │
│     │ • mobile_number - 手机号                   │          │
│     │ ... 更多未映射的标准字段                    │          │
│     └──────────────────────────────────────────┘          │
│                                                             │
│  ● 方式二：设为拓展字段（创建自定义字段）                     │
│     ┌──────────────────────────────────────────┐          │
│     │ 扩展字段别名：[customer_level__________]   │          │
│     │ (系统内部使用，只能包含小写字母、数字、下划线) │          │
│     │                                            │          │
│     │ 所属分组：[基本信息 ▼]                     │          │
│     │                                            │          │
│     │ 隐私标签：[公开 ▼]                         │          │
│     │ • PII（个人身份信息）                       │          │
│     │ • 敏感（敏感信息）                          │          │
│     │ • 公开（公开信息）                          │          │
│     │                                            │          │
│     │ 字段说明：                                  │          │
│     │ [甲方特有字段，标识客户等级_____________]   │          │
│     │                                            │          │
│     │ ☑ 是否必填                                 │          │
│     └──────────────────────────────────────────┘          │
│                                                             │
│                    [取消]  [保存]                           │
└────────────────────────────────────────────────────────────┘
```

**处理方式说明**：

**方式一：匹配到目标字段**
- 适用场景：该甲方字段实际对应某个标准字段，但自动匹配未识别
- 操作：选择对应的标准字段，建立映射关系
- 结果：该字段作为标准字段的映射，不再是未使用字段

**方式二：设为拓展字段**
- 适用场景：该甲方字段是甲方特有字段，无法映射到标准字段
- 操作：填写拓展字段信息，创建自定义字段
- 结果：该字段作为拓展字段独立管理，可在案件列表中展示

#### 3.5.5 批量处理未使用字段

点击页面顶部的 [批量处理] 按钮：

```text
┌────────────────────────────────────────────────────────────┐
│  批量处理未使用字段（3个）                             [×]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  ☑ 客户等级 (CUSTOMER_LEVEL)                               │
│     处理方式：● 设为拓展字段  ○ 匹配到目标字段              │
│     拓展字段别名：customer_level                            │
│     所属分组：基本信息                                       │
│     隐私标签：公开                                           │
│                                                             │
│  ☑ 逾期等级 (OVERDUE_LEVEL)                                │
│     处理方式：● 设为拓展字段  ○ 匹配到目标字段              │
│     拓展字段别名：overdue_level                             │
│     所属分组：状态信息                                       │
│     隐私标签：公开                                           │
│                                                             │
│  ☐ 备注信息 (REMARK)                                        │
│     处理方式：○ 设为拓展字段  ○ 匹配到目标字段              │
│     （暂不处理）                                             │
│                                                             │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                             │
│  已选择 2 个字段进行处理                                     │
│                                                             │
│              [取消]  [批量保存]                             │
└────────────────────────────────────────────────────────────┘
```

### 3.6 步骤5：保存映射配置

#### 3.6.1 页面顶部状态栏

系统在页面顶部实时显示映射配置状态：

```text
┌────────────────────────────────────────────────────────────┐
│ 案件列表字段映射配置             [版本管理] [保存新版本]     │
│ [✓ 映射完成] 已映射 15/15 个标准字段                        │
└────────────────────────────────────────────────────────────┘
```

**状态标签类型**：

| 映射进度 | 状态标签 | 标签颜色 | 保存按钮状态 |
|---------|---------|---------|-------------|
| 0/15 | 未开始映射 | 灰色(info) | 禁用 |
| 1-14/15 | 映射进行中 | 橙色(warning) | 禁用 |
| 15/15 | ✓ 映射完成 | 绿色(success) | 可用 |

**未保存修改提示**：
```text
[✓ 映射完成] 已映射 15/15  ⚠️ 有未保存的修改
```

#### 3.6.2 保存条件检查

**核心规则**：
> ⚠️ **只有所有标准字段都映射完成后，才能保存配置**
> ✅ **保存成功后，系统自动生成新的配置版本号**

**严格的保存条件**（三个条件必须同时满足）：

1. ✅ **映射完成度 = 100%**（强制要求）
   - ❌ **不允许部分保存**：不能保存 10/15 或 14/15 的状态
   - ✅ **必须全部映射**：所有15个标准字段都必须映射到甲方字段
   - 🔒 **保存按钮控制**：未完成映射时，保存按钮强制禁用
   - 💡 **提示信息**：缺少映射时显示"请先完成所有标准字段的映射"

2. ✅ **已选择甲方**
   - 必须在甲方下拉框中选择了具体甲方
   - 未选择甲方时，整个页面不可操作

3. ✅ **不在保存中**
   - 避免重复提交
   - 保存过程中按钮显示加载状态

**示例说明**：

```text
场景1：未完成映射
映射进度：12/15
保存按钮：[保存新版本]（禁用，灰色）
提示：还有3个字段未映射（case_status、overdue_days、total_installments）
结果：❌ 无法保存

场景2：完成映射
映射进度：15/15
保存按钮：[保存新版本]（可用，蓝色）
提示：[✓ 映射完成] 已映射 15/15 个标准字段
结果：✅ 可以保存
```

**保存按钮状态**：

| 状态 | 按钮文本 | 可用性 | 图标 |
|------|---------|--------|------|
| 首次保存 | 保存 | 映射完成后可用 | ✓ |
| 已有版本 | 保存新版本 | 映射完成后可用 | ✓ |
| 保存中 | 保存新版本 | 禁用+加载动画 | ⏳ |
| 未完成 | 保存新版本 | 禁用(灰色) | - |

#### 3.6.3 保存操作流程

```text
用户操作流程：

1. 完成所有字段映射
   状态：[✓ 映射完成] 已映射 15/15
   ↓
2. 点击"保存"或"保存新版本"按钮
   ↓
3. 系统显示确认对话框
   ┌─────────────────────────────────────────────┐
   │ 确认保存                                     │
   ├─────────────────────────────────────────────┤
   │ 即将保存当前映射配置，共映射 15 个标准字段。  │
   │ 保存后将生成新版本并在线上生效。             │
   │                                             │
   │            [取消]     [确认保存]             │
   └─────────────────────────────────────────────┘
   ↓
4. 用户确认保存
   ↓
5. 系统执行保存操作
   - 调用API：POST /api/v1/field-mapping/save
   - 显示加载状态
   ↓
6. 保存成功后，系统自动完成以下操作：
   a) **自动生成新版本号**
      - 首次保存 → v1
      - 第二次保存 → v2
      - 第N次保存 → vN
      - 版本号由系统自动递增，不可手动指定

   b) **设置版本状态**
      - 新版本设为"生效中"（is_active = true）
      - 原生效版本改为"历史版本"（is_active = false）

   c) **更新页面显示**
      - 显示成功消息："配置保存成功！已生成版本 vN"
      - 更新"当前生效的映射配置版本"卡片
      - 清除"未保存修改"标记
      - 配置立即在线上生效
```text

**版本生成示例**：

```text
第1次保存配置
  ↓
生成版本 v1（生效中）
保存时间：2024-12-04 10:00:00
映射完成度：15/15

修改配置后，第2次保存
  ↓
生成版本 v2（生效中）
保存时间：2024-12-05 14:20:00
映射完成度：15/15
同时：v1 变为历史版本

再次修改后，第3次保存
  ↓
生成版本 v3（生效中）
保存时间：2024-12-06 16:30:00
映射完成度：15/15
同时：v2 变为历史版本
```

#### 3.6.4 保存数据结构

**请求数据格式**：

```json
{
  "tenant_id": 1,
  "scene": "case_list",
  "field_mappings": [
    {
      "standard_field_key": "case_code",
      "standard_field_name": "案件编号",
      "tenant_field_key": "CASE_ID",
      "tenant_field_name": "案件ID",
      "tenant_field_type": "String",
      "mapping_status": "manual_mapped"
    },
    {
      "standard_field_key": "case_status",
      "standard_field_name": "案件状态",
      "tenant_field_key": "LOAN_STATUS",
      "tenant_field_name": "借款状态",
      "tenant_field_type": "Enum",
      "mapping_status": "auto_mapped",
      "enum_mapping": {
        "待分配": "UNASSIGNED",
        "催收中": "COLLECTING",
        "已完成": "COMPLETED"
      }
    }
    // ... 其他13个字段映射
  ],
  "extended_fields": [
    {
      "field_alias": "customer_level",
      "tenant_field_key": "CUSTOMER_LEVEL",
      "tenant_field_name": "客户等级",
      "field_type": "Enum",
      "enum_values": ["VIP", "普通", "黑名单"]
    }
    // ... 其他拓展字段
  ],
  "total_count": 15,
  "mapped_count": 15
}
```

**响应数据格式**：

```json
{
  "code": 200,
  "message": "保存成功",
  "data": {
    "version": 5,
    "created_at": "2024-12-08T15:30:45Z",
    "created_by_name": "管理员",
    "mapped_count": 15,
    "total_count": 15,
    "is_active": true
  }
}
```

#### 3.6.5 保存失败处理

**可能的失败原因**：

1. **映射未完成**
   ```
   错误提示：请先完成所有标准字段的映射
   当前进度：已映射 12/15
   缺失字段：案件状态、逾期天数、期数
   ```

2. **网络错误**
   ```
   错误提示：保存配置失败，请检查网络连接后重试
   建议操作：点击"重新保存"按钮
   ```

3. **权限不足**
   ```
   错误提示：您没有权限保存映射配置
   建议操作：联系管理员获取权限
   ```

4. **数据验证失败**
   ```
   错误提示：数据验证失败，请检查配置
   详细信息：枚举字段"案件状态"未配置枚举值映射
   ```

#### 3.6.6 配置生效机制

**生效时机**：
- ✅ **立即生效**：保存成功后，配置立即在线上环境生效
- ⚠️ **无预发布**：不支持预发布环境，保存即生效
- 📝 **变更记录**：所有变更都有版本记录，可随时回滚

**生效范围**：
```text
保存配置后，影响以下功能模块：
│
├── 案件列表页面
│   └── 根据映射配置显示对应字段数据
│
├── 案件详情页面
│   └── 根据映射配置显示字段详情
│
├── 数据导出功能
│   └── 根据映射配置导出标准化数据
│
└── 数据API接口
    └── 返回映射后的标准化字段
```

---

## 4. 版本控制机制

### 4.1 为什么需要版本控制

**业务场景**：
1. 甲方字段定义可能会变更（新增、删除、修改字段）
2. 需要回滚到历史版本（新版本有问题）
3. 需要对比不同版本的差异（了解变更内容）
4. 需要保留变更历史（审计追溯）

### 4.2 版本号管理

**版本号生成规则**：
- 按甲方+场景维度自增：v1, v2, v3, ...
- 每次上传新JSON文件，版本号自动+1
- 版本号不可手动指定，系统自动计算
- 删除版本不会影响版本号的连续性

**示例**：
```text
甲方：XX金融 (tenant_001)
场景：案件列表 (list)

版本历史：
v1 - 2025-12-01 09:00:00 - 10个字段 - 初始版本
v2 - 2025-12-05 10:20:00 - 12个字段 - 新增逾期天数等2个字段
v3 - 2025-12-07 15:30:00 - 14个字段 - 新增借款人联系信息
v4 - 2025-12-08 11:00:00 - 15个字段 - 新增客户等级字段
```

### 4.3 版本状态管理

**版本状态**：
- **当前生效版本**（`is_active = true`）：用于字段映射的版本，同一甲方同一场景只有1个
- **历史版本**（`is_active = false`）：保留记录，可随时查看、下载、切换

**状态转换**：
```text
新上传版本
    ↓
自动设为 is_active = true（当前生效版本）
    ↓
旧版本自动设为 is_active = false（历史版本）
```

**版本切换流程**：
```sql
1. 管理员选择历史版本
   ↓
2. 点击 [设为当前版本]
   ↓
3. 确认切换
   ↓
4. 更新数据库：
   UPDATE tenant_field_uploads SET is_active = false WHERE tenant_id = ? AND scene = 'list'
   UPDATE tenant_field_uploads SET is_active = true WHERE id = ?
   ↓
5. 刷新页面
   ↓
6. 字段映射配置使用新版本的字段
```

### 4.4 版本对比功能

版本对比是版本控制的核心功能，帮助管理员了解不同版本之间的差异。

#### 4.4.1 对比触发方式

**方式一：与上一版本对比**
```text
版本管理面板
    ↓
选择某个版本
    ↓
点击 [与上一版本对比]
    ↓
自动对比该版本与其前一个版本
```

**方式二：选择任意两个版本对比**
```text
版本管理面板
    ↓
勾选版本2
    ↓
勾选版本3
    ↓
点击 [对比选中版本]
    ↓
对比版本2和版本3
```

#### 4.4.2 对比维度

系统对比以下字段属性：
- `field_name`：字段名称
- `field_key`：字段标识
- `field_type`：字段类型
- `enum_values`：枚举值（Enum类型）
- `is_required`：是否必填
- `sort_order`：排序
- `description`：字段说明

#### 4.4.3 对比结果展示

参见"2-案件列表甲方字段查看-PRD.md"第8.3节的详细说明。

**变更类型**：
- 🟢 **新增字段**：版本2有，版本1没有
- 🔴 **删除字段**：版本1有，版本2没有
- 🟡 **修改字段**：字段标识相同，但其他属性有变化
- ⚪ **未变更字段**：所有属性完全相同

#### 4.4.4 版本对比报告导出

支持导出Markdown格式的对比报告，包含：
- 基本信息（对比版本、对比时间、操作人）
- 版本信息（上传时间、字段数、上传人）
- 变更摘要（新增/删除/修改/未变更数量）
- 详细对比（每个字段的具体变化）

### 4.5 版本与映射关系

**重要原则**：

1. **映射关系独立于版本**
   - 映射关系存储在 `tenant_field_configs` 表中
   - 版本切换不会删除已配置的映射关系
   - 切换版本后，映射关系仍然保留

2. **版本切换的影响**
   ```
   假设当前使用 v3，已映射 14 个字段
       ↓
   切换到 v2（只有 12 个字段）
       ↓
   结果：
   • v2 和 v3 共有的 12 个字段：映射关系保留
   • v3 独有的 2 个字段：映射关系保留，但标记为"字段不存在"
   • 如果再切回 v3：所有映射关系恢复正常
   ```

3. **版本删除字段的处理**
   ```
   假设 v2 删除了 v1 的某个字段（CUSTOMER_LEVEL）
       ↓
   切换到 v2 后
       ↓
   CUSTOMER_LEVEL 的映射关系：
   • 如果映射到标准字段：标记为"源字段不存在"，可选择重新映射
   • 如果是拓展字段：标记为"源字段不存在"，可选择删除或保留
   ```

### 4.6 版本审计日志

所有版本操作都记录审计日志：

| 操作类型 | 操作内容 | 记录信息 |
|----------|----------|----------|
| 上传新版本 | 上传JSON文件 | 操作人、时间、版本号、字段数 |
| 切换版本 | 设为当前版本 | 操作人、时间、旧版本、新版本 |
| 版本对比 | 对比两个版本 | 操作人、时间、对比版本 |
| 下载版本 | 下载JSON文件 | 操作人、时间、下载版本 |

**日志查询**：
```text
接口：GET /api/v1/tenants/{tenantId}/field-version-audit-log
参数：
- scene: 场景（list/detail）
- operation_type: 操作类型（upload/switch/compare/download）
- start_date: 开始日期
- end_date: 结束日期
```text

### 4.7 映射配置版本管理

#### 4.7.1 两种版本的区别

系统中存在**两种独立的版本**，各自管理不同的内容：

| 版本类型 | 管理内容 | 变更时机 | 管理入口 | 版本号规则 |
|---------|---------|---------|---------|-----------|
| **甲方字段版本** | 甲方上传的字段数据 | 上传新JSON文件时 | "案件列表甲方字段查看" | v1, v2, v3... |
| **映射配置版本** | 字段映射关系配置 | 保存映射配置时 | "案件列表字段映射配置" | v1, v2, v3... |

**版本关系示例**：
```text
甲方字段版本 v3（18个字段）
    ↓
基于此版本创建映射配置 v1（映射15个标准字段）
    ↓
修改映射后保存 → 映射配置 v2
修改映射后保存 → 映射配置 v3
    ↓
甲方上传新字段 → 甲方字段版本 v4（20个字段）
    ↓
基于新版本重新配置 → 映射配置 v4
```

**独立性说明**：
- 甲方字段版本变更 **不会** 自动创建新的映射配置版本
- 映射配置版本变更 **不会** 影响甲方字段版本
- 两种版本各自独立管理，互不干扰

#### 4.7.2 映射配置版本信息

每个映射配置版本包含以下信息：

```json
{
  "version": 5,
  "tenant_id": 1,
  "scene": "case_list",
  "created_at": "2024-12-08T15:30:45Z",
  "created_by": 123,
  "created_by_name": "管理员",
  "mapped_count": 15,
  "total_count": 15,
  "completion_rate": 100,
  "is_active": true,
  "field_mappings": [
    {
      "standard_field_key": "case_code",
      "tenant_field_key": "CASE_ID",
      "mapping_status": "manual_mapped"
    }
    // ... 其他映射关系
  ],
  "extended_fields": [
    {
      "field_alias": "customer_level",
      "tenant_field_key": "CUSTOMER_LEVEL"
    }
    // ... 其他拓展字段
  ]
}
```

#### 4.7.3 配置版本显示卡片

**当前生效版本卡片**：

```text
┌─────────────────────────────────────────────────────────┐
│ 当前生效的映射配置版本                  [已生效]          │
├─────────────────────────────────────────────────────────┤
│ 配置版本: v5                                             │
│ 保存时间: 2024-12-08 15:30:45                           │
│ 映射完成度: 15/15                                        │
│ 保存人: 管理员                                           │
└─────────────────────────────────────────────────────────┘
```

**甲方字段版本卡片**：

```text
┌─────────────────────────────────────────────────────────┐
│ 甲方字段数据版本                        [数据源]          │
├─────────────────────────────────────────────────────────┤
│ 字段版本: v3                                             │
│ 上传时间: 2024-12-07 10:20:30                           │
│ 字段数量: 18                                             │
│ 上传人: 张三                                             │
└─────────────────────────────────────────────────────────┘
```

**卡片显示逻辑**：
- 两张卡片并列显示，各自独立
- 配置版本卡片：标注"已生效"（绿色）
- 字段版本卡片：标注"数据源"（蓝色）
- 明确区分两种版本的作用

#### 4.7.4 版本管理对话框

**打开方式**：
- 点击页面顶部"版本管理"按钮
- 弹出"映射配置版本管理"对话框

**对话框结构**：

```text
┌────────────────────────────────────────────────────────┐
│ 映射配置版本管理                                [×]      │
├────────────────────────────────────────────────────────┤
│ ℹ️ 当前生效版本：v5                                      │
│    保存时间：2024-12-08 15:30:45                        │
│    映射完成度：15/15                                     │
├────────────────────────────────────────────────────────┤
│ 历史版本记录                                  [刷新]     │
├────────────────────────────────────────────────────────┤
│ 序号│版本号│保存时间        │映射完成度│保存人│状态  │操作│
│  1  │ v5  │2024-12-08...  │15/15    │管理员│生效中│查看详情│
│  2  │ v4  │2024-12-07...  │15/15    │管理员│历史  │查看/恢复│
│  3  │ v3  │2024-12-06...  │15/15    │管理员│历史  │查看/恢复│
│  4  │ v2  │2024-12-05...  │15/15    │管理员│历史  │查看/恢复│
│  5  │ v1  │2024-12-04...  │15/15    │管理员│历史  │查看/恢复│
└────────────────────────────────────────────────────────┘

**说明**：
- 由于保存时强制要求100%完成，所以所有版本的映射完成度都是15/15
- 不再显示完成率列（始终为100%）
```text

**版本列表字段说明**：

| 字段 | 说明 | 示例 |
|------|------|------|
| 版本号 | 配置版本号 | v5 (生效中-绿色标签), v4 (历史-灰色标签) |
| 保存时间 | 配置保存时间 | 2024-12-08 15:30:45 |
| 映射完成度 | 映射字段数/总字段数 | 15/15（所有版本都是100%） |
| 保存人 | 操作用户名 | 管理员 |
| 状态 | 当前状态 | 生效中(绿色) / 历史版本(灰色) |
| 操作 | 可用操作 | 查看详情 / 恢复版本 |

**注意**：由于保存时要求必须100%完成映射，所以所有版本的映射完成度都是15/15，不需要显示完成率百分比。

#### 4.7.5 查看版本详情

**操作入口**：点击版本列表中的"查看详情"按钮

**详情对话框**：

```text
┌────────────────────────────────────────────────────────┐
│ 版本 v4 详情                                    [×]      │
├────────────────────────────────────────────────────────┤
│ 版本信息                                                │
│ • 版本号: v4                                            │
│ • 保存时间: 2024-12-07 14:20:30                        │
│ • 保存人: 管理员                                        │
│ • 映射完成度: 14/15 (93%)                              │
│ • 状态: 历史版本                                        │
├────────────────────────────────────────────────────────┤
│ 字段映射配置 (14个)                                     │
│ 1. case_code → CASE_ID (手动映射)                       │
│ 2. user_name → CUSTOMER_NAME (自动匹配)                │
│ 3. mobile_number → MOBILE (手动映射)                   │
│ ...                                                     │
│ 14. merchant_name → MERCHANT (手动映射)                │
├────────────────────────────────────────────────────────┤
│ 未映射字段 (1个)                                        │
│ • case_status (案件状态)                               │
├────────────────────────────────────────────────────────┤
│ 拓展字段 (2个)                                          │
│ • customer_level - 客户等级                            │
│ • overdue_level - 逾期等级                             │
└────────────────────────────────────────────────────────┘
```

#### 4.7.6 恢复历史版本

**操作流程**：

```text
1. 用户在版本列表中选择历史版本
   ↓
2. 点击"恢复版本"按钮
   ↓
3. 系统显示确认对话框
   ┌──────────────────────────────────────────┐
   │ 确认恢复                                  │
   ├──────────────────────────────────────────┤
   │ 确定要恢复到版本 v3 吗？                  │
   │                                           │
   │ 恢复后，当前配置将被替换为该历史版本的     │
   │ 配置。映射关系和拓展字段都将恢复到 v3。   │
   │                                           │
   │            [取消]     [确认恢复]          │
   └──────────────────────────────────────────┘
   ↓
4. 用户确认恢复
   ↓
5. 系统执行恢复操作
   - 调用API：POST /api/v1/field-mapping/restore
   - 将 v3 设为当前生效版本
   - 将原 v5 设为历史版本
   ↓
6. 恢复成功
   - 显示成功消息
   - 关闭版本管理对话框
   - 重新加载页面数据
   - 配置立即生效
```typescript

**恢复后的影响**：

| 影响范围 | 说明 |
|---------|------|
| 映射关系 | 恢复到所选版本的映射配置 |
| 拓展字段 | 恢复到所选版本的拓展字段配置 |
| 未映射字段 | 根据所选版本重新计算 |
| 映射完成度 | 恢复到所选版本的完成度 |
| 线上环境 | 立即生效，影响案件列表等功能 |

#### 4.7.7 版本变更追踪

**未保存修改检测**：

系统实时监听配置变化，自动标记未保存状态：

```typescript
// 监听字段映射变化
watch([mappedFields, extendedFields], () => {
  if (currentConfigVersion.value) {
    hasUnsavedChanges.value = true
  }
}, { deep: true })
```

**触发条件**：
- ✅ 修改任意字段映射关系
- ✅ 添加/删除/编辑拓展字段
- ✅ 清除字段映射

**清除条件**：
- ✅ 保存配置成功
- ✅ 恢复到历史版本
- ✅ 刷新页面

**显示效果**：
```text
[✓ 映射完成] 已映射 15/15  ⚠️ 有未保存的修改
```

#### 4.7.8 版本审计日志

所有映射配置版本操作都记录审计日志：

| 操作类型 | 操作内容 | 记录信息 |
|----------|----------|----------|
| 保存配置 | 保存新版本 | 操作人、时间、版本号、映射完成度 |
| 恢复版本 | 恢复历史版本 | 操作人、时间、恢复版本号、原版本号 |
| 查看详情 | 查看版本详情 | 操作人、时间、查看版本号 |

**日志查询接口**：
```text
接口：GET /api/v1/field-mapping/audit-log
参数：
- tenant_id: 甲方ID
- scene: 场景（case_list）
- operation_type: 操作类型（save/restore/view）
- start_date: 开始日期
- end_date: 结束日期
```text

---

## 5. 接口设计

### 5.1 字段映射配置接口

#### 5.1.1 获取字段映射列表
```http
GET /api/v1/tenants/{tenantId}/field-configs

参数：
- field_group_id: 字段分组ID（可选）
- mapping_status: 映射状态（可选：unmapped/auto_mapped/manual_mapped）

响应：
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_id": 1,
      "field_key": "case_code",
      "field_name": "案件编号",
      "field_type": "String",
      "tenant_field_key": "CASE_ID",
      "tenant_field_id": "case_id_001",
      "mapping_status": "auto_mapped",
      "auto_mapped": true,
      "is_required": true,
      "enum_mapping": null,
      "created_at": "2025-12-08T10:00:00Z",
      "updated_at": "2025-12-08T10:00:00Z"
    }
  ]
}
```

#### 5.1.2 创建或更新字段映射
```http
PUT /api/v1/tenants/{tenantId}/field-configs

请求体：
{
  "field_key": "case_code",
  "tenant_field_key": "CASE_ID",
  "tenant_field_id": "case_id_001",
  "mapping_status": "manual_mapped",
  "enum_mapping": {
    "unassigned": "pending",
    "collecting": "overdue"
  }
}

响应：
{
  "code": 200,
  "message": "映射保存成功",
  "data": {
    "id": 1,
    "tenant_id": 1,
    "field_key": "case_code",
    ...
  }
}
```

#### 5.1.3 删除字段映射
```sql
DELETE /api/v1/tenants/{tenantId}/field-configs/{id}

响应：
{
  "code": 200,
  "message": "映射删除成功"
}
```

#### 5.1.4 一键建议映射
```http
POST /api/v1/tenants/{tenantId}/field-configs/auto-suggest

响应：
{
  "code": 200,
  "message": "success",
  "data": {
    "suggestions": [
      {
        "field_key": "case_code",
        "field_name": "案件编号",
        "tenant_field_key": "CASE_ID",
        "tenant_field_name": "案件编号",
        "similarity": 100,
        "match_type": "exact",
        "confidence": "high"
      },
      {
        "field_key": "mobile_number",
        "field_name": "手机号",
        "tenant_field_key": "PHONE_NUMBER",
        "tenant_field_name": "手机号码",
        "similarity": 70,
        "match_type": "synonym",
        "confidence": "medium"
      }
    ],
    "summary": {
      "total": 12,
      "high_confidence": 8,
      "medium_confidence": 4,
      "low_confidence": 0
    }
  }
}
```

#### 5.1.5 批量确认映射建议
```http
POST /api/v1/tenants/{tenantId}/field-configs/batch-confirm

请求体：
{
  "mappings": [
    {
      "field_key": "case_code",
      "tenant_field_key": "CASE_ID",
      "tenant_field_id": "case_id_001",
      "mapping_status": "auto_mapped"
    },
    {
      "field_key": "mobile_number",
      "tenant_field_key": "PHONE_NUMBER",
      "tenant_field_id": "phone_001",
      "mapping_status": "auto_mapped"
    }
  ]
}

响应：
{
  "code": 200,
  "message": "批量映射成功",
  "data": {
    "success_count": 2,
    "failed_count": 0
  }
}
```

#### 5.1.6 保存映射配置

**接口说明**：保存当前完整的映射配置，生成新版本

```http
POST /api/v1/field-mapping/save

请求体：
{
  "tenant_id": 1,
  "scene": "case_list",
  "field_mappings": [
    {
      "standard_field_key": "case_code",
      "standard_field_name": "案件编号",
      "tenant_field_key": "CASE_ID",
      "tenant_field_name": "案件ID",
      "tenant_field_type": "String",
      "mapping_status": "manual_mapped"
    },
    {
      "standard_field_key": "case_status",
      "standard_field_name": "案件状态",
      "tenant_field_key": "LOAN_STATUS",
      "tenant_field_name": "借款状态",
      "tenant_field_type": "Enum",
      "mapping_status": "auto_mapped",
      "enum_mapping": {
        "待分配": "UNASSIGNED",
        "催收中": "COLLECTING",
        "已完成": "COMPLETED"
      }
    }
    // ... 其他字段映射（共15个）
  ],
  "extended_fields": [
    {
      "field_alias": "customer_level",
      "tenant_field_key": "CUSTOMER_LEVEL",
      "tenant_field_name": "客户等级",
      "field_type": "Enum",
      "enum_values": ["VIP", "普通", "黑名单"]
    }
    // ... 其他拓展字段
  ],
  "total_count": 15,
  "mapped_count": 15
}

响应：
{
  "code": 200,
  "message": "保存成功",
  "data": {
    "version": 5,
    "created_at": "2024-12-08T15:30:45Z",
    "created_by": 123,
    "created_by_name": "管理员",
    "mapped_count": 15,
    "total_count": 15,
    "completion_rate": 100,
    "is_active": true
  }
}

错误响应示例1 - 映射未完成：
{
  "code": 400,
  "message": "映射未完成，无法保存配置",
  "data": {
    "mapped_count": 12,
    "total_count": 15,
    "completion_rate": 80,
    "missing_fields": [
      {
        "field_key": "case_status",
        "field_name": "案件状态",
        "is_required": true
      },
      {
        "field_key": "overdue_days",
        "field_name": "逾期天数",
        "is_required": true
      },
      {
        "field_key": "total_installments",
        "field_name": "期数",
        "is_required": true
      }
    ],
    "error_type": "INCOMPLETE_MAPPING",
    "error_hint": "必须完成所有15个标准字段的映射后才能保存"
  }
}

错误响应示例2 - 空映射：
{
  "code": 400,
  "message": "未配置任何映射关系",
  "data": {
    "mapped_count": 0,
    "total_count": 15,
    "error_type": "NO_MAPPING",
    "error_hint": "请先配置字段映射关系"
  }
}
```text

**错误码说明**：
- `400`：映射未完成或数据验证失败
- `401`：未登录或token过期
- `403`：无权限保存配置
- `500`：服务器内部错误

**业务规则**：

**核心规则**：
> ⚠️ **只有所有标准字段都映射完成后，才允许保存**
> ✅ **保存成功后，系统自动生成新的配置版本号**

**详细规则**：
1. **保存前验证**（必须满足，否则返回400错误）
   - ✅ 映射完成度必须 = 100%（mapped_count === total_count）
   - ✅ 所有15个标准字段都必须有映射关系
   - ❌ 不允许部分保存（如10/15、14/15都不允许）

2. **版本号自动生成**（不可手动指定）
   - 首次保存 → 版本号 = 1
   - 后续保存 → 版本号 = 当前最大版本号 + 1
   - 版本号只增不减，不可跳号

3. **版本状态自动管理**
   - 新保存的版本 → 立即设为"生效中"（is_active = true）
   - 原生效版本 → 自动改为"历史版本"（is_active = false）
   - 同一甲方同一场景，只有1个生效版本

4. **配置立即生效**
   - 保存成功后，配置立即在线上环境生效
   - 影响案件列表、案件详情等所有相关功能
   - 无缓冲期，无预发布环境

5. **操作审计日志**
   - 记录操作人、操作时间、版本号
   - 记录映射完成度、字段数量
   - 用于追溯和审计

#### 5.1.7 获取映射配置版本列表

**接口说明**：获取某甲方的映射配置版本历史

```http
GET /api/v1/field-mapping/versions

参数：
- tenant_id: 甲方ID（必填）
- scene: 场景（必填，case_list）
- page: 页码（可选，默认1）
- page_size: 每页数量（可选，默认20）

响应：
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 5,
    "current_page": 1,
    "total_pages": 1,
    "versions": [
      {
        "version": 5,
        "created_at": "2024-12-08T15:30:45Z",
        "created_by": 123,
        "created_by_name": "管理员",
        "mapped_count": 15,
        "total_count": 15,
        "completion_rate": 100,
        "is_active": true
      },
      {
        "version": 4,
        "created_at": "2024-12-07T14:20:30Z",
        "created_by": 123,
        "created_by_name": "管理员",
        "mapped_count": 14,
        "total_count": 15,
        "completion_rate": 93,
        "is_active": false
      },
      {
        "version": 3,
        "created_at": "2024-12-06T10:15:00Z",
        "created_by": 123,
        "created_by_name": "管理员",
        "mapped_count": 12,
        "total_count": 15,
        "completion_rate": 80,
        "is_active": false
      }
    ]
  }
}
```text

#### 5.1.8 获取映射配置版本详情

**接口说明**：获取特定版本的完整配置详情

```http
GET /api/v1/field-mapping/versions/{version}

参数：
- tenant_id: 甲方ID（必填）
- scene: 场景（必填，case_list）

响应：
{
  "code": 200,
  "message": "success",
  "data": {
    "version": 4,
    "tenant_id": 1,
    "scene": "case_list",
    "created_at": "2024-12-07T14:20:30Z",
    "created_by": 123,
    "created_by_name": "管理员",
    "mapped_count": 14,
    "total_count": 15,
    "completion_rate": 93,
    "is_active": false,
    "field_mappings": [
      {
        "standard_field_key": "case_code",
        "standard_field_name": "案件编号",
        "tenant_field_key": "CASE_ID",
        "tenant_field_name": "案件ID",
        "tenant_field_type": "String",
        "mapping_status": "manual_mapped"
      }
      // ... 其他14个映射
    ],
    "extended_fields": [
      {
        "field_alias": "customer_level",
        "tenant_field_key": "CUSTOMER_LEVEL",
        "tenant_field_name": "客户等级",
        "field_type": "Enum",
        "enum_values": ["VIP", "普通", "黑名单"]
      }
      // ... 其他拓展字段
    ],
    "unmapped_fields": [
      {
        "field_key": "case_status",
        "field_name": "案件状态",
        "field_type": "Enum"
      }
    ]
  }
}
```text

#### 5.1.9 恢复历史版本

**接口说明**：将历史版本恢复为当前生效版本

```http
POST /api/v1/field-mapping/restore

请求体：
{
  "tenant_id": 1,
  "scene": "case_list",
  "version": 3
}

响应：
{
  "code": 200,
  "message": "恢复成功",
  "data": {
    "restored_version": 3,
    "previous_version": 5,
    "created_at": "2024-12-08T16:00:00Z"
  }
}

错误响应：
{
  "code": 404,
  "message": "版本不存在",
  "data": {
    "version": 99,
    "available_versions": [1, 2, 3, 4, 5]
  }
}
```

**业务规则**：
1. 验证版本是否存在
2. 将指定版本设为生效版本（is_active = true）
3. 将原生效版本设为历史版本（is_active = false）
4. 记录操作日志（操作人、时间、恢复版本、原版本）
5. 恢复后立即生效，影响线上环境

### 5.2 拓展字段管理接口

#### 5.2.1 获取拓展字段列表
```http
GET /api/v1/tenants/{tenantId}/extended-fields

参数：
- field_group_id: 字段分组ID（可选）

响应：
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_id": 1,
      "field_alias": "customer_level",
      "tenant_field_key": "CUSTOMER_LEVEL",
      "tenant_field_name": "客户等级",
      "field_type": "String",
      "field_group_id": 1,
      "privacy_label": "公开",
      "is_required": false,
      "created_at": "2025-12-08T10:00:00Z"
    }
  ]
}
```

#### 5.2.2 创建拓展字段
```http
POST /api/v1/tenants/{tenantId}/extended-fields

请求体：
{
  "field_alias": "customer_level",
  "tenant_field_key": "CUSTOMER_LEVEL",
  "tenant_field_name": "客户等级",
  "field_type": "String",
  "field_group_id": 1,
  "privacy_label": "公开",
  "is_required": false,
  "description": "甲方特有字段：VIP/普通/黑名单"
}

响应：
{
  "code": 200,
  "message": "拓展字段创建成功",
  "data": { ... }
}
```

### 5.3 未使用字段接口

#### 5.3.1 获取未使用的甲方字段列表
```http
GET /api/v1/tenants/{tenantId}/unmapped-fields

响应：
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "field_key": "CUSTOMER_LEVEL",
      "field_name": "客户等级",
      "field_type": "String",
      "is_required": false,
      "updated_at": "2025-12-07T15:30:00Z"
    },
    {
      "field_key": "OVERDUE_LEVEL",
      "field_name": "逾期等级",
      "field_type": "Enum",
      "enum_values": ["A", "B", "C"],
      "is_required": false,
      "updated_at": "2025-12-07T15:30:00Z"
    }
  ]
}
```

### 5.4 前端API调用时序

#### 5.4.1 页面初始化数据加载

**加载策略**：使用 `Promise.all` 并行调用所有API，提升加载速度

```text
用户进入字段映射配置页面
  ↓
检查是否已选择甲方
  ├─ 未选择 → 提示"请先选择甲方"
  └─ 已选择 → 执行并行数据加载
     ↓
  Promise.all([
    getStandardFields(),                    // API 1: 获取15个标准字段
    getTenantFieldsJson(tenantId),          // API 2: 获取甲方字段版本信息
    getFieldConfigs(tenantId),              // API 3: 获取已有的映射配置
    getExtendedFields(tenantId),            // API 4: 获取拓展字段列表
    getUnmappedFields(tenantId)             // API 5: 获取未使用字段列表
  ])
     ↓
  所有API并行执行（预计耗时 < 1秒）
     ↓
  处理返回数据：
     ├─ 合并标准字段和映射配置，生成完整的映射关系表
     ├─ 提取版本信息（版本号、上传时间、字段数、上传人）
     ├─ 计算未映射字段数量
     └─ 处理拓展字段和未使用字段
     ↓
  渲染界面：
     ├─ 显示版本信息卡片
     ├─ 显示未使用字段警告（如果数量 > 0）
     ├─ 渲染匹配目标字段表格
     ├─ 渲染拓展字段表格
     └─ 渲染未使用字段表格
```

**错误处理策略**：

```typescript
// 单个API失败不影响其他API的执行
const [versionRes, standardRes, configsRes, extendedRes, unmappedRes] =
  await Promise.all([
    getTenantFieldsJson(tenantId).catch(() => null),      // 失败返回 null
    getStandardFields().catch(() => ({ data: [] })),      // 失败返回空数组
    getFieldConfigs(tenantId).catch(() => ({ data: [] })),
    getExtendedFields(tenantId).catch(() => ({ data: [] })),
    getUnmappedFields(tenantId).catch(() => ({ data: [] }))
  ])

// 容错处理
if (!versionRes) {
  ElMessage.warning('获取甲方字段版本信息失败')
  versionInfo.value = null  // 显示"未上传甲方字段"提示
}

if (!standardRes?.data || standardRes.data.length === 0) {
  ElMessage.error('获取标准字段失败')
  standardFields.value = []  // 显示空数据提示
}
```

**数据合并逻辑**：

```typescript
// 合并标准字段和映射配置
mappedFields.value = standardFields.value.map(field => {
  const config = configs.find(c => c.field_key === field.field_key)
  return {
    ...field,                                    // 标准字段的所有属性
    tenant_field_key: config?.tenant_field_key,  // 甲方字段Key
    tenant_field_name: config?.tenant_field_name,// 甲方字段名称
    mapping_status: config?.mapping_status || 'unmapped'  // 映射状态
  }
})
```

#### 5.4.2 用户操作触发的API调用

**智能匹配操作**：
```text
用户点击"智能匹配建议"按钮
  ↓
显示加载状态
  ↓
POST /api/v1/tenants/{tenantId}/field-configs/auto-suggest
  ↓
等待后端计算匹配结果（预计2-3秒）
  ↓
返回匹配建议列表
  ↓
打开匹配建议对话框
  ↓
用户勾选要应用的建议
  ↓
点击"确认选中项"
  ↓
POST /api/v1/tenants/{tenantId}/field-configs/batch-confirm
  ↓
保存成功，关闭对话框
  ↓
重新加载页面数据（调用初始化API）
```

**编辑映射操作**：
```text
用户点击"选择映射"或"重新映射"按钮
  ↓
打开编辑映射对话框
  ↓
异步加载可用甲方字段列表
GET /api/v1/tenants/{tenantId}/fields-json
  ↓
用户从下拉列表选择甲方字段
  ↓
实时检查类型兼容性（前端逻辑）
  ↓
用户点击"确认映射"
  ↓
PUT /api/v1/tenants/{tenantId}/field-configs
  ↓
保存成功，关闭对话框
  ↓
重新加载页面数据
```

**版本管理操作**：
```text
用户点击"管理版本"按钮
  ↓
打开版本管理抽屉
  ↓
GET /api/v1/tenants/{tenantId}/fields-json/history
  ↓
显示版本列表
  ↓
用户点击"切换到此版本"
  ↓
确认切换操作
  ↓
PUT /api/v1/tenants/{tenantId}/fields-json/activate/{version}
  ↓
切换成功
  ↓
关闭抽屉
  ↓
重新加载页面数据（使用新版本）
```

#### 5.4.3 性能优化措施

1. **并行加载**：使用 Promise.all 同时调用多个API
2. **数据缓存**：甲方字段列表缓存，避免重复加载
3. **懒加载**：对话框内容延迟加载，提升首屏速度
4. **防抖节流**：搜索、筛选等操作使用防抖
5. **加载状态**：所有API调用都显示加载动画

---

## 6. 数据库设计

### 6.1 甲方字段配置表

```sql
CREATE TABLE tenant_field_configs (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  tenant_id BIGINT NOT NULL COMMENT '甲方ID',
  field_key VARCHAR(100) NOT NULL COMMENT '标准字段标识',
  tenant_field_key VARCHAR(100) COMMENT '甲方字段标识',
  tenant_field_id VARCHAR(100) COMMENT '甲方字段ID',
  field_type VARCHAR(20) NOT NULL COMMENT '字段类型',
  mapping_status VARCHAR(20) NOT NULL DEFAULT 'unmapped' COMMENT '映射状态：unmapped/auto_mapped/manual_mapped',
  auto_mapped BOOLEAN DEFAULT FALSE COMMENT '是否自动映射',
  enum_mapping JSON COMMENT '枚举值映射关系',
  is_required BOOLEAN DEFAULT FALSE COMMENT '是否必填',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY uk_tenant_field (tenant_id, field_key),
  INDEX idx_tenant_id (tenant_id),
  INDEX idx_mapping_status (mapping_status)
) COMMENT '甲方字段配置表';
```

### 6.2 自定义拓展字段表

```sql
CREATE TABLE custom_fields (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  tenant_id BIGINT NOT NULL COMMENT '甲方ID',
  field_alias VARCHAR(100) NOT NULL COMMENT '扩展字段别名',
  tenant_field_key VARCHAR(100) NOT NULL COMMENT '甲方原始字段标识',
  tenant_field_name VARCHAR(200) NOT NULL COMMENT '甲方字段名称',
  field_type VARCHAR(50) NOT NULL COMMENT '字段类型',
  field_group_id BIGINT COMMENT '所属分组ID',
  privacy_label VARCHAR(20) NOT NULL COMMENT '隐私标签：PII/敏感/公开',
  is_required BOOLEAN DEFAULT FALSE COMMENT '是否必填',
  description TEXT COMMENT '字段说明',
  enum_options JSON COMMENT '枚举选项',
  sort_order INT DEFAULT 0 COMMENT '排序顺序',
  is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY uk_tenant_alias (tenant_id, field_alias),
  INDEX idx_tenant_id (tenant_id),
  INDEX idx_field_group_id (field_group_id)
) COMMENT '自定义拓展字段表';
```

### 6.3 甲方字段上传记录表

```sql
CREATE TABLE tenant_field_uploads (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  tenant_id VARCHAR(64) NOT NULL COMMENT '甲方ID',
  scene VARCHAR(20) NOT NULL DEFAULT 'list' COMMENT '场景：list-案件列表, detail-案件详情',
  version INT NOT NULL COMMENT '版本号',
  file_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
  file_size INT NOT NULL COMMENT '文件大小（字节）',
  file_path VARCHAR(512) NOT NULL COMMENT '存储路径',
  fields_count INT NOT NULL COMMENT '字段数量',
  uploaded_by VARCHAR(64) NOT NULL COMMENT '上传人ID',
  uploaded_by_name VARCHAR(100) COMMENT '上传人姓名',
  uploaded_at DATETIME NOT NULL COMMENT '上传时间',
  json_content JSON NOT NULL COMMENT 'JSON文件内容',
  is_active BOOLEAN DEFAULT FALSE COMMENT '是否为当前生效版本',
  version_note VARCHAR(500) COMMENT '版本说明',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY uk_tenant_scene_version (tenant_id, scene, version),
  INDEX idx_tenant_scene (tenant_id, scene),
  INDEX idx_tenant_scene_active (tenant_id, scene, is_active),
  INDEX idx_uploaded_at (uploaded_at)
) COMMENT '甲方字段上传记录表';
```

---

## 7. 业务规则

### 7.1 字段映射规则

- **一对一映射**：一个标准字段只能映射到一个甲方字段
- **一对多映射**：不支持（一个标准字段不能映射到多个甲方字段）
- **多对一映射**：不支持（多个标准字段不能映射到同一个甲方字段）
- **必填字段规则**：所有标准必填字段必须映射（覆盖率100%）
- **类型匹配规则**：标准字段和甲方字段的类型必须匹配或兼容

### 7.2 拓展字段规则

- **字段别名唯一性**：`field_alias` 在甲方内必须唯一
- **字段别名命名规范**：只能包含小写字母、数字和下划线，长度1-100字符
- **隐私标签必填**：必须选择 PII/敏感/公开 之一
- **所属分组必填**：必须选择已存在的字段分组

### 7.3 版本管理规则

- **版本号自增**：按甲方+场景维度自增，不可手动指定
- **当前版本唯一**：同一甲方同一场景只有1个`is_active = true`的版本
- **版本切换不删除映射**：切换版本后，已配置的映射关系保留
- **版本删除限制**：当前生效版本不可删除
- **历史版本保留**：所有历史版本永久保留，不删除

---

## 8. 用户体验设计

### 8.1 页面布局

```text
┌─────────────────────────────────────────────────────────────┐
│  顶部：面包屑 + 页面标题                                      │
├─────────────────────────────────────────────────────────────┤
│  甲方选择器 | 版本信息 | 操作按钮区                            │
├──────────┬──────────────────────────────────────────────────┤
│          │  Tab标签页：                                      │
│          │  ┌─────────────────────────────────────────┐    │
│          │  │ [匹配目标字段] [拓展字段] [未使用字段]   │    │
│          │  └─────────────────────────────────────────┘    │
│  左侧：  │                                                   │
│  字段    │  字段映射表格                                      │
│  分组    │  ┌───────────────────────────────────────┐      │
│  树      │  │ 目标字段 | 状态 | 甲方字段 | 枚举值 |  │      │
│  (可折叠)│  │ 案件编号 | ✓自动 | CASE_ID | - | 编辑 │      │
│          │  │ 客户姓名 | ✗未映 | [选择▼] | - | -    │      │
│          │  │ ...                                   │      │
│          │  └───────────────────────────────────────┘      │
└──────────┴──────────────────────────────────────────────────┘
```

### 8.2 交互反馈

- **保存成功**：显示成功提示，自动关闭弹窗
- **映射冲突**：显示错误提示，阻止保存
- **必填字段未映射**：红色高亮显示，顶部显示警告
- **版本切换**：显示确认对话框，切换后显示成功提示
- **自动匹配**：显示加载动画，匹配完成后展示建议列表

### 8.3 状态标识

- 🟢 **已自动映射**：绿色标签
- 🔵 **已手动映射**：蓝色标签
- 🔴 **未映射**：红色标签（必填字段加粗高亮）
- 🟡 **已自动匹配（待确认）**：黄色标签

### 8.4 前端组件架构

#### 8.4.1 组件层级结构

```text
FieldMappingConfigSimple.vue (主页面)
├── VersionManagerDrawerSimple.vue (版本管理抽屉)
├── AutoMatchSuggestDialogSimple.vue (智能匹配建议对话框)
├── EditMappingDialog.vue (编辑映射对话框) ⭐ 核心组件
├── ExtendedFieldDialogSimple.vue (拓展字段管理对话框)
└── MatchToTargetDialogSimple.vue (匹配到目标字段对话框)
```

#### 8.4.2 主页面职责

**FieldMappingConfigSimple.vue**

**核心职责**：
- 页面整体布局和Tab管理
- 数据加载和状态管理
- 子组件的协调和通信
- 用户交互事件的处理

**关键功能**：
1. **数据加载**
   - 并行加载5个数据源
   - 错误处理和容错机制
   - 数据合并和状态计算

2. **状态管理**
   - 使用 Pinia 管理全局甲方状态
   - 本地状态管理（加载状态、对话框显示等）
   - 响应式数据更新

3. **子组件通信**
   - Props传递数据到子组件
   - Emits接收子组件事件
   - 事件触发数据刷新

**技术栈**：
- Vue 3 Composition API
- TypeScript
- Element Plus UI组件
- Pinia状态管理

#### 8.4.3 子组件详细说明

##### 1. VersionManagerDrawerSimple (版本管理抽屉)

**功能**：
- ✅ 查看版本历史列表
- ✅ 显示当前使用版本（高亮）
- ✅ 查看版本详细信息
- ✅ 切换到指定版本
- ✅ 下载历史版本JSON

**Props**：
- `modelValue`: 控制抽屉显示/隐藏
- `tenantId`: 甲方ID
- `currentVersion`: 当前版本号

**Emits**：
- `update:modelValue`: 更新显示状态
- `version-changed`: 版本切换成功

**关键API**：
- `getFieldsJsonHistory()` - 获取版本列表
- `activateFieldsJsonVersion()` - 激活指定版本
- `downloadFieldsJsonVersion()` - 下载版本文件

##### 2. AutoMatchSuggestDialogSimple (智能匹配建议对话框)

**功能**：
- ✅ 显示AI智能匹配建议列表
- ✅ 显示匹配方式（完全匹配、相似匹配、同义词）
- ✅ 显示相似度百分比和置信度
- ✅ 支持批量勾选
- ✅ 批量确认应用映射

**Props**：
- `modelValue`: 控制对话框显示
- `tenantId`: 甲方ID

**Emits**：
- `update:modelValue`: 更新显示状态
- `confirm`: 确认应用建议

**关键功能**：
- 表格展示建议列表
- 复选框批量选择
- 相似度进度条可视化
- 置信度标签颜色区分

##### 3. EditMappingDialog (编辑映射对话框) ⭐

**功能**：
- ✅ 显示标准字段详细信息
- ✅ 选择甲方字段（下拉列表，支持搜索）
- ✅ 显示已选字段详情
- ✅ 类型兼容性检查
- ✅ 类型不匹配警告
- ✅ 枚举类型特殊提示
- ✅ 保存映射关系

**Props**：
- `modelValue`: 控制对话框显示
- `tenantId`: 甲方ID
- `standardField`: 要映射的标准字段对象
- `currentMapping`: 当前的映射关系（重新映射时使用）

**Emits**：
- `update:modelValue`: 更新显示状态
- `confirm`: 映射保存成功
- `enum-mapping-needed`: 枚举类型需要进一步配置

**核心逻辑**：
```typescript
// 类型兼容性检查
const showTypeWarning = computed(() => {
  if (!selectedTenantField.value || !props.standardField) return false
  return selectedTenantField.value.field_type !== props.standardField.field_type
})

// 枚举类型检测
const isEnumType = computed(() => {
  return props.standardField?.field_type === 'enum' ||
         selectedTenantField.value?.field_type === 'enum'
})
```

##### 4. ExtendedFieldDialogSimple (拓展字段管理对话框)

**功能**：
- ✅ 添加新的拓展字段
- ✅ 编辑已有拓展字段
- ✅ 表单验证
- ✅ 字段别名、类型、分组配置
- ✅ 隐私标签选择
- ✅ 必填/选填设置

**Props**：
- `modelValue`: 控制对话框显示
- `tenantId`: 甲方ID
- `editData`: 编辑的字段数据（编辑模式）

**Emits**：
- `update:modelValue`: 更新显示状态
- `confirm`: 保存成功

##### 5. MatchToTargetDialogSimple (匹配到目标字段对话框)

**功能**：
- ✅ 显示未使用甲方字段信息
- ✅ 选择标准字段进行匹配
- ✅ 字段类型兼容性检查
- ✅ 数据示例显示

**Props**：
- `modelValue`: 控制对话框显示
- `tenantId`: 甲方ID
- `unmappedField`: 未使用的甲方字段对象
- `standardFields`: 标准字段列表

**Emits**：
- `update:modelValue`: 更新显示状态
- `confirm`: 匹配保存成功

#### 8.4.4 组件通信流程

**场景1：编辑映射**
```text
用户在主页面点击"选择映射"
  ↓
主页面设置 currentStandardField = row
主页面设置 editMappingDialogVisible = true
  ↓
EditMappingDialog 接收 props
  ↓
对话框打开，加载可用甲方字段
  ↓
用户选择甲方字段，点击"确认映射"
  ↓
EditMappingDialog 调用 API 保存
  ↓
保存成功，emit('confirm')
  ↓
主页面接收 confirm 事件
  ↓
主页面调用 loadAllData() 刷新数据
```

**场景2：版本切换**
```text
用户点击"管理版本"
  ↓
主页面设置 versionManagerVisible = true
  ↓
VersionManagerDrawer 打开
  ↓
用户选择历史版本，点击"切换到此版本"
  ↓
VersionManagerDrawer 调用 API 激活版本
  ↓
激活成功，emit('version-changed')
  ↓
主页面接收 version-changed 事件
  ↓
主页面调用 loadAllData() 刷新数据（使用新版本）
```

#### 8.4.5 技术实现要点

1. **响应式数据管理**
   ```typescript
   const isLoading = ref(false)
   const versionInfo = ref<any>(null)
   const mappedFields = ref<any[]>([])
   ```

2. **计算属性优化**
   ```typescript
   const unmappedCount = computed(() => unmappedFields.value.length)
   const currentTenantId = computed(() => tenantStore.currentTenantId)
   ```

3. **生命周期钩子**
   ```typescript
   onMounted(() => {
     loadAllData()  // 页面加载时初始化数据
   })
   ```

4. **错误处理**
   ```typescript
   try {
     await saveFieldConfig(...)
     ElMessage.success('保存成功')
   } catch (error) {
     console.error('保存失败:', error)
     ElMessage.error('保存失败')
   }
   ```

---

## 9. 验收标准

### 9.1 功能验收

- ✅ 能正确加载标准字段（15个）
- ✅ 能正确加载甲方当前生效版本字段
- ✅ 能执行自动匹配并生成建议（准确率≥80%）
- ✅ 能手动选择甲方字段进行映射
- ✅ 能配置Enum类型字段的枚举值映射
- ✅ 能识别并提示未使用的甲方字段
- ✅ 能创建拓展字段
- ✅ 能切换甲方字段版本
- ✅ 能对比两个版本的差异
- ✅ 必填字段映射覆盖率达到100%

### 9.2 性能验收

- ✅ 字段映射列表加载时间 < 1秒（100个字段）
- ✅ 自动匹配计算时间 < 3秒（100个字段）
- ✅ 版本对比计算时间 < 1秒
- ✅ 单个字段映射保存时间 < 500ms

### 9.3 数据验收

- ✅ 映射关系正确保存到数据库
- ✅ 版本切换后映射关系不丢失
- ✅ 拓展字段正确保存到数据库
- ✅ 所有操作都有审计日志记录

---

## 10. 常见问题

### Q1：甲方字段版本更新后，原来的映射关系会丢失吗？
**答**：不会。映射关系独立存储，版本切换不会删除已配置的映射关系。但如果新版本删除了某个字段，该字段的映射会标记为"源字段不存在"，需要重新配置。

### Q2：如何判断应该映射到标准字段还是创建拓展字段？
**答**：
- 如果甲方字段的含义与某个标准字段一致，应该映射到标准字段
- 如果甲方字段是甲方特有的业务字段，无标准字段对应，应该创建拓展字段
- 建议优先使用标准字段，保持数据一致性

### Q3：自动匹配的准确率如何保证？
**答**：系统使用多维度匹配算法（字段名称、类型、同义词等），并设置置信度阈值。相似度≥80%才会自动映射，60-80%需要人工确认，<60%不建议映射。管理员可在同义词配置中添加业务相关的同义词，提高匹配准确率。

### Q4：版本对比功能的使用场景？
**答**：
1. 甲方上传新版本后，查看与上一版本的差异
2. 排查问题时，对比当前版本与历史稳定版本
3. 审计需要，了解甲方字段的变更历史
4. 切换版本前，预览版本间的差异

### Q5：未使用的甲方字段一定要处理吗？
**答**：建议全部处理，避免数据丢失。但如果确认某些字段不需要使用（如系统内部字段、冗余字段等），可以暂不处理。系统会持续提醒未处理字段的数量。

---

---

## 附录：实现说明

### A1. 当前实现版本

**版本号**：v2.0.0
**实现方式**：简化版本（Simplified Version）
**技术栈**：Vue 3 + TypeScript + Element Plus

**已实现功能**：
- ✅ 数据源加载（标准字段 + 甲方字段）
- ✅ 版本管理（查看、切换、下载）
- ✅ 智能匹配建议
- ✅ 编辑映射对话框（核心功能）
- ✅ 拓展字段管理
- ✅ 未使用字段处理
- ⏳ 枚举值映射（预留接口，待实现）

**文件清单**：
```text
frontend/src/views/field-config/
├── FieldMappingConfigSimple.vue          # 主页面
└── components/
    ├── VersionManagerDrawerSimple.vue    # 版本管理
    ├── AutoMatchSuggestDialogSimple.vue  # 智能匹配
    ├── EditMappingDialog.vue             # 编辑映射 ⭐
    ├── ExtendedFieldDialogSimple.vue     # 拓展字段
    └── MatchToTargetDialogSimple.vue     # 未使用字段处理
```

### A2. 与完整版本的差异

| 功能模块 | 完整版本 | 简化版本 | 说明 |
|---------|---------|---------|------|
| 字段分组树 | ✅ 支持 | ⏸️ 暂缓 | 简化版本使用平铺列表 |
| 枚举值映射配置 | ✅ 完整对话框 | ⚠️ 仅提示 | 预留接口，后续迭代 |
| 批量操作 | ✅ 支持 | ⏸️ 暂缓 | 可通过智能匹配实现批量 |
| 版本对比 | ✅ 支持 | ⏸️ 暂缓 | 后续迭代 |
| 审计日志 | ✅ 支持 | ⏸️ 暂缓 | 后续迭代 |

### A3. 后续迭代计划

**Phase 2**（预计2周）：
- [ ] 实现枚举值映射配置完整对话框
- [ ] 添加字段分组折叠树
- [ ] 优化智能匹配算法

**Phase 3**（预计2周）：
- [ ] 版本对比功能
- [ ] 批量操作功能
- [ ] 审计日志查询

**Phase 4**（预计1周）：
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 国际化支持

---

**文档版本**：v2.0.0
**创建日期**：2025-12-08
**最后更新**：2025-12-08 19:00
**状态**：✅ 已优化完成
**作者**：产品团队
**优化记录**：
- 添加"快速开始"章节
- 补充"编辑映射对话框"详细说明
- 优化表格列设计
- 添加前端组件架构说明
- 补充API调用时序
- 说明枚举值映射当前实现状态
- 添加实现说明附录
