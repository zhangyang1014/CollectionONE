# 案件详情字段分组管理 PRD

## 版本记录

| 版本号 | 日期 | 作者 | 变更说明 |
|--------|------|------|---------|
| v1.0.0 | 2025-12-08 | 产品大象 | 初始版本，详情字段分组管理 |

---

## 1. 背景与目标

### 1.1 业务背景

为案件详情字段提供**分组管理能力**，支持对分组元数据（分组名称、排序、父子关系等）的独立管理。案件详情字段以分组为核心，前端按分组卡片展示，分组管理是详情字段配置的基础功能。

### 1.2 核心目标

- 提供分组的CRUD（创建、查看、编辑、删除）能力
- 支持分组排序（拖拽或按钮调整）
- 支持分组层级管理（建议最多两级）
- 为详情字段的标准字段、甲方字段、映射配置、展示配置提供分组基础数据

### 1.3 业务价值

- **提升配置效率**：统一管理分组，避免在各个配置页面重复定义
- **保证一致性**：分组结构统一，避免数据不一致
- **便于扩展**：支持动态新增/调整分组，适应业务变化
- **运营友好**：分组结构清晰，便于理解和维护

---

## 2. 角色与范围

### 2.1 角色定义

| 角色 | 权限 | 说明 |
|------|------|------|
| SuperAdmin | 完全权限 | 可管理所有分组（标准分组+甲方自定义分组） |
| TenantAdmin | 受限权限 | 仅可查看标准分组，可管理本甲方的自定义分组 |
| 产品/研发/QA | 只读权限 | 查看分组结构，用于理解业务逻辑 |

### 2.2 功能范围

- **范围**：控台"案件详情字段分组管理"页面（详情场景专用分组管理）
- **路由**：`/field-config/detail-groups`
- **应用场景**：
  - 案件详情标准字段管理（PRD1）
  - 案件详情甲方字段查看（PRD2）
  - 案件详情字段映射配置（PRD3）
  - 案件详情字段展示配置（PRD4）

---

## 3. 需求概述

### 3.1 核心功能

#### 3.1.1 分组查看

- 以分组树形式展示所有分组
- 显示分组层级关系（支持1-2级）
- 显示每个分组包含的字段数量
- 区分标准分组和自定义分组

#### 3.1.2 分组创建

- 创建新的自定义分组
- 指定分组名称、标识、排序
- 支持指定父分组（创建子分组）
- 自动校验分组标识唯一性

#### 3.1.3 分组编辑

- 编辑分组名称、英文名称
- 调整分组排序
- 修改父子关系（如果没有关联字段）
- 标准分组只能编辑名称，不能删除

#### 3.1.4 分组删除

- 删除自定义分组（有前置校验）
- 校验是否有关联字段
- 校验是否有子分组
- 标准分组不可删除

#### 3.1.5 分组排序

- 支持拖拽调整分组顺序
- 支持按钮上移/下移
- 排序后批量保存
- 实时更新到其他配置页面

---

## 4. 分组模型

### 4.1 分组字段定义

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | BIGINT | ✓ | 分组ID（主键） |
| group_key | VARCHAR(100) | ✓ | 分组标识（唯一，如basic_info） |
| group_name | VARCHAR(200) | ✓ | 分组名称（如"基本信息"） |
| group_name_en | VARCHAR(200) | - | 分组英文名称 |
| parent_id | BIGINT | - | 父分组ID（NULL表示顶级分组） |
| sort_order | INT | ✓ | 排序序号（同级内唯一） |
| is_standard | BOOLEAN | ✓ | 是否标准分组（系统内置） |
| is_active | BOOLEAN | ✓ | 是否启用 |
| scene | VARCHAR(50) | ✓ | 场景标识（固定为'detail'） |
| description | TEXT | - | 分组说明 |
| created_at | DATETIME | ✓ | 创建时间 |
| updated_at | DATETIME | ✓ | 更新时间 |
| created_by | VARCHAR(100) | - | 创建人 |
| updated_by | VARCHAR(100) | - | 更新人 |

### 4.2 分组层级规则

- **最大层级**：2级（建议）
- **顶级分组**：parent_id = NULL
- **子分组**：parent_id = 父分组ID
- **排序规则**：按sort_order升序排列（同层级内）

### 4.3 标准分组（系统内置）

系统预定义5个标准分组（`is_standard=true`）：

| 分组标识 | 分组名称 | 排序 | 字段数 | 说明 |
|---------|---------|------|--------|------|
| basic_info | 基本信息 | 1 | 4 | 案件基础信息 |
| loan_info | 借款信息 | 2 | 7 | 借款相关信息 |
| collection_info | 催收信息 | 3 | 3 | 催收相关信息 |
| contact_info | 联系信息 | 4 | 3 | 联系方式信息 |
| product_info | 产品信息 | 5 | 4 | 产品相关信息 |

**标准分组特点**：
- 不可删除
- 不可修改group_key
- 可修改group_name（多语言场景）
- 可调整sort_order

---

## 5. 前端要求

### 5.1 页面布局

```
┌─────────────────────────────────────────────────────┐
│ 案件详情字段分组管理                    [+ 新建分组] │
├───────────┬─────────────────────────────────────────┤
│ 分组树     │ 分组详情/编辑表单                        │
│           │                                          │
│ 标准分组： │ 【分组详情】                             │
│ ▼ 基本信息│ 分组名称：[基本信息_______________]      │
│   (4字段) │ 分组标识：basic_info (只读)             │
│ ▼ 借款信息│ 英文名称：[Basic Information_______]     │
│   (7字段) │ 父分组：[无▼]                           │
│ ▼ 催收信息│ 排序序号：[1_]                          │
│   (3字段) │ 分组类型：[✓] 标准分组 (只读)           │
│           │ 关联字段：4个字段                        │
│ 自定义：   │                                          │
│ ▼ 其他信息│ [保存] [取消] [删除]                     │
│   (2字段) │                                          │
└───────────┴─────────────────────────────────────────┘
```

### 5.2 分组树设计

**树节点格式**：
```
▼ 分组名称
  (字段数) [类型标签]
```

**示例**：
```
标准分组：
▼ 基本信息 (4字段) [标准]
▼ 借款信息 (7字段) [标准]
  ▶ 借款明细 (3字段) [标准子组]
▼ 催收信息 (3字段) [标准]

自定义分组：
▼ 风控信息 (5字段) [自定义]
▼ 其他信息 (2字段) [自定义]
```

**交互规则**：
- 点击分组节点：右侧显示分组详情
- 拖拽分组节点：调整分组排序
- 右键菜单：编辑、删除、新建子分组

### 5.3 新建/编辑分组表单

```
┌────────────────────────────────────────┐
│ 新建分组                          [×]  │
├────────────────────────────────────────┤
│ 分组名称：[________________] *必填     │
│ 分组标识：[________________] *必填     │
│   （只能包含小写字母、数字、下划线）    │
│                                        │
│ 英文名称：[________________] 可选      │
│                                        │
│ 父分组：  [选择父分组 ▼]     可选      │
│   ○ 无（创建顶级分组）                 │
│   ○ 基本信息                          │
│   ○ 借款信息                          │
│   ○ ...                               │
│                                        │
│ 排序序号：[1_____] *必填               │
│   （同级分组内的显示顺序）              │
│                                        │
│ 分组说明：                             │
│ [_____________________________]       │
│ [_____________________________]       │
│                                        │
│     [取消]          [确定]             │
└────────────────────────────────────────┘
```

### 5.4 删除确认对话框

```
┌────────────────────────────────────────┐
│ 确认删除分组                      [×]  │
├────────────────────────────────────────┤
│ 您确定要删除分组"风控信息"吗？         │
│                                        │
│ ⚠️ 删除前请注意：                      │
│ • 该分组下有 5 个字段                  │
│ • 该分组下有 2 个子分组                │
│                                        │
│ 删除后的影响：                         │
│ • 字段将变为"未分组"状态               │
│ • 子分组将提升为顶级分组               │
│ • 此操作不可撤销                       │
│                                        │
│ 处理方式：                             │
│ ○ 先将字段移至其他分组，再删除         │
│ ● 直接删除（字段变为未分组）           │
│                                        │
│     [取消]          [确认删除]         │
└────────────────────────────────────────┘
```

### 5.5 拖拽排序

**操作方式**：
1. 鼠标悬停在分组节点上，显示拖拽图标（:::）
2. 按住鼠标左键，拖拽分组到目标位置
3. 释放鼠标，分组移动到新位置
4. 系统自动重新计算sort_order
5. 提示"排序已更新，请点击'保存排序'按钮"

**限制**：
- 只能在同级分组内拖拽
- 不能将子分组拖拽到顶级
- 不能将顶级分组拖拽到子级

---

## 6. 后端要求

### 6.1 API接口

#### 6.1.1 获取分组列表

```
GET /api/v1/field-groups?scene=detail

响应：
{
  "code": 200,
  "message": "success",
  "data": {
    "groups": [
      {
        "id": 1,
        "group_key": "basic_info",
        "group_name": "基本信息",
        "group_name_en": "Basic Information",
        "parent_id": null,
        "sort_order": 1,
        "is_standard": true,
        "is_active": true,
        "fields_count": 4,
        "children": []
      }
    ]
  }
}
```

#### 6.1.2 创建分组

```
POST /api/v1/field-groups

请求：
{
  "group_key": "risk_info",
  "group_name": "风控信息",
  "group_name_en": "Risk Information",
  "parent_id": null,
  "sort_order": 6,
  "scene": "detail",
  "description": "风控相关字段"
}

响应：
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 6,
    "group_key": "risk_info",
    ...
  }
}
```

#### 6.1.3 更新分组

```
PUT /api/v1/field-groups/{id}

请求：
{
  "group_name": "风控信息（更新）",
  "group_name_en": "Risk Information",
  "sort_order": 7
}

响应：
{
  "code": 200,
  "message": "更新成功"
}
```

#### 6.1.4 删除分组

```
DELETE /api/v1/field-groups/{id}

响应：
{
  "code": 200,
  "message": "删除成功"
}
```

#### 6.1.5 批量更新排序

```
POST /api/v1/field-groups/batch-sort

请求：
{
  "scene": "detail",
  "groups": [
    {"id": 1, "sort_order": 1},
    {"id": 2, "sort_order": 2},
    {"id": 6, "sort_order": 3}
  ]
}

响应：
{
  "code": 200,
  "message": "排序更新成功"
}
```

### 6.2 业务规则

#### 6.2.1 创建校验

- ✅ group_key全局唯一（同scene下）
- ✅ group_key只能包含小写字母、数字、下划线
- ✅ group_name不能为空
- ✅ sort_order必须是正整数
- ✅ parent_id如果不为空，必须存在且不能形成循环引用

#### 6.2.2 删除校验

- ✅ 标准分组（is_standard=true）不可删除
- ⚠️ 如果分组下有字段，提示处理方式：
  - 方式1：先将字段移至其他分组
  - 方式2：直接删除（字段变为未分组）
- ⚠️ 如果分组下有子分组，提示处理方式：
  - 方式1：先删除子分组
  - 方式2：子分组提升为顶级分组

#### 6.2.3 更新校验

- ✅ 标准分组不可修改group_key
- ✅ 修改parent_id时，不能形成循环引用
- ✅ 修改sort_order时，自动重新计算同级分组排序

### 6.3 数据库设计

**表名**：`field_groups_detail`

```sql
CREATE TABLE field_groups_detail (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_key VARCHAR(100) NOT NULL,
  group_name VARCHAR(200) NOT NULL,
  group_name_en VARCHAR(200),
  parent_id BIGINT,
  sort_order INT NOT NULL DEFAULT 0,
  is_standard BOOLEAN NOT NULL DEFAULT FALSE,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  scene VARCHAR(50) NOT NULL DEFAULT 'detail',
  description TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by VARCHAR(100),
  updated_by VARCHAR(100),
  
  UNIQUE KEY uk_group_key_scene (group_key, scene),
  KEY idx_scene (scene),
  KEY idx_parent (parent_id),
  KEY idx_sort (sort_order),
  FOREIGN KEY (parent_id) REFERENCES field_groups_detail(id) ON DELETE SET NULL
);
```

**初始化数据**（5个标准分组）：

```sql
INSERT INTO field_groups_detail 
  (group_key, group_name, group_name_en, parent_id, sort_order, is_standard, scene) 
VALUES
  ('basic_info', '基本信息', 'Basic Information', NULL, 1, TRUE, 'detail'),
  ('loan_info', '借款信息', 'Loan Information', NULL, 2, TRUE, 'detail'),
  ('collection_info', '催收信息', 'Collection Information', NULL, 3, TRUE, 'detail'),
  ('contact_info', '联系信息', 'Contact Information', NULL, 4, TRUE, 'detail'),
  ('product_info', '产品信息', 'Product Information', NULL, 5, TRUE, 'detail');
```

---

## 7. 交互与校验

### 7.1 新增/编辑必填校验

**必填字段**：
- ✅ 分组名称（group_name）
- ✅ 分组标识（group_key）
- ✅ 排序序号（sort_order）

**格式校验**：
- ✅ group_key：只能包含小写字母、数字、下划线，长度2-100
- ✅ group_name：长度1-200
- ✅ sort_order：正整数

**唯一性校验**：
- ✅ group_key在同scene下全局唯一
- ✅ sort_order在同级分组内建议唯一（系统自动处理冲突）

### 7.2 删除确认

**前置检查**：
1. 检查是否是标准分组
2. 检查分组下是否有字段
3. 检查分组下是否有子分组

**确认弹窗内容**：
```
标准分组：
  "标准分组不可删除"

有字段的分组：
  "该分组下有 X 个字段，请选择处理方式：
   ○ 先将字段移至其他分组，再删除
   ● 直接删除（字段变为未分组）"

有子分组的分组：
  "该分组下有 X 个子分组，请选择处理方式：
   ○ 先删除子分组，再删除此分组
   ● 直接删除（子分组提升为顶级分组）"
```

### 7.3 排序调整

**拖拽排序**：
1. 拖拽分组节点到目标位置
2. 系统自动重新计算sort_order
3. 显示"排序已更新"提示
4. 点击"保存排序"按钮批量保存

**按钮排序**：
1. 点击"上移"或"下移"按钮
2. 分组与相邻分组交换位置
3. 系统自动重新计算sort_order
4. 立即保存（无需额外确认）

---

## 8. 与其他PRD的关系

### 8.1 PRD1（标准字段管理）

**依赖关系**：
- 标准字段必须关联到某个分组（通过group_id）
- 分组删除时，标准字段的group_id置为NULL

**使用场景**：
- 查看标准字段时，按分组显示
- 左侧分组树，点击分组查看对应字段

### 8.2 PRD2（甲方字段查看）

**依赖关系**：
- 甲方上传JSON时，groups数组引用这些分组
- 甲方可以使用标准分组，也可以自定义分组

**使用场景**：
- 上传JSON时，校验group_key是否存在
- 如果group_key不存在，自动创建自定义分组

### 8.3 PRD3（映射配置）

**依赖关系**：
- 映射配置时，按分组显示字段
- 拓展字段需要指定目标分组（选择现有分组）

**使用场景**：
- 分组视图：左侧分组树，选择分组查看字段
- 拓展字段：下拉选择目标分组

### 8.4 PRD4（展示配置）

**依赖关系**：
- 展示配置时，管理分组排序和折叠状态
- 分组结构来源于分组管理

**使用场景**：
- 分组管理对话框：显示所有分组，调整排序
- 分组树：显示分组，点击查看字段

---

## 9. 验收标准

### 9.1 功能验收

- [ ] 可正常查看分组列表（树形结构）
- [ ] 可正常新增自定义分组
- [ ] 可正常编辑分组（标准分组仅可编辑名称）
- [ ] 可正常删除自定义分组（含前置校验）
- [ ] 可正常调整分组排序（拖拽或按钮）
- [ ] 标准分组不可删除、不可修改group_key
- [ ] 分组数据正确落库

### 9.2 交互验收

- [ ] 分组树正确显示层级关系
- [ ] 分组树显示字段数量
- [ ] 点击分组节点，右侧显示分组详情
- [ ] 拖拽排序流畅，实时更新
- [ ] 删除时有确认提示
- [ ] 有字段或子分组时，删除需额外确认

### 9.3 集成验收

- [ ] PRD1：标准字段管理页面正确显示分组
- [ ] PRD2：甲方字段上传JSON时，分组引用正确
- [ ] PRD3：映射配置页面，分组树正常工作
- [ ] PRD4：展示配置页面，分组管理正常工作
- [ ] 分组变更后，其他页面实时更新

### 9.4 数据验收

- [ ] 标准分组数据正确初始化（5个分组）
- [ ] 自定义分组正确保存
- [ ] 分组排序正确保存
- [ ] 删除分组后，关联字段处理正确
- [ ] 父子关系正确维护，无循环引用

---

## 10. 注意事项

### 10.1 标准分组保护

- ⚠️ 标准分组（is_standard=true）不可删除
- ⚠️ 标准分组的group_key不可修改
- ✅ 标准分组的group_name可修改（支持多语言）
- ✅ 标准分组的sort_order可调整

### 10.2 删除安全

- ⚠️ 删除分组前，必须检查是否有关联字段
- ⚠️ 删除分组前，必须检查是否有子分组
- ⚠️ 删除操作不可撤销，需要明确提示

### 10.3 性能优化

- 💡 分组数量建议不超过20个
- 💡 分组层级建议不超过2级
- 💡 单个分组下字段数量建议不超过30个

### 10.4 兼容性

- ✅ 与PRD1-4保持一致的分组结构
- ✅ 分组变更后，其他页面需要实时更新
- ✅ 支持向下兼容（旧数据自动迁移到默认分组）

---

## 附录

### A. 与案件列表的区别

| 对比项 | 案件列表字段管理 | 案件详情字段管理 |
|-------|----------------|----------------|
| 分组管理 | ❌ 无分组管理 | ✅ 有分组管理（本PRD） |
| 分组显示 | ❌ 不显示分组 | ✅ 分组树+分组卡片 |
| 分组数量 | 0个 | 5个标准分组+自定义分组 |
| 前端布局 | 单表格 | 分组树+表格/卡片 |

### B. PRD1-5的关系

```
PRD5（分组管理）- 基础数据
    ↓ 提供分组
PRD1（标准字段）- 引用分组
    ↓ 提供模板
PRD2（甲方字段）- 引用分组
    ↓ 上传JSON
PRD3（映射配置）- 引用分组
    ↓ 映射字段
PRD4（展示配置）- 引用分组
    ↓ 配置展示
前端详情页 - 按分组展示
```

---

**文档版本**: v1.0.0  
**最后更新**: 2025-12-08  
**更新人**: 产品大象  
**变更说明**: 初始版本，案件详情字段分组管理
