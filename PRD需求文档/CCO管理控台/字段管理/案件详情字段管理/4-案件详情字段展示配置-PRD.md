# 案件详情字段展示配置 PRD

## 版本记录

| 版本号 | 日期 | 作者 | 变更说明 |
|--------|------|------|---------|
| v1.0.0 | 2025-12-08 | 产品大象 | 初始版本，基于分组的字段展示配置 |

---

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

案件详情字段展示配置是CCO管理控台的核心功能之一，用于配置控台和催员端案件详情页面的字段展示方式。该功能基于"案件详情字段映射配置"已完成匹配并保存的生效版本，**以分组为核心**，允许管理员对每个分组和字段的显示属性（颜色、隐藏规则等）进行配置。当前版本不支持字段拖拽排序，不支持配置显示宽度（统一自动宽度）。

**业务痛点**：
- 控台和催员端案件详情字段展示需求差异大，需要独立配置机制
- 详情页面字段多（约21个），需要分组管理提升配置效率
- 字段展示属性配置复杂，需要直观的配置界面
- 配置变更频繁，缺乏版本管理和变更追溯能力
- **区别于列表**：详情页面不需要筛选和范围检索配置

**预期影响的核心指标**：
- 字段配置效率：单个字段展示属性配置完成时间≤30秒
- 配置准确率：字段展示配置准确率≥99.5%
- 版本管理效率：版本保存和恢复操作时间≤5秒
- 用户体验：字段展示配置对用户体验提升≥25%
- 用户满意度：管理员对配置功能满意度≥95%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：配置控台案件详情字段展示**
- **入口**：管理控台菜单 → 字段配置 → 案件详情字段配置
- **触发时机**：需要配置控台案件详情页面的字段展示时
- **所在页面**：`/field-config/detail` → 选择场景"控台案件详情"
- **流程节点**：选择分组 → 配置字段属性 → 保存为新版本

**场景2：配置催员端案件详情字段展示**
- **入口**：管理控台菜单 → 字段配置 → 案件详情字段配置
- **触发时机**：需要配置催员端案件详情页面的字段展示时
- **所在页面**：`/field-config/detail` → 选择场景"IM端案件详情"
- **流程节点**：选择分组 → 配置字段属性 → 保存为新版本

**场景3：配置分组展示属性**
- **入口**：字段展示配置页面 → 分组管理
- **触发时机**：需要调整分组的展示属性（折叠状态、排序等）
- **所在页面**：分组管理对话框
- **流程节点**：调整分组排序 → 设置默认折叠状态 → 保存

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 配置所有甲方的字段展示规则，管理版本 | 高 |
| 甲方管理员 | TenantAdmin | 配置本甲方的字段展示规则，管理版本 | 高 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 字段展示配置主流程

```text
管理员进入案件详情字段配置页面
    ↓
系统显示当前基于的映射配置版本（版本号、来源、拉取时间）
    ↓
选择场景类型（admin_case_detail/collector_case_detail）
    ↓
系统加载字段列表（含分组结构）：
  - 优先加载本地激活的展示配置版本
  - 如无本地版本，则从映射配置最新版本获取字段列表
  - 如仍无数据，则使用内置Mock字段
    ↓
显示字段配置表格（分组+字段，含颜色等）
    ↓
支持操作：
  - 选择分组查看对应字段
  - 编辑字段属性（颜色）
  - 管理分组（排序、折叠状态）
  - 保存为新版本
  - 查看版本历史
  - 恢复历史版本
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 场景类型规则

**支持的场景类型**：
- `admin_case_detail`：控台案件详情（用于控台案件详情页面展示）
- `collector_case_detail`：IM端案件详情（用于催员端案件详情页面展示）

#### 4.2 字段来源规则

**字段数据来源优先级**：

1. **本地激活版本（优先级最高）**
   - 位置：本地文件 `~/.cco-storage/case-detail-display-versions/{tenantId}_{sceneType}.json`
   - 条件：存在文件且有激活版本（activeVersion不为null）
   - 内容：管理员保存的展示配置版本快照（含分组）

2. **映射配置最新版本（次优先级）**
   - 位置：`tenant_field_uploads` 表（scene='detail'，is_active=true）
   - 条件：映射配置已完成匹配并保存生效版本
   - 内容：从映射配置的groups字段转换为展示配置
   - 转换规则：
     - 保留分组结构和字段基本信息
     - 补充展示配置默认值（自动宽度、颜色normal）

3. **内置Mock数据（兜底）**
   - 位置：后端代码内置
   - 条件：前两者都不存在时
   - 内容：系统预设的基础字段配置（含6个分组，约123个字段，顺序：客户基础信息 → 影像资料 → 贷款详情 → 分期详情 → 还款记录 → 历史借款记录）

#### 4.3 字段配置属性规则

**可配置属性清单**：

1. **分组属性**
   - `group_key`：分组标识（只读）
   - `group_name`：分组名称（只读）
   - `sort_order`：分组排序（可配置）
   - `is_collapsed_default`：默认折叠状态（可配置）

2. **字段基本属性**（所有字段）
   - `field_key`：字段标识（只读，来自映射配置）
   - `field_name`：字段名称（可编辑）
   - `field_data_type`：字段类型（只读）
   - `field_source`：字段来源（只读，standard/custom）
   - `group_key`：所属分组（只读）
   - `sort_order`：排序顺序（拖拽或手动设置，分组内排序）

3. **显示属性**（所有字段）
   - `display_width`：显示宽度（像素）
     - 范围：0-500
     - 0表示自动宽度
     - 默认值：120px
   - `color_type`：颜色类型
     - 选项：normal（普通）、red（红色）、yellow（黄色）、green（绿色）
     - 默认值：normal

**范围边界**：
- ✅ 支持分组和字段的展示属性配置
- ✅ 支持按分组管理字段
- ❌ **不支持筛选配置**（is_filterable）- 详情页无需筛选
- ❌ **不支持范围检索配置**（is_range_searchable）- 详情页无需检索
- ❌ 不支持隐藏规则
- ❌ 不支持格式化规则（已简化）

---

## 二、功能设计（Feature Design）

### 1. 整体功能架构

```text
案件详情字段展示配置
├── 版本信息显示区
│   ├── 映射配置版本号（基于映射配置）
│   ├── 数据来源标识（上传版本/内置Mock）
│   └── 拉取时间
├── 操作按钮区
│   ├── 保存为新版本
│   ├── 版本历史
│   └── 分组管理
├── 场景选择区
│   └── 场景类型下拉
├── 左侧分组树
│   ├── 分组列表
│   ├── 展开/折叠
│   └── 分组排序
└── 右侧字段配置表格区
    ├── 拖拽列（分组内拖拽）
    ├── 序号列
    ├── 字段名称列
    ├── 字段标识列
    ├── 字段类型列
    ├── 所属分组列（全部视图显示）
    ├── 显示宽度列
    ├── 颜色列
    └── 操作列（编辑按钮）
```

### 2. 页面结构设计

#### 2.1 主页面布局

```text
┌─────────────────────────────────────────────────────────────────┐
│ 案件详情字段配置                                                  │
│ 【基于映射配置：v5】【来源：上传版本】拉取时间：2025-12-08 10:30:00 │
│                        【保存为新版本】【版本历史】【分组管理】     │
├─────────────────────────────────────────────────────────────────┤
│ 场景类型：[控台案件详情 ▼]                                       │
├───────────┬─────────────────────────────────────────────────────┤
│ 分组树     │ 字段配置表格                                          │
│           │                                                       │
│ 视图切换： │ 拖拽 | 序号 | 字段名称 | 字段标识 | 字段类型 |         │
│ ○ 全部    │      |      |          |          |          | 显示宽度│
│ ● 分组    │      |      |          |          |          | 颜色    │
│           │      |      |          |          |          | 操作    │
│ 分组列表： │                                                       │
│ ▼ 基本信息│ :::  |  1   | 案件编号  | case_code| String  | [120]  │
│   (4字段) │      |      |          |          |          | [普通▼]│
│           │      |      |          |          |          | [编辑] │
│ ▼ 借款信息│                                                       │
│   (7字段) │ :::  |  2   | 客户姓名  | user_name| String  | [120]  │
│           │      |      |          |          |          | [普通▼]│
│ ▼ 催收信息│      |      |          |          |          | [编辑] │
│   (3字段) │                                                       │
│           │ ...                                                   │
│ ▼ 联系信息│                                                       │
│   (3字段) │                                                       │
│           │                                                       │
│ ▼ 产品信息│                                                       │
│   (4字段) │                                                       │
└───────────┴─────────────────────────────────────────────────────┘
```

#### 2.2 分组树设计

```text
┌─────────────────┐
│ 视图模式：       │
│ ○ 全部视图      │
│ ● 分组视图      │
├─────────────────┤
│ 分组列表：       │
│ ▼ 基本信息      │
│   4个字段       │
│                 │
│ ▼ 借款信息      │
│   7个字段       │
│                 │
│ ▼ 催收信息      │
│   3个字段       │
│                 │
│ ▼ 联系信息      │
│   3个字段       │
│                 │
│ ▼ 产品信息      │
│   4个字段       │
└─────────────────┘
```

**交互规则**：
- 点击"全部视图"：右侧显示所有字段（含分组列）
- 点击"分组视图"：显示分组树，点击分组查看对应字段
- 默认展开所有分组
- 支持分组折叠/展开

#### 2.3 字段配置表格设计

**表格列说明**：

| 列名 | 宽度 | 类型 | 说明 |
|-----|------|------|------|
| 拖拽 | 60px | 图标 | 三横线拖拽图标（分组内拖拽） |
| 序号 | 60px | 数字 | 分组内序号（1, 2, 3...） |
| 分组 | 100px | 文本 | 仅"全部视图"显示 |
| 字段名称 | 150px | 标签 | 字段中文名称 |
| 字段标识 | 150px | 文本 | field_key |
| 字段类型 | 100px | 标签 | String/Enum/Integer等 |
| 显示宽度 | 150px | 数字输入 | 0-500px，0=自动 |
| 颜色 | 120px | 下拉选择 | normal/red/yellow/green |
| 操作 | 110px | 按钮 | 编辑按钮 |

**关键区别**：
- ❌ **无"可筛选"列** - 详情页不需要筛选功能
- ❌ **无"范围检索"列** - 详情页不需要检索功能
- ✅ **支持分组内拖拽** - 只能在同一分组内调整字段顺序

#### 2.4 编辑字段弹窗设计

```text
┌────────────────────────────────────────────────────────────┐
│  编辑字段配置 - 案件编号                                [×]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  Tab: [基本信息] [样式配置]                                 │
│                                                             │
│  ━━━ 基本信息Tab ━━━                                        │
│                                                             │
│  所属分组：[基本信息] (只读)                                 │
│  场景类型：[控台案件详情] (只读)                             │
│  字段标识：[case_code] (只读)                               │
│  字段名称：[案件编号___________]                            │
│  字段类型：[String] (只读)                                  │
│  字段来源：[标准字段] (只读)                                 │
│  排序顺序：[1_________] (分组内排序)                        │
│  显示宽度：[120_______] px (0表示自动)                      │
│                                                             │
│  ━━━ 样式配置Tab ━━━                                        │
│                                                             │
│  颜色类型：                                                  │
│  ○ 普通（灰色预览）                                          │
│  ○ 红色（红色预览）                                          │
│  ○ 黄色（黄色预览）                                          │
│  ○ 绿色（绿色预览）                                          │
│                                                             │
│                    [取消]  [确定]                           │
└────────────────────────────────────────────────────────────┘
```

**简化说明**：
- 只有2个Tab：基本信息、样式配置
- **无"检索配置"Tab** - 详情页不需要筛选和检索

#### 2.5 分组管理对话框

```text
┌────────────────────────────────────────────────────────────┐
│  分组管理                                              [×]  │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  拖拽 | 分组名称 | 字段数 | 默认折叠 | 操作                 │
│  :::  | 基本信息 | 4     | ☐       | [上移] [下移]       │
│  :::  | 借款信息 | 7     | ☐       | [上移] [下移]       │
│  :::  | 催收信息 | 3     | ☑       | [上移] [下移]       │
│  :::  | 联系信息 | 3     | ☐       | [上移] [下移]       │
│  :::  | 产品信息 | 4     | ☑       | [上移] [下移]       │
│                                                             │
│  说明：                                                      │
│  • 拖拽调整分组显示顺序                                      │
│  • 默认折叠：勾选后该分组在详情页默认折叠显示                 │
│  • 分组结构来源于映射配置，不可新增/删除分组                  │
│                                                             │
│                    [取消]  [保存]                           │
└────────────────────────────────────────────────────────────┘
```

**分组管理功能**：
- 调整分组显示顺序（拖拽或按钮）
- 设置分组默认折叠状态
- 查看每个分组包含的字段数
- **不支持新增/删除分组**（分组结构固定，来源于映射配置）

---

## 三、接口设计（API Design）

### 3.1 获取字段配置列表（含分组）

**接口路径**：`GET /api/v1/case-detail-field-configs`

**请求参数**：
```json
{
  "tenantId": 1,
  "sceneType": "admin_case_detail"
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "groups": [
      {
        "group_key": "basic_info",
        "group_name": "基本信息",
        "sort_order": 1,
        "is_collapsed_default": false,
        "fields": [
          {
            "id": 1,
            "tenant_id": 1,
            "scene_type": "admin_case_detail",
            "group_key": "basic_info",
            "field_key": "case_code",
            "field_name": "案件编号",
            "field_data_type": "String",
            "field_source": "standard",
            "sort_order": 1,
            "display_width": 120,
            "color_type": "normal",
            "is_required": true
          }
        ]
      }
    ]
  }
}
```

### 3.2 保存为新版本（含分组配置）

**接口路径**：`POST /api/v1/case-detail-field-configs/version/save`

**请求参数**：
```json
{
  "tenant_id": 1,
  "scene_type": "admin_case_detail",
  "groups": [
    {
      "group_key": "basic_info",
      "group_name": "基本信息",
      "sort_order": 1,
      "is_collapsed_default": false,
      "fields": [
        {
          "field_key": "case_code",
          "field_name": "案件编号",
          "field_data_type": "String",
          "field_source": "standard",
          "sort_order": 1,
          "display_width": 140,
          "color_type": "normal"
        }
      ]
    }
  ],
  "operator": "admin",
  "note": "调整分组排序和字段宽度"
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "保存成功",
  "data": {
    "version": 3,
    "saved_at": "2025-12-08T10:35:00"
  }
}
```

### 3.3 版本文件数据结构

**文件位置**：`~/.cco-storage/case-detail-display-versions/{tenantId}_{sceneType}.json`

**文件格式**：
```json
{
  "versions": [
    {
      "version": 1,
      "saved_at": "2025-12-08T10:00:00",
      "operator": "system",
      "note": "初始配置版本",
      "groups": [
        {
          "group_key": "basic_info",
          "group_name": "基本信息",
          "sort_order": 1,
          "is_collapsed_default": false,
          "fields": [
            {
              "field_key": "case_code",
              "field_name": "案件编号",
              "sort_order": 1,
              "display_width": 120,
              "color_type": "normal"
            }
          ]
        }
      ]
    }
  ],
  "activeVersion": 1
}
```

---

## 四、交互设计（Interaction Design）

### 1. 分组内拖拽排序

```text
用户在分组视图下选择"基本信息"分组
    ↓
右侧显示该分组下的4个字段
    ↓
用户拖拽"案件编号"字段到第3位
    ↓
系统自动重新计算该分组内字段的sort_order
    ↓
表格顺序实时更新
    ↓
提示：拖拽成功，请点击"保存为新版本"保存更改
```

**限制**：
- 只能在同一分组内拖拽排序
- 不能跨分组拖拽
- 全部视图下禁用拖拽（需要先选择分组）

### 2. 分组管理交互

```text
用户点击"分组管理"按钮
    ↓
打开分组管理对话框
    ↓
用户拖拽"借款信息"分组到第1位
    ↓
用户勾选"催收信息"的"默认折叠"
    ↓
点击"保存"
    ↓
系统更新分组配置
    ↓
关闭对话框
    ↓
提示：分组配置已更新，请点击"保存为新版本"使配置生效
```

### 3. 版本保存交互

**保存对话框**：
```text
┌───────────────────────────────────────────┐
│  保存为新版本                              │
├───────────────────────────────────────────┤
│  当前配置包含 5 个分组，共 21 个字段       │
│                                            │
│  版本备注：                                │
│  [调整分组排序和字段宽度________________]  │
│  (可选，建议填写)                          │
│                                            │
│  变更摘要：                                │
│  • 调整了2个分组的排序                     │
│  • 修改了3个字段的显示宽度                 │
│  • 设置了1个分组的默认折叠状态             │
│                                            │
│     [取消]            [确定保存]           │
└───────────────────────────────────────────┘
```

---

## 五、数据流转说明

### 1. 字段数据流转（含分组）

```text
案件详情字段映射配置（上游）
    ↓
甲方上传JSON（含分组）→ 匹配标准字段 → 保存映射版本 → 激活版本
    ↓
tenant_field_uploads表（scene='detail', is_active=true）
    ↓
存储字段映射关系（含分组结构）：
  - groups数组
  - 每个分组含fields数组
    ↓
案件详情字段展示配置（本功能）
    ↓
读取映射配置最新版本 → 转换为展示配置 → 补充展示属性默认值
    ↓
管理员配置展示属性：
  - 分组排序
  - 分组默认折叠状态
  - 字段显示宽度
  - 字段颜色
  - 字段排序（分组内）
    ↓
保存为展示配置新版本（含分组配置）
    ↓
本地版本文件（~/.cco-storage/case-detail-display-versions/）
    ↓
激活版本 → 案件详情页面读取 → 控制字段展示
```

---

## 六、测试验证点

### 1. 功能测试

**基础功能测试**：
- [ ] 页面正常加载，显示分组树和字段配置列表
- [ ] 映射配置版本信息正确显示
- [ ] 场景切换正常工作
- [ ] 分组树正确显示，支持折叠/展开
- [ ] 点击分组查看对应字段

**配置编辑测试**：
- [ ] 编辑按钮打开弹窗，预填充正确
- [ ] 修改宽度、颜色等属性成功保存
- [ ] **无筛选和检索配置选项**（已移除）
- [ ] 分组内拖拽排序正常工作
- [ ] 不能跨分组拖拽

**分组管理测试**：
- [ ] 分组管理对话框正确显示
- [ ] 调整分组排序成功
- [ ] 设置默认折叠状态成功
- [ ] 分组配置正确保存

**版本管理测试**：
- [ ] 保存按钮弹出确认对话框
- [ ] 输入备注并保存成功
- [ ] 保存后生成新版本号
- [ ] 版本历史正确显示（含分组信息）
- [ ] 恢复版本正确工作

### 2. 边界测试

**数据边界**：
- [ ] 映射配置不存在时显示Mock数据（含分组）
- [ ] 本地版本文件不存在时创建新文件
- [ ] 版本列表为空时显示空状态
- [ ] 分组列表为空时显示空状态

---

## 七、产品验收标准

### 1. 功能完整性

- [x] 支持2个场景的独立配置（控台、催员端）
- [x] 支持基于映射配置版本获取字段列表（含分组）
- [x] 支持字段展示属性配置（宽度、颜色）
- [x] **不支持筛选和检索配置**（详情场景特性）
- [x] 支持分组内拖拽排序
- [x] 支持分组管理（排序、折叠状态）
- [x] 支持保存为新版本（含分组配置）
- [x] 支持查看版本历史
- [x] 支持恢复历史版本

### 2. 交互体验

- [x] 分组树交互流畅，支持折叠/展开
- [x] 分组内拖拽排序交互清晰
- [x] 禁止跨分组拖拽，有明确提示
- [x] 分组管理对话框操作直观
- [x] 版本保存显示变更摘要

### 3. 数据准确性

- [x] 字段列表来源准确（含分组结构）
- [x] 分组配置正确保存和恢复
- [x] 版本快照完整（含分组和字段）
- [x] 恢复后分组结构一致

---

## 八、与列表字段展示配置的区别

| 项目 | 列表字段展示配置 | 详情字段展示配置 |
|-----|----------------|----------------|
| 场景标识 | scene=list | scene=detail |
| 分组结构 | 无分组 | 有分组（核心） |
| 字段数量 | 15个 | 21个 |
| 拖拽排序 | 全局排序 | 分组内排序 |
| 可筛选配置 | ✅ 支持 | ❌ 不支持 |
| 范围检索配置 | ✅ 支持 | ❌ 不支持 |
| 分组管理 | ❌ 无 | ✅ 支持 |
| 页面布局 | 单表格 | 分组树+表格 |
| 版本文件 | case-list-display-versions | case-detail-display-versions |

---

**文档版本**: v1.0.0  
**最后更新**: 2025-12-08  
**更新人**: 产品大象  
**变更说明**: 初始版本，基于分组的字段展示配置，不支持筛选和检索配置
