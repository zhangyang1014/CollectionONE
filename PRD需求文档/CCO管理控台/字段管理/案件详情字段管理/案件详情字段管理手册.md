# 案件详情字段管理手册

## 版本记录

| 版本号 | 日期 | 作者 | 变更说明 |
|--------|------|------|---------|
| v1.0.0 | 2025-12-08 | 产品大象 | 初始版本，包含完整的基于分组的字段管理流程说明 |

> **适用场景**: 控台案件详情、IM端案件详情

---

## 一、架构概述

### 1.1 整体架构

案件详情字段管理系统采用**五层架构**，以**分组为核心**，实现从分组基础数据到前端详情页展示的完整链路：

```
分组管理（group management，基础数据层）
    ↓
标准字段（含分组结构）
    ↓
甲方字段（含分组的JSON文件）
    ↓
标准字段映射（mapping，支持分组视图）
    ↓
字段展示配置（display config，含分组管理）
    ↓
前端详情页展示（分组卡片展示）
```

### 1.2 核心概念

| 层级 | 名称 | 作用 | 数据来源 | 核心特点 |
|------|------|------|----------|----------|
| **Layer 0** | 分组管理 | 管理分组基础数据（CRUD） | 系统内置+自定义（`field_groups_detail`表） | 7个标准分组+自定义分组 |
| **Layer 1** | 标准字段 | 系统预定义的字段规范（含分组） | 系统内置（`standard_fields_detail`表） | 7个分组，128个字段 |
| **Layer 2** | 甲方字段 | 各甲方的原始字段数据（含分组） | 甲方上传JSON文件 | JSON必须包含groups数组 |
| **Layer 3** | 映射配置 | 将甲方字段映射到标准字段 | 人工配置（`tenant_field_uploads`表） | 支持分组视图配置 |
| **Layer 4** | 展示配置 | 控制字段在详情页的展示 | 管理员配置（本地JSON文件） | 分组管理+字段属性 |

### 1.3 分组是核心

与案件列表字段管理（无分组）不同，案件详情字段管理以**分组**为核心设计理念：

```
分组结构贯穿五层
│
├── Layer 0: 分组管理（基础数据）
│   ├── 7个标准分组（系统内置，顺序为：客户基础信息 → 影像资料 → 贷款详情 → 分期详情 → 还款记录 → 历史借款记录 → 放款记录）
│   ├── 自定义分组（甲方可创建）
│   ├── 分组CRUD（创建、编辑、删除）
│   └── 分组排序（拖拽或按钮）
│
├── Layer 1: 标准字段按7个分组组织（共128个字段）
│   ├── 客户基础信息（37字段，含子分组：基础身份/教育/职业/行为信用/联系方式）
│   ├── 影像资料（8字段，全部图片选填，无子分组）
│   ├── 贷款详情（23字段）
│   ├── 分期详情（16字段）
│   ├── 还款记录（13字段）
│   ├── 历史借款记录（26字段）
│   └── 放款记录（5字段）
│
├── Layer 2: 甲方JSON必须包含groups数组
│   └── 一次上传含多个分组的完整配置
│
├── Layer 3: 映射配置支持分组视图
│   ├── 全部视图：查看所有字段
│   └── 分组视图：按分组配置映射
│
└── Layer 4: 展示配置含分组管理
    ├── 分组排序
    ├── 分组默认折叠状态
    └── 分组内字段排序
```

---

## 二、分组管理（Layer 0）

### 2.1 定义

**分组管理**是案件详情字段配置的基础数据层，提供对分组的增删改查能力。分组是详情字段管理的核心概念，所有字段都必须归属于某个分组。

### 2.2 分组类型

#### 2.2.1 标准分组（系统内置）

系统预定义7个标准分组，不可删除，group_key不可修改，默认展示顺序如下：

| 分组标识 | 分组名称 | 排序 | 用途 |
|---------|---------|------|------|
| customer_info | 客户基础信息 | 1 | 客户基础/身份/教育/职业/行为信用/联系方式 |
| image_materials | 影像资料 | 2 | 证件照、活体照片、补充资料图片 |
| loan_detail | 贷款详情 | 3 | 贷款订单相关字段 |
| installment_detail | 分期详情 | 4 | 分期维度字段 |
| repayment_record | 还款记录 | 5 | 还款行为记录 |
| loan_history | 历史借款记录 | 6 | 历史借款及关联信息 |
| disbursement_record | 放款记录 | 7 | 记录放款相关信息，包括金额、订单号、收款机构等 |

#### 2.2.2 自定义分组

- 甲方可创建自定义分组（如"风控信息"、"其他信息"）
- 支持删除（需校验是否有关联字段）
- 支持修改分组名称和排序

### 2.3 分组管理功能

- **查看**：以分组树形式展示所有分组
- **创建**：创建新的自定义分组
- **编辑**：修改分组名称、排序
- **删除**：删除自定义分组（有前置校验）
- **排序**：拖拽或按钮调整分组顺序

### 2.4 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件详情字段分组管理
- **路由**: `/field-config/detail-groups`
- **权限**: SuperAdmin（完全权限）/ TenantAdmin（受限权限）
- **PRD文档**: 5-案件详情字段分组管理-PRD.md

---

## 三、标准字段（Layer 1）

### 3.1 定义

**标准字段**是CCO系统预定义的字段规范，用于统一不同甲方的字段命名和数据类型。案件详情标准字段共**21个字段，分为5个分组**。标准字段必须关联到分组管理（Layer 0）中定义的分组。

### 3.2 分组结构

#### 分组1：基本信息（4个字段）

| 字段标识 | 字段名称 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| case_code | 案件编号 | String | ✓ | 案件唯一标识 |
| user_name | 客户姓名 | String | ✓ | 借款人姓名 |
| id_card | 身份证号 | String | ✓ | 借款人身份证 |
| case_status | 案件状态 | Enum | ✓ | 案件当前状态 |

#### 分组2：借款信息（7个字段）

| 字段标识 | 字段名称 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| loan_amount | 贷款金额 | Decimal | ✓ | 借款总金额 |
| outstanding_amount | 未还金额 | Decimal | ✓ | 当前未还金额 |
| overdue_days | 逾期天数 | Integer | ✓ | 当前逾期天数 |
| due_date | 到期日期 | Date | ✓ | 应还款日期 |
| total_installments | 期数 | Integer | ✓ | 总期数 |
| term_days | 当期天数 | Integer | ✓ | 当前期数天数 |
| loan_id | 关联借款ID | String | ✓ | 关联的借款订单ID |

#### 分组3：催收信息（3个字段）

| 字段标识 | 字段名称 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| collector_name | 催收员姓名 | String | ✓ | 当前负责催收员 |
| collection_stage | 催收阶段 | Enum | ✓ | M1/M2/M3等 |
| last_contact_time | 最后联系时间 | Datetime | ✓ | 最后一次联系时间 |

#### 分组4：联系信息（3个字段）

| 字段标识 | 字段名称 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| mobile_number | 手机号 | String | ✓ | 借款人手机号 |
| emergency_contact | 紧急联系人 | String | ✓ | 紧急联系人姓名 |
| emergency_phone | 紧急联系电话 | String | ✓ | 紧急联系人电话 |

#### 分组5：产品信息（4个字段）

| 字段标识 | 字段名称 | 类型 | 必填 | 说明 |
|---------|---------|------|------|------|
| system_name | 所属系统 | String | ✓ | 所属业务系统 |
| product_name | 产品 | String | ✓ | 借款产品名称 |
| app_name | APP | String | ✓ | 借款APP名称 |
| merchant_name | 商户 | String | ✓ | 商户名称 |

### 3.3 数据类型

| 类型 | 说明 | 详情页特点 | 示例 |
|------|------|----------|------|
| **String** | 文本 | 普通文本展示 | 案件编号、客户姓名 |
| **Integer** | 整数 | 数字展示 | 逾期天数、期数 |
| **Number** | 数字（含小数） | 数字展示 | - |
| **Decimal** | 精确小数 | 金额展示 | 贷款金额、未还金额 |
| **Enum** | 枚举 | 标签/徽章展示 | 案件状态、催收阶段 |
| **Date** | 日期 | 日期格式化 | 到期日期 |
| **Datetime** | 日期时间 | 时间格式化 | 最后联系时间 |
| **Boolean** | 布尔值 | 是/否展示 | - |

### 3.4 核心属性

```json
{
  "group_key": "basic_info",
  "group_name": "基本信息",
  "sort_order": 1,
  "fields": [
    {
      "field_key": "case_code",
      "field_name": "案件编号",
      "field_type": "String",
      "description": "案件唯一标识",
      "is_required": true
    }
  ]
}
```

### 3.5 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件详情标准字段管理
- **路由**: `/field-config/standard-detail`
- **权限**: SuperAdmin（仅超级管理员）
- **页面布局**: 左侧分组树 + 右侧字段表格
- **PRD文档**: 1-案件详情标准字段管理-PRD.md

---

## 四、甲方字段（Layer 2）

### 4.1 定义

**甲方字段**是各甲方系统中的原始字段数据，通过**含分组的JSON文件**上传到CCO系统。与列表字段不同，详情字段的JSON**必须包含groups数组**。

### 4.2 JSON格式规范（含分组）

```json
{
  "version": "1.0",
  "scene": "detail",
  "tenant_id": "1",
  "tenant_name": "示例甲方",
  "updated_at": "2025-12-08T10:00:00",
  "description": "案件详情字段配置",
  "groups": [
    {
      "group_key": "basic_info",
      "group_name": "基本信息",
      "group_name_en": "Basic Information",
      "sort_order": 1,
      "is_collapsed_default": false,
      "description": "案件基础信息",
      "fields": [
        {
          "field_name": "案件编号",
          "field_key": "CASE_ID",
          "field_type": "String",
          "enum_values": null,
          "is_required": true,
          "sort_order": 1,
          "description": "案件唯一标识",
          "data_example": "CASE20251208001"
        },
        {
          "field_name": "客户姓名",
          "field_key": "CUSTOMER_NAME",
          "field_type": "String",
          "enum_values": null,
          "is_required": true,
          "sort_order": 2,
          "description": "借款人姓名"
        }
      ]
    },
    {
      "group_key": "loan_info",
      "group_name": "借款信息",
      "group_name_en": "Loan Information",
      "sort_order": 2,
      "is_collapsed_default": false,
      "description": "借款相关信息",
      "fields": [
        {
          "field_name": "贷款金额",
          "field_key": "LOAN_AMT",
          "field_type": "Decimal",
          "enum_values": null,
          "is_required": true,
          "sort_order": 1,
          "description": "借款总金额"
        }
      ]
    }
  ]
}
```

### 4.3 JSON结构要求

#### 4.3.1 顶层字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| version | String | ✓ | 配置版本号（如"1.0"） |
| scene | String | ✓ | 必须为"detail" |
| tenant_id | String | ✓ | 甲方ID |
| tenant_name | String | ✓ | 甲方名称 |
| updated_at | String | ✓ | 更新时间（ISO格式） |
| description | String | 可选 | 配置说明 |
| **groups** | Array | **✓** | **分组数组（必填）** |

#### 4.3.2 groups数组要求

每个分组对象必须包含：

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| group_key | String | ✓ | 分组标识（唯一） |
| group_name | String | ✓ | 分组名称 |
| group_name_en | String | 可选 | 分组英文名 |
| sort_order | Integer | ✓ | 分组排序 |
| is_collapsed_default | Boolean | 可选 | 默认折叠状态 |
| description | String | 可选 | 分组说明 |
| **fields** | Array | **✓** | **字段数组（必填）** |

#### 4.3.3 fields数组要求

每个字段对象必须包含：

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| field_name | String | ✓ | 字段名称 |
| field_key | String | ✓ | 字段标识（分组内唯一） |
| field_type | String | ✓ | 字段类型 |
| enum_values | Array | 条件 | 枚举值（Enum类型必填） |
| is_required | Boolean | ✓ | 是否必填 |
| sort_order | Integer | ✓ | 字段排序 |
| description | String | 可选 | 字段说明 |
| data_example | String | 可选 | 数据示例 |

### 4.4 上传方式

1. **手动上传**: 通过管理控台上传JSON文件（推荐）
2. **API对接**: 通过API接口推送字段配置（需开启功能开关）

### 4.5 验证规则

#### 4.5.1 结构验证

- ✅ **必须包含groups数组**（否则拒绝上传）
- ✅ **每个分组必须包含fields数组**（否则拒绝上传）
- ✅ **group_key在文件中唯一**
- ✅ **field_key在同一分组内唯一**
- ✅ **至少包含1个分组**
- ✅ **每个分组至少包含1个字段**

#### 4.5.2 数据验证

- ✅ 字段类型必须是系统支持的类型（String/Integer/Decimal/Enum/Date/Datetime/Boolean）
- ✅ Enum类型必须提供enum_values
- ✅ enum_values数组不能为空
- ✅ sort_order必须是正整数

#### 4.5.3 大小限制

- **文件大小**: ≤ 5MB（列表字段为2MB）
- **分组数量**: 建议 ≤ 10个
- **字段总数**: 建议 ≤ 50个
- **单个分组字段数**: 建议 ≤ 15个

### 4.6 版本管理

- **版本存储**: `tenant_field_uploads` 表（scene='detail'）
- **版本号**: 整数，从1开始自增
- **激活机制**: 同一甲方+scene='detail'只能有一个激活版本
- **历史查看**: 支持查看所有历史版本（含分组结构）
- **版本对比**: 支持版本间对比（分组级别+字段级别）

### 4.7 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件详情甲方字段查看
- **路由**: `/field-config/tenant-fields-detail`
- **权限**: SuperAdmin / TenantAdmin
- **页面布局**: 左侧分组树 + 右侧字段表格
- **PRD文档**: 2-案件详情甲方字段查看-PRD.md

---

## 五、映射配置（Layer 3）

### 5.1 定义

**映射配置**将甲方字段（含分组）映射到标准字段，实现字段的统一化和标准化。案件详情映射配置支持**全部视图和分组视图**两种配置模式。

### 5.2 映射关系

```
甲方字段（含分组）         →    标准字段（含分组）
CASE_ID（基本信息）        →    case_code（基本信息）
CUSTOMER_NAME（基本信息）  →    user_name（基本信息）
LOAN_AMT（借款信息）       →    loan_amount（借款信息）
```

### 5.3 视图模式

#### 5.3.1 全部视图

显示所有标准字段（含分组列），支持跨分组映射：

```
┌─────────────────────────────────────────────────────┐
│ 分组     | 标准字段 | 映射关系 | 甲方字段 | 状态   │
│ 基本信息 | 案件编号 | ✓       | CASE_ID  | 自动   │
│ 基本信息 | 客户姓名 | ✗       | [选择▼]  | 未映射 │
│ 借款信息 | 贷款金额 | ✓       | LOAN_AMT | 手动   │
│ ...                                                 │
└─────────────────────────────────────────────────────┘
```

#### 5.3.2 分组视图

左侧分组树，点击分组查看对应字段：

```
┌───────────┬─────────────────────────────────────────┐
│ 分组树     │ 字段映射表格（仅显示当前分组）           │
│           │                                          │
│ ▼ 基本信息│ 标准字段 | 映射关系 | 甲方字段 | 状态   │
│   (4/4)   │ 案件编号 | ✓       | CASE_ID  | 自动   │
│ ▼ 借款信息│ 客户姓名 | ✓       | CUST_NM  | 手动   │
│   (5/7)   │ 身份证号 | ✗       | [选择▼]  | 未映射 │
│           │ 案件状态 | ✓       | STATUS   | 自动   │
└───────────┴─────────────────────────────────────────┘
```

### 5.4 映射类型

| 映射类型 | 说明 | 示例 | 分组处理 |
|---------|------|------|---------|
| **1:1映射** | 一个甲方字段映射到一个标准字段 | `CASE_ID` → `case_code` | 可同分组或跨分组 |
| **标准字段** | 直接使用标准字段（key相同） | `case_code` → `case_code` | 保持原分组 |
| **拓展字段** | 不映射到标准字段，作为自定义字段 | `CUSTOM_FIELD` → 无映射 | 需指定目标分组 |

### 5.5 映射配置流程

```
【步骤1】选择视图模式
  - 全部视图：查看所有字段，支持跨分组映射
  - 分组视图：选择分组，配置该分组字段
    ↓

【步骤2】智能匹配（可选）
  - 选择匹配范围（全部/当前分组/未映射字段）
  - 系统自动匹配，按分组显示建议
  - 管理员确认匹配建议
    ↓

【步骤3】手动映射
  - 选择标准字段
  - 选择甲方字段（支持跨分组选择）
  - 配置枚举值映射（Enum类型）
  - 保存映射关系
    ↓

【步骤4】处理未使用字段
  - 查看未使用的甲方字段（按分组显示）
  - 选择处理方式：
    a) 映射到标准字段（可跨分组）
    b) 创建拓展字段（需指定目标分组）
    ↓

【步骤5】保存为新版本
  - 检查分组维度的映射完成度
  - 确认所有必填字段已映射
  - 保存为v1版本并激活
```

### 5.6 智能匹配（分组支持）

#### 5.6.1 匹配范围

- **全部字段**: 匹配所有21个标准字段
- **当前分组**: 仅匹配当前选中分组的字段
- **未映射字段**: 仅匹配尚未映射的字段

#### 5.6.2 匹配建议显示（按分组）

```
┌────────────────────────────────────────────────┐
│ 自动匹配建议 - 发现 15 个匹配建议（3个分组）    │
├────────────────────────────────────────────────┤
│ 匹配摘要：                                      │
│ ✅ 自动映射（相似度≥80%）：10个                 │
│ 🔍 建议映射（相似度60-80%）：5个                │
│ ❌ 未匹配：6个标准字段                           │
│                                                 │
│ 📁 基本信息 (4个建议)                           │
│ ☑ case_code → CASE_ID (100%)                  │
│ ☑ user_name → CUSTOMER_NAME (70%)             │
│                                                 │
│ 📁 借款信息 (7个建议)                           │
│ ☑ loan_amount → LOAN_AMT (75%)                │
│ ☑ outstanding_amount → OUTSTANDING (80%)      │
│                                                 │
│ 📁 联系信息 (4个建议)                           │
│ ☑ mobile_number → PHONE_NUMBER (70%)          │
└────────────────────────────────────────────────┘
```

### 5.7 跨分组映射

**支持场景**: 甲方的字段分组可能与标准分组不一致

**示例**:
```
甲方字段：PHONE（甲方分组：基本信息）
标准字段：mobile_number（标准分组：联系信息）
映射：允许跨分组映射
```

**操作方式**:
1. 在全部视图下，可选择任意甲方字段
2. 在分组视图下，甲方字段下拉列表按分组组织，支持选择其他分组的字段
3. 映射后显示"跨分组映射"提示

### 5.8 拓展字段（需指定分组）

**场景**: 甲方有特有字段，无法映射到标准字段

**处理方式**:
```
┌────────────────────────────────────────────┐
│ 处理未使用字段 - CUSTOMER_LEVEL            │
├────────────────────────────────────────────┤
│ 甲方字段信息：                              │
│ • 所属分组：基本信息                        │
│ • 字段名称：客户等级                        │
│ • 字段标识：CUSTOMER_LEVEL                 │
│                                             │
│ 选择处理方式：                              │
│ ● 方式二：设为拓展字段                      │
│   扩展字段别名：[customer_level_______]    │
│   所属分组：[基本信息 ▼]                   │
│     • 基本信息（来源分组，推荐）            │
│     • 借款信息                             │
│     • 催收信息                             │
│   隐私标签：[公开 ▼]                       │
│   ☑ 是否必填                               │
└────────────────────────────────────────────┘
```

### 5.9 版本管理

#### 5.9.1 保存条件检查（分组维度）

```
┌─────────────────────────────────────────┐
│ 映射完成度统计                           │
├─────────────────────────────────────────┤
│ 📁 基本信息：4/4 (100%) ✅              │
│ 📁 借款信息：5/7 (71%) ⚠️ 缺少2个必填字段│
│ 📁 催收信息：2/3 (67%) ⚠️ 缺少1个可选字段│
│ 📁 联系信息：3/3 (100%) ✅              │
│ 📁 产品信息：4/4 (100%) ✅              │
├─────────────────────────────────────────┤
│ 总计：18/21 (86%)                       │
│ ❌ 还有3个字段未映射，无法保存           │
└─────────────────────────────────────────┘
```

#### 5.9.2 版本历史（显示分组完成度）

```
┌───────────────────────────────────────────────────┐
│ 版本 | 保存时间 | 操作人 | 映射进度 | 状态       │
├───────────────────────────────────────────────────┤
│ v5  | 2025-12-08 | admin | 21/21 (100%) | 生效中│
│     | 15:30:00   |       | 5个分组全部完成 |     │
├───────────────────────────────────────────────────┤
│ v4  | 2025-12-07 | admin | 18/21 (86%)  | 历史版│
│     | 14:20:00   |       | 3个分组未完成   |     │
└───────────────────────────────────────────────────┘
```

### 5.10 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件详情字段映射配置
- **路由**: `/field-config/mapping-detail`
- **权限**: SuperAdmin / TenantAdmin
- **页面布局**: 左侧分组树（可选） + 右侧字段映射表格
- **PRD文档**: 3-案件详情字段映射配置-PRD.md

---

## 六、展示配置（Layer 4）

### 6.1 定义

**展示配置**控制字段在案件详情页面中的展示方式，包括分组管理、字段属性配置等。与列表字段展示配置的核心区别是：**不支持筛选和范围检索配置**（详情页不需要这些功能）。

### 6.2 核心功能

#### 6.2.1 分组管理

```
┌────────────────────────────────────────────┐
│ 分组管理                                    │
├────────────────────────────────────────────┤
│ 拖拽 | 分组名称 | 字段数 | 默认折叠 | 操作 │
│ :::  | 基本信息 | 4     | ☐       | ↑ ↓ │
│ :::  | 借款信息 | 7     | ☐       | ↑ ↓ │
│ :::  | 催收信息 | 3     | ☑       | ↑ ↓ │
│ :::  | 联系信息 | 3     | ☐       | ↑ ↓ │
│ :::  | 产品信息 | 4     | ☑       | ↑ ↓ │
└────────────────────────────────────────────┘
```

**可配置项**:
- 分组显示顺序（拖拽或按钮调整）
- 默认折叠状态（勾选后该分组在详情页默认折叠）

**限制**:
- 不支持新增/删除分组（分组结构来源于映射配置）
- 不支持修改分组名称

#### 6.2.2 字段属性配置

可配置的字段属性：

| 属性名 | 类型 | 说明 | 适用字段 | 默认值 |
|--------|------|------|---------|--------|
| **field_name** | String | 字段名称 | 全部 | 来自映射配置 |
| **sort_order** | Integer | 排序顺序（分组内） | 全部 | 1, 2, 3... |
| **display_width** | Integer | 显示宽度（px） | 全部 | 120px |
| **color_type** | Enum | 颜色类型 | 全部 | normal |

**颜色类型选项**:
- `normal`：普通（灰色）
- `red`：红色（警告）
- `yellow`：黄色（提示）
- `green`：绿色（正常）

### 6.3 核心区别（详情 vs 列表）

| 配置项 | 列表字段展示配置 | 详情字段展示配置 |
|--------|----------------|----------------|
| **分组管理** | ❌ 无 | ✅ 支持 |
| **排序方式** | 全局拖拽 | 分组内拖拽 |
| **可筛选配置** | ✅ 支持 | ❌ 不支持 |
| **范围检索配置** | ✅ 支持 | ❌ 不支持 |
| **隐藏规则** | ✅ 支持 | ❌ 不支持 |
| **宽度配置** | ✅ 支持 | ✅ 支持 |
| **颜色配置** | ✅ 支持 | ✅ 支持 |

**原因说明**:
- **筛选**: 详情页展示单个案件的所有信息，无需筛选
- **范围检索**: 详情页不是列表页，无需检索功能
- **隐藏规则**: 详情页通常展示完整信息，不需要隐藏字段

### 6.4 数据来源优先级

```
优先级1: 本地激活版本（~/.cco-storage/case-detail-display-versions/）
    ↓ 如果不存在
优先级2: 映射配置最新版本（tenant_field_uploads表，scene='detail'）
    ↓ 如果不存在
优先级3: 内置Mock字段（5个分组，21个字段）
```

### 6.5 Mock字段列表

系统内置21个基础字段（分为5个分组）作为兜底数据：

**分组1：基本信息（4字段）**
- case_code - 案件编号
- user_name - 客户姓名
- id_card - 身份证号
- case_status - 案件状态

**分组2：借款信息（7字段）**
- loan_amount - 贷款金额
- outstanding_amount - 未还金额
- overdue_days - 逾期天数
- due_date - 到期日期
- total_installments - 期数
- term_days - 当期天数
- loan_id - 关联借款ID

**分组3：催收信息（3字段）**
- collector_name - 催收员姓名
- collection_stage - 催收阶段
- last_contact_time - 最后联系时间

**分组4：联系信息（3字段）**
- mobile_number - 手机号
- emergency_contact - 紧急联系人
- emergency_phone - 紧急联系电话

**分组5：产品信息（4字段）**
- system_name - 所属系统
- product_name - 产品
- app_name - APP
- merchant_name - 商户

### 6.6 版本管理

#### 6.6.1 版本文件结构

**文件位置**: `~/.cco-storage/case-detail-display-versions/{tenantId}_{sceneType}.json`

**文件格式**:
```json
{
  "versions": [
    {
      "version": 1,
      "saved_at": "2025-12-08T10:00:00",
      "operator": "admin",
      "note": "初始配置版本",
      "groups": [
        {
          "group_key": "basic_info",
          "group_name": "基本信息",
          "sort_order": 1,
          "is_collapsed_default": false,
          "fields": [
            {
              "field_key": "case_code",
              "field_name": "案件编号",
              "sort_order": 1,
              "display_width": 120,
              "color_type": "normal"
            }
          ]
        }
      ]
    }
  ],
  "activeVersion": 1
}
```

#### 6.6.2 版本保存

**保存对话框**:
```
┌───────────────────────────────────────────┐
│ 保存为新版本                               │
├───────────────────────────────────────────┤
│ 当前配置包含 5 个分组，共 21 个字段        │
│                                            │
│ 版本备注：                                 │
│ [调整分组排序和字段宽度________________]   │
│ (可选，建议填写)                           │
│                                            │
│ 变更摘要：                                 │
│ • 调整了2个分组的排序                      │
│ • 修改了3个字段的显示宽度                  │
│ • 设置了1个分组的默认折叠状态              │
│                                            │
│    [取消]            [确定保存]            │
└───────────────────────────────────────────┘
```

### 6.7 页面布局

```
┌─────────────────────────────────────────────────────┐
│ 案件详情字段配置                                     │
│ 【基于映射配置：v5】【来源：上传版本】               │
│              【保存为新版本】【版本历史】【分组管理】│
├─────────────────────────────────────────────────────┤
│ 场景类型：[控台案件详情 ▼]                          │
├───────────┬─────────────────────────────────────────┤
│ 分组树     │ 字段配置表格                             │
│           │                                          │
│ 视图切换： │ 拖拽|序号|字段名称|宽度|颜色|操作        │
│ ○ 全部    │                                          │
│ ● 分组    │ ::: | 1 | 案件编号 | [120] | [普通▼] | […]│
│           │                                          │
│ 分组列表： │ ::: | 2 | 客户姓名 | [120] | [普通▼] | […]│
│ ▼ 基本信息│                                          │
│   (4字段) │ ...                                      │
│           │                                          │
│ ▼ 借款信息│                                          │
│   (7字段) │                                          │
└───────────┴─────────────────────────────────────────┘
```

### 6.8 管理入口

- **页面路径**: 管理控台 → 字段配置 → 案件详情字段展示配置
- **路由**: `/field-config/detail`
- **权限**: SuperAdmin / TenantAdmin
- **页面布局**: 左侧分组树（可选） + 右侧字段配置表格
- **PRD文档**: 4-案件详情字段展示配置-PRD.md

---

## 七、场景类型

### 7.1 支持的场景

案件详情字段管理支持2个场景类型：

| 场景Key | 场景名称 | 说明 | 使用端 |
|---------|---------|------|--------|
| `admin_case_detail` | 控台案件详情 | 管理控台的案件详情页面字段配置 | 控台端 |
| `collector_case_detail` | IM端案件详情 | 催员端的案件详情页面字段配置 | IM端 |

### 7.2 场景隔离

- 每个场景的配置**完全独立**
- 控台和IM端可以配置不同的字段、不同的分组排序
- 版本管理按场景分别存储

### 7.3 场景参数说明

系统中存在**两个场景相关参数**，用途和使用场景不同：

#### 7.3.1 scene参数（用于甲方字段上传和映射配置）

**参数说明**：
- **参数名**: `scene`
- **可选值**: `list`（列表）、`detail`（详情）
- **使用场景**: 甲方字段上传、字段映射配置
- **存储位置**: `tenant_field_uploads.scene`、`tenant_field_configs.scene`

**API示例**：
```
GET /api/v1/tenants/{tenantId}/fields-json?scene=detail
GET /api/v1/tenant-field-configs/mapping?tenantId=1&scene=detail
POST /api/v1/tenant-field-uploads/upload
  Body: { "scene": "detail", "groups": [...] }
```

**用途**：
- 区分甲方字段是用于"案件列表"还是"案件详情"
- 控制字段映射配置的范围
- 版本管理的场景隔离（list和detail的版本号独立）

#### 7.3.2 sceneType参数（用于展示配置）

**参数说明**：
- **参数名**: `sceneType`
- **可选值**: `admin_case_detail`（控台端）、`collector_case_detail`（IM端）
- **使用场景**: 字段展示配置、前端页面渲染
- **存储位置**: 本地版本文件路径（`{tenantId}_{sceneType}.json`）

> ⚠️ **重要说明**：sceneType命名中的`_detail`后缀是历史命名，不表示"详情"。
> - 列表场景和详情场景使用**相同的sceneType值**
> - 通过**文件夹路径**区分列表和详情：
>   - 列表：`case-list-display-versions/`
>   - 详情：`case-detail-display-versions/`
> - 通过**sceneType**区分控台端和IM端：
>   - 控台端：`admin_case_detail`
>   - IM端：`collector_case_detail`

**API示例**：
```
GET /api/v1/case-detail-field-configs?tenantId=1&sceneType=admin_case_detail
POST /api/v1/case-detail-field-configs/version/save
  Body: { "sceneType": "admin_case_detail", "groups": [...] }
```

**用途**：
- 区分"控台端"和"IM端"的字段展示配置
- 控制展示配置的版本管理（控台和IM端的版本独立）
- 前端根据不同端渲染不同的字段配置

#### 7.3.3 参数对比

| 维度 | scene | sceneType |
|------|-------|-----------|
| **使用层级** | 甲方字段上传、字段映射 | 字段展示配置 |
| **可选值** | `list` / `detail` | `admin_case_detail` / `collector_case_detail` |
| **区分维度** | 列表 vs 详情 | 控台端 vs IM端 |
| **API路径** | `/tenant-field-uploads`<br>`/tenant-field-configs` | `/case-list-field-configs`（列表）<br>`/case-detail-field-configs`（详情） |
| **版本管理** | 数据库表（`tenant_field_uploads`）| 本地JSON文件 |
| **文件路径** | - | `case-list-display-versions/`（列表）<br>`case-detail-display-versions/`（详情） |
| **命名说明** | 清晰明确 | `_detail`后缀是历史命名，不表示详情 |
| **分组支持** | detail场景必须含分组 | 继承scene=detail的分组结构 |

#### 7.3.4 参数关系图

```
scene层级（甲方字段维度）
│
├── list（列表场景，无分组）
│   └── sceneType层级（展示配置维度）
│       ├── admin_case_detail（控台端）
│       │   → 文件：case-list-display-versions/1_admin_case_detail.json
│       └── collector_case_detail（IM端）
│           → 文件：case-list-display-versions/1_collector_case_detail.json
│
└── detail（详情场景，含分组）
    └── sceneType层级（展示配置维度）
        ├── admin_case_detail（控台端）
        │   → 文件：case-detail-display-versions/1_admin_case_detail.json
        └── collector_case_detail（IM端）
            → 文件：case-detail-display-versions/1_collector_case_detail.json
```

**关键说明**：
- sceneType值（`admin_case_detail`/`collector_case_detail`）在列表和详情场景中**相同**
- 通过**文件夹路径**区分列表和详情：
  - `case-list-display-versions/` - 列表场景
  - `case-detail-display-versions/` - 详情场景
- 通过**sceneType**区分控台端和IM端
- `_detail`后缀是历史命名习惯，不代表"详情"的含义

**实际使用逻辑**：
1. 甲方上传字段时指定 `scene=detail`，JSON必须包含groups数组
2. 映射配置基于 `scene=detail` 的甲方字段，支持分组视图
3. 控台端展示配置使用 `sceneType=admin_case_detail`，从 `scene=detail` 的映射配置中读取字段（含分组）
4. IM端展示配置使用 `sceneType=collector_case_detail`，同样从 `scene=detail` 的映射配置中读取字段（含分组）
5. 展示配置保存到 `case-detail-display-versions/{tenantId}_{sceneType}.json`

---

## 八、完整数据流转

### 8.1 初次配置流程（从零开始）

```
【步骤1】准备含分组的甲方字段JSON
  操作: 按照JSON规范准备文件
  要点: 
    - 必须包含groups数组
    - 每个分组必须包含fields数组
    - group_key全局唯一
    - field_key在分组内唯一
  结果: 准备好符合规范的JSON文件（≤5MB）
    ↓

【步骤2】上传甲方字段
  操作: 管理控台 → 案件详情甲方字段查看 → 上传文件
  验证: 系统校验JSON结构（groups、fields必填）
  结果: 
    - 系统解析JSON，提取分组和字段列表
    - 生成v1版本并激活
    - 显示分组树和字段列表
    ↓

【步骤3】配置字段映射（支持分组视图）
  操作: 管理控台 → 案件详情字段映射配置
  模式: 
    - 全部视图：查看所有字段，可跨分组映射
    - 分组视图：选择分组，配置该分组字段
  流程:
    a) 智能匹配（可选）
       - 选择匹配范围（全部/当前分组/未映射字段）
       - 查看按分组显示的匹配建议
       - 确认匹配
    b) 手动映射
       - 选择标准字段
       - 选择甲方字段（支持跨分组）
       - 保存映射
    c) 处理未使用字段
       - 映射到标准字段 或
       - 创建拓展字段（指定目标分组）
  结果: 生成映射配置v1版本并激活
    ↓

【步骤4】配置字段展示（含分组管理）
  操作: 管理控台 → 案件详情字段展示配置
  要点:
    - 系统从映射配置读取字段列表（含分组）
    - 管理分组（排序、默认折叠状态）
    - 配置字段属性（宽度、颜色、分组内排序）
    - **不配置**筛选和范围检索（详情页不需要）
  流程:
    a) 分组管理
       - 调整分组显示顺序
       - 设置分组默认折叠状态
    b) 字段属性配置
       - 设置字段宽度
       - 设置字段颜色
       - 拖拽调整分组内字段顺序
    c) 保存为新版本
       - 填写版本备注
       - 查看变更摘要
       - 确认保存
  结果: 生成展示配置v1版本并激活
    ↓

【步骤5】前端详情页渲染
  操作: 前端案件详情页面加载
  流程:
    - 读取展示配置v1（含分组配置）
    - 按分组渲染详情页
    - 每个分组显示为卡片/面板
    - 根据is_collapsed_default控制折叠状态
    - 字段按sort_order排序
    - 应用颜色和宽度配置
  结果: 案件详情页正确展示
```

### 8.2 更新配置流程

#### 8.2.1 场景A：甲方字段变更（新增/删除分组或字段）

```
【触发】甲方上传新的JSON（调整分组或字段）
    ↓
【步骤1】上传新版本
  操作: 案件详情甲方字段查看 → 上传新文件
  变更: 可能新增/删除分组，可能新增/删除字段
  结果: 生成甲方字段v2版本并激活
    ↓
【步骤2】重新配置映射关系
  操作: 案件详情字段映射配置
  处理:
    - 新增的分组/字段：需要配置映射
    - 删除的分组/字段：映射关系自动失效
    - 保持的分组/字段：保留原映射关系
  结果: 保存为映射配置v2并激活
    ↓
【步骤3】调整展示配置（如果需要）
  操作: 案件详情字段展示配置
  自动: 页面自动显示"基于映射配置版本：v2"
  处理:
    - 新增的分组：设置排序和折叠状态
    - 新增的字段：设置宽度和颜色
    - 调整分组/字段排序
  结果: 保存为展示配置v2
    ↓
【步骤4】前端生效
  结果: 前端详情页显示新的分组和字段
```

#### 8.2.2 场景B：仅调整展示配置（不改变字段）

```
【触发】管理员需要调整分组排序或字段展示属性
    ↓
【步骤1】修改展示配置
  操作: 案件详情字段展示配置
  修改:
    - 调整分组显示顺序
    - 修改分组默认折叠状态
    - 调整字段宽度/颜色
    - 调整分组内字段排序
  结果: 配置已修改（未保存）
    ↓
【步骤2】保存为新版本
  操作: 点击"保存为新版本"
  验证: 查看变更摘要
  结果: 保存为展示配置v2并激活
    ↓
【步骤3】前端立即生效
  结果: 前端详情页应用新的展示配置
```

### 8.3 版本恢复流程

#### 8.3.1 恢复映射配置版本

```
【触发】需要恢复到之前的映射配置
    ↓
【步骤1】查看映射配置版本历史
  操作: 案件详情字段映射配置 → 版本历史
  显示: 版本列表（含分组完成度）
    ↓
【步骤2】选择目标版本
  操作: 点击目标版本的"恢复此版本"
  预览: 查看版本详情（分组结构、映射关系）
    ↓
【步骤3】确认恢复
  操作: 确认恢复对话框
  警告: 当前激活版本将被替换
  结果: 该版本被设为激活版本
    ↓
【步骤4】展示配置自动更新
  自动: 展示配置页面显示"基于映射配置版本：vX"
  建议: 检查展示配置是否需要调整
```

#### 8.3.2 恢复展示配置版本

```
【触发】需要恢复到之前的展示配置
    ↓
【步骤1】查看展示配置版本历史
  操作: 案件详情字段展示配置 → 版本历史
  显示: 版本列表（含变更摘要）
    ↓
【步骤2】选择目标版本
  操作: 点击目标版本的"恢复此版本"
  预览: 查看版本详情（分组配置、字段属性）
    ↓
【步骤3】确认恢复
  操作: 确认恢复对话框
  警告: 当前激活版本将被替换
  结果: 该版本被设为激活版本
    ↓
【步骤4】前端立即生效
  结果: 前端详情页应用恢复的展示配置
```

---

## 九、API接口

### 9.1 分组管理相关

```
// 获取分组列表
GET /api/v1/field-groups?scene=detail

// 创建分组
POST /api/v1/field-groups

// 更新分组
PUT /api/v1/field-groups/{id}

// 删除分组
DELETE /api/v1/field-groups/{id}

// 批量更新排序
POST /api/v1/field-groups/batch-sort
```

### 9.2 标准字段相关

```
// 获取案件详情标准字段（含分组）
GET /api/v1/standard-fields/case-detail

响应示例:
{
  "code": 200,
  "message": "success",
  "data": {
    "groups": [
      {
        "group_id": 1,
        "group_name": "基本信息",
        "group_key": "basic_info",
        "sort_order": 1,
        "fields": [
          {
            "field_key": "case_code",
            "field_name": "案件编号",
            "field_data_type": "String",
            "is_required": true
          }
        ]
      }
    ]
  }
}
```

### 9.3 甲方字段相关

```
// 获取甲方字段JSON（含分组）
GET /api/v1/tenants/{tenantId}/fields-json?scene=detail

响应示例:
{
  "code": 200,
  "message": "success",
  "data": {
    "version": 1,
    "scene": "detail",
    "groups_count": 5,
    "fields_count": 21,
    "groups": [
      {
        "group_key": "basic_info",
        "group_name": "基本信息",
        "fields": [...]
      }
    ]
  }
}

// 上传甲方字段JSON（含分组）
POST /api/v1/tenants/{tenantId}/fields-json/upload

请求参数:
{
  "scene": "detail",
  "groups": [
    {
      "group_key": "basic_info",
      "group_name": "基本信息",
      "fields": [...]
    }
  ]
}

响应:
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "version": 2,
    "groups_count": 5,
    "fields_count": 21
  }
}
```

### 9.4 映射配置相关

```
// 智能匹配建议（支持分组范围）
POST /api/v1/tenants/{tenantId}/field-configs/auto-suggest

请求参数:
{
  "scene": "detail",
  "scope": "group",  // all：全部，group：指定分组，unmapped：未映射
  "group_key": "basic_info"
}

响应:
{
  "code": 200,
  "message": "success",
  "data": {
    "suggestions_by_group": {
      "basic_info": [
        {
          "field_key": "case_code",
          "tenant_field_key": "CASE_ID",
          "similarity": 100,
          "match_type": "exact"
        }
      ]
    },
    "summary": {
      "total": 15,
      "high_confidence": 10,
      "medium_confidence": 5,
      "groups_count": 3
    }
  }
}

// 保存映射配置（含分组信息）
POST /api/v1/field-mapping/save

请求参数:
{
  "tenant_id": 1,
  "scene": "case_detail",
  "field_mappings": [
    {
      "group_key": "basic_info",
      "standard_field_key": "case_code",
      "tenant_field_key": "CASE_ID",
      "tenant_field_group": "basic_info",
      "mapping_status": "auto_mapped"
    }
  ],
  "extended_fields": [
    {
      "field_alias": "customer_level",
      "tenant_field_key": "CUSTOMER_LEVEL",
      "target_group_key": "basic_info",
      "source_group_key": "basic_info"
    }
  ]
}
```

### 9.5 展示配置相关

```
// 获取字段展示配置列表（含分组）
GET /api/v1/case-detail-field-configs?tenantId=1&sceneType=admin_case_detail

响应:
{
  "code": 200,
  "message": "success",
  "data": {
    "groups": [
      {
        "group_key": "basic_info",
        "group_name": "基本信息",
        "sort_order": 1,
        "is_collapsed_default": false,
        "fields": [
          {
            "field_key": "case_code",
            "field_name": "案件编号",
            "sort_order": 1,
            "display_width": 120,
            "color_type": "normal"
          }
        ]
      }
    ]
  }
}

// 保存展示配置为新版本（含分组配置）
POST /api/v1/case-detail-field-configs/version/save

请求参数:
{
  "tenant_id": 1,
  "scene_type": "admin_case_detail",
  "groups": [
    {
      "group_key": "basic_info",
      "group_name": "基本信息",
      "sort_order": 1,
      "is_collapsed_default": false,
      "fields": [...]
    }
  ],
  "operator": "admin",
  "note": "调整分组排序"
}

// 获取展示配置版本历史
GET /api/v1/case-detail-field-configs/version/history?tenantId=1&sceneType=admin_case_detail

// 激活展示配置版本
POST /api/v1/case-detail-field-configs/version/activate

请求参数:
{
  "tenant_id": 1,
  "scene_type": "admin_case_detail",
  "version": 3
}
```

---

## 十、常见问题

### 10.1 为什么案件详情字段要分组？

**原因**:
- **字段数量多**: 案件详情有21个字段（列表只有15个），需要分组管理提升可读性
- **逻辑分类**: 基本信息、借款信息、催收信息等有明确的业务逻辑分类
- **用户体验**: 前端详情页分组卡片展示，支持折叠/展开，体验更好
- **配置效率**: 分组视图下配置映射，效率更高

### 10.2 甲方JSON必须包含分组吗？

**回答**: 是的，**必须包含groups数组**。

**原因**:
- 系统设计上，案件详情字段以分组为核心
- 缺少groups数组会导致上传失败
- 即使甲方原始数据没有分组，也需要在JSON中创建至少1个分组

**示例**:
```json
{
  "scene": "detail",
  "groups": [
    {
      "group_key": "default_group",
      "group_name": "默认分组",
      "fields": [...]
    }
  ]
}
```

### 10.3 如何在分组视图下配置映射？

**步骤**:
1. 进入"案件详情字段映射配置"页面
2. 左侧分组树选择"分组视图"
3. 点击某个分组（如"基本信息"）
4. 右侧表格仅显示该分组的标准字段
5. 为每个字段选择甲方字段（支持跨分组选择）
6. 切换到其他分组，继续配置
7. 保存为新版本

### 10.4 为什么详情不支持筛选配置？

**原因**:
- **功能定位**: 详情页展示单个案件的完整信息，不是列表页
- **无筛选需求**: 用户查看案件详情时，不需要筛选功能
- **无检索需求**: 详情页不需要范围检索（如逾期天数>30）
- **简化配置**: 去掉筛选和检索配置，降低配置复杂度

**对比**:
| 功能 | 列表字段 | 详情字段 |
|------|---------|---------|
| 筛选 | ✅ 需要 | ❌ 不需要 |
| 范围检索 | ✅ 需要 | ❌ 不需要 |
| 展示 | ✅ 需要 | ✅ 需要 |

### 10.5 如何跨分组映射字段？

**场景**: 甲方的字段分组与标准分组不一致

**方法1（全部视图）**:
1. 选择"全部视图"
2. 在甲方字段下拉列表中选择任意分组的字段
3. 系统会显示"跨分组映射"提示

**方法2（分组视图）**:
1. 选择"分组视图"，选择目标分组
2. 甲方字段下拉列表按分组组织
3. 可以选择其他分组的字段
4. 系统会显示"跨分组映射"提示

**示例**:
```
标准字段：mobile_number（联系信息分组）
甲方字段：PHONE（基本信息分组）
映射：允许，标记为"跨分组映射"
```

### 10.6 枚举值从哪里来？

**来源优先级**:
1. **甲方JSON**: 如果甲方JSON中定义了 `enum_values`，则使用甲方的枚举值
2. **标准字段**: 如果映射到了标准字段，且标准字段有枚举值，则使用标准枚举值
3. **Mock数据**: 如果使用Mock数据，则使用系统预定义的枚举值

**示例**:
```json
// 甲方JSON
{
  "field_key": "CASE_STATUS",
  "field_type": "Enum",
  "enum_values": ["待分配", "催收中", "已完成", "已关闭"]
}

// 映射到标准字段case_status后
// 前端展示时使用甲方的枚举值
```

### 10.7 版本号是如何生成的？

**生成规则**:
- 版本号从**1**开始
- 每次保存新版本，版本号**自动加1**
- 版本号**不会重复**，即使删除了某个版本
- 映射配置版本和展示配置版本**独立计数**

**示例**:
```
映射配置版本: v1, v2, v3, v4, v5 ...
展示配置版本: v1, v2, v3, v4, v5 ...
（两者版本号独立，可能不一致）
```

### 10.8 删除本地版本文件会怎样？

**影响**:
- 展示配置会回退到**映射配置最新版本**
- 如果映射配置也不存在，则回退到**Mock数据**（5个分组，21个字段）
- 不会影响数据库中的映射配置
- 不会丢失数据，可以重新配置并保存

**恢复方法**:
1. 进入"案件详情字段展示配置"页面
2. 系统自动从映射配置读取字段（含分组）
3. 重新配置展示属性
4. 保存为新版本

### 10.9 分组数量有限制吗？

**建议限制**:
- **分组数量**: 建议 ≤ 10个（过多影响用户体验）
- **单个分组字段数**: 建议 ≤ 15个
- **字段总数**: 建议 ≤ 50个
- **JSON文件大小**: ≤ 5MB

**原因**:
- 分组过多会导致详情页过长，用户需要频繁滚动
- 单个分组字段过多会降低分组的意义
- 字段总数过多会影响页面加载性能

### 10.10 页面显示"基于映射配置版本：v0，来源：内置Mock"是什么意思？

**含义**:
- **v0**: 表示没有找到映射配置版本，使用Mock数据
- **内置Mock**: 系统内置的21个基础字段（5个分组）
- **原因**: 尚未上传甲方JSON或配置映射关系

**解决方法**:
1. 上传甲方JSON（含分组）
2. 配置字段映射关系
3. 保存为新版本并激活
4. 展示配置页面会自动显示正确的版本号

### 10.11 sceneType为什么叫admin_case_detail，但用于列表和详情？

**原因**: 历史命名习惯

**说明**:
- `admin_case_detail`和`collector_case_detail`中的`_detail`后缀是**历史命名**，不表示"详情"
- 这两个sceneType既用于**列表场景**也用于**详情场景**
- 系统通过**文件夹路径**区分列表和详情：
  - 列表：`~/.cco-storage/case-list-display-versions/`
  - 详情：`~/.cco-storage/case-detail-display-versions/`
- 通过**sceneType**区分控台端和IM端：
  - 控台端：`admin_case_detail`
  - IM端：`collector_case_detail`

**实际文件路径示例**:
```
列表场景：
- 控台：case-list-display-versions/1_admin_case_detail.json
- IM端：case-list-display-versions/1_collector_case_detail.json

详情场景：
- 控台：case-detail-display-versions/1_admin_case_detail.json
- IM端：case-detail-display-versions/1_collector_case_detail.json
```

**记忆要点**:
- scene参数（list/detail）→ 区分列表和详情
- sceneType参数（admin_case_detail/collector_case_detail）→ 区分控台端和IM端
- 文件夹路径 → 对应scene
- sceneType值 → 对应端（admin/collector）

### 10.12 如何管理分组？

**查看分组**：
1. 进入"案件详情字段分组管理"页面
2. 查看分组树（5个标准分组+自定义分组）
3. 点击分组查看详情

**创建分组**：
1. 点击"新建分组"按钮
2. 填写分组名称、标识
3. 选择父分组（可选）
4. 设置排序序号
5. 保存

**编辑分组**：
1. 点击分组节点
2. 修改分组名称、排序
3. 保存（标准分组不可删除，group_key不可修改）

**删除分组**：
1. 选择自定义分组
2. 点击"删除"按钮
3. 确认删除（会检查是否有关联字段）

---

## 十一、操作指南

### 11.1 初次配置（从零开始）

#### 步骤0：管理分组（可选）

如果需要自定义分组：
1. 进入"案件详情字段分组管理"页面
2. 创建自定义分组（如"风控信息"）
3. 设置分组名称和排序

#### 步骤1：准备甲方字段JSON

**JSON模板**:
```json
{
  "version": "1.0",
  "scene": "detail",
  "tenant_id": "1",
  "tenant_name": "示例甲方",
  "updated_at": "2025-12-08T10:00:00",
  "description": "案件详情字段配置",
  "groups": [
    {
      "group_key": "basic_info",
      "group_name": "基本信息",
      "sort_order": 1,
      "fields": [
        {
          "field_name": "案件编号",
          "field_key": "CASE_ID",
          "field_type": "String",
          "is_required": true,
          "sort_order": 1
        }
      ]
    }
  ]
}
```

**检查清单**:
- [ ] JSON格式正确
- [ ] 包含groups数组
- [ ] 每个分组包含fields数组
- [ ] group_key全局唯一
- [ ] field_key在分组内唯一
- [ ] 文件大小 ≤ 5MB

#### 步骤2：上传并配置映射

**2.1 上传甲方JSON**
1. 进入"案件详情甲方字段查看"页面
2. 点击"上传JSON文件"按钮
3. 选择准备好的JSON文件
4. 系统校验并解析（显示分组树和字段列表）
5. 确认上传

**2.2 配置字段映射**
1. 进入"案件详情字段映射配置"页面
2. 选择视图模式（推荐使用分组视图）
3. 智能匹配（可选）：
   - 点击"智能匹配建议"
   - 选择匹配范围（全部/当前分组）
   - 查看匹配建议（按分组显示）
   - 确认匹配
4. 手动映射：
   - 为每个未映射字段选择甲方字段
   - 支持跨分组选择
   - 配置枚举值映射（Enum类型）
5. 处理未使用字段：
   - 查看未使用的甲方字段
   - 选择"映射到标准字段"或"创建拓展字段"
   - 创建拓展字段时需指定目标分组
6. 填写版本备注
7. 点击"保存并激活"

#### 步骤3：配置展示

**3.1 分组管理**
1. 进入"案件详情字段展示配置"页面
2. 点击"分组管理"按钮
3. 调整分组显示顺序（拖拽或按钮）
4. 设置分组默认折叠状态
5. 保存分组配置

**3.2 字段属性配置**
1. 选择分组视图模式
2. 点击某个分组
3. 为每个字段配置：
   - 显示宽度（默认120px）
   - 颜色类型（默认normal）
4. 拖拽调整分组内字段顺序
5. 切换到其他分组，继续配置

**3.3 保存为新版本**
1. 点击"保存为新版本"按钮
2. 填写版本备注（可选）
3. 查看变更摘要
4. 确认保存

#### 步骤4：验证

1. 刷新前端案件详情页面
2. 检查分组是否正确显示
3. 检查分组排序是否正确
4. 检查字段显示是否正确
5. 检查字段宽度和颜色是否符合预期
6. 测试分组折叠/展开功能

### 11.2 更新甲方字段

#### 场景：甲方新增了一个分组和几个字段

**步骤1：准备新的JSON**
- 在原JSON基础上新增分组和字段
- 保持原有分组和字段不变
- version保持为"1.0"（系统会自动递增数据库版本）

**步骤2：上传新版本**
1. 进入"案件详情甲方字段查看"页面
2. 点击"上传新版本"
3. 上传新的JSON文件
4. 系统自动生成v2版本并激活
5. 查看新增的分组和字段

**步骤3：配置新增字段的映射**
1. 进入"案件详情字段映射配置"页面
2. 页面会显示"基于映射配置版本：v2"
3. 智能匹配新增字段（可选）
4. 手动映射新增字段
5. 保存为映射配置v2

**步骤4：调整展示配置**
1. 进入"案件详情字段展示配置"页面
2. 页面会显示"基于映射配置版本：v2"
3. 配置新增分组的排序和折叠状态
4. 配置新增字段的宽度和颜色
5. 保存为展示配置v2

### 11.3 恢复历史版本

#### 恢复映射配置版本

**步骤1：查看版本历史**
1. 进入"案件详情字段映射配置"页面
2. 点击"版本历史"按钮
3. 查看版本列表（含分组完成度）

**步骤2：选择目标版本**
1. 找到需要恢复的版本
2. 点击"查看详情"查看版本内容
3. 确认无误后点击"恢复此版本"

**步骤3：确认恢复**
1. 系统弹出确认对话框
2. 阅读警告信息
3. 点击"确认恢复"

**步骤4：检查展示配置**
1. 进入"案件详情字段展示配置"页面
2. 查看"基于映射配置版本"是否已更新
3. 检查展示配置是否需要调整

#### 恢复展示配置版本

**步骤1：查看版本历史**
1. 进入"案件详情字段展示配置"页面
2. 点击"版本历史"按钮
3. 查看版本列表（含变更摘要）

**步骤2：选择目标版本**
1. 找到需要恢复的版本
2. 点击"查看详情"查看版本内容
3. 确认无误后点击"恢复此版本"

**步骤3：确认恢复**
1. 系统弹出确认对话框
2. 阅读警告信息
3. 点击"确认恢复"

**步骤4：验证**
1. 刷新前端案件详情页面
2. 检查展示效果是否符合预期

---

## 十二、技术实现

### 12.1 后端技术栈

- **框架**: Spring Boot 3.3.5
- **ORM**: MyBatis-Plus 3.5.8
- **数据库**: MySQL 8.0
- **存储**:
  - 映射配置：MySQL数据库（`tenant_field_uploads`表，scene='detail'）
  - 展示配置：本地JSON文件（`~/.cco-storage/case-detail-display-versions/`）

### 12.2 前端技术栈

- **框架**: Vue 3 + TypeScript
- **UI库**: Element Plus
- **状态管理**: Pinia
- **拖拽**: Sortable.js
- **分组树**: Element Plus Tree组件

### 12.3 核心表结构

#### 12.3.1 field_groups_detail（分组管理）

```sql
CREATE TABLE field_groups_detail (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_key VARCHAR(100) NOT NULL,
  group_name VARCHAR(200) NOT NULL,
  group_name_en VARCHAR(200),
  parent_id BIGINT,
  sort_order INT NOT NULL DEFAULT 0,
  is_standard BOOLEAN NOT NULL DEFAULT FALSE,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  scene VARCHAR(50) NOT NULL DEFAULT 'detail',
  description TEXT,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  created_by VARCHAR(100),
  updated_by VARCHAR(100),
  
  UNIQUE KEY uk_group_key_scene (group_key, scene),
  KEY idx_scene (scene),
  KEY idx_parent (parent_id),
  KEY idx_sort (sort_order),
  FOREIGN KEY (parent_id) REFERENCES field_groups_detail(id) ON DELETE SET NULL
);
```

#### 12.3.2 tenant_field_uploads（映射配置）

```sql
CREATE TABLE tenant_field_uploads (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  tenant_id VARCHAR(50) NOT NULL,
  scene VARCHAR(100) NOT NULL,  -- 'detail'
  version INT NOT NULL,
  json_content JSON NOT NULL,  -- 含groups数组
  groups_count INT,  -- 分组数量
  fields_count INT,  -- 字段总数
  is_active BOOLEAN DEFAULT FALSE,
  uploaded_by VARCHAR(100),
  uploaded_at DATETIME,
  INDEX idx_tenant_scene (tenant_id, scene),
  INDEX idx_active (tenant_id, scene, is_active)
);
```

#### 12.3.3 standard_fields_detail（标准字段）

```sql
CREATE TABLE standard_fields_detail (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  group_id INT NOT NULL,  -- 分组ID
  field_key VARCHAR(100) NOT NULL UNIQUE,
  field_name VARCHAR(200) NOT NULL,
  field_type VARCHAR(50) NOT NULL,
  description TEXT,
  is_required BOOLEAN DEFAULT FALSE,
  enum_values JSON,
  sort_order INT,
  created_at DATETIME,
  updated_at DATETIME
);
```

### 12.4 展示配置版本文件格式

**文件路径**: `~/.cco-storage/case-detail-display-versions/{tenantId}_{sceneType}.json`

**示例**: `~/.cco-storage/case-detail-display-versions/1_admin_case_detail.json`

**文件结构**:
```json
{
  "versions": [
    {
      "version": 1,
      "saved_at": "2025-12-08T10:00:00",
      "operator": "admin",
      "note": "初始版本",
      "groups": [
        {
          "group_key": "basic_info",
          "group_name": "基本信息",
          "sort_order": 1,
          "is_collapsed_default": false,
          "fields": [
            {
              "field_key": "case_code",
              "field_name": "案件编号",
              "field_data_type": "String",
              "field_source": "standard",
              "sort_order": 1,
              "display_width": 120,
              "color_type": "normal"
            }
          ]
        }
      ]
    }
  ],
  "activeVersion": 1
}
```

### 12.5 分组树组件实现

**Vue组件示例**:
```vue
<template>
  <div class="group-tree">
    <el-tree
      :data="groupTreeData"
      :props="treeProps"
      node-key="group_key"
      :default-expanded-keys="expandedKeys"
      @node-click="handleNodeClick"
    >
      <template #default="{ node, data }">
        <span class="custom-tree-node">
          <span>{{ data.group_name }}</span>
          <span class="fields-count">({{ data.fields_count }}个字段)</span>
        </span>
      </template>
    </el-tree>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'

interface GroupTreeNode {
  group_key: string
  group_name: string
  fields_count: number
}

const props = defineProps<{
  groups: GroupTreeNode[]
}>()

const treeProps = {
  children: 'children',
  label: 'group_name'
}

const groupTreeData = computed(() => {
  return props.groups.map(group => ({
    group_key: group.group_key,
    group_name: group.group_name,
    fields_count: group.fields_count
  }))
})

const expandedKeys = ref<string[]>([])

const handleNodeClick = (data: GroupTreeNode) => {
  // 发射分组选择事件
  emit('group-select', data.group_key)
}

const emit = defineEmits<{
  (e: 'group-select', groupKey: string): void
}>()
</script>
```

---

## 十二、注意事项

### 12.1 权限控制

- **SuperAdmin**: 可管理所有甲方的字段配置
- **TenantAdmin**: 只能管理自己甲方的字段配置
- **其他角色**: 无权限访问字段管理功能

### 13.2 数据安全

- **版本文件**: 存储在服务器本地磁盘，建议定期备份
- **备份目录**: `~/.cco-storage/case-detail-display-versions/`
- **删除操作**: 版本删除是软删除，可以恢复
- **敏感数据**: 分组和字段配置不包含实际案件数据

### 13.3 性能优化

- **分组数量**: 建议 ≤ 10个
- **字段总数**: 建议 ≤ 50个
- **单个分组字段数**: 建议 ≤ 15个
- **枚举选项**: 建议不超过100个
- **JSON文件大小**: ≤ 5MB
- **版本文件**: 定期清理过期版本（保留最近10个版本）

### 13.4 兼容性

- **场景类型命名**: `admin_case_detail`/`collector_case_detail`保留历史兼容性
- **分组结构**: 新版本必须保持分组结构，不能去掉groups数组
- **Mock数据**: 确保系统在无配置时也能正常运行（5个分组，21个字段）
- **版本恢复**: 不会删除历史数据，可以安全恢复

### 13.5 最佳实践

#### 13.5.1 分组设计

- **分组命名**: 使用清晰的业务命名（如"基本信息"、"借款信息"）
- **分组数量**: 控制在5-8个，不超过10个
- **字段分布**: 每个分组字段数量均衡，避免某个分组过多字段
- **逻辑分类**: 相关字段归为同一分组

#### 13.5.2 字段映射

- **优先智能匹配**: 使用智能匹配提高配置效率
- **分组视图配置**: 使用分组视图提高配置准确性
- **跨分组映射**: 仅在必要时使用，避免混乱
- **拓展字段**: 谨慎创建，确保必要性

#### 13.5.3 展示配置

- **分组排序**: 按重要性排序，重要信息放前面
- **默认折叠**: 次要信息可设置默认折叠
- **字段宽度**: 根据内容长度合理设置
- **颜色使用**: 谨慎使用颜色，避免过多强调

#### 13.5.4 版本管理

- **版本备注**: 每次保存版本都填写清晰的备注
- **定期检查**: 定期检查版本文件，清理过期版本
- **备份**: 定期备份版本文件
- **测试**: 恢复版本后及时测试验证

---

## 十四、更新日志

### v1.0 (2025-12-08)
- ✅ 初始版本
- ✅ 完整的五层架构说明（含分组管理）
- ✅ Layer 0: 分组管理（基础数据层）
- ✅ 5个标准分组，21个标准字段
- ✅ 甲方字段JSON必须包含groups数组
- ✅ 映射配置支持全部视图和分组视图
- ✅ 智能匹配按分组显示建议
- ✅ 支持跨分组映射
- ✅ 拓展字段需指定目标分组
- ✅ 展示配置含分组管理（排序、折叠状态）
- ✅ 分组内字段拖拽排序
- ✅ 不支持筛选和范围检索配置（详情场景特性）
- ✅ 映射配置和展示配置的版本管理
- ✅ 支持控台和IM端两个场景（sceneType）
- ✅ scene=detail区分详情字段和列表字段

---

## 附录

### A. 标准字段分组参考

详见：`PRD需求文档/CCO管理控台/字段管理/案件详情字段管理/1-案件详情标准字段管理-PRD.md`

### B. PRD文档

- [案件详情字段分组管理PRD](./案件详情字段管理/5-案件详情字段分组管理-PRD.md)（Layer 0 - 基础数据层）
- [案件详情标准字段管理PRD](./案件详情字段管理/1-案件详情标准字段管理-PRD.md)（Layer 1）
- [案件详情甲方字段查看PRD](./案件详情字段管理/2-案件详情甲方字段查看-PRD.md)（Layer 2）
- [案件详情字段映射配置PRD](./案件详情字段管理/3-案件详情字段映射配置-PRD.md)（Layer 3）
- [案件详情字段展示配置PRD](./案件详情字段管理/4-案件详情字段展示配置-PRD.md)（Layer 4）

### C. PRD关系图

```
PRD5（分组管理）→ 基础数据层
    ↓ 提供分组
PRD1（标准字段）→ 标准字段定义
    ↓ 提供模板
PRD2（甲方字段）→ 甲方字段上传
    ↓ 上传JSON
PRD3（映射配置）→ 字段映射
    ↓ 映射字段
PRD4（展示配置）→ 展示配置
    ↓ 配置展示
前端详情页 → 按分组展示
```

### D. 详情 vs 列表字段管理对比

| 对比项 | 案件列表字段管理 | 案件详情字段管理 |
|-------|----------------|----------------|
| **分组管理** | ❌ 无 | ✅ PRD5分组管理 |
| **分组结构** | ❌ 无分组 | ✅ 5个标准分组+自定义 |
| **字段数量** | 15个 | 21个 |
| **JSON结构** | `fields[]` | `groups[].fields[]` |
| **文件大小** | ≤2MB | ≤5MB |
| **页面布局** | 单表格 | 分组树+表格 |
| **映射视图** | 单一平铺视图 | 全部视图+分组视图 |
| **智能匹配** | 全局匹配 | 按分组匹配 |
| **拓展字段** | 无分组 | 需指定目标分组 |
| **拖拽排序** | 全局排序 | 分组内排序 |
| **分组管理** | ❌ 无 | ✅ 支持 |
| **筛选配置** | ✅ 支持 | ❌ 不支持 |
| **范围检索** | ✅ 支持 | ❌ 不支持 |
| **scene参数** | `list` | `detail` |
| **sceneType** | `admin_case_detail`<br>`collector_case_detail` | `admin_case_detail`<br>`collector_case_detail` |
| **版本文件** | `case-list-display-versions` | `case-detail-display-versions` |
| **PRD数量** | 4个（无分组管理） | 5个（含分组管理） |

### E. 联系方式

如有问题，请联系CCO开发团队。

---

**文档结束**
