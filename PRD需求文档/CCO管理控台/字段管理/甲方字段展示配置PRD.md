# 甲方字段展示配置 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

甲方字段展示配置是CCO管理控台的核心功能之一，用于配置不同场景下字段的展示方式、排序、筛选、范围检索等属性。不同甲方客户在不同业务场景下对字段的展示需求差异很大，系统需要支持灵活的字段展示配置，让管理员能够根据实际业务需求配置字段的显示顺序、宽度、颜色、格式化、筛选等属性。通过统一的字段展示配置，确保不同场景下字段展示的一致性和用户体验的优化。

**业务痛点**：
- 不同场景下字段展示需求差异大，需要灵活的配置机制
- 字段排序和筛选配置复杂，需要高效的配置工具
- 字段颜色和格式化规则需要支持条件表达式
- 字段隐藏规则需要支持按队列、机构、小组配置
- 字段展示配置变更频繁，需要版本管理和变更追踪

**预期影响的核心指标**：
- 字段配置效率：单个字段配置完成时间≤1分钟
- 配置准确率：字段展示配置准确率≥99%
- 用户体验：字段展示配置对用户体验提升≥20%
- 用户满意度：管理员对字段展示配置功能满意度≥90%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：配置控台案件列表字段展示**
- **入口**：管理控台菜单 → 字段配置 → 甲方字段展示配置
- **触发时机**：需要配置控台案件列表页面的字段展示时
- **所在页面**：`/field-config/display` → 选择场景"控台案件管理列表"
- **流程节点**：选择甲方 → 选择场景类型 → 选择字段 → 配置展示属性 → 批量保存

**场景2：配置催员案件列表字段展示**
- **入口**：管理控台菜单 → 字段配置 → 甲方字段展示配置
- **触发时机**：需要配置催员案件列表页面的字段展示时
- **所在页面**：`/field-config/display` → 选择场景"催员案件列表"
- **流程节点**：选择甲方 → 选择场景类型 → 选择字段 → 配置展示属性 → 批量保存

**场景3：配置字段排序**
- **入口**：字段展示配置页面 → 拖拽字段行
- **触发时机**：需要调整字段显示顺序时
- **所在页面**：字段展示配置页面
- **流程节点**：拖拽字段行 → 自动保存排序

**场景4：配置字段筛选和范围检索**
- **入口**：字段展示配置页面 → 点击"编辑"按钮
- **触发时机**：需要配置字段的筛选和范围检索属性时
- **所在页面**：字段展示配置页面（弹窗）
- **流程节点**：选择字段 → 配置筛选属性（枚举字段）→ 配置范围检索属性（数字/日期字段）→ 保存

**场景5：配置字段颜色规则**
- **入口**：字段展示配置页面 → 点击"编辑"按钮 → "颜色规则"Tab
- **触发时机**：需要根据字段值显示不同颜色时
- **所在页面**：字段展示配置页面（弹窗）
- **流程节点**：选择字段 → 配置颜色规则（条件表达式）→ 保存

**场景6：配置字段隐藏规则**
- **入口**：字段展示配置页面 → 点击"编辑"按钮 → "隐藏规则"Tab
- **触发时机**：需要根据队列、机构、小组隐藏字段时
- **所在页面**：字段展示配置页面（弹窗）
- **流程节点**：选择字段 → 配置隐藏规则（队列/机构/小组）→ 保存

**场景7：复制场景配置**
- **入口**：字段展示配置页面 → 点击"复制场景配置"按钮
- **触发时机**：需要将一个场景的配置复制到另一个场景时
- **所在页面**：字段展示配置页面（弹窗）
- **流程节点**：选择源场景 → 选择目标场景 → 确认复制 → 保存

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 配置所有甲方的字段展示规则 | 高 |
| 甲方管理员 | TenantAdmin | 配置本甲方的字段展示规则 | 高 |
| 机构管理员 | AgencyAdmin | 查看字段展示配置，了解字段结构 | 低 |
| 小组管理员 | TeamLeader | 查看字段展示配置，了解字段结构 | 低 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 字段展示配置流程

```
管理员进入字段展示配置页面
    ↓
选择甲方（必选）
    ↓
选择场景类型（admin_case_list/collector_case_list/collector_case_detail）
    ↓
加载可用字段列表（标准字段 + 自定义字段）
    ↓
加载已配置的字段列表
    ↓
支持操作：
  - 添加字段配置：选择字段 → 配置属性 → 保存
  - 编辑字段配置：修改配置属性 → 保存
  - 删除字段配置：删除配置
  - 拖拽排序：拖拽字段行 → 自动保存排序
  - 批量保存：批量保存所有配置
```

#### 3.2 添加字段配置流程

```
管理员点击"添加字段配置"按钮
    ↓
打开添加字段配置弹窗
    ↓
选择字段（从可用字段列表中选择）
    ↓
配置基本信息：
  - 场景类型（自动填充）
  - 字段名称（自动填充）
  - 字段标识（自动填充）
  - 字段类型（自动填充）
  - 显示宽度（默认0，自动）
  - 颜色类型（默认normal）
    ↓
配置筛选属性（仅枚举字段）：
  - 是否可筛选（开关）
    ↓
配置范围检索属性（仅数字/日期字段）：
  - 是否支持范围检索（开关）
    ↓
配置颜色规则（可选）：
  - 添加颜色规则（条件表达式）
    ↓
配置隐藏规则（可选）：
  - 选择队列/机构/小组
    ↓
配置格式化规则（可选）：
  - 选择格式类型（日期/数字/货币/百分比）
    ↓
点击"保存"按钮
    ↓
校验配置信息
    ↓
[校验失败] → 显示错误提示
    ↓
[校验成功] → 保存到数据库
    ↓
刷新字段配置列表
```

#### 3.3 编辑字段配置流程

```
管理员点击"编辑"按钮
    ↓
打开编辑字段配置弹窗（预填充配置信息）
    ↓
修改配置属性：
  - 显示宽度
  - 颜色类型
  - 颜色规则
  - 隐藏规则
  - 格式化规则
  - 是否可筛选（仅枚举字段）
  - 是否支持范围检索（仅数字/日期字段）
    ↓
点击"保存"按钮
    ↓
校验配置信息
    ↓
[校验失败] → 显示错误提示
    ↓
[校验成功] → 更新数据库
    ↓
刷新字段配置列表
```

#### 3.4 拖拽排序流程

```
管理员拖拽字段行
    ↓
系统自动计算新的排序顺序
    ↓
更新字段的sort_order值
    ↓
自动保存排序（或批量保存时保存）
    ↓
刷新字段配置列表
```

#### 3.5 批量保存流程

```
管理员修改多个字段配置
    ↓
点击"批量保存"按钮
    ↓
系统收集所有修改的配置
    ↓
批量校验配置信息
    ↓
[校验失败] → 显示错误提示，不保存
    ↓
[校验成功] → 批量保存到数据库
    ↓
刷新字段配置列表
    ↓
显示保存成功提示
```

#### 3.6 复制场景配置流程

```
管理员点击"复制场景配置"按钮
    ↓
打开复制场景配置弹窗
    ↓
选择源场景类型（下拉选择）
    ↓
选择目标场景类型（下拉选择）
    ↓
显示源场景的配置数量
    ↓
点击"确认复制"按钮
    ↓
系统复制源场景的所有配置到目标场景
    ↓
保存目标场景的配置
    ↓
刷新字段配置列表
    ↓
显示复制成功提示
```

#### 3.7 颜色规则配置流程

```
管理员点击"编辑"按钮 → "颜色规则"Tab
    ↓
添加颜色规则：
  - 条件表达式（如：overdue_days > 30）
  - 颜色类型（red/yellow/green）
    ↓
支持添加多个颜色规则（按优先级排序）
    ↓
保存颜色规则
    ↓
系统在展示时根据条件表达式判断显示颜色
```

#### 3.8 隐藏规则配置流程

```
管理员点击"编辑"按钮 → "隐藏规则"Tab
    ↓
选择隐藏类型：
  - 按队列隐藏：选择队列列表
  - 按机构隐藏：选择机构列表
  - 按小组隐藏：选择小组列表
    ↓
支持多选（可同时选择多个队列/机构/小组）
    ↓
保存隐藏规则
    ↓
系统在展示时根据案件所属队列/机构/小组判断是否隐藏字段
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 场景类型规则

**支持的场景类型**：
- `admin_case_list`：控台案件管理列表
- `collector_case_list`：催员案件列表
- `collector_case_detail`：催员案件详情

**场景配置规则**：
- 每个场景的配置相互独立
- 支持场景配置复制（将一个场景的配置复制到另一个场景）
- 同一字段可以在不同场景下有不同的配置

**范围边界**：
- ✅ 支持3种场景类型的配置
- ✅ 支持场景配置复制
- ❌ 不支持自定义场景类型

#### 4.2 字段选择规则

**可用字段来源**：
- 标准字段（field_source='standard'）
- 自定义字段（field_source='custom'）

**字段选择规则**：
- 只能选择已映射的标准字段或已创建的自定义字段
- 同一字段在同一场景下只能配置一次
- 支持从可用字段列表中选择字段添加到配置

**范围边界**：
- ✅ 支持标准字段和自定义字段
- ✅ 支持字段搜索和筛选
- ❌ 不支持未映射的字段

#### 4.3 排序配置规则

**排序规则**：
- 排序顺序（sort_order）：数字，越小越靠前
- 支持拖拽排序，自动更新sort_order
- 支持手动输入排序数字
- 默认排序：按字段创建时间或配置时间

**范围边界**：
- ✅ 支持拖拽排序
- ✅ 支持手动输入排序数字
- ❌ 不支持按字段值排序

#### 4.4 显示宽度配置规则

**宽度规则**：
- 显示宽度（display_width）：数字，单位像素
- 0表示自动宽度（根据内容自适应）
- 最小宽度：50像素
- 最大宽度：500像素
- 默认宽度：0（自动）

**范围边界**：
- ✅ 支持固定宽度和自动宽度
- ✅ 支持宽度范围限制
- ❌ 不支持百分比宽度

#### 4.5 颜色配置规则

**颜色类型**：
- `normal`：普通颜色（默认）
- `red`：红色
- `yellow`：黄色
- `green`：绿色

**颜色规则**：
- 支持条件表达式配置颜色规则
- 条件表达式格式：`字段名 操作符 值`
- 支持多个颜色规则（按优先级排序）
- 示例：
  - `overdue_days > 30` → 红色
  - `overdue_days > 15 && overdue_days <= 30` → 黄色
  - `overdue_days <= 15` → 绿色

**范围边界**：
- ✅ 支持4种颜色类型
- ✅ 支持条件表达式配置
- ❌ 不支持自定义颜色

#### 4.6 筛选配置规则

**筛选规则**：
- 仅枚举类型字段支持筛选
- 是否可筛选（is_filterable）：开关
- 筛选选项从字段枚举配置中获取
- 支持多选筛选

**范围边界**：
- ✅ 支持枚举字段筛选
- ❌ 不支持文本字段筛选（文本字段使用搜索功能）

#### 4.7 范围检索配置规则

**范围检索规则**：
- 仅数字类型和日期类型字段支持范围检索
- 是否支持范围检索（is_range_searchable）：开关
- 数字类型：支持最小值-最大值范围检索
- 日期类型：支持开始日期-结束日期范围检索

**范围边界**：
- ✅ 支持数字字段范围检索
- ✅ 支持日期字段范围检索
- ❌ 不支持文本字段范围检索

#### 4.8 隐藏规则配置规则

**隐藏规则类型**：
- 按队列隐藏：选择队列列表，字段在指定队列中隐藏
- 按机构隐藏：选择机构列表，字段在指定机构中隐藏
- 按小组隐藏：选择小组列表，字段在指定小组中隐藏

**隐藏规则逻辑**：
- 支持多选（可同时选择多个队列/机构/小组）
- 隐藏规则优先级：队列 > 机构 > 小组
- 如果案件属于隐藏的队列/机构/小组，则隐藏字段

**范围边界**：
- ✅ 支持按队列/机构/小组隐藏
- ✅ 支持多选隐藏
- ❌ 不支持按催员隐藏

#### 4.9 格式化规则配置规则

**格式化类型**：
- `date`：日期格式（YYYY-MM-DD）
- `datetime`：日期时间格式（YYYY-MM-DD HH:mm:ss）
- `number`：数字格式（千分位分隔符）
- `currency`：货币格式（¥符号 + 千分位分隔符）
- `percent`：百分比格式（%符号）

**格式化规则**：
- 支持前缀和后缀配置
- 支持自定义格式模式
- 示例：
  - 货币格式：`prefix: "¥", format_type: "currency"`
  - 百分比格式：`format_type: "percent", suffix: "%"`

**范围边界**：
- ✅ 支持5种格式化类型
- ✅ 支持前缀和后缀配置
- ❌ 不支持自定义格式化函数

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据隐私保护

**敏感字段处理**：
- PII字段（个人身份信息）：身份证号、手机号等需要脱敏显示
- 敏感字段：收入、地址等需要权限控制
- 支持按字段配置隐私级别和脱敏规则

**隐私设置规则**：
- 支持按字段配置隐私级别
- 支持按角色配置字段可见性
- 支持按队列配置字段隐藏规则

#### 5.2 数据安全

**权限控制**：
- 字段展示配置：SuperAdmin和TenantAdmin可以操作
- TenantAdmin只能配置自己甲方的字段展示配置
- 其他角色：只能查看，不能编辑

**数据校验**：
- 字段配置唯一性校验：同一字段在同一场景下只能配置一次
- 字段类型校验：筛选和范围检索属性需要匹配字段类型
- 颜色规则表达式校验：条件表达式格式校验

#### 5.3 审计要求

**操作日志**：
- 记录字段展示配置的所有变更操作（创建、编辑、删除）
- 记录场景配置复制操作
- 记录批量保存操作
- 记录操作人、操作时间、操作内容

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不适用**：本功能不涉及资金流转。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 甲方字段展示配置表（tenant_field_display_configs）

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|---------|
| id | BIGINT | 主键ID | 系统自增 | - |
| tenant_id | BIGINT | 所属甲方ID | 系统自动 | - |
| scene_type | VARCHAR(50) | 场景类型 | 管理员选择 | 可编辑 |
| scene_name | VARCHAR(100) | 场景名称 | 系统自动 | - |
| field_key | VARCHAR(100) | 字段标识 | 管理员选择 | 可编辑 |
| field_name | VARCHAR(200) | 字段名称 | 系统自动 | - |
| field_data_type | VARCHAR(50) | 字段数据类型 | 系统自动 | - |
| field_source | VARCHAR(20) | 字段来源 | 系统自动 | - |
| sort_order | INT | 排序顺序 | 管理员配置 | 可编辑 |
| display_width | INT | 显示宽度（像素） | 管理员配置 | 可编辑 |
| color_type | VARCHAR(20) | 颜色类型 | 管理员配置 | 可编辑 |
| color_rule | JSON | 颜色规则 | 管理员配置 | 可编辑 |
| hide_rule | JSON | 隐藏规则 | 管理员配置 | 可编辑 |
| hide_for_queues | JSON | 对哪些队列隐藏 | 管理员配置 | 可编辑 |
| hide_for_agencies | JSON | 对哪些机构隐藏 | 管理员配置 | 可编辑 |
| hide_for_teams | JSON | 对哪些小组隐藏 | 管理员配置 | 可编辑 |
| format_rule | JSON | 格式化规则 | 管理员配置 | 可编辑 |
| is_searchable | BOOLEAN | 是否可搜索 | 管理员配置 | 可编辑 |
| is_filterable | BOOLEAN | 是否可筛选 | 管理员配置 | 可编辑 |
| is_range_searchable | BOOLEAN | 是否支持范围检索 | 管理员配置 | 可编辑 |
| created_at | DATETIME | 创建时间 | 系统自动 | - |
| updated_at | DATETIME | 更新时间 | 系统自动 | - |
| created_by | VARCHAR(100) | 创建人 | 系统自动 | - |
| updated_by | VARCHAR(100) | 更新人 | 系统自动 | - |

---

### 8. 交互与信息展示（UX & UI Brief）

#### 8.1 字段展示配置页面

**布局**：
- 顶部：甲方选择器、场景类型选择器、操作按钮（添加字段配置、复制场景配置、批量保存）
- 表格：字段配置列表（可拖拽排序）

**字段配置列表表格列**：
- 拖拽手柄（用于排序）
- 序号
- 字段名称（Tag显示）
- 字段标识
- 字段类型（Tag显示）
- 映射类型（标准/自定义，Tag显示）
- 显示宽度（数字输入，0=自动）
- 颜色（下拉选择：普通/红色/黄色/绿色）
- 可筛选（开关，仅枚举字段）
- 范围检索（开关，仅数字/日期字段）
- 隐藏规则（Tag显示：队列/机构/小组数量）
- 操作（编辑、删除）

**功能**：
- 支持拖拽排序
- 支持批量保存
- 支持场景配置复制

#### 8.2 添加/编辑字段配置弹窗

**布局**：
- Tabs：基本信息、颜色规则、隐藏规则、格式化规则

**基本信息Tab**：
- 场景类型（下拉选择，编辑时禁用）
- 选择字段（下拉选择，仅添加时显示）
- 字段名称（自动填充，只读）
- 字段标识（自动填充，只读）
- 字段类型（自动填充，只读）
- 显示宽度（数字输入，0=自动）
- 颜色类型（下拉选择：普通/红色/黄色/绿色）
- 是否可筛选（开关，仅枚举字段）
- 是否支持范围检索（开关，仅数字/日期字段）

**颜色规则Tab**：
- 颜色规则列表（可添加、编辑、删除）
- 条件表达式输入框
- 颜色类型下拉选择

**隐藏规则Tab**：
- 按队列隐藏（多选下拉）
- 按机构隐藏（多选下拉）
- 按小组隐藏（多选下拉）

**格式化规则Tab**：
- 格式类型（下拉选择：日期/日期时间/数字/货币/百分比）
- 前缀（文本输入）
- 后缀（文本输入）
- 格式模式（文本输入，可选）

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 场景类型配置

**可配置的场景类型**：
- admin_case_list（控台案件管理列表）
- collector_case_list（催员案件列表）
- collector_case_detail（催员案件详情）

**配置入口**：系统设置 → 字段展示配置 → 场景类型

#### 9.2 颜色类型配置

**可配置的颜色类型**：
- normal（普通）
- red（红色）
- yellow（黄色）
- green（绿色）

**配置入口**：字段展示配置 → 编辑字段配置 → 颜色类型下拉选择

#### 9.3 格式化类型配置

**可配置的格式化类型**：
- date（日期）
- datetime（日期时间）
- number（数字）
- currency（货币）
- percent（百分比）

**配置入口**：字段展示配置 → 编辑字段配置 → 格式化规则Tab

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 进入字段展示配置页面 | 查看字段展示配置页面 | view_field_display_config_page | tenant_id, user_id, scene_type |
| 添加字段配置 | 添加字段展示配置 | add_field_display_config | tenant_id, user_id, scene_type, field_key |
| 编辑字段配置 | 编辑字段展示配置 | edit_field_display_config | tenant_id, user_id, scene_type, field_key, config_id |
| 删除字段配置 | 删除字段展示配置 | delete_field_display_config | tenant_id, user_id, scene_type, config_id |
| 拖拽字段排序 | 拖拽字段排序 | drag_field_sort | tenant_id, user_id, scene_type, field_key, new_sort_order |
| 批量保存配置 | 批量保存字段展示配置 | batch_save_field_display_config | tenant_id, user_id, scene_type, config_count |
| 复制场景配置 | 复制场景配置 | copy_scene_config | tenant_id, user_id, source_scene_type, target_scene_type |
| 配置颜色规则 | 配置字段颜色规则 | config_color_rule | tenant_id, user_id, scene_type, field_key, rule_count |
| 配置隐藏规则 | 配置字段隐藏规则 | config_hide_rule | tenant_id, user_id, scene_type, field_key, hide_type |
| 配置格式化规则 | 配置字段格式化规则 | config_format_rule | tenant_id, user_id, scene_type, field_key, format_type |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 模块划分

```
甲方字段展示配置模块
│
├── 字段展示配置管理模块
│   ├── FieldDisplayConfigController（字段展示配置API）
│   ├── FieldDisplayConfigService（字段展示配置业务逻辑）
│   └── TenantFieldDisplayConfigMapper（字段展示配置数据访问）
│
└── 场景配置管理模块
    ├── SceneConfigService（场景配置业务逻辑）
    └── SceneConfigMapper（场景配置数据访问）
```

#### 1.2 调用关系

```
前端页面
    ↓
Controller层（API接口）
    ↓
Service层（业务逻辑）
    ↓
Mapper层（数据访问）
    ↓
数据库（MySQL）
```

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 字段展示配置管理接口

**2.1.1 获取字段展示配置列表**
- **接口**：`GET /api/v1/field-display-configs`
- **请求参数**：
  - `tenant_id`（必填）：甲方ID
  - `scene_type`（可选）：场景类型
  - `field_key`（可选）：字段标识
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_id": 1,
      "scene_type": "admin_case_list",
      "scene_name": "控台案件管理列表",
      "field_key": "user_name",
      "field_name": "用户姓名",
      "field_data_type": "String",
      "field_source": "standard",
      "sort_order": 1,
      "display_width": 120,
      "color_type": "normal",
      "color_rule": null,
      "hide_rule": null,
      "hide_for_queues": [],
      "hide_for_agencies": [],
      "hide_for_teams": [],
      "format_rule": null,
      "is_searchable": true,
      "is_filterable": false,
      "is_range_searchable": false
    }
  ]
}
```

**2.1.2 创建字段展示配置**
- **接口**：`POST /api/v1/field-display-configs`
- **请求体**：
```json
{
  "tenant_id": 1,
  "scene_type": "admin_case_list",
  "field_key": "user_name",
  "display_width": 120,
  "color_type": "normal",
  "is_filterable": false,
  "is_range_searchable": false
}
```

**2.1.3 更新字段展示配置**
- **接口**：`PUT /api/v1/field-display-configs/{id}`
- **请求体**：同创建接口

**2.1.4 删除字段展示配置**
- **接口**：`DELETE /api/v1/field-display-configs/{id}`

**2.1.5 批量更新字段展示配置**
- **接口**：`PUT /api/v1/field-display-configs/batch`
- **请求体**：
```json
{
  "tenant_id": 1,
  "scene_type": "admin_case_list",
  "configs": [
    {
      "id": 1,
      "sort_order": 1,
      "display_width": 120,
      "color_type": "normal"
    },
    {
      "id": 2,
      "sort_order": 2,
      "display_width": 150,
      "color_type": "red"
    }
  ]
}
```

**2.1.6 复制场景配置**
- **接口**：`POST /api/v1/field-display-configs/copy-scene`
- **请求体**：
```json
{
  "tenant_id": 1,
  "source_scene_type": "admin_case_list",
  "target_scene_type": "collector_case_list"
}
```

**2.1.7 获取可用字段列表**
- **接口**：`GET /api/v1/field-display-configs/available-fields`
- **请求参数**：
  - `tenant_id`（必填）：甲方ID
  - `scene_type`（可选）：场景类型
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "field_key": "user_name",
      "field_name": "用户姓名",
      "field_type": "String",
      "field_source": "standard",
      "field_group_id": 1,
      "is_extended": false,
      "description": "用户姓名"
    }
  ]
}
```

#### 2.2 接口依赖

**内部依赖**：
- 标准字段服务：获取标准字段列表
- 自定义字段服务：获取自定义字段列表
- 字段分组服务：获取字段分组信息

**外部依赖**：
- 无

#### 2.3 超时与重试策略

- **超时时间**：5秒
- **重试策略**：不重试
- **幂等要求**：创建和更新接口需要幂等

#### 2.4 失败降级逻辑

- **创建失败**：返回错误信息，不保存
- **更新失败**：返回错误信息，不更新数据库
- **批量保存失败**：返回错误信息，不保存任何配置

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 依赖的现有表

- `tenant_field_display_configs`：甲方字段展示配置表
- `standard_fields`：标准字段定义表
- `custom_fields`：自定义字段表
- `field_groups`：字段分组表

#### 3.2 索引优化

**tenant_field_display_configs表索引**：
- 主键：`id`
- 唯一索引：`tenant_id + scene_type + field_key`
- 普通索引：`tenant_id`、`scene_type`、`field_key`

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **接口响应时间**：所有接口响应时间≤300ms
- **字段配置列表加载**：加载100个字段配置≤500ms
- **批量保存性能**：批量保存50个配置≤1秒

#### 4.2 可用性要求

- **SLA**：接口可用性≥99.9%
- **降级策略**：操作失败时返回详细错误信息

#### 4.3 安全要求

- **接口鉴权**：所有接口需要Token验证
- **权限控制**：SuperAdmin和TenantAdmin可以操作，TenantAdmin只能操作自己甲方的数据
- **数据校验**：字段配置唯一性、字段类型匹配、颜色规则表达式格式

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

**必须记录的日志**：
- 字段展示配置的所有变更操作（创建、编辑、删除）
- 批量保存操作
- 场景配置复制操作
- 颜色规则和隐藏规则配置操作

**日志格式**：
```
[INFO] 创建字段展示配置 - tenantId=1, sceneType=admin_case_list, fieldKey=user_name, userId=admin
[INFO] 批量保存字段展示配置 - tenantId=1, sceneType=admin_case_list, configCount=10, userId=admin
[INFO] 复制场景配置 - tenantId=1, sourceScene=admin_case_list, targetScene=collector_case_list, userId=admin
```

#### 5.2 监控指标

**关键指标**：
- 字段展示配置创建成功率
- 批量保存成功率
- 场景配置复制成功率
- 接口错误率

**告警规则**：
- 接口错误率>1%：发送告警
- 批量保存失败率>5%：发送告警

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 字段配置唯一性校验测试
- 字段类型匹配校验测试
- 颜色规则表达式校验测试
- 隐藏规则逻辑测试

**集成测试**：
- 字段展示配置创建接口测试
- 批量保存接口测试
- 场景配置复制接口测试
- 权限验证测试

#### 6.2 验收标准

**关键验收标准**：
1. ✅ 字段配置唯一性校验准确率100%
2. ✅ 字段类型匹配校验准确率100%
3. ✅ 颜色规则表达式校验准确率100%
4. ✅ 权限控制有效：只有SuperAdmin和TenantAdmin可以操作
5. ✅ 批量保存成功率≥99%

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**灰度发布**：
- 第一阶段：内部测试环境验证（1周）
- 第二阶段：小范围甲方测试（选择1-2个甲方，1周）
- 第三阶段：全量发布（所有甲方）

#### 7.2 回滚方案

**回滚步骤**：
1. 关闭功能入口
2. 保留已创建的配置（不删除）
3. 修复问题后重新发布

---

**文档版本**：v1.0.0  
**创建日期**：2025-11-25  
**最后更新**：2025-11-25  
**状态**：待评审

