# 字段映射配置 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

字段映射配置是CCO管理控台的核心功能之一，用于将甲方通过API推送的字段与系统标准字段建立映射关系。不同甲方客户的字段命名和结构差异很大，系统需要支持灵活的字段映射机制，让管理员能够将甲方的字段映射到系统标准字段，确保数据的一致性和可处理性。同时，对于无法映射到标准字段的甲方特有字段，系统支持创建自定义拓展字段进行独立管理。通过统一的字段映射配置，确保所有甲方字段都能被正确处理和展示。

**业务痛点**：
- 不同甲方字段命名和结构差异大，需要灵活的映射机制
- 字段映射配置复杂，需要高效的匹配和配置工具
- 未映射字段可能导致数据丢失，需要强提醒机制
- 手动映射效率低，需要自动匹配建议功能
- 字段映射关系变更频繁，需要版本管理和变更追踪

**预期影响的核心指标**：
- 字段映射效率：单个字段映射完成时间≤30秒
- 自动匹配准确率：自动匹配建议准确率≥80%
- 字段映射覆盖率：必填字段映射覆盖率≥100%
- 未映射字段处理率：未映射字段处理率≥95%
- 用户满意度：管理员对字段映射功能满意度≥90%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：查看字段映射列表**
- **入口**：管理控台菜单 → 字段配置 → 字段映射配置
- **触发时机**：需要查看或配置甲方字段映射关系时
- **所在页面**：`/field-config/custom` → "匹配目标字段"Tab
- **流程节点**：选择甲方 → 选择字段分组 → 查看字段映射列表 → 配置映射关系

**场景2：手动配置字段映射**
- **入口**：字段映射配置页面 → 点击"甲方字段"下拉选择
- **触发时机**：需要将甲方字段映射到标准字段时
- **所在页面**：字段映射配置页面
- **流程节点**：选择标准字段 → 选择甲方字段 → 保存映射关系

**场景3：一键建议映射**
- **入口**：字段映射配置页面 → 点击"一键建议映射未匹配字段"按钮
- **触发时机**：有多个未映射字段需要快速处理时
- **所在页面**：字段映射配置页面
- **流程节点**：点击按钮 → 系统生成映射建议 → 管理员确认 → 批量保存

**场景4：管理拓展字段**
- **入口**：字段映射配置页面 → "拓展字段"Tab
- **触发时机**：甲方有特殊字段需求，无法映射到标准字段时
- **所在页面**：字段映射配置页面 → "拓展字段"Tab
- **流程节点**：选择字段分组 → 添加拓展字段 → 配置字段属性（类型、隐私标签等）

**场景5：处理未使用的甲方字段**
- **入口**：字段映射配置页面 → "未使用的甲方字段"Tab
- **触发时机**：甲方推送了新字段但未映射时
- **所在页面**：字段映射配置页面 → "未使用的甲方字段"Tab
- **流程节点**：查看未使用字段列表 → 选择处理方式（匹配到目标字段/设为拓展字段）→ 保存

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 配置所有甲方的字段映射关系 | 高 |
| 甲方管理员 | TenantAdmin | 配置本甲方的字段映射关系 | 高 |
| 机构管理员 | AgencyAdmin | 查看字段映射关系，了解字段结构 | 低 |
| 小组管理员 | TeamLeader | 查看字段映射关系，了解字段结构 | 低 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 字段映射配置流程

```
管理员进入字段映射配置页面
    ↓
选择甲方（必选）
    ↓
切换到"匹配目标字段"Tab
    ↓
加载标准字段列表（按分组展示）
    ↓
加载甲方字段列表（从JSON文件或API获取）
    ↓
显示字段映射列表：
  - 目标字段（标准字段）
  - 匹配状态（未映射/已自动映射/已手动映射）
  - 甲方字段（下拉选择）
  - 枚举值（枚举字段）
  - 来源（标准/自定义）
    ↓
支持操作：
  - 手动选择甲方字段进行映射
  - 一键建议映射未匹配字段
  - 编辑映射关系
  - 删除映射关系
```

#### 3.2 手动配置字段映射流程

```
管理员选择标准字段
    ↓
点击"甲方字段"下拉选择框
    ↓
显示甲方字段列表（可搜索）
    ↓
选择甲方字段
    ↓
系统自动保存映射关系：
  - tenant_field_key：甲方字段标识
  - tenant_field_id：甲方字段ID
  - mapping_status：手动映射
    ↓
刷新字段映射列表
```

#### 3.3 一键建议映射流程

```
管理员点击"一键建议映射未匹配字段"按钮
    ↓
系统分析未映射的甲方字段
    ↓
基于字段名称相似度算法生成映射建议：
  - 字段名称相似度匹配
  - 同义词匹配
  - 字段类型匹配
    ↓
显示映射建议列表（弹窗）
    ↓
管理员确认/修改映射建议
    ↓
[确认] → 批量保存映射关系
    ↓
[取消] → 关闭弹窗，不保存
```

#### 3.4 自动匹配算法流程

```
获取未映射的甲方字段列表
    ↓
获取未映射的标准字段列表
    ↓
遍历甲方字段，计算与标准字段的相似度：
  - 字段名称相似度（字符串匹配、编辑距离）
  - 字段类型匹配度
  - 同义词匹配度
    ↓
为每个甲方字段找到最相似的标准字段
    ↓
生成映射建议列表：
  - 相似度≥80%：自动映射
  - 相似度60%-80%：建议映射（需确认）
  - 相似度<60%：不建议映射
    ↓
返回映射建议结果
```

#### 3.5 创建拓展字段流程

```
管理员切换到"拓展字段"Tab
    ↓
选择字段分组（左侧树）
    ↓
点击"添加拓展字段"按钮
    ↓
打开添加拓展字段弹窗
    ↓
填写字段信息：
  - 扩展字段别名（field_alias）：必填，系统内部使用
  - 甲方原始字段（tenant_field_key）：必填，甲方字段标识
  - 甲方字段名称（tenant_field_name）：必填
  - 字段类型（field_type）：必填，下拉选择
  - 所属分组（field_group_id）：必填，下拉选择
  - 隐私标签（privacy_label）：必填，PII/敏感/公开
  - 是否必填（is_required）：开关，默认false
    ↓
点击"保存"按钮
    ↓
校验字段信息
    ↓
[校验失败] → 显示错误提示
    ↓
[校验成功] → 保存到数据库
    ↓
刷新拓展字段列表
```

#### 3.6 处理未使用的甲方字段流程

```
管理员切换到"未使用的甲方字段"Tab
    ↓
系统自动检测未使用的甲方字段：
  - 获取所有甲方字段
  - 获取已映射的字段（匹配到标准字段）
  - 获取已创建拓展字段的字段
  - 计算未使用的字段
    ↓
显示未使用字段列表（红色警告）
    ↓
管理员选择处理方式：
  - 匹配到目标字段：选择标准字段进行映射
  - 设为拓展字段：创建为拓展字段
    ↓
批量处理或单个处理
    ↓
保存处理结果
    ↓
刷新字段列表
```

#### 3.7 枚举值映射流程

```
管理员选择枚举类型的标准字段
    ↓
系统加载标准字段的枚举值列表
    ↓
系统加载甲方字段的枚举值列表
    ↓
自动匹配枚举值：
  - 按value匹配
  - 按label匹配
  - 按standard_name匹配
    ↓
显示枚举值映射关系：
  - 已匹配的枚举值（绿色）
  - 未匹配的枚举值（红色）
    ↓
管理员手动配置未匹配的枚举值
    ↓
保存枚举值映射关系
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 字段映射规则

**映射关系规则**：
- **一对一映射**：一个标准字段只能映射到一个甲方字段
- **一对多映射**：不支持（一个标准字段不能映射到多个甲方字段）
- **多对一映射**：不支持（多个标准字段不能映射到同一个甲方字段）
- **映射状态**：
  - `unmapped`：未映射
  - `auto_mapped`：已自动映射（系统自动匹配）
  - `manual_mapped`：已手动映射（管理员手动配置）

**必填字段规则**：
- 标准字段中标记为`is_required=true`的字段必须映射
- 未映射的必填字段在页面顶部显示红色警告
- 支持筛选：仅显示未映射的必填字段
- 未映射的必填字段在列表中高亮显示

**字段类型匹配规则**：
- 标准字段和甲方字段的类型必须匹配或兼容
- 类型匹配规则：
  - `String` ↔ `String`、`Text`：匹配
  - `Integer` ↔ `Integer`、`Number`：匹配
  - `Decimal` ↔ `Decimal`、`Float`、`Double`：匹配
  - `Date` ↔ `Date`：匹配
  - `Datetime` ↔ `Datetime`、`Timestamp`：匹配
  - `Boolean` ↔ `Boolean`、`Bool`：匹配
  - `Enum` ↔ `Enum`：匹配（需配置枚举值映射）

**范围边界**：
- ✅ 支持标准字段与甲方字段的映射
- ✅ 支持自动匹配和手动配置
- ✅ 支持枚举值映射
- ✅ 支持映射关系的增删改查
- ❌ 不支持一对多映射
- ❌ 不支持多对一映射

#### 4.2 拓展字段管理规则

**拓展字段属性规则**：
- **扩展字段别名（field_alias）**：
  - 必填，在甲方内唯一
  - 只能包含小写字母、数字和下划线
  - 长度限制：1-100个字符
- **甲方原始字段（tenant_field_key）**：
  - 必填，甲方字段标识
  - 长度限制：1-100个字符
- **字段类型（field_type）**：
  - 必填，同标准字段类型
- **所属分组（field_group_id）**：
  - 必填，必须在系统中存在
- **隐私标签（privacy_label）**：
  - 必填，必须是：PII/敏感/公开
- **是否必填（is_required）**：
  - 默认false，可编辑

**操作规则**：
- 拓展字段完全由管理员控制
- 支持添加、编辑、删除拓展字段
- 拓展字段不映射到标准字段
- 拓展字段独立管理，不影响标准字段

**范围边界**：
- ✅ 支持拓展字段的完全管理
- ✅ 支持隐私标签配置
- ✅ 支持字段分组配置
- ❌ 不支持拓展字段映射到标准字段

#### 4.3 未使用字段处理规则

**未使用字段判断逻辑**：
- 获取所有甲方字段（从JSON文件或API获取）
- 获取已映射的字段（匹配到标准字段的字段）
- 获取已创建拓展字段的字段
- 计算未使用的字段：甲方字段 - 已映射字段 - 已创建拓展字段

**强提醒机制**：
- 页面顶部显示红色警告：`警告：发现 X 个未使用的甲方字段，请尽快处理！`
- 未使用字段可能导致数据丢失
- 支持一键批量处理：批量匹配或批量创建拓展字段

**处理方式**：
- **匹配到目标字段**：选择标准字段进行映射
- **设为拓展字段**：创建为拓展字段

**范围边界**：
- ✅ 支持自动检测未使用字段
- ✅ 支持批量处理未使用字段
- ✅ 支持单个处理未使用字段
- ❌ 不支持自动删除未使用字段

#### 4.4 自动匹配规则

**匹配算法**：
- **字段名称相似度**：
  - 字符串完全匹配：100%
  - 字符串包含匹配：80%
  - 编辑距离匹配：60%-80%
  - 同义词匹配：70%
- **字段类型匹配**：
  - 类型完全匹配：+10%
  - 类型兼容匹配：+5%
- **综合相似度**：
  - 相似度≥80%：自动映射
  - 相似度60%-80%：建议映射（需确认）
  - 相似度<60%：不建议映射

**匹配优先级**：
1. 字段名称完全匹配
2. 字段名称包含匹配
3. 同义词匹配
4. 编辑距离匹配

**范围边界**：
- ✅ 支持基于字段名称的自动匹配
- ✅ 支持基于字段类型的匹配
- ✅ 支持同义词匹配
- ❌ 不支持基于字段值的匹配
- ❌ 不支持机器学习匹配

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据隐私保护

**敏感字段处理**：
- PII字段（个人身份信息）：身份证号、手机号等需要脱敏显示
- 敏感字段：收入、地址等需要权限控制
- 公开字段：公司名称等可以正常显示

**隐私设置规则**：
- 支持按字段配置隐私级别
- 支持按角色配置字段可见性
- 支持按队列配置字段隐藏规则

#### 5.2 数据安全

**权限控制**：
- 字段映射配置：SuperAdmin和TenantAdmin可以操作
- TenantAdmin只能配置自己甲方的字段映射
- 其他角色：只能查看，不能编辑

**数据校验**：
- 字段映射关系唯一性校验：防止重复映射
- 字段类型匹配校验：防止类型错误导致系统异常
- 必填字段映射校验：确保必填字段都已映射

#### 5.3 审计要求

**操作日志**：
- 记录字段映射关系的所有变更操作（创建、编辑、删除）
- 记录拓展字段的所有变更操作（创建、编辑、删除）
- 记录自动匹配操作（匹配建议、确认匹配）
- 记录操作人、操作时间、操作内容

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不适用**：本功能不涉及资金流转。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 甲方字段配置表（tenant_field_configs）

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|---------|
| id | BIGINT | 主键ID | 系统自增 | - |
| tenant_id | BIGINT | 所属甲方ID | 系统自动 | - |
| field_key | VARCHAR(100) | 标准字段标识 | 系统自动 | - |
| tenant_field_key | VARCHAR(100) | 甲方字段标识 | 管理员配置 | 可编辑 |
| tenant_field_id | VARCHAR(100) | 甲方字段ID | 管理员配置 | 可编辑 |
| field_type | VARCHAR(20) | 字段类型 | 系统自动 | - |
| mapping_status | VARCHAR(20) | 映射状态 | 系统自动 | 可编辑 |
| auto_mapped | BOOLEAN | 是否自动映射 | 系统自动 | - |
| enum_mapping | JSON | 枚举值映射关系 | 管理员配置 | 可编辑 |
| is_required | BOOLEAN | 是否必填 | 系统自动 | - |
| created_at | DATETIME | 创建时间 | 系统自动 | - |
| updated_at | DATETIME | 更新时间 | 系统自动 | - |

#### 7.2 自定义字段表（custom_fields）

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|---------|
| id | BIGINT | 主键ID | 系统自增 | - |
| tenant_id | BIGINT | 所属甲方ID | 系统自动 | - |
| field_alias | VARCHAR(100) | 扩展字段别名 | 管理员输入 | 可编辑 |
| tenant_field_key | VARCHAR(100) | 甲方字段标识 | 管理员输入 | 可编辑 |
| tenant_field_name | VARCHAR(200) | 甲方字段名称 | 管理员输入 | 可编辑 |
| field_type | VARCHAR(50) | 字段类型 | 管理员选择 | 可编辑 |
| field_group_id | BIGINT | 所属分组ID | 管理员选择 | 可编辑 |
| privacy_label | VARCHAR(20) | 隐私标签 | 管理员选择 | 可编辑 |
| is_required | BOOLEAN | 是否必填 | 管理员配置 | 可编辑 |
| description | TEXT | 字段说明 | 管理员输入 | 可编辑 |
| enum_options | JSON | 枚举选项 | 管理员配置 | 可编辑 |
| sort_order | INT | 排序顺序 | 系统自动/手动 | 可编辑 |
| is_active | BOOLEAN | 是否启用 | 管理员配置 | 可编辑 |
| created_at | DATETIME | 创建时间 | 系统自动 | - |
| updated_at | DATETIME | 更新时间 | 系统自动 | - |

---

### 8. 交互与信息展示（UX & UI Brief）

#### 8.1 字段映射配置页面

**布局**：
- 顶部：甲方选择器、"一键建议映射未匹配字段"按钮、"添加自定义字段"按钮
- 左侧：字段分组树形结构（可折叠）
- 右侧：字段映射列表（表格形式）

**字段映射列表表格列**：
- 拖拽手柄（用于排序）
- 目标字段（标准字段名称和标识）
- 匹配状态（未映射/已自动映射/已手动映射，Tag显示）
- 甲方字段（下拉选择，可搜索）
- 枚举值（枚举字段的映射关系）
- 来源（标准/自定义，Tag显示）
- 甲方更新时间（字段最后更新时间）
- 是否必填（开关，标准字段不可编辑）
- 队列可见性（配置字段在特定队列中隐藏）
- 操作（编辑、删除）

**功能**：
- 支持按分组筛选
- 支持按匹配状态筛选（全部/未映射/已自动映射/已手动映射）
- 支持字段搜索（按字段名称或标识）
- 支持拖拽排序
- 支持必填字段高亮显示

#### 8.2 拓展字段管理页面

**布局**：
- 左侧：字段分组树形结构
- 右侧：拓展字段列表（表格形式）

**拓展字段列表表格列**：
- 扩展字段别名
- 甲方原始字段（字段名称 + 字段标识）
- 类型
- 隐私标签（PII/敏感/公开，Tag显示）
- 是否必填（开关）
- 操作（编辑、删除）

#### 8.3 未使用的甲方字段页面

**布局**：
- 顶部：红色警告提示
- 表格：未使用字段列表

**未使用字段列表表格列**：
- 字段名（甲方字段名称和标识）
- 类型
- 甲方更新时间
- 是否必填（必填/非必填，Tag显示）
- 操作（匹配到目标字段/设为扩展字段）

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 自动匹配配置

**匹配阈值配置**：
- `auto_match_threshold_high`：自动映射阈值（默认80%）
- `auto_match_threshold_low`：建议映射阈值（默认60%）

**配置入口**：系统设置 → 字段映射配置 → 自动匹配阈值

#### 9.2 同义词配置

**同义词库**：
- 支持配置字段名称同义词
- 例如：`用户ID` ↔ `USER_ID`、`UID`、`用户标识`

**配置入口**：系统设置 → 字段映射配置 → 同义词库

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 进入字段映射配置页面 | 查看字段映射配置页面 | view_field_mapping_page | tenant_id, user_id |
| 手动配置字段映射 | 手动配置字段映射关系 | manual_map_field | tenant_id, user_id, field_key, tenant_field_key |
| 一键建议映射 | 点击一键建议映射按钮 | click_auto_suggest_mapping | tenant_id, user_id |
| 确认自动匹配建议 | 确认自动匹配建议 | confirm_auto_match | tenant_id, user_id, match_count |
| 进入拓展字段管理页面 | 查看拓展字段管理页面 | view_extended_fields_page | tenant_id, user_id |
| 添加拓展字段 | 添加拓展字段 | add_extended_field | tenant_id, user_id, field_alias, field_type |
| 编辑拓展字段 | 编辑拓展字段 | edit_extended_field | tenant_id, user_id, field_id |
| 删除拓展字段 | 删除拓展字段 | delete_extended_field | tenant_id, user_id, field_id |
| 进入未使用字段页面 | 查看未使用字段页面 | view_unmapped_fields_page | tenant_id, user_id |
| 处理未使用字段 | 处理未使用字段 | process_unmapped_field | tenant_id, user_id, field_key, action_type |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 模块划分

```
字段映射配置模块
│
├── 字段映射管理模块
│   ├── TenantFieldConfigController（字段映射API）
│   ├── TenantFieldConfigService（字段映射业务逻辑）
│   └── TenantFieldConfigMapper（字段映射数据访问）
│
├── 拓展字段管理模块
│   ├── CustomFieldController（拓展字段API）
│   ├── CustomFieldService（拓展字段业务逻辑）
│   └── CustomFieldMapper（拓展字段数据访问）
│
└── 自动匹配模块
    ├── FieldMappingService（自动匹配算法）
    └── SynonymService（同义词匹配）
```

#### 1.2 调用关系

```
前端页面
    ↓
Controller层（API接口）
    ↓
Service层（业务逻辑）
    ↓
Mapper层（数据访问）
    ↓
数据库（MySQL）
```

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 字段映射管理接口

**2.1.1 获取字段映射列表**
- **接口**：`GET /api/v1/tenants/{tenantId}/field-configs`
- **请求参数**：
  - `field_group_id`（可选）：字段分组ID，用于筛选
  - `mapping_status`（可选）：映射状态，用于筛选
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_id": 1,
      "field_key": "user_id",
      "field_name": "用户ID",
      "field_type": "String",
      "tenant_field_key": "USER_ID",
      "tenant_field_id": "user_id_001",
      "mapping_status": "manual_mapped",
      "auto_mapped": false,
      "is_required": true,
      "enum_mapping": null
    }
  ]
}
```

**2.1.2 创建或更新字段映射**
- **接口**：`PUT /api/v1/tenants/{tenantId}/field-configs`
- **请求体**：
```json
{
  "field_key": "user_id",
  "tenant_field_key": "USER_ID",
  "tenant_field_id": "user_id_001",
  "enum_mapping": null
}
```

**2.1.3 删除字段映射**
- **接口**：`DELETE /api/v1/tenants/{tenantId}/field-configs/{id}`

**2.1.4 一键建议映射**
- **接口**：`POST /api/v1/tenants/{tenantId}/field-configs/auto-suggest`
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "suggestions": [
      {
        "field_key": "user_id",
        "field_name": "用户ID",
        "tenant_field_key": "USER_ID",
        "tenant_field_name": "用户ID",
        "similarity": 0.95,
        "match_type": "auto"
      }
    ]
  }
}
```

**2.1.5 批量确认映射建议**
- **接口**：`POST /api/v1/tenants/{tenantId}/field-configs/batch-confirm`
- **请求体**：
```json
{
  "mappings": [
    {
      "field_key": "user_id",
      "tenant_field_key": "USER_ID",
      "tenant_field_id": "user_id_001"
    }
  ]
}
```

#### 2.2 拓展字段管理接口

**2.2.1 获取拓展字段列表**
- **接口**：`GET /api/v1/tenants/{tenantId}/extended-fields`
- **请求参数**：
  - `field_group_id`（可选）：字段分组ID
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_id": 1,
      "field_alias": "company_name",
      "tenant_field_key": "COMPANY_NAME",
      "tenant_field_name": "公司名称",
      "field_type": "String",
      "field_group_id": 1,
      "privacy_label": "公开",
      "is_required": false
    }
  ]
}
```

**2.2.2 创建拓展字段**
- **接口**：`POST /api/v1/tenants/{tenantId}/extended-fields`
- **请求体**：
```json
{
  "field_alias": "company_name",
  "tenant_field_key": "COMPANY_NAME",
  "tenant_field_name": "公司名称",
  "field_type": "String",
  "field_group_id": 1,
  "privacy_label": "公开",
  "is_required": false
}
```

**2.2.3 更新拓展字段**
- **接口**：`PUT /api/v1/tenants/{tenantId}/extended-fields/{id}`
- **请求体**：同创建接口

**2.2.4 删除拓展字段**
- **接口**：`DELETE /api/v1/tenants/{tenantId}/extended-fields/{id}`

#### 2.3 未使用字段接口

**2.3.1 获取未使用的甲方字段列表**
- **接口**：`GET /api/v1/tenants/{tenantId}/unmapped-fields`
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "field_key": "unmapped_field_1",
      "field_name": "未映射字段1",
      "field_type": "String",
      "is_required": false,
      "updated_at": "2025-11-25T10:30:00Z"
    }
  ]
}
```

#### 2.4 接口依赖

**内部依赖**：
- 标准字段服务：获取标准字段列表
- 字段分组服务：校验field_group_id是否存在
- 甲方字段JSON服务：获取甲方字段列表

**外部依赖**：
- 无

#### 2.5 超时与重试策略

- **超时时间**：10秒（自动匹配接口可能需要较长时间）
- **重试策略**：不重试
- **幂等要求**：创建和更新接口需要幂等

#### 2.6 失败降级逻辑

- **自动匹配失败**：返回错误信息，不生成建议
- **映射保存失败**：返回错误信息，不保存映射关系
- **字段类型不匹配**：返回错误提示，不允许保存

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 依赖的现有表

- `tenant_field_configs`：甲方字段配置表
- `custom_fields`：自定义字段表
- `standard_fields`：标准字段定义表
- `field_groups`：字段分组表
- `tenant_fields_json`：甲方字段JSON版本表

#### 3.2 索引优化

**tenant_field_configs表索引**：
- 主键：`id`
- 唯一索引：`tenant_id + field_key`
- 普通索引：`tenant_id`、`field_key`、`mapping_status`

**custom_fields表索引**：
- 主键：`id`
- 唯一索引：`tenant_id + field_alias`
- 普通索引：`tenant_id`、`field_group_id`

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **接口响应时间**：所有接口响应时间≤500ms（除自动匹配接口）
- **自动匹配性能**：匹配100个字段≤3秒
- **字段映射列表加载**：加载100个字段映射≤1秒

#### 4.2 可用性要求

- **SLA**：接口可用性≥99.9%
- **降级策略**：自动匹配失败时，返回错误信息，不生成建议

#### 4.3 安全要求

- **接口鉴权**：所有接口需要Token验证
- **权限控制**：SuperAdmin和TenantAdmin可以操作，TenantAdmin只能操作自己甲方的数据
- **数据校验**：字段映射关系唯一性、字段类型匹配、必填字段映射

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

**必须记录的日志**：
- 字段映射关系的所有变更操作（创建、编辑、删除）
- 自动匹配操作（匹配建议、确认匹配）
- 拓展字段的所有变更操作（创建、编辑、删除）
- 未使用字段处理操作

**日志格式**：
```
[INFO] 创建字段映射 - tenantId=1, fieldKey=user_id, tenantFieldKey=USER_ID, userId=admin
[INFO] 自动匹配建议 - tenantId=1, suggestionCount=10, userId=admin
[INFO] 确认自动匹配 - tenantId=1, confirmedCount=8, userId=admin
[INFO] 创建拓展字段 - tenantId=1, fieldAlias=company_name, userId=admin
```

#### 5.2 监控指标

**关键指标**：
- 字段映射创建成功率
- 自动匹配准确率
- 必填字段映射覆盖率
- 未映射字段处理率

**告警规则**：
- 必填字段映射覆盖率<100%：发送告警
- 未映射字段数量>10：发送告警
- 接口错误率>1%：发送告警

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 字段映射关系唯一性校验测试
- 字段类型匹配校验测试
- 自动匹配算法测试
- 枚举值映射测试

**集成测试**：
- 字段映射创建接口测试
- 自动匹配接口测试
- 权限验证测试

#### 6.2 验收标准

**关键验收标准**：
1. ✅ 必填字段映射覆盖率100%：所有必填字段都必须映射
2. ✅ 自动匹配准确率≥80%：自动匹配建议准确率≥80%
3. ✅ 字段映射关系唯一性校验准确率100%
4. ✅ 权限控制有效：只有SuperAdmin和TenantAdmin可以操作
5. ✅ 未映射字段处理率≥95%：未映射字段处理率≥95%

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**灰度发布**：
- 第一阶段：内部测试环境验证（1周）
- 第二阶段：小范围甲方测试（选择1-2个甲方，1周）
- 第三阶段：全量发布（所有甲方）

#### 7.2 回滚方案

**回滚步骤**：
1. 关闭功能入口
2. 保留已创建的映射关系（不删除）
3. 修复问题后重新发布

---

**文档版本**：v1.0.0  
**创建日期**：2025-11-25  
**最后更新**：2025-11-25  
**状态**：待评审

