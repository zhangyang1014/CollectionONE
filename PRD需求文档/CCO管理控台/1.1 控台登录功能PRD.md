# 控台登录功能 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

CCO（Collection Control Office）管理控台是催收业务的核心管理系统，需要为不同角色的管理员提供安全、便捷的登录认证功能。当前系统支持多种管理员角色（超级管理员、甲方管理员、机构管理员、小组管理员等），需要统一的登录入口和权限管理体系。

**业务痛点**：
- 不同角色的管理员需要访问不同的功能模块，需要基于角色的权限控制
- 登录安全需要保障，防止未授权访问
- Token管理需要支持自动刷新和过期处理
- 需要记录登录日志，便于审计和问题排查

**预期影响的核心指标**：
- 登录成功率：≥99%
- 登录响应时间：≤500ms
- 安全事件：0次未授权访问
- 用户满意度：登录流程顺畅，无卡顿
- 账号锁定机制：连续5次失败后自动锁定10分钟

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：日常登录**
- **入口**：访问管理控台首页 `/admin/login`
- **触发时机**：管理员首次访问系统或Token过期后
- **所在页面**：登录页面
- **流程节点**：输入登录ID和密码 → 验证码验证（可选）→ 点击登录 → 跳转到工作台

**场景2：Token过期重新登录**
- **入口**：系统检测到Token过期，自动跳转到登录页
- **触发时机**：Token过期或无效
- **所在页面**：登录页面
- **流程节点**：提示Token过期 → 重新输入账号密码 → 登录成功

**场景3：账号锁定**
- **入口**：连续5次登录失败后
- **触发时机**：账号被系统自动锁定
- **所在页面**：登录页面
- **流程节点**：显示锁定提示 → 等待10分钟后自动解锁 → 可重新尝试登录

**场景4：主动登出**
- **入口**：用户点击登出按钮
- **触发时机**：管理员完成工作，需要退出系统
- **所在页面**：任意管理页面
- **流程节点**：点击登出 → 清除Token和用户信息 → 跳转到登录页

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 权限范围 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 系统全权限管理 | 所有功能模块 |
| 甲方管理员 | TenantAdmin | 管理甲方相关配置 | 甲方管理、字段配置、渠道配置 |
| 机构管理员 | AgencyAdmin | 管理机构相关配置 | 机构管理、小组管理、催员管理 |
| 小组管理员 | TeamLeader | 管理小组相关配置 | 小组管理、催员管理、案件查看 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 登录流程

```
用户访问系统
    ↓
检查Token是否存在且有效
    ↓
[Token有效] → 直接进入工作台
    ↓
[Token无效/不存在] → 跳转到登录页
    ↓
输入登录ID和密码
    ↓
输入验证码（可选，当前测试模式已禁用）
    ↓
点击登录按钮
    ↓
检查账号是否锁定
    ↓
[已锁定] → 显示锁定提示（剩余时间倒计时）
    ↓
[未锁定] → 后端验证账号密码
    ↓
[验证失败] → 记录失败次数
    ↓
失败次数>=5? → [是] 锁定账号10分钟 → 显示锁定提示
    ↓
[否] → 提示错误，显示剩余尝试次数，返回登录页
    ↓
[验证成功] → 重置失败次数 → 生成JWT Token
    ↓
返回Token和用户信息
    ↓
前端保存Token到localStorage
    ↓
跳转到工作台首页

**注意如果是非超级管理登录的话，要控制默认甲方只能是当前甲方，不可切换**
```

#### 3.2 账号来源说明

**当前实现**（Mock模式）：
- 账号信息硬编码在 `UserDetailsServiceImpl` 中
- 支持账号：
  - `superadmin` / `123456` → SuperAdmin角色
  - `tenantadmin` / `admin123` → TenantAdmin角色
- 密码使用BCrypt加密存储和验证

**未来规划**（待实现）：
- 账号信息从数据库 `users` 表加载
- 支持管理员在控台创建和管理账号
- 支持账号启用/禁用状态管理
- 支持密码重置功能

#### 3.3 账号锁定机制（新增）

**锁定规则**：
- 连续登录失败5次后，账号自动锁定10分钟
- 锁定期间，即使密码正确也无法登录
- 10分钟后自动解锁，可重新尝试登录
- 锁定状态在服务端记录，前端显示倒计时

**实现细节**：
- 失败次数计数：按登录ID（loginId）统计，存储在内存或Redis中
- 锁定时间：从最后一次失败时间开始计算，锁定10分钟（600秒）
- 解锁条件：
  - 自动解锁：锁定时间超过10分钟
  - 手动解锁：管理员在控台手动解锁（待实现）
- 成功登录后：重置失败次数计数器

**前端提示**：
- 锁定提示："账号已被锁定，请10分钟后再试（剩余时间：X分X秒）"
- 失败提示："登录失败，剩余尝试次数：X次"

#### 3.4 登出流程

```
用户点击登出按钮
    ↓
调用登出接口（可选，JWT无状态）
    ↓
清除前端Token和用户信息
    ↓
清除localStorage中的token和userInfo
    ↓
跳转到登录页
```

#### 3.5 Token管理流程

```
用户登录成功
    ↓
生成JWT Token（包含用户ID、角色等信息）
    ↓
设置Token过期时间（默认72小时）
    ↓
前端每次请求携带Token
    ↓
后端验证Token有效性
    ↓
[Token有效] → 允许访问
    ↓
[Token过期] → 返回401，前端跳转登录页
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 登录规则

**账号密码规则**：
- 登录ID：必填，支持字母、数字、下划线
- 密码：必填，长度≥6位，使用BCrypt加密存储
- 验证码：当前测试模式已禁用，生产环境可启用

**登录限制**：
- ✅ **连续5次登录失败，锁定账号10分钟**（已实现）
- ⏳ 同一账号最多允许1个设备同时登录（待实现）
- ⏳ 登录IP白名单限制（待实现）

**账号锁定规则**（新增）：
- 失败次数阈值：5次
- 锁定时长：10分钟（600秒）
- 计数范围：按登录ID（loginId）独立计数
- 解锁方式：自动解锁（10分钟后）或管理员手动解锁（待实现）
- 成功登录后：自动重置失败次数


#### 4.2 Token规则

**Token生成规则**：
- 使用JWT（JSON Web Token）标准
- 签名算法：HS256
- Token有效期：72小时
- Token包含信息：用户登录ID、角色、过期时间

**Token使用规则**：
- Token存储在localStorage中
- 每次API请求在Header中携带：`Authorization: Bearer {token}`
- Token过期后自动跳转登录页
- 登出时清除Token

#### 4.3 权限规则

**角色权限映射**：
- SuperAdmin：所有权限
- TenantAdmin：甲方相关权限
- AgencyAdmin：机构相关权限
- TeamLeader：小组相关权限

**权限验证**：
- 前端路由守卫验证Token
- 后端接口验证Token和角色权限
- 无权限访问时返回403错误

#### 4.4 范围边界

**本次需求范围内**：
- ✅ 管理员登录功能
- ✅ JWT Token生成和验证
- ✅ 登出功能
- ✅ 用户信息获取
- ✅ 基础权限验证
- ✅ **连续5次失败后锁定10分钟**（已实现）

**本次需求范围外**：
- ❌ 密码找回功能（忘记密码）
- ❌ 账号手动解锁功能（待实现）
- ❌ 多设备登录管理
- ❌ 登录IP白名单
- ❌ Token自动刷新（需手动重新登录）
- ❌ 单点登录（SSO）
- ❌ 双因素认证（2FA）

---
如下内容可以不看

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 安全要求

**密码安全**：
- 密码使用BCrypt加密存储，不存储明文密码
- 密码传输使用HTTPS加密
- 密码强度要求：≥6位（可配置）

**Token安全**：
- Token使用密钥签名，防止篡改
- Token设置过期时间，降低泄露风险
- Token存储在localStorage，前端需防范XSS攻击

**接口安全**：
- 登录接口需要防止暴力破解（账号锁定机制）
- 验证码防止自动化攻击（当前测试模式已禁用）
- 接口需要HTTPS传输

**账号锁定安全**（新增）：
- 锁定状态存储在服务端，防止前端绕过
- 锁定时间精确到秒，防止时间篡改
- 记录锁定日志，便于审计

#### 5.2 数据隐私

**用户信息处理**：
- 用户密码不记录日志
- 登录日志脱敏处理（仅记录登录ID，不记录密码）
- 用户信息访问需要权限验证

**日志记录**：
- 记录登录成功/失败日志
- 记录账号锁定/解锁日志（新增）
- 记录登出日志
- 记录Token验证失败日志
- 日志保留30天（可配置）

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不涉及资金流**，本节不适用。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 登录请求字段

| 字段名 | 类型 | 必填 | 说明 | 来源 |
|--------|------|------|------|------|
| loginId | String | 是 | 登录ID | 用户输入 |
| password | String | 是 | 密码（明文） | 用户输入 |
| captcha | String | 否 | 验证码（当前禁用） | 用户输入 |

#### 7.2 登录响应字段

| 字段名 | 类型 | 说明 | 更新频率 |
|--------|------|------|----------|
| token | String | JWT Token | 登录时生成 |
| user.id | Integer | 用户ID | 登录时返回 |
| user.loginId | String | 登录ID | 登录时返回 |
| user.username | String | 用户名 | 登录时返回 |
| user.role | String | 用户角色 | 登录时返回 |
| user.name | String | 用户姓名 | 登录时返回 |
| user.email | String | 用户邮箱 | 登录时返回 |

#### 7.3 账号锁定相关字段（新增）

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| loginId | String | 登录ID | 登录请求 |
| failureCount | Integer | 失败次数 | 服务端计数 |
| lockTime | Long | 锁定时间戳（毫秒） | 服务端记录 |
| unlockTime | Long | 解锁时间戳（毫秒） | lockTime + 600000 |
| isLocked | Boolean | 是否锁定 | 服务端计算 |

#### 7.4 登录错误码列表（Error Codes）

| HTTP状态码 | 业务错误码 (code) | 错误码标识 (errorCode) | 英文错误信息 (message) | 中文说明 | 适用场景 |
|-----------|-----------------|---------------------|---------------------|---------|---------|
| 400 | 400 | INVALID_REQUEST | Invalid request parameters | 请求参数错误 | 请求参数缺失或格式错误 |
| 400 | 400 | CAPTCHA_INCORRECT | Verification code incorrect | 验证码错误 | 验证码输入错误（当前测试模式已禁用） |
| 401 | 401 | UNAUTHORIZED | Unauthorized access | 未授权访问 | Token无效或过期 |
| 401 | 401 | LOGIN_FAILED | Login ID or password incorrect | 登录ID或密码错误 | 账号或密码不正确 |
| 401 | 401 | ACCOUNT_NOT_FOUND | Account not found | 账号不存在 | 登录ID不存在 |
| 401 | 401 | PASSWORD_INCORRECT | Password incorrect | 密码错误 | 密码不正确 |
| 403 | 403 | ACCOUNT_DISABLED | Account has been disabled | 账号已被禁用 | 账号状态为禁用 |
| 403 | 403 | FORBIDDEN | Access denied | 访问被拒绝 | 无权限访问 |
| 423 | 423 | ACCOUNT_LOCKED | Account has been temporarily locked for 10 minutes due to 5 consecutive failed login attempts. Please try again later. | 账号已被锁定，请10分钟后再试 | 连续5次登录失败后账号被锁定（新增） |
| 429 | 429 | TOO_MANY_REQUESTS | Too many login attempts. Please try again later. | 登录请求过于频繁，请稍后再试 | 请求频率过高，触发限流 |
| 500 | 500 | INTERNAL_SERVER_ERROR | Internal server error | 服务器内部错误 | 服务器处理异常 |
| 503 | 503 | SERVICE_UNAVAILABLE | Service temporarily unavailable | 服务暂时不可用 | 服务维护或过载 |

**错误响应格式**：
```json
{
  "code": 401,
  "message": "Login ID or password incorrect",
  "errorCode": "LOGIN_FAILED",
  "data": {
    "remainingAttempts": 3
  }
}
```

**错误码说明**：
- **HTTP状态码**：HTTP协议标准状态码
- **业务错误码 (code)**：业务层面的错误码，通常与HTTP状态码一致
- **错误码标识 (errorCode)**：英文错误码标识，用于程序判断和日志记录
- **英文错误信息 (message)**：返回给前端的英文错误提示信息
- **适用场景**：该错误码的具体使用场景

#### 7.5 Token字段

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| sub | String | 用户登录ID | JWT标准字段 |
| iat | Long | 签发时间 | JWT标准字段 |
| exp | Long | 过期时间 | JWT标准字段 |

#### 7.6 统计口径

- **登录成功率**：登录成功次数 / 总登录尝试次数（按自然日统计）
- **平均登录响应时间**：所有登录请求的平均响应时间（按自然日统计）
- **Token过期率**：Token过期导致的重新登录次数 / 总访问次数（按自然日统计）
- **账号锁定率**：锁定账号数 / 总账号数（按自然日统计，新增）
- **锁定触发次数**：触发锁定的登录失败次数（按自然日统计，新增）

---

### 8. 交互与信息展示（UX & UI Brief）

**前端交互已实现**，主要界面元素：

**登录页面**：
- Logo和系统标题："CCO 管理控台"
- 登录表单：
  - 登录ID输入框（带用户图标）
  - 密码输入框（带锁图标，支持显示/隐藏）
  - 验证码输入框（带图片图标，当前测试模式已禁用）
- 登录按钮（加载状态显示"登录中..."）
- 底部链接：切换到IM端登录
- 版权信息："CCO Collection System © 2025"

**账号锁定提示**（新增）：
- 锁定状态：显示红色警告提示框
- 提示文案："账号已被锁定，请10分钟后再试"
- 倒计时显示："剩余时间：X分X秒"（实时更新）
- 登录按钮：锁定期间禁用，显示灰色

**登录失败提示**（优化）：
- 失败提示：显示错误信息
- 剩余次数提示："登录失败，剩余尝试次数：X次"（当失败次数<5时）
- 接近锁定提示："连续失败4次，再失败1次将锁定账号10分钟"（当失败次数=4时）

**交互细节**：
- 支持Enter键提交登录
- 登录失败显示错误提示
- 登录成功显示成功提示并跳转
- 验证码点击可刷新
- 账号锁定期间，登录按钮禁用，显示倒计时

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 Token配置

| 配置项 | 配置路径 | 默认值 | 说明 |
|--------|---------|--------|------|
| jwt.secret | application.yml | 随机生成 | JWT签名密钥 |
| jwt.expiration | application.yml | 86400000 (24小时) | Token过期时间（毫秒） |

#### 9.2 登录配置

| 配置项 | 配置路径 | 默认值 | 说明 |
|--------|---------|--------|------|
| 验证码开关 | 前端代码 | false（测试模式） | 是否启用验证码 |
| 密码最小长度 | 前端验证规则 | 6 | 密码最小长度要求 |

#### 9.3 运营开关（待实现）

| 开关名称 | 默认值 | 说明 |
|---------|--------|------|
| 登录失败锁定开关 | false | 是否启用登录失败锁定 |
| 多设备登录限制开关 | false | 是否限制多设备同时登录 |
| IP白名单开关 | false | 是否启用IP白名单 |

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 用户打开登录页 | 登录页访问 | page_view_login | userId: null, page: /admin/login |
| 用户点击登录按钮 | 登录按钮点击 | click_login_button | loginId: 用户输入的登录ID |
| 登录成功 | 登录成功 | login_success | userId: 用户ID, role: 用户角色, loginId: 登录ID |
| 登录失败 | 登录失败 | login_failure | loginId: 登录ID, errorCode: 错误码, errorMessage: 错误信息, remainingAttempts: 剩余尝试次数 |
| 账号锁定 | 账号锁定 | account_locked | loginId: 登录ID, lockTime: 锁定时间, unlockTime: 解锁时间 |
| 账号解锁 | 账号解锁 | account_unlocked | loginId: 登录ID, unlockTime: 解锁时间 |
| Token过期跳转 | Token过期 | token_expired | userId: 用户ID, tokenAge: Token年龄（秒） |
| 用户点击登出 | 登出按钮点击 | click_logout_button | userId: 用户ID, role: 用户角色 |
| 登出成功 | 登出成功 | logout_success | userId: 用户ID, role: 用户角色 |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```
┌─────────────────┐
│   前端 (Vue3)   │
│  /admin/login   │
└────────┬────────┘
         │ HTTP/HTTPS
         │ POST /api/v1/admin/auth/login
         ↓
┌─────────────────┐
│  Java后端        │
│  AuthController │
└────────┬────────┘
         │
         ├──→ UserDetailsServiceImpl (用户验证)
         ├──→ JwtTokenProvider (Token生成)
         ├──→ BCryptPasswordEncoder (密码验证)
         └──→ LoginLockService (账号锁定服务，新增)
```

#### 1.2 模块职责

**前端模块**：
- `frontend/src/views/admin/Login.vue`：登录页面组件
- `frontend/src/stores/user.ts`：用户状态管理（Token、用户信息）
- `frontend/src/router/index.ts`：路由守卫（Token验证）

**后端模块**：
- `AuthController`：认证控制器，处理登录、登出、获取用户信息
- `JwtTokenProvider`：JWT Token生成和验证
- `UserDetailsServiceImpl`：用户信息加载服务（当前Mock模式，硬编码账号）
- `JwtAuthenticationFilter`：Token验证过滤器
- `LoginLockService`：账号锁定服务（新增，处理失败计数和锁定逻辑）

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 登录接口

**接口路径**：`POST /api/v1/admin/auth/login`

**请求参数**：
```json
{
  "loginId": "string",  // 必填，登录ID
  "password": "string"  // 必填，密码（明文）
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "loginId": "admin",
      "username": "admin",
      "role": "SuperAdmin",
      "name": "超级管理员",
      "email": "admin@cco.com"
    }
  }
}
```

**响应数据**（账号锁定，新增）：
```json
{
  "code": 423,
  "message": "账号已被锁定，请10分钟后再试",
  "data": {
    "lockTime": 1701234567890,
    "unlockTime": 1701235167890,
    "remainingSeconds": 600
  }
}
```

**响应数据**（登录失败）：
```json
{
  "code": 401,
  "message": "登录ID或密码错误",
  "data": {
    "remainingAttempts": 3
  }
}
```

**错误响应**：

| HTTP状态码 | 业务错误码 | 错误码标识 | 英文错误信息 | 说明 |
|-----------|----------|----------|------------|------|
| 400 | 400 | INVALID_REQUEST | Invalid request parameters | 请求参数错误 |
| 400 | 400 | CAPTCHA_INCORRECT | Verification code incorrect | 验证码错误（当前测试模式已禁用） |
| 401 | 401 | LOGIN_FAILED | Login ID or password incorrect | 登录ID或密码错误 |
| 401 | 401 | ACCOUNT_NOT_FOUND | Account not found | 账号不存在 |
| 401 | 401 | PASSWORD_INCORRECT | Password incorrect | 密码错误 |
| 401 | 401 | UNAUTHORIZED | Unauthorized access | 未授权访问（Token无效） |
| 403 | 403 | ACCOUNT_DISABLED | Account has been disabled | 账号已被禁用 |
| 423 | 423 | ACCOUNT_LOCKED | Account has been temporarily locked for 10 minutes due to 5 consecutive failed login attempts. Please try again later. | 账号已被锁定（新增） |
| 429 | 429 | TOO_MANY_REQUESTS | Too many login attempts. Please try again later. | 请求频率过高 |
| 500 | 500 | INTERNAL_SERVER_ERROR | Internal server error | 服务器内部错误 |
| 503 | 503 | SERVICE_UNAVAILABLE | Service temporarily unavailable | 服务暂时不可用 |

**超时与重试**：
- 超时时间：5秒
- 重试策略：不重试（用户可手动重试）

**幂等性**：不适用（登录操作本身不是幂等的）

**失败降级**：登录失败返回错误信息，不进行降级处理

#### 2.2 登出接口

**接口路径**：`POST /api/v1/admin/auth/logout`

**请求参数**：无（Token在Header中）

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": "登出成功"
}
```

**说明**：JWT是无状态的，登出主要是前端清除Token，后端接口主要用于记录日志。

#### 2.3 获取当前用户信息接口

**接口路径**：`GET /api/v1/admin/auth/me`

**请求参数**：无（Token在Header中）

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "loginId": "admin",
    "username": "admin",
    "role": "SuperAdmin",
    "name": "超级管理员",
    "email": "admin@cco.com"
  }
}
```

**错误响应**：

| HTTP状态码 | 业务错误码 | 错误码标识 | 英文错误信息 | 说明 |
|-----------|----------|----------|------------|------|
| 401 | 401 | UNAUTHORIZED | Unauthorized access. Please login again. | 未登录或Token无效 |
| 401 | 401 | TOKEN_EXPIRED | Token has expired. Please login again. | Token已过期 |
| 401 | 401 | TOKEN_INVALID | Invalid token | Token无效 |
| 403 | 403 | FORBIDDEN | Access denied | 无权限访问 |
| 500 | 500 | INTERNAL_SERVER_ERROR | Internal server error | 服务器内部错误 |

#### 2.4 系统依赖

**内部依赖**：
- Spring Security：安全框架
- JWT库：`io.jsonwebtoken:jjwt`（Token生成和验证）
- BCrypt：密码加密

**外部依赖**：无

#### 2.5 账号锁定服务接口（新增）

**内部服务**：`LoginLockService`

**主要方法**：
- `checkLockStatus(String loginId)`：检查账号是否锁定
- `recordLoginFailure(String loginId)`：记录登录失败
- `resetFailureCount(String loginId)`：重置失败次数（登录成功时调用）
- `isLocked(String loginId)`：判断账号是否锁定
- `getRemainingLockTime(String loginId)`：获取剩余锁定时间（秒）

**存储方案**：
- 当前实现：使用内存Map存储（`ConcurrentHashMap`）
- 未来优化：使用Redis存储（支持分布式部署）

**数据结构**（内存存储）：
```java
Map<String, LoginLockInfo> lockMap = new ConcurrentHashMap<>();

class LoginLockInfo {
    String loginId;
    int failureCount;      // 失败次数
    long lockTime;         // 锁定时间戳（毫秒）
    long unlockTime;        // 解锁时间戳（毫秒）
}
```

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据存储

**当前实现**（Mock模式）：
- 用户信息：硬编码在 `UserDetailsServiceImpl` 中
- 账号锁定信息：存储在内存 `ConcurrentHashMap` 中（新增）

**账号信息**（硬编码）：
- `superadmin` / `123456` → SuperAdmin角色
- `tenantadmin` / `admin123` → TenantAdmin角色

**锁定信息存储**（新增）：
```java
// 内存存储（当前实现）
private final Map<String, LoginLockInfo> lockMap = new ConcurrentHashMap<>();

// 未来优化：Redis存储
// Redis Key: "login:lock:{loginId}"
// Redis Value: JSON格式存储 LoginLockInfo
```

**未来规划**（待实现）：
- 用户表（users）：存储用户基本信息
- 角色表（roles）：存储角色信息
- 用户角色关联表（user_roles）：用户和角色的多对多关系

**表结构设计**（待实现）：

```sql
-- 用户表
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  login_id VARCHAR(50) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,  -- BCrypt加密
  username VARCHAR(100),
  email VARCHAR(100),
  status TINYINT DEFAULT 1,  -- 1:启用 0:禁用
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 角色表
CREATE TABLE roles (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  role_code VARCHAR(50) UNIQUE NOT NULL,
  role_name VARCHAR(100) NOT NULL,
  description TEXT
);

-- 用户角色关联表
CREATE TABLE user_roles (
  user_id BIGINT NOT NULL,
  role_id BIGINT NOT NULL,
  PRIMARY KEY (user_id, role_id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (role_id) REFERENCES roles(id)
);

-- 登录锁定表（可选，或使用Redis）
CREATE TABLE login_locks (
  login_id VARCHAR(50) PRIMARY KEY,
  failure_count INT DEFAULT 0,
  lock_time BIGINT,  -- 锁定时间戳（毫秒）
  unlock_time BIGINT,  -- 解锁时间戳（毫秒）
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3.2 索引设计

- `users.login_id`：唯一索引（用于快速查找用户）
- `users.status`：普通索引（用于查询启用用户）
- `login_locks.login_id`：主键索引（用于快速查找锁定信息）

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **QPS**：登录接口支持100 QPS
- **响应时间**：
  - 登录接口：≤500ms（P95）
  - Token验证：≤50ms（P95）
  - 锁定检查：≤10ms（P95，新增）
- **峰值容量**：支持1000并发登录请求

#### 4.2 可用性要求

- **SLA**：99.9%可用性
- **降级策略**：
  - 登录接口异常时，返回友好错误提示
  - Token验证失败时，自动跳转登录页
  - 锁定服务异常时，允许登录（记录日志，新增）
- **容灾**：支持多机房部署（待实现）

#### 4.3 安全要求

**加密存储**：
- 密码使用BCrypt加密存储
- Token密钥存储在配置文件中，生产环境使用环境变量

**接口鉴权**：
- 所有管理接口需要Token验证
- Token验证失败返回401错误

**脱敏展示**：
- 日志中不记录密码明文
- 错误信息不暴露系统内部细节

**账号锁定安全**（新增）：
- 锁定状态存储在服务端，防止前端绕过
- 锁定时间精确到秒，防止时间篡改
- 支持分布式部署（未来使用Redis）

#### 4.4 扩展性

- 支持新增角色类型（通过配置）
- 支持Token刷新机制（待实现）
- 支持单点登录（SSO，待实现）
- 支持锁定时间配置化（待实现）
- 支持失败次数阈值配置化（待实现）

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 日志内容 | 日志级别 |
|---------|---------|---------|
| 登录请求 | 登录ID（不记录密码） | INFO |
| 登录成功 | 登录ID、角色、IP地址 | INFO |
| 登录失败 | 登录ID、失败原因、IP地址、剩余尝试次数 | WARN |
| 账号锁定 | 登录ID、锁定时间、解锁时间 | WARN（新增） |
| 账号解锁 | 登录ID、解锁时间 | INFO（新增） |
| Token验证失败 | Token内容（脱敏）、失败原因 | WARN |
| 登出请求 | 用户ID、角色 | INFO |

**日志格式示例**：
```
[2025-11-27 10:00:00] INFO  [AuthController] ========== 管理后台登录请求，loginId=admin ==========
[2025-11-27 10:00:01] WARN  [AuthController] 登录失败，loginId=admin, 剩余尝试次数=3
[2025-11-27 10:00:05] WARN  [LoginLockService] 账号锁定，loginId=admin, 锁定时间=1701234567890, 解锁时间=1701235167890
[2025-11-27 10:00:01] INFO  [AuthController] ========== 登录成功，loginId=admin, role=SuperAdmin ==========
```

#### 5.2 监控指标

| 指标名称 | 指标类型 | 告警阈值 | 说明 |
|---------|---------|---------|------|
| 登录成功率 | 百分比 | <95% | 登录成功次数/总登录次数 |
| 登录响应时间 | 毫秒 | P95 >1000ms | 登录接口响应时间 |
| Token验证失败率 | 百分比 | >10% | Token验证失败次数/总验证次数 |
| 登录失败次数 | 次数 | 5分钟内>100次 | 可能遭受暴力破解攻击 |
| 账号锁定次数 | 次数 | 1小时内>50次 | 可能遭受暴力破解攻击（新增） |
| 锁定触发率 | 百分比 | >5% | 触发锁定的登录失败次数/总登录失败次数（新增） |

#### 5.3 告警规则

- **登录成功率低于95%**：发送告警通知
- **登录响应时间P95超过1秒**：发送告警通知
- **5分钟内登录失败超过100次**：发送安全告警
- **Token验证失败率超过10%**：发送告警通知
- **1小时内账号锁定超过50次**：发送安全告警（新增）
- **锁定触发率超过5%**：发送告警通知（新增）

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 密码加密验证测试
- Token生成和验证测试
- 用户信息加载测试
- 账号锁定服务测试（新增）：
  - 失败次数计数测试
  - 锁定时间计算测试
  - 解锁时间判断测试

**集成测试**：
- 登录接口完整流程测试
- Token验证过滤器测试
- 登出接口测试
- 账号锁定集成测试（新增）：
  - 连续5次失败后锁定测试
  - 锁定期间登录拦截测试
  - 10分钟后自动解锁测试

**功能测试**：
- 正常登录流程测试
- 错误密码登录测试
- Token过期处理测试
- 登出功能测试
- 不同角色登录测试
- 账号锁定功能测试（新增）：
  - 连续5次失败锁定测试
  - 锁定期间登录测试
  - 10分钟后自动解锁测试
  - 成功登录后重置失败次数测试

**安全测试**：
- SQL注入测试
- XSS攻击测试
- Token篡改测试
- 暴力破解防护测试（账号锁定机制）
- 锁定状态绕过测试（新增）

**性能测试**：
- 登录接口压力测试（100 QPS）
- Token验证性能测试
- 锁定服务性能测试（新增）

#### 6.2 验收标准

1. **功能完整性**：
   - ✅ 支持管理员登录功能
   - ✅ 支持Token生成和验证
   - ✅ 支持登出功能
   - ✅ 支持获取当前用户信息
   - ✅ **支持连续5次失败后锁定10分钟**（新增）

2. **性能指标**：
   - ✅ 登录接口响应时间≤500ms（P95）
   - ✅ 支持100 QPS并发登录
   - ✅ Token验证响应时间≤50ms（P95）
   - ✅ 锁定检查响应时间≤10ms（P95，新增）

3. **安全要求**：
   - ✅ 密码使用BCrypt加密存储
   - ✅ Token使用HS256签名
   - ✅ 所有管理接口需要Token验证
   - ✅ 日志中不记录密码明文
   - ✅ **连续5次失败后自动锁定10分钟**（新增）
   - ✅ **锁定状态存储在服务端，防止前端绕过**（新增）

4. **可用性要求**：
   - ✅ 登录成功率≥99%
   - ✅ 系统可用性≥99.9%

5. **用户体验**：
   - ✅ 登录流程顺畅，无卡顿
   - ✅ 错误提示清晰明确
   - ✅ 支持Enter键提交登录
   - ✅ **锁定提示清晰，显示倒计时**（新增）
   - ✅ **失败次数提示友好**（新增）

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**发布方式**：全量发布（当前版本）

**发布步骤**：
1. 部署后端服务（Java Spring Boot，包含账号锁定功能）
2. 部署前端静态资源（Vue3，包含锁定提示UI）
3. 验证登录功能正常
4. 验证账号锁定功能正常（新增）
5. 监控系统指标

**灰度发布**（未来规划）：
- 支持按用户ID灰度发布
- 支持按角色灰度发布
- 灰度比例：10% → 50% → 100%

#### 7.2 配置切换

**Token配置切换**：
- 修改`application.yml`中的`jwt.secret`和`jwt.expiration`
- 重启后端服务生效

**验证码开关切换**：
- 修改前端代码中的验证码开关
- 重新构建前端资源

**锁定配置切换**（新增）：
- 修改`application.yml`中的锁定配置：
  ```yaml
  login:
    lock:
      max-failure-count: 5      # 最大失败次数
      lock-duration-minutes: 10 # 锁定时长（分钟）
  ```
- 重启后端服务生效

#### 7.3 回滚方案

**回滚条件**：
- 登录成功率低于90%
- 登录响应时间P95超过2秒
- 出现严重安全漏洞
- 账号锁定功能异常（新增）

**回滚步骤**：
1. 停止新版本服务
2. 回滚到上一个稳定版本
3. 验证功能正常
4. 通知相关人员

**回滚时间**：≤5分钟

#### 7.4 应急联系人

- **技术负责人**：待指定
- **运维负责人**：待指定
- **安全负责人**：待指定

---

## 附录

### A. 相关文档

- [CCO系统功能设计.xlsx](../CCO%20系统功能设计.xlsx) - 控台功能点sheet，行15
- [后端API文档](../../接口/1-管理控台API文档.md)
- [登录问题修复文档](../../✅-登录跳转问题最终修复.md)

### B. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0 | 2025-11-27 | 初始版本，完成基础登录功能 | AI Assistant |
| v1.1 | 2025-11-27 | 新增账号锁定功能（连续5次失败后锁定10分钟），更新账号来源说明 | AI Assistant |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-11-27  
**文档版本**：v1.1




