# 控台登录功能 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

CCO（Collection Control Office）管理控台是催收业务的核心管理系统，需要为不同角色的管理员提供安全、便捷的登录认证功能。当前系统支持多种管理员角色（超级管理员、甲方管理员、机构管理员、小组管理员等），需要统一的登录入口和权限管理体系。

**业务痛点**：
- 不同角色的管理员需要访问不同的功能模块，需要基于角色的权限控制
- 登录安全需要保障，防止未授权访问
- Token管理需要支持自动刷新和过期处理
- 需要记录登录日志，便于审计和问题排查

**预期影响的核心指标**：
- 登录成功率：≥99%
- 登录响应时间：≤500ms
- 安全事件：0次未授权访问
- 用户满意度：登录流程顺畅，无卡顿

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：日常登录**
- **入口**：访问管理控台首页 `/admin/login`
- **触发时机**：管理员首次访问系统或Token过期后
- **所在页面**：登录页面
- **流程节点**：输入登录ID和密码 → 验证码验证（可选）→ 点击登录 → 跳转到工作台

**场景2：Token过期重新登录**
- **入口**：系统检测到Token过期，自动跳转到登录页
- **触发时机**：Token过期或无效
- **所在页面**：登录页面
- **流程节点**：提示Token过期 → 重新输入账号密码 → 登录成功

**场景3：主动登出**
- **入口**：用户点击登出按钮
- **触发时机**：管理员完成工作，需要退出系统
- **所在页面**：任意管理页面
- **流程节点**：点击登出 → 清除Token和用户信息 → 跳转到登录页

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 权限范围 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 系统全权限管理 | 所有功能模块 |
| 甲方管理员 | TenantAdmin | 管理甲方相关配置 | 甲方管理、字段配置、渠道配置 |
| 机构管理员 | AgencyAdmin | 管理机构相关配置 | 机构管理、小组管理、催员管理 |
| 小组管理员 | TeamLeader | 管理小组相关配置 | 小组管理、催员管理、案件查看 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 登录流程

```
用户访问系统
    ↓
检查Token是否存在且有效
    ↓
[Token有效] → 直接进入工作台
    ↓
[Token无效/不存在] → 跳转到登录页
    ↓
输入登录ID和密码
    ↓
输入验证码（可选，当前测试模式已禁用）
    ↓
点击登录按钮
    ↓
后端验证账号密码
    ↓
[验证失败] → 提示错误，返回登录页
    ↓
[验证成功] → 生成JWT Token
    ↓
返回Token和用户信息
    ↓
前端保存Token到localStorage
    ↓
跳转到工作台首页

**注意如果是非超级管理登录的话，要控制默认甲方只能是当前甲方，不可切换**
```

#### 3.2 登出流程

```
用户点击登出按钮
    ↓
调用登出接口（可选，JWT无状态）
    ↓
清除前端Token和用户信息
    ↓
清除localStorage中的token和userInfo
    ↓
跳转到登录页
```

#### 3.3 Token管理流程

```
用户登录成功
    ↓
生成JWT Token（包含用户ID、角色等信息）
    ↓
设置Token过期时间（默认24小时）
    ↓
前端每次请求携带Token
    ↓
后端验证Token有效性
    ↓
[Token有效] → 允许访问
    ↓
[Token过期] → 返回401，前端跳转登录页
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 登录规则

**账号密码规则**：
- 登录ID：必填，支持字母、数字、下划线
- 密码：必填，长度≥6位，使用BCrypt加密存储
- 验证码：当前测试模式已禁用，生产环境可启用

**登录限制**：
- 连续5次登录失败，锁定账号30分钟（待实现）
- 同一账号最多允许3个设备同时登录（待实现）
- 登录IP白名单限制（待实现）

#### 4.2 Token规则

**Token生成规则**：
- 使用JWT（JSON Web Token）标准
- 签名算法：HS256
- Token有效期：24小时（可配置）
- Token包含信息：用户登录ID、角色、过期时间

**Token使用规则**：
- Token存储在localStorage中
- 每次API请求在Header中携带：`Authorization: Bearer {token}`
- Token过期后自动跳转登录页
- 登出时清除Token

#### 4.3 权限规则

**角色权限映射**：
- SuperAdmin：所有权限
- TenantAdmin：甲方相关权限
- AgencyAdmin：机构相关权限
- TeamLeader：小组相关权限

**权限验证**：
- 前端路由守卫验证Token
- 后端接口验证Token和角色权限
- 无权限访问时返回403错误

#### 4.4 范围边界

**本次需求范围内**：
- ✅ 管理员登录功能
- ✅ JWT Token生成和验证
- ✅ 登出功能
- ✅ 用户信息获取
- ✅ 基础权限验证

**本次需求范围外**：
- ❌ 密码找回功能（忘记密码）
- ❌ 账号锁定和解锁
- ❌ 多设备登录管理
- ❌ 登录IP白名单
- ❌ Token自动刷新（需手动重新登录）
- ❌ 单点登录（SSO）
- ❌ 双因素认证（2FA）

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 安全要求

**密码安全**：
- 密码使用BCrypt加密存储，不存储明文密码
- 密码传输使用HTTPS加密
- 密码强度要求：≥6位（可配置）

**Token安全**：
- Token使用密钥签名，防止篡改
- Token设置过期时间，降低泄露风险
- Token存储在localStorage，前端需防范XSS攻击

**接口安全**：
- 登录接口需要防止暴力破解（待实现限流）
- 验证码防止自动化攻击（当前测试模式已禁用）
- 接口需要HTTPS传输

#### 5.2 数据隐私

**用户信息处理**：
- 用户密码不记录日志
- 登录日志脱敏处理（仅记录登录ID，不记录密码）
- 用户信息访问需要权限验证

**日志记录**：
- 记录登录成功/失败日志
- 记录登出日志
- 记录Token验证失败日志
- 日志保留30天（可配置）

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不涉及资金流**，本节不适用。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 登录请求字段

| 字段名 | 类型 | 必填 | 说明 | 来源 |
|--------|------|------|------|------|
| loginId | String | 是 | 登录ID | 用户输入 |
| password | String | 是 | 密码（明文） | 用户输入 |
| captcha | String | 否 | 验证码（当前禁用） | 用户输入 |

#### 7.2 登录响应字段

| 字段名 | 类型 | 说明 | 更新频率 |
|--------|------|------|----------|
| token | String | JWT Token | 登录时生成 |
| user.id | Integer | 用户ID | 登录时返回 |
| user.loginId | String | 登录ID | 登录时返回 |
| user.username | String | 用户名 | 登录时返回 |
| user.role | String | 用户角色 | 登录时返回 |
| user.name | String | 用户姓名 | 登录时返回 |
| user.email | String | 用户邮箱 | 登录时返回 |

#### 7.3 Token字段

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| sub | String | 用户登录ID | JWT标准字段 |
| iat | Long | 签发时间 | JWT标准字段 |
| exp | Long | 过期时间 | JWT标准字段 |

#### 7.4 统计口径

- **登录成功率**：登录成功次数 / 总登录尝试次数（按自然日统计）
- **平均登录响应时间**：所有登录请求的平均响应时间（按自然日统计）
- **Token过期率**：Token过期导致的重新登录次数 / 总访问次数（按自然日统计）

---

### 8. 交互与信息展示（UX & UI Brief）

**前端交互已实现**，主要界面元素：

**登录页面**：
- Logo和系统标题："CCO 管理控台"
- 登录表单：
  - 登录ID输入框（带用户图标）
  - 密码输入框（带锁图标，支持显示/隐藏）
  - 验证码输入框（带图片图标，当前测试模式已禁用）
- 登录按钮（加载状态显示"登录中..."）
- 底部链接：忘记密码、切换到IM端登录
- 版权信息："CCO Collection System © 2025"

**交互细节**：
- 支持Enter键提交登录
- 登录失败显示错误提示
- 登录成功显示成功提示并跳转
- 验证码点击可刷新

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 Token配置

| 配置项 | 配置路径 | 默认值 | 说明 |
|--------|---------|--------|------|
| jwt.secret | application.yml | 随机生成 | JWT签名密钥 |
| jwt.expiration | application.yml | 86400000 (24小时) | Token过期时间（毫秒） |

#### 9.2 登录配置

| 配置项 | 配置路径 | 默认值 | 说明 |
|--------|---------|--------|------|
| 验证码开关 | 前端代码 | false（测试模式） | 是否启用验证码 |
| 密码最小长度 | 前端验证规则 | 6 | 密码最小长度要求 |

#### 9.3 运营开关（待实现）

| 开关名称 | 默认值 | 说明 |
|---------|--------|------|
| 登录失败锁定开关 | false | 是否启用登录失败锁定 |
| 多设备登录限制开关 | false | 是否限制多设备同时登录 |
| IP白名单开关 | false | 是否启用IP白名单 |

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 用户打开登录页 | 登录页访问 | page_view_login | userId: null, page: /admin/login |
| 用户点击登录按钮 | 登录按钮点击 | click_login_button | loginId: 用户输入的登录ID |
| 登录成功 | 登录成功 | login_success | userId: 用户ID, role: 用户角色, loginId: 登录ID |
| 登录失败 | 登录失败 | login_failure | loginId: 登录ID, errorCode: 错误码, errorMessage: 错误信息 |
| Token过期跳转 | Token过期 | token_expired | userId: 用户ID, tokenAge: Token年龄（秒） |
| 用户点击登出 | 登出按钮点击 | click_logout_button | userId: 用户ID, role: 用户角色 |
| 登出成功 | 登出成功 | logout_success | userId: 用户ID, role: 用户角色 |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```
┌─────────────────┐
│   前端 (Vue3)   │
│  /admin/login   │
└────────┬────────┘
         │ HTTP/HTTPS
         │ POST /api/v1/admin/auth/login
         ↓
┌─────────────────┐
│  Java后端        │
│  AuthController │
└────────┬────────┘
         │
         ├──→ UserDetailsServiceImpl (用户验证)
         ├──→ JwtTokenProvider (Token生成)
         └──→ BCryptPasswordEncoder (密码验证)
```

#### 1.2 模块职责

**前端模块**：
- `frontend/src/views/admin/Login.vue`：登录页面组件
- `frontend/src/stores/user.ts`：用户状态管理（Token、用户信息）
- `frontend/src/router/index.ts`：路由守卫（Token验证）

**后端模块**：
- `AuthController`：认证控制器，处理登录、登出、获取用户信息
- `JwtTokenProvider`：JWT Token生成和验证
- `UserDetailsServiceImpl`：用户信息加载服务
- `JwtAuthenticationFilter`：Token验证过滤器

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 登录接口

**接口路径**：`POST /api/v1/admin/auth/login`

**请求参数**：
```json
{
  "loginId": "string",  // 必填，登录ID
  "password": "string"  // 必填，密码（明文）
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "loginId": "admin",
      "username": "admin",
      "role": "SuperAdmin",
      "name": "超级管理员",
      "email": "admin@cco.com"
    }
  }
}
```

**错误响应**：
- 401：登录ID或密码错误
- 500：服务器内部错误

**超时与重试**：
- 超时时间：5秒
- 重试策略：不重试（用户可手动重试）

**幂等性**：不适用（登录操作本身不是幂等的）

**失败降级**：登录失败返回错误信息，不进行降级处理

#### 2.2 登出接口

**接口路径**：`POST /api/v1/admin/auth/logout`

**请求参数**：无（Token在Header中）

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": "登出成功"
}
```

**说明**：JWT是无状态的，登出主要是前端清除Token，后端接口主要用于记录日志。

#### 2.3 获取当前用户信息接口

**接口路径**：`GET /api/v1/admin/auth/me`

**请求参数**：无（Token在Header中）

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "loginId": "admin",
    "username": "admin",
    "role": "SuperAdmin",
    "name": "超级管理员",
    "email": "admin@cco.com"
  }
}
```

**错误响应**：
- 401：未登录或Token无效

#### 2.4 系统依赖

**内部依赖**：
- Spring Security：安全框架
- JWT库：`io.jsonwebtoken:jjwt`（Token生成和验证）
- BCrypt：密码加密

**外部依赖**：无

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据存储

**当前实现**：使用Mock数据，用户信息硬编码在代码中

**未来规划**（待实现）：
- 用户表（users）：存储用户基本信息
- 角色表（roles）：存储角色信息
- 用户角色关联表（user_roles）：用户和角色的多对多关系

**表结构设计**（待实现）：

```sql
-- 用户表
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  login_id VARCHAR(50) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,  -- BCrypt加密
  username VARCHAR(100),
  email VARCHAR(100),
  status TINYINT DEFAULT 1,  -- 1:启用 0:禁用
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 角色表
CREATE TABLE roles (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  role_code VARCHAR(50) UNIQUE NOT NULL,
  role_name VARCHAR(100) NOT NULL,
  description TEXT
);

-- 用户角色关联表
CREATE TABLE user_roles (
  user_id BIGINT NOT NULL,
  role_id BIGINT NOT NULL,
  PRIMARY KEY (user_id, role_id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (role_id) REFERENCES roles(id)
);
```

#### 3.2 索引设计

- `users.login_id`：唯一索引（用于快速查找用户）
- `users.status`：普通索引（用于查询启用用户）

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **QPS**：登录接口支持100 QPS
- **响应时间**：
  - 登录接口：≤500ms（P95）
  - Token验证：≤50ms（P95）
- **峰值容量**：支持1000并发登录请求

#### 4.2 可用性要求

- **SLA**：99.9%可用性
- **降级策略**：
  - 登录接口异常时，返回友好错误提示
  - Token验证失败时，自动跳转登录页
- **容灾**：支持多机房部署（待实现）

#### 4.3 安全要求

**加密存储**：
- 密码使用BCrypt加密存储
- Token密钥存储在配置文件中，生产环境使用环境变量

**接口鉴权**：
- 所有管理接口需要Token验证
- Token验证失败返回401错误

**脱敏展示**：
- 日志中不记录密码明文
- 错误信息不暴露系统内部细节

#### 4.4 扩展性

- 支持新增角色类型（通过配置）
- 支持Token刷新机制（待实现）
- 支持单点登录（SSO，待实现）

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 日志内容 | 日志级别 |
|---------|---------|---------|
| 登录请求 | 登录ID（不记录密码） | INFO |
| 登录成功 | 登录ID、角色、IP地址 | INFO |
| 登录失败 | 登录ID、失败原因、IP地址 | WARN |
| Token验证失败 | Token内容（脱敏）、失败原因 | WARN |
| 登出请求 | 用户ID、角色 | INFO |

**日志格式示例**：
```
[2025-11-27 10:00:00] INFO  [AuthController] ========== 管理后台登录请求，loginId=admin ==========
[2025-11-27 10:00:01] INFO  [AuthController] ========== 登录成功，loginId=admin, role=SuperAdmin ==========
```

#### 5.2 监控指标

| 指标名称 | 指标类型 | 告警阈值 | 说明 |
|---------|---------|---------|------|
| 登录成功率 | 百分比 | <95% | 登录成功次数/总登录次数 |
| 登录响应时间 | 毫秒 | P95 >1000ms | 登录接口响应时间 |
| Token验证失败率 | 百分比 | >10% | Token验证失败次数/总验证次数 |
| 登录失败次数 | 次数 | 5分钟内>100次 | 可能遭受暴力破解攻击 |

#### 5.3 告警规则

- **登录成功率低于95%**：发送告警通知
- **登录响应时间P95超过1秒**：发送告警通知
- **5分钟内登录失败超过100次**：发送安全告警
- **Token验证失败率超过10%**：发送告警通知

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 密码加密验证测试
- Token生成和验证测试
- 用户信息加载测试

**集成测试**：
- 登录接口完整流程测试
- Token验证过滤器测试
- 登出接口测试

**功能测试**：
- 正常登录流程测试
- 错误密码登录测试
- Token过期处理测试
- 登出功能测试
- 不同角色登录测试

**安全测试**：
- SQL注入测试
- XSS攻击测试
- Token篡改测试
- 暴力破解防护测试（待实现）

**性能测试**：
- 登录接口压力测试（100 QPS）
- Token验证性能测试

#### 6.2 验收标准

1. **功能完整性**：
   - ✅ 支持管理员登录功能
   - ✅ 支持Token生成和验证
   - ✅ 支持登出功能
   - ✅ 支持获取当前用户信息

2. **性能指标**：
   - ✅ 登录接口响应时间≤500ms（P95）
   - ✅ 支持100 QPS并发登录
   - ✅ Token验证响应时间≤50ms（P95）

3. **安全要求**：
   - ✅ 密码使用BCrypt加密存储
   - ✅ Token使用HS256签名
   - ✅ 所有管理接口需要Token验证
   - ✅ 日志中不记录密码明文

4. **可用性要求**：
   - ✅ 登录成功率≥99%
   - ✅ 系统可用性≥99.9%

5. **用户体验**：
   - ✅ 登录流程顺畅，无卡顿
   - ✅ 错误提示清晰明确
   - ✅ 支持Enter键提交登录

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**发布方式**：全量发布（当前版本）

**发布步骤**：
1. 部署后端服务（Java Spring Boot）
2. 部署前端静态资源（Vue3）
3. 验证登录功能正常
4. 监控系统指标

**灰度发布**（未来规划）：
- 支持按用户ID灰度发布
- 支持按角色灰度发布
- 灰度比例：10% → 50% → 100%

#### 7.2 配置切换

**Token配置切换**：
- 修改`application.yml`中的`jwt.secret`和`jwt.expiration`
- 重启后端服务生效

**验证码开关切换**：
- 修改前端代码中的验证码开关
- 重新构建前端资源

#### 7.3 回滚方案

**回滚条件**：
- 登录成功率低于90%
- 登录响应时间P95超过2秒
- 出现严重安全漏洞

**回滚步骤**：
1. 停止新版本服务
2. 回滚到上一个稳定版本
3. 验证功能正常
4. 通知相关人员

**回滚时间**：≤5分钟

#### 7.4 应急联系人

- **技术负责人**：待指定
- **运维负责人**：待指定
- **安全负责人**：待指定

---

## 附录

### A. 相关文档

- [CCO系统功能设计.xlsx](../CCO%20系统功能设计.xlsx) - 控台功能点sheet，行15
- [后端API文档](../../接口/1-管理控台API文档.md)
- [登录问题修复文档](../../✅-登录跳转问题最终修复.md)

### B. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0 | 2025-11-27 | 初始版本，完成基础登录功能 | AI Assistant |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-11-27  
**文档版本**：v1.0




