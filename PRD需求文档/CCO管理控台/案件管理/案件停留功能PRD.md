| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.1 | 2025-12-09 | 统一状态描述、性能指标与实现状态；补充代码块语言标注 | 大象 |
| v1.0 | 2025-11-27 | 初始版本，完成案件停留基础功能 | 大象 |

# 案件停留功能 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

案件停留功能是CCO管理控台的重要功能之一，用于处理特殊情况下的案件管理需求。当案件需要暂时停止催收（如等待法律程序、客户申请延期、资产打包等场景）时，管理员需要将案件标记为"停留"状态。停留的案件将从催员侧收回，管理端不可再分案，催员不可再查看跟进，确保案件处于暂停状态。同时，支持"解放停留"功能，让停留的案件能够恢复到正常状态，重新进入催收流程。

**业务痛点**：
- 特殊情况下需要暂停案件催收，但现有状态无法满足需求
- 需要将案件从催员侧收回，避免催员继续跟进
- 需要防止停留的案件被重新分配
- 需要单独管理停留的案件，便于后续处理
- 需要支持恢复停留案件，重新进入催收流程

**预期影响的核心指标**：
- 停留操作效率：批量停留100个案件≤5秒（P95）
- 停留准确率：案件停留成功率≥99%
- 解放停留效率：批量解放停留100个案件≤5秒（P95）
- 用户满意度：管理员对案件停留功能满意度≥90%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：批量标记案件为停留**
- **入口**：案件列表页面 → 批量选择案件 → 点击"标记停留"按钮
- **触发时机**：需要将多个案件暂停催收时
- **所在页面**：案件列表页面
- **流程节点**：选择案件 → 点击标记停留 → 确认操作 → 案件状态更新为停留 → 从催员侧收回

**场景2：查看停留案件**
- **入口**：管理控台菜单 → 案件管理 → 停留案件
- **触发时机**：需要查看和管理停留的案件时
- **所在页面**：`/cases/stay`（停留案件列表）
- **流程节点**：进入停留案件列表 → 查看停留案件 → 筛选/搜索 → 查看详情

**场景3：解放停留案件**
- **入口**：停留案件列表 → 选择案件 → 点击"解放停留"按钮
- **触发时机**：停留的案件需要重新进入催收流程时
- **所在页面**：停留案件列表页面
- **流程节点**：选择案件 → 点击解放停留 → 确认操作 → 案件状态恢复为正常 → 回到正常案件列表

**场景4：单个案件标记停留**
- **入口**：案件详情页面 → 点击"标记停留"按钮
- **触发时机**：单个案件需要暂停催收时
- **所在页面**：案件详情页面
- **流程节点**：查看案件详情 → 点击标记停留 → 确认操作 → 案件状态更新为停留

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 管理所有停留案件 | 中 |
| 甲方管理员 | TenantAdmin | 管理本甲方停留案件 | 高 |
| 机构管理员 | AgencyAdmin | 管理本机构停留案件 | 中 |
| 小组管理员 | TeamLeader | 管理本小组停留案件 | 低 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 标记停留流程

```text
管理员在案件列表选择案件
    ↓
勾选多个案件（支持全选、反选）
    ↓
点击"标记停留"按钮
    ↓
弹窗确认："确定要将选中的 X 个案件标记为停留吗？"
    ↓
[取消] → 返回案件列表
    ↓
[确认] → 执行停留操作
    ↓
标记案件为停留状态（is_stay = true）
    ↓
清除催员分配（collector_id = null, team_id = null, agency_id = null）
    ↓
记录停留时间（stay_at = 当前时间）
    ↓
记录停留操作人（stay_by = 当前用户ID）
    ↓
从催员侧收回（催员无法再查看该案件）
    ↓
从正常案件列表中移除（正常案件列表不展示停留案件）
    ↓
操作成功，刷新案件列表
```

#### 3.2 查看停留案件流程

```text
管理员点击"停留案件"菜单
    ↓
进入停留案件列表页面
    ↓
加载停留案件列表（is_stay = true，根据权限过滤）
    ↓
支持筛选、搜索、排序、分页
    ↓
查看停留案件详情
    ↓
支持批量解放停留
```

#### 3.3 解放停留流程

```text
管理员在停留案件列表选择案件
    ↓
勾选多个案件（支持全选、反选）
    ↓
点击"解放停留"按钮
    ↓
弹窗确认："确定要将选中的 X 个案件解放停留吗？解放后案件将恢复到正常状态。"
    ↓
[取消] → 返回停留案件列表
    ↓
[确认] → 执行解放停留操作
    ↓
取消停留状态（is_stay = false）
    ↓
清除停留时间（stay_at = null）
    ↓
清除停留操作人（stay_by = null）
    ↓
记录解放停留时间（stay_released_at = 当前时间）
    ↓
记录解放停留操作人（stay_released_by = 当前用户ID）
    ↓
案件回到正常案件列表（不绑定催员，collector_id = null）
    ↓
操作成功，刷新停留案件列表
```

#### 3.4 权限控制流程

```text
管理员尝试标记案件为停留
    ↓
检查案件当前状态
    ↓
[已结清] → 提示："已结清的案件不能标记为停留"
    ↓
[已停留] → 提示："案件已经是停留状态"
    ↓
[正常状态] → 检查权限（只能操作权限范围内的案件）
    ↓
[无权限] → 提示："您没有权限操作此案件"
    ↓
[有权限] → 执行停留操作
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 案件选择规则

**选择规则**：
- 支持单选：点击案件行的复选框
- 支持全选：点击表头复选框
- 支持反选：取消全选
- 支持跨页选择：切换页面时保留已选案件
- 最少选择1个案件，最多不限制

**选择限制**：
- 只能选择未结清的案件（待还款、部分还款）
- 已结清的案件不能选择（正常结清、展期结清）
- 已停留的案件不能再次选择标记停留（在正常案件列表中不显示，只能从停留案件列表操作）
- 只能选择权限范围内的案件（机构管理员只能选择本机构的案件，小组管理员只能选择本小组的案件）

#### 4.2 停留状态规则

**停留状态定义**：
- 停留标识：`is_stay = true`（独立的停留状态字段，与案件还款状态`case_status`分离）
- 停留时间：`stay_at`（记录停留的时间）
- 停留操作人：`stay_by`（记录标记停留的用户ID）
- **注意**：停留状态是独立的状态标识，不影响案件的还款状态（`case_status`），案件原有的还款状态（待还款、部分还款等）保持不变

**停留后的影响**：
- **催员侧**：案件从催员案件列表中移除，催员无法查看和跟进
- **管理端**：
  - **正常案件列表**：明确不展示停留案件（`is_stay = false`或`is_stay IS NULL`的案件才显示）
  - 案件不可再分案（分案时过滤停留案件，`is_stay = true`的案件不参与分案）
  - 案件在停留案件列表中显示（`is_stay = true`）
- **自动化分案**：停留案件不参与自动化分案策略

#### 4.3 解放停留规则

**解放停留条件**：
- 仅对停留中的案件（`is_stay = true`）执行解放

**解放停留后的状态**：
- 取消停留标识（`is_stay = false`）
- 清除停留相关字段（`stay_at = null, stay_by = null`）
- 记录解放停留信息（`stay_released_at, stay_released_by`）
- **案件回到正常案件列表**（正常案件列表展示`is_stay = false`或`is_stay IS NULL`的案件）
- **案件不绑定催员**（`collector_id = null, team_id = null, agency_id = null`，需要重新分配）
- 案件可以重新分配和跟进

#### 4.4 权限规则

**权限范围说明**：
- 所有操作（标记停留、解放停留、查看停留案件）都必须遵循权限范围限制
- 用户只能看到和操作权限范围内的案件，不能超出范围
- 权限范围基于案件的组织架构归属（甲方、机构、小组）

**标记停留权限**：
- SuperAdmin：可以标记所有案件为停留
- TenantAdmin：只能标记本甲方的案件为停留（只能看到和操作本甲方的案件）
- AgencyAdmin：只能标记本机构的案件为停留（只能看到和操作本机构的案件，不能操作其他机构的案件）
- TeamLeader：只能标记本小组的案件为停留（只能看到和操作本小组的案件，不能操作其他小组的案件）

**解放停留权限**：
- SuperAdmin：可以解放所有停留案件
- TenantAdmin：只能解放本甲方的停留案件（只能看到和操作本甲方的停留案件）
- AgencyAdmin：只能解放本机构的停留案件（只能看到和操作本机构的停留案件，不能操作其他机构的停留案件）
- TeamLeader：只能解放本小组的停留案件（只能看到和操作本小组的停留案件，不能操作其他小组的停留案件）

**查看停留案件权限**：
- SuperAdmin：可以查看所有停留案件
- TenantAdmin：只能查看本甲方的停留案件（停留案件列表只显示本甲方的停留案件）
- AgencyAdmin：只能查看本机构的停留案件（停留案件列表只显示本机构的停留案件，不显示其他机构的停留案件）
- TeamLeader：只能查看本小组的停留案件（停留案件列表只显示本小组的停留案件，不显示其他小组的停留案件）

**权限验证规则**：
- 在标记停留前，验证用户是否有权限操作选中的案件
- 在解放停留前，验证用户是否有权限操作选中的停留案件
- 在查询停留案件列表时，自动过滤只显示权限范围内的案件
- 如果用户尝试操作权限范围外的案件，返回403错误："您没有权限操作此案件"

#### 4.5 停留案件列表规则

**列表展示**：
- 单独菜单："停留案件"（`/cases/stay`）
- 使用动态字段配置展示（场景类型：`admin_stay_case_list`）
- 支持筛选、搜索、排序、分页（同正常案件列表）
- **权限过滤**：只显示用户权限范围内的停留案件（机构管理员只显示本机构的，小组管理员只显示本小组的）

**筛选条件**：
- 案件队列（根据权限范围过滤）
- 甲方（根据权限范围过滤，机构管理员和小组管理员不可选）
- 停留时间范围
- 停留操作人

**搜索功能**：
- 支持搜索案件编号、客户姓名、客户ID、手机号码
- 搜索结果也受权限范围限制

#### 4.6 范围边界

**本次需求范围内**：
- ✅ 批量标记案件为停留
- ✅ 单个案件标记停留
- ✅ 停留案件列表展示
- ✅ 批量解放停留
- ✅ 单个案件解放停留
- ✅ 停留状态权限控制

**本次需求范围外**：
- ❌ 停留原因记录（暂不记录停留原因）
- ❌ 停留期限设置（暂不设置停留期限）
- ❌ 自动解放停留（暂不支持自动解放）
- ❌ 停留案件统计（暂不提供统计功能）
- ❌ 停留通知功能（暂不通知相关催员）

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据安全

**操作记录**：
- 记录案件停留操作日志
- 记录停留人、停留时间、停留的案件ID
- 记录解放停留操作日志
- 记录解放停留人、解放停留时间

**权限控制**：
- 不同角色只能操作权限范围内的案件
- 停留操作需要Token验证

#### 5.2 数据一致性

**停留一致性**：
- 停留操作需要保证数据一致性（事务处理）
- 如果部分案件停留失败，需要回滚所有停留操作
- 停留成功后更新案件的`is_stay = true`、`stay_at`、`stay_by`字段
- 清除案件的`collector_id`、`team_id`、`agency_id`字段
- **注意**：`case_status`字段保持不变，停留状态不影响案件的还款状态

**解放停留一致性**：
- 解放停留操作需要保证数据一致性（事务处理）
- 如果部分案件解放失败，需要回滚所有解放操作
- 解放成功后更新案件的`is_stay = false`、`stay_released_at`、`stay_released_by`字段
- **案件不绑定催员**：解放停留后，`collector_id`、`team_id`、`agency_id`保持为NULL，需要重新分配
- **注意**：`case_status`字段保持不变，解放停留不影响案件的还款状态

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不涉及资金流**，本节不适用。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 案件停留请求字段

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| case_ids | Array<Long> | 案件ID列表 | 用户选择 |

#### 7.2 案件停留响应字段

| 字段名 | 类型 | 说明 | 更新频率 |
|--------|------|------|----------|
| success_count | Integer | 成功停留的案件数量 | 操作时返回 |
| failure_count | Integer | 失败停留的案件数量 | 操作时返回 |
| failures | Array<Object> | 失败详情列表 | 操作时返回 |

#### 7.3 案件表新增字段

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| is_stay | TINYINT(1) | 是否停留（独立状态字段，与case_status分离） | 0 (false) |
| stay_at | DATETIME | 停留时间 | NULL |
| stay_by | BIGINT | 停留操作人ID | NULL |
| stay_released_at | DATETIME | 解放停留时间 | NULL |
| stay_released_by | BIGINT | 解放停留操作人ID | NULL |

#### 7.4 案件状态说明

**案件还款状态（case_status）**：描述案件的还款情况
| 状态值 | 中文名称 | 说明 |
|--------|---------|------|
| pending_repayment | 待还款 | 正常催收状态 |
| partial_repayment | 部分还款 | 正常催收状态 |
| normal_settlement | 正常结清 | 已结清 |
| extension_settlement | 展期结清 | 已结清 |

**停留状态（is_stay）**：独立的停留标识，与还款状态分离
| 状态值 | 说明 |
|--------|------|
| true | 案件处于停留状态（暂停催收） |
| false | 案件处于正常状态（可催收） |

**注意**：
- 停留状态（`is_stay`）与案件还款状态（`case_status`）是独立的两个维度
- 案件可以同时有还款状态（如"待还款"）和停留状态（如"停留"）
- 正常案件列表查询条件：`is_stay = false OR is_stay IS NULL`（排除停留案件）
- 停留案件列表查询条件：`is_stay = true`（只显示停留案件）

#### 7.5 统计口径

- **停留案件数**：`is_stay = true`的案件数量（按自然日统计，根据权限范围统计）
- **停留操作次数**：标记停留的操作次数（按自然日统计）
- **解放停留次数**：解放停留的操作次数（按自然日统计）
- **停留成功率**：成功停留的案件数 / 总停留操作案件数（按自然日统计）

---

### 8. 交互与信息展示（UX & UI Brief）

**前端交互已实现**，主要界面元素：

**案件列表页面（正常案件列表）**：
- **明确不展示停留案件**：只显示`is_stay = false`或`is_stay IS NULL`的案件
- 案件表格支持复选框选择
- 表头支持全选/取消全选
- 批量操作工具栏：显示已选案件数量、"标记停留"按钮
- 单个案件操作：案件详情页面的"标记停留"按钮
- **权限过滤**：只显示用户权限范围内的案件（机构管理员只显示本机构的，小组管理员只显示本小组的）

**停留确认弹窗**：
- 弹窗标题："标记停留确认"
- 提示内容："确定要将选中的 X 个案件标记为停留吗？停留后案件将从催员侧收回，管理端不可再分案。"
- 操作按钮：
  - "取消"按钮：关闭弹窗
  - "确认"按钮：执行停留操作

**停留案件列表页面**：
- 页面标题："停留案件"
- **只展示停留案件**：只显示`is_stay = true`的案件
- 使用动态字段配置展示（场景类型：`admin_stay_case_list`）
- **权限过滤**：只显示用户权限范围内的停留案件（机构管理员只显示本机构的，小组管理员只显示本小组的）
- 筛选器区域：
  - 案件队列下拉选择框（根据权限范围过滤）
  - 甲方下拉选择框（根据权限范围过滤，机构管理员和小组管理员不可选）
  - 停留时间范围选择器
  - 停留操作人下拉选择框
- 搜索框：支持搜索案件编号、客户姓名、客户ID、手机号码（搜索结果也受权限范围限制）
- 案件列表表格：支持复选框选择
- 批量操作工具栏：显示已选案件数量、"解放停留"按钮
- 单个案件操作：案件行的"解放停留"按钮

**解放停留确认弹窗**：
- 弹窗标题："解放停留确认"
- 提示内容："确定要将选中的 X 个案件解放停留吗？解放后案件将恢复到正常状态，回到正常案件列表。"
- 操作按钮：
  - "取消"按钮：关闭弹窗
  - "确认"按钮：执行解放停留操作

**操作结果提示**：
- 停留成功：显示"成功标记 X 个案件为停留"
- 停留失败：显示错误信息
- 解放停留成功：显示"成功解放停留 X 个案件"
- 解放停留失败：显示错误信息

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 停留功能配置

**配置项**：
- 是否启用案件停留功能（默认：启用）
- 停留案件列表是否使用动态字段配置（默认：是）

#### 9.2 权限配置

**配置入口**：权限配置页面

**配置项**：
- 各角色的案件停留权限范围
- 各角色的解放停留权限范围

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 用户点击标记停留按钮 | 标记停留按钮点击 | click_mark_stay | userId, selectedCaseCount |
| 用户确认标记停留 | 标记停留确认 | confirm_mark_stay | userId, caseCount |
| 案件停留成功 | 案件停留成功 | case_stay_success | userId, caseCount, successCount |
| 案件停留失败 | 案件停留失败 | case_stay_failure | userId, errorCode, errorMessage |
| 用户进入停留案件列表 | 停留案件列表访问 | page_view_stay_cases | userId, tenantId |
| 用户点击解放停留按钮 | 解放停留按钮点击 | click_release_stay | userId, selectedCaseCount |
| 用户确认解放停留 | 解放停留确认 | confirm_release_stay | userId, caseCount |
| 解放停留成功 | 解放停留成功 | case_release_stay_success | userId, caseCount, successCount |
| 解放停留失败 | 解放停留失败 | case_release_stay_failure | userId, errorCode, errorMessage |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```text
┌─────────────────┐
│   前端 (Vue3)   │
│  CaseList.vue   │
│  StayCaseList   │
└────────┬────────┘
         │ HTTP/HTTPS
         │ POST /api/v1/cases/batch-stay
         │ POST /api/v1/cases/batch-release-stay
         │ GET /api/v1/cases/stay
         ↓
┌─────────────────┐
│  Java后端        │
│  CaseController │
└────────┬────────┘
         │
         ├──→ CaseService (案件服务)
         ├──→ CaseMapper (数据访问)
         └──→ UserService (用户服务)
```

#### 1.2 模块职责

**前端模块**：
- `CaseList.vue`：案件列表页面，包含批量标记停留入口
- `StayCaseList.vue`：停留案件列表页面（已实现）
- `CaseDetail.vue`：案件详情页面，包含单个标记停留入口

**后端模块**：
- `CaseController`：案件控制器，处理停留和解放停留接口
- `CaseService`：案件服务，业务逻辑处理
- `CaseMapper`：案件数据访问层

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 批量标记停留接口

**接口路径**：`POST /api/v1/cases/batch-stay`

**请求参数**：
```json
{
  "case_ids": [1, 2, 3]
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| case_ids | Array<Long> | 是 | 案件ID列表 |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success_count": 100,
    "failure_count": 0,
    "failures": []
  }
}
```

**错误响应**：
- 400：参数错误（案件ID列表为空）
- 403：无权限操作
- 500：服务器内部错误

**超时与重试**：
- 超时时间：30秒（批量操作可能较慢）
- 重试策略：不重试（用户可手动重试）

**幂等性**：支持幂等（重复停留已停留的案件，返回成功但不重复操作）

**失败降级**：停留失败返回错误信息，部分成功时返回成功和失败的详情

#### 2.2 批量解放停留接口

**接口路径**：`POST /api/v1/cases/batch-release-stay`

**请求参数**：
```json
{
  "case_ids": [1, 2, 3]
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| case_ids | Array<Long> | 是 | 案件ID列表 |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success_count": 100,
    "failure_count": 0,
    "failures": []
  }
}
```

**错误响应**：
- 400：参数错误（案件ID列表为空或案件不是停留状态）
- 403：无权限操作
- 500：服务器内部错误

**超时与重试**：
- 超时时间：30秒
- 重试策略：不重试

**幂等性**：支持幂等（重复解放已解放的案件，返回成功但不重复操作）

#### 2.3 获取停留案件列表接口

**接口路径**：`GET /api/v1/cases/stay`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | Long | 否 | 甲方ID（根据权限自动过滤） |
| queue_id | Long | 否 | 队列ID |
| stay_by | Long | 否 | 停留操作人ID |
| stay_date_start | String | 否 | 停留时间开始 |
| stay_date_end | String | 否 | 停留时间结束 |
| search_keyword | String | 否 | 搜索关键词 |
| sort_by | String | 否 | 排序字段 |
| skip | Integer | 否 | 跳过数量（默认0） |
| limit | Integer | 否 | 限制数量（默认20） |

**权限过滤**：
- 后端自动根据用户角色过滤案件
- 机构管理员：只返回`agency_id = 用户所属机构ID`的停留案件
- 小组管理员：只返回`team_id = 用户所属小组ID`的停留案件
- 甲方管理员：只返回`tenant_id = 用户所属甲方ID`的停留案件
- 超级管理员：返回所有停留案件

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "case_code": "CASE001",
        "user_name": "张三",
        "case_status": "pending_repayment",
        "is_stay": true,
        "stay_at": "2025-11-27 10:00:00",
        "stay_by": 1,
        "stay_by_name": "管理员"
      }
    ],
    "total": 100,
    "skip": 0,
    "limit": 20
  }
}
```

#### 2.4 系统依赖

**内部依赖**：
- 案件服务
- 用户服务（获取操作人信息）

**外部依赖**：无

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据存储

**案件表（cases）**：
- 需要新增的字段：
  - `is_stay`：是否停留（TINYINT(1)，默认0，独立状态字段，与case_status分离）
  - `stay_at`：停留时间（DATETIME，可为NULL）
  - `stay_by`：停留操作人ID（BIGINT，可为NULL）
  - `stay_released_at`：解放停留时间（DATETIME，可为NULL）
  - `stay_released_by`：解放停留操作人ID（BIGINT，可为NULL）
- 需要更新的字段：
  - `is_stay`：停留标识（标记停留时设为true，解放停留时设为false）
  - `collector_id`：清除催员分配（停留时设为NULL，解放停留时也保持为NULL，不自动绑定）
  - `team_id`：清除小组分配（停留时设为NULL，解放停留时也保持为NULL）
  - `agency_id`：清除机构分配（停留时设为NULL，解放停留时也保持为NULL）
- **注意**：`case_status`字段保持不变，停留状态不影响案件的还款状态

**停留日志表（case_stay_logs，待实现）**：
```sql
CREATE TABLE IF NOT EXISTS `case_stay_logs` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `case_id` BIGINT NOT NULL COMMENT '案件ID',
  `operation_type` VARCHAR(20) NOT NULL COMMENT '操作类型：stay/release_stay',
  `operated_by` BIGINT NOT NULL COMMENT '操作人ID',
  `operated_at` DATETIME NOT NULL COMMENT '操作时间',
  `reason` TEXT COMMENT '操作原因（预留）',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_case_id` (`case_id`),
  KEY `idx_operated_at` (`operated_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案件停留操作日志表';
```

#### 3.2 查询优化

**停留案件列表查询优化**：
- 使用索引加速筛选条件查询（`is_stay = true`）
- 分页查询使用`LIMIT`和`OFFSET`
- 停留时间范围查询使用索引
- 权限范围过滤使用索引（`agency_id`, `team_id`, `tenant_id`）

**正常案件列表查询优化**：
- 明确过滤停留案件：`WHERE (is_stay = false OR is_stay IS NULL)`
- 使用索引加速筛选条件查询
- 权限范围过滤使用索引

**停留操作优化**：
- 批量更新使用事务处理
- 使用批量更新减少数据库访问次数

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **QPS**：停留和解放停留接口支持50 QPS
- **响应时间**：
  - 批量停留100个案件：≤5秒（P95）
  - 批量解放停留100个案件：≤5秒（P95）
  - 停留案件列表查询：≤2秒（P95）
- **峰值容量**：支持500个案件批量停留

#### 4.2 可用性要求

- **SLA**：99.9%可用性
- **降级策略**：
  - 批量停留失败时，返回部分成功结果
  - 停留案件列表查询失败时，显示错误提示
- **容灾**：支持多机房部署（待实现）

#### 4.3 安全要求

**接口安全**：
- 所有接口需要Token验证
- 接口需要HTTPS传输
- 防止SQL注入攻击

**权限控制**：
- 不同角色只能操作权限范围内的案件
- 停留操作需要记录操作日志

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 日志内容 | 日志级别 |
|---------|---------|---------|
| 批量停留请求 | 案件ID列表、操作人ID | INFO |
| 批量停留成功 | 成功停留的案件数量 | INFO |
| 批量停留失败 | 错误信息、异常堆栈 | ERROR |
| 批量解放停留请求 | 案件ID列表、操作人ID | INFO |
| 批量解放停留成功 | 成功解放的案件数量 | INFO |
| 批量解放停留失败 | 错误信息、异常堆栈 | ERROR |

**日志格式示例**：
```text
[2025-11-27 10:00:00] INFO  [CaseController] ========== 批量标记停留，case_ids=[1,2,3], operated_by=1 ==========
[2025-11-27 10:00:01] INFO  [CaseController] ========== 批量标记停留成功，成功=100, 失败=0 ==========
[2025-11-27 10:00:02] INFO  [CaseController] ========== 批量解放停留，case_ids=[1,2,3], operated_by=1 ==========
[2025-11-27 10:00:03] INFO  [CaseController] ========== 批量解放停留成功，成功=100, 失败=0 ==========
```

#### 5.2 监控指标

| 指标名称 | 指标类型 | 告警阈值 | 说明 |
|---------|---------|---------|------|
| 停留操作成功率 | 百分比 | <95% | 停留成功次数/总停留次数 |
| 停留操作响应时间 | 毫秒 | P95 >10000ms | 停留接口响应时间 |
| 解放停留成功率 | 百分比 | <95% | 解放停留成功次数/总解放次数 |
| 停留案件数量 | 数量 | >10000 | 当前停留案件总数 |

#### 5.3 告警规则

- **停留操作成功率低于95%**：发送告警通知
- **停留操作响应时间P95超过10秒**：发送告警通知
- **停留案件数量超过10000**：发送告警通知（可能需要批量处理）

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 停留状态更新逻辑测试
- 解放停留状态恢复逻辑测试
- 权限验证逻辑测试

**集成测试**：
- 批量停留接口完整流程测试
- 批量解放停留接口完整流程测试
- 停留案件列表查询接口测试

**功能测试**：
- 批量标记停留测试
- 单个标记停留测试
- 停留案件列表展示测试
- 批量解放停留测试
- 单个解放停留测试
- 权限控制测试
- 状态验证测试（已结清案件不能停留）

**性能测试**：
- 批量停留压力测试（500个案件）
- 批量解放停留压力测试（500个案件）
- 停留案件列表查询性能测试

**边界测试**：
- 选择1个案件标记停留
- 选择100个案件标记停留
- 选择0个案件（不允许）
- 停留已停留的案件（幂等性）
- 解放停留非停留案件（不允许）

#### 6.2 验收标准

1. **功能完整性**：
   - ✅ 支持批量标记案件为停留
   - ✅ 支持单个标记案件为停留
   - ✅ 停留状态独立于案件还款状态（使用is_stay字段）
   - ✅ 停留案件从催员侧收回
   - ✅ **正常案件列表明确不展示停留案件**（只显示is_stay = false或is_stay IS NULL的案件）
   - ✅ 停留案件不可再分案
   - ✅ 停留案件列表展示正常（只显示is_stay = true的案件）
   - ✅ 支持批量解放停留
   - ✅ 支持单个解放停留
   - ✅ **解放停留后案件回到正常列表，但不绑定催员**（collector_id = null）
   - ✅ **权限控制严格**：机构管理员和小组管理员只能看到和操作权限范围内的案件

2. **性能指标**：
   - ✅ 批量停留100个案件响应时间≤5秒（P95）
   - ✅ 批量解放停留100个案件响应时间≤5秒（P95）
   - ✅ 停留案件列表查询响应时间≤2秒（P95）

3. **数据准确性**：
   - ✅ 停留状态更新准确
   - ✅ 解放停留状态恢复准确
   - ✅ 催员分配清除准确

4. **用户体验**：
   - ✅ 操作流程顺畅，无卡顿
   - ✅ 错误提示清晰明确
   - ✅ 确认弹窗提示清晰

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**发布方式**：全量发布（当前版本）

**发布步骤**：
1. 数据库迁移：添加停留相关字段
2. 部署后端服务（停留和解放停留接口）
3. 部署前端静态资源（停留案件列表页面）
4. 验证停留功能正常
5. 验证解放停留功能正常
6. 监控系统指标

**灰度发布**（未来规划）：
- 支持按甲方灰度发布
- 支持按用户角色灰度发布
- 灰度比例：10% → 50% → 100%

#### 7.2 配置切换

**停留功能开关切换**：
- 在系统配置中修改停留功能开关
- 配置立即生效

#### 7.3 回滚方案

**回滚条件**：
- 停留操作成功率低于90%
- 停留操作响应时间P95超过15秒
- 出现严重功能缺陷

**回滚步骤**：
1. 停止新版本服务
2. 回滚数据库迁移（可选，如果数据已产生）
3. 回滚到上一个稳定版本
4. 验证功能正常
5. 通知相关人员

**回滚时间**：≤10分钟（包含数据库回滚）

#### 7.4 应急联系人

- **技术负责人**：待指定（上线前补充）
- **运维负责人**：待指定（上线前补充）
- **产品负责人**：待指定（上线前补充）

---

## 附录

### A. 相关文档

- [CCO系统功能设计.xlsx](../CCO%20系统功能设计.xlsx) - 控台功能点sheet，行39
- [案件列表功能PRD](./1.2%20案件列表功能PRD.md)
- [案件分配功能PRD](./案件分配功能PRD.md)
- [后端API文档](../../接口/1-管理控台API文档.md)

### B. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.1 | 2025-12-09 | 统一状态描述、性能指标与实现状态；补充代码块语言标注 | 大象 |
| v1.0 | 2025-11-27 | 初始版本，完成案件停留基础功能 | 大象 |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-12-09  
**文档版本**：v1.1

