# 案件列表功能 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

案件列表是CCO管理控台的核心功能之一，为管理员提供统一的案件查看和管理入口。不同甲方、不同队列的案件字段差异很大，需要支持动态字段配置，让管理员能够灵活配置需要展示的字段。同时，管理员需要能够快速筛选和查找目标案件，支持按多种条件组合筛选，提高案件管理效率。

**业务痛点**：
- 不同甲方的案件字段差异大，固定字段列表无法满足需求
- 案件数量庞大，需要高效的筛选和搜索能力
- 需要支持多种排序方式，便于按优先级处理案件
- 需要快速查看案件催记历史，了解催收进展

**预期影响的核心指标**：
- 案件查找效率：筛选+搜索平均查找时间≤30秒
- 页面加载性能：列表加载时间≤2秒（100条数据）
- 用户满意度：管理员对案件列表功能满意度≥90%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：查看案件列表**
- **入口**：管理控台菜单 → 案件管理 → 案件列表
- **触发时机**：管理员需要查看和管理案件时
- **所在页面**：`/cases`
- **流程节点**：选择甲方 → 查看案件列表 → 筛选/搜索 → 查看详情/催记

**场景2：筛选目标案件**
- **入口**：案件列表页面的筛选器
- **触发时机**：需要查找特定条件的案件（如某个队列、某个催员的案件）
- **所在页面**：案件列表页面
- **流程节点**：选择筛选条件 → 点击查询 → 查看筛选结果

**场景3：搜索案件**
- **入口**：案件列表页面的搜索框
- **触发时机**：知道案件编号、客户姓名、客户ID或手机号码，需要快速定位
- **所在页面**：案件列表页面
- **流程节点**：输入搜索关键词 → 点击搜索或按Enter → 查看搜索结果
- **注意**：手机号码支持搜索，列表默认脱敏展示，点击可展开（无需填写查看原因）

**场景4：查看案件催记**
- **入口**：案件列表 → 点击"查看催记"按钮
- **触发时机**：需要了解案件的历史催收记录
- **所在页面**：案件列表页面（弹窗）
- **流程节点**：点击查看催记 → 查看催记列表 → 查看催记详情

**场景5：查看案件详情**
- **入口**：案件列表 → 点击"查看详情"按钮
- **触发时机**：需要查看案件的完整信息
- **所在页面**：案件详情页面 `/cases/:id`
- **流程节点**：点击查看详情 → 跳转到详情页 → 查看完整信息

**场景6：批量标记案件停留**
- **入口**：案件列表 → 多选案件 → 标记停留按钮
- **触发时机**：特殊案件需要暂停催收，从催员侧收回
- **所在页面**：案件列表页面
- **流程节点**：选择案件 → 点击"标记停留" → 确认 → 案件进入停留状态
- **频率**：每日数次（约5-20次/日）
- **说明**：停留后案件将从催员侧收回，不可再分案，需解放停留后才能重新分配

**场景7：批量解放停留案件** （不是在本页面）
- **入口**：停留案件列表 → 多选案件 → 解放停留按钮
- **触发时机**：停留案件需要恢复正常流程
- **所在页面**：停留案件列表页面
- **流程节点**：选择停留案件 → 点击"解放停留" → 确认 → 案件恢复正常状态
- **频率**：每日数次（约5-20次/日）
- **说明**：解放停留后案件不会自动分配，需要手动重新分案

**场景8：手动批量分案**
- **入口**：案件列表 → 多选案件 → 批量分案按钮
- **触发时机**：需要将案件分配给催员进行催收
- **所在页面**：案件列表页面（分案对话框）
- **流程节点**：选择案件 → 点击"批量分案" → 选择催员 → 确认分配 → 分案成功
- **频率**：每日多次（约10-50次/日）
- **说明**：支持选择单个或多个催员，系统会自动进行队列匹配检查，详见[手动批量分案PRD](./手动批量分案PRD.md)

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 查看所有案件，监控整体情况 | 高 |
| 甲方管理员 | TenantAdmin | 查看本甲方案件，管理案件队列 | 高 |
| 机构管理员 | AgencyAdmin | 查看本机构案件，分配案件 | 中 |
| 小组管理员 | TeamLeader | 查看本小组案件，管理催员案件 | 中 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 案件列表查看流程

```
管理员进入案件列表页面
    ↓
检查是否已选择甲方
    ↓
[未选择] → 提示选择甲方（如果是甲方登录的话，要控制默认甲方只能是当前甲方，不可切换）
    ↓
[已选择] → 加载字段展示配置
    ↓
加载案件列表（默认第一页，默认排序）
    ↓
显示案件列表（使用动态字段配置）
    ↓
支持筛选、搜索、排序、分页操作
```

#### 3.2 筛选流程

```
管理员选择筛选条件
    ↓
【第一排】（不可更改）
├─ 选择案件状态（可选）
├─ 选择案件队列（可选）
├─ 选择到期日范围（可选，使用日期范围选择器）
└─ 输入逾期天数范围（可选，最小值~最大值）
    ↓
【第二排】（不可更改）
├─ 选择催收机构（可选）
├─ 选择催收小组群（可选，依赖机构）
├─ 选择催收小组（可选，依赖小组群）
└─ 选择催员（可选，依赖小组）
    ↓
【第三排】（固定新增筛选器，2行，每行4列）
├─ 第1行：期数（installment_no）、首期天数（first_term_days）、所属系统（system_name）、商户（merchant_name）
├─ 第2行：APP（app_name）、产品（product_name），其余2列预留保持对齐
【第四排起】自定义/动态筛选器（基于字段展示配置，按每行4个追加）
    ↓
点击查询按钮 / 筛选条件自动触发查询
    ↓
发送筛选请求
    ↓
显示筛选结果
    ↓
[可选] 点击重置按钮清空所有筛选条件
```

#### 3.3 搜索流程

```
管理员输入搜索关键词
    ↓
支持搜索：案件编号、客户姓名、客户ID、手机号码
    ↓
点击搜索或按Enter键
    ↓
发送搜索请求
    ↓
显示搜索结果
```

#### 3.4 查看催记流程

```
管理员点击"查看催记"按钮
    ↓
打开催记历史对话框（标题显示"历史催记 - {案件ID}"）
    ↓
自动加载该案件的历史催记记录
    ↓
显示催记列表（同IM端展示方式）
    ↓
（可选）通过筛选器按维度筛选催记
    ↓
查看催记详情
```

**注意**：
- v1.3版本优化：移除搜索框，标题直接显示当前案件ID
- 详见：[历史催记弹窗优化PRD](./历史催记弹窗优化PRD.md)

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 列表展示规则

**字段展示规则**：
- 使用动态字段配置（`admin_case_list`场景），前端存在兜底列。
- **必须展示字段**（固定展示，不可配置隐藏）：
  - `case_code`：案件编号
  - `user_name`：客户（列名）
  - `loan_amount`：贷款金额
  - `outstanding_amount`：未还金额
  - `overdue_days`：逾期天数
  - `case_status`：案件状态
  - `due_date`：到期日期
- **新增默认展示字段**（前端兜底展示，后端配置缺失时也显示，可配置关闭）：
  - `mobile_number`：手机号（默认脱敏，点击可展开，无需填写查看原因）
  - `merchant_name`：商户
  - `app_name`：APP
  - `product_name`：产品
  - `total_installments`：期数（总期数）
  - `term_days`：当期天数
  - `system_name`：所属系统
- **可配置字段**：除上述必显/默认展示字段外的其他字段可在字段配置中选择展示
- **特殊字段规则**：
  - `mobile_number`：列表可点击查看完整号码（默认脱敏），搜索亦支持
- 字段顺序、宽度、颜色、格式化由字段展示配置决定，前端在缺省时使用兜底配置
- 支持字段隐藏规则（按队列、机构、小组隐藏）
- 支持字段颜色规则（根据值显示不同颜色）

**分页规则**：
- 默认每页显示20条
- 支持每页10/20/50/100条切换
- 默认显示第一页
- 分页参数：`skip`（跳过数量）、`limit`（限制数量）

**排序规则**：
- 默认排序：按逾期天数降序（`overdue_days DESC`）
- 支持按数字字段排序（如逾期天数、应还金额等）
- 支持按日期字段排序（如到期日、结清日等）
- 支持升序/降序切换

#### 4.2 筛选规则

**筛选条件布局**（多排布局，至少两排）：

**第一排**（4个筛选条件）：
- **案件状态**：下拉选择（待还款、部分还款、正常结清、展期结清）
- **案件队列**：下拉选择，显示所有可用队列
- **到期日范围**：日期范围选择器（开始日期 ~ 结束日期）
- **逾期天数范围**：数字范围输入（最小值 ~ 最大值）

**第二排**（4个筛选条件，级联关系）：
- **催收机构**：下拉选择，显示所有可用机构
- **催收小组群**：下拉选择，依赖机构（选择机构后显示该机构的小组群）
- **催收小组**：下拉选择，依赖小组群（选择小组群后显示该小组群的小组）
- **催员**：下拉选择，依赖小组（选择小组后显示该小组的催员）

**第三排及以后**（动态筛选条件，基于甲方字段展示配置）：
- **数据来源**：从"甲方字段展示配置"中获取 `is_filterable = true` 的字段
- **字段类型限制**：仅支持枚举类型（Enum）字段作为筛选条件
- **筛选选项**：从字段枚举配置（`enum_values`）中获取可选项
- **布局规则**：每排显示4个筛选字段（与第一排、第二排保持一致）
- **自动换行**：如果动态筛选字段超过4个，自动换到下一排
- **字段顺序**：按照字段展示配置中的 `sort_order` 排序
- **示例**：
  - 如果配置了6个可筛选字段：前4个显示在第三排，后2个显示在第四排
  - 如果配置了0个可筛选字段：不显示第三排
- **渲染组件**：下拉选择框（el-select），支持单选或多选（根据字段配置）
- **交互行为**：筛选条件变更后自动触发查询

> **更新（2025-12-08）**：  
> - 第三排改为固定新增筛选器，2行、每行4列：  
>   - 第1行：期数（installment_no）、首期天数（first_term_days）、所属系统（system_name，iOS/Android/Web）、商户（merchant_name，下拉，选项来自已加载案件）  
>   - 第2行：APP（app_name，下拉）、产品（product_name，下拉），其余2列预留保持对齐  
> - 自定义/动态筛选器从 **第四排** 开始追加，继续遵循每行4个、超出自动换行的规则。

**筛选条件联动规则**：
- 选择机构后 → 自动加载该机构的小组群列表
- 选择小组群后 → 自动加载该小组群的小组列表
- 选择小组后 → 自动加载该小组的催员列表
- 清空上级筛选条件时，自动清空下级筛选条件

**范围筛选优化**：
- **到期日范围**：使用日期范围选择器组件
  - 支持快捷选择：今天、最近7天、最近30天、自定义
  - 格式：YYYY-MM-DD
  - 交互：点击输入框弹出日期选择器
- **逾期天数范围**：使用数字范围输入组件
  - 最小值输入框 + "~" + 最大值输入框
  - 支持只填写最小值（表示>=）或只填写最大值（表示<=）
  - 自动验证：最小值不能大于最大值
  - 示例：输入 "0~30" 表示逾期0-30天的案件

**动态字段筛选**（第四排及以后）：
- **位置**：第四排开始，每排4个字段（与第一、二排对齐；第三排为固定新增筛选器）
- **数据源**：基于字段展示配置中的`is_filterable = true`的字段
- **字段类型**：仅枚举类型（Enum）字段支持筛选
- **筛选选项**：从字段枚举配置（`enum_values`）中获取
  - 选项标签：优先使用 `tenant_name`（甲方自定义名称），其次 `standard_name`（标准名称）
  - 选项值：使用 `standard_id` 或 `tenant_id`
- **排序规则**：按字段展示配置中的 `sort_order` 升序排列
- **换行逻辑**：每4个字段换一排（如第3排显示字段5-8，第4排显示字段9-12）
- **配置管理**：管理员点击页面右上角“筛选器配置”按钮后，跳转到左侧菜单“案件列表字段展示配置”页面（`/field-config/list`）选择哪些字段显示在筛选器中

**筛选组合规则**：
- 支持多条件组合筛选（AND关系）
- 所有筛选条件都是可选的
- 筛选条件变更后自动触发查询
- 点击"重置"按钮清空所有筛选条件

#### 4.3 搜索规则

**搜索范围**：
- 案件编号（精确匹配或模糊匹配）
- 客户姓名（模糊匹配）
- 客户ID（精确匹配）
- 手机号码（精确匹配或模糊匹配）- **注意**：手机号码虽然不在列表中展示，但支持搜索

**搜索规则**：
- 支持单个关键词搜索
- 搜索关键词为空时不进行搜索
- 搜索与筛选条件可以组合使用（AND关系）

#### 4.4 权限规则

**查看权限**：
- SuperAdmin：可查看所有甲方的案件
- TenantAdmin：仅可查看本甲方的案件
- AgencyAdmin：仅可查看本机构的案件
- TeamLeader：仅可查看本小组的案件

**筛选器配置权限**：
- SuperAdmin和TenantAdmin可以配置筛选器
- 其他角色只能使用已配置的筛选器

#### 4.5 范围边界

**本次需求范围内**：
- ✅ 案件列表展示（使用动态字段配置）
- ✅ 分页、筛选、排序功能
- ✅ 搜索功能
- ✅ 查看历史催记记录（同IM端）
- ✅ 查看案件详情（跳转到详情页）
- ✅ 批量标记案件停留
- ✅ 批量解放停留案件
- ✅ 手动批量分案（详见[手动批量分案PRD](./手动批量分案PRD.md)）
- ✅ 案件列表字段分组管理（仅维护/导出分组元数据，列表前端暂不按组展示）

**本次需求范围外**：
- ❌ 案件编辑功能
- ❌ 自动分案功能（智能分案）
- ❌ 案件导出功能
- ❌ 案件统计功能

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据隐私

**敏感信息处理**：
- 客户手机号码需要脱敏显示（如：138****5678）
- 客户身份证号需要脱敏显示（如：320***********1234）
- 客户姓名根据隐私设置决定是否显示

**权限控制**：
- 不同角色只能查看权限范围内的案件
- 字段隐藏规则支持按队列、机构、小组隐藏敏感字段

#### 5.2 数据安全

**接口安全**：
- 所有接口需要Token验证
- 接口需要HTTPS传输
- 防止SQL注入攻击

**日志记录**：
- 记录案件列表查询日志
- 记录案件详情查看日志
- 记录催记查看日志
- 日志中不记录敏感信息（如密码、完整手机号）

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不涉及资金流**，本节不适用。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 案件列表字段

**必须展示字段**（固定展示，不可配置隐藏）：
- `case_code`：案件编号
- `user_name`：客户（列名显示为"客户"）
- `loan_amount`：贷款金额
- `outstanding_amount`：未还金额
- `overdue_days`：逾期天数
- `case_status`：案件状态
- `due_date`：到期日期

**新增默认展示字段**（前端兜底展示，可配置关闭，后端缺省时亦展示）：
- `mobile_number`：手机号（默认脱敏，点击可展开，无需填写查看原因）
- `merchant_name`：商户
- `app_name`：APP
- `product_name`：产品
- `total_installments`：期数（总期数）
- `term_days`：当期天数
- `system_name`：所属系统
- **列序规则**：在到期日期（`due_date`）之后，按顺序展示：期数（total_installments）→ 当期天数（term_days）→ 所属系统（system_name）→ 产品（product_name）→ APP（app_name）→ 商户（merchant_name）

**其他标准字段**（可配置是否展示）：
- `user_id`：客户ID
- `settlement_date`：结清日期
- 其他标准字段

**特殊字段**：
- `mobile_number`：手机号码（默认脱敏展示，可点击展开；支持搜索）

**动态字段**（根据字段展示配置）：
- 标准字段：从标准字段配置中获取
- 拓展字段：从甲方字段配置中获取
- 自定义字段：从字段映射配置中获取

#### 7.2 筛选条件字段

| 字段名 | 类型 | 说明 | 来源 | 所在排 |
|--------|------|------|------|--------|
| case_status | String | 案件状态 | 固定枚举值 | 第一排 |
| queue_id | Long | 案件队列ID | 从队列列表获取 | 第一排 |
| due_date_start | String | 到期日开始 | 日期选择器（YYYY-MM-DD） | 第一排 |
| due_date_end | String | 到期日结束 | 日期选择器（YYYY-MM-DD） | 第一排 |
| overdue_days_min | Integer | 逾期天数最小值 | 数字输入框 | 第一排 |
| overdue_days_max | Integer | 逾期天数最大值 | 数字输入框 | 第一排 |
| agency_id | Long | 机构ID | 从机构列表获取 | 第二排 |
| team_group_id | Long | 小组群ID | 从小组群列表获取（依赖机构） | 第二排 |
| team_id | Long | 小组ID | 从小组列表获取（依赖小组群） | 第二排 |
| collector_id | Long | 催员ID | 从催员列表获取（依赖小组） | 第二排 |
| installment_no | Integer/String | 期数 | 固定筛选器 | 第三排 |
| first_term_days | Integer/String | 首期天数 | 固定筛选器 | 第三排 |
| system_name | String | 所属系统（iOS/Android/Web） | 固定筛选器 | 第三排 |
| merchant_name | String | 商户 | 固定筛选器（下拉，选项来自已加载案件） | 第三排 |
| app_name | String | APP | 固定筛选器（下拉，选项来自已加载案件） | 第三排 |
| product_name | String | 产品 | 固定筛选器（下拉，选项来自已加载案件） | 第三排 |
| search_keyword | String | 搜索关键词 | 用户输入 | 搜索区域 |
| sort_by | String | 排序字段 | 用户选择 | 表头排序 |

#### 7.3 分页字段

| 字段名 | 类型 | 说明 | 默认值 |
|--------|------|------|--------|
| skip | Integer | 跳过数量 | 0 |
| limit | Integer | 限制数量 | 20 |

#### 7.4 统计口径

- **案件总数**：符合筛选条件的案件总数（按自然日统计）
- **分页总数**：`total = Math.ceil(案件总数 / limit)`
- **当前页数据**：`items = cases.slice(skip, skip + limit)`

---

### 8. 交互与信息展示（UX & UI Brief）

**前端交互已实现**，主要界面元素：

**筛选器区域**（两排紧凑布局）：

**第一排**（4个筛选条件）：
- 案件状态：下拉选择框，支持单选
- 案件队列：下拉选择框，支持单选
- 到期日范围：日期范围选择器
  - 支持快捷选择：今天、最近7天、最近30天
  - 支持自定义选择开始和结束日期
  - 格式：YYYY-MM-DD
- 逾期天数范围：数字范围输入
  - 最小值输入框 + "至" + 最大值输入框
  - 支持只填一个值（单边范围）
  - 自动校验：最小值 ≤ 最大值

**第二排**（4个筛选条件，级联关系）：
- 催收机构：下拉选择框，支持单选
- 催收小组群：下拉选择框，依赖机构（选择机构后加载）
- 催收小组：下拉选择框，依赖小组群（选择小组群后加载）
- 催员：下拉选择框，依赖小组（选择小组后加载）

**操作按钮**：
- 查询按钮：触发筛选查询
- 重置按钮：清空所有筛选条件

**搜索区域**：
- 搜索输入框（支持Enter键搜索）
- 搜索按钮
- 提示文案："搜索案件编号、客户姓名、客户ID、手机号码"

**列表区域**：
- 动态表格（使用`DynamicCaseTable`组件）
- 列宽、对齐方式、颜色由字段展示配置决定
- 支持列排序（数字和日期字段）
- 操作列：查看详情、查看催记

**分页区域**：
- 分页组件（显示总数、每页条数、页码跳转）

**催记对话框**（v1.3优化）：
- 对话框标题："历史催记 - {案件ID}"（动态显示当前查看的案件ID）
- 催记列表（同IM端展示方式）
- 支持筛选催记（触达人、渠道、状态、结果、日期范围）
- 详见：[历史催记弹窗优化PRD](./历史催记弹窗优化PRD.md)

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 字段展示配置

**配置入口**：字段配置 → 甲方字段展示配置

**配置项**：
- 字段显示顺序（`sort_order`）
- 字段显示宽度（`display_width`）
- 字段颜色类型（`color_type`）
- 字段颜色规则（`color_rule`）
- 字段隐藏规则（`hide_rule`）
- 字段格式化规则（`format_rule`）
- 是否可筛选（`is_filterable`）
- 是否支持范围检索（`is_range_searchable`）
- 是否必须展示（`is_required`）- **新增字段**

**必须展示字段配置规则**：
- 以下字段为必须展示字段，`is_required` 为 `true`，不可配置隐藏：
  - `case_code`（案件编号）
  - `user_name`（客户，列名显示为"客户"）
  - `loan_amount`（贷款金额）
  - `outstanding_amount`（未还金额）
  - `overdue_days`（逾期天数）
  - `case_status`（案件状态）
  - `due_date`（到期日期）
- 其他字段可以通过配置控制是否展示

**特殊字段配置规则**：
- `mobile`（手机号）：不在列表中展示，但支持搜索功能

**场景类型**：`admin_case_list`（控台案件列表）

#### 9.2 筛选器配置

**配置入口**：案件列表页面 → 筛选器配置按钮（仅SuperAdmin和TenantAdmin可见，点击后跳转至左侧菜单“案件列表字段展示配置”页面，路由 `/field-config/list`）

**配置项**：
- 选择要显示的筛选字段
- 配置筛选字段的顺序
- 配置筛选字段的默认值

#### 9.3 分页配置

**配置项**：
- 默认每页条数：20（可配置）
- 每页条数选项：10/20/50/100（可配置）

#### 9.4 字段分组管理（列表场景）

**背景与作用**：
- 为列表字段提供逻辑分组元数据，便于运营理解、维护与导出（当前列表前端不按组展示，但需保留分组管理能力）。
- 分组仅作用于列表场景 `admin_case_list`，与详情分组解耦。

**配置入口**：
- 路由：`/field-config/detail/groups`（列表分组管理页）
- 展示形式：左侧分组树 + 右侧分组表单/列表

**分组模型**：
- 字段：`id, group_key, group_name, group_name_en, parent_id, sort_order, is_active, created_at, updated_at`
- 支持多级（建议两级），按 `sort_order` 升序

**管理能力**：
- 新增、编辑、删除、排序（上移/下移或拖拽）
- 排序调整支持批量保存
- 删除校验：若分组存在子分组或仍关联字段，需提示“请先调整字段分组”并阻止删除

**分组与其他页面的关系**：
- 分组树不在“列表标准字段/甲方字段/映射配置”页面显示，避免干扰已有维护流程
- 仅列表分组管理页保留分组树，详情分组管理逻辑保持不变

**使用范围**：
- 场景标识：`admin_case_list`
- 仅维护分组元数据，当前列表展示仍按字段展示配置的顺序与宽度渲染

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 用户进入案件列表页 | 案件列表页访问 | page_view_case_list | userId, role, tenantId |
| 用户点击查询按钮 | 筛选查询 | click_filter_query | userId, filterConditions |
| 用户输入搜索关键词并搜索 | 案件搜索 | case_search | userId, searchKeyword, resultCount |
| 用户点击排序 | 列表排序 | case_list_sort | userId, sortField, sortOrder |
| 用户切换分页 | 分页切换 | case_list_pagination | userId, page, pageSize |
| 用户点击查看详情 | 查看案件详情 | click_view_case_detail | userId, caseId |
| 用户点击查看催记 | 查看案件催记 | click_view_case_notes | userId, caseId |
| 列表加载完成 | 列表加载完成 | case_list_loaded | userId, totalCount, loadTime |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```
┌─────────────────┐
│   前端 (Vue3)   │
│  /cases         │
│  CaseList.vue   │
└────────┬────────┘
         │ HTTP/HTTPS
         │ GET /api/v1/cases
         ↓
┌─────────────────┐
│  Java后端        │
│  CaseController │
└────────┬────────┘
         │
         ├──→ CaseService (案件服务)
         ├──→ CaseMapper (数据访问)
         ├──→ FieldDisplayConfigService (字段配置服务)
         └──→ QueueService (队列服务)
```

#### 1.2 模块职责

**前端模块**：
- `CaseList.vue`：案件列表页面组件
- `DynamicCaseTable.vue`：动态表格组件
- `useFieldDisplayConfig.ts`：字段展示配置Hook
- `CaseDetail.vue`：案件详情页面组件

**后端模块**：
- `CaseController`：案件控制器，处理案件列表查询
- `CaseService`：案件服务，业务逻辑处理
- `CaseMapper`：案件数据访问层
- `FieldDisplayConfigController`：字段展示配置控制器

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 获取案件列表接口

**接口路径**：`GET /api/v1/cases`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 | 筛选位置 |
|--------|------|------|------|----------|
| tenant_id | Long | 否 | 甲方ID | 系统自动 |
| case_status | String | 否 | 案件状态 | 第一排 |
| queue_id | Long | 否 | 队列ID | 第一排 |
| agency_id | Long | 否 | 机构ID | 第二排 |
| team_group_id | Long | 否 | 小组群ID（新增） | 第二排 |
| team_id | Long | 否 | 小组ID | 第二排 |
| collector_id | Long | 否 | 催员ID | 第二排 |
| due_date_start | String | 否 | 到期日期开始（YYYY-MM-DD） | 第一排 |
| due_date_end | String | 否 | 到期日期结束（YYYY-MM-DD） | 第一排 |
| overdue_days_min | Integer | 否 | 逾期天数最小值（新增） | 第一排 |
| overdue_days_max | Integer | 否 | 逾期天数最大值（新增） | 第一排 |
| {field_key} | 根据字段类型 | 否 | 动态筛选字段值（如：gender、marital_status等） | 第三排+ |
| user_id | String | 否 | 用户ID | - |
| search_keyword | String | 否 | 搜索关键词 | 搜索区域 |
| settlement_date_start | String | 否 | 结清日期开始 | - |
| settlement_date_end | String | 否 | 结清日期结束 | - |
| sort_by | String | 否 | 排序字段（如：collection_value） | 表头排序 |
| skip | Integer | 否 | 跳过数量（默认0） | 分页 |
| limit | Integer | 否 | 限制数量（默认20） | 分页 |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1,
        "case_code": "CASE001",
        "user_id": "USER001",
        "user_name": "张三",
        "mobile": "13800138000",
        "loan_amount": 10000.00,
        "outstanding_amount": 5000.00,
        "case_status": "待还款",
        "overdue_days": 10,
        "due_date": "2025-11-20",
        "settlement_date": null
      }
    ],
    "total": 100,
    "skip": 0,
    "limit": 20
  }
}
```

**响应字段说明**：
- `user_name`：客户姓名（列表中显示列名为"客户"）
- `mobile`：手机号码（后端返回，但前端列表不展示，仅用于搜索）
- `loan_amount`、`outstanding_amount`、`overdue_days`、`case_status`、`due_date`：必须展示字段

**特殊排序规则**：
- `sort_by=collection_value`：催回价值排序
  - 筛选所有未还案件（`case_status != 'normal_settlement' AND case_status != 'extension_settlement'`）
  - 排序1：逾期日少的在前（`overdue_days ASC`）
  - 排序2：金额大的在前（`outstanding_amount DESC`）

**超时与重试**：
- 超时时间：10秒
- 重试策略：不重试（用户可手动重试）

**幂等性**：查询接口天然幂等

**失败降级**：查询失败返回错误信息，不进行降级处理

#### 2.2 获取字段展示配置接口

**接口路径**：`GET /api/v1/field-display-configs`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | String | 是 | 甲方ID |
| scene_type | String | 是 | 场景类型（admin_case_list） |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_id": "TENANT001",
      "scene_type": "admin_case_list",
      "field_key": "case_code",
      "field_name": "案件编号",
      "sort_order": 1,
      "display_width": 150,
      "color_type": "normal",
      "is_filterable": false,
      "is_range_searchable": false,
      "is_required": true
    },
    {
      "id": 2,
      "tenant_id": "TENANT001",
      "scene_type": "admin_case_list",
      "field_key": "user_name",
      "field_name": "客户",
      "sort_order": 2,
      "display_width": 120,
      "color_type": "normal",
      "is_filterable": false,
      "is_range_searchable": false,
      "is_required": true
    },
    {
      "id": 3,
      "tenant_id": "TENANT001",
      "scene_type": "admin_case_list",
      "field_key": "loan_amount",
      "field_name": "贷款金额",
      "sort_order": 3,
      "display_width": 120,
      "color_type": "normal",
      "is_filterable": false,
      "is_range_searchable": true,
      "is_required": true
    }
  ]
}
```

**字段说明**：
- `is_required`：是否必须展示（true=必须展示，不可配置隐藏；false=可配置）
- 必须展示字段：`case_code`、`user_name`、`loan_amount`、`outstanding_amount`、`overdue_days`、`case_status`、`due_date`
- `user_name` 的 `field_name` 应为"客户"（不是"客户姓名"）

#### 2.3 获取队列列表接口

**接口路径**：`GET /api/v1/queues`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | Long | 否 | 甲方ID |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "queue_name": "队列1",
      "tenant_id": 1
    }
  ]
}
```

#### 2.4 获取机构列表接口

**接口路径**：`GET /api/v1/organization/agencies`

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "agency_name": "机构1"
    }
  ]
}
```

#### 2.5 获取小组群列表接口（新增）

**接口路径**：`GET /api/v1/organization/team-groups`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| agency_id | Long | 是 | 机构ID |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "group_name": "小组群1",
      "agency_id": 1
    }
  ]
}
```

#### 2.6 获取小组列表接口

**接口路径**：`GET /api/v1/organization/teams`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| team_group_id | Long | 否 | 小组群ID（优先级高于agency_id） |
| agency_id | Long | 否 | 机构ID（当team_group_id为空时使用） |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "team_name": "小组1",
      "agency_id": 1
    }
  ]
}
```

#### 2.7 获取催员列表接口

**接口路径**：`GET /api/v1/organization/collectors`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| team_id | Long | 是 | 小组ID |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "collector_name": "催员1",
      "team_id": 1
    }
  ]
}
```

#### 2.8 系统依赖

**内部依赖**：
- 字段展示配置服务
- 队列管理服务
- 组织架构服务（机构、小组群、小组、催员）

**外部依赖**：无

#### 2.9 案件列表字段分组管理接口

**接口路径**：`/api/v1/field-groups`（需支持 GET/POST/PUT/DELETE；场景限定 `admin_case_list`）

**请求参数示例**：
| 方法 | 关键参数 | 说明 |
|------|---------|------|
| GET | scene_type=admin_case_list | 按场景获取分组树，排序升序 |
| POST | group_key, group_name, sort_order, parent_id?, scene_type=admin_case_list | 新增分组，group_key 同层级唯一 |
| PUT | id, group_name?, sort_order?, parent_id? | 编辑名称、排序或层级 |
| DELETE | id | 删除前需校验：无子分组且未关联字段 |

**规则**：
- 分组与列表场景绑定，避免与详情分组合并
- 删除失败需返回明确提示（例如“请先调整字段分组”）
- 排序调整可批量提交，后端按 `sort_order` 持久化

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据存储

**案件表（cases）**：
- 主键：`id`
- 索引：`tenant_id`、`queue_id`、`collector_id`、`case_status`、`user_id`

**字段展示配置表（field_display_configs）**：
- 主键：`id`
- 唯一键：`(tenant_id, scene_type, field_key)`
- 索引：`tenant_id`、`scene_type`

**队列表（queues）**：
- 主键：`id`
- 索引：`tenant_id`

#### 3.2 查询优化

**案件列表查询优化**：
- 使用索引加速筛选条件查询
- 分页查询使用`LIMIT`和`OFFSET`
- 排序字段建立索引

**字段配置查询优化**：
- 字段展示配置按`tenant_id`和`scene_type`查询，使用索引

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **QPS**：案件列表接口支持200 QPS
- **响应时间**：
  - 案件列表查询：≤2秒（100条数据，P95）
  - 字段配置加载：≤500ms（P95）
  - 筛选条件加载：≤300ms（P95）
- **峰值容量**：支持1000并发查询请求

#### 4.2 可用性要求

- **SLA**：99.9%可用性
- **降级策略**：
  - 字段配置加载失败时，使用默认字段配置
  - 案件列表查询失败时，显示错误提示
- **容灾**：支持多机房部署（待实现）

#### 4.3 安全要求

**接口安全**：
- 所有接口需要Token验证
- 接口需要HTTPS传输
- 防止SQL注入攻击

**数据安全**：
- 敏感信息脱敏显示
- 权限控制：不同角色只能查看权限范围内的案件

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 日志内容 | 日志级别 |
|---------|---------|---------|
| 案件列表查询 | 查询参数、结果数量 | INFO |
| 案件列表查询失败 | 错误信息、异常堆栈 | ERROR |
| 字段配置加载 | 甲方ID、场景类型、配置数量 | INFO |
| 筛选条件变更 | 筛选条件、用户ID | INFO |

**日志格式示例**：
```
[2025-11-27 10:00:00] INFO  [CaseController] ========== 获取案件列表，tenant_id=1, case_status=待还款, skip=0, limit=20 ==========
[2025-11-27 10:00:01] INFO  [CaseController] ========== 返回案件列表，总数=100, 当前页数量=20 ==========
```

#### 5.2 监控指标

| 指标名称 | 指标类型 | 告警阈值 | 说明 |
|---------|---------|---------|------|
| 案件列表查询成功率 | 百分比 | <95% | 查询成功次数/总查询次数 |
| 案件列表查询响应时间 | 毫秒 | P95 >3000ms | 查询接口响应时间 |
| 字段配置加载成功率 | 百分比 | <90% | 配置加载成功次数/总加载次数 |
| 案件列表页面加载时间 | 毫秒 | >5000ms | 前端页面完整加载时间 |

#### 5.3 告警规则

- **案件列表查询成功率低于95%**：发送告警通知
- **案件列表查询响应时间P95超过3秒**：发送告警通知
- **字段配置加载失败率超过10%**：发送告警通知

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 案件列表查询逻辑测试
- 字段配置加载逻辑测试
- 筛选条件组合测试
- 排序逻辑测试

**集成测试**：
- 案件列表接口完整流程测试
- 字段配置接口测试
- 筛选条件接口测试

**功能测试**：
- 案件列表展示测试
- 筛选功能测试
- 搜索功能测试
- 排序功能测试
- 分页功能测试
- 查看催记功能测试
- 查看详情功能测试
- 字段分组管理测试（新增/编辑/删除/排序；删除校验；分组树仅出现在列表分组页）

**性能测试**：
- 案件列表查询压力测试（200 QPS）
- 大量数据分页测试（10000+条数据）
- 字段配置加载性能测试

**兼容性测试**：
- 不同浏览器兼容性测试
- 不同屏幕尺寸响应式测试

#### 6.2 验收标准

1. **功能完整性**：
   - ✅ 案件列表正确展示（使用动态字段配置）
   - ✅ 筛选功能正常工作（所有筛选条件）
   - ✅ 搜索功能正常工作（支持所有搜索字段）
   - ✅ 排序功能正常工作（支持所有可排序字段）
   - ✅ 分页功能正常工作
   - ✅ 查看催记功能正常工作（同IM端）
   - ✅ 查看详情功能正常工作
   - ✅ 字段分组管理可正常新增/编辑/删除/排序，删除时若有关联字段或子分组能阻止并提示；分组树仅在列表分组页显示

2. **性能指标**：
   - ✅ 案件列表查询响应时间≤2秒（100条数据，P95）
   - ✅ 字段配置加载时间≤500ms（P95）
   - ✅ 支持200 QPS并发查询

3. **用户体验**：
   - ✅ 页面加载流畅，无卡顿
   - ✅ 筛选条件变更后自动查询
   - ✅ 支持Enter键搜索
   - ✅ 错误提示清晰明确

4. **数据准确性**：
   - ✅ 筛选结果准确
   - ✅ 搜索结果准确
   - ✅ 排序结果准确
   - ✅ 分页数据准确

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**发布方式**：全量发布（当前版本）

**发布步骤**：
1. 部署后端服务（案件列表接口、字段配置接口）
2. 部署前端静态资源（案件列表页面）
3. 验证案件列表功能正常
4. 验证筛选、搜索、排序功能正常
5. 监控系统指标

**灰度发布**（未来规划）：
- 支持按甲方灰度发布
- 支持按用户角色灰度发布
- 灰度比例：10% → 50% → 100%

#### 7.2 配置切换

**字段展示配置切换**：
- 在字段展示配置页面修改配置
- 配置立即生效（前端重新加载配置）

**筛选器配置切换**：
- 在案件列表页面配置筛选器
- 配置立即生效

#### 7.3 回滚方案

**回滚条件**：
- 案件列表查询成功率低于90%
- 案件列表查询响应时间P95超过5秒
- 出现严重功能缺陷

**回滚步骤**：
1. 停止新版本服务
2. 回滚到上一个稳定版本
3. 验证功能正常
4. 通知相关人员

**回滚时间**：≤5分钟

#### 7.4 应急联系人

- **技术负责人**：待指定
- **运维负责人**：待指定
- **产品负责人**：待指定

---

## 附录

### A. 相关文档

- [CCO系统功能设计.xlsx](../CCO%20系统功能设计.xlsx) - 控台功能点sheet，行25-26
- [字段展示配置功能说明](../../说明文档/功能说明/拓展字段快速开始指南.md)
- [后端API文档](../../接口/1-管理控台API文档.md)

### B. 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0 | 2025-11-27 | 初始版本，完成案件列表基础功能 | AI Assistant |
| v1.1 | 2025-12-04 | 1. 手机号不在列中展示，但可被搜索<br>2. 客户姓名列名更新为"客户"<br>3. 定义必须展示字段（案件编号、客户、贷款金额、未还金额、逾期天数、案件状态、到期日期），其他字段可配置 | AI Assistant |
| v1.2 | 2025-12-04 | 筛选条件优化：<br>1. 调整筛选布局为两排（第一排：案件状态、案件队列、到期日范围、逾期天数范围；第二排：机构、小组群、小组、催员）<br>2. 新增小组群筛选条件<br>3. 优化范围筛选交互（日期范围选择器支持快捷选择、数字范围输入）<br>4. 完善筛选条件级联逻辑 | AI Assistant |
| v1.3 | 2025-12-04 | 历史催记弹窗优化：<br>1. 移除搜索框（不再需要搜索案件ID）<br>2. 弹窗标题显示当前案件ID（格式：历史催记 - {案件ID}）<br>3. 自动加载当前案件的催记，保留筛选功能<br>详见：[历史催记弹窗优化PRD](./历史催记弹窗优化PRD.md) | AI Assistant |
| v1.4 | 2025-12-05 | 筛选器布局规则明确化：<br>1. 明确第一排、第二排为固定筛选条件（各4个）<br>2. 明确第三排及以后为动态筛选器（基于甲方字段展示配置）<br>3. 明确动态筛选器布局规则：每排4个字段<br>4. 修正接口参数表中到期日/逾期天数范围的排位标注错误 | AI Assistant |
| v1.5 | 2025-12-05 | 补充批量操作功能：<br>1. 批量标记案件停留（从催员侧收回，不可再分案）<br>2. 批量解放停留案件（恢复正常状态，需手动重新分案）<br>3. 代码已实现，补充PRD说明 | AI Assistant |
| v1.6 | 2025-12-05 | 补充手动批量分案入口：<br>1. 新增场景8：手动批量分案<br>2. 添加批量分案功能入口说明<br>3. 详细PRD见独立文档[手动批量分案PRD](./手动批量分案PRD.md) | AI Assistant |
| v1.7 | 2025-12-08 | 案件列表增强：<br>1. 新增默认展示字段：手机号（可点击展开，无需原因）、商户、APP、产品、期数、当期天数、所属系统<br>2. 固定新增筛选器：期数、首期天数、所属系统、商户、APP、产品（2行，每行4列），自定义筛选器从第四排开始<br>3. 更新筛选布局与字段说明，对齐每行4列 | AI Assistant |
| v1.8 | 2025-12-08 | 案件列表字段分组管理：<br>1. 新增列表分组管理能力（新增/编辑/删除/排序），场景限定 `admin_case_list`<br>2. 分组树仅在列表分组页保留，不影响列表标准字段/甲方字段/映射页面展示<br>3. 删除校验需阻止有子分组或关联字段的分组删除 | AI Assistant |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-12-08  
**文档版本**：v1.8


