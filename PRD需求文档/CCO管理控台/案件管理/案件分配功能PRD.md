# 案件分配功能 PRD

| 日期 | 版本 | 变更内容 | 责任人 |
|------|------|---------|--------|
| 2025-12-08 | v1.2 | 1. 新增案件与催员属性匹配校验（所属系统/当期天数/产品/APP/商户/队列）<br>2. 新增限制属性筛选器（所属系统/当期天数/产品/APP/商户）<br>3. 补充所有错误提示文案规范<br>4. 完善分案弹窗展示小组/催员完整限制范围 | 大象 |
| 2025-12-08 | v1.1 | 批量分案弹窗补充展示并查询小组/催员限制属性（商户/APP/产品/队列） | 大象 |
| 2025-11-27 | v1.0 | 初始版本，完成案件分配基础功能 | 大象 |

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

案件分配是CCO管理控台的核心功能之一，管理员需要能够灵活地将案件分配给合适的催员。当自动化分案策略无法满足特殊需求时，或者需要紧急调整案件分配时，管理员需要手动批量分配案件。支持批量选择案件、灵活筛选催员、平均分配案件，能够提高案件分配效率，确保案件及时分配给合适的催员处理。

**业务痛点**：
- 自动化分案策略无法覆盖所有场景，需要手动干预
- 紧急情况下需要快速调整案件分配
- 需要支持批量操作，提高分配效率
- 需要灵活选择催员，不受队列限制约束（可突破限制）
- 需要平均分配，确保催员工作量均衡

**预期影响的核心指标**：
- 案件分配效率：批量分配100个案件≤2分钟
- 分配准确率：案件分配成功率≥99%
- 用户满意度：管理员对案件分配功能满意度≥90%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：批量分配案件**
- **入口**：案件列表页面 → 批量选择案件 → 点击"批量分案"按钮
- **触发时机**：需要将多个案件分配给催员时
- **所在页面**：案件列表页面（分案弹窗）
- **流程节点**：选择案件 → 点击批量分案 → 筛选/搜索催员 → 选择催员 → 平均分案 → 确认分配

**场景2：突破队列限制分配**
- **入口**：分案弹窗 → 选择催员 → 点击平均分案
- **触发时机**：案件队列不属于催员所在小组的范围队列
- **所在页面**：分案弹窗 → 二次确认弹窗
- **流程节点**：检测到队列限制 → 弹窗确认 → 选择是否忽略限制 → 执行分配或返回修改

**场景3：筛选催员分配**
- **入口**：分案弹窗 → 筛选器
- **触发时机**：需要按机构、小组、队列属性筛选催员
- **所在页面**：分案弹窗
- **流程节点**：选择筛选条件 → 查看筛选结果 → 选择催员 → 分配

**场景4：搜索催员分配**
- **入口**：分案弹窗 → 搜索框
- **触发时机**：知道催员名或催员ID，需要快速定位
- **所在页面**：分案弹窗
- **流程节点**：输入搜索关键词 → 查看搜索结果 → 选择催员 → 分配

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 跨机构、跨队列分配案件 | 中 |
| 甲方管理员 | TenantAdmin | 本甲方案件分配，灵活调整 | 高 |
| 机构管理员 | AgencyAdmin | 本机构案件分配 | 高 |
| 小组管理员 | TeamLeader | 本小组案件分配 | 中 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 批量分案流程

```text
管理员在案件列表选择案件
    ↓
勾选多个案件（支持全选、反选）
    ↓
点击"批量分案"按钮
    ↓
打开分案弹窗
    ↓
加载催员列表（支持筛选和搜索）
    ↓
筛选/搜索催员
    ↓
多选催员（显示机构、小组、队列属性、今日持案量）
    ↓
点击"平均分案"按钮
    ↓
检查案件队列与催员队列是否匹配
    ↓
[匹配] → 直接执行分配
    ↓
[不匹配] → 弹窗二次确认
    ↓
[选择"是"] → 突破队列限制，执行分配
    ↓
[选择"否"] → 返回分案弹窗，等待修改
    ↓
分配成功，刷新案件列表
```

#### 3.2 队列限制检查流程

```text
点击"平均分案"按钮
    ↓
遍历选中的案件和催员
    ↓
检查每个案件的队列ID
    ↓
检查每个催员所在小组的队列ID
    ↓
判断案件队列是否在催员小组队列范围内
    ↓
[全部匹配] → 直接分配
    ↓
[存在不匹配] → 统计不匹配情况
    ↓
弹窗显示不匹配详情
    ↓
提示："案件队列不属于催员所在小组的范围队列，是否忽略队列限制？"
    ↓
[选择"是"] → 突破限制，执行分配
    ↓
[选择"否"] → 返回分案弹窗
```

#### 3.3 平均分配算法流程

```text
获取选中的案件列表（N个案件）
    ↓
获取选中的催员列表（M个催员）
    ↓
计算每个催员应分配的案件数：baseCount = N / M
    ↓
计算余数：remainder = N % M
    ↓
前remainder个催员分配 baseCount + 1 个案件
    ↓
剩余催员分配 baseCount 个案件
    ↓
随机打乱案件顺序（避免按固定顺序分配）
    ↓
按分配数量分配给每个催员
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 案件选择规则

**选择规则**：
- 支持单选：点击案件行的复选框
- 支持全选：点击表头复选框
- 支持反选：取消全选
- 支持跨页选择：切换页面时保留已选案件
- 最少选择1个案件，最多不限制

**选择限制**：
- 只能选择未结清的案件（待还款、部分还款）
- 已结清的案件不能选择（正常结清、展期结清）
- 已分配的案件可以重新分配

#### 4.2 催员筛选规则

**基础筛选条件**：
- **机构**：下拉选择，显示所有可用机构
- **小组**：下拉选择，依赖机构（选择机构后显示该机构的小组）
- **队列属性**：下拉选择，显示所有可用队列

**限制属性筛选条件**（用于精准匹配案件能力）：
- **所属系统**：下拉选择，显示所有催员/小组的所属系统限制值，筛选具备该系统处理能力的催员
- **当期天数**：下拉选择，显示所有催员/小组的当期天数限制值，筛选具备该天数处理能力的催员
- **产品**：下拉选择，显示所有催员/小组的产品限制值，筛选具备该产品处理能力的催员
- **APP**：下拉选择，显示所有催员/小组的APP限制值，筛选具备该APP处理能力的催员
- **商户**：下拉选择，显示所有催员/小组的商户限制值，筛选具备该商户处理能力的催员

**筛选说明**：
- 限制属性筛选器的选项值来源于所有催员/小组的限制配置聚合
- 如果催员/小组没有配置某项限制（值为空或"全部"），表示该催员可以处理所有该属性的案件
- 筛选时，只显示限制属性包含所选值或限制为空的催员

**筛选组合**：
- 支持多条件组合筛选（AND关系）
- 所有筛选条件都是可选的
- 筛选条件变更后自动刷新催员列表

#### 4.3 催员搜索规则

**搜索范围**：
- 催员名称（模糊匹配）
- 催员ID（精确匹配）

**搜索规则**：
- 支持单个关键词搜索
- 搜索关键词为空时不进行搜索
- 搜索与筛选条件可以组合使用（AND关系）

#### 4.4 催员选择规则

**选择规则**：
- 支持多选催员（复选框）
- 最少选择1个催员，最多不限制
- 催员列表显示信息：
  - 催员名称
  - 催员ID
  - 所属机构
  - 所属小组
  - 队列属性（队列名称）
  - **限制范围**（2列显示）：
    - 商户：显示催员/小组的商户限制，空值显示"全部"
    - APP：显示催员/小组的APP限制，空值显示"全部"
    - 产品：显示催员/小组的产品限制，空值显示"全部"
    - 队列：显示催员/小组的队列限制，空值显示"全部"
    - 所属系统：显示催员/小组的所属系统限制，空值显示"全部"
    - 当期天数：显示催员/小组的当期天数限制，空值显示"全部"
  - 今日持案量（当前已分配的案件数量）

**选择限制**：
- 只能选择启用状态的催员
- 已禁用的催员不显示在列表中

**显示说明**：
- 限制范围优先显示催员自身的限制配置
- 如果催员没有配置限制，则显示所属小组的限制配置
- 多个值用顿号（、）分隔，如：产品A、产品B、产品C
- 空值统一显示为"全部"，表示该催员可以处理所有该属性的案件

#### 4.5 平均分配规则

**分配算法**：
- 将选中的案件平均分配给选中的催员
- 如果案件数不能被催员数整除，前N个催员多分配1个案件（N = 案件数 % 催员数）
- 分配时随机打乱案件顺序，避免按固定顺序分配

**分配限制**：
- **不限制队列限制**：允许将案件分配给不同队列的催员
- 如果案件队列不属于催员所在小组的范围队列，需要二次确认

#### 4.6 案件与催员属性匹配规则

**匹配校验时机**：
- 用户点击"平均分案"按钮时，执行属性匹配校验
- 校验在前端执行，避免不匹配的分配请求发送到后端

**校验维度**：
1. **所属系统**：案件的 `system_name` 必须在催员/小组的 `allowed_systems` 范围内（或催员限制为空）
2. **当期天数**：案件的 `term_days` 必须在催员/小组的 `allowed_term_days` 范围内（或催员限制为空）
3. **产品**：案件的 `product_name` 必须在催员/小组的 `allowed_products` 范围内（或催员限制为空）
4. **APP**：案件的 `app_name` 必须在催员/小组的 `allowed_apps` 范围内（或催员限制为空）
5. **商户**：案件的 `merchant_name` 必须在催员/小组的 `allowed_merchants` 范围内（或催员限制为空）
6. **队列**：案件的 `queue_id` 必须在催员/小组的 `queue_id` 范围内（或催员限制为空）

**匹配判定逻辑**：
- **催员/小组限制为空或"全部"**：表示该催员可以处理所有该属性的案件，匹配通过
- **案件属性值在催员限制范围内**：匹配通过
- **案件属性值不在催员限制范围内**：匹配失败

**校验结果处理**：
- **全部匹配**：直接执行分配
- **存在不匹配**：阻止分配，显示错误提示（见9.1节错误提示文案）
- **不强制要求100%匹配**：管理员可以通过精准筛选后重新选择催员

**典型场景示例**：
- 案件A（产品：贷款A，APP：AppOne，商户：商户A，队列：M1）
- 催员1（限制：产品[贷款A, 贷款B]，APP[AppOne]，商户[商户A]，队列[M1]）→ 匹配
- 催员2（限制：产品[贷款C]，APP[AppTwo]，商户[商户B]，队列[M2]）→ 不匹配
- 催员3（限制：全部为空）→ 匹配

#### 4.7 队列限制规则（历史遗留，已整合到4.6）

**队列匹配规则**：
- 每个小组关联一个队列ID（`collection_teams.queue_id`）
- 每个案件关联一个队列ID（`cases.queue_id`）
- 如果案件队列ID = 催员所在小组的队列ID，则匹配
- 如果案件队列ID ≠ 催员所在小组的队列ID，则不匹配

**说明**：队列匹配已整合到4.6节的属性匹配规则中，此规则保留用于向后兼容

#### 4.8 权限规则

**分配权限**：
- SuperAdmin：可以分配所有案件给所有催员
- TenantAdmin：只能分配本甲方的案件给本甲方的催员
- AgencyAdmin：只能分配本机构的案件给本机构的催员
- TeamLeader：只能分配本小组的案件给本小组的催员

#### 4.9 范围边界

**本次需求范围内**：
- ✅ 批量选择案件
- ✅ 分案弹窗（筛选、搜索、多选催员）
- ✅ 平均分配算法
- ✅ 队列限制检查和二次确认
- ✅ 突破队列限制分配

**本次需求范围外**：
- ❌ 按金额分配（仅支持按数量平均分配）
- ❌ 按优先级分配（仅支持平均分配）
- ❌ 按催员能力分配（仅支持平均分配）
- ❌ 分配历史记录查询
- ❌ 分配撤销功能
- ❌ 分配通知功能

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据安全

**操作记录**：
- 记录案件分配操作日志
- 记录分配人、分配时间、分配的案件ID、分配的催员ID
- 记录是否突破队列限制

**权限控制**：
- 不同角色只能分配权限范围内的案件
- 分配操作需要Token验证

#### 5.2 数据一致性

**分配一致性**：
- 分配操作需要保证数据一致性（事务处理）
- 如果部分案件分配失败，需要回滚所有分配
- 分配成功后更新案件的`collector_id`、`team_id`、`agency_id`、`assigned_at`字段

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不涉及资金流**，本节不适用。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 案件分配请求字段

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| case_ids | Array<Long> | 案件ID列表 | 用户选择 |
| collector_ids | Array<Long> | 催员ID列表 | 用户选择 |
| ignore_queue_limit | Boolean | 是否忽略队列限制 | 用户确认 |

#### 7.2 催员列表字段

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| id | Long | 催员ID | 数据库 |
| collector_name | String | 催员名称 | 数据库 |
| collector_id | String | 催员编号 | 数据库 |
| agency_id | Long | 机构ID | 数据库 |
| agency_name | String | 机构名称 | 关联查询 |
| team_id | Long | 小组ID | 数据库 |
| team_name | String | 小组名称 | 关联查询 |
| queue_id | Long | 队列ID | 关联查询（小组的队列） |
| queue_name | String | 队列名称 | 关联查询 |
| current_case_count | Integer | 今日持案量 | 统计查询 |

#### 7.3 队列限制检查字段

| 字段名 | 类型 | 说明 | 来源 |
|--------|------|------|------|
| case_id | Long | 案件ID | 用户选择 |
| case_queue_id | Long | 案件队列ID | 案件表 |
| collector_id | Long | 催员ID | 用户选择 |
| collector_team_queue_id | Long | 催员小组队列ID | 小组表 |
| is_match | Boolean | 是否匹配 | 计算得出 |

#### 7.4 统计口径

- **今日持案量**：催员当前已分配且未结清的案件数量（按自然日统计）
- **分配成功率**：成功分配的案件数 / 总分配案件数（按自然日统计）

---

### 8. 交互与信息展示（UX & UI Brief）

**前端交互已实现**，主要界面元素：

**案件列表页面**：
- 案件表格支持复选框选择
- 表头支持全选/取消全选
- 批量操作工具栏：显示已选案件数量、"批量分案"按钮

**分案弹窗**：
- 弹窗标题："批量分案"
- 显示已选案件数量："已选择 X 个案件"
- **筛选器区域**（第一行）：
  - 机构下拉选择框（宽度180px）
  - 小组下拉选择框（宽度180px，依赖机构）
  - 队列属性下拉选择框（宽度180px）
  - 搜索框（宽度200px）：支持搜索催员名、催员ID
- **限制属性筛选器**（第二行，用于精准匹配案件能力）：
  - 所属系统下拉选择框（宽度150px）：可选值从所有催员/小组的系统限制聚合
  - 当期天数下拉选择框（宽度150px）：可选值从所有催员/小组的天数限制聚合
  - 产品下拉选择框（宽度150px）：可选值从所有催员/小组的产品限制聚合
  - APP下拉选择框（宽度150px）：可选值从所有催员/小组的APP限制聚合
  - 商户下拉选择框（宽度150px）：可选值从所有催员/小组的商户限制聚合
- **催员列表表格**：
  - 复选框列（宽度55px，支持多选）
  - 催员名称（宽度120px）
  - 催员ID（宽度100px）
  - 所属机构（宽度120px）
  - 所属小组（宽度120px）
  - 队列属性（宽度100px）
  - **限制范围**（最小宽度260px，2列网格布局）：
    - 商户：xxx、xxx
    - APP：xxx、xxx
    - 产品：xxx、xxx
    - 队列：xxx
    - （注：空值显示"全部"）
  - 今日持案量（宽度100px，右对齐）
- **操作按钮**：
  - "取消"按钮：关闭弹窗
  - "平均分案"按钮：执行分配（选中催员数为0时禁用）

**队列限制确认弹窗**：
- 弹窗标题："队列限制确认"
- 提示内容："案件队列不属于催员所在小组的范围队列，是否忽略队列限制？"
- 显示不匹配详情（可选）：
  - 案件编号：XXX，队列：YYY
  - 催员：ZZZ，小组队列：AAA
- 操作按钮：
  - "否"按钮：返回分案弹窗
  - "是"按钮：突破限制，执行分配

**分配结果提示**：
- 分配成功：显示"成功分配 X 个案件给 Y 个催员"
- 分配失败：显示错误信息

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 分配配置

**配置项**：
- 是否启用队列限制检查（默认：启用）
- 是否允许突破队列限制（默认：允许，但需要二次确认）

#### 9.2 权限配置

**配置入口**：权限配置页面

**配置项**：
- 各角色的案件分配权限范围
- 是否允许突破队列限制的权限

---

### 10. 错误提示与文案规范（Error Messages & Copy）

#### 10.1 操作前校验提示

| 场景 | 提示类型 | 文案内容 | 触发条件 |
|------|---------|---------|---------|
| 未选择案件 | Warning | 请先选择案件 | 点击"批量分案"按钮时，未选择任何案件 |
| 未选择催员 | Warning | 请至少选择一个催员 | 点击"平均分案"按钮时，未选择任何催员 |
| 案件与催员属性不匹配 | Error | 您的案件属性和催员属性不匹配，请精准筛选案件和催员后，再批量分配 | 点击"平均分案"按钮时，检测到案件属性与催员限制不匹配 |

#### 10.2 数据加载失败提示

| 场景 | 提示类型 | 文案内容 | 触发条件 |
|------|---------|---------|---------|
| 加载机构列表失败 | Error | 加载机构列表失败 | 调用机构列表接口失败 |
| 加载小组列表失败 | Error | 加载小组列表失败 | 调用小组列表接口失败 |
| 加载队列列表失败 | Error | 加载队列列表失败 | 调用队列列表接口失败 |
| 获取催员列表失败 | Error | 获取催员列表失败 | 调用催员列表接口失败 |

#### 10.3 分配操作提示

| 场景 | 提示类型 | 文案内容 | 触发条件 |
|------|---------|---------|---------|
| 检查队列限制失败 | Error | 检查队列限制失败 | 调用队列限制检查接口失败 |
| 批量分配失败 | Error | 批量分配失败 | 调用批量分配接口失败 |
| 分配成功 | Success | 成功分配 X 个案件给 Y 个催员 | 批量分配接口返回成功 |
| 分配失败（无成功案件） | Error | 分配失败 | 批量分配接口返回成功数为0 |

#### 10.4 属性匹配校验详细说明

**不匹配检测逻辑**：
- 遍历所有已选案件和已选催员，检查以下属性是否匹配：
  1. 所属系统（system_name）
  2. 当期天数（term_days）
  3. 产品（product_name）
  4. APP（app_name）
  5. 商户（merchant_name）
  6. 队列（queue_id）

**匹配规则**：
- 催员/小组限制为空或"全部"：视为匹配
- 案件属性值在催员/小组限制值范围内：视为匹配
- 案件属性值不在催员/小组限制值范围内：视为不匹配

**提示时机**：
- 点击"平均分案"按钮时立即执行前端校验
- 发现任何不匹配项，立即阻止提交并显示错误提示
- 用户需要通过筛选器或重新选择案件/催员来解决不匹配问题

**示例场景**：
```text
案件列表：
- 案件A：产品=贷款A，APP=AppOne，商户=商户A，队列=M1
- 案件B：产品=贷款B，APP=AppTwo，商户=商户B，队列=M2

催员列表（已选）：
- 催员1：限制[产品=贷款A，APP=AppOne，商户=商户A，队列=M1] → 只匹配案件A
- 催员2：限制[产品=全部，APP=全部，商户=全部，队列=全部] → 匹配所有案件

结果：存在不匹配（案件B不匹配催员1），显示错误提示
```

#### 10.5 队列限制确认弹窗（历史功能，保留向后兼容）

| 场景 | 提示类型 | 文案内容 | 触发条件 |
|------|---------|---------|---------|
| 队列限制二次确认 | Confirm | 案件队列不属于催员所在小组的范围队列，是否忽略队列限制？ | 检测到案件队列与催员小组队列不匹配 |

**说明**：此功能已整合到10.4的属性匹配校验中，但保留原有队列限制确认逻辑用于向后兼容。

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 用户点击批量分案按钮 | 批量分案按钮点击 | click_batch_assign | userId, selectedCaseCount |
| 用户打开分案弹窗 | 分案弹窗打开 | dialog_open_assign | userId, selectedCaseCount |
| 用户筛选催员 | 催员筛选 | filter_collector | userId, filterConditions |
| 用户搜索催员 | 催员搜索 | search_collector | userId, searchKeyword |
| 用户选择催员 | 催员选择 | select_collector | userId, collectorIds |
| 用户点击平均分案 | 平均分案按钮点击 | click_average_assign | userId, caseCount, collectorCount |
| 队列限制确认弹窗显示 | 队列限制确认弹窗 | dialog_queue_limit_confirm | userId, unmatchedCount |
| 用户选择忽略队列限制 | 忽略队列限制 | ignore_queue_limit | userId, caseCount |
| 用户选择不忽略队列限制 | 不忽略队列限制 | not_ignore_queue_limit | userId |
| 案件分配成功 | 案件分配成功 | case_assign_success | userId, caseCount, collectorCount, ignoreLimit |
| 案件分配失败 | 案件分配失败 | case_assign_failure | userId, errorCode, errorMessage |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 架构图

```text
┌─────────────────┐
│   前端 (Vue3)   │
│  CaseList.vue   │
│  分案弹窗组件    │
└────────┬────────┘
         │ HTTP/HTTPS
         │ POST /api/v1/cases/batch-assign
         ↓
┌─────────────────┐
│  Java后端        │
│  CaseController │
└────────┬────────┘
         │
         ├──→ CaseService (案件服务)
         ├──→ CaseMapper (数据访问)
         ├──→ CollectorService (催员服务)
         └──→ TeamService (小组服务)
```

#### 1.2 模块职责

**前端模块**：
- `CaseList.vue`：案件列表页面，包含批量选择和分案入口
- `BatchAssignDialog.vue`：分案弹窗组件（待实现）
- `QueueLimitConfirmDialog.vue`：队列限制确认弹窗组件（待实现）

**后端模块**：
- `CaseController`：案件控制器，处理批量分配接口
- `CaseService`：案件服务，业务逻辑处理
- `CaseMapper`：案件数据访问层
- `CollectorService`：催员服务，查询催员信息
- `TeamService`：小组服务，查询小组和队列信息

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 批量分配案件接口

**接口路径**：`POST /api/v1/cases/batch-assign`

**请求参数**：
```json
{
  "case_ids": [1, 2, 3],
  "collector_ids": [10, 11, 12],
  "ignore_queue_limit": false
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| case_ids | Array<Long> | 是 | 案件ID列表 |
| collector_ids | Array<Long> | 是 | 催员ID列表 |
| ignore_queue_limit | Boolean | 否 | 是否忽略队列限制（默认false） |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success_count": 100,
    "failure_count": 0,
    "assignments": [
      {
        "case_id": 1,
        "collector_id": 10,
        "status": "success"
      }
    ]
  }
}
```

**错误响应**：
- 400：参数错误（案件ID或催员ID为空）
- 403：无权限分配
- 500：服务器内部错误

**超时与重试**：
- 超时时间：30秒（批量操作可能较慢）
- 重试策略：不重试（用户可手动重试）

**幂等性**：不支持幂等（重复分配会覆盖之前的分配）

**失败降级**：分配失败返回错误信息，部分成功时返回成功和失败的详情

#### 2.2 获取催员列表接口（用于分案弹窗）

**接口路径**：`GET /api/v1/organization/collectors`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| agency_id | Long | 否 | 机构ID |
| team_id | Long | 否 | 小组ID |
| queue_id | Long | 否 | 队列ID |
| search_keyword | String | 否 | 搜索关键词（催员名或ID） |
| include_case_count | Boolean | 否 | 是否包含今日持案量（默认true） |

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 10,
      "collector_name": "张三",
      "collector_id": "C001",
      "agency_id": 1,
      "agency_name": "机构1",
      "team_id": 5,
      "team_name": "小组1",
      "queue_id": 2,
      "queue_name": "M1队列",
      "current_case_count": 50,
      "status": "active"
    }
  ]
}
```

#### 2.3 检查队列限制接口

**接口路径**：`POST /api/v1/cases/check-queue-limit`

**请求参数**：
```json
{
  "case_ids": [1, 2, 3],
  "collector_ids": [10, 11, 12]
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "has_limit": true,
    "unmatched_items": [
      {
        "case_id": 1,
        "case_code": "CASE001",
        "case_queue_id": 1,
        "case_queue_name": "M1队列",
        "collector_id": 10,
        "collector_name": "张三",
        "collector_team_queue_id": 2,
        "collector_team_queue_name": "M2队列"
      }
    ]
  }
}
```

**说明**：此接口用于在分配前检查队列限制，前端可以根据检查结果决定是否显示确认弹窗。

#### 2.4 系统依赖

**内部依赖**：
- 案件服务
- 催员服务
- 小组服务
- 队列服务

**外部依赖**：
- 甲方接口（如果需要通知甲方案件分配结果，待实现）

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 数据存储

**案件表（cases）**：
- 需要更新的字段：
  - `collector_id`：分配的催员ID
  - `team_id`：催员所在小组ID
  - `agency_id`：催员所在机构ID
  - `assigned_at`：分配时间

**分配日志表（case_assignments，待实现）**：
```sql
CREATE TABLE IF NOT EXISTS `case_assignments` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `case_id` BIGINT NOT NULL COMMENT '案件ID',
  `collector_id` BIGINT NOT NULL COMMENT '催员ID',
  `assigned_by` BIGINT NOT NULL COMMENT '分配人ID',
  `assigned_at` DATETIME NOT NULL COMMENT '分配时间',
  `ignore_queue_limit` TINYINT(1) DEFAULT 0 COMMENT '是否忽略队列限制',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_case_id` (`case_id`),
  KEY `idx_collector_id` (`collector_id`),
  KEY `idx_assigned_at` (`assigned_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案件分配记录表';
```

#### 3.2 查询优化

**催员列表查询优化**：
- 使用索引加速筛选条件查询
- 今日持案量使用聚合查询，避免N+1查询

**队列限制检查优化**：
- 批量查询案件队列信息
- 批量查询催员小组队列信息
- 使用JOIN查询减少数据库访问次数

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **QPS**：批量分配接口支持50 QPS
- **响应时间**：
  - 批量分配100个案件：≤5秒（P95）
  - 催员列表查询：≤1秒（P95）
  - 队列限制检查：≤2秒（P95）
- **峰值容量**：支持500个案件批量分配

#### 4.2 可用性要求

- **SLA**：99.9%可用性
- **降级策略**：
  - 批量分配失败时，返回部分成功结果
  - 队列限制检查失败时，允许用户手动选择是否忽略限制
- **容灾**：支持多机房部署（待实现）

#### 4.3 安全要求

**接口安全**：
- 所有接口需要Token验证
- 接口需要HTTPS传输
- 防止SQL注入攻击

**权限控制**：
- 不同角色只能分配权限范围内的案件
- 分配操作需要记录操作日志

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

| 日志类型 | 日志内容 | 日志级别 |
|---------|---------|---------|
| 批量分配请求 | 案件ID列表、催员ID列表、是否忽略队列限制 | INFO |
| 队列限制检查 | 不匹配的案件和催员详情 | WARN |
| 批量分配成功 | 成功分配的案件数量、催员数量 | INFO |
| 批量分配失败 | 错误信息、异常堆栈 | ERROR |

**日志格式示例**：
```text
[2025-11-27 10:00:00] INFO  [CaseController] ========== 批量分配案件，case_ids=[1,2,3], collector_ids=[10,11,12], ignore_queue_limit=false ==========
[2025-11-27 10:00:01] WARN  [CaseService] 队列限制检查：案件CASE001（队列M1）与催员张三（小组队列M2）不匹配
[2025-11-27 10:00:02] INFO  [CaseController] ========== 批量分配成功，成功=100, 失败=0 ==========
```

#### 5.2 监控指标

| 指标名称 | 指标类型 | 告警阈值 | 说明 |
|---------|---------|---------|------|
| 批量分配成功率 | 百分比 | <95% | 分配成功次数/总分配次数 |
| 批量分配响应时间 | 毫秒 | P95 >10000ms | 分配接口响应时间 |
| 队列限制突破率 | 百分比 | >50% | 突破队列限制的分配次数/总分配次数 |
| 平均分配均衡度 | 数值 | 标准差>10 | 每个催员分配案件数的标准差 |

#### 5.3 告警规则

- **批量分配成功率低于95%**：发送告警通知
- **批量分配响应时间P95超过10秒**：发送告警通知
- **队列限制突破率超过50%**：发送告警通知（可能配置有问题）

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 平均分配算法测试
- 队列限制检查逻辑测试
- 案件选择验证测试

**集成测试**：
- 批量分配接口完整流程测试
- 队列限制检查接口测试
- 催员列表查询接口测试

**功能测试**：
- 批量选择案件测试
- 分案弹窗筛选测试
- 分案弹窗搜索测试
- 多选催员测试
- 平均分配测试
- 队列限制检查测试
- 突破队列限制测试
- 权限控制测试

**性能测试**：
- 批量分配压力测试（500个案件）
- 催员列表查询性能测试
- 队列限制检查性能测试

**边界测试**：
- 选择1个案件分配给1个催员
- 选择100个案件分配给1个催员
- 选择1个案件分配给100个催员
- 选择0个案件（不允许）
- 选择0个催员（不允许）

#### 6.2 验收标准

1. **功能完整性**：
   - ✅ 支持批量选择案件
   - ✅ 分案弹窗筛选功能正常
   - ✅ 分案弹窗搜索功能正常
   - ✅ 多选催员功能正常
   - ✅ 平均分配算法正确
   - ✅ 队列限制检查功能正常
   - ✅ 突破队列限制功能正常

2. **性能指标**：
   - ✅ 批量分配100个案件响应时间≤5秒（P95）
   - ✅ 催员列表查询响应时间≤1秒（P95）

3. **数据准确性**：
   - ✅ 分配结果准确（案件正确分配给催员）
   - ✅ 平均分配均衡（案件数差异≤1）
   - ✅ 队列限制检查准确

4. **用户体验**：
   - ✅ 操作流程顺畅，无卡顿
   - ✅ 错误提示清晰明确
   - ✅ 二次确认提示清晰

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**发布方式**：全量发布（当前版本）

**发布步骤**：
1. 部署后端服务（批量分配接口、队列限制检查接口）
2. 部署前端静态资源（分案弹窗组件）
3. 验证批量分配功能正常
4. 验证队列限制检查功能正常
5. 监控系统指标

**灰度发布**（未来规划）：
- 支持按甲方灰度发布
- 支持按用户角色灰度发布
- 灰度比例：10% → 50% → 100%

#### 7.2 配置切换

**队列限制开关切换**：
- 在系统配置中修改队列限制检查开关
- 配置立即生效

#### 7.3 回滚方案

**回滚条件**：
- 批量分配成功率低于90%
- 批量分配响应时间P95超过15秒
- 出现严重功能缺陷

**回滚步骤**：
1. 停止新版本服务
2. 回滚到上一个稳定版本
3. 验证功能正常
4. 通知相关人员

**回滚时间**：≤5分钟

#### 7.4 应急联系人

- **技术负责人**：待指定
- **运维负责人**：待指定
- **产品负责人**：待指定

---

## 附录

### A. 相关文档

- [CCO系统功能设计.xlsx](../CCO%20系统功能设计.xlsx) - 控台功能点sheet，行29
- [案件列表功能PRD](./1.2%20案件列表功能PRD.md)
- [后端API文档](../../接口/1-管理控台API文档.md)
