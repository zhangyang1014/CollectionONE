# 停留案件管理PRD

## 一、产品需求(Product Requirements)

### 1. 项目背景与目标(Background & Goals)

催收业务中,某些案件因特殊原因需要暂停催收,例如客户提出异议、客户住院、客户失联、法律纠纷等情况。本需求旨在建立**案件停留管理机制**,实现案件的临时冻结和管理,保护客户权益的同时规范催收流程。通过完善的停留管理,预期实现:
- **合规性提升**:规范处理特殊案件,降低投诉率和法律风险
- **管理效率提升**:集中管理停留案件,避免催员误操作
- **客户体验优化**:对特殊情况客户给予合理宽限期
- **流程透明化**:记录停留原因和时间,便于追溯和审计

### 2. 业务场景与用户画像(Business Scenario & User)

**主要使用场景:**

1. **手动标记案件停留**
   - **场景**:案件需要暂停催收处理
   - **入口**:案件列表 → 多选案件 → 标记停留
   - **操作**:管理员勾选多个案件,点击"标记停留"按钮,确认后案件进入停留状态
   - **频率**:每日多次(约5-20次/日)
   - **常见停留原因**:客户异议、客户住院、客户失联、法律纠纷、还款承诺中、系统维护

2. **查看停留案件列表**
   - **场景**:查询和管理所有停留状态的案件
   - **入口**:案件管理 → 停留案件
   - **操作**:查看停留案件列表,支持筛选(队列、停留时间、停留操作人)和搜索
   - **频率**:每日多次(约10-30次/日)

3. **批量解放停留案件**
   - **场景**:停留原因消除,案件需要恢复正常催收
   - **入口**:停留案件列表 → 多选案件 → 批量解放停留
   - **操作**:勾选多个停留案件,点击"批量解放停留"按钮,确认后案件解除停留状态
   - **频率**:每日数次(约3-15次/日)

4. **查看案件停留历史**
   - **场景**:了解案件的停留和解放历史记录
   - **入口**:案件详情 → 停留历史
   - **操作**:查看案件的所有停留记录(停留时间、停留操作人、解放时间、解放操作人)
   - **频率**:按需查看

**用户画像:**

| 用户类型 | 核心诉求 | 使用功能 | 使用频率 |
|---------|---------|---------|---------|
| **分案专员** | 快速标记和解放停留案件 | 批量标记停留、批量解放停留 | 高频(10-30次/日) |
| **客服经理** | 处理客户异议和投诉 | 手动标记停留、查看停留列表 | 中频(5-15次/日) |
| **催收主管** | 监控停留案件情况 | 查看停留列表、筛选统计 | 中频(3-10次/日) |
| **合规审计** | 审计停留操作合规性 | 查看停留历史、导出停留记录 | 低频(1-3次/周) |

### 3. 关键业务流程(Business Flow)

#### 3.1 手动标记案件停留流程

```
开始
  ↓
[分案专员] 案件列表勾选案件
  ↓
[分案专员] 点击"标记停留"按钮
  ↓
[系统] 弹出确认对话框
  ├─ 显示将要停留的案件数量
  ├─ 提示:停留后案件从催员侧收回
  └─ 提示:管理端不可再分案
  ↓
[分案专员] 确认标记停留
  ↓
[系统] 执行批量标记停留
  ├─ 检查案件状态(已结清不可停留)
  ├─ 检查幂等性(已停留跳过)
  ├─ 更新案件is_stay=true
  ├─ 记录stay_at=当前时间
  ├─ 记录stay_by=操作人ID
  └─ 清除催员分配(collector_id=null)
  ↓
[系统] 返回操作结果
  ├─ 成功数量
  ├─ 失败数量
  └─ 失败详情
  ↓
[系统] 刷新案件列表(停留案件从列表中移除)
  ↓
结束
```

#### 3.2 批量解放停留案件流程

```
开始
  ↓
[分案专员] 停留案件列表勾选案件
  ↓
[分案专员] 点击"批量解放停留"按钮
  ↓
[系统] 弹出确认对话框
  ├─ 显示将要解放的案件数量
  └─ 提示:解放后案件可重新分配
  ↓
[分案专员] 确认解放停留
  ↓
[系统] 执行批量解放停留
  ├─ 检查案件是否停留(非停留不可解放)
  ├─ 更新案件is_stay=false
  ├─ 记录stay_released_at=当前时间
  ├─ 记录stay_released_by=操作人ID
  └─ 清空stay_at和stay_by字段
  ↓
[系统] 返回操作结果
  ├─ 成功数量
  ├─ 失败数量
  └─ 失败详情
  ↓
[系统] 刷新停留案件列表(已解放案件从列表移除)
  ↓
结束
```

### 4. 业务规则与边界(Business Rules & Scope)

#### 4.1 停留案件规则

**可停留的案件:**
- ✅ 案件状态为"待还款"
- ✅ 案件状态为"部分还款"
- ✅ 已分配给催员的案件
- ✅ 未分配催员的案件

**不可停留的案件:**
- ❌ 案件状态为"正常结清"
- ❌ 案件状态为"展期结清"
- ❌ 已经是停留状态的案件(幂等性处理,不报错)

**停留后的状态变更:**
- `is_stay` → `true`(停留标识)
- `stay_at` → 当前时间(停留时间)
- `stay_by` → 操作人ID(停留操作人)
- `collector_id` → `NULL`(清除催员分配)
- `team_id` → `NULL`(清除小组分配)
- `agency_id` → `NULL`(清除机构分配)
- `case_status` → 保持不变(停留不改变案件本身状态)

#### 4.2 解放停留规则

**可解放的案件:**
- ✅ 当前is_stay=true的案件

**不可解放的案件:**
- ❌ 当前is_stay=false的案件

**解放后的状态变更:**
- `is_stay` → `false`(取消停留标识)
- `stay_at` → `NULL`(清空停留时间)
- `stay_by` → `NULL`(清空停留操作人)
- `stay_released_at` → 当前时间(解放停留时间)
- `stay_released_by` → 操作人ID(解放操作人)
- 注意:解放后**不自动分配催员**,需要手动重新分案

#### 4.3 停留案件显示规则

**在案件列表中:**
- 停留案件**不显示**在普通案件列表中(默认筛选 is_stay=false)
- 提供"包含停留案件"筛选选项(可选)
- 如果显示停留案件,需要特殊标识(如图标、颜色)

**在停留案件列表中:**
- 仅显示is_stay=true的案件
- 支持按队列、停留时间、停留操作人筛选
- 支持搜索案件编号、客户姓名、客户ID、手机号

#### 4.4 权限控制

**标记停留权限:**
- 系统管理员:✅
- 分案专员:✅
- 客服经理:✅
- 普通催员:❌

**解放停留权限:**
- 系统管理员:✅
- 分案专员:✅
- 客服经理:✅
- 普通催员:❌

#### 4.5 本次需求范围

**范围内(In Scope):**
- ✅ 手动批量标记案件停留
- ✅ 批量解放停留案件
- ✅ 停留案件列表查询
- ✅ 停留案件筛选和搜索
- ✅ 停留状态字段存储
- ✅ 停留操作记录(操作人、操作时间)

**范围外(Out of Scope):**
- ❌ 停留原因选择和记录(后续迭代)
- ❌ 自动停留规则配置(后续迭代)
- ❌ 停留期限设置和自动解放(后续迭代)
- ❌ 停留案件提醒通知(后续迭代)
- ❌ 停留案件统计报表(后续迭代)
- ❌ 停留审批工作流(后续迭代)

### 5. 合规与风控要求(Compliance & Risk Control)

#### 5.1 合规要求

**催收合规:**
- **停留即停催**:停留状态案件不得进行任何催收操作
- **操作留痕**:记录所有停留和解放操作的人、时间
- **客户权益保护**:停留期间逾期天数正常增长,但不进行催收
- **合理期限**:建议定期审查长期停留案件(如>30天)

**数据合规:**
- **数据隔离**:不同甲方的停留案件完全隔离
- **隐私保护**:停留案件列表仅显示有权限的用户可见字段
- **审计日志**:所有停留操作记录日志,保留至少6个月

#### 5.2 风控要求

**业务风控:**
- **停留率监控**:警告停留案件占比过高(>10%)的情况
- **长期停留预警**:提醒停留超过30天的案件
- **批量操作限制**:单次批量标记停留上限1000个案件
- **恶意停留检测**:监控频繁标记和解放同一案件的操作

**系统风控:**
- **并发控制**:停留操作时加锁,避免并发冲突
- **事务完整性**:停留操作作为一个事务执行
- **幂等性保证**:重复标记停留不报错,仅计入成功数

### 6. 数据字段与口径(Data Definition)

#### 6.1 核心数据字段

**案件表(cases)停留相关字段**

| 字段名 | 数据类型 | 必填 | 说明 | 示例值 |
|-------|---------|-----|------|--------|
| is_stay | TINYINT(1) | ✅ | 是否停留(独立于case_status) | 0/1 |
| stay_at | DATETIME | ⬜ | 停留时间 | "2025-12-05 10:00:00" |
| stay_by | BIGINT | ⬜ | 停留操作人ID | 1001 |
| stay_released_at | DATETIME | ⬜ | 解放停留时间 | "2025-12-10 15:30:00" |
| stay_released_by | BIGINT | ⬜ | 解放停留操作人ID | 1002 |

**说明:**
- `is_stay`默认值为0(false)
- 停留时,`stay_at`和`stay_by`必须设置
- 解放停留时,`stay_released_at`和`stay_released_by`必须设置,`stay_at`和`stay_by`清空为NULL

#### 6.2 统计口径

**停留案件数统计:**
- **口径**:统计is_stay=true 且 case_status != 'normal_settlement' 且 case_status != 'extension_settlement'的案件数
- **更新频率**:实时(查询时计算)
- **统计维度**:甲方维度、队列维度、时间维度

**停留率统计:**
- **口径**:(停留案件数 / 总案件数) × 100%
- **更新频率**:T+1(每日凌晨统计)
- **统计维度**:甲方+日期

**平均停留天数统计:**
- **口径**:已解放案件的平均停留天数(stay_released_at - stay_at)
- **更新频率**:T+1(每日凌晨统计)
- **统计维度**:甲方+月份

### 7. 交互与信息展示(UX & UI Brief)

#### 7.1 案件列表页-停留操作

**新增批量操作按钮:**
- 位置:批量操作工具栏(已选择案件时显示)
- 按钮文案:"标记停留"
- 按钮图标:Lock图标
- 按钮类型:warning(黄色)
- 按钮位置:在"批量分案"按钮之后

**确认对话框:**
```
标题:标记停留确认
内容:确定要将选中的 X 个案件标记为停留吗?
     停留后案件将从催员侧收回,管理端不可再分案。
按钮:[取消] [确认]
```

**操作结果提示:**
- 全部成功:"成功标记X个案件为停留状态"(绿色提示)
- 部分失败:"成功X个,失败Y个"(黄色警告)
- 全部失败:显示失败原因(红色错误)

#### 7.2 停留案件列表页

**页面入口:**案件管理 → 停留案件

**核心元素:**
- 页面标题:"停留案件"
- 筛选器:案件队列、停留时间范围、停留操作人
- 搜索框:支持搜索案件编号、客户姓名、客户ID、手机号码
- 批量操作:"批量解放停留"按钮
- 案件列表表格:与案件列表相同的字段配置,额外显示"停留时间"和"停留操作人"

**筛选器布局:**
```
[案件队列▼] [停留时间:开始~结束] [停留操作人▼] [查询] [重置]
```

**批量解放停留确认对话框:**
```
标题:批量解放停留确认
内容:确定要解放选中的 X 个案件的停留状态吗?
     解放后案件可重新分配给催员。
按钮:[取消] [确认]
```

#### 7.3 案件详情页-停留历史

**显示位置:**案件详情页的独立Tab页或折叠面板

**内容:**
| 停留时间 | 停留操作人 | 解放时间 | 解放操作人 | 停留时长 |
|---------|-----------|---------|-----------|---------|
| 2025-12-01 10:00 | 张三 | 2025-12-05 15:00 | 李四 | 4天5小时 |
| 2025-11-15 09:00 | 王五 | 2025-11-20 18:00 | 赵六 | 5天9小时 |

### 8. 配置项与运营开关(Config & Operation Switches)

#### 8.1 系统配置项

| 配置项 | 默认值 | 说明 | 配置入口 | 变更流程 |
|-------|-------|------|---------|---------|
| max_batch_stay_count | 1000 | 单次批量停留上限 | 系统配置管理 | 需开发变更 |
| stay_warning_days | 30 | 停留天数警告阈值 | 系统配置管理 | 运营可配置 |
| stay_rate_warning_threshold | 0.1 | 停留率警告阈值(10%) | 系统配置管理 | 运营可配置 |

#### 8.2 运营开关

| 开关名称 | 默认状态 | 说明 | 配置入口 | 影响范围 |
|---------|---------|------|---------|---------|
| 允许批量停留 | 开启 | 是否允许批量标记停留 | 系统配置 | 全局 |
| 停留天数预警 | 开启 | 是否启用长期停留预警 | 系统配置 | 全局 |
| 停留率监控 | 开启 | 是否启用停留率监控 | 系统配置 | 全局 |

---

## 二、技术部分描述(Technical Requirements / TRD)

### 1. 系统架构与模块划分(System Architecture & Modules)

#### 1.1 模块职责

**前端模块:**
- `CaseList.vue`:案件列表页面,新增"标记停留"批量操作按钮
- `StayCaseList.vue`:停留案件列表页面,展示和管理停留案件
- `CaseDetail.vue`:案件详情页面,展示停留历史(可选)

**后端模块:**
- `CaseController`:案件控制器,新增停留相关接口
  - `POST /api/v1/cases/batch-stay`:批量标记停留
  - `POST /api/v1/cases/batch-release-stay`:批量解放停留
  - `GET /api/v1/cases/stay`:获取停留案件列表
- `CaseService`:案件服务,实现停留业务逻辑
  - `batchStayCases()`:批量标记停留
  - `batchReleaseStayCases()`:批量解放停留
  - `getStayCaseList()`:查询停留案件列表

**数据库模块:**
- `cases`表:新增停留相关字段

### 2. 接口设计(API Design)

#### 2.1 批量标记案件停留

```
POST /api/v1/cases/batch-stay
```

**请求体:**
```json
{
  "case_ids": [1001, 1002, 1003]
}
```

**响应示例(成功):**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success_count": 3,
    "failure_count": 0,
    "failures": []
  }
}
```

**响应示例(部分失败):**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success_count": 2,
    "failure_count": 1,
    "failures": [
      {
        "case_id": 1003,
        "error_message": "已结清的案件不能标记为停留"
      }
    ]
  }
}
```

#### 2.2 批量解放停留案件

```
POST /api/v1/cases/batch-release-stay
```

**请求体:**
```json
{
  "case_ids": [1001, 1002, 1003]
}
```

**响应示例:**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "success_count": 3,
    "failure_count": 0,
    "failures": []
  }
}
```

#### 2.3 获取停留案件列表

```
GET /api/v1/cases/stay?tenant_id={tenant_id}&queue_id={queue_id}&stay_date_start={start}&stay_date_end={end}&stay_by={user_id}&search_keyword={keyword}&skip={skip}&limit={limit}
```

**请求参数:**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tenant_id | Long | 是 | 甲方ID |
| queue_id | Long | 否 | 队列ID筛选 |
| agency_id | Long | 否 | 机构ID筛选 |
| team_id | Long | 否 | 小组ID筛选 |
| stay_by | Long | 否 | 停留操作人ID |
| stay_date_start | String | 否 | 停留开始日期(YYYY-MM-DD) |
| stay_date_end | String | 否 | 停留结束日期(YYYY-MM-DD) |
| search_keyword | String | 否 | 搜索关键词 |
| sort_by | String | 否 | 排序字段 |
| skip | Integer | 否 | 跳过数量(默认0) |
| limit | Integer | 否 | 限制数量(默认20) |

**响应示例:**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "items": [
      {
        "id": 1001,
        "case_code": "CASE20250101001",
        "user_name": "张三",
        "loan_amount": 10000.00,
        "outstanding_amount": 5000.00,
        "overdue_days": 15,
        "case_status": "待还款",
        "is_stay": true,
        "stay_at": "2025-12-01T10:00:00",
        "stay_by": 1,
        "stay_by_name": "管理员"
      }
    ],
    "total": 50,
    "skip": 0,
    "limit": 20
  }
}
```

### 3. 数据库设计(Database Design)

#### 3.1 数据库表变更

**cases表-新增字段:**

```sql
-- 停留相关字段
ALTER TABLE `cases` 
ADD COLUMN `is_stay` TINYINT(1) DEFAULT 0 COMMENT '是否停留（独立状态字段，与case_status分离）' AFTER `next_follow_up_at`,
ADD COLUMN `stay_at` DATETIME NULL COMMENT '停留时间' AFTER `is_stay`,
ADD COLUMN `stay_by` BIGINT NULL COMMENT '停留操作人ID' AFTER `stay_at`,
ADD COLUMN `stay_released_at` DATETIME NULL COMMENT '解放停留时间' AFTER `stay_by`,
ADD COLUMN `stay_released_by` BIGINT NULL COMMENT '解放停留操作人ID' AFTER `stay_released_at`;

-- 新增索引
ALTER TABLE `cases` ADD KEY `idx_is_stay` (`is_stay`);
ALTER TABLE `cases` ADD KEY `idx_stay_at` (`stay_at`);
ALTER TABLE `cases` ADD KEY `idx_stay_by` (`stay_by`);
```

### 4. 业务逻辑实现(Business Logic)

#### 4.1 批量标记停留逻辑

```java
public BatchStayResponse batchStayCases(BatchStayRequest request, Long operatorId) {
    // 1. 参数验证
    // 2. 遍历案件ID
    for (Long caseId : request.getCaseIds()) {
        // 2.1 查询案件
        // 2.2 检查案件状态(已结清不可停留)
        // 2.3 检查幂等性(已停留跳过,计入成功)
        // 2.4 更新案件
        //     - is_stay = true
        //     - stay_at = now
        //     - stay_by = operatorId
        //     - collector_id = null
        //     - team_id = null
        //     - agency_id = null
        // 2.5 记录成功/失败
    }
    // 3. 返回结果
}
```

#### 4.2 批量解放停留逻辑

```java
public BatchReleaseStayResponse batchReleaseStayCases(BatchReleaseStayRequest request, Long operatorId) {
    // 1. 参数验证
    // 2. 遍历案件ID
    for (Long caseId : request.getCaseIds()) {
        // 2.1 查询案件
        // 2.2 检查是否停留状态(非停留不可解放)
        // 2.3 更新案件
        //     - is_stay = false
        //     - stay_at = null
        //     - stay_by = null
        //     - stay_released_at = now
        //     - stay_released_by = operatorId
        //     注意:不自动分配催员
        // 2.4 记录成功/失败
    }
    // 3. 返回结果
}
```

### 5. 非功能性要求(Non-Functional Requirements)

#### 5.1 性能要求

| 接口 | QPS目标 | 响应时间(P99) | 峰值容量 |
|------|---------|--------------|---------|
| POST /api/v1/cases/batch-stay | 20 | <1000ms | 100 QPS |
| POST /api/v1/cases/batch-release-stay | 20 | <1000ms | 100 QPS |
| GET /api/v1/cases/stay | 50 | <500ms | 200 QPS |

**性能优化策略:**
- 批量操作采用事务批处理,减少数据库往返
- 停留案件列表查询结果分页,默认20条/页
- 大批量停留(>100案件)转异步后台任务

#### 5.2 可用性要求

**SLA目标:**
- 月度可用性:99.9%
- 故障恢复时间(MTTR):<30分钟

**降级策略:**
- 停留操作失败时,返回详细失败原因
- 停留列表查询失败时,返回空列表并提示

---

## 三、验收标准(Acceptance Criteria)

### 关键验收标准

1. ✅ **批量标记停留功能**
   - 勾选多个案件后,可以点击"标记停留"按钮
   - 弹出确认对话框显示停留案件数量
   - 确认后案件进入停留状态(is_stay=true)
   - 停留案件从普通案件列表中移除
   - 停留案件的催员分配被清空
   - 已结清案件标记停留失败,返回错误提示

2. ✅ **批量解放停留功能**
   - 在停留案件列表勾选案件,可以点击"批量解放停留"
   - 弹出确认对话框显示解放案件数量
   - 确认后案件解除停留状态(is_stay=false)
   - 解放后案件从停留列表中移除
   - 解放后案件不自动分配催员

3. ✅ **停留案件列表查询**
   - 仅显示is_stay=true的案件
   - 支持按队列、停留时间、停留操作人筛选
   - 支持搜索案件编号、客户姓名、客户ID、手机号
   - 显示停留时间和停留操作人信息

4. ✅ **幂等性保证**
   - 重复标记已停留案件不报错,计入成功数
   - 重复解放非停留案件返回失败,提示案件不是停留状态

5. ✅ **操作记录完整**
   - 停留时记录stay_at和stay_by
   - 解放时记录stay_released_at和stay_released_by

---

## 附录

### A. 变更历史

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| v1.0 | 2025-12-05 | 初始版本,完整PRD | AI Assistant |

---

**文档状态:**✅ 已完成  
**最后更新:**2025-12-05  
**版本:**v1.0.0

