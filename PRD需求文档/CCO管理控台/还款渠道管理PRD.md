# 还款渠道管理 PRD

## 一、产品需求（Product Requirements）

### 1. 项目背景与目标（Background & Goals）

还款渠道管理是CCO管理控台的核心功能之一，用于为不同甲方配置和管理多种第三方支付渠道。不同国家和地区的支付方式差异很大，系统需要支持灵活的还款渠道配置，让管理员能够为每个甲方配置适合的支付渠道（如印尼的VA码、菲律宾的电子钱包、墨西哥的现金支付等），并支持拖拽排序、启用/禁用等管理功能。通过统一的还款渠道管理，确保催员在IM端能够为案件请求合适的还款码，提高还款成功率。

**业务痛点**：
- 不同国家/地区的支付方式差异大，需要灵活的配置机制
- 渠道配置复杂，需要高效的管理工具
- 渠道排序影响用户体验，需要支持拖拽排序
- 渠道状态管理需要实时控制，支持快速启用/禁用
- 渠道配置信息敏感，需要安全的存储和传输

**预期影响的核心指标**：
- 渠道配置效率：单个渠道配置完成时间≤2分钟
- 渠道管理效率：拖拽排序操作响应时间≤500ms
- 渠道配置准确率：渠道配置成功率≥99%
- 用户满意度：管理员对还款渠道管理功能满意度≥90%

---

### 2. 业务场景与用户画像（Business Scenario & User）

#### 2.1 典型使用场景

**场景1：查看还款渠道列表**
- **入口**：管理控台菜单 → 支付管理 → 还款渠道管理
- **触发时机**：需要查看或管理甲方还款渠道时
- **所在页面**：`/admin/payment-channels`
- **流程节点**：选择甲方 → 查看渠道列表 → 筛选/搜索渠道 → 管理渠道

**场景2：新增还款渠道**
- **入口**：还款渠道列表页面 → 点击"新增渠道"按钮
- **触发时机**：需要为甲方添加新的支付渠道时
- **所在页面**：还款渠道列表页面 → 新增渠道弹窗
- **流程节点**：点击新增 → 填写渠道信息 → 配置接口信息 → 保存

**场景3：编辑还款渠道**
- **入口**：还款渠道列表页面 → 点击"编辑"按钮
- **触发时机**：需要修改渠道配置信息时
- **所在页面**：还款渠道列表页面 → 编辑渠道弹窗
- **流程节点**：点击编辑 → 修改渠道信息 → 保存

**场景4：拖拽排序渠道**
- **入口**：还款渠道列表页面 → 拖拽渠道行
- **触发时机**：需要调整渠道显示顺序时
- **所在页面**：还款渠道列表页面
- **流程节点**：拖拽渠道行 → 释放 → 自动保存排序

**场景5：启用/禁用渠道**
- **入口**：还款渠道列表页面 → 点击启用/禁用开关
- **触发时机**：需要临时禁用或启用某个渠道时
- **所在页面**：还款渠道列表页面
- **流程节点**：点击开关 → 确认操作 → 更新状态

**场景6：删除还款渠道**
- **入口**：还款渠道列表页面 → 点击"删除"按钮
- **触发时机**：需要删除不再使用的渠道时
- **所在页面**：还款渠道列表页面 → 删除确认弹窗
- **流程节点**：点击删除 → 确认删除 → 删除成功

#### 2.2 主要用户类型

| 用户类型 | 角色标识 | 核心诉求 | 使用频率 |
|---------|---------|---------|---------|
| 超级管理员 | SuperAdmin | 配置所有甲方的还款渠道 | 中 |
| 甲方管理员 | TenantAdmin | 配置本甲方的还款渠道 | 高 |
| 机构管理员 | AgencyAdmin | 查看还款渠道配置 | 低 |
| 小组管理员 | TeamLeader | 查看还款渠道配置 | 低 |

---

### 3. 关键业务流程（Business Flow）

#### 3.1 还款渠道列表展示流程

```
管理员进入还款渠道管理页面
    ↓
选择甲方（必选）
    ↓
加载还款渠道列表：
  - 按sort_order排序
  - 显示渠道基本信息
  - 显示启用状态
    ↓
支持筛选：
  - 按启用状态筛选（全部/已启用/已禁用）
  - 按支付类型筛选（全部/VA码/H5链接/二维码）
    ↓
支持搜索：
  - 按渠道名称搜索
  - 按服务公司搜索
    ↓
显示渠道列表（表格形式）
```

#### 3.2 新增还款渠道流程

```
管理员点击"新增渠道"按钮
    ↓
打开新增渠道弹窗
    ↓
填写基础信息：
  - 支付名称（必填）
  - 支付图标（选填，支持上传）
  - 支付类型（必填，VA/H5/QR）
  - 服务公司（必填）
  - 渠道描述（选填）
    ↓
配置接口信息：
  - API地址（必填）
  - 请求方法（必填，GET/POST）
  - 认证方式（必填，API_KEY/BEARER/BASIC）
  - 认证配置（必填，JSON格式）
  - 接口入参配置（必填，JSON格式，支持占位符）
    ↓
配置状态：
  - 是否启用（开关，默认开启）
  - 排序权重（数字，默认0）
    ↓
点击"保存"按钮
    ↓
校验表单数据：
  - 必填字段校验
  - URL格式校验
  - JSON格式校验
    ↓
[校验失败] → 显示错误提示
    ↓
[校验成功] → 保存到数据库
    ↓
刷新渠道列表
```

#### 3.3 拖拽排序流程

```
管理员在渠道列表中拖拽渠道行
    ↓
显示拖拽预览效果
    ↓
释放拖拽
    ↓
计算新的排序顺序：
  - 获取拖拽后的渠道顺序
  - 重新计算sort_order值
    ↓
调用排序接口，批量更新sort_order
    ↓
[更新成功] → 刷新列表，显示新顺序
    ↓
[更新失败] → 显示错误提示，恢复原顺序
```

#### 3.4 启用/禁用渠道流程

```
管理员点击渠道的启用/禁用开关
    ↓
检查当前状态
    ↓
[当前启用] → 弹窗确认："确定要禁用该渠道吗？禁用后催员端将无法使用。"
    ↓
[当前禁用] → 直接切换为启用（无需确认）
    ↓
[确认禁用] → 更新is_enabled字段为0
    ↓
[确认启用] → 更新is_enabled字段为1
    ↓
刷新渠道列表，更新状态显示
```

#### 3.5 编辑还款渠道流程

```
管理员点击渠道的"编辑"按钮
    ↓
打开编辑渠道弹窗
    ↓
加载渠道当前配置信息
    ↓
管理员修改配置信息
    ↓
点击"保存"按钮
    ↓
校验表单数据
    ↓
[校验失败] → 显示错误提示
    ↓
[校验成功] → 更新数据库
    ↓
刷新渠道列表
```

#### 3.6 删除还款渠道流程

```
管理员点击渠道的"删除"按钮
    ↓
弹窗确认："确定要删除该渠道吗？删除后无法恢复。"
    ↓
[取消] → 关闭弹窗
    ↓
[确认] → 检查渠道是否被使用：
  - 检查是否有还款码记录关联该渠道
    ↓
[有使用记录] → 提示："该渠道已被使用，无法删除。"
    ↓
[无使用记录] → 执行删除操作
    ↓
删除成功，刷新渠道列表
```

---

### 4. 业务规则与边界（Business Rules & Scope）

#### 4.1 渠道列表展示规则

**展示规则**：
- 默认按`sort_order`升序排序（越小越靠前）
- 支持按启用状态筛选（全部/已启用/已禁用）
- 支持按支付类型筛选（全部/VA码/H5链接/二维码）
- 支持按渠道名称搜索（模糊匹配）
- 支持按服务公司搜索（模糊匹配）
- 支持分页展示（默认每页20条）

**列表字段**：
- 拖拽手柄（用于排序）
- 支付图标（64x64px，支持预览）
- 支付名称
- 支付类型（Tag显示：VA码/H5链接/二维码）
- 服务公司
- 启用状态（开关按钮）
- 排序权重（数字显示）
- 创建时间
- 操作（编辑、删除）

**范围边界**：
- ✅ 支持列表展示、筛选、搜索
- ✅ 支持拖拽排序
- ✅ 支持启用/禁用切换
- ❌ 不支持批量操作（批量启用/禁用、批量删除）

#### 4.2 渠道配置规则

**基础信息规则**：
- **支付名称**：必填，长度1-100字符，同一甲方下不能重复
- **支付图标**：选填，支持jpg/png格式，建议尺寸64x64px，文件大小≤2MB
- **支付类型**：必填，必须是：VA码/H5链接/二维码
- **服务公司**：必填，长度1-100字符
- **渠道描述**：选填，长度≤500字符

**接口配置规则**：
- **API地址**：必填，必须是有效的URL格式，支持http/https
- **请求方法**：必填，必须是：GET/POST
- **认证方式**：必填，必须是：API_KEY/BEARER/BASIC
- **认证配置**：必填，必须是有效的JSON格式
  - API_KEY：`{"api_key": "xxx"}`
  - BEARER：`{"token": "xxx"}`
  - BASIC：`{"username": "xxx", "password": "xxx"}`
- **接口入参配置**：必填，必须是有效的JSON格式，支持占位符：
  - `{loan_id}` - 借款ID
  - `{case_id}` - 案件ID
  - `{installment_number}` - 期数
  - `{amount}` - 还款金额
  - `{customer_name}` - 客户姓名
  - `{customer_phone}` - 客户手机号
  - `{customer_id}` - 客户ID

**状态配置规则**：
- **是否启用**：开关按钮，默认开启（is_enabled=1）
- **排序权重**：数字输入框，默认0，范围0-9999，越小越靠前

**范围边界**：
- ✅ 支持渠道的增删改查
- ✅ 支持接口配置（URL、认证、参数模板）
- ✅ 支持占位符变量
- ❌ 不支持接口测试功能（不在本需求范围内）
- ❌ 不支持接口调用日志查看（不在本需求范围内）

#### 4.3 拖拽排序规则

**排序规则**：
- 支持拖拽渠道行调整顺序
- 拖拽后自动保存排序（调用排序接口）
- 排序值（sort_order）自动重新计算：
  - 第一个渠道：sort_order = 1
  - 第二个渠道：sort_order = 2
  - 以此类推
- 排序范围：仅限当前甲方下的渠道

**排序限制**：
- 只能拖拽同一甲方下的渠道
- 排序操作需要权限验证
- 排序失败时恢复原顺序

**范围边界**：
- ✅ 支持拖拽排序
- ✅ 支持自动保存排序
- ❌ 不支持手动输入排序值（仅支持拖拽）

#### 4.4 启用/禁用规则

**启用/禁用规则**：
- 支持快速切换渠道启用状态
- 启用状态影响催员端显示：
  - 已启用：催员端可见且可用
  - 已禁用：催员端不可见
- 禁用操作需要二次确认
- 启用操作无需确认（直接切换）

**状态切换规则**：
- 启用 → 禁用：弹窗确认
- 禁用 → 启用：直接切换

**范围边界**：
- ✅ 支持启用/禁用切换
- ✅ 支持二次确认（禁用时）
- ❌ 不支持批量启用/禁用

#### 4.5 删除规则

**删除规则**：
- 删除操作需要二次确认
- 删除前检查渠道是否被使用：
  - 检查`payment_codes`表中是否有记录关联该渠道
  - 如果有使用记录，不允许删除
- 删除成功后，关联的还款码记录不受影响（保留历史记录）

**删除限制**：
- 有使用记录的渠道不能删除
- 删除操作需要权限验证

**范围边界**：
- ✅ 支持删除渠道
- ✅ 支持使用记录检查
- ❌ 不支持强制删除（有使用记录时）

---

### 5. 合规与风控要求（Compliance & Risk Control）

#### 5.1 数据安全

**敏感信息保护**：
- 认证配置（auth_config）字段需要加密存储（AES加密）
- 前端传输使用HTTPS
- 仅授权人员可查看敏感信息
- 敏感信息在日志中需要脱敏处理

**权限控制**：
- 渠道配置：SuperAdmin和TenantAdmin可以操作
- TenantAdmin只能配置自己甲方的渠道
- 其他角色：只能查看，不能编辑

#### 5.2 数据校验

**配置校验**：
- URL格式校验：必须是有效的URL
- JSON格式校验：认证配置和接口入参配置必须是有效的JSON
- 必填字段校验：确保必填字段都已填写
- 渠道名称唯一性校验：同一甲方下渠道名称不能重复

#### 5.3 审计要求

**操作日志**：
- 记录渠道配置的所有变更操作（创建、编辑、删除）
- 记录启用/禁用操作
- 记录排序操作
- 记录操作人、操作时间、操作内容

---

### 6. 资金路径与结算规则（Funding Flow & Settlement）

**不适用**：本功能不涉及资金流转，仅涉及渠道配置管理。

---

### 7. 数据字段与口径（Data Definition）

#### 7.1 还款渠道配置表（payment_channels）

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|---------|
| id | BIGINT | 主键ID | 系统自增 | - |
| party_id | BIGINT | 所属甲方ID | 系统自动 | - |
| channel_name | VARCHAR(100) | 支付名称 | 管理员输入 | 可编辑 |
| channel_icon | VARCHAR(500) | 图标URL | 管理员上传 | 可编辑 |
| channel_type | ENUM | 支付类型：VA/H5/QR | 管理员选择 | 可编辑 |
| service_provider | VARCHAR(100) | 服务公司 | 管理员输入 | 可编辑 |
| description | TEXT | 渠道描述 | 管理员输入 | 可编辑 |
| api_url | VARCHAR(500) | API地址 | 管理员输入 | 可编辑 |
| api_method | ENUM | 请求方法：GET/POST | 管理员选择 | 可编辑 |
| auth_type | ENUM | 认证方式：API_KEY/BEARER/BASIC | 管理员选择 | 可编辑 |
| auth_config | JSON | 认证配置（加密存储） | 管理员输入 | 可编辑 |
| request_params | JSON | 接口入参模板 | 管理员输入 | 可编辑 |
| is_enabled | TINYINT(1) | 是否启用：1-启用，0-禁用 | 管理员配置 | 可编辑 |
| sort_order | INT | 排序权重，越小越靠前 | 系统自动/拖拽 | 可编辑 |
| created_by | BIGINT | 创建人ID | 系统自动 | - |
| updated_by | BIGINT | 更新人ID | 系统自动 | - |
| created_at | TIMESTAMP | 创建时间 | 系统自动 | - |
| updated_at | TIMESTAMP | 更新时间 | 系统自动 | - |

#### 7.2 统计口径

- **渠道配置数量**：按甲方统计已配置的渠道数量（按自然日统计）
- **渠道启用率**：已启用渠道数 / 总渠道数（按自然日统计）
- **渠道配置成功率**：成功配置的渠道数 / 总配置尝试数（按自然日统计）

---

### 8. 交互与信息展示（UX & UI Brief）

#### 8.1 还款渠道列表页面

**布局**：
- 顶部：甲方选择器、"新增渠道"按钮
- 筛选器：启用状态筛选、支付类型筛选、搜索框
- 表格：渠道列表（支持拖拽排序）

**渠道列表表格列**：
- 拖拽手柄（用于排序）
- 支付图标（64x64px，支持预览）
- 支付名称
- 支付类型（Tag显示：VA码/H5链接/二维码）
- 服务公司
- 启用状态（开关按钮）
- 排序权重（数字显示）
- 创建时间
- 操作（编辑、删除）

**功能**：
- 支持拖拽排序（使用Sortable.js或Vue Draggable）
- 支持按启用状态筛选
- 支持按支付类型筛选
- 支持按渠道名称搜索
- 支持按服务公司搜索
- 支持分页展示

#### 8.2 新增/编辑渠道弹窗

**布局**：
- 弹窗标题："新增渠道"或"编辑渠道"
- 表单区域：
  - 基础信息（支付名称、图标、类型、服务公司、描述）
  - 接口配置（API地址、请求方法、认证方式、认证配置、接口入参配置）
  - 状态配置（是否启用、排序权重）
- 操作按钮："取消"、"保存"

**表单验证**：
- 实时验证：输入时实时校验格式
- 提交验证：点击保存时完整校验
- 错误提示：在对应字段下方显示错误信息

#### 8.3 删除确认弹窗

**布局**：
- 弹窗标题："删除确认"
- 提示内容："确定要删除该渠道吗？删除后无法恢复。"
- 操作按钮："取消"、"确认删除"

#### 8.4 禁用确认弹窗

**布局**：
- 弹窗标题："禁用确认"
- 提示内容："确定要禁用该渠道吗？禁用后催员端将无法使用。"
- 操作按钮："取消"、"确认禁用"

---

### 9. 配置项与运营开关（Config & Operation Switches）

#### 9.1 渠道配置开关

**配置项**：
- 是否允许删除有使用记录的渠道（默认：不允许）
- 是否启用渠道配置审核（默认：不启用）
- 渠道配置变更是否需要审批（默认：不需要）

**配置入口**：系统设置 → 还款渠道管理 → 配置开关

#### 9.2 排序配置

**配置项**：
- 默认排序方式（默认：按sort_order升序）
- 是否允许手动输入排序值（默认：不允许，仅支持拖拽）

**配置入口**：系统设置 → 还款渠道管理 → 排序配置

---

## 二、数据需求（Data Requirements）

### 1. 埋点需求（Tracking Requirements）

| 触发时间点/条件 | 埋点中文说明 | 埋点英文ID | 关键属性 |
|----------------|------------|-----------|---------|
| 进入还款渠道管理页面 | 查看还款渠道管理页面 | view_payment_channels_page | party_id, user_id |
| 点击新增渠道按钮 | 点击新增渠道按钮 | click_add_channel | party_id, user_id |
| 保存渠道配置 | 保存渠道配置 | save_channel_config | party_id, user_id, channel_type |
| 点击编辑渠道按钮 | 点击编辑渠道按钮 | click_edit_channel | party_id, user_id, channel_id |
| 拖拽排序渠道 | 拖拽排序渠道 | drag_sort_channel | party_id, user_id, channel_ids |
| 切换启用/禁用状态 | 切换渠道启用状态 | toggle_channel_status | party_id, user_id, channel_id, is_enabled |
| 点击删除渠道按钮 | 点击删除渠道按钮 | click_delete_channel | party_id, user_id, channel_id |
| 确认删除渠道 | 确认删除渠道 | confirm_delete_channel | party_id, user_id, channel_id |

---

## 三、技术部分描述（Technical Requirements / TRD）

### 1. 系统架构与模块划分（System Architecture & Modules）

#### 1.1 模块划分

```
还款渠道管理模块
│
├── 渠道配置管理模块
│   ├── PaymentChannelController（渠道配置API）
│   ├── PaymentChannelService（渠道配置业务逻辑）
│   └── PaymentChannelMapper（渠道配置数据访问）
│
├── 渠道排序模块
│   ├── ChannelSortService（排序业务逻辑）
│   └── 前端拖拽组件（Sortable.js/Vue Draggable）
│
└── 渠道状态管理模块
    ├── ChannelStatusService（状态管理业务逻辑）
    └── 前端开关组件
```

#### 1.2 调用关系

```
前端页面
    ↓
Controller层（API接口）
    ↓
Service层（业务逻辑）
    ↓
Mapper层（数据访问）
    ↓
数据库（MySQL）
```

---

### 2. 接口设计与系统依赖（API Design & Dependencies）

#### 2.1 渠道配置管理接口

**2.1.1 获取渠道列表**
- **接口**：`GET /api/admin/payment-channels`
- **请求参数**：
  - `party_id`（必填）：甲方ID
  - `is_enabled`（可选）：是否启用（1/0）
  - `channel_type`（可选）：支付类型（VA/H5/QR）
  - `keyword`（可选）：搜索关键词（渠道名称或服务公司）
  - `page`（可选）：页码（默认1）
  - `page_size`（可选）：每页数量（默认20）
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "list": [
      {
        "id": 1,
        "party_id": 1,
        "channel_name": "BCA VA",
        "channel_icon": "https://...",
        "channel_type": "VA",
        "service_provider": "Xendit",
        "description": "BCA虚拟账户",
        "is_enabled": 1,
        "sort_order": 1,
        "created_at": "2025-11-25T10:00:00Z",
        "updated_at": "2025-11-25T10:00:00Z"
      }
    ]
  }
}
```

**2.1.2 获取渠道详情**
- **接口**：`GET /api/admin/payment-channels/{id}`
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "party_id": 1,
    "channel_name": "BCA VA",
    "channel_icon": "https://...",
    "channel_type": "VA",
    "service_provider": "Xendit",
    "description": "BCA虚拟账户",
    "api_url": "https://api.xendit.co/v2/virtual_accounts",
    "api_method": "POST",
    "auth_type": "API_KEY",
    "auth_config": {
      "api_key": "***"
    },
    "request_params": {
      "loan_id": "{loan_id}",
      "amount": "{amount}"
    },
    "is_enabled": 1,
    "sort_order": 1,
    "created_at": "2025-11-25T10:00:00Z",
    "updated_at": "2025-11-25T10:00:00Z"
  }
}
```

**2.1.3 创建渠道**
- **接口**：`POST /api/admin/payment-channels`
- **请求体**：
```json
{
  "party_id": 1,
  "channel_name": "BCA VA",
  "channel_icon": "https://...",
  "channel_type": "VA",
  "service_provider": "Xendit",
  "description": "BCA虚拟账户",
  "api_url": "https://api.xendit.co/v2/virtual_accounts",
  "api_method": "POST",
  "auth_type": "API_KEY",
  "auth_config": {
    "api_key": "xnd_development_xxx"
  },
  "request_params": {
    "loan_id": "{loan_id}",
    "amount": "{amount}",
    "customer_name": "{customer_name}"
  },
  "is_enabled": 1,
  "sort_order": 0
}
```

**2.1.4 更新渠道**
- **接口**：`PUT /api/admin/payment-channels/{id}`
- **请求体**：同创建接口

**2.1.5 删除渠道**
- **接口**：`DELETE /api/admin/payment-channels/{id}`
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

**2.1.6 切换启用状态**
- **接口**：`POST /api/admin/payment-channels/{id}/toggle`
- **请求体**：
```json
{
  "is_enabled": 0
}
```

**2.1.7 更新排序**
- **接口**：`POST /api/admin/payment-channels/sort`
- **请求体**：
```json
{
  "party_id": 1,
  "channel_ids": [3, 1, 2, 5, 4]
}
```
- **说明**：channel_ids数组按新顺序排列，系统会重新计算sort_order

#### 2.2 接口依赖

**内部依赖**：
- 甲方服务：校验party_id是否存在
- 文件上传服务：处理图标上传

**外部依赖**：
- 无

#### 2.3 超时与重试策略

- **超时时间**：5秒
- **重试策略**：不重试
- **幂等要求**：创建和更新接口需要幂等

#### 2.4 失败降级逻辑

- **配置保存失败**：返回错误信息，不保存配置
- **排序更新失败**：返回错误信息，恢复原顺序
- **状态切换失败**：返回错误信息，保持原状态

---

### 3. 数据存储与模型依赖（Data Storage & Model Dependencies）

#### 3.1 依赖的现有表

- `payment_channels`：还款渠道配置表
- `payment_codes`：还款码记录表（用于检查渠道是否被使用）

#### 3.2 索引优化

**payment_channels表索引**：
- 主键：`id`
- 普通索引：`party_id`、`is_enabled`、`sort_order`
- 组合索引：`idx_party_enabled`（party_id, is_enabled, sort_order）

---

### 4. 非功能性要求（Non-Functional Requirements）

#### 4.1 性能目标

- **接口响应时间**：所有接口响应时间≤500ms
- **列表加载时间**：加载20条渠道记录≤1秒
- **拖拽排序响应时间**：排序操作响应时间≤500ms

#### 4.2 可用性要求

- **SLA**：接口可用性≥99.9%
- **降级策略**：排序失败时，返回错误信息，恢复原顺序

#### 4.3 安全要求

- **接口鉴权**：所有接口需要Token验证
- **权限控制**：SuperAdmin和TenantAdmin可以操作，TenantAdmin只能操作自己甲方的数据
- **数据加密**：auth_config字段需要AES加密存储
- **数据校验**：URL格式、JSON格式、必填字段校验

---

### 5. 日志埋点与监控告警（Logging, Metrics & Alerting）

#### 5.1 关键日志

**必须记录的日志**：
- 渠道配置的所有变更操作（创建、编辑、删除）
- 启用/禁用操作
- 排序操作
- 操作人、操作时间、操作内容

**日志格式**：
```
[INFO] 创建还款渠道 - partyId=1, channelName=BCA VA, channelType=VA, userId=admin
[INFO] 更新还款渠道 - partyId=1, channelId=1, userId=admin
[INFO] 删除还款渠道 - partyId=1, channelId=1, userId=admin
[INFO] 切换渠道状态 - partyId=1, channelId=1, isEnabled=0, userId=admin
[INFO] 更新渠道排序 - partyId=1, channelIds=[3,1,2], userId=admin
```

#### 5.2 监控指标

**关键指标**：
- 渠道配置创建成功率
- 渠道配置更新成功率
- 渠道删除成功率
- 排序操作成功率
- 状态切换成功率

**告警规则**：
- 接口错误率>1%：发送告警
- 排序操作失败率>5%：发送告警
- 配置保存失败率>2%：发送告警

---

### 6. 测试策略与验收标准（Test Plan & Acceptance Criteria）

#### 6.1 测试类型

**单元测试**：
- 渠道配置数据校验测试
- 排序算法测试
- 状态切换逻辑测试
- 删除前使用记录检查测试

**集成测试**：
- 渠道配置创建接口测试
- 渠道配置更新接口测试
- 渠道配置删除接口测试
- 排序接口测试
- 状态切换接口测试
- 权限验证测试

**前端测试**：
- 拖拽排序功能测试
- 表单验证测试
- 开关切换测试

#### 6.2 验收标准

**关键验收标准**：
1. ✅ 渠道列表展示正常，支持筛选和搜索
2. ✅ 拖拽排序功能正常，排序后自动保存
3. ✅ 渠道配置创建/编辑/删除功能正常
4. ✅ 启用/禁用切换功能正常，禁用时需二次确认
5. ✅ 权限控制有效：只有SuperAdmin和TenantAdmin可以操作
6. ✅ 数据校验有效：URL格式、JSON格式、必填字段校验
7. ✅ 敏感信息加密存储：auth_config字段加密存储

---

### 7. 发布计划与回滚预案（Release Plan & Rollback）

#### 7.1 发布策略

**灰度发布**：
- 第一阶段：内部测试环境验证（1周）
- 第二阶段：小范围甲方测试（选择1-2个甲方，1周）
- 第三阶段：全量发布（所有甲方）

#### 7.2 回滚方案

**回滚步骤**：
1. 关闭功能入口
2. 保留已创建的渠道配置（不删除）
3. 修复问题后重新发布

---

**文档版本**：v1.0.0  
**创建日期**：2025-11-25  
**最后更新**：2025-11-25  
**状态**：待评审

