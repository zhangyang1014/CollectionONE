# 甲方还款渠道配置管理 PRD

## 1. 功能概述

为不同甲方提供灵活的还款渠道配置能力，支持配置多种第三方支付渠道（如印尼、墨西哥、印度、智利、菲律宾等国家的主流支付方式），催员可在IM端为案件请求还款码并跟踪还款状态。

## 2. 核心功能模块

### 2.1 还款渠道配置

#### 2.1.1 渠道列表页面

**功能要求：**
- 展示当前甲方已配置的所有还款渠道
- 支持按状态筛选（已启用/已禁用）
- 支持拖拽排序（决定催员端显示顺序）
- 支持启用/禁用开关切换
- 支持新增、编辑、删除操作

**列表字段：**
- 支付名称
- 支付图标
- 支付类型（VA码/H5链接/二维码）
- 服务公司
- 启用状态
- 排序
- 操作按钮

#### 2.1.2 渠道配置表单

**基础信息：**

| 字段 | 类型 | 是否必填 | 说明 |
|------|------|---------|------|
| 支付名称 | 文本 | 必填 | 如"GCash"、"BCA VA"、"OXXO Pay" |
| 支付图标 | 图片上传 | 选填 | 建议尺寸64x64px，支持jpg/png格式 |
| 支付类型 | 下拉选择 | 必填 | VA码/H5链接/二维码 |
| 所属服务公司 | 文本 | 必填 | 如"Xendit"、"Midtrans"、"Razorpay" |
| 渠道描述 | 多行文本 | 选填 | 简短说明该渠道的特点 |

**接口配置：**

| 字段 | 类型 | 是否必填 | 说明 |
|------|------|---------|------|
| API地址 | 文本 | 必填 | 甲方提供的还款码生成接口地址 |
| 请求方法 | 下拉选择 | 必填 | GET/POST |
| 认证方式 | 下拉选择 | 必填 | API Key/Bearer Token/Basic Auth |
| 认证配置 | JSON | 必填 | 根据认证方式填写对应的密钥信息 |
| 接口入参配置 | JSON编辑器 | 必填 | 配置调用第三方接口的参数模板 |

**接口入参配置示例：**
```json
{
  "loan_id": "{loan_id}",
  "case_id": "{case_id}",
  "installment_number": "{installment_number}",
  "amount": "{amount}",
  "customer_name": "{customer_name}",
  "customer_phone": "{customer_phone}",
  "customer_id": "{customer_id}"
}
```

**支持的变量占位符：**
- `{loan_id}` - 借款ID
- `{case_id}` - 案件ID
- `{installment_number}` - 期数
- `{amount}` - 还款金额
- `{customer_name}` - 客户姓名
- `{customer_phone}` - 客户手机号
- `{customer_id}` - 客户ID

**状态配置：**
- 是否启用：开关按钮，默认开启
- 排序权重：数字输入框，越小越靠前

**重要说明：**
- 有效期由第三方支付接口返回，不在此处配置
- 系统会自动替换占位符为实际值后调用第三方接口

#### 2.1.3 数据库设计

**payment_channels 表（还款渠道配置表）：**

```sql
CREATE TABLE payment_channels (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
  party_id BIGINT NOT NULL COMMENT '甲方ID',
  channel_name VARCHAR(100) NOT NULL COMMENT '支付名称',
  channel_icon VARCHAR(500) COMMENT '图标URL',
  channel_type ENUM('VA', 'H5', 'QR') NOT NULL COMMENT '支付类型：VA-虚拟账户，H5-H5链接，QR-二维码',
  service_provider VARCHAR(100) COMMENT '服务公司',
  description TEXT COMMENT '渠道描述',
  api_url VARCHAR(500) NOT NULL COMMENT 'API地址',
  api_method ENUM('GET', 'POST') DEFAULT 'POST' COMMENT '请求方法',
  auth_type ENUM('API_KEY', 'BEARER', 'BASIC') NOT NULL COMMENT '认证方式',
  auth_config JSON COMMENT '认证配置（加密存储）',
  request_params JSON COMMENT '接口入参模板',
  is_enabled TINYINT(1) DEFAULT 1 COMMENT '是否启用：1-启用，0-禁用',
  sort_order INT DEFAULT 0 COMMENT '排序权重，越小越靠前',
  created_by BIGINT COMMENT '创建人ID',
  updated_by BIGINT COMMENT '更新人ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_party_enabled (party_id, is_enabled, sort_order),
  INDEX idx_party_id (party_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='还款渠道配置表';
```

#### 2.1.4 API接口设计

**接口1：获取渠道列表**
```
GET /api/admin/payment-channels
请求参数：
  - party_id: 甲方ID（必填）
  - is_enabled: 是否启用（选填，1/0）
  - page: 页码（默认1）
  - page_size: 每页数量（默认20）

返回示例：
{
  "code": 0,
  "msg": "success",
  "data": {
    "total": 5,
    "list": [
      {
        "id": 1,
        "channel_name": "BCA VA",
        "channel_icon": "https://...",
        "channel_type": "VA",
        "service_provider": "Xendit",
        "is_enabled": 1,
        "sort_order": 1
      }
    ]
  }
}
```

**接口2：创建渠道**
```
POST /api/admin/payment-channels
请求体：见渠道配置表单
```

**接口3：更新渠道**
```
PUT /api/admin/payment-channels/{id}
请求体：见渠道配置表单
```

**接口4：删除渠道**
```
DELETE /api/admin/payment-channels/{id}
```

**接口5：更新排序**
```
POST /api/admin/payment-channels/sort
请求体：
{
  "party_id": 1,
  "channel_ids": [3, 1, 2, 5, 4]
}
```

**接口6：切换启用状态**
```
POST /api/admin/payment-channels/{id}/toggle
```

### 2.2 权限设计

**所需权限点：**
- `payment_channel:view` - 查看还款渠道配置
- `payment_channel:add` - 新增还款渠道
- `payment_channel:edit` - 编辑还款渠道
- `payment_channel:delete` - 删除还款渠道
- `payment_channel:toggle` - 启用/禁用渠道

**角色分配建议：**
- 超级管理员：拥有所有权限
- 甲方管理员：拥有本甲方的所有权限
- 普通管理员：仅查看权限

### 2.3 前端实现

**页面路径：**
`/admin/payment-channels`

**页面组件结构：**
```
PaymentChannels/
├── index.vue              # 主页面
├── components/
│   ├── ChannelList.vue    # 渠道列表
│   ├── ChannelForm.vue    # 渠道表单
│   └── IconUpload.vue     # 图标上传组件
└── types.ts               # 类型定义
```

**关键功能：**
1. 拖拽排序：使用 Sortable.js 或 Vue Draggable
2. 图标上传：支持预览和裁剪
3. JSON编辑器：使用 CodeMirror 或 Monaco Editor
4. 表单验证：URL格式、JSON格式验证

## 3. 技术实现要点

### 3.1 安全性

1. **密钥加密存储**
   - auth_config 字段存储前使用AES加密
   - 前端传输使用HTTPS
   - 仅授权人员可查看敏感信息

2. **接口调用安全**
   - 第三方接口调用需验证签名
   - 设置超时时间（建议5秒）
   - 记录所有调用日志

### 3.2 可扩展性

1. **支付类型可扩展**
   - 预留其他支付类型的扩展空间
   - 支持自定义支付类型

2. **变量占位符可扩展**
   - 支持添加新的占位符变量
   - 支持复杂的数据结构（嵌套对象）

### 3.3 容错处理

1. **接口调用失败**
   - 记录错误日志
   - 返回友好的错误提示
   - 支持重试机制

2. **数据验证**
   - 创建/编辑时验证API地址可达性
   - 验证JSON格式正确性
   - 验证必填字段完整性

## 4. 测试用例

### 4.1 功能测试

1. 创建渠道配置
2. 编辑渠道配置
3. 删除渠道配置
4. 启用/禁用渠道
5. 拖拽排序
6. 接口参数变量替换

### 4.2 边界测试

1. 同一甲方创建重名渠道
2. 删除已被使用的渠道
3. API地址无法访问
4. JSON格式错误
5. 密钥信息为空

## 5. 实施计划

### 5.1 第一阶段（数据库和后端）
- 创建数据库表
- 实现后端CRUD接口
- 实现密钥加密/解密
- 编写API文档

### 5.2 第二阶段（前端界面）
- 创建渠道列表页面
- 实现渠道配置表单
- 实现拖拽排序功能
- 集成图标上传功能

### 5.3 第三阶段（联调测试）
- 前后端联调
- 功能测试
- 安全测试
- 性能测试

## 6. 附录

### 6.1 各国主流支付方式参考

**印度尼西亚：**
- VA码：BCA VA、Mandiri VA、BNI VA、Permata VA
- 电子钱包：OVO、DANA、LinkAja、GoPay
- 二维码：QRIS

**墨西哥：**
- 银行转账：SPEI
- 现金支付：OXXO Pay
- 电子钱包：Mercado Pago

**印度：**
- UPI支付：统一支付接口
- 电子钱包：Paytm、PhonePe、Google Pay

**智利：**
- 银行转账：Webpay
- 电子钱包：MACH、Tenpo
- 线下支付：Servipag

**菲律宾：**
- 电子钱包：GCash、Maya、GrabPay
- 二维码：QRPH
- 线下支付：7-Eleven、Bayad Center

### 6.2 支付网关服务商参考

- Xendit（印尼、菲律宾）
- Midtrans（印尼）
- Razorpay（印度）
- Cashfree（印度）
- Dragonpay（菲律宾）
- PayMongo（菲律宾）

