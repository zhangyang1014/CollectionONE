# ç©ºé—²å‚¬å‘˜ç›‘æ§ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ‰ åŠŸèƒ½å®Œå…¨å°±ç»ªï¼

æ•°æ®è®¡ç®—å¼•æ“å·²å®Œå…¨é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼Œæ‚¨å¯ä»¥ç«‹å³å¼€å§‹ä½¿ç”¨ã€‚

---

## ğŸš€ 3æ­¥å¼€å§‹ï¼ˆæœ€ç®€å•ï¼‰

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“è¡¨

```bash
cd backend
python3 create_idle_monitor_tables.py
```

### æ­¥éª¤2ï¼šé€šè¿‡APIç”Ÿæˆæµ‹è¯•æ•°æ®

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š
```
http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1&collector_count=5
```

æˆ–ä½¿ç”¨curlï¼š
```bash
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1&collector_count=5"
```

### æ­¥éª¤3ï¼šé€šè¿‡APIè®¡ç®—ç©ºé—²æ•°æ®

è®¿é—®ï¼š
```
http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1
```

æˆ–ä½¿ç”¨curlï¼š
```bash
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1"
```

å®Œæˆï¼ç°åœ¨æ‰“å¼€å‰ç«¯æŸ¥çœ‹ç»“æœï¼š
- è®¿é—®: `http://localhost:5173`
- ç‚¹å‡»èœå•: **æ•°æ®çœ‹æ¿ > ç©ºé—²å‚¬å‘˜ç›‘æ§**

---

## ğŸ“š è¯¦ç»†ä½¿ç”¨æ–¹å¼

### æ–¹å¼1ï¼šé€šè¿‡Webç•Œé¢ï¼ˆæœ€ç®€å•ï¼‰

#### 1.1 ç”Ÿæˆæµ‹è¯•æ•°æ®

å‰ç«¯å°†æ¥å¯ä»¥æ·»åŠ ä¸€ä¸ª"ç”Ÿæˆæµ‹è¯•æ•°æ®"æŒ‰é’®ï¼Œç°åœ¨æš‚æ—¶é€šè¿‡APIï¼š

```bash
# ç”Ÿæˆä»Šå¤©çš„æµ‹è¯•æ•°æ®ï¼ˆ5ä¸ªå‚¬å‘˜ï¼‰
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1&collector_count=5"

# ç”ŸæˆæŒ‡å®šæ—¥æœŸçš„æµ‹è¯•æ•°æ®ï¼ˆ10ä¸ªå‚¬å‘˜ï¼‰
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1&test_date=2025-11-20&collector_count=10"
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "æˆåŠŸä¸º 5/5 ä¸ªå‚¬å‘˜ç”Ÿæˆæµ‹è¯•æ•°æ®",
  "log": [
    "âœ… å‚¬å‘˜ å¼ ä¸‰: ç”Ÿæˆ 45 æ¡è®°å½•",
    "âœ… å‚¬å‘˜ æå››: ç”Ÿæˆ 38 æ¡è®°å½•",
    ...
  ],
  "stats": {
    "total_collectors": 5,
    "generated_count": 5
  },
  "next_step": {
    "message": "ä¸‹ä¸€æ­¥ï¼šè¿è¡Œè®¡ç®—",
    "api": "/api/v1/idle-monitor/calculate?tenant_id=1&calc_date=2025-11-20"
  }
}
```

#### 1.2 è®¡ç®—ç©ºé—²æ•°æ®

**åŒæ­¥è®¡ç®—ï¼ˆç«‹å³è¿”å›ç»“æœï¼‰ï¼š**
```bash
# è®¡ç®—æ˜¨å¤©çš„æ•°æ®
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1"

# è®¡ç®—æŒ‡å®šæ—¥æœŸ
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1&calc_date=2025-11-20"
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "è®¡ç®—å®Œæˆï¼ŒæˆåŠŸ 5/5 ä¸ªå‚¬å‘˜",
  "log": [
    "[10:30:15] ğŸš€ å¼€å§‹è®¡ç®— - ç”²æ–¹ID: 1, æ—¥æœŸ: 2025-11-20",
    "[10:30:15] ğŸ“Š æ‰¾åˆ° 5 ä¸ªæ´»è·ƒå‚¬å‘˜",
    "[10:30:16]    å‚¬å‘˜ å¼ ä¸‰: å‘ç° 2 ä¸ªç©ºé—²æ—¶æ®µ",
    "[10:30:16]    å‚¬å‘˜ æå››: å‘ç° 1 ä¸ªç©ºé—²æ—¶æ®µ",
    ...
    "[10:30:17] âœ… è®¡ç®—å®Œæˆï¼æˆåŠŸ: 5/5 ä¸ªå‚¬å‘˜"
  ],
  "stats": {
    "total_collectors": 5,
    "success_count": 5,
    "fail_count": 0
  }
}
```

**å¼‚æ­¥è®¡ç®—ï¼ˆç«‹å³è¿”å›ï¼Œåå°æ‰§è¡Œï¼‰ï¼š**
```bash
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate-async?tenant_id=1&calc_date=2025-11-20"
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "è®¡ç®—ä»»åŠ¡å·²æäº¤åˆ°åå°é˜Ÿåˆ—",
  "tenant_id": 1,
  "calc_date": "2025-11-20"
}
```

#### 1.3 æŸ¥çœ‹ç»“æœ

è®¿é—® Web ç•Œé¢ï¼š
- `http://localhost:5173`
- ç™»å½•åé€‰æ‹©ç”²æ–¹
- ç‚¹å‡»èœå•ï¼š**æ•°æ®çœ‹æ¿ > ç©ºé—²å‚¬å‘˜ç›‘æ§**

---

### æ–¹å¼2ï¼šé€šè¿‡APIæ–‡æ¡£ï¼ˆæ¨èå¼€å‘æµ‹è¯•ï¼‰

è®¿é—® Swagger UIï¼š
```
http://localhost:8000/docs
```

æ‰¾åˆ° **"ç©ºé—²å‚¬å‘˜ç›‘æ§"** åˆ†ç»„ï¼Œæ‚¨ä¼šçœ‹åˆ°ï¼š

**æ•°æ®è®¡ç®—ç›¸å…³ï¼š**
- `POST /api/v1/idle-monitor/generate-test-data` - ç”Ÿæˆæµ‹è¯•æ•°æ®
- `POST /api/v1/idle-monitor/calculate` - åŒæ­¥è®¡ç®—
- `POST /api/v1/idle-monitor/calculate-async` - å¼‚æ­¥è®¡ç®—

**æ•°æ®æŸ¥è¯¢ç›¸å…³ï¼š**
- `GET /api/v1/idle-monitor/summary` - è·å–æ€»è§ˆæ•°æ®
- `GET /api/v1/idle-monitor/details` - è·å–è¯¦æƒ…åˆ—è¡¨
- `GET /api/v1/idle-monitor/details/{collector_id}/time-slots` - è·å–æ—¶æ®µæ˜ç»†
- `GET /api/v1/idle-monitor/trend` - è·å–è¶‹åŠ¿æ•°æ®

**é…ç½®ç®¡ç†ï¼š**
- `GET /api/v1/idle-monitor/config` - è·å–é…ç½®
- `POST /api/v1/idle-monitor/config` - åˆ›å»º/æ›´æ–°é…ç½®
- `GET /api/v1/idle-monitor/config/history` - è·å–é…ç½®å†å²

---

### æ–¹å¼3ï¼šé€šè¿‡å‘½ä»¤è¡Œè„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æ›´å–œæ¬¢å‘½ä»¤è¡Œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çš„è„šæœ¬ï¼ˆéœ€è¦å…ˆè§£å†³Pythonç¯å¢ƒé—®é¢˜ï¼‰ï¼š

```bash
# ç”Ÿæˆæµ‹è¯•æ•°æ®
python3 generate_test_idle_data.py --tenant-id 1 --collectors 5

# è®¡ç®—ç©ºé—²æ•°æ®
python3 calculate_idle_data.py --tenant-id 1 --date 2025-11-20
```

ä½†æ¨èä½¿ç”¨APIæ–¹å¼ï¼Œå› ä¸ºï¼š
- âœ… ä¸éœ€è¦æ‹…å¿ƒPythonç¯å¢ƒé—®é¢˜
- âœ… å¯ä»¥é€šè¿‡æµè§ˆå™¨ç›´æ¥è®¿é—®
- âœ… æ›´å®¹æ˜“é›†æˆåˆ°ç³»ç»Ÿä¸­
- âœ… æ”¯æŒå¼‚æ­¥æ‰§è¡Œ

---

## ğŸ¯ å®Œæ•´å·¥ä½œæµç¤ºä¾‹

### åœºæ™¯ï¼šé¦–æ¬¡ä½¿ç”¨

```bash
# 1. åˆ›å»ºæ•°æ®åº“è¡¨
cd backend
python3 create_idle_monitor_tables.py

# 2. ç”Ÿæˆä»Šå¤©çš„æµ‹è¯•æ•°æ®
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1&collector_count=5"

# 3. è®¡ç®—ç©ºé—²æ•°æ®
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1"

# 4. æŸ¥çœ‹ç»“æœ
# æ‰“å¼€æµè§ˆå™¨: http://localhost:5173
# ç™»å½• > é€‰æ‹©ç”²æ–¹ > æ•°æ®çœ‹æ¿ > ç©ºé—²å‚¬å‘˜ç›‘æ§
```

### åœºæ™¯ï¼šæ¯æ—¥è‡ªåŠ¨åŒ–

å¯ä»¥åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆcrontabï¼‰ï¼š

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨1ç‚¹è®¡ç®—æ˜¨å¤©çš„æ•°æ®
0 1 * * * curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate-async?tenant_id=1" >> /var/log/idle_calc.log 2>&1
```

---

## ğŸ“Š APIå‚æ•°è¯´æ˜

### ç”Ÿæˆæµ‹è¯•æ•°æ® API

**æ¥å£ï¼š** `POST /api/v1/idle-monitor/generate-test-data`

**å‚æ•°ï¼š**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|------|--------|
| tenant_id | int | âœ… | ç”²æ–¹ID | æ—  |
| test_date | string | âŒ | æµ‹è¯•æ—¥æœŸ(YYYY-MM-DD) | ä»Šå¤© |
| collector_count | int | âŒ | å‚¬å‘˜æ•°é‡ | 5 |

**ç¤ºä¾‹ï¼š**
```bash
# åŸºæœ¬ç”¨æ³•
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1"

# æŒ‡å®šæ—¥æœŸå’Œæ•°é‡
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1&test_date=2025-11-15&collector_count=10"
```

### è®¡ç®—ç©ºé—²æ•°æ® API

**æ¥å£ï¼š** `POST /api/v1/idle-monitor/calculate`

**å‚æ•°ï¼š**
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|------|--------|
| tenant_id | int | âœ… | ç”²æ–¹ID | æ—  |
| calc_date | string | âŒ | è®¡ç®—æ—¥æœŸ(YYYY-MM-DD) | æ˜¨å¤© |

**ç¤ºä¾‹ï¼š**
```bash
# è®¡ç®—æ˜¨å¤©
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1"

# è®¡ç®—æŒ‡å®šæ—¥æœŸ
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1&calc_date=2025-11-20"
```

### å¼‚æ­¥è®¡ç®— API

**æ¥å£ï¼š** `POST /api/v1/idle-monitor/calculate-async`

å‚æ•°åŒä¸Šï¼Œä½†ç«‹å³è¿”å›ï¼Œè®¡ç®—åœ¨åå°è¿›è¡Œã€‚

---

## ğŸ” æ•°æ®éªŒè¯

### é€šè¿‡SQLæŸ¥çœ‹ç»“æœ

```sql
-- æŸ¥çœ‹ä»Šå¤©ç”Ÿæˆçš„æµ‹è¯•æ•°æ®
SELECT 
    COUNT(*) as è®°å½•æ•°,
    DATE(contacted_at) as æ—¥æœŸ
FROM communication_records
WHERE DATE(contacted_at) = CURRENT_DATE
GROUP BY DATE(contacted_at);

-- æŸ¥çœ‹ç©ºé—²ç»Ÿè®¡
SELECT 
    c.collector_name as å‚¬å‘˜,
    s.stat_date as æ—¥æœŸ,
    s.idle_count as ç©ºé—²æ¬¡æ•°,
    s.total_idle_minutes as ç©ºé—²æ€»æ—¶é•¿,
    s.idle_rate as ç©ºé—²ç‡
FROM collector_idle_stats s
JOIN collectors c ON s.collector_id = c.id
WHERE s.stat_date = CURRENT_DATE
ORDER BY s.idle_count DESC;

-- æŸ¥çœ‹ç©ºé—²æ—¶æ®µè¯¦æƒ…
SELECT 
    c.collector_name as å‚¬å‘˜,
    r.idle_start_time as å¼€å§‹æ—¶é—´,
    r.idle_end_time as ç»“æŸæ—¶é—´,
    r.idle_duration_minutes as æ—¶é•¿
FROM collector_idle_records r
JOIN collectors c ON r.collector_id = c.id
WHERE r.idle_date = CURRENT_DATE
ORDER BY r.idle_duration_minutes DESC
LIMIT 10;
```

### é€šè¿‡APIæŸ¥çœ‹ç»“æœ

```bash
# è·å–æ€»è§ˆæ•°æ®
curl "http://localhost:8000/api/v1/idle-monitor/summary?tenant_id=1&start_date=2025-11-20&end_date=2025-11-20"

# è·å–è¯¦æƒ…åˆ—è¡¨
curl "http://localhost:8000/api/v1/idle-monitor/details?tenant_id=1&start_date=2025-11-20&end_date=2025-11-20"

# è·å–æŸä¸ªå‚¬å‘˜çš„ç©ºé—²æ—¶æ®µ
curl "http://localhost:8000/api/v1/idle-monitor/details/1/time-slots?date=2025-11-20"
```

---

## ğŸ¨ å‰ç«¯ç•Œé¢é¢„è§ˆ

è®¿é—® `http://localhost:5173`ï¼Œç™»å½•åï¼š

1. **é€‰æ‹©ç”²æ–¹**ï¼šå³ä¸Šè§’ä¸‹æ‹‰æ¡†
2. **è¿›å…¥ç©ºé—²ç›‘æ§**ï¼šæ•°æ®çœ‹æ¿ > ç©ºé—²å‚¬å‘˜ç›‘æ§
3. **æŸ¥çœ‹æ•°æ®**ï¼š
   - ğŸ“Š æ€»è§ˆå¡ç‰‡ï¼ˆç©ºé—²å‚¬å‘˜æ•°ã€ç©ºé—²æ¬¡æ•°ã€ç©ºé—²æ—¶é•¿ï¼‰
   - ğŸ“ˆ è¶‹åŠ¿å›¾è¡¨
   - ğŸ“‹ è¯¦æƒ…åˆ—è¡¨ï¼ˆå¯å±•å¼€æŸ¥çœ‹æ—¶æ®µæ˜ç»†ï¼‰
4. **ç­›é€‰æ•°æ®**ï¼š
   - æœºæ„ã€å°ç»„ã€å‚¬å‘˜
   - æ—¥æœŸèŒƒå›´
5. **é…ç½®ç®¡ç†**ï¼š
   - ç‚¹å‡»"ç©ºé—²é…ç½®"æŒ‰é’®
   - ä¿®æ”¹ç©ºé—²é˜ˆå€¼ã€ä¸Šç­æ—¶é—´ç­‰

---

## âš™ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹ç©ºé—²å®šä¹‰

é€šè¿‡APIæ›´æ–°é…ç½®ï¼š

```bash
curl -X POST "http://localhost:8000/api/v1/idle-monitor/config" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": 1,
    "config_name": "æ–°é…ç½®",
    "work_time_slots": [
      {"start": "08:30", "end": "12:00"},
      {"start": "13:30", "end": "18:00"}
    ],
    "idle_threshold_minutes": 45,
    "monitored_actions": ["call", "whatsapp", "sms", "rcs", "email"],
    "exclude_holidays": true
  }'
```

### æ‰¹é‡è®¡ç®—å¤šä¸ªç”²æ–¹

```bash
#!/bin/bash
# batch_calculate.sh

for tenant_id in 1 2 3 4 5; do
    echo "è®¡ç®—ç”²æ–¹ $tenant_id..."
    curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate-async?tenant_id=$tenant_id"
    echo ""
done
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šAPIè¿”å›404

**åŸå› **ï¼šåç«¯æœåŠ¡æœªè¿è¡Œ

**è§£å†³**ï¼š
```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### é—®é¢˜2ï¼šç”Ÿæˆæµ‹è¯•æ•°æ®å¤±è´¥

**åŸå› **ï¼šæ²¡æœ‰å‚¬å‘˜ã€æ¡ˆä»¶æˆ–è”ç³»äººæ•°æ®

**è§£å†³**ï¼š
```sql
-- æ£€æŸ¥å‚¬å‘˜æ•°é‡
SELECT COUNT(*) FROM collectors WHERE tenant_id = 1 AND is_active = true;

-- æ£€æŸ¥æ¡ˆä»¶æ•°é‡
SELECT COUNT(*) FROM cases;

-- æ£€æŸ¥è”ç³»äººæ•°é‡
SELECT COUNT(*) FROM case_contacts;
```

### é—®é¢˜3ï¼šè®¡ç®—åæ²¡æœ‰æ•°æ®

**åŸå› **ï¼š
1. é€šä¿¡è®°å½•ä¸è¶³ï¼ˆå°‘äº2æ¡ï¼‰
2. æ—¶é—´é—´éš”éƒ½å°äºé˜ˆå€¼ï¼ˆé»˜è®¤30åˆ†é’Ÿï¼‰

**è§£å†³**ï¼š
1. ç”Ÿæˆæ›´å¤šæµ‹è¯•æ•°æ®
2. é™ä½ç©ºé—²é˜ˆå€¼ï¼ˆä¿®æ”¹é…ç½®ä¸º15åˆ†é’Ÿï¼‰

---

## ğŸ“š å®Œæ•´APIæ–‡æ¡£

è®¿é—® Swagger UI æŸ¥çœ‹æ‰€æœ‰APIï¼š
```
http://localhost:8000/docs
```

æˆ–è®¿é—® ReDocï¼š
```
http://localhost:8000/redoc
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é¦–æ¬¡ä½¿ç”¨å»ºè®®

1. âœ… å…ˆç”¨é»˜è®¤é…ç½®ï¼ˆ30åˆ†é’Ÿé˜ˆå€¼ï¼‰
2. âœ… ç”Ÿæˆå°‘é‡æµ‹è¯•æ•°æ®ï¼ˆ5ä¸ªå‚¬å‘˜ï¼‰
3. âœ… è§‚å¯Ÿç»“æœï¼Œç†è§£ç®—æ³•é€»è¾‘
4. âœ… æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é…ç½®

### 2. ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. âœ… ä½¿ç”¨å¼‚æ­¥APIï¼ˆé¿å…é˜»å¡ï¼‰
2. âœ… é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©è‡ªåŠ¨è®¡ç®—ï¼‰
3. âœ… ç›‘æ§è®¡ç®—æ—¥å¿—
4. âœ… å®šæœŸå¤‡ä»½æ•°æ®

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. âœ… å¦‚æœå‚¬å‘˜å¾ˆå¤šï¼ˆ>100ï¼‰ï¼Œä½¿ç”¨å¼‚æ­¥API
2. âœ… æ‰¹é‡è®¡ç®—æ—¶ï¼Œé”™å¼€æ—¶é—´ï¼ˆé¿å…é«˜å³°ï¼‰
3. âœ… å®šæœŸæ¸…ç†å†å²æ•°æ®ï¼ˆå¦‚ä¿ç•™90å¤©ï¼‰

---

## ğŸ‰ æ€»ç»“

### æœ€ç®€å•çš„å¼€å§‹æ–¹å¼ï¼š

```bash
# 1. åˆ›å»ºè¡¨
python3 create_idle_monitor_tables.py

# 2. ç”Ÿæˆæ•°æ®
curl -X POST "http://localhost:8000/api/v1/idle-monitor/generate-test-data?tenant_id=1"

# 3. è®¡ç®—
curl -X POST "http://localhost:8000/api/v1/idle-monitor/calculate?tenant_id=1"

# 4. æŸ¥çœ‹
# æµè§ˆå™¨æ‰“å¼€: http://localhost:5173
```

### å…³é”®APIï¼š

| API | ç”¨é€” | åœ°å€ |
|-----|------|------|
| ç”Ÿæˆæµ‹è¯•æ•°æ® | å¿«é€Ÿæµ‹è¯• | POST /api/v1/idle-monitor/generate-test-data |
| åŒæ­¥è®¡ç®— | ç«‹å³è·å–ç»“æœ | POST /api/v1/idle-monitor/calculate |
| å¼‚æ­¥è®¡ç®— | åå°æ‰§è¡Œ | POST /api/v1/idle-monitor/calculate-async |
| æŸ¥çœ‹æ€»è§ˆ | è·å–ç»Ÿè®¡ | GET /api/v1/idle-monitor/summary |
| æŸ¥çœ‹è¯¦æƒ… | è·å–åˆ—è¡¨ | GET /api/v1/idle-monitor/details |

---

**çŠ¶æ€**ï¼šâœ… å®Œå…¨å°±ç»ªï¼Œç«‹å³å¯ç”¨ï¼

**æœ€åæ›´æ–°**ï¼š2025-11-20

