#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
生成产品功能点说明Excel文件
包含系统名称、产品模块、功能类别、功能描述、预估人天等信息
"""

import os
import sys
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.utils import get_column_letter
from datetime import datetime

# 添加项目根目录到路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

def create_excel():
    """创建Excel文件"""
    wb = Workbook()
    ws = wb.active
    ws.title = "产品功能点说明"
    
    # 设置表头
    headers = [
        "系统名称",
        "产品模块",
        "功能类别一",
        "功能类别二",
        "模块功能描述",
        "预估前端人天",
        "预估后端人天"
    ]
    
    # 写入表头
    for col, header in enumerate(headers, 1):
        cell = ws.cell(row=1, column=col, value=header)
        cell.font = Font(bold=True, size=12, color="FFFFFF")
        cell.fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
        cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)
        cell.border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )
    
    # 功能点数据
    features = [
        # ========== 控台端 ==========
        {
            "系统": "控台端",
            "模块": "登录认证",
            "类别一": "登录功能",
            "类别二": "",
            "描述": "管理员登录、Token管理、登出功能。参考：登录功能已实现，包含JWT认证。",
            "前端人天": 1,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "工作台/数据看板",
            "类别一": "工作台首页",
            "类别二": "",
            "描述": "工作台首页展示，欢迎页面。",
            "前端人天": 0.5,
            "后端人天": 0
        },
        {
            "系统": "控台端",
            "模块": "工作台/数据看板",
            "类别一": "单催员业绩看板",
            "类别二": "",
            "描述": "查看单个催员的业绩数据，包括应催、未还、回收率等指标。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "工作台/数据看板",
            "类别一": "空闲催员监控看板",
            "类别二": "",
            "描述": "监控空闲催员状态，实时显示空闲催员列表和统计数据。参考：空闲催员监控看板实施说明.md",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件列表",
            "类别二": "列表展示",
            "描述": "案件列表展示，支持分页、筛选、排序。使用动态字段配置展示。",
            "前端人天": 5,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件列表",
            "类别二": "筛选功能",
            "描述": "支持按甲方、队列、催员、状态等条件筛选案件。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件列表",
            "类别二": "查看催记",
            "描述": "查看案件的历史催记记录。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件详情",
            "类别二": "详情展示",
            "描述": "案件详情页面，展示案件基本信息、标准字段、自定义字段等。",
            "前端人天": 4,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件分配",
            "类别二": "",
            "描述": "手动分配案件给催员。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件状态更新",
            "类别二": "",
            "描述": "更新案件状态。",
            "前端人天": 1,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "案件统计",
            "类别二": "",
            "描述": "案件统计数据查询。",
            "前端人天": 1,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "案件管理",
            "类别一": "批量导入",
            "类别二": "",
            "描述": "批量导入案件数据。",
            "前端人天": 3,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "自动化分案",
            "类别一": "队列总览",
            "类别二": "",
            "描述": "查看案件队列总览，包括队列状态、案件分布等。",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "自动化分案",
            "类别一": "策略管理",
            "类别二": "策略列表",
            "描述": "分案策略列表展示和管理。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "自动化分案",
            "类别一": "策略管理",
            "类别二": "策略详情",
            "描述": "查看和编辑分案策略详情。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "自动化分案",
            "类别一": "策略管理",
            "类别二": "策略创建向导",
            "描述": "通过向导创建新的分案策略。",
            "前端人天": 5,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "字段配置",
            "类别一": "标准字段管理",
            "类别二": "",
            "描述": "管理系统标准字段，包括字段的增删改查。参考：系统字段功能实现说明.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "字段配置",
            "类别一": "自定义字段管理",
            "类别二": "",
            "描述": "管理自定义字段（字段映射配置）。参考：拓展字段添加完成报告.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "字段配置",
            "类别一": "字段分组管理",
            "类别二": "",
            "描述": "管理字段分组，用于字段分类展示。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "字段配置",
            "类别一": "甲方字段展示配置",
            "类别二": "",
            "描述": "配置不同甲方在不同场景下的字段展示规则。参考：甲方字段展示配置Mock数据初始化说明.md",
            "前端人天": 5,
            "后端人天": 4
        },
        {
            "系统": "控台端",
            "模块": "字段配置",
            "类别一": "甲方字段查看",
            "类别二": "",
            "描述": "查看甲方字段配置信息。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "甲方管理",
            "类别一": "甲方列表",
            "类别二": "",
            "描述": "甲方列表展示和管理。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "甲方管理",
            "类别一": "甲方字段配置",
            "类别二": "",
            "描述": "配置甲方的字段映射关系。参考：甲方字段管理重构说明.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "甲方管理",
            "类别一": "甲方案件队列管理",
            "类别二": "",
            "描述": "管理甲方的案件队列配置。参考：甲方案件队列默认配置规则.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "组织架构管理",
            "类别一": "机构管理",
            "类别二": "机构列表",
            "描述": "机构列表展示和管理，包括创建、编辑、删除机构。",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "组织架构管理",
            "类别一": "机构管理",
            "类别二": "机构作息时间",
            "描述": "配置机构的作息时间。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "组织架构管理",
            "类别一": "小组群管理",
            "类别二": "",
            "描述": "管理小组群（TeamGroup）。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "组织架构管理",
            "类别一": "小组管理",
            "类别二": "",
            "描述": "管理小组（Team），包括创建、编辑、删除小组。参考：小组管理页面筛选功能实现说明.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "组织架构管理",
            "类别一": "小组管理员管理",
            "类别二": "",
            "描述": "管理小组管理员账号。参考：小组管理账号优化说明.md",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "组织架构管理",
            "类别一": "催员管理",
            "类别二": "",
            "描述": "管理催员账号，包括创建、编辑、删除催员。",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "渠道配置",
            "类别一": "渠道发送限制配置",
            "类别二": "",
            "描述": "配置渠道发送限制规则。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "渠道配置",
            "类别一": "甲方渠道管理",
            "类别二": "",
            "描述": "管理甲方的渠道供应商配置。",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "渠道配置",
            "类别一": "Infinity外呼配置",
            "类别二": "配置管理",
            "描述": "配置Infinity外呼系统参数。参考：Infinity外呼系统集成完成报告.md",
            "前端人天": 5,
            "后端人天": 4
        },
        {
            "系统": "控台端",
            "模块": "渠道配置",
            "类别一": "Infinity外呼配置",
            "类别二": "拓展字段管理",
            "描述": "管理Infinity拓展字段。参考：Infinity配置字段优化说明.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "还款渠道管理",
            "类别一": "还款渠道配置",
            "类别二": "渠道列表",
            "描述": "还款渠道列表展示和管理。参考：PRD需求文档/CCO管理控台/甲方还款渠道配置管理.md",
            "前端人天": 4,
            "后端人天": 3
        },
        {
            "系统": "控台端",
            "模块": "还款渠道管理",
            "类别一": "还款渠道配置",
            "类别二": "渠道表单",
            "描述": "创建和编辑还款渠道配置表单，包括API配置、认证配置等。参考：PRD需求文档/CCO管理控台/甲方还款渠道配置管理.md",
            "前端人天": 5,
            "后端人天": 4
        },
        {
            "系统": "控台端",
            "模块": "还款渠道管理",
            "类别一": "还款渠道配置",
            "类别二": "拖拽排序",
            "描述": "支持拖拽排序还款渠道显示顺序。参考：PRD需求文档/CCO管理控台/甲方还款渠道配置管理.md",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "系统管理",
            "类别一": "权限配置",
            "类别二": "",
            "描述": "配置不同角色的权限。参考：权限系统使用指南.md",
            "前端人天": 6,
            "后端人天": 4
        },
        {
            "系统": "控台端",
            "模块": "系统管理",
            "类别一": "权限查看",
            "类别二": "",
            "描述": "查看权限矩阵和权限配置。参考：权限系统使用指南.md",
            "前端人天": 3,
            "后端人天": 1
        },
        {
            "系统": "控台端",
            "模块": "系统管理",
            "类别一": "通知配置",
            "类别二": "通知模板配置",
            "描述": "配置通知模板。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "系统管理",
            "类别一": "通知配置",
            "类别二": "通知维度配置",
            "描述": "配置通知的触发维度和规则。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "控台端",
            "模块": "系统管理",
            "类别一": "通知配置",
            "类别二": "公共通知配置",
            "描述": "配置公共通知。",
            "前端人天": 2,
            "后端人天": 1
        },
        
        # ========== IM端 ==========
        {
            "系统": "IM端",
            "模块": "登录认证",
            "类别一": "登录功能",
            "类别二": "",
            "描述": "催员登录功能，支持机构ID、催员ID、密码登录。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "登录认证",
            "类别一": "人脸识别",
            "类别二": "人脸检测",
            "描述": "登录时进行人脸检测，获取人脸ID。参考：催员登录人脸识别功能实现说明.md",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "登录认证",
            "类别一": "人脸识别",
            "类别二": "人脸验证",
            "描述": "验证人脸ID是否有效。参考：催员登录人脸识别功能实现说明.md",
            "前端人天": 1,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "登录认证",
            "类别一": "验证码",
            "类别二": "",
            "描述": "登录时显示验证码，防止暴力破解。",
            "前端人天": 1,
            "后端人天": 0.5
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "案件列表",
            "类别二": "列表展示",
            "描述": "催员工作台左侧案件列表，显示分配给当前催员的案件。",
            "前端人天": 4,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "案件列表",
            "类别二": "筛选功能",
            "描述": "支持按状态、逾期天数等条件筛选案件。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "案件列表",
            "类别二": "未读消息标识",
            "描述": "在案件列表中显示未读消息标识。",
            "前端人天": 1,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "案件详情",
            "类别二": "详情展示",
            "描述": "案件详情面板，展示案件基本信息、字段信息等。使用动态字段配置。",
            "前端人天": 5,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "数据看板",
            "类别二": "核心数据展示",
            "描述": "工作台顶部数据入口，悬停显示核心数据（排名、应催、未还、回收率等）。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "通知中心",
            "类别二": "通知列表",
            "描述": "通知中心，显示各类通知（案件待回复、催办机制、案件更新等）。",
            "前端人天": 4,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "通知中心",
            "类别二": "通知筛选",
            "描述": "支持按通知类型筛选通知。",
            "前端人天": 1,
            "后端人天": 0.5
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "通知中心",
            "类别二": "通知已读标记",
            "描述": "标记通知为已读，支持单个和全部标记。",
            "前端人天": 1,
            "后端人天": 0.5
        },
        {
            "系统": "IM端",
            "模块": "工作台",
            "类别一": "时区显示",
            "类别二": "",
            "描述": "显示催员时区和客户时区。",
            "前端人天": 1,
            "后端人天": 0.5
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "联系人管理",
            "类别二": "联系人列表",
            "描述": "显示案件的联系人列表，支持筛选和搜索。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "联系人管理",
            "类别二": "新增联系人",
            "描述": "为案件新增联系人。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "联系人管理",
            "类别二": "联系人筛选",
            "描述": "支持按联系人类型、沟通状态等筛选联系人。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "渠道管理",
            "类别二": "渠道Tab切换",
            "描述": "支持在不同渠道（短信、WhatsApp、电话等）之间切换。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息发送",
            "类别二": "文本消息",
            "描述": "发送文本消息给客户。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息发送",
            "类别二": "图片消息",
            "描述": "发送图片消息给客户。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息发送",
            "类别二": "批量发送",
            "描述": "批量发送消息给多个案件。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息接收",
            "类别二": "",
            "描述": "接收客户回复的消息，实时更新聊天记录。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息展示",
            "类别二": "会话聚合",
            "描述": "聚合显示所有渠道的会话消息。",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息展示",
            "类别二": "消息列表",
            "描述": "按时间顺序展示消息列表，区分发送和接收。",
            "前端人天": 3,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "消息展示",
            "类别二": "未读消息标识",
            "描述": "标识未读消息，支持标记已读。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "通信记录",
            "类别二": "",
            "描述": "查看历史通信记录（催记）。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "聊天功能",
            "类别一": "电话状态",
            "类别二": "",
            "描述": "显示联系人的电话拨打状态（未拨打、已接通、从未接通等）。",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码请求",
            "类别二": "渠道选择",
            "描述": "选择还款渠道（VA码、H5链接、二维码）。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码请求",
            "类别二": "金额输入",
            "描述": "输入还款金额，选择期数。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码请求",
            "类别二": "还款码展示",
            "描述": "展示生成的还款码（VA码、H5链接、二维码）。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码列表",
            "类别二": "",
            "描述": "显示历史还款码记录列表。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 3,
            "后端人天": 2
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码详情",
            "类别二": "",
            "描述": "查看还款码详情，包括状态、有效期等。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 2,
            "后端人天": 1
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码操作",
            "类别二": "复制功能",
            "描述": "复制还款码（VA码、H5链接）。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 1,
            "后端人天": 0
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码操作",
            "类别二": "分享功能",
            "描述": "分享还款码给客户。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 1,
            "后端人天": 0
        },
        {
            "系统": "IM端",
            "模块": "还款码管理",
            "类别一": "还款码操作",
            "类别二": "倒计时显示",
            "描述": "显示还款码有效期倒计时。参考：PRD需求文档/CCO催员IM端/还款码管理功能.md",
            "前端人天": 2,
            "后端人天": 0.5
        },
    ]
    
    # 写入数据
    row = 2
    for feature in features:
        ws.cell(row=row, column=1, value=feature["系统"])
        ws.cell(row=row, column=2, value=feature["模块"])
        ws.cell(row=row, column=3, value=feature["类别一"])
        ws.cell(row=row, column=4, value=feature["类别二"])
        ws.cell(row=row, column=5, value=feature["描述"])
        ws.cell(row=row, column=6, value=feature["前端人天"])
        ws.cell(row=row, column=7, value=feature["后端人天"])
        
        # 设置样式
        for col in range(1, 8):
            cell = ws.cell(row=row, column=col)
            cell.alignment = Alignment(horizontal="left", vertical="center", wrap_text=True)
            cell.border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )
            
            # 系统名称列使用不同背景色
            if col == 1:
                if feature["系统"] == "控台端":
                    cell.fill = PatternFill(start_color="E7F3FF", end_color="E7F3FF", fill_type="solid")
                else:
                    cell.fill = PatternFill(start_color="FFF4E6", end_color="FFF4E6", fill_type="solid")
        
        row += 1
    
    # 设置列宽
    ws.column_dimensions['A'].width = 12
    ws.column_dimensions['B'].width = 25
    ws.column_dimensions['C'].width = 20
    ws.column_dimensions['D'].width = 20
    ws.column_dimensions['E'].width = 60
    ws.column_dimensions['F'].width = 15
    ws.column_dimensions['G'].width = 15
    
    # 设置行高
    ws.row_dimensions[1].height = 30
    for r in range(2, row):
        ws.row_dimensions[r].height = 40
    
    # 冻结首行
    ws.freeze_panes = 'A2'
    
    # 保存文件
    output_dir = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), "PRD需求文档")
    os.makedirs(output_dir, exist_ok=True)
    
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"产品功能点说明_{timestamp}.xlsx"
    filepath = os.path.join(output_dir, filename)
    
    wb.save(filepath)
    print(f"✅ Excel文件已生成: {filepath}")
    print(f"   共 {len(features)} 个功能点")
    
    # 统计信息
    frontend_total = sum(f["前端人天"] for f in features)
    backend_total = sum(f["后端人天"] for f in features)
    print(f"\n📊 统计信息:")
    print(f"   前端总人天: {frontend_total:.1f}")
    print(f"   后端总人天: {backend_total:.1f}")
    print(f"   总计: {frontend_total + backend_total:.1f} 人天")
    
    return filepath

if __name__ == "__main__":
    try:
        create_excel()
    except Exception as e:
        print(f"❌ 生成Excel文件失败: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

