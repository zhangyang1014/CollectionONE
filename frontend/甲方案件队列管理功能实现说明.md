# 甲方案件队列管理功能实现说明

## 📋 功能概述

甲方案件队列管理功能用于配置每个甲方的案件队列，根据逾期天数自动分类案件，便于催收团队分级管理。

## 🎯 核心功能

### 1. 队列配置

**字段说明：**
- **队列编码**：队列的唯一标识（如：C、S0、S1、L1、M1）
- **队列名称**：队列的显示名称（如：C队列、S1队列）
- **逾期天数范围**：起始天数 ~ 结束天数
  - 不填写开始天数 = 负无穷（-∞）
  - 不填写结束天数 = 正无穷（+∞）
- **排序**：队列的显示顺序
- **状态**：启用/禁用

### 2. 默认队列配置

新建甲方时，系统自动创建5个标准队列：

| 队列编码 | 队列名称 | 逾期天数范围 | 说明 |
|---------|---------|------------|------|
| **C** | C队列 | **-∞ ~ -1** | 未逾期，提前还款客户 |
| **S0** | S0队列 | **0 ~ 0** | 当日到期，需重点关注 |
| **S1** | S1队列 | **1 ~ 5** | 轻度逾期，友好提醒 |
| **L1** | L1队列 | **6 ~ 90** | 中度逾期，加强催收 |
| **M1** | M1队列 | **91 ~ +∞** | 重度逾期，专项处理 |

**详细规则请参考：** `甲方案件队列默认配置规则.md`

### 3. 验证规则

#### 3.1 范围不可重合

添加或编辑队列时，系统会自动检查逾期天数范围是否与其他队列重合：

```
示例1：合法的配置
C队列:  -∞ ~ -1
S0队列: 0 ~ 0
S1队列: 1 ~ 5
L1队列: 6 ~ 90
M1队列: 91 ~ +∞

✅ 无重合，配置有效
```

```
示例2：非法的配置
S1队列: 1 ~ 5
S2队列: 3 ~ 7   ← 与S1队列重合（3、4、5天重复）

❌ 有重合，保存失败
提示：逾期天数范围与队列"S1队列"重合，请调整范围
```

#### 3.2 范围合法性

```javascript
// 如果都不为NULL，开始天数不能大于结束天数
开始: 10, 结束: 5  ❌ 非法

// 至少有一个边界
开始: NULL, 结束: NULL  ❌ 非法（不能两个都为无穷大）
```

## 💻 技术实现

### 1. 前端页面

**文件：** `frontend/src/views/tenant-management/QueueManagement.vue`

**主要功能：**
- ✅ 选择甲方
- ✅ 队列列表展示
- ✅ 添加队列
- ✅ 编辑队列
- ✅ 删除队列
- ✅ 范围合法性验证
- ✅ 范围重合检测
- ✅ 支持负无穷/正无穷

**核心代码片段：**

```vue
<!-- 逾期天数范围输入 -->
<el-form-item label="逾期天数范围" required>
  <div style="display: flex; gap: 10px; align-items: center;">
    <!-- 开始天数 -->
    <div>
      <el-input-number 
        v-model="form.overdue_days_start" 
        :disabled="form.start_infinity"
        placeholder="开始"
      />
      <el-checkbox v-model="form.start_infinity">
        负无穷（-∞）
      </el-checkbox>
    </div>
    
    <span>~</span>
    
    <!-- 结束天数 -->
    <div>
      <el-input-number 
        v-model="form.overdue_days_end" 
        :disabled="form.end_infinity"
        placeholder="结束"
      />
      <el-checkbox v-model="form.end_infinity">
        正无穷（+∞）
      </el-checkbox>
    </div>
  </div>
</el-form-item>
```

**范围重合检测逻辑：**

```typescript
const checkRangeOverlap = (
  start1: number | null, 
  end1: number | null, 
  start2: number | null, 
  end2: number | null
) => {
  // 将NULL转换为无穷大/小
  const s1 = start1 === null ? Number.NEGATIVE_INFINITY : start1
  const e1 = end1 === null ? Number.POSITIVE_INFINITY : end1
  const s2 = start2 === null ? Number.NEGATIVE_INFINITY : start2
  const e2 = end2 === null ? Number.POSITIVE_INFINITY : end2

  // 两个区间重合的条件：s1 <= e2 && s2 <= e1
  return s1 <= e2 && s2 <= e1
}
```

### 2. 后端Mock API

**文件：** `backend/simple_server.py`

**API接口：** `GET /api/v1/tenants/{tenant_id}/queues`

**返回数据：**
```json
{
  "data": [
    {
      "id": 101,
      "tenant_id": 1,
      "queue_code": "C",
      "queue_name": "C队列",
      "overdue_days_start": null,  // -∞
      "overdue_days_end": -1,
      "sort_order": 1,
      "is_active": true,
      "created_at": "2025-01-01T00:00:00",
      "updated_at": "2025-01-01T00:00:00"
    },
    // ... 其他队列
  ]
}
```

**默认队列生成函数：**

```python
def get_default_queues(tenant_id):
    """获取甲方的默认队列配置"""
    return [
        {
            "queue_code": "C",
            "queue_name": "C队列",
            "overdue_days_start": None,  # -∞
            "overdue_days_end": -1,
            "sort_order": 1,
            "is_active": True
        },
        # ... 其他队列
    ]
```

### 3. 路由配置

**文件：** `frontend/src/router/index.ts`

```typescript
{
  path: 'tenants/queue-management',
  name: 'QueueManagement',
  component: () => import('@/views/tenant-management/QueueManagement.vue'),
  meta: { title: '甲方案件队列管理' },
}
```

## 🎨 界面展示

### 队列列表

```
┌──────────────────────────────────────────────────────────────┐
│  甲方案件队列管理    [示例甲方A ▼]  [添加队列]              │
├──────────────────────────────────────────────────────────────┤
│  📢 说明：队列用于根据逾期天数自动分类案件。逾期天数范围   │
│     不可重合。不填写开始/结束代表无穷大（-∞ 或 +∞）。      │
├──────────────────────────────────────────────────────────────┤
│  队列编码 │ 队列名称 │ 逾期天数范围    │ 排序 │ 状态 │ 操作 │
│──────────┼─────────┼────────────────┼─────┼─────┼──────│
│  C       │ C队列   │ -∞ ~ -1 天     │  1  │ 启用 │ 编辑 删除 │
│  S0      │ S0队列  │ 0 ~ 0 天       │  2  │ 启用 │ 编辑 删除 │
│  S1      │ S1队列  │ 1 ~ 5 天       │  3  │ 启用 │ 编辑 删除 │
│  L1      │ L1队列  │ 6 ~ 90 天      │  4  │ 启用 │ 编辑 删除 │
│  M1      │ M1队列  │ 91 ~ +∞ 天     │  5  │ 启用 │ 编辑 删除 │
└──────────────────────────────────────────────────────────────┘
```

### 添加/编辑对话框

```
┌─────────────────────────────────────────────────────┐
│  添加队列                                           │
├─────────────────────────────────────────────────────┤
│  队列编码：  [M2______________]                     │
│                                                     │
│  队列名称：  [M2队列__________]                     │
│                                                     │
│  逾期天数范围：                                     │
│  ┌──────────────┐              ┌──────────────┐   │
│  │ 开始天数     │      ~       │ 结束天数     │   │
│  ├──────────────┤              ├──────────────┤   │
│  │ [31____] 天  │              │ [60____] 天  │   │
│  │ □ 负无穷(-∞) │              │ □ 正无穷(+∞) │   │
│  └──────────────┘              └──────────────┘   │
│                                                     │
│  示例：C队列(-∞ ~ -1), S0队列(0 ~ 0), M1队列(91 ~ +∞)│
│                                                     │
│  排序：  [6__]                                      │
│  建议按逾期天数从小到大排序                          │
│                                                     │
│  是否启用：  [√]                                    │
│                                                     │
│                         [取消]  [保存]              │
└─────────────────────────────────────────────────────┘
```

## 🧪 测试场景

### 场景1：查看默认队列

**步骤：**
1. 刷新页面
2. 进入：甲方管理 → 甲方案件队列管理
3. 选择甲方"示例甲方A"

**预期结果：**
- ✅ 显示5个默认队列（C, S0, S1, L1, M1）
- ✅ 范围连续覆盖 -∞ 到 +∞
- ✅ 所有队列状态为"启用"

### 场景2：添加新队列（合法）

**步骤：**
1. 点击"添加队列"
2. 输入：
   - 队列编码：M2
   - 队列名称：M2队列
   - 逾期天数范围：31 ~ 60
   - 排序：6
3. 点击"保存"

**预期结果：**
- ✅ 保存成功提示
- ✅ 队列列表中显示新队列
- ❗ 注意：此时L1和M1之间有间隙（91以上未覆盖）

### 场景3：添加新队列（范围重合）

**步骤：**
1. 点击"添加队列"
2. 输入：
   - 队列编码：S2
   - 逾期天数范围：3 ~ 7（与S1队列1~5重合）
3. 点击"保存"

**预期结果：**
- ❌ 显示警告："逾期天数范围与队列'S1队列'重合，请调整范围"
- ❌ 不允许保存

### 场景4：使用负无穷

**步骤：**
1. 点击"编辑" C队列
2. 勾选"负无穷（-∞）"
3. 结束天数：-1

**预期结果：**
- ✅ 开始天数输入框禁用
- ✅ 范围显示为：-∞ ~ -1 天
- ✅ 保存成功

### 场景5：使用正无穷

**步骤：**
1. 点击"编辑" M1队列
2. 开始天数：91
3. 勾选"正无穷（+∞）"

**预期结果：**
- ✅ 结束天数输入框禁用
- ✅ 范围显示为：91 ~ +∞ 天
- ✅ 保存成功

### 场景6：删除队列

**步骤：**
1. 点击某个队列的"删除"按钮
2. 在确认对话框中点击"确定"

**预期结果：**
- ✅ 显示确认对话框："确定要删除队列'XXX'吗？删除后该队列下的案件将无法归类。"
- ✅ 删除成功后，队列从列表中移除
- ⚠️ 警告：删除队列会影响案件归类

## 📁 相关文件

### 文档

- ✅ `甲方案件队列默认配置规则.md` - 默认配置规则详细说明
- ✅ `frontend/甲方案件队列管理功能实现说明.md` - 本文档

### 代码

- ✅ `frontend/src/views/tenant-management/QueueManagement.vue` - 队列管理页面
- ✅ `frontend/src/router/index.ts` - 路由配置
- ✅ `backend/simple_server.py` - Mock API服务器

## 🔍 后续对接真实后端

### 1. 数据库表设计

```sql
CREATE TABLE case_queues (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '所属甲方ID',
    queue_code VARCHAR(50) NOT NULL COMMENT '队列编码',
    queue_name VARCHAR(100) NOT NULL COMMENT '队列名称',
    overdue_days_start INT COMMENT '逾期天数开始（NULL表示负无穷）',
    overdue_days_end INT COMMENT '逾期天数结束（NULL表示正无穷）',
    sort_order INT DEFAULT 0 COMMENT '排序',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_tenant_code (tenant_id, queue_code),
    FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

### 2. API接口实现

```python
@router.get("/{tenant_id}/queues")
def get_tenant_queues(tenant_id: int, db: Session = Depends(get_db)):
    """获取甲方的队列配置"""
    queues = db.query(CaseQueue).filter(
        CaseQueue.tenant_id == tenant_id
    ).order_by(CaseQueue.sort_order).all()
    return {"data": queues}

@router.post("/{tenant_id}/queues")
def create_queue(
    tenant_id: int,
    data: QueueCreate,
    db: Session = Depends(get_db)
):
    """创建队列，验证范围不重合"""
    # 1. 验证范围合法性
    validate_range_values(data.overdue_days_start, data.overdue_days_end)
    
    # 2. 检查范围是否重合
    existing_queues = db.query(CaseQueue).filter(
        CaseQueue.tenant_id == tenant_id,
        CaseQueue.is_active == True
    ).all()
    
    for queue in existing_queues:
        if check_range_overlap(
            data.overdue_days_start, data.overdue_days_end,
            queue.overdue_days_start, queue.overdue_days_end
        ):
            raise HTTPException(
                status_code=400,
                detail=f"逾期天数范围与队列 {queue.queue_name} 重合"
            )
    
    # 3. 创建队列
    queue = CaseQueue(tenant_id=tenant_id, **data.dict())
    db.add(queue)
    db.commit()
    return {"data": queue}
```

## ⚠️ 注意事项

### 1. 数据一致性

- 删除队列前应检查是否有案件关联
- 建议软删除（设置 `is_active = False`）而非物理删除

### 2. 业务影响

- 修改队列范围会影响案件的自动归类
- 建议在业务低峰期进行队列调整

### 3. 完整性建议

- 队列范围应覆盖所有可能的逾期天数
- 建议保留默认的5个队列，在此基础上扩展

## ✅ 验证清单

功能测试完成后，请确认：

- [ ] Mock服务器已重启
- [ ] API返回默认5个队列
- [ ] 页面能正常显示队列列表
- [ ] 能选择不同甲方切换数据
- [ ] 添加队列功能正常
- [ ] 编辑队列功能正常
- [ ] 删除队列功能正常（带确认）
- [ ] 范围重合检测有效
- [ ] 负无穷（-∞）功能正常
- [ ] 正无穷（+∞）功能正常
- [ ] 范围格式化显示正确
- [ ] 所有表单验证有效
- [ ] 没有JavaScript错误

**全部通过 ✅ = 功能实现成功！**

---

**实现日期：** 2024-11-11  
**版本：** v1.0  
**状态：** ✅ 已完成

