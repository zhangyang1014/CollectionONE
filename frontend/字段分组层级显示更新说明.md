# 字段分组层级显示更新说明

## 📋 更新时间
2024-11-11

## 🎯 更新目标

在"字段分组管理"页面中，清晰展示分组的层级从属关系：
- **一级分组**：客户基础信息、贷款详情、借款记录等
- **二级分组**（子分组）：
  - 客户基础信息 → 基础身份信息、教育信息、职业信息、用户行为与信用

## ✅ 已完成的功能

### 1. 树形结构显示

**从表格改为树形展示：**
- ✅ 使用 `el-tree` 组件替代原有的 `el-table`
- ✅ 清晰显示一级分组和子分组的层级关系
- ✅ 默认展开所有节点，便于查看完整结构
- ✅ 通过缩进和左侧边线体现层级关系

### 2. 视觉区分

**一级分组：**
- 蓝色"一级分组"标签
- 可展开/折叠子分组
- 显示"添加子分组"按钮

**子分组：**
- 灰色"子分组"标签
- 缩进显示，带左侧蓝色边线
- 白色背景区分

### 3. 拖拽排序功能

**智能拖拽控制：**
- ✅ 支持同级节点之间拖拽调整顺序
- ✅ **只允许同级拖拽**（一级分组之间、同一父分组下的子分组之间）
- ✅ 不允许跨层级拖拽（保持树形结构完整性）
- ✅ 不允许拖入成为子节点
- ✅ 拖拽后自动更新排序

### 4. 完整的CRUD操作

**添加功能：**
- ✅ "添加一级分组"按钮 - 创建顶级分组
- ✅ "添加子分组"按钮 - 为选中的一级分组添加子分组
- ✅ 每个一级分组节点上都有"添加子分组"操作

**编辑功能：**
- ✅ 编辑分组名称、标识、英文名称
- ✅ 可修改父分组（调整层级）
- ✅ 可调整排序顺序

**删除功能：**
- ✅ 删除一级分组时提示会删除所有子分组
- ✅ 删除确认对话框

### 5. 信息展示

每个分组节点显示：
- ✅ 分组级别标签（一级分组/子分组）
- ✅ 分组名称（如：客户基础信息）
- ✅ 分组标识（如：customer_basic）
- ✅ 排序序号
- ✅ 操作按钮（编辑、添加子分组、删除）

## 🎨 界面效果

### 树形结构示例

```
📂 客户基础信息 (customer_basic) [一级分组] 排序: 1
  ├─ 📄 基础身份信息 (identity_info) [子分组] 排序: 1
  ├─ 📄 教育信息 (education) [子分组] 排序: 2
  ├─ 📄 职业信息 (employment) [子分组] 排序: 3
  └─ 📄 用户行为与信用 (user_behavior) [子分组] 排序: 4

📂 贷款详情 (loan_details) [一级分组] 排序: 2

📂 借款记录 (borrowing_records) [一级分组] 排序: 3

📂 还款记录 (repayment_records) [一级分组] 排序: 4

📂 分期详情 (installment_details) [一级分组] 排序: 5
```

### 视觉特征

1. **一级分组**：
   - 蓝色背景标签
   - 可展开/折叠
   - 粗体显示
   - 灰色背景

2. **子分组**：
   - 灰色标签
   - 缩进20px
   - 左侧蓝色边线
   - 白色背景

3. **交互反馈**：
   - 鼠标悬停：浅蓝色背景
   - 拖拽时：虚线边框提示
   - 点击节点：高亮选中

## 🔧 技术实现

### 组件结构

```vue
<el-tree
  :data="treeData"                    // 树形数据
  node-key="id"                       // 节点唯一标识
  default-expand-all                   // 默认展开
  draggable                           // 启用拖拽
  :allow-drop="allowDrop"             // 拖拽控制
  @node-drop="handleDrop"             // 拖拽完成
  @node-click="handleNodeClick"       // 节点点击
>
  <template #default="{ node, data }">
    <!-- 自定义节点模板 -->
  </template>
</el-tree>
```

### 数据处理

**构建树形结构：**
```typescript
const buildTree = (data: FieldGroup[]): TreeNode[] => {
  // 1. 创建节点映射
  const map: { [key: number]: TreeNode } = {}
  
  // 2. 构建父子关系
  data.forEach(item => {
    if (item.parent_id && map[item.parent_id]) {
      map[item.parent_id].children.push(map[item.id])
    } else {
      roots.push(map[item.id])
    }
  })
  
  // 3. 按sort_order排序
  sortNodes(roots)
  
  return roots
}
```

**拖拽控制：**
```typescript
const allowDrop = (draggingNode, dropNode, type) => {
  // 只允许同级拖拽
  if (type === 'inner') return false
  
  const draggingParentId = draggingNode.data.parent_id || null
  const dropParentId = dropNode.data.parent_id || null
  
  return draggingParentId === dropParentId
}
```

## 📂 当前分组结构

根据mock数据，系统有以下分组结构：

### 一级分组（5个）

1. **客户基础信息** (customer_basic)
   - 基础身份信息 (identity_info)
   - 教育信息 (education)
   - 职业信息 (employment)
   - 用户行为与信用 (user_behavior)

2. **贷款详情** (loan_details)

3. **借款记录** (borrowing_records)

4. **还款记录** (repayment_records)

5. **分期详情** (installment_details)

### 总计
- 一级分组：5个
- 二级分组：4个
- 总分组数：9个

## 💡 使用指南

### 查看分组层级

1. 进入"字段配置" → "字段分组管理"
2. 页面自动展开所有分组
3. 一级分组带展开/折叠图标
4. 子分组缩进显示，带左侧边线

### 调整分组顺序

**同级拖拽：**
1. 鼠标按住分组节点
2. 拖动到目标位置（同级节点前后）
3. 释放鼠标，自动保存新顺序

**限制：**
- ❌ 不能将一级分组拖入另一个分组
- ❌ 不能将子分组拖到其他父分组下
- ✅ 只能在同级之间调整顺序

### 添加分组

**添加一级分组：**
1. 点击页面右上角"添加一级分组"
2. 填写分组信息
3. 保存

**添加子分组：**
1. 点击一级分组节点
2. 点击"添加子分组"按钮
3. 或点击一级分组节点上的"添加子分组"操作
4. 填写子分组信息
5. 保存

### 编辑分组

1. 点击分组节点的"编辑"按钮
2. 修改分组信息
3. 可修改父分组（调整层级）
4. 保存

### 删除分组

1. 点击"删除"按钮
2. 确认删除
3. 如果是一级分组，会提示删除所有子分组

## ⚠️ 注意事项

1. **层级限制**：目前只支持两级分组（一级分组+子分组）
2. **拖拽限制**：只能在同级节点间拖拽，保持树形结构稳定
3. **删除警告**：删除一级分组会同时删除所有子分组
4. **排序自动更新**：拖拽后排序会自动重新计算

## 🔄 后续优化

1. ✅ 树形结构展示 - 已完成
2. ✅ 拖拽排序 - 已完成
3. ✅ 添加/编辑/删除 - 已完成
4. 🔲 API对接 - 待实现
5. 🔲 批量操作 - 待实现
6. 🔲 分组图标自定义 - 待实现

---

**更新人员**: AI Assistant  
**更新日期**: 2024-11-11  
**状态**: ✅ 已完成

