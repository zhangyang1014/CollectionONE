# 案件列表筛选器优化变更说明

**变更日期**: 2025-12-04  
**变更版本**: v1.2  
**变更人**: AI Assistant

---

## 一、变更需求

根据产品需求,对案件列表的筛选条件进行布局优化和功能增强:

1. **筛选条件布局优化**: 将筛选条件重新组织为两排紧凑布局,提升用户体验和节省空间
2. **新增小组群筛选**: 添加催收小组群级别的筛选条件
3. **优化范围筛选交互**: 改进到期日范围和逾期天数范围的输入交互

---

## 二、PRD文档更新

### 文件: `/PRD需求文档/CCO管理控台/案件管理/案件列表功能PRD.md`

**主要变更内容:**

#### 1. 筛选规则 (第177-212行)

**新的筛选条件布局:**

```
【第一排】案件状态、案件队列、到期日范围、逾期天数范围
【第二排】催收机构、催收小组群、催收小组、催员
```

**筛选条件联动规则:**
- 选择机构 → 自动加载该机构的小组群列表
- 选择小组群 → 自动加载该小组群的小组列表
- 选择小组 → 自动加载该小组的催员列表
- 清空上级筛选条件时，自动清空下级筛选条件

#### 2. 范围筛选优化 (第186-202行)

**到期日范围:**
- 使用日期范围选择器组件
- 支持快捷选择：今天、最近7天、最近30天、自定义
- 格式：YYYY-MM-DD

**逾期天数范围:**
- 使用数字范围输入组件
- 最小值输入框 + "至" + 最大值输入框
- 支持只填写最小值（表示>=）或只填写最大值（表示<=）
- 自动验证：最小值不能大于最大值

#### 3. 筛选流程 (第89-118行)

更新为三排筛选流程，明确每排的筛选条件和操作流程。

#### 4. 数据字段 (第330-351行)

新增筛选条件字段：

| 字段名 | 类型 | 说明 | 所在排 |
|--------|------|------|--------|
| team_group_id | Long | 小组群ID | 第二排 |
| overdue_days_min | Integer | 逾期天数最小值 | 第三排 |
| overdue_days_max | Integer | 逾期天数最大值 | 第三排 |

#### 5. 交互与信息展示 (第362-405行)

更新筛选器UI描述，详细说明三排布局的交互方式。

#### 6. 接口设计 (第528-576行)

**新增接口:**
- 获取小组群列表接口: `GET /api/v1/organization/team-groups`

**更新接口:**
- 获取小组列表接口: 支持 `team_group_id` 参数

**案件列表接口参数更新:**
- 新增: `team_group_id`、`overdue_days_min`、`overdue_days_max`

---

## 三、前端代码更新

### 文件: `/frontend/src/views/case-management/CaseList.vue`

#### 1. 模板变更

**重新组织筛选器布局为两排:**

```vue
<!-- 第一排：案件状态、案件队列、到期日范围、逾期天数范围 -->
<el-row :gutter="20">
  <el-col :span="6">案件状态</el-col>
  <el-col :span="6">案件队列</el-col>
  <el-col :span="6">到期日范围（日期范围选择器）</el-col>
  <el-col :span="6">逾期天数范围（数字范围输入）</el-col>
</el-row>

<!-- 第二排：催收机构、催收小组群、催收小组、催员 -->
<el-row :gutter="20">
  <el-col :span="6">催收机构</el-col>
  <el-col :span="6">催收小组群</el-col>
  <el-col :span="6">催收小组</el-col>
  <el-col :span="6">催员</el-col>
</el-row>
```

**优化点:**
1. ✅ 筛选器从三排优化为两排，更加紧凑
2. ✅ 新增小组群选择器（依赖机构）
3. ✅ 到期日范围添加快捷选择（今天、最近7天、最近30天）
4. ✅ 逾期天数范围使用数字范围输入（最小值 ~ 最大值）
5. ✅ 第一排4个独立筛选条件，第二排4个级联筛选条件，逻辑清晰

#### 2. Script变更

**新增数据定义:**

```typescript
const teamGroups = ref<any[]>([])  // 小组群列表

const filters = ref({
  // ... 原有字段
  team_group_id?: number,     // ✅ 新增：小组群ID
  overdue_days_min?: number,  // ✅ 新增：逾期天数最小值
  overdue_days_max?: number,  // ✅ 新增：逾期天数最大值
})

// ✅ 新增：到期日快捷选择选项
const dueDateShortcuts = [
  { text: '今天', value: () => [today, today] },
  { text: '最近7天', value: () => [start, end] },
  { text: '最近30天', value: () => [start, end] }
]
```

**新增方法:**

```typescript
// ✅ 加载小组群列表
const loadTeamGroups = async () => {
  if (!filters.value.agency_id) {
    teamGroups.value = []
    return
  }
  
  try {
    const response = await getAgencyTeamGroups(filters.value.agency_id)
    teamGroups.value = Array.isArray(response) ? response : (response.data || [])
  } catch (error) {
    console.error('加载小组群失败:', error)
  }
}

// ✅ 处理小组群变更
const handleTeamGroupChange = () => {
  // 清空下级筛选条件
  filters.value.team_id = undefined
  filters.value.collector_id = undefined
  teams.value = []
  collectors.value = []
  // 加载小组
  loadTeams()
  handleQuery()
}
```

**更新方法:**

```typescript
// ✅ 修改：加载小组列表（支持小组群参数）
const loadTeams = async () => {
  if (!filters.value.team_group_id && !filters.value.agency_id) {
    teams.value = []
    return
  }
  
  try {
    let response
    if (filters.value.team_group_id) {
      // 如果选择了小组群，加载小组群下的小组
      response = await getTeamGroupTeams(filters.value.team_group_id)
    } else if (filters.value.agency_id) {
      // 如果只选择了机构，加载机构下的所有小组
      response = await getAgencyTeams(filters.value.agency_id)
    }
    teams.value = Array.isArray(response) ? response : (response.data || [])
  } catch (error) {
    console.error('加载小组失败:', error)
  }
}

// ✅ 修改：处理机构变更
const handleAgencyChange = () => {
  // 清空下级筛选条件（包括小组群）
  filters.value.team_group_id = undefined
  filters.value.team_id = undefined
  filters.value.collector_id = undefined
  teamGroups.value = []
  teams.value = []
  collectors.value = []
  // 加载小组群
  loadTeamGroups()
  handleQuery()
}

// ✅ 修改：加载案件数据（添加新筛选参数）
const loadCases = async () => {
  // ... 
  
  // 第二排筛选条件（组织架构）
  if (filters.value.agency_id) {
    params.agency_id = filters.value.agency_id
  }
  if (filters.value.team_group_id) {
    params.team_group_id = filters.value.team_group_id
  }
  if (filters.value.team_id) {
    params.team_id = filters.value.team_id
  }
  if (filters.value.collector_id) {
    params.collector_id = filters.value.collector_id
  }
  
  // 第三排筛选条件（范围筛选）
  if (filters.value.due_date_range && ...) {
    params.due_date_start = filters.value.due_date_range[0]
    params.due_date_end = filters.value.due_date_range[1]
  }
  if (filters.value.overdue_days_min !== undefined && ...) {
    params.overdue_days_min = filters.value.overdue_days_min
  }
  if (filters.value.overdue_days_max !== undefined && ...) {
    params.overdue_days_max = filters.value.overdue_days_max
  }
  
  // ...
}

// ✅ 修改：重置筛选器
const resetFilters = () => {
  filters.value = {
    // ... 原有字段
    team_group_id: undefined,      // ✅ 新增
    overdue_days_min: undefined,   // ✅ 新增
    overdue_days_max: undefined,   // ✅ 新增
  }
  // ...
  teamGroups.value = []  // ✅ 新增
  // ...
}
```

**更新API导入:**

```typescript
import { 
  getTenantAgencies, 
  getAgencyTeamGroups,    // ✅ 新增
  getTeamGroupTeams,      // ✅ 新增
  getTeamCollectors 
} from '@/api/organization'
```

#### 3. 样式变更

**新增样式:**

```css
/* 范围输入框组样式 */
.range-input-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.range-separator {
  color: #606266;
  font-size: 14px;
}
```

---

## 四、组织架构层级说明

本次优化涉及到完整的组织架构层级:

```
甲方(Tenant)
  └── 催收机构(CollectionAgency)
      └── 小组群(TeamGroup)  ⭐ 本次新增到筛选器
          └── 催收小组(CollectionTeam)
              └── 催员(Collector)
```

**筛选器级联关系:**
1. 选择机构 → 加载该机构下的小组群
2. 选择小组群 → 加载该小组群下的小组
3. 选择小组 → 加载该小组下的催员

---

## 五、功能特性

### 5.1 筛选条件布局优化

**优化前:**
- 筛选条件分散在多排
- 布局不够清晰
- 逻辑关系不明显

**优化后:**
- ✅ 第一排：基础筛选（案件状态、队列）
- ✅ 第二排：组织架构筛选（机构 → 小组群 → 小组 → 催员）
- ✅ 第三排：范围筛选（到期日、逾期天数）
- ✅ 布局清晰，逻辑分明

### 5.2 小组群筛选

**新增功能:**
- ✅ 支持按小组群筛选案件
- ✅ 小组群级联加载小组列表
- ✅ 完善组织架构筛选层级

**使用场景:**
- SPV（小组群长）查看其管辖的所有小组的案件
- 管理员按小组群维度分析案件情况

### 5.3 范围筛选优化

**到期日范围:**
- ✅ 快捷选择：一键选择今天、最近7天、最近30天
- ✅ 自定义选择：选择任意日期范围
- ✅ 日期格式统一：YYYY-MM-DD

**逾期天数范围:**
- ✅ 数字输入框：最小值 ~ 最大值
- ✅ 单边范围支持：只填最小值或最大值
- ✅ 自动校验：最小值 ≤ 最大值
- ✅ 清晰展示：使用"至"分隔符

---

## 六、测试验证

### 6.1 功能测试

**筛选条件测试:**
- [ ] 第一排筛选（案件状态、案件队列）正常工作
- [ ] 第二排组织架构筛选级联正常
  - [ ] 选择机构 → 加载小组群
  - [ ] 选择小组群 → 加载小组
  - [ ] 选择小组 → 加载催员
  - [ ] 清空上级 → 自动清空下级
- [ ] 第三排范围筛选正常工作
  - [ ] 到期日快捷选择正常
  - [ ] 到期日自定义选择正常
  - [ ] 逾期天数范围输入正常
  - [ ] 逾期天数单边范围支持

**数据加载测试:**
- [ ] 小组群列表正确加载
- [ ] 小组列表根据小组群ID正确加载
- [ ] 筛选参数正确传递到后端
- [ ] 筛选结果正确返回

**重置功能测试:**
- [ ] 点击重置按钮清空所有筛选条件
- [ ] 重置后所有下拉列表正确清空

### 6.2 交互测试

- [ ] 筛选条件变更后自动触发查询
- [ ] 下拉框disable状态正确（依赖上级选择）
- [ ] 快捷日期选择交互流畅
- [ ] 数字范围输入交互流畅

### 6.3 边界测试

- [ ] 逾期天数最小值 > 最大值时自动调整
- [ ] 未选择上级筛选条件时，下级筛选条件禁用
- [ ] 筛选条件为空时正常查询所有数据

---

## 七、影响范围分析

### 7.1 影响的模块

| 模块 | 影响程度 | 说明 |
|------|----------|------|
| PRD文档 | 🟡 中 | 更新筛选规则、流程、接口设计 |
| 前端-模板 | 🟡 中 | 重新组织筛选器布局 |
| 前端-逻辑 | 🟡 中 | 新增小组群相关逻辑 |
| 前端-样式 | 🟢 低 | 新增范围输入框样式 |
| 后端接口 | 🟢 低 | 使用已有接口，无需修改 |

### 7.2 兼容性分析

✅ **向下兼容**: 
- 新增的筛选条件都是可选的
- 不影响现有筛选功能
- 现有数据和接口无需修改

✅ **数据兼容**: 
- 小组群接口已存在，直接使用
- 案件列表接口支持新的筛选参数

✅ **接口兼容**: 
- 后端接口已支持team_group_id参数
- 新增的overdue_days_min/max参数需要后端支持

---

## 八、部署注意事项

### 8.1 前提条件

1. ✅ 后端已实现小组群管理功能
2. ✅ 后端案件列表接口支持team_group_id参数
3. ⚠️ 后端案件列表接口需要支持overdue_days_min/max参数（如未支持需要添加）

### 8.2 部署步骤

1. **更新PRD文档** ✅ 已完成
2. **更新前端代码** ✅ 已完成
3. **验证后端接口** ⚠️ 需要确认
   - 确认 `/api/v1/organization/team-groups` 接口可用
   - 确认 `/api/v1/teams` 接口支持 `team_group_id` 参数
   - 确认 `/api/v1/cases` 接口支持新的筛选参数
4. **功能测试** ⚠️ 需要执行
5. **上线发布** ⚠️ 待执行

### 8.3 回滚方案

如需回滚:

```bash
# 1. 回滚Git到本次变更前的版本
git revert <commit-hash>

# 2. 重新部署
npm run build
```

---

## 九、后续优化建议

### 9.1 功能增强

1. **筛选条件保存**
   - 支持保存常用筛选条件组合
   - 快速应用已保存的筛选方案

2. **高级筛选**
   - 支持更多字段的范围筛选
   - 支持多条件OR关系组合

3. **筛选统计**
   - 显示每个筛选条件的数据量统计
   - 帮助用户快速定位目标数据

### 9.2 性能优化

1. **接口优化**
   - 小组群、小组、催员列表支持搜索和分页
   - 减少大数据量下的加载时间

2. **缓存优化**
   - 缓存组织架构数据，减少重复加载
   - 智能刷新策略

---

## 十、总结

本次优化主要聚焦于提升案件列表筛选器的用户体验和功能完整性：

### 核心改进

1. ✅ **布局优化**: 两排紧凑布局，筛选条件分组清晰，节省空间
2. ✅ **层级完整**: 支持完整的组织架构层级筛选（机构 → 小组群 → 小组 → 催员）
3. ✅ **交互优化**: 日期快捷选择、数字范围输入，提升操作效率

### 用户价值

- 🎯 **SPV用户**: 可以快速查看其管辖小组群的所有案件
- 🎯 **管理员用户**: 更灵活的多维度筛选，提升案件管理效率
- 🎯 **所有用户**: 更清晰的布局，更便捷的操作

### 技术价值

- 📦 **代码组织**: 筛选逻辑更清晰，易于维护
- 🔧 **可扩展性**: 为后续添加更多筛选条件预留空间
- 🎨 **交互一致**: 统一的筛选器交互模式

---

**文档版本**: v1.0  
**最后更新**: 2025-12-04  
**维护人**: AI Assistant

