# 案件列表字段调整变更说明

**变更日期**: 2025-12-04  
**变更版本**: v1.1  
**变更人**: AI Assistant

---

## 一、变更需求

根据产品需求,对案件列表功能进行如下调整:

1. **手机号字段调整**: 手机号不在列表中展示,但仍可被搜索
2. **客户姓名列名更新**: 将"客户姓名"列名更新为"客户"
3. **必须展示字段定义**: 定义必须展示的字段,不接受配置隐藏:
   - 案件编号 (`case_code`)
   - 客户 (`user_name`)
   - 贷款金额 (`loan_amount`)
   - 未还金额 (`outstanding_amount`)
   - 逾期天数 (`overdue_days`)
   - 案件状态 (`case_status`)
   - 到期日期 (`due_date`)
   - 其他字段可以配置是否展示

---

## 二、PRD文档更新

### 文件: `/PRD需求文档/CCO管理控台/案件管理/案件列表功能PRD.md`

**主要变更内容:**

1. **列表展示规则** (第145-162行)
   - 新增必须展示字段列表
   - 新增可配置字段说明
   - 新增特殊字段规则(手机号)

2. **搜索规则** (第189-201行)
   - 标注手机号虽不展示但支持搜索

3. **数据字段与口径** (第267-296行)
   - 将字段分为:必须展示字段、其他标准字段、特殊字段
   - 明确"客户"作为列名

4. **字段展示配置** (第349-379行)
   - 新增 `is_required` 配置项
   - 新增必须展示字段配置规则
   - 新增特殊字段配置规则

5. **接口响应数据** (第467-509行)
   - 添加字段说明,明确手机号后端返回但前端不展示

6. **字段配置接口响应** (第519-551行)
   - 添加 `is_required` 字段示例
   - 明确"客户"作为 `field_name`

7. **变更记录**
   - 新增 v1.1 版本变更记录

---

## 三、后端代码更新

### 3.1 SQL初始化文件

**文件**: `/backend-java/src/main/resources/db/data/init_field_display_configs.sql`

**变更内容:**

```sql
-- 修改前:
(1, 'admin_case_list', '控台案件管理列表', 'user_name', '客户姓名', 'String', 'standard', ...)
(1, 'admin_case_list', '控台案件管理列表', 'mobile', '手机号码', 'String', 'standard', ...)

-- 修改后:
(1, 'admin_case_list', '控台案件管理列表', 'user_name', '客户', 'String', 'standard', ...)
-- 手机号字段已注释,不在列表中展示
-- (1, 'admin_case_list', '控台案件管理列表', 'mobile', '手机号码', 'String', 'standard', ...)
```

**影响范围**: 控台案件列表、催员案件列表

---

### 3.2 Java实体类

**文件**: `/backend-java/src/main/java/com/cco/model/entity/TenantFieldDisplayConfig.java`

**变更内容:**

```java
/**
 * 是否必须展示（不可配置隐藏）
 * 控台案件列表的必须展示字段：case_code、user_name、loan_amount、outstanding_amount、overdue_days、case_status、due_date
 */
private Boolean isRequired;
```

**作用**: 标记字段是否为必须展示字段

---

### 3.3 Java控制器

**文件**: `/backend-java/src/main/java/com/cco/controller/FieldDisplayConfigController.java`

**变更内容:**

1. **移除手机号字段** (从字段数组中移除 `"mobile"`)
2. **更新字段名称**: `"客户姓名"` → `"客户"`
3. **新增必须展示标识**:
   ```java
   boolean[] isRequired = {true, true, true, true, true, true, true, false, false};
   ```
4. **在Mock数据中添加 `is_required` 字段**:
   ```java
   config.put("is_required", isRequired[i]);
   ```

**字段调整前后对比:**

| 位置 | 修改前 | 修改后 | 必须展示 |
|------|--------|--------|----------|
| 1 | 案件编号 | 案件编号 | ✅ |
| 2 | 客户姓名 | 客户 | ✅ |
| 3 | 手机号码 | ❌ 已移除 | - |
| 4 | 贷款金额 | 贷款金额 | ✅ |
| 5 | 未还金额 | 未还金额 | ✅ |
| 6 | 逾期天数 | 逾期天数 | ✅ |
| 7 | 案件状态 | 案件状态 | ✅ |
| 8 | 产品名称 | 到期日期 | ✅ |
| 9 | App名称 | 产品名称 | ❌ |
| 10 | 到期日期 | App名称 | ❌ |

---

## 四、前端代码更新

### 4.1 TypeScript类型定义

**文件**: `/frontend/src/types/fieldDisplay.ts`

**变更内容:**

```typescript
export interface FieldDisplayConfig {
  // ... 其他字段
  is_searchable?: boolean // 是否可搜索
  is_filterable: boolean // 是否可筛选（针对枚举字段）
  is_range_searchable: boolean // 是否支持范围检索（针对数字和时间字段）
  is_required?: boolean // ✅ 新增: 是否必须展示（不可配置隐藏）
  created_at: string
}
```

同时在 `FieldDisplayConfigCreate` 和 `FieldDisplayConfigUpdate` 中也添加了 `is_required` 和 `is_searchable` 字段。

---

### 4.2 字段展示配置Hook

**文件**: `/frontend/src/composables/useFieldDisplayConfig.ts`

**变更内容:**

1. **新增常量定义**:
   ```typescript
   // 控台案件列表必须展示的字段(不可配置隐藏)
   export const ADMIN_CASE_LIST_REQUIRED_FIELDS = [
     'case_code',          // 案件编号
     'user_name',          // 客户
     'loan_amount',        // 贷款金额
     'outstanding_amount', // 未还金额
     'overdue_days',       // 逾期天数
     'case_status',        // 案件状态
     'due_date'            // 到期日期
   ]

   // 不在列表中展示但支持搜索的字段
   export const SEARCH_ONLY_FIELDS = [
     'mobile'  // 手机号码 - 不在列表中展示，但可以被搜索
   ]
   ```

2. **修改 `getTableColumns` 方法**:
   ```typescript
   const getTableColumns = (hideContext?) => {
     return visibleConfigs.value
       .filter(config => {
         // ✅ 新增: 过滤掉仅用于搜索的字段(如手机号)
         if (SEARCH_ONLY_FIELDS.includes(config.field_key)) {
           return false
         }
         
         // 应用隐藏规则
         if (hideContext) {
           return !shouldHideField(config.field_key, hideContext)
         }
         return true
       })
       .map(config => ({
         // ... 其他字段
         // ✅ 新增: 标记是否为必须展示字段
         isRequired: sceneType === 'admin_case_list' 
           ? ADMIN_CASE_LIST_REQUIRED_FIELDS.includes(config.field_key)
           : false
       }))
   }
   ```

---

### 4.3 案件列表页面

**文件**: `/frontend/src/views/case-management/CaseList.vue`

**变更内容:**

无需修改。由于使用了 `useFieldDisplayConfig` Hook,字段配置的变更会自动生效:
- 手机号字段会被 `SEARCH_ONLY_FIELDS` 过滤掉,不在表格中展示
- 但搜索功能仍然支持手机号搜索(第216行的搜索提示中仍包含"手机号码")
- "客户姓名"列名会自动显示为"客户"(从后端配置中获取)

---

## 五、数据库迁移 (可选)

如果已有数据库中有 `tenant_field_display_configs` 表的数据,需要执行以下SQL更新:

```sql
-- 1. 添加 is_required 字段
ALTER TABLE `tenant_field_display_configs` 
ADD COLUMN `is_required` TINYINT(1) DEFAULT 0 COMMENT '是否必须展示（不可配置隐藏）' 
AFTER `is_range_searchable`;

-- 2. 更新控台案件列表的"客户姓名"为"客户"
UPDATE `tenant_field_display_configs` 
SET `field_name` = '客户' 
WHERE `scene_type` = 'admin_case_list' 
  AND `field_key` = 'user_name';

-- 3. 删除控台案件列表的手机号字段配置
DELETE FROM `tenant_field_display_configs` 
WHERE `scene_type` = 'admin_case_list' 
  AND `field_key` = 'mobile';

-- 4. 标记必须展示的字段
UPDATE `tenant_field_display_configs` 
SET `is_required` = 1 
WHERE `scene_type` = 'admin_case_list' 
  AND `field_key` IN ('case_code', 'user_name', 'loan_amount', 'outstanding_amount', 'overdue_days', 'case_status', 'due_date');

-- 5. 可选: 更新催员案件列表的"客户姓名"为"客户"(保持一致性)
UPDATE `tenant_field_display_configs` 
SET `field_name` = '客户' 
WHERE `scene_type` = 'collector_case_list' 
  AND `field_key` = 'user_name';
```

---

## 六、测试验证

### 6.1 功能测试

1. **列表展示测试**
   - [ ] 案件列表中不显示手机号列
   - [ ] "客户姓名"列名显示为"客户"
   - [ ] 必须展示字段正常显示(案件编号、客户、贷款金额、未还金额、逾期天数、案件状态、到期日期)
   - [ ] 可配置字段(产品名称、App名称)正常显示

2. **搜索功能测试**
   - [ ] 搜索框提示文案包含"手机号码"
   - [ ] 输入手机号可以正常搜索到案件
   - [ ] 搜索其他字段(案件编号、客户姓名、客户ID)正常工作

3. **字段配置测试**
   - [ ] 必须展示字段不可配置隐藏
   - [ ] 可配置字段可以设置显示/隐藏
   - [ ] 字段展示顺序正确

### 6.2 回归测试

- [ ] 案件列表加载正常
- [ ] 筛选功能正常
- [ ] 排序功能正常
- [ ] 分页功能正常
- [ ] 查看详情功能正常
- [ ] 查看催记功能正常

---

## 七、影响范围分析

### 7.1 影响的模块

| 模块 | 影响程度 | 说明 |
|------|----------|------|
| PRD文档 | 🟢 低 | 文档更新,无功能影响 |
| 后端SQL初始化 | 🟡 中 | 新部署环境会使用新配置 |
| 后端实体类 | 🟢 低 | 新增字段,向下兼容 |
| 后端控制器 | 🟢 低 | Mock数据调整,不影响现有逻辑 |
| 前端类型定义 | 🟢 低 | 新增可选字段,向下兼容 |
| 前端Hook | 🟡 中 | 新增过滤逻辑,影响字段展示 |
| 案件列表页面 | 🟢 低 | 无需修改,自动应用新配置 |

### 7.2 兼容性分析

✅ **向下兼容**: 所有新增字段都是可选的,不会影响现有功能  
✅ **数据兼容**: 现有数据库数据不会受影响,仅展示方式变化  
✅ **接口兼容**: 后端接口不变,仅返回数据字段调整  

---

## 八、部署建议

### 8.1 部署顺序

1. **更新PRD文档** (已完成)
2. **更新后端代码** (已完成)
   - 实体类新增 `is_required` 字段
   - 控制器调整Mock数据
3. **更新前端代码** (已完成)
   - 类型定义新增字段
   - Hook新增过滤逻辑
4. **数据库迁移** (可选,仅新环境需要)
   - 执行SQL更新脚本

### 8.2 回滚方案

如果需要回滚,执行以下步骤:

1. 恢复Git到变更前的版本:
   ```bash
   git revert <commit-hash>
   ```

2. 恢复数据库(如果执行了迁移):
   ```sql
   -- 恢复"客户"为"客户姓名"
   UPDATE `tenant_field_display_configs` 
   SET `field_name` = '客户姓名' 
   WHERE `scene_type` = 'admin_case_list' AND `field_key` = 'user_name';
   
   -- 恢复手机号字段配置
   INSERT INTO `tenant_field_display_configs` (...) VALUES (...);
   
   -- 删除 is_required 字段
   ALTER TABLE `tenant_field_display_configs` DROP COLUMN `is_required`;
   ```

---

## 九、总结

本次变更主要是优化案件列表的字段展示,核心改动包括:

1. ✅ **手机号优化**: 不在列表中占用空间,但保留搜索能力
2. ✅ **列名简化**: "客户姓名" → "客户",更简洁
3. ✅ **字段分级**: 明确必须展示字段和可配置字段,提高灵活性

**变更影响**:
- 🟢 用户体验提升: 列表更简洁,关键信息突出
- 🟢 配置灵活性提升: 支持字段必填配置
- 🟢 代码可维护性提升: 字段管理更规范

**风险评估**: 🟢 **低风险**
- 所有变更都是向下兼容的
- 不影响现有数据
- 不影响核心业务逻辑

---

**文档版本**: v1.0  
**最后更新**: 2025-12-04  
**维护人**: AI Assistant

