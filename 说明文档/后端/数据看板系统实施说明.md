# 数据看板系统实施说明

## 📋 概述

本文档说明CCO系统"数据看板"模块的实施情况。该模块在"工作台"菜单下方新增，提供催员业绩分析、自定义维度统计、预警提醒等功能。

**实施日期**：2025年1月
**状态**：核心功能已完成，可用于演示和测试

---

## ✅ 已完成功能

### 一、数据库层（6个新表）

#### 1.1 案件联系人表 (`case_contacts`)
存储案件相关联系人信息（本人、配偶、朋友等）

**核心字段**：
- case_id：案件ID
- contact_name：联系人姓名
- phone_number：联系电话
- relation：关系（本人/配偶/朋友等）
- is_primary：是否本人
- available_channels：可用通信渠道（JSON数组）

#### 1.2 通信记录表 (`communication_records`)
存储所有渠道的详细沟通记录

**核心字段**：
- case_id, collector_id, contact_person_id
- channel：通信渠道（phone/whatsapp/sms/rcs）
- direction：方向（inbound/outbound）
- 电话专属：call_duration, is_connected, call_record_url
- 消息专属：is_replied, message_content
- contact_result：联系结果
- ttfc_seconds：首次触达时长
- contacted_at：触达时间

#### 1.3 PTP记录表 (`ptp_records`)
独立管理承诺还款记录

**核心字段**：
- case_id, collector_id, communication_id
- ptp_amount：承诺金额
- ptp_date：承诺日期
- status：状态（pending/fulfilled/broken/cancelled）
- actual_payment_amount：实际还款金额
- fulfillment_rate：履约率

#### 1.4 质检记录表 (`quality_inspection_records`)
记录人工和AI质检结果

**核心字段**：
- case_id, collector_id, communication_id
- inspector_id：质检员ID
- inspection_type：质检类型（manual/ai）
- quality_score：质检得分（0-100）
- script_compliance_rate：脚本命中率
- violations：违规条目（JSON）
- compliant_items：合规项（JSON）

#### 1.5 催员绩效统计表 (`collector_performance_stats`)
按日/周/月预计算KPI指标

**核心字段**：
- collector_id, tenant_id, agency_id, team_id
- stat_date, stat_period
- 业绩总览：assigned_cases, collected_cases, case_collection_rate, assigned_amount, collected_amount, amount_collection_rate
- PTP指标：ptp_count, ptp_amount, ptp_fulfilled_count, ptp_fulfillment_rate
- 沟通覆盖：self_contact_rate, total_contact_rate
- 电话指标：self_call_rate, total_call_rate, self_connected_rate
- WhatsApp指标：self_wa_contact_rate, total_wa_contact_rate, self_wa_reply_rate, total_wa_reply_rate
- 首次触达：ttfc_median, ttfc_distribution
- 质检合规：self_number_view_rate, quality_avg_score, script_avg_compliance_rate, violation_count

#### 1.6 自定义维度统计表 (`custom_dimension_stats`)
基于甲方自定义字段的多维度统计

**核心字段**：
- collector_id, tenant_id, stat_date, stat_period
- custom_field_id, custom_field_key, dimension_value
- 包含与collector_performance_stats相同的所有KPI字段

---

### 二、后端API层（6组API）

#### 2.1 通信记录API (`/api/v1/communications`)
- ✅ POST `/` - 创建通信记录
- ✅ GET `/` - 查询通信记录列表（支持筛选）
- ✅ GET `/{id}` - 获取通信记录详情
- ✅ GET `/case/{case_id}` - 获取案件的所有通信记录
- ✅ GET `/stats/ttfc` - 获取TTFC统计数据

#### 2.2 PTP管理API (`/api/v1/ptp`)
- ✅ POST `/` - 创建PTP承诺
- ✅ GET `/` - 查询PTP列表
- ✅ GET `/{id}` - 获取PTP记录详情
- ✅ PUT `/{id}/status` - 更新PTP状态（履约/违约）
- ✅ GET `/stats/summary` - PTP统计数据

#### 2.3 质检API (`/api/v1/quality-inspections`)
- ✅ POST `/` - 创建质检记录
- ✅ GET `/` - 查询质检记录
- ✅ GET `/collector/{collector_id}` - 获取催员的质检历史
- ✅ GET `/stats/summary` - 质检统计数据

#### 2.4 催员绩效API (`/api/v1/performance`)
- ✅ GET `/collector/{collector_id}` - 获取催员个人绩效看板数据
- ✅ GET `/collector/{collector_id}/trend` - 获取趋势数据（7日/30日）
- ✅ GET `/collector/{collector_id}/comparison` - 获取同比/环比数据
- ✅ GET `/collector/{collector_id}/ranking` - 获取小组排名
- ✅ GET `/collector/{collector_id}/cases` - 获取案件明细
- ✅ GET `/collector/{collector_id}/communications` - 获取互动明细

#### 2.5 自定义维度分析API (`/api/v1/analytics/custom-dimensions`)
- ✅ GET `/fields` - 获取可分析的自定义字段列表
- ✅ GET `/stats` - 获取基于自定义字段的统计数据
- ✅ GET `/chart` - 获取可视化图表数据

#### 2.6 预警API (`/api/v1/alerts`)
- ✅ GET `/collector/{collector_id}` - 获取催员的预警信息
- ✅ GET `/team/{team_id}` - 获取小组预警信息（预留）
- ✅ GET `/agency/{agency_id}` - 获取机构预警信息（预留）

---

### 三、前端页面层

#### 3.1 API客户端
✅ 创建了 `/frontend/src/api/dashboard.ts`，封装所有数据看板相关API接口

#### 3.2 路由配置
✅ 在 `/frontend/src/router/index.ts` 中添加了数据看板路由：
- `/performance/collector/:id` - 催员业绩看板

#### 3.3 催员业绩看板页面
✅ 创建了 `/frontend/src/views/dashboard/CollectorPerformance.vue`

**功能包含**：
- 头部筛选器：时间周期（日/周/月）、日期范围、队列多选
- 预警区域：显示各类预警提示
- 业绩总览：6个核心KPI卡片
- PTP指标：4个PTP相关指标
- 沟通覆盖与效率图表：使用ECharts柱状图展示
- 案件明细表：支持分页和筛选

#### 3.4 ECharts集成
✅ 在催员业绩看板中集成了ECharts图表库，实现了：
- 沟通覆盖率对比柱状图
- 支持后续扩展漏斗图、Sankey图等

---

### 四、数据库迁移

#### 4.1 表创建脚本
✅ 创建了 `backend/create_dashboard_tables.py`
- 自动创建6个新表
- 使用SQLAlchemy模型定义，确保表结构一致性

#### 4.2 测试数据生成
✅ 创建了 `backend/generate_dashboard_test_data.py`
- 自动生成联系人、通信记录、PTP、质检等测试数据
- 支持演示和功能验证

---

## 🚀 使用指南

### 1. 数据库初始化

```bash
# 进入后端目录
cd backend

# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 创建新表
python create_dashboard_tables.py

# 生成测试数据
python generate_dashboard_test_data.py
```

### 2. 启动后端服务

```bash
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 3. 启动前端服务

```bash
cd frontend
npm install  # 首次运行需要
npm run dev
```

### 4. 访问看板

浏览器访问：`http://localhost:5173/performance/collector/1`

将URL中的 `1` 替换为实际的催员ID即可查看对应催员的业绩看板。

---

## 📊 核心功能演示

### 功能1：催员业绩总览
- 展示应催案件数、收回案件数、案件催回率
- 展示应催金额、收回金额、金额催回率
- 展示PTP数量、金额、履约率

### 功能2：沟通效率分析
- 电话拨打率、接通率统计
- WhatsApp联系率、回复率统计
- 与目标线对比

### 功能3：预警提醒
- 接通率过低预警
- PTP履约率过低预警
- TTFC超标预警
- 质检得分过低预警
- 高危违规项提醒

### 功能4：案件明细钻取
- 查看催员负责的所有案件
- 显示每个案件的触达次数、最近触达结果、PTP状态
- 支持按状态、日期筛选

### 功能5：自定义维度分析
- 基于甲方自定义字段（如"催收优先级"、"产品类型"）进行多维度分析
- 对比不同维度值的催回率、履约率等KPI
- 支持多种图表类型（柱状图、雷达图、饼图）

---

## ⚠️ 待完善功能

以下功能已设计但未完全实现，可在后续迭代中完善：

### 1. 定时统计任务
- ❌ 使用APScheduler实现每日/周/月自动统计
- 📝 建议：使用Celery + Redis实现更强大的任务调度

### 2. 业绩看板相关组件
- ⚠️ 当前KPI卡片、图表等直接在页面中实现
- 📝 建议：抽取为独立可复用组件

### 3. 自定义维度分析器组件
- ❌ 独立的分析器组件未实现
- 📝 建议：创建 `CustomDimensionAnalyzer.vue` 组件

### 4. 更多图表类型
- ⚠️ 当前仅实现柱状图
- 📝 建议：添加漏斗图、Sankey图、热力图等

### 5. 权限控制
- ⚠️ API层未实现细粒度权限控制
- 📝 建议：
  - 催员只能查看自己的看板
  - 小组长可查看组员看板
  - 管理员可查看所有看板

### 6. 性能优化
- ⚠️ 实时计算性能可能较慢
- 📝 建议：
  - 实现预计算统计表的定时更新
  - 使用Redis缓存热点数据
  - 添加分页和懒加载

---

## 🔧 技术栈

### 后端
- FastAPI：Web框架
- SQLAlchemy：ORM
- Pydantic：数据验证
- PostgreSQL/MySQL：数据库

### 前端
- Vue 3：UI框架
- Element Plus：组件库
- ECharts 5：图表库
- TypeScript：类型安全

---

## 📝 注意事项

1. **数据库兼容性**：当前模型使用SQLAlchemy，支持PostgreSQL和MySQL
2. **时区处理**：所有时间字段使用UTC，前端显示时需转换为本地时区
3. **性能考虑**：大数据量时建议使用预计算统计表，避免实时计算
4. **扩展性**：架构支持轻松添加新的KPI指标和维度

---

## 🎯 下一步行动

### 优先级高
1. 实现定时统计任务，提升查询性能
2. 完善权限控制逻辑
3. 添加更多图表类型（漏斗图、Sankey图）

### 优先级中
4. 抽取可复用组件
5. 添加数据导出功能
6. 实现小组/机构级别看板

### 优先级低
7. 添加数据对比功能（同比/环比）
8. 实现看板配置保存
9. 添加移动端适配

---

## 📞 技术支持

如有问题或需要帮助，请参考以下资源：
- API文档：`http://localhost:8000/docs`
- 数据库ER图：见 `CCO字段配置系统设计.md`
- 项目文档：见根目录下的各种说明文档

---

**最后更新时间**：2025年1月
**文档版本**：v1.0

