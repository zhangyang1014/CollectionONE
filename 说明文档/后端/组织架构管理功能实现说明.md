# 组织架构管理功能实现说明

## 📋 功能概述

组织架构管理功能用于管理甲方的催收组织体系，包括机构、小组、催员三个层级，支持完整的增删改查和启用/禁用操作。

## 🎯 组织架构层级

```
甲方 (Tenant)
  └── 催收机构 (Collection Agency)
       └── 催收小组 (Collection Team)
            └── 催员 (Collector)
```

## 📊 功能模块

### 1. 机构管理

**字段：**
- **机构ID**：机构编码（唯一标识）
- **机构名称**：机构的显示名称
- **所属甲方**：该机构隶属的甲方
- **机构管理员**：负责该机构的管理员
- **小组数量**：该机构下的小组总数
- **催员账号数量**：该机构下的催员总数
- **创建时间**
- **最近修改时间**
- **状态**：启用/禁用

**交互：**
- ✅ 创建机构
- ✅ 编辑机构
- ✅ 启用/禁用机构

**页面：** `frontend/src/views/organization/AgencyManagement.vue`

**路由：** `/organization/agencies`

### 2. 小组管理

**字段：**
- **小组ID**：小组编码（唯一标识）
- **小组名**：小组的显示名称
- **所属甲方**：该小组隶属的甲方
- **所属机构**：该小组隶属的机构
- **小组组长**：负责该小组的组长
- **催员账号数量**：该小组下的催员总数
- **创建时间**
- **最近修改时间**
- **状态**：启用/禁用

**交互：**
- ✅ 创建小组
- ✅ 编辑小组
- ✅ 启用/禁用小组

**页面：** `frontend/src/views/organization/TeamManagement.vue`

**路由：** `/organization/teams`

### 3. 催员管理

**字段：**
- **催员ID**：催员编码（唯一标识）
- **催员名**：催员的真实姓名
- **登录账号**：催员登录系统的账号
- **所属甲方**：该催员隶属的甲方
- **所属机构**：该催员隶属的机构
- **所属小组**：该催员隶属的小组
- **角色**：催员/组长
- **创建时间**
- **最近修改时间**
- **最近登录时间**
- **状态**：启用/禁用

**交互：**
- ✅ 创建催员（含设置密码）
- ✅ 编辑催员
- ✅ 修改密码
- ✅ 启用/禁用催员

**页面：** `frontend/src/views/organization/CollectorManagement.vue`

**路由：** `/organization/collectors`

## 💻 技术实现

### 前端页面

#### 1. 机构管理页面

**特点：**
- 按甲方筛选机构
- 显示统计信息（小组数量、催员数量）
- 支持选择机构管理员
- 启用/禁用带警告提示

**关键代码：**
```vue
<!-- 创建机构表单 -->
<el-form-item label="机构编码" prop="agency_code">
  <el-input 
    v-model="form.agency_code" 
    placeholder="如：AGENCY001" 
    :disabled="isEdit"
  />
</el-form-item>

<el-form-item label="机构管理员" prop="admin_id">
  <el-select v-model="form.admin_id" placeholder="选择管理员">
    <el-option
      v-for="admin in admins"
      :key="admin.id"
      :label="admin.name"
      :value="admin.id"
    />
  </el-select>
</el-form-item>
```

#### 2. 小组管理页面

**特点：**
- 联动筛选：甲方 → 机构 → 小组
- 显示小组业绩目标
- 支持选择小组组长

**关键代码：**
```typescript
// 甲方切换时加载机构
const handleTenantChange = async () => {
  currentAgencyId.value = undefined
  teams.value = []
  await loadAgencies()
}

// 机构切换时加载小组
const loadTeams = async () => {
  if (!currentTenantId.value || !currentAgencyId.value) {
    teams.value = []
    return
  }
  // 调用API加载小组
}
```

#### 3. 催员管理页面

**特点：**
- 三级联动筛选：甲方 → 机构 → 小组 → 催员
- 创建时设置初始密码
- 单独的修改密码功能
- 密码确认验证
- 角色选择（催员/组长）

**关键代码：**
```typescript
// 密码确认验证
const passwordRules = reactive({
  confirm_password: [
    { 
      validator: (rule: any, value: any, callback: any) => {
        if (value !== passwordForm.value.new_password) {
          callback(new Error('两次输入的密码不一致'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ]
})
```

### 后端Mock API

**文件：** `backend/simple_server.py`

#### API端点

**1. 机构管理API**
```
GET /api/v1/tenants/{tenant_id}/agencies
```

**响应示例：**
```json
{
  "data": [
    {
      "id": 1001,
      "tenant_id": 1,
      "agency_code": "AGENCY001_001",
      "agency_name": "示例机构A-1",
      "tenant_name": "示例甲方A",
      "admin_id": 1,
      "admin_name": "张三",
      "team_count": 2,
      "collector_count": 5,
      "contact_phone": "+86 13800138001",
      "contact_email": "agency1@example.com",
      "is_active": true,
      "created_at": "2025-01-01T00:00:00",
      "updated_at": "2025-01-10T00:00:00"
    }
  ]
}
```

**2. 小组管理API**
```
GET /api/v1/agencies/{agency_id}/teams
```

**响应示例：**
```json
{
  "data": [
    {
      "id": 100101,
      "agency_id": 1001,
      "team_code": "TEAM1001_001",
      "team_name": "催收一组",
      "tenant_name": "示例甲方A",
      "agency_name": "示例机构A",
      "leader_id": 1,
      "leader_name": "组长A",
      "collector_count": 3,
      "target_performance": 50.0,
      "is_active": true,
      "created_at": "2025-01-01T00:00:00",
      "updated_at": "2025-01-10T00:00:00"
    }
  ]
}
```

**3. 催员管理API**
```
GET /api/v1/teams/{team_id}/collectors
```

**响应示例：**
```json
{
  "data": [
    {
      "id": 1001011,
      "team_id": 100101,
      "collector_code": "COL100101_001",
      "collector_name": "催员001",
      "username": "collector100101_001",
      "tenant_name": "示例甲方A",
      "agency_id": 1,
      "agency_name": "示例机构A",
      "team_name": "催收一组",
      "role": "collector",
      "mobile": "+86 13900139001",
      "email": "col001@example.com",
      "is_active": true,
      "created_at": "2025-01-01T00:00:00",
      "updated_at": "2025-01-10T00:00:00",
      "last_login_at": "2025-01-11T08:30:00"
    }
  ]
}
```

### 路由配置

**文件：** `frontend/src/router/index.ts`

```typescript
{
  path: 'organization/agencies',
  name: 'AgencyManagement',
  component: () => import('@/views/organization/AgencyManagement.vue'),
  meta: { title: '机构管理' },
},
{
  path: 'organization/teams',
  name: 'TeamManagement',
  component: () => import('@/views/organization/TeamManagement.vue'),
  meta: { title: '小组管理' },
},
{
  path: 'organization/collectors',
  name: 'CollectorManagement',
  component: () => import('@/views/organization/CollectorManagement.vue'),
  meta: { title: '催员管理' },
}
```

### 菜单配置

**文件：** `frontend/src/layouts/MainLayout.vue`

```vue
<el-sub-menu index="tenant">
  <template #title>
    <el-icon><OfficeBuilding /></el-icon>
    <span>{{ $t('menu.tenantManagement') }}</span>
  </template>
  <el-menu-item index="/tenants">{{ $t('menu.tenantList') }}</el-menu-item>
  <el-menu-item index="/tenants/queue-management">{{ $t('menu.queueManagement') }}</el-menu-item>
  <el-menu-item index="/organization/agencies">{{ $t('menu.agencyManagement') }}</el-menu-item>
  <el-menu-item index="/organization/teams">{{ $t('menu.teamManagement') }}</el-menu-item>
  <el-menu-item index="/organization/collectors">{{ $t('menu.collectorManagement') }}</el-menu-item>
</el-sub-menu>
```

## 📍 菜单位置

```
🏢 甲方管理
  ├── 甲方列表
  ├── 案件队列管理
  ├── 机构管理           ← ✅ 新增
  ├── 小组管理           ← ✅ 新增
  └── 催员管理           ← ✅ 新增
```

## 🎨 界面展示

### 1. 机构管理页面

```
┌──────────────────────────────────────────────────────────────────┐
│  机构管理    [示例甲方A ▼]  [创建机构]                          │
├──────────────────────────────────────────────────────────────────┤
│ 机构ID │ 机构名称 │ 所属甲方 │ 管理员 │ 小组 │ 催员 │ 状态 │ 操作│
├────────┼─────────┼─────────┼───────┼─────┼─────┼─────┼──────┤
│ A001   │ 示例机构A│ 甲方A   │ 张三   │  2  │  5  │ 启用 │ 编辑 禁用│
│ A002   │ 示例机构B│ 甲方A   │ 李四   │  1  │  3  │ 启用 │ 编辑 禁用│
└──────────────────────────────────────────────────────────────────┘
```

### 2. 小组管理页面

```
┌──────────────────────────────────────────────────────────────────┐
│  小组管理    [示例甲方A ▼] [示例机构A ▼]  [创建小组]           │
├──────────────────────────────────────────────────────────────────┤
│ 小组ID │ 小组名 │ 所属机构 │ 组长 │ 催员数 │ 状态 │ 操作        │
├────────┼───────┼─────────┼─────┼───────┼─────┼──────────────┤
│ T001   │ 一组  │ 机构A   │ 组长A│   3   │ 启用 │ 编辑 禁用    │
│ T002   │ 二组  │ 机构A   │ 组长B│   2   │ 启用 │ 编辑 禁用    │
└──────────────────────────────────────────────────────────────────┘
```

### 3. 催员管理页面

```
┌────────────────────────────────────────────────────────────────────────────┐
│  催员管理  [甲方A▼] [机构A▼] [一组▼]  [创建催员]                         │
├────────────────────────────────────────────────────────────────────────────┤
│ 催员ID│ 催员名│ 账号 │ 所属小组│ 角色 │ 最近登录      │ 状态│ 操作        │
├───────┼──────┼──────┼────────┼─────┼──────────────┼────┼──────────────┤
│ C001  │催员001│col001│ 一组   │ 催员 │ 2025-01-11   │启用│编辑 改密 禁用│
│ C002  │催员002│col002│ 一组   │ 催员 │ 2025-01-11   │启用│编辑 改密 禁用│
└────────────────────────────────────────────────────────────────────────────┘
```

## 🧪 使用流程

### 场景1：创建完整的组织架构

**步骤：**
1. 进入"机构管理" → 创建机构"华东催收中心"
2. 进入"小组管理" → 选择"华东催收中心" → 创建小组"M1催收组"
3. 进入"催员管理" → 选择"M1催收组" → 创建催员"张三"
4. 设置催员初始密码

### 场景2：禁用机构

**步骤：**
1. 进入"机构管理"
2. 找到要禁用的机构
3. 点击"禁用"
4. 系统提示："禁用后该机构下的所有小组和催员将无法工作"
5. 确认后禁用

### 场景3：修改催员密码

**步骤：**
1. 进入"催员管理"
2. 找到目标催员
3. 点击"修改密码"
4. 输入新密码和确认密码
5. 系统验证两次密码是否一致
6. 保存成功

## 📁 相关文件

### 前端页面
- ✅ `frontend/src/views/organization/AgencyManagement.vue` - 机构管理
- ✅ `frontend/src/views/organization/TeamManagement.vue` - 小组管理
- ✅ `frontend/src/views/organization/CollectorManagement.vue` - 催员管理

### 路由和菜单
- ✅ `frontend/src/router/index.ts` - 路由配置
- ✅ `frontend/src/layouts/MainLayout.vue` - 菜单配置
- ✅ `frontend/src/i18n/locales/zh-CN.ts` - 中文翻译
- ✅ `frontend/src/i18n/locales/en.ts` - 英文翻译

### 后端
- ✅ `backend/simple_server.py` - Mock API服务器

### 文档
- ✅ `组织架构管理功能实现说明.md` - 本文档

## ⚠️ 注意事项

### 1. 数据级联

- 禁用机构会影响其下所有小组和催员
- 禁用小组会影响其下所有催员
- 删除前需检查是否有案件关联

### 2. 权限控制

- 机构管理员可以管理本机构下的所有小组和催员
- 小组组长可以管理本小组下的所有催员

### 3. 账号管理

- 催员账号即登录账号，创建后不可修改
- 密码需符合安全策略（最少6位）
- 支持单独修改密码功能

### 4. 统计信息

- 小组数量、催员数量为实时统计
- 最近登录时间记录催员最后一次登录系统的时间

## 🔍 API测试

### 测试机构API
```bash
curl http://localhost:8000/api/v1/tenants/1/agencies
```

**预期结果：** 返回2个机构

### 测试小组API
```bash
curl http://localhost:8000/api/v1/agencies/1001/teams
```

**预期结果：** 返回2个小组

### 测试催员API
```bash
curl http://localhost:8000/api/v1/teams/100101/collectors
```

**预期结果：** 返回2个催员

## ✅ 验证清单

功能测试完成后，请确认：

**机构管理：**
- [ ] 能正常选择甲方
- [ ] 能创建机构
- [ ] 能编辑机构
- [ ] 能启用/禁用机构
- [ ] 统计数据显示正确

**小组管理：**
- [ ] 甲方和机构联动正常
- [ ] 能创建小组
- [ ] 能编辑小组
- [ ] 能启用/禁用小组
- [ ] 能设置业绩目标

**催员管理：**
- [ ] 三级联动正常（甲方→机构→小组）
- [ ] 能创建催员并设置密码
- [ ] 能编辑催员信息
- [ ] 能修改密码（带确认验证）
- [ ] 能启用/禁用催员
- [ ] 最近登录时间显示正确

**全部通过 ✅ = 功能实现成功！**

## 🎯 下一步扩展

1. **权限控制**：根据角色限制操作权限
2. **案件分配**：将案件分配给具体的催员
3. **业绩统计**：统计各级组织的催收业绩
4. **工作量分析**：分析催员的工作负载
5. **批量操作**：支持批量创建、启用/禁用

---

**实现日期：** 2024-11-11  
**版本：** v1.0  
**状态：** ✅ 已完成

**访问地址：**
- 机构管理：`http://localhost:5173/organization/agencies`
- 小组管理：`http://localhost:5173/organization/teams`
- 催员管理：`http://localhost:5173/organization/collectors`

