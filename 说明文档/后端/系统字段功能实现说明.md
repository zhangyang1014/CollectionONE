# CCO系统 - 系统字段功能实现说明

## 文档信息

| 项目 | 内容 |
|------|------|
| 创建日期 | 2025-11-20 |
| 最后更新 | 2025-11-20 |
| 负责人 | CCO开发团队 |

## 功能概述

### 什么是系统字段？

**系统字段（System Fields）** 是一种新的字段类型，具有以下特点：

1. **自动计算**：由系统后台自动计算生成，不需要用户手动输入
2. **只读属性**：用户不能修改这些字段的值
3. **可配置展示**：虽然不可编辑，但可以配置是否展示、排序、筛选等
4. **动态更新**：随着业务数据变化自动更新

### 字段来源类型

系统现在支持4种字段来源类型：

| 字段来源 | 说明 | 示例 |
|---------|------|------|
| **standard** | 标准字段 | 案件编号、客户姓名、手机号码等 |
| **extended** | 扩展字段 | 基于标准字段创建的扩展字段 |
| **custom** | 自定义字段 | 所属队列、催收机构、催收小组等 |
| **system** | 系统字段（新增） | 已分发天数、电话拨打次数等 |

---

## 已实现的系统字段

### 字段列表

| 序号 | 字段标识 | 字段名称 | 数据类型 | 计算说明 |
|-----|---------|---------|---------|---------|
| 1 | `days_assigned` | 已分发天数 | Integer | 案件归属当前催员的天数 |
| 2 | `view_phone_count` | 查看本人联系电话次数 | Integer | 催员查看客户本人联系电话的次数 |
| 3 | `call_count` | 电话拨打次数 | Integer | 催员拨打电话的总次数 |
| 4 | `call_connected_count` | 电话拨通次数 | Integer | 电话成功拨通的次数 |
| 5 | `whatsapp_sent_count` | WA发送次数 | Integer | WhatsApp消息发送次数 |
| 6 | `whatsapp_reply_count` | WA回复次数 | Integer | WhatsApp消息回复次数 |
| 7 | `rcs_sent_count` | RCS发送次数 | Integer | RCS消息发送次数 |
| 8 | `rcs_reply_count` | RCS回复次数 | Integer | RCS消息回复次数 |
| 9 | `sms_sent_count` | 短信发送次数 | Integer | 短信发送次数 |

### 字段特性

所有系统字段都配置为：

- ✅ **字段类型**：`Integer`（整数类型）
- ✅ **字段来源**：`system`（系统字段）
- ✅ **可搜索**：❌ 关闭（Integer类型不支持文本搜索）
- ✅ **可筛选**：❌ 关闭（Integer类型不支持枚举筛选）
- ✅ **范围检索**：✅ 开启（支持最小-最大值范围筛选）

---

## 展示场景配置

### 配置的场景

系统字段已在以下3个场景中配置为展示：

#### 1. 控台案件管理列表 (`admin_case_list`)

**使用者**：系统管理员、甲方管理员、机构管理员

**配置详情**：
- 所有9个系统字段都已添加
- 排序位置：16-24（在现有字段之后）
- 显示宽度：100像素
- 支持范围检索

#### 2. 催员案件列表 (`collector_case_list`)

**使用者**：催员

**配置详情**：
- 所有9个系统字段都已添加
- 排序位置：13-21（在现有字段之后）
- 显示宽度：100像素
- 支持范围检索

#### 3. 催员案件详情 (`collector_case_detail`)

**使用者**：催员

**配置详情**：
- 所有9个系统字段都已添加
- 排序位置：15-23（在现有字段之后）
- 显示宽度：100像素
- 支持范围检索

### 配置统计

- **甲方数量**：7个
- **场景数量**：3个
- **字段数量**：9个
- **总配置条数**：189条（7 × 3 × 9）

---

## 技术实现

### 1. 数据库配置

**表名**：`tenant_field_display_configs`

**字段定义**：
```sql
field_key VARCHAR(100)          -- 字段标识，如：days_assigned
field_name VARCHAR(200)         -- 字段名称，如：已分发天数
field_data_type VARCHAR(50)     -- 字段类型：Integer
field_source VARCHAR(20)        -- 字段来源：system
is_range_searchable BOOLEAN     -- 是否支持范围检索：1
```

### 2. 后端配置文件

**文件**：`backend/fix_field_display_data_v2.py`

**系统字段定义**：
```python
VIRTUAL_FIELDS = {
    # 系统字段（system）- 自动计算的字段
    'days_assigned': {'type': 'Integer', 'source': 'system', 'name': '已分发天数'},
    'view_phone_count': {'type': 'Integer', 'source': 'system', 'name': '查看本人联系电话次数'},
    'call_count': {'type': 'Integer', 'source': 'system', 'name': '电话拨打次数'},
    'call_connected_count': {'type': 'Integer', 'source': 'system', 'name': '电话拨通次数'},
    'whatsapp_sent_count': {'type': 'Integer', 'source': 'system', 'name': 'WA发送次数'},
    'whatsapp_reply_count': {'type': 'Integer', 'source': 'system', 'name': 'WA回复次数'},
    'rcs_sent_count': {'type': 'Integer', 'source': 'system', 'name': 'RCS发送次数'},
    'rcs_reply_count': {'type': 'Integer', 'source': 'system', 'name': 'RCS回复次数'},
    'sms_sent_count': {'type': 'Integer', 'source': 'system', 'name': '短信发送次数'},
}
```

### 3. 前端类型定义

**文件**：`frontend/src/types/fieldDisplay.ts`

**类型定义**：
```typescript
export interface FieldDisplayConfig {
  field_data_type?: string // 字段数据类型：String/Integer/Boolean/Enum等
  field_source?: string    // 字段来源：standard/extended/custom/system
  // ...
}

export interface AvailableFieldOption {
  field_source: string     // 字段来源：standard/extended/custom/system
  // ...
}
```

---

## 使用说明

### 范围检索功能

系统字段都是Integer类型，支持范围检索功能：

**筛选界面**：
```
已分发天数: [最小值] - [最大值]
示例：0 - 30 （查询分发0-30天的案件）

电话拨打次数: [最小值] - [最大值]
示例：1 - 5 （查询拨打1-5次的案件）
```

**筛选逻辑**：
- 只输入最小值：`字段值 >= 最小值`
- 只输入最大值：`字段值 <= 最大值`
- 同时输入：`最小值 <= 字段值 <= 最大值`

### 配置管理

在"甲方字段展示配置"页面：

1. **查看系统字段**
   - 字段来源显示为：`系统字段`
   - 范围检索列显示开关（已开启）
   - 可搜索、可筛选列不显示（不适用）

2. **调整显示顺序**
   - 可以拖拽调整字段排序
   - 可以输入排序数字

3. **配置显示宽度**
   - 默认100像素
   - 可根据内容调整

4. **隐藏字段**
   - 可以从列表中移除不需要显示的系统字段
   - 移除后不影响数据计算

---

## 数据验证

### 验证命令

```bash
# 统计每个场景的系统字段数量
sqlite3 cco_test.db "
SELECT scene_type, COUNT(*) as field_count 
FROM tenant_field_display_configs 
WHERE field_source = 'system' 
GROUP BY scene_type;
"

# 查看甲方1的系统字段详情
sqlite3 cco_test.db "
SELECT field_key, field_name, field_data_type, field_source, is_range_searchable 
FROM tenant_field_display_configs 
WHERE tenant_id = 1 AND scene_type = 'admin_case_list' AND field_source = 'system' 
ORDER BY sort_order;
"
```

### 验证结果

✅ **场景统计**：
- `admin_case_list`: 63条（9字段 × 7甲方）
- `collector_case_list`: 63条（9字段 × 7甲方）
- `collector_case_detail`: 63条（9字段 × 7甲方）

✅ **字段配置**：所有字段的类型、来源、范围检索配置都正确

---

## 后续扩展

### 如何添加新的系统字段？

1. **定义字段**

在 `backend/fix_field_display_data_v2.py` 中添加：
```python
VIRTUAL_FIELDS = {
    # ...
    'new_system_field': {'type': 'Integer', 'source': 'system', 'name': '新系统字段'},
}
```

2. **创建添加脚本**

参考 `backend/add_system_fields.py`（已删除）创建新的添加脚本：
```python
SYSTEM_FIELDS = [
    {
        'field_key': 'new_system_field',
        'field_name': '新系统字段',
        'field_type': 'Integer',
        'description': '字段说明'
    }
]
```

3. **运行脚本**

```bash
cd backend
python3 add_new_system_fields.py
```

4. **验证配置**

检查字段是否正确添加到所有场景中。

### 支持的数据类型

系统字段可以使用以下数据类型：

| 类型 | 说明 | 支持功能 |
|-----|------|---------|
| Integer | 整数 | 范围检索 |
| Decimal | 小数 | 范围检索 |
| Date | 日期 | 范围检索 |
| Datetime | 日期时间 | 范围检索 |
| String | 文本 | 关键字搜索 |
| Enum | 枚举 | 下拉筛选 |

---

## 注意事项

### ⚠️ 重要提示

1. **只读属性**
   - 系统字段由后台自动计算
   - 前端和API不应允许修改这些字段的值
   - 只能配置展示相关的属性

2. **数据源**
   - 这些字段的实际数据需要从业务表中统计计算
   - 当前只是配置了字段展示，实际数据计算需要后续实现

3. **性能考虑**
   - 系统字段的计算可能涉及复杂的统计查询
   - 建议使用缓存或定时计算来提升性能
   - 大数据量场景下需要优化查询

4. **版本兼容**
   - 新增系统字段不影响现有功能
   - 旧版本前端可能不识别 "system" 字段来源
   - 建议前后端同步更新

---

## 总结

### ✅ 已完成

1. ✅ 定义了 "system" 字段来源类型
2. ✅ 新增了9个系统字段定义
3. ✅ 在3个场景中配置了所有系统字段
4. ✅ 为7个甲方都添加了完整配置（共189条）
5. ✅ 更新了前端TypeScript类型定义
6. ✅ 更新了后端字段定义文件
7. ✅ 配置了范围检索功能

### 📋 待实现

1. ⏳ 后端API实现系统字段的实际数据计算逻辑
2. ⏳ 前端界面优化（标识系统字段为只读）
3. ⏳ 添加系统字段的缓存机制
4. ⏳ 性能优化和测试

### 🎯 核心价值

- **自动化**：减少手动录入工作量
- **实时性**：数据随业务变化自动更新
- **可配置**：灵活控制展示和筛选
- **扩展性**：易于添加新的系统字段

---

## 相关文档

- [字段配置功能PRD](../../CCO管理控台/字段配置功能PRD.md)
- [甲方字段展示配置实现说明](../../说明文档/前端/甲方字段展示配置实现说明.md)
- [范围检索功能完成报告](../../文档/完成报告/范围检索功能-完成报告.md)

---

**文档版本**：V1.0  
**最后更新**：2025-11-20  
**维护者**：CCO开发团队

