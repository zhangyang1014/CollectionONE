# 小组管理页面筛选功能实现说明

## 📋 功能概述

小组管理页面现在支持筛选功能，与其他管理页面保持一致：
- ✅ 默认全选（显示所有机构的所有小组）
- ✅ 可以选择机构进行筛选
- ✅ 可以选择小组进行筛选
- ✅ 选择机构后，小组选择器显示该机构的小组列表

## 🎯 实现内容

### 1. 添加小组选择器 ✅

**Before（之前）：**
```
┌────────────────────────────────────────┐
│  小组管理                               │
│  [选择机构▼]  [创建小组]               │
└────────────────────────────────────────┘
```

**After（现在）：**
```
┌────────────────────────────────────────┐
│  小组管理                               │
│  [全部机构▼] [全部小组▼] [创建小组]   │
└────────────────────────────────────────┘
```

### 2. 筛选逻辑 ✅

**三种筛选模式：**

1. **全选模式**（机构和小组都是undefined）
   - 显示所有机构的所有小组
   - 小组选择器被禁用

2. **按机构筛选**（选择了机构，小组为全选）
   - 显示该机构的所有小组
   - 小组选择器启用，显示该机构的小组列表

3. **按小组筛选**（选择了机构和小组）
   - 只显示该小组
   - 小组选择器显示该机构的小组列表

### 3. 数据结构 ✅

**新增变量：**
- `allTeams` - 存储所有小组（用于筛选）
- `teams` - 显示在表格中的小组（根据筛选条件过滤）
- `currentTeamId` - 当前选择的小组ID
- `filteredTeams` - 计算属性，用于小组选择器的选项

**关键代码：**
```typescript
// 存储所有小组
const allTeams = ref<any[]>([])

// 显示在表格中的小组（根据筛选条件）
const teams = ref<any[]>([])

// 计算属性：用于小组选择器的选项
const filteredTeams = computed(() => {
  if (!currentAgencyId.value) {
    return allTeams.value
  }
  return allTeams.value.filter(team => team.agency_id === currentAgencyId.value)
})
```

### 4. 加载逻辑 ✅

**loadAllTeams()** - 加载所有小组
```typescript
// 遍历所有机构，加载每个机构的小组
for (const agency of agencies.value) {
  const agencyTeams = await loadTeamsForAgency(agency.id)
  // 为每个小组添加机构信息
  agencyTeams.forEach((team: any) => {
    team.agency_name = agency.agency_name
    team.agency_id = agency.id
  })
  allTeams.value.push(...agencyTeams)
}
```

**loadTeams()** - 根据筛选条件过滤小组
```typescript
let filtered = [...allTeams.value]

// 如果选择了机构，筛选该机构的小组
if (currentAgencyId.value) {
  filtered = filtered.filter(team => team.agency_id === currentAgencyId.value)
}

// 如果选择了小组，只显示该小组
if (currentTeamId.value) {
  filtered = filtered.filter(team => team.id === currentTeamId.value)
}

teams.value = filtered
```

**handleAgencyChange()** - 机构切换时
```typescript
const handleAgencyChange = async () => {
  currentTeamId.value = undefined // 重置小组选择
  await loadTeams() // 重新应用筛选
}
```

## 📊 界面展示

### 默认状态（全选）

```
┌──────────────────────────────────────────────────────────┐
│  小组管理  [全部机构▼] [全部小组▼(禁用)] [创建小组]    │
├──────────────────────────────────────────────────────────┤
│ 小组ID│小组名│所属甲方│所属机构│组长│催员数│状态│操作   │
├───────┼─────┼───────┼───────┼────┼─────┼────┼──────┤
│ T001  │一组 │甲方A  │机构A  │组长A│  3  │启用│编辑 禁用│
│ T002  │二组 │甲方A  │机构A  │组长B│  2  │启用│编辑 禁用│
│ T003  │一组 │甲方A  │机构B  │组长C│  2  │启用│编辑 禁用│
│ ...   │（显示所有机构的所有小组）                        │
└──────────────────────────────────────────────────────────┘
```

### 选择机构后

```
┌──────────────────────────────────────────────────────────┐
│  小组管理  [机构A▼] [全部小组▼] [创建小组]              │
├──────────────────────────────────────────────────────────┤
│ 小组ID│小组名│所属甲方│所属机构│组长│催员数│状态│操作   │
├───────┼─────┼───────┼───────┼────┼─────┼────┼──────┤
│ T001  │一组 │甲方A  │机构A  │组长A│  3  │启用│编辑 禁用│
│ T002  │二组 │甲方A  │机构A  │组长B│  2  │启用│编辑 禁用│
│ ...   │（只显示机构A的小组）                             │
└──────────────────────────────────────────────────────────┘

小组选择器下拉：
┌─────────────┐
│ 全部小组    │
│ 催收一组    │ ← 机构A的小组
│ 催收二组    │ ← 机构A的小组
└─────────────┘
```

### 选择小组后

```
┌──────────────────────────────────────────────────────────┐
│  小组管理  [机构A▼] [催收一组▼] [创建小组]              │
├──────────────────────────────────────────────────────────┤
│ 小组ID│小组名│所属甲方│所属机构│组长│催员数│状态│操作   │
├───────┼─────┼───────┼───────┼────┼─────┼────┼──────┤
│ T001  │一组 │甲方A  │机构A  │组长A│  3  │启用│编辑 禁用│
│ ...   │（只显示催收一组）                                 │
└──────────────────────────────────────────────────────────┘
```

## 🧪 测试场景

### 场景1：默认全选
**步骤：**
1. 选择甲方
2. 进入"小组管理"页面

**预期结果：**
- ✅ 机构选择器显示"全部机构"
- ✅ 小组选择器显示"全部小组"且被禁用
- ✅ 表格显示所有机构的所有小组

### 场景2：选择机构
**步骤：**
1. 在机构选择器中选择"示例机构A-1"

**预期结果：**
- ✅ 小组选择器自动启用
- ✅ 小组选择器显示"全部小组"和该机构的所有小组
- ✅ 表格只显示该机构的小组

### 场景3：选择小组
**步骤：**
1. 选择机构后
2. 在小组选择器中选择"催收一组"

**预期结果：**
- ✅ 表格只显示"催收一组"
- ✅ 其他小组不显示

### 场景4：清除筛选
**步骤：**
1. 选择机构和小组
2. 点击机构选择器的清除按钮（×）

**预期结果：**
- ✅ 机构选择器恢复为"全部机构"
- ✅ 小组选择器被禁用
- ✅ 表格显示所有机构的所有小组

## 📁 修改的文件

- ✅ `frontend/src/views/organization/TeamManagement.vue`
  - 添加小组选择器
  - 添加 `allTeams` 和 `filteredTeams`
  - 添加 `loadAllTeams()` 函数
  - 修改 `loadTeams()` 函数支持筛选
  - 添加 `handleAgencyChange()` 函数
  - 更新初始加载逻辑

## ✅ 完成状态

- ✅ 小组选择器已添加
- ✅ 默认全选功能正常
- ✅ 机构筛选功能正常
- ✅ 小组筛选功能正常
- ✅ 选择机构后小组列表正确显示
- ✅ 无Linter错误

---

**实现时间：** 2024-11-11  
**版本：** v1.1  
**状态：** ✅ 已完成

**请刷新浏览器测试功能！** 🎉

