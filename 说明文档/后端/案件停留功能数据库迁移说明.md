# 案件停留功能数据库迁移说明

## 问题描述

如果访问停留案件列表时出现500错误，通常是因为数据库表还没有添加停留相关字段。

## 解决方案

### 1. 执行数据库迁移SQL

请在MySQL客户端中执行以下SQL脚本：

```bash
# 方式1：使用mysql命令行
mysql -u root -p cco_system < backend-java/src/main/resources/db/migration/add_case_stay_fields.sql

# 方式2：在MySQL客户端中直接执行
# 打开文件：backend-java/src/main/resources/db/migration/add_case_stay_fields.sql
# 复制内容到MySQL客户端执行
```

### 2. 验证字段是否添加成功

执行以下SQL查询，确认字段已添加：

```sql
DESC cases;
```

应该能看到以下字段：
- `is_stay` - TINYINT(1)
- `stay_at` - DATETIME
- `stay_by` - BIGINT
- `stay_released_at` - DATETIME
- `stay_released_by` - BIGINT

### 3. 如果字段已存在但仍有错误

检查后端日志，查看具体错误信息。常见问题：

1. **字段类型不匹配**：确保字段类型与SQL脚本一致
2. **索引冲突**：如果索引已存在，SQL会报错，可以忽略
3. **权限问题**：确保数据库用户有ALTER TABLE权限

### 4. 手动执行SQL（如果自动执行失败）

如果ALTER TABLE语句失败，可以手动执行：

```sql
USE cco_system;

-- 检查字段是否已存在
SHOW COLUMNS FROM cases LIKE 'is_stay';

-- 如果不存在，手动添加
ALTER TABLE `cases` 
ADD COLUMN `is_stay` TINYINT(1) DEFAULT 0 COMMENT '是否停留（独立状态字段，与case_status分离）' AFTER `next_follow_up_at`;

ALTER TABLE `cases` 
ADD COLUMN `stay_at` DATETIME NULL COMMENT '停留时间' AFTER `is_stay`;

ALTER TABLE `cases` 
ADD COLUMN `stay_by` BIGINT NULL COMMENT '停留操作人ID' AFTER `stay_at`;

ALTER TABLE `cases` 
ADD COLUMN `stay_released_at` DATETIME NULL COMMENT '解放停留时间' AFTER `stay_by`;

ALTER TABLE `cases` 
ADD COLUMN `stay_released_by` BIGINT NULL COMMENT '解放停留操作人ID' AFTER `stay_released_at`;

-- 添加索引（如果不存在）
ALTER TABLE `cases` ADD INDEX `idx_is_stay` (`is_stay`);
ALTER TABLE `cases` ADD INDEX `idx_stay_at` (`stay_at`);
ALTER TABLE `cases` ADD INDEX `idx_stay_by` (`stay_by`);

-- 更新现有数据
UPDATE `cases` SET `is_stay` = 0 WHERE `is_stay` IS NULL;
```

## 验证功能

执行迁移后，重启后端服务，然后：

1. 访问停留案件列表：`http://localhost:5173/cases/stay`
2. 应该能正常显示页面（即使没有停留案件，也应该显示空列表，而不是500错误）

## 注意事项

- 执行迁移前建议备份数据库
- 如果表中有大量数据，ALTER TABLE可能需要一些时间
- 迁移后，现有案件的`is_stay`字段默认为0（false），表示未停留

