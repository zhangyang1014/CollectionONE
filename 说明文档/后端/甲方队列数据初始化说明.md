# 甲方队列数据初始化说明

## 📋 问题描述

甲方案件队列管理页面显示"暂无数据"，原因是数据库中缺少案件队列（CaseQueue）的mock数据。

## 🔍 问题分析

经过检查发现：

1. **数据库表存在**：`case_queues` 表已经创建
2. **API接口正常**：`GET /api/v1/tenants/{tenant_id}/queues` 接口实现正确
3. **前端代码正常**：队列管理页面实现完整
4. **缺少数据**：初始化脚本 `init_all_data.py` 和 `init_complete_data.py` 没有创建队列数据

## ✅ 解决方案

### 1. 创建队列初始化脚本

创建了专门的脚本 `backend/init_case_queues.py` 用于初始化队列数据：

```bash
cd backend
source venv/bin/activate
python init_case_queues.py
```

### 2. 队列配置规则

每个甲方自动创建5个默认队列：

| 队列编码 | 队列名称 | 逾期天数范围 | 说明 |
|---------|---------|------------|------|
| **C** | C队列 | **-∞ ~ -1** | 未逾期，提前还款客户 |
| **S0** | S0队列 | **0 ~ 0** | 当日到期，需重点关注 |
| **S1** | S1队列 | **1 ~ 5** | 轻度逾期，友好提醒 |
| **L1** | L1队列 | **6 ~ 90** | 中度逾期，加强催收 |
| **M1** | M1队列 | **91 ~ +∞** | 重度逾期，专项处理 |

### 3. 更新初始化脚本

已更新以下脚本，使其在初始化时自动创建队列数据：

- `backend/init_all_data.py`
- `backend/init_complete_data.py`

## 📊 执行结果

```
================================================================================
初始化案件队列数据
================================================================================

找到 3 个甲方，开始创建队列...

1. 清空现有队列数据...
✓ 已删除 0 条现有队列数据

2. 为每个甲方创建默认队列...

  为甲方 [BTQ] 百腾企业 创建队列...
  ✓ 成功创建 5 个队列
    - C (C队列): -∞ ~ -1 天
    - S0 (S0队列): 0 ~ 0 天
    - S1 (S1队列): 1 ~ 5 天
    - L1 (L1队列): 6 ~ 90 天
    - M1 (M1队列): 91 ~ +∞ 天

  为甲方 [BTSK] 百腾数科 创建队列...
  ✓ 成功创建 5 个队列
    - C (C队列): -∞ ~ -1 天
    - S0 (S0队列): 0 ~ 0 天
    - S1 (S1队列): 1 ~ 5 天
    - L1 (L1队列): 6 ~ 90 天
    - M1 (M1队列): 91 ~ +∞ 天

  为甲方 [XYQY] 星耀企业 创建队列...
  ✓ 成功创建 5 个队列
    - C (C队列): -∞ ~ -1 天
    - S0 (S0队列): 0 ~ 0 天
    - S1 (S1队列): 1 ~ 5 天
    - L1 (L1队列): 6 ~ 90 天
    - M1 (M1队列): 91 ~ +∞ 天

3. 验证数据...
✓ 数据库中共有 15 个队列

================================================================================
✅ 案件队列数据初始化完成！
================================================================================

统计信息：
  - 甲方数量: 3
  - 队列总数: 15
  - 每个甲方: 5 个默认队列 (C, S0, S1, L1, M1)
```

## 🔧 验证步骤

### 1. 验证数据库数据

```bash
cd backend
source venv/bin/activate
python -c "
from sqlalchemy.orm import sessionmaker
from app.core.database import engine
from app.models import Tenant, CaseQueue

Session = sessionmaker(bind=engine)
session = Session()

tenant = session.query(Tenant).filter(Tenant.tenant_code == 'BTQ').first()
print(f'甲方：{tenant.tenant_name} (ID: {tenant.id})')
print('\\n队列列表：')
queues = session.query(CaseQueue).filter(CaseQueue.tenant_id == tenant.id).order_by(CaseQueue.sort_order).all()
for q in queues:
    start = '-∞' if q.overdue_days_start is None else q.overdue_days_start
    end = '+∞' if q.overdue_days_end is None else q.overdue_days_end
    print(f'  {q.queue_code} ({q.queue_name}): {start}~{end}天')
session.close()
"
```

### 2. 验证API接口

```bash
curl http://localhost:8000/api/v1/tenants/1/queues | python -m json.tool
```

### 3. 验证前端页面

1. 刷新前端页面
2. 进入"案件管理" -> "甲方案件队列管理"
3. 确认显示5个队列数据

## 📝 相关文件

### 新创建的文件
- `backend/init_case_queues.py` - 队列数据初始化脚本

### 修改的文件
- `backend/init_all_data.py` - 添加队列数据初始化
- `backend/init_complete_data.py` - 添加队列数据初始化

### 相关模型和API
- `backend/app/models/case_queue.py` - 队列数据模型
- `backend/app/api/tenants.py` - 队列API接口 (第169-182行)
- `frontend/src/views/tenant-management/QueueManagement.vue` - 队列管理页面

## 🎯 后续建议

1. **自动创建队列**：在创建新甲方时，自动为其创建默认的5个队列
2. **队列字段配置**：考虑为每个队列配置不同的字段显示规则
3. **队列分案规则**：完善基于队列的自动分案功能

## 📚 参考文档

- [甲方案件队列管理功能实现说明](../前端/甲方案件队列管理功能实现说明.md)
- [甲方案件队列默认配置规则](./甲方案件队列默认配置规则.md)

---

**修复时间**：2025-11-20  
**修复人员**：系统维护

