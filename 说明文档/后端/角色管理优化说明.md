# 角色管理优化说明

## 变更日期

2025-01-11

---

## 一、系统角色架构

系统定义了清晰的三级角色管理体系：

```
SuperAdmin（系统超级管理员）
    └─创建─→ 甲方（Tenant）
            └─创建─→ 甲方管理员（TenantAdmin）
                        └─创建─→ 催收机构（Collection Agency）
                                    └─创建─→ 机构管理员（AgencyAdmin）
                                                └─管理─→ 催收小组（Collection Team）
                                                            └─管理─→ 催员（Collector）
```

---

## 二、角色详细说明

### 2.1 SuperAdmin（系统超级管理员）

**特性：**
- 系统创建，无界面编辑
- 通过环境变量或配置文件管理
- 不存储在数据库的常规用户表中

**权限：**
- 创建、编辑、删除甲方
- **创建甲方时同时创建甲方管理员账号**

**创建内容：**
- 甲方基础信息（名称、编码、国家、时区、货币）
- 甲方管理员账号（账号名、账号ID、邮箱、密码）

### 2.2 甲方管理员（TenantAdmin）

**创建方式：**
- 由SuperAdmin在创建甲方时同时创建
- 填写以下信息：
  - 管理员账号名
  - 管理员登录ID
  - 管理员邮箱
  - 管理员密码

**特性：**
- 账号信息可由SuperAdmin编辑
- 可以自己修改密码和邮箱

**权限：**
- 管理本甲方的所有催收机构
- **创建机构时同时创建机构管理员账号**
- 管理本甲方的催收小组
- 管理本甲方的小组管理账号和催员
- 配置本甲方的自定义字段和案件队列

### 2.3 机构管理员（AgencyAdmin）

**创建方式：**
- 由甲方管理员在创建机构时同时创建
- 填写以下信息：
  - 管理员账号名
  - 管理员登录ID
  - 管理员邮箱
  - 管理员密码（仅创建时）

**特性：**
- 账号信息可由甲方管理员编辑
- 可以自己修改密码和邮箱
- 编辑机构时不需要重新输入密码

**权限：**
- 管理该机构下的所有催收小组
- 管理该机构下的催员账号
- 查看该机构的业绩数据

---

## 三、前端变更

### 3.1 甲方列表页面 (`TenantList.vue`) - 已完成 ✅

**变更内容：**
- 创建甲方对话框增加"甲方管理员账号"部分
- 表单字段：
  - 管理员账号名（必填）
  - 管理员登录ID（必填）
  - 管理员邮箱（必填，邮箱格式验证）
  - 管理员密码（必填，至少6位）
  - 确认密码（必填，一致性验证）

**交互逻辑：**
- 创建甲方时必须填写管理员信息
- 编辑甲方时可以修改管理员信息

### 3.2 机构管理页面 (`AgencyManagement.vue`) - 本次更新 ✅

**移除内容：**
- ❌ 机构管理员下拉选择器
- ❌ 模拟管理员数据列表

**新增内容：**
- ✅ 对话框宽度从600px增加到700px
- ✅ 添加"机构管理员账号"部分（使用分隔线）
- ✅ 表单字段：
  - 管理员账号名（必填）
  - 管理员登录ID（必填）
  - 管理员邮箱（必填，邮箱格式验证）
  - 管理员密码（必填，至少6位，仅创建时显示）
  - 确认密码（必填，一致性验证，仅创建时显示）

**交互逻辑：**
- 创建机构时必须填写管理员信息
- 编辑机构时不显示密码字段，但可以修改账号名、登录ID和邮箱
- 密码修改需要通过单独的"修改密码"功能

---

## 四、数据结构变更

### 4.1 tenant_admins 表

```sql
CREATE TABLE tenant_admins (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '所属甲方ID',
    admin_name VARCHAR(50) NOT NULL COMMENT '管理员账号名',
    login_id VARCHAR(50) NOT NULL UNIQUE COMMENT '登录ID',
    email VARCHAR(100) NOT NULL COMMENT '邮箱',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_at TIMESTAMP NULL COMMENT '最近登录时间',
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_login_id (login_id),
    UNIQUE KEY uk_login_id (login_id)
) COMMENT '甲方管理员表';
```

### 4.2 agency_admins 表（新增）

```sql
CREATE TABLE agency_admins (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id BIGINT NOT NULL COMMENT '所属甲方ID',
    agency_id BIGINT NOT NULL COMMENT '所属机构ID',
    admin_name VARCHAR(50) NOT NULL COMMENT '管理员账号名',
    login_id VARCHAR(50) NOT NULL UNIQUE COMMENT '登录ID',
    email VARCHAR(100) NOT NULL COMMENT '邮箱',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_at TIMESTAMP NULL COMMENT '最近登录时间',
    
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    FOREIGN KEY (agency_id) REFERENCES collection_agencies(id) ON DELETE CASCADE,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_agency_id (agency_id),
    INDEX idx_login_id (login_id),
    UNIQUE KEY uk_login_id (login_id),
    UNIQUE KEY uk_agency_admin (agency_id)
) COMMENT '机构管理员表';
```

**说明：**
- `uk_agency_admin`: 确保一个机构只有一个管理员
- `uk_login_id`: 确保登录ID全局唯一

### 4.3 collection_agencies 表更新

```sql
-- 移除原有的 admin_id 字段（如果存在）
ALTER TABLE collection_agencies 
    DROP COLUMN IF EXISTS admin_id;

-- 不需要添加新字段，因为通过 agency_admins 表关联
```

---

## 五、API设计

### 5.1 创建甲方（含管理员）- 已实现 ✅

**接口：** `POST /api/v1/tenants`

**请求体：**
```json
{
  "tenant_name": "示例甲方A",
  "tenant_code": "TENANT001",
  "country_code": "CN",
  "timezone": "Asia/Shanghai",
  "currency_code": "CNY",
  "admin": {
    "admin_name": "张三",
    "login_id": "zhangsan001",
    "email": "zhangsan@example.com",
    "password": "SecurePass123"
  }
}
```

**后端逻辑：**
```python
async def create_tenant_with_admin(data: TenantCreateRequest):
    async with db.transaction():
        # 1. 创建甲方
        tenant = await create_tenant(data.tenant)
        
        # 2. 创建甲方管理员
        admin_data = data.admin
        admin_data.tenant_id = tenant.id
        admin_data.password_hash = hash_password(admin_data.password)
        admin = await create_tenant_admin(admin_data)
        
        # 3. 初始化标准字段配置
        await initialize_standard_fields(tenant.id)
        
        # 4. 创建默认案件队列
        await create_default_queues(tenant.id)
        
        return {"tenant": tenant, "admin": admin}
```

### 5.2 创建机构（含管理员）- 待实现 ⏳

**接口：** `POST /api/v1/tenants/{tenant_id}/agencies`

**请求体：**
```json
{
  "agency_code": "AGENCY001",
  "agency_name": "示例机构A",
  "contact_phone": "13800138000",
  "contact_email": "agency@example.com",
  "remark": "备注信息",
  "is_active": true,
  "admin": {
    "admin_name": "李四",
    "login_id": "lisi001",
    "email": "lisi@example.com",
    "password": "SecurePass456"
  }
}
```

**响应体：**
```json
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "agency": {
      "id": 1,
      "tenant_id": 1,
      "agency_code": "AGENCY001",
      "agency_name": "示例机构A",
      "contact_phone": "13800138000",
      "contact_email": "agency@example.com",
      "is_active": true,
      "created_at": "2025-01-11T10:00:00Z",
      "updated_at": "2025-01-11T10:00:00Z"
    },
    "admin": {
      "id": 1,
      "tenant_id": 1,
      "agency_id": 1,
      "admin_name": "李四",
      "login_id": "lisi001",
      "email": "lisi@example.com",
      "is_active": true,
      "created_at": "2025-01-11T10:00:00Z"
    }
  }
}
```

**后端逻辑：**
```python
async def create_agency_with_admin(tenant_id: int, data: AgencyCreateRequest):
    async with db.transaction():
        # 1. 创建机构
        agency_data = data.dict(exclude={'admin'})
        agency_data['tenant_id'] = tenant_id
        agency = await create_agency(agency_data)
        
        # 2. 创建机构管理员
        admin_data = data.admin
        admin_data['tenant_id'] = tenant_id
        admin_data['agency_id'] = agency.id
        admin_data['password_hash'] = hash_password(admin_data.password)
        admin = await create_agency_admin(admin_data)
        
        return {"agency": agency, "admin": admin}
```

### 5.3 编辑机构（含管理员）- 待实现 ⏳

**接口：** `PUT /api/v1/agencies/{agency_id}`

**请求体：**
```json
{
  "agency_name": "示例机构A（更新）",
  "contact_phone": "13900139000",
  "contact_email": "agency_new@example.com",
  "remark": "更新后的备注",
  "is_active": true,
  "admin": {
    "admin_name": "李四",
    "login_id": "lisi001",
    "email": "lisi_new@example.com"
  }
}
```

**说明：**
- 编辑时不包含密码字段
- 管理员信息可以修改（账号名、登录ID、邮箱）
- 密码修改需要单独的接口

---

## 六、使用流程

### 6.1 SuperAdmin 创建甲方流程

```
1. SuperAdmin 登录系统
   ↓
2. 进入"甲方列表"页面，点击"添加甲方"
   ↓
3. 填写甲方基础信息
   - 甲方名称
   - 甲方编码
   - 国家代码
   - 时区
   - 货币
   ↓
4. 填写甲方管理员账号信息
   - 管理员账号名
   - 管理员登录ID
   - 管理员邮箱
   - 管理员密码（至少6位）
   - 确认密码
   ↓
5. 点击"保存"
   ↓
6. 系统自动完成：
   - ✅ 创建甲方记录
   - ✅ 创建甲方管理员账号（密码加密存储）
   - ✅ 初始化标准字段配置
   - ✅ 创建默认案件队列
```

### 6.2 甲方管理员创建机构流程

```
1. 甲方管理员登录
   ↓
2. 进入"机构管理"页面，点击"创建机构"
   ↓
3. 填写机构基础信息
   - 机构编码
   - 机构名称
   - 联系电话
   - 联系邮箱
   - 备注
   ↓
4. 填写机构管理员账号信息
   - 管理员账号名
   - 管理员登录ID
   - 管理员邮箱
   - 管理员密码（至少6位）
   - 确认密码
   ↓
5. 点击"保存"
   ↓
6. 系统自动完成：
   - ✅ 创建机构记录
   - ✅ 创建机构管理员账号（密码加密存储）
```

---

## 七、表单验证规则

### 7.1 甲方管理员账号

| 字段 | 规则 | 说明 |
|------|------|------|
| 管理员账号名 | 必填，最长50字符 | 用于显示 |
| 管理员登录ID | 必填，最长50字符，全局唯一 | 用于登录 |
| 管理员邮箱 | 必填，邮箱格式，最长100字符 | 用于找回密码 |
| 管理员密码 | 必填，至少6位，最长50字符 | 仅创建时 |
| 确认密码 | 必填，与密码一致 | 仅创建时 |

### 7.2 机构管理员账号

| 字段 | 规则 | 说明 |
|------|------|------|
| 管理员账号名 | 必填，最长50字符 | 用于显示 |
| 管理员登录ID | 必填，最长50字符，全局唯一 | 用于登录 |
| 管理员邮箱 | 必填，邮箱格式，最长100字符 | 用于找回密码 |
| 管理员密码 | 必填，至少6位，最长50字符 | 仅创建时 |
| 确认密码 | 必填，与密码一致 | 仅创建时 |

---

## 八、安全考虑

### 8.1 密码安全

- 所有密码使用bcrypt或Argon2进行哈希存储
- 最小密码长度：6位
- 建议密码包含大小写字母、数字、特殊字符
- 前端使用`show-password`显示密码输入

### 8.2 登录ID唯一性

- 所有管理员的登录ID全局唯一
- SuperAdmin、甲方管理员、机构管理员的登录ID不能重复
- 数据库层面通过UNIQUE约束保证

### 8.3 权限隔离

- 甲方管理员只能管理本甲方的机构
- 机构管理员只能管理本机构的小组和催员
- 数据查询时强制添加tenant_id过滤

---

## 九、待实现功能

### 9.1 后端

- [ ] 实现 `POST /api/v1/tenants/{tenant_id}/agencies` 接口
- [ ] 实现 `PUT /api/v1/agencies/{agency_id}` 接口
- [ ] 创建 `agency_admins` 表
- [ ] 实现机构管理员认证中间件
- [ ] 实现密码修改接口
- [ ] 实现找回密码功能

### 9.2 前端

- [ ] 集成实际的API调用（创建机构）
- [ ] 实现机构管理员登录页面
- [ ] 实现密码修改功能
- [ ] 实现找回密码功能

### 9.3 Mock Server

- [ ] 更新 `backend/simple_server.py`，添加创建机构的mock接口
- [ ] mock数据中添加机构管理员信息

---

## 十、总结

本次优化明确了系统的角色创建流程：

✅ **SuperAdmin创建甲方** → 同时创建甲方管理员账号  
✅ **甲方管理员创建机构** → 同时创建机构管理员账号  
✅ **账号填写方式** → 直接填写账号信息，不再使用下拉选择  
✅ **密码管理** → 仅创建时输入密码，编辑时不显示密码字段  
✅ **表单验证** → 完整的必填项、格式、一致性验证  

这种设计确保了：
- ✅ 角色创建流程清晰
- ✅ 权限层级分明
- ✅ 数据安全可靠
- ✅ 操作简便高效

