# 后端404错误修复说明

**修复日期**: 2025-11-22  
**修复人**: AI助手  
**状态**: ✅ 已修复

---

## 🐛 问题描述

前端在访问以下API时出现404错误：

1. `/api/v1/field-display-configs?tenant_id=...&scene=collector_case_list`
2. `/api/v1/field-display-configs?tenant_id=...&scene=collector_case_detail`
3. `/api/v1/cases?tenant_id=...&collector_id=37`

### 错误信息

```
Failed to load resource: the server responded with a status of 404 (Not Found)
[useFieldDisplayConfig] 加载字段配置失败: Error: HTTP 404: Not Found
加载案件失败: AxiosError
```

---

## 🔍 问题分析

经过排查发现问题原因：

### 1. Python后端未正常运行

- 8000端口被一个旧的 `server.py` 进程占用
- FastAPI后端没有成功启动，导致所有API返回404

### 2. 进程冲突

```bash
$ lsof -i :8000
COMMAND   PID      USER   FD   TYPE   NODE NAME
Python  90189 zhangyang    8u  IPv4   TCP *:irdmi (LISTEN)
Python  90402 zhangyang    8u  IPv4   TCP *:irdmi (LISTEN)
```

两个Python进程在占用8000端口，阻止了FastAPI后端的启动。

---

## ✅ 解决方案

### 步骤1: 停止占用端口的进程

```bash
# 查找占用8000端口的进程
lsof -i :8000

# 停止这些进程
kill 90189 90402
```

### 步骤2: 启动Python FastAPI后端

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload > ../backend.log 2>&1 &
```

### 步骤3: 验证服务启动成功

```bash
# 检查健康状态
curl http://localhost:8000/health
# 响应: {"status":"healthy"}

# 测试字段展示配置API
curl "http://localhost:8000/api/v1/field-display-configs?tenant_id=1&scene_type=collector_case_list"
# 响应: [... 16603字节的JSON数据 ...]

# 测试案件列表API
curl "http://localhost:8000/api/v1/cases?tenant_id=1&collector_id=37"
# 响应: [... 6885字节的JSON数据 ...]
```

---

## 📊 修复结果

### ✅ 修复后的API状态

| API端点 | 状态 | 响应 |
|---------|------|------|
| `/health` | ✅ 正常 | `{"status":"healthy"}` |
| `/api/v1/field-display-configs` | ✅ 正常 | 返回配置数据 |
| `/api/v1/cases` | ✅ 正常 | 返回案件列表 |

### 测试结果

```bash
# 字段展示配置 - collector_case_list
✅ 返回数据: 16603字节 (约50条配置)

# 字段展示配置 - collector_case_detail
✅ 返回数据: 90条配置

# 案件列表
✅ 返回数据: 6885字节 (多条案件记录)
```

---

## 🎯 根本原因

1. **端口冲突**: 8000端口被旧的Python脚本占用
2. **服务未启动**: FastAPI后端因端口占用无法启动
3. **错误不明显**: 启动日志被重定向，错误信息不容易发现

---

## 💡 预防措施

### 1. 启动前检查端口

在启动后端服务前，先检查端口是否被占用：

```bash
# 检查8000端口
lsof -i :8000

# 如果有进程占用，先停止
kill <PID>
```

### 2. 使用启动脚本

创建一个统一的启动脚本 `backend/start.sh`：

```bash
#!/bin/bash

# 检查端口
PORT=8000
PID=$(lsof -ti:$PORT)

if [ ! -z "$PID" ]; then
    echo "端口 $PORT 已被进程 $PID 占用，正在停止..."
    kill $PID
    sleep 2
fi

# 启动后端
cd /path/to/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port $PORT --reload
```

### 3. 监控日志

定期检查后端日志文件：

```bash
tail -f backend.log
```

---

## 📝 相关文件

- **后端主文件**: `backend/app/main.py`
- **字段展示配置API**: `backend/app/api/field_display.py`
- **案件管理API**: `backend/app/api/cases.py`
- **启动日志**: `backend.log`

---

## 🔗 相关文档

- [后端双系统架构说明](../../文档/后端双系统架构说明.md)
- [后端服务启动说明](../部署/后端服务启动说明.md)
- [甲方字段展示配置-完成报告](../../文档/功能说明/甲方字段展示配置-完成报告.md)

---

## ✅ 总结

**问题**: 前端访问API时出现404错误  
**原因**: Python后端因端口冲突未能正常启动  
**解决**: 停止占用进程并重新启动FastAPI后端  
**结果**: 所有API恢复正常，前端可以正常访问

**当前状态**: 🟢 Python后端运行在8000端口，所有API正常工作


