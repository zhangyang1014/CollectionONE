# 标准字段显示问题修复说明

## 问题描述

**症状**: 标准字段管理页面显示空白表格
- 表格有行数，但字段名称、类型等列都显示为"-"
- 左侧分组树正常显示

**根本原因**: 后端返回的字段名格式（驼峰式）与前端期望的格式（下划线式）不匹配

## 解决方案

### 1. 后端配置修改

**文件**: `backend-java/src/main/resources/application.yml`

**变更**: 添加Jackson的SNAKE_CASE命名策略

```yaml
# Jackson 配置
jackson:
  time-zone: GMT+8
  date-format: yyyy-MM-dd HH:mm:ss
  serialization:
    write-dates-as-timestamps: false
  default-property-inclusion: non_null
  property-naming-strategy: SNAKE_CASE  # 新增：使用下划线命名
```

**效果**: 
- 驼峰式: `fieldKey` → 下划线式: `field_key`
- 驼峰式: `fieldName` → 下划线式: `field_name`
- 驼峰式: `enumOptions` → 下划线式: `enum_options`

### 2. 前端代码修改

**文件**: `frontend/src/views/field-config/StandardFields.vue`

**变更**: 将所有 `enum_values` 改为 `enum_options` 以匹配后端

**修改点**:
1. 表格列定义: `prop="enum_values"` → `prop="enum_options"`
2. 模板引用: `row.enum_values` → `row.enum_options`
3. 表单数据: `form.value.enum_values` → `form.value.enum_options`

**文件**: `frontend/src/types/index.ts`

**变更**: 更新StandardField接口定义

```typescript
export interface StandardField {
  // ... 其他字段 ...
  enum_options?: Array<{
    standard_name: string
    standard_id: string
    tenant_name: string
    tenant_id: string
  }>  // 从 string[] 改为完整的对象数组
  // ... 其他字段 ...
}
```

## 验证步骤

### 1. 确保后端运行

```bash
# 检查后端是否运行在8080端口
curl http://localhost:8080/api/v1/standard-fields | python3 -m json.tool | head -20
```

**预期输出**:
```json
{
    "code": 200,
    "message": "success",
    "data": [
        {
            "id": 1,
            "field_key": "user_id",        // ✅ 下划线格式
            "field_name": "用户编号",
            "field_type": "String",
            "field_group_id": 11,
            "is_required": true,
            // ...
        }
    ]
}
```

### 2. 测试枚举字段

```bash
# 获取包含枚举字段的分组
curl 'http://localhost:8080/api/v1/standard-fields?field_group_id=11' | \
  python3 -c "import sys, json; data = json.load(sys.stdin)['data']; \
  enum_field = [f for f in data if f.get('field_type') == 'Enum'][0]; \
  print(json.dumps(enum_field, indent=2, ensure_ascii=False))"
```

**预期输出**:
```json
{
  "id": 3,
  "field_key": "gender",
  "field_name": "性别",
  "field_type": "Enum",
  "enum_options": [              // ✅ 正确的字段名
    {
      "standard_name": "Male",
      "standard_id": "male",
      "tenant_name": "Male",
      "tenant_id": "male"
    },
    {
      "standard_name": "Female",
      "standard_id": "female",
      "tenant_name": "Female",
      "tenant_id": "female"
    }
  ]
}
```

### 3. 前端页面验证

1. **访问页面**: http://localhost:5173/#/system/fields/standard

2. **检查点**:
   - ✅ 左侧分组树显示完整
   - ✅ 点击分组后，右侧表格显示字段详情
   - ✅ 字段名称、标识、类型等列有内容
   - ✅ 枚举类型字段显示枚举值标签
   - ✅ 必填/非必填状态正确显示

3. **预期效果**:

| 字段名称 | 字段标识 | 字段类型 | 枚举值 | 是否必填 | 排序 |
|---------|---------|---------|--------|---------|------|
| 用户编号 | user_id | String | - | 必填 | 1 |
| 用户姓名 | user_name | String | - | 必填 | 2 |
| 性别 | gender | Enum | Male, Female | 非必填 | 3 |
| 出生日期 | birth_date | Date | - | 非必填 | 4 |

## 数据统计

**当前已导入字段**: 74个

**分组分布**:
- 基础身份信息（ID: 11）: 11个字段
- 教育信息（ID: 12）: 3个字段
- 职业信息（ID: 13）: 11个字段
- 用户行为与信用（ID: 14）: 10个字段
- 联系方式（ID: 15）: 2个字段
- 贷款详情（ID: 2）: 23个字段
- 借款记录（ID: 3）: 14个字段

## 已知限制

### 1. 部分字段未导入

**原因**: SQL脚本中存在重复的 `field_key`

**影响**: 约41个字段因重复键冲突未能导入

**后续**: 需要修改SQL脚本，为重复字段添加唯一前缀

### 2. 功能限制

**当前状态**: 只读模式
- ✅ 查看字段列表
- ✅ 按分组筛选
- ✅ 查看枚举值
- ❌ 创建字段（待实现）
- ❌ 编辑字段（待实现）
- ❌ 删除字段（待实现）

## 故障排查

### 问题1: 表格仍显示空白

**检查步骤**:
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 硬刷新页面（Ctrl+Shift+R）
3. 打开浏览器开发者工具（F12）
4. 检查Network标签，查看API请求返回的数据格式
5. 检查Console标签，查看是否有JavaScript错误

### 问题2: 后端返回驼峰式字段名

**原因**: 后端未重新编译或未重启

**解决**:
```bash
cd backend-java
JAVA_HOME=/opt/homebrew/opt/openjdk@17 \
PATH=/opt/homebrew/opt/openjdk@17/bin:$PATH \
mvn clean package -DskipTests

# 停止旧进程
lsof -ti :8080 | xargs kill -9

# 启动新版本
nohup java -jar target/cco-backend-1.0.0.jar --spring.profiles.active=dev &
```

### 问题3: 枚举值不显示

**检查**:
1. 确认后端返回的字段名是 `enum_options` 而不是 `enumOptions`
2. 确认前端代码使用 `row.enum_options` 而不是 `row.enum_values`
3. 确认枚举项包含 `standard_name` 字段

## 相关文件

### 后端
- `backend-java/src/main/resources/application.yml` - Jackson配置
- `backend-java/src/main/java/com/cco/controller/StandardFieldController.java` - API控制器
- `backend-java/src/main/java/com/cco/service/impl/StandardFieldServiceImpl.java` - 业务逻辑
- `backend-java/src/main/java/com/cco/mapper/StandardFieldMapper.java` - 数据访问

### 前端
- `frontend/src/views/field-config/StandardFields.vue` - 页面组件
- `frontend/src/types/index.ts` - TypeScript类型定义
- `frontend/src/api/field.ts` - API调用

### 数据库
- `backend-java/src/main/resources/db/data/init_standard_fields.sql` - 初始化数据

## 技术要点

### 字段名映射关系

| Java实体（驼峰式） | JSON输出（下划线式） | 前端接口（下划线式） |
|-------------------|---------------------|---------------------|
| fieldKey | field_key | field_key |
| fieldName | field_name | field_name |
| fieldType | field_type | field_type |
| fieldGroupId | field_group_id | field_group_id |
| isRequired | is_required | is_required |
| enumOptions | enum_options | enum_options |

### Jackson配置说明

```yaml
property-naming-strategy: SNAKE_CASE
```

**效果**: 
- 自动将Java实体的驼峰式字段名转换为JSON的下划线式
- 序列化（Java → JSON）: `fieldName` → `field_name`
- 反序列化（JSON → Java）: `field_name` → `fieldName`

**优点**:
- 统一前后端命名风格
- 无需修改Java实体类
- 自动处理所有API响应

---

**修复完成时间**: 2025-12-05 18:30
**状态**: ✅ 已修复，前端可正常显示数据







