# 公共通知功能优化说明

## 优化概述

本次优化主要针对公共通知配置功能进行了以下改进：

1. **移除了"内容类型"字段**：统一为标题、正文、链接（可选）的格式
2. **调整了表单布局**：将"是否启用"移到最上面，更符合使用习惯
3. **增强了非强制阅读配置**：添加了重复提醒、最大提醒次数、通知时间范围等配置

## 主要变更

### 1. 后端模型变更 (`backend/app/models/public_notification.py`)

#### 修改的字段
- `h5_content`: 从必填改为可选（`nullable=True`），注释更新为"H5链接地址（可选）"

#### 新增的字段
```python
# 非强制阅读时的配置
repeat_interval_minutes = Column(Integer, nullable=True, comment="重复提醒时间间隔（分钟）")
max_remind_count = Column(Integer, nullable=True, comment="最大提醒次数")
notify_time_start = Column(String(5), nullable=True, comment="通知时间范围开始（HH:MM）")
notify_time_end = Column(String(5), nullable=True, comment="通知时间范围结束（HH:MM）")
```

### 2. 后端 Schema 变更 (`backend/app/schemas/notification.py`)

更新了 `PublicNotificationBase`、`PublicNotificationUpdate` 等 Schema，添加了新字段的定义：

```python
# 非强制阅读时的配置
repeat_interval_minutes: Optional[int] = Field(None, ge=1, description="重复提醒时间间隔（分钟）")
max_remind_count: Optional[int] = Field(None, ge=1, description="最大提醒次数")
notify_time_start: Optional[str] = Field(None, description="通知时间范围开始（HH:MM）")
notify_time_end: Optional[str] = Field(None, description="通知时间范围结束（HH:MM）")
```

### 3. 前端类型定义变更 (`frontend/src/types/notification.ts`)

更新了 `PublicNotification`、`PublicNotificationCreate`、`PublicNotificationUpdate` 接口，添加了新字段：

```typescript
// 非强制阅读时的配置
repeat_interval_minutes?: number | null
max_remind_count?: number | null
notify_time_start?: string | null
notify_time_end?: string | null
```

### 4. 前端界面优化 (`frontend/src/views/system/components/PublicNotificationConfig.vue`)

#### 表格变更
- **移除**：内容类型列（`h5_content_type`）

#### 表单布局优化

1. **"是否启用"移到最上面**
   - 添加了说明文字："关闭后，该通知将不会显示给用户"
   - 使用分隔线（`<el-divider />`）分隔不同区块

2. **H5链接地址改为可选**
   - 更新了占位符文本："请输入H5链接地址（可选）"
   - 添加了说明："可选项，填写后用户点击通知可跳转到指定链接"

3. **新增非强制阅读配置区块**（仅在非强制阅读时显示）
   ```vue
   <template v-if="!form.is_forced_read">
     <!-- 重复提醒间隔 -->
     <el-form-item label="重复提醒间隔">
       <el-input-number v-model="form.repeat_interval_minutes" ... />
       <span>单位：分钟，用户关闭后多久再次提醒</span>
     </el-form-item>
     
     <!-- 最大提醒次数 -->
     <el-form-item label="最大提醒次数">
       <el-input-number v-model="form.max_remind_count" ... />
       <span>最多提醒多少次后不再显示</span>
     </el-form-item>
     
     <!-- 通知时间范围 -->
     <el-form-item label="通知时间范围">
       <el-time-picker v-model="notifyTimeStart" ... />
       <span>至</span>
       <el-time-picker v-model="notifyTimeEnd" ... />
       <div>仅在指定时间段内显示通知，不填则全天显示</div>
     </el-form-item>
   </template>
   ```

4. **表单验证规则更新**
   - 移除了 `h5_content` 的必填验证
   - 保留了 `title` 和 `content` 的必填验证

#### 逻辑变更

1. **新增计算属性**
   ```typescript
   const notifyTimeStart = computed({
     get: () => form.value.notify_time_start,
     set: (value: string | null) => { form.value.notify_time_start = value }
   })
   
   const notifyTimeEnd = computed({
     get: () => form.value.notify_time_end,
     set: (value: string | null) => { form.value.notify_time_end = value }
   })
   ```

2. **更新表单初始化**
   - `handleAdd()` 和 `handleEdit()` 函数中添加了新字段的初始化

## 数据库迁移

提供了数据库迁移脚本 `backend/update_public_notification_fields.py`，用于更新现有数据库表结构。

### 执行迁移

```bash
cd backend
python update_public_notification_fields.py
```

### 迁移内容

1. 修改 `h5_content` 字段为可空
2. 添加 `repeat_interval_minutes` 字段
3. 添加 `max_remind_count` 字段
4. 添加 `notify_time_start` 字段
5. 添加 `notify_time_end` 字段

## 功能说明

### 强制阅读模式

当开启"强制阅读"时：
- 用户必须点击"已阅读"按钮才能关闭通知
- 不显示重复提醒、最大提醒次数、通知时间范围等配置

### 非强制阅读模式

当关闭"强制阅读"时，可以配置：

1. **重复提醒间隔**（分钟）
   - 用户关闭通知后，经过设定的时间间隔会再次显示
   - 取值范围：1-1440 分钟（1天）

2. **最大提醒次数**
   - 设置通知最多提醒的次数
   - 达到最大次数后不再显示
   - 取值范围：1-100 次

3. **通知时间范围**
   - 设置每天显示通知的时间段（HH:MM 格式）
   - 例如：09:00 至 18:00，仅在工作时间显示
   - 不填则全天显示

### 其他配置

- **轮播间隔**：多条通知时的轮播切换间隔（秒）
- **生效时间范围**：通知的有效期，不填则长期有效
- **通知对象**：可选择催员、小组长等角色

## 使用示例

### 示例 1：重要公告（强制阅读）

```
是否启用：✓ 开启
通知标题：系统维护通知
通知正文：系统将于今晚 22:00-24:00 进行维护，请提前保存工作内容。
H5链接地址：（留空）
轮播间隔：30 秒
强制阅读：✓ 开启
```

### 示例 2：日常提醒（非强制阅读）

```
是否启用：✓ 开启
通知标题：每日工作提醒
通知正文：请及时跟进今日待处理案件
H5链接地址：https://example.com/daily-tasks
轮播间隔：60 秒
强制阅读：✗ 关闭
重复提醒间隔：120 分钟
最大提醒次数：3 次
通知时间范围：09:00 至 18:00
```

## 注意事项

1. **数据库迁移**：在使用新功能前，必须先执行数据库迁移脚本
2. **向后兼容**：新增字段均为可选，不影响现有数据
3. **时间格式**：通知时间范围使用 HH:MM 格式（24小时制）
4. **H5链接**：现在是可选项，不填写也能正常保存

## 测试建议

1. 测试强制阅读模式下的通知显示
2. 测试非强制阅读模式下的重复提醒功能
3. 测试通知时间范围的限制效果
4. 测试最大提醒次数的限制效果
5. 测试 H5 链接的可选性（填写和不填写两种情况）

## 相关文件

- 后端模型：`backend/app/models/public_notification.py`
- 后端 Schema：`backend/app/schemas/notification.py`
- 前端类型：`frontend/src/types/notification.ts`
- 前端组件：`frontend/src/views/system/components/PublicNotificationConfig.vue`
- 数据库迁移：`backend/update_public_notification_fields.py`

---

**更新时间**：2025-11-19  
**版本**：v1.0

