# 案件列表筛选器优化说明

## 变更日期

2025-01-11

---

## 一、优化概述

本次优化对案件列表页面的筛选器进行了全面升级，增强了筛选功能，提升了用户体验。

---

## 二、主要变更

### 2.1 集成全局甲方选择器

**变更前：**
- 案件列表页面有独立的甲方选择下拉框
- 需要每次手动选择甲方

**变更后：**
- ✅ 使用右上角全局的甲方选择器（`useTenantStore`）
- ✅ 自动同步全局选中的甲方
- ✅ 甲方切换时自动刷新案件列表和筛选器选项

### 2.2 更新案件状态筛选

**变更前：**
- 案件状态：进行中、已结清、逾期

**变更后：**
- ✅ 案件子状态：
  - 待还款
  - 部分还款
  - 正常结清
  - 展期结清
- ✅ 默认为"全部"

### 2.3 新增案件队列筛选

- ✅ 支持按案件队列筛选（C, S0, S1, L1, M1等）
- ✅ 队列列表根据当前选中的甲方动态加载

### 2.4 新增日期范围筛选

#### 到期日筛选
- ✅ 支持选择开始日期和结束日期
- ✅ 使用日期范围选择器（`el-date-picker` type="daterange"）

#### 结清日期筛选
- ✅ 支持选择开始日期和结束日期
- ✅ 使用日期范围选择器

### 2.5 新增组织架构筛选

#### 催收机构筛选
- ✅ 根据当前甲方加载机构列表
- ✅ 支持"全部"选项

#### 催收小组筛选
- ✅ 根据选中的机构加载小组列表
- ✅ 选中机构后才能选择小组
- ✅ 支持"全部"选项

#### 催员筛选
- ✅ 根据选中的小组加载催员列表
- ✅ 选中小组后才能选择催员
- ✅ 支持"全部"选项

---

## 三、UI 布局优化

### 3.1 筛选器布局

采用两行布局，每行使用 `el-row` 和 `el-col` 组件：

```
┌─────────────────────────────────────────────────────────────┐
│ 第一行                                                       │
│ ┌──────────┬──────────┬──────────┬──────────┐              │
│ │ 案件状态  │ 案件队列  │ 催收机构  │ 催收小组 │              │
│ └──────────┴──────────┴──────────┴──────────┘              │
│                                                              │
│ 第二行                                                       │
│ ┌──────────┬─────────────────┬─────────────────┐           │
│ │  催员    │   到期日         │   结清日期       │           │
│ └──────────┴─────────────────┴─────────────────┘           │
│                                                              │
│                                      [查询] [重置]           │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 样式优化

- ✅ 筛选器背景色：浅灰色（#f5f7fa）
- ✅ 圆角边框：4px
- ✅ 内边距：20px
- ✅ 所有输入框自动占满列宽
- ✅ 表单项间距统一为 16px
- ✅ 查询和重置按钮右对齐

---

## 四、交互逻辑

### 4.1 级联筛选

```
选择甲方
  ↓
加载案件队列、催收机构
  ↓
选择催收机构
  ↓
加载该机构的催收小组
  ↓
选择催收小组
  ↓
加载该小组的催员
  ↓
选择催员
```

### 4.2 联动关系

- **甲方变更**：重置所有筛选器，重新加载队列和机构
- **机构变更**：清空小组和催员选择，重新加载小组列表
- **小组变更**：清空催员选择，重新加载催员列表

### 4.3 重置功能

点击"重置"按钮：
- ✅ 清空所有筛选条件
- ✅ 清空搜索关键词
- ✅ 重置分页到第一页
- ✅ 清空小组和催员列表
- ✅ 重新加载案件数据

---

## 五、技术实现

### 5.1 文件变更

**修改文件：** `frontend/src/views/case-management/CaseList.vue`

### 5.2 核心代码变更

#### 引入全局甲方状态管理

```typescript
import { useTenantStore } from '@/stores/tenant'

const tenantStore = useTenantStore()
const currentTenantId = computed(() => tenantStore.currentTenantId)
```

#### 新增筛选器字段

```typescript
const filters = ref({
  case_status: undefined,       // 案件状态
  queue_id: undefined,          // 案件队列
  agency_id: undefined,         // 催收机构
  team_id: undefined,           // 催收小组
  collector_id: undefined,      // 催员
  due_date_range: null,         // 到期日范围
  settlement_date_range: null,  // 结清日期范围
})
```

#### 新增数据加载函数

```typescript
// 加载案件队列
const loadQueues = async () => { ... }

// 加载催收机构
const loadAgencies = async () => { ... }

// 加载催收小组
const loadTeams = async () => { ... }

// 加载催员
const loadCollectors = async () => { ... }
```

#### 监听全局甲方变化

```typescript
watch(currentTenantId, async (newTenantId) => {
  if (newTenantId) {
    // 重置筛选器并加载数据
    await loadQueues()
    await loadAgencies()
    await loadCases()
  } else {
    // 清空所有数据
    cases.value = []
    queues.value = []
    agencies.value = []
    teams.value = []
    collectors.value = []
  }
})
```

#### 处理级联选择

```typescript
// 处理机构变更
const handleAgencyChange = () => {
  filters.value.team_id = undefined
  filters.value.collector_id = undefined
  teams.value = []
  collectors.value = []
  loadTeams()
}

// 处理小组变更
const handleTeamChange = () => {
  filters.value.collector_id = undefined
  collectors.value = []
  loadCollectors()
}
```

---

## 六、API 接口

### 6.1 获取案件队列

**接口：** `GET /api/v1/tenants/{tenant_id}/queues`

**响应示例：**
```json
{
  "data": [
    {
      "id": 101,
      "queue_code": "C",
      "queue_name": "C队列",
      "overdue_days_start": null,
      "overdue_days_end": -1
    },
    {
      "id": 102,
      "queue_code": "S0",
      "queue_name": "S0队列",
      "overdue_days_start": 0,
      "overdue_days_end": 0
    }
  ]
}
```

### 6.2 获取催收机构

**接口：** `GET /api/v1/tenants/{tenant_id}/agencies`

### 6.3 获取催收小组

**接口：** `GET /api/v1/agencies/{agency_id}/teams`

### 6.4 获取催员

**接口：** `GET /api/v1/teams/{team_id}/collectors`

### 6.5 获取案件列表（带筛选）

**接口：** `GET /api/v1/cases`

**查询参数：**
- `tenant_id`：甲方ID（必填）
- `case_status`：案件状态（可选）
- `queue_id`：队列ID（可选）
- `agency_id`：机构ID（可选）
- `team_id`：小组ID（可选）
- `collector_id`：催员ID（可选）
- `due_date_start`：到期日开始（可选）
- `due_date_end`：到期日结束（可选）
- `settlement_date_start`：结清日期开始（可选）
- `settlement_date_end`：结清日期结束（可选）

---

## 七、使用说明

### 7.1 基本筛选流程

1. 在右上角选择甲方（全局选择器）
2. 案件列表自动加载该甲方的案件
3. 根据需要设置筛选条件：
   - 案件状态
   - 案件队列
   - 催收机构 → 催收小组 → 催员
   - 到期日范围
   - 结清日期范围
4. 点击"查询"按钮应用筛选
5. 点击"重置"按钮清空所有筛选条件

### 7.2 搜索功能

在筛选器下方的搜索框中，可以输入：
- 用户编号
- 贷款编号
- 手机号

进行精确搜索。

### 7.3 排序功能

点击表格列头可以进行排序：
- 逾期天数
- 未还金额
- 应还金额
- 案件状态

---

## 八、测试要点

### 8.1 功能测试

- [ ] 全局甲方选择器与案件列表联动
- [ ] 案件状态筛选正确
- [ ] 案件队列筛选正确
- [ ] 机构 → 小组 → 催员 级联筛选
- [ ] 到期日范围筛选
- [ ] 结清日期范围筛选
- [ ] 组合筛选（多个条件同时使用）
- [ ] 重置按钮清空所有筛选条件
- [ ] 搜索功能正常

### 8.2 交互测试

- [ ] 未选择机构时，小组下拉框禁用
- [ ] 未选择小组时，催员下拉框禁用
- [ ] 选择机构后，自动清空小组和催员
- [ ] 选择小组后，自动清空催员
- [ ] 切换甲方后，所有筛选器重置
- [ ] 日期选择器正常工作

### 8.3 UI测试

- [ ] 筛选器布局合理，间距均匀
- [ ] 输入框宽度一致
- [ ] 按钮对齐正确
- [ ] 响应式布局适配不同屏幕

---

## 九、后续优化建议

### 9.1 功能增强

- [ ] 添加筛选条件的保存和恢复功能
- [ ] 添加常用筛选条件的快捷选择
- [ ] 支持更多日期范围（如"今天"、"本周"、"本月"等）
- [ ] 添加筛选条件的提示信息（如：已选择3个筛选条件）

### 9.2 性能优化

- [ ] 实现筛选条件的防抖处理
- [ ] 优化大数据量下的筛选性能
- [ ] 添加加载状态提示

### 9.3 用户体验

- [ ] 记住用户上次使用的筛选条件
- [ ] 添加筛选结果统计（如：共筛选出X条案件）
- [ ] 优化移动端显示

---

## 十、总结

本次优化的核心成果：

✅ **全局联动**：集成全局甲方选择器，实现跨页面状态同步  
✅ **筛选增强**：新增6个筛选维度，覆盖主要业务场景  
✅ **级联交互**：机构→小组→催员的智能级联选择  
✅ **UI优化**：清晰的布局，统一的样式，良好的用户体验  

案件列表筛选器现在具备了强大的筛选能力，能够满足不同角色的业务需求！

