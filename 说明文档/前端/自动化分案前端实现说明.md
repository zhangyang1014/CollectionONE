# 自动化分案前端实现说明

## 📋 概述

基于《自动化分案需求.md》v0.2，已完成自动化分案功能的前端页面交互实现。后端逻辑暂未实现，使用 Mock 数据进行展示。

**实现日期**：2025-11-12  
**版本**：v1.0（前端 MVP）

---

## 🎯 已实现功能

### 1. 菜单入口

- **位置**：案件管理 → 自动化分案
- **路由**：`/auto-assignment`
- **权限**：需要登录认证

### 2. 队列总览（Queue Dashboard）

**文件位置**：`frontend/src/views/case-management/auto-assignment/QueueDashboard.vue`

**功能特性**：
- ✅ 队列选择器（C、S0、S1、L1、M1）
- ✅ 日期选择器（查看历史数据）
- ✅ 核心指标卡片展示：
  - 自动分案时间（Cron 表达式 + 下次执行时间）
  - 今日计划入催案件数
  - 已分配案件数（含分配率）
  - 平均持案数（含参与催员数）
- ✅ 剩余待分配案件提示
- ✅ 指标口径说明（可折叠）
- ✅ 近 7 日分配趋势图（预留图表容器）
- ✅ 数据刷新功能
- ✅ 数据导出功能（预留）

**Mock 数据示例**：
```javascript
{
  schedule_time: '每日 09:00',
  next_run: '2025-11-13 09:00:00',
  planned_cases: 1250,
  assigned_cases: 1180,
  assignment_rate: 94.4,
  remaining_cases: 70,
  active_collectors: 25,
  avg_cases_per_collector: 47.2,
}
```

### 3. 策略列表（Strategy List）

**文件位置**：`frontend/src/views/case-management/auto-assignment/StrategyList.vue`

**功能特性**：
- ✅ 队列筛选
- ✅ 策略列表展示：
  - 执行顺序（带拖拽图标）
  - 策略名称（可点击查看详情）
  - 状态标签（开启/关闭）
  - 分配目标层级
  - 目标机构/小组
  - 启动时间
  - 最近执行状态
  - 创建时间
- ✅ 操作按钮：
  - 编辑策略
  - 复制策略
  - 开启/关闭
  - 模拟执行
  - 删除（二次确认）
- ✅ 新建策略按钮
- ✅ 提示信息（策略执行顺序说明）

**Mock 数据示例**：
```javascript
{
  id: 1,
  sort_order: 1,
  strategy_name: 'C队列-机构A优先分配',
  is_enabled: true,
  target_level: '催员',
  target_names: '机构A - 电催组1, 电催组2',
  start_time: '2025-11-10 09:00:00',
  created_at: '2025-11-10 08:30:00',
  last_execution: {
    status: 'success',
    time: '2025-11-12 09:05:00'
  }
}
```

### 4. 策略详情（Strategy Detail）

**文件位置**：`frontend/src/views/case-management/auto-assignment/StrategyDetail.vue`

**功能特性**：
- ✅ 基础信息展示（描述表格）
- ✅ 分配条件展示：
  - 多条件组展示（OR 关系）
  - 条件表格（字段、运算符、值）
- ✅ 分配策略展示：
  - 分配层级、分配方式
  - 目标机构/小组
  - 优先分配（粘连）配置
  - 容量限制模式
  - 案件排序规则
- ✅ 执行历史（最近 10 次）：
  - 批次号
  - 状态标签
  - 案件数统计
  - 执行时间
  - 耗时
  - 查看详情按钮
- ✅ 操作日志（最近 20 条）：
  - 时间轴展示
  - 操作类型标签
  - 操作人信息
  - 备注说明

### 5. 策略向导（Strategy Wizard）

**文件位置**：`frontend/src/views/case-management/auto-assignment/StrategyWizard.vue`

**功能特性**：

#### 第一步：基础信息
- ✅ 所属队列（只读，显示队列名称和编码）
- ✅ 时区显示（UTC+8）
- ✅ 策略名称输入（1-50字，带字数统计）
- ✅ 启动时间选择器（禁用早于当前的日期）
- ✅ 策略描述（可选，200字）
- ✅ 表单验证

#### 第二步：分配条件
- ✅ 条件组管理：
  - 添加条件
  - 添加条件组
  - 复制条件组
  - 删除条件/条件组
- ✅ 条件配置：
  - 字段选择（分组展示：系统字段、标准字段）
  - 运算符选择（11种运算符）
  - 值输入
- ✅ OR/AND 关系提示
- ✅ 实时预览（符合条件的案件数量）
- ✅ 刷新预览按钮

#### 第三步：机构与策略
- ✅ 目标选择：
  - 分配层级（机构/小组/催员）
  - 目标机构多选（显示催员数）
  - 目标小组多选（联动过滤）
- ✅ 分配策略：
  - 分配方式（按数量/按金额）
  - 优先分配开关
  - 粘连粒度选择（同客户/同客户+产品/同客户+商户）
  - 历史窗口选择（7/30/90天）
  - 容量限制模式（硬/软/无限制）
  - 案件排序规则
- ✅ 容量预警提示
- ✅ 表单验证

#### 向导交互
- ✅ 步骤指示器
- ✅ 上一步/下一步按钮
- ✅ 取消按钮
- ✅ 提交按钮（带 loading 状态）
- ✅ 分步验证
- ✅ 数据保留（上一步不丢失数据）

---

## 📁 文件结构

```
frontend/src/views/case-management/
├── AutoAssignment.vue                    # 主入口（Tab 切换）
└── auto-assignment/
    ├── QueueDashboard.vue               # 队列总览
    ├── StrategyList.vue                 # 策略列表
    ├── StrategyDetail.vue               # 策略详情
    └── StrategyWizard.vue               # 策略向导（三步）
```

---

## 🎨 UI 设计亮点

### 1. 指标卡片
- 使用不同颜色图标区分指标类型
- Hover 动画效果（上浮）
- 清晰的主值 + 副值展示

### 2. 策略列表
- 状态标签颜色区分
- 执行状态彩色标签
- 行点击查看详情
- 操作按钮分组

### 3. 条件构建器
- 视觉化 OR/AND 关系
- 条件组卡片样式
- 拖拽图标提示
- 实时预览反馈

### 4. 向导界面
- 清晰的步骤指示
- 分步验证反馈
- 容量预警提示
- 禁用状态说明（阶段三功能）

---

## 🔧 技术实现

### 技术栈
- **框架**：Vue 3 + TypeScript
- **UI 组件**：Element Plus
- **状态管理**：Pinia（useTenantStore）
- **路由**：Vue Router

### 核心特性
1. **响应式设计**：使用 `ref`、`reactive`、`computed` 管理状态
2. **表单验证**：Element Plus Form 验证规则
3. **组件通信**：Props + Emits
4. **Mock 数据**：前端模拟数据，便于调试
5. **用户体验**：
   - 二次确认（删除、状态切换）
   - Loading 状态
   - 成功/失败提示
   - 空状态展示

### Mock 数据位置
所有 Mock 数据都在各组件内部定义，便于后续替换为 API 调用：
- 队列列表：`queues`
- 机构列表：`mockAgencies`
- 小组列表：`mockTeams`
- 策略列表：`strategies`
- 执行历史：`mockExecutionHistory`
- 操作日志：`mockOperationLogs`

---

## 🚀 后续开发建议

### 1. API 集成（优先级：高）

创建 API 文件：`frontend/src/api/auto-assignment.ts`

```typescript
// 队列总览
export function getQueueDashboard(queueId: number, date: string) {
  return request({
    url: `/api/v1/queues/${queueId}/assignment-dashboard`,
    method: 'get',
    params: { date }
  })
}

// 策略列表
export function getStrategies(queueId: number) {
  return request({
    url: `/api/v1/queues/${queueId}/strategies`,
    method: 'get'
  })
}

// 创建策略
export function createStrategy(data: any) {
  return request({
    url: `/api/v1/strategies`,
    method: 'post',
    data
  })
}

// 更新策略
export function updateStrategy(id: number, data: any) {
  return request({
    url: `/api/v1/strategies/${id}`,
    method: 'put',
    data
  })
}

// 切换策略状态
export function toggleStrategyStatus(id: number, enabled: boolean) {
  return request({
    url: `/api/v1/strategies/${id}/status`,
    method: 'patch',
    data: { is_enabled: enabled }
  })
}

// 删除策略
export function deleteStrategy(id: number) {
  return request({
    url: `/api/v1/strategies/${id}`,
    method: 'delete'
  })
}

// 模拟执行
export function simulateStrategy(id: number) {
  return request({
    url: `/api/v1/strategies/${id}/simulation`,
    method: 'post'
  })
}

// 预览案件数
export function previewCases(conditions: any) {
  return request({
    url: `/api/v1/strategies/preview`,
    method: 'post',
    data: { conditions }
  })
}
```

### 2. 功能增强（优先级：中）

#### 2.1 拖拽排序
使用 `Sortable.js` 或 `VueDraggable` 实现策略顺序调整：

```bash
npm install sortablejs
npm install --save-dev @types/sortablejs
```

#### 2.2 图表集成
使用 ECharts 绘制趋势图：

```bash
npm install echarts
```

在 `QueueDashboard.vue` 中实现：
```typescript
import * as echarts from 'echarts'

const initChart = () => {
  const chart = echarts.init(chartRef.value)
  chart.setOption({
    // ... 配置项
  })
}
```

#### 2.3 导出功能
使用 `xlsx` 库实现数据导出：

```bash
npm install xlsx
```

### 3. 性能优化（优先级：低）

- 大列表虚拟滚动（`el-table` 配合 `el-virtual-scroll`）
- 条件构建器防抖（实时预览）
- 路由懒加载（已实现）

### 4. 国际化（优先级：低）

在 `frontend/src/i18n/` 中添加翻译：

```typescript
// zh-CN.ts
export default {
  autoAssignment: {
    queueDashboard: '队列总览',
    strategyList: '策略管理',
    createStrategy: '新建策略',
    // ...
  }
}
```

---

## ✅ 测试检查清单

### 功能测试
- [ ] 队列切换正常
- [ ] 策略列表加载正常
- [ ] 新建策略向导流程完整
- [ ] 编辑策略回显数据正确
- [ ] 复制策略功能正常
- [ ] 删除策略二次确认
- [ ] 状态切换提示正确
- [ ] 详情抽屉展示完整

### 表单验证
- [ ] 策略名称必填
- [ ] 启动时间必填且不早于当前
- [ ] 分配条件至少一个有效
- [ ] 目标机构必选
- [ ] 所有必填项红色提示

### 交互体验
- [ ] 按钮 loading 状态
- [ ] 成功/失败消息提示
- [ ] 空状态展示
- [ ] 禁用状态说明
- [ ] 响应式布局适配

---

## 📝 注意事项

1. **Mock 数据替换**：所有 `// TODO: 调用实际 API` 注释处需要替换为真实 API 调用
2. **权限控制**：后续需要根据用户角色控制操作按钮显示
3. **数据校验**：前端校验 + 后端校验双重保障
4. **错误处理**：API 调用失败时的友好提示
5. **日志记录**：关键操作需要记录审计日志
6. **性能监控**：大数据量场景需要分页或虚拟滚动

---

## 🔗 相关文档

- [自动化分案需求.md](./自动化分案需求.md) - 完整需求文档
- [Element Plus 文档](https://element-plus.org/) - UI 组件库
- [Vue 3 文档](https://cn.vuejs.org/) - 框架文档

---

## 📞 联系方式

如有问题或建议，请联系开发团队。

**最后更新**：2025-11-12

