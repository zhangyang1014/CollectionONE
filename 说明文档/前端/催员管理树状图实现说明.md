# 催员管理树状图实现说明

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 1.0.0 | 2025-12-10 | 初始版本，实现催员管理树状图功能 | 大象 |

## 功能概述

在催员管理页面实现了树状图展示功能，将组织架构以树形结构呈现，支持从小组节点直接创建催员，并实现树与表格的双向联动。

## 页面布局

采用左右分栏布局：

- **左侧（30%）**：树状图区域
  - 展示组织架构层级（机构 → 小组群 → 小组 → 催员）
  - 提供刷新按钮
  - 支持点击节点筛选

- **右侧（70%）**：表格区域
  - 保留原有的筛选器（搜索、状态、机构、小组）
  - 保留原有的催员列表表格
  - 保留所有原有操作功能

## 树状图功能

### 1. 组织架构层级展示

树状图展示四层结构：

```text
📍 机构
  ├── 📊 小组群
  │   ├── 👤 小组 [催员数]
  │   │   ├── 👤 催员1
  │   │   ├── 👤 催员2
  │   │   └── 👤 催员3
  │   └── 👤 小组
  │       └── 👤 催员
  └── 👤 小组（无小组群）
      └── 👤 催员
```

**图标说明**：
- 🏢 机构：`<OfficeBuilding />`
- 📊 小组群：`<Grid />`
- 👥 小组：`<User />`
- 👤 催员：`<Avatar />`

### 2. 小组节点创建催员

在小组节点上hover时，会显示"创建催员"按钮：

```vue
<el-button 
  size="small" 
  text 
  type="primary"
  @click.stop="handleCreateCollectorFromTree(data)"
>
  创建催员
</el-button>
```

**功能特点**：
- 点击后打开创建催员对话框
- 自动填充所属机构和小组
- 禁用机构和小组选择器（因为已由树节点指定）
- 创建成功后自动刷新树状图和表格

### 3. 树节点点击筛选

点击不同类型的节点，触发不同的筛选行为：

| 节点类型 | 筛选行为 | 说明 |
|----------|----------|------|
| 机构节点 | 筛选该机构的所有催员 | 更新右侧筛选器的机构选择 |
| 小组群节点 | 筛选该小组群下所有小组的催员 | 显示该机构所有催员（待优化） |
| 小组节点 | 筛选该小组的催员 | 更新右侧筛选器的机构和小组选择 |
| 催员节点 | 在表格中高亮该催员 | 使用搜索关键词筛选 |

### 4. 双向联动

**树 → 筛选器**：
- 点击树节点时，自动更新右侧筛选器的值
- 触发表格数据重新加载

**筛选器 → 树**：
- 改变机构或小组筛选器时，树自动高亮对应节点
- 自动展开父节点以显示选中节点

## 数据加载逻辑

### buildTreeData() 函数

构建树形数据的核心函数，分四层加载：

```typescript
const buildTreeData = async () => {
  // 1. 加载所有机构（已有数据）
  for (const agency of agencies.value) {
    // 2. 加载该机构的小组群
    const teamGroups = await fetch(`/api/v1/agencies/${agency.id}/team-groups`)
    
    for (const teamGroup of teamGroups) {
      // 3. 加载该小组群的小组
      const teams = await fetch(`/api/v1/agencies/${agency.id}/teams`)
        .filter(t => t.team_group_id === teamGroup.id)
      
      for (const team of teams) {
        // 4. 加载该小组的催员
        const collectors = await fetch(`/api/v1/teams/${team.id}/collectors`)
      }
    }
    
    // 处理没有小组群的小组
    const teamsWithoutGroup = teams.filter(t => !t.team_group_id)
  }
}
```

### API调用

使用的API端点：
- `GET /api/v1/agencies/{id}/team-groups` - 获取机构的小组群
- `GET /api/v1/agencies/{id}/teams` - 获取机构的小组
- `GET /api/v1/teams/{id}/collectors` - 获取小组的催员

## 类型定义

在 `types/organization.ts` 中新增：

```typescript
export interface OrgTreeNode {
  id: string | number
  label: string
  type: 'agency' | 'team_group' | 'team' | 'collector'
  data: CollectionAgency | TeamGroup | CollectionTeam | Collector
  children?: OrgTreeNode[]
  disabled?: boolean
}
```

## 样式设计

### 布局样式

```css
.org-container {
  height: calc(100vh - 280px);
  min-height: 600px;
}

.tree-aside {
  border-right: 1px solid #e4e7ed;
  background-color: #fafafa;
}
```

### 树节点样式

- 节点高度：40px
- hover效果：背景色 `#f0f2f5`
- 选中状态：背景色 `#e6f7ff`，字体加粗
- 操作按钮：hover时显示

## 使用场景

### 场景1：快速定位某个机构的催员

1. 在左侧树状图中点击机构节点
2. 右侧表格自动筛选该机构的所有催员
3. 筛选器自动更新为该机构

### 场景2：为某个小组创建催员

1. 在左侧树状图中找到目标小组
2. hover到小组节点，点击"创建催员"按钮
3. 对话框打开，机构和小组已自动填充
4. 填写催员信息并保存
5. 树状图和表格自动刷新

### 场景3：查看某个催员的详细信息

1. 在树状图中点击催员节点
2. 右侧表格自动筛选到该催员
3. 可以在表格中进行编辑、修改密码等操作

## 技术要点

### 1. 树节点唯一标识

使用前缀+ID的方式生成唯一标识：
- 机构：`agency-{id}`
- 小组群：`team-group-{id}`
- 小组：`team-{id}`
- 催员：`collector-{id}`

### 2. 树与表格的同步

```typescript
// 树节点点击 → 更新筛选器
const handleTreeNodeClick = (data: OrgTreeNode) => {
  if (data.type === 'team') {
    currentAgencyId.value = team.agency_id
    currentTeamId.value = team.id
    loadCollectors()
  }
}

// 筛选器改变 → 高亮树节点
const syncTreeSelection = () => {
  const nodeKey = `team-${currentTeamId.value}`
  treeRef.value.setCurrentKey(nodeKey)
}
```

### 3. 从树创建催员的标记

使用 `fromTree` 标记来区分创建来源：

```typescript
const fromTree = ref(false)

// 从树创建时
fromTree.value = true
form.value.agency_id = team.agency_id  // 自动填充
form.value.team_id = team.id           // 自动填充

// 禁用选择器
<el-select :disabled="fromTree">
```

## 待优化项

1. **小组群筛选**：点击小组群节点时，应该只显示该小组群下的小组催员，而不是整个机构的
2. **懒加载**：当数据量很大时，可以使用懒加载优化性能
3. **搜索功能**：可以在树状图中添加搜索框，支持按名称搜索节点
4. **右键菜单**：可以在树节点上添加右键菜单，提供更多操作选项
5. **拖拽排序**：支持拖拽树节点进行排序
6. **批量操作**：支持选中多个节点进行批量操作

## 相关文件

- **主文件**：`frontend/src/views/organization/CollectorManagement.vue`
- **类型定义**：`frontend/src/types/organization.ts`
- **参考示例**：`frontend/src/views/field-config/FieldGroups.vue`

## 调试指南

如果树状图只显示机构层级，没有显示小组群和小组，请按以下步骤调试：

### 1. 打开浏览器控制台

按 `F12` 打开开发者工具，切换到 Console 标签页。

### 2. 查看调试日志

刷新催员管理页面，控制台会显示详细的加载日志：

```text
开始构建树状图，机构数量：2
加载小组群：http://localhost:8080/api/v1/team-groups?tenant_id=1&agency_id=1
机构 测试机构1 的小组群数量：2
加载小组：http://localhost:8080/api/v1/agencies/1/teams
小组群 测试小组群1 的小组数量：3
小组 催收一组 的催员数量：5
...
树状图构建完成，根节点数量：2
```

### 3. 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 小组群数量为0 | 后端没有返回小组群数据 | 检查小组群管理页面是否有数据 |
| 小组数量为0 | 小组没有关联小组群 | 检查小组的 `team_group_id` 字段 |
| 催员数量为0 | 小组没有催员 | 检查该小组是否有催员账号 |
| API调用404 | 后端接口不存在 | 检查Java后端是否启动 |

### 4. 检查数据完整性

在小组管理页面，确认：
- ✅ 每个机构至少有1个小组群
- ✅ 每个小组群至少有1个小组
- ✅ 每个小组至少有1个催员

### 5. 查看树状图数据结构

在控制台执行：
```javascript
console.log('树状图数据：', treeData)
```

应该看到类似的数据结构：
```javascript
[
  {
    id: "agency-1",
    label: "测试机构1",
    type: "agency",
    children: [
      {
        id: "team-group-1",
        label: "测试小组群1",
        type: "team_group",
        children: [
          {
            id: "team-1",
            label: "催收一组",
            type: "team",
            children: [...]
          }
        ]
      }
    ]
  }
]
```

## 测试建议

### 功能测试

1. **树状图加载**
   - ✅ 页面打开后树状图正确加载
   - ✅ 展示所有层级（机构、小组群、小组、催员）
   - ✅ 图标显示正确

2. **树节点点击**
   - ✅ 点击机构节点，表格显示该机构催员
   - ✅ 点击小组节点，表格显示该小组催员
   - ✅ 点击催员节点，表格高亮该催员

3. **创建催员**
   - ✅ hover小组节点显示"创建催员"按钮
   - ✅ 点击按钮打开对话框
   - ✅ 机构和小组已自动填充且禁用
   - ✅ 创建成功后树和表格自动刷新

4. **双向联动**
   - ✅ 改变筛选器，树节点自动高亮
   - ✅ 点击树节点，筛选器自动更新

### 兼容性测试

- ✅ 保留原有所有功能（搜索、筛选、编辑、删除等）
- ✅ 不影响原有的工作流程
- ✅ 不同角色（超管、机构管理员、小组管理员）权限正常

## 总结

本次实现为催员管理增加了直观的树状图展示功能，大大提升了用户体验：

1. **可视化**：以树形结构清晰展示组织架构层级
2. **便捷性**：支持从小组节点直接创建催员
3. **联动性**：树与表格双向联动，操作更流畅
4. **兼容性**：完全保留原有功能，不影响现有工作流程

---

**最后更新**：2025-12-10  
**版本**：1.0.0
