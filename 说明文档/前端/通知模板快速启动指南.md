# 通知模板功能 - 快速启动指南

## 🚀 快速开始

### 1. 创建数据库表

```bash
cd backend
python3 create_notification_template_table.py
```

**输出示例**：
```
============================================================
创建通知模板表
============================================================
开始创建 notification_templates 表...
✅ notification_templates 表创建成功！

插入示例模板...
✅ 示例模板插入成功！

已创建以下示例模板：
  1. 案件标签变化模板 (case_tag_change)
  2. 案件还款模板 (case_payment)
  3. 用户访问APP模板 (user_app_visit)
  4. 用户访问还款页模板 (user_payment_page_visit)
============================================================
```

### 2. 访问功能

1. 启动后端服务（如果未启动）：
   ```bash
   cd backend
   python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
   ```

2. 启动前端服务（如果未启动）：
   ```bash
   cd frontend
   npm run dev
   ```

3. 访问系统：
   - 打开浏览器访问：`http://localhost:5173/admin/login`
   - 登录账号：`superadmin` / `123456`
   - 进入：系统管理 -> 通知配置 -> **通知模板**

## 📋 示例模板说明

系统已自动创建4个示例模板，可以直接使用或修改：

### 1. 案件标签变化模板
- **模板ID**: `case_tag_change`
- **用途**: 案件标签变化时通知
- **内容**: 案件 {case_number} 的标签已从 {old_tag} 更改为 {new_tag}，操作人：{operator}

### 2. 案件还款模板
- **模板ID**: `case_payment`
- **用途**: 收到还款时通知
- **内容**: 案件 {case_number} 收到还款 ￥{amount}，还款时间：{payment_time}
- **优先级**: 高

### 3. 用户访问APP模板
- **模板ID**: `user_app_visit`
- **用途**: 用户访问APP时通知
- **内容**: 用户 {user_name} ({user_phone}) 访问了APP，案件：{case_number}

### 4. 用户访问还款页模板
- **模板ID**: `user_payment_page_visit`
- **用途**: 用户访问还款页时通知
- **内容**: 用户 {user_name} 访问了还款页面，待还金额：￥{outstanding_amount}
- **优先级**: 高

## ✨ 创建自定义模板

### 步骤1：点击"添加通知模板"

### 步骤2：填写基本信息
```
是否启用: ✓ 开启
模板ID: my_custom_template
模板名称: 我的自定义模板
模板类型: 选择一个类型（如"案件还款"）
```

### 步骤3：编写通知内容
```
通知正文模板:
案件 {case_number} 有新的更新，请及时处理。

跳转URL模板:
/cases/{case_id}
```

**提示**：点击下方的变量标签可以快速插入变量！

### 步骤4：配置发送对象
```
发送对象类型: ○ 机构 ○ 小组 ● 指定催员
目标催员: [选择催员]
```

### 步骤5：配置阅读机制
```
强制阅读: ☐ 关闭

↓ 非强制阅读配置 ↓

重复提醒间隔: 30 分钟
最大提醒次数: 3 次
通知时间范围: 09:00 至 18:00
```

### 步骤6：设置优先级
```
优先级: ○ 高 ● 中 ○ 低
展示时长: 5 秒
```

### 步骤7：保存
点击"保存"按钮完成创建。

## 🎯 常见使用场景

### 场景1：高优先级还款通知
```yaml
模板ID: urgent_payment
模板名称: 紧急还款通知
模板类型: case_payment
优先级: 高
强制阅读: 是
内容: 🎉 案件 {case_number} 收到大额还款 ￥{amount}！
```

### 场景2：工作时间提醒
```yaml
模板ID: work_hour_reminder
模板名称: 工作时间提醒
强制阅读: 否
重复提醒间隔: 60 分钟
最大提醒次数: 5 次
通知时间范围: 09:00 - 18:00
```

### 场景3：特定催员通知
```yaml
发送对象类型: 指定催员
目标催员: [催员A, 催员B, 催员C]
```

## 🔧 管理模板

### 编辑模板
1. 在列表中找到要编辑的模板
2. 点击"编辑"按钮
3. 修改配置
4. 点击"保存"

**注意**：模板ID创建后不可修改！

### 启用/禁用模板
直接在列表中切换"启用状态"开关即可。

### 删除模板
1. 点击"删除"按钮
2. 确认删除

**警告**：删除后无法恢复，请谨慎操作！

## 📊 查看统计

在模板列表的"统计"列可以看到：
- **发送**: 累计发送次数
- **阅读**: 累计阅读次数

## ⚠️ 注意事项

1. **模板ID唯一性**
   - 每个模板ID必须全局唯一
   - 创建后不可修改
   - 建议使用有意义的英文命名，如：`case_payment_high_priority`

2. **变量格式**
   - 使用 `{variable_name}` 格式
   - 变量名区分大小写
   - 确保变量名与模板类型匹配

3. **发送对象配置**
   - 不选择具体对象时，会发送给该类型的所有对象
   - 可以选择多个目标对象

4. **时间范围**
   - 仅在非强制阅读时可配置
   - 使用24小时制，格式：HH:MM
   - 不填则全天显示

## 🐛 常见问题

### Q1: 创建模板时提示"模板ID已存在"
**A**: 模板ID必须全局唯一，请更换一个新的ID。

### Q2: 变量没有被替换
**A**: 检查变量名是否正确，是否使用了 `{variable_name}` 格式。

### Q3: 通知没有发送给指定对象
**A**: 检查：
- 模板是否已启用
- 发送对象配置是否正确
- 目标对象是否存在

### Q4: 如何测试模板效果？
**A**: 当前版本需要等待甲方系统推送。后续版本会添加测试功能。

## 📚 更多信息

详细文档请查看：[通知模板功能说明](./通知模板功能说明.md)

---

**快速启动指南** | 版本 v1.0 | 更新时间：2025-11-19

