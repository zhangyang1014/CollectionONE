# 催员工作台实现说明

## ✅ 已完成功能

### 1. 顶部条 (Workspace Header)

#### 左侧
- ✅ Logo图标（科技绿）
- ✅ 系统名称 "CCO-IM"

#### 中间
- ✅ 通知中心（带未读徽章）

#### 右侧
- ✅ **时区显示**
  - 实时时钟（每秒更新）
  - 根据机构自动设置时区
    - BTQ（墨西哥）: America/Mexico_City (CST)
    - BTSK（印度）: Asia/Kolkata (IST)
  - 悬浮显示完整时区信息

- ✅ **语言切换**
  - 中文 🇨🇳
  - English 🇺🇸
  - Español 🇲🇽
  - Indonesia 🇮🇩
  - 下拉选择，即时切换

- ✅ **账号信息下拉菜单**
  - 催员ID显示
  - 悬浮显示完整信息
    - 催员姓名
    - 所属机构
    - 所属团队
    - WhatsApp连接状态
  - **双重登出功能**
    - ✅ 仅登出WhatsApp账号（不影响催收账号）
    - ✅ 登出催收账号（同时登出WhatsApp）

---

### 2. 案件列表区域 (左侧 1/3)

#### 核心数据看板
- ✅ **第一行数据**
  - 组内排名（案件）
  - 应催案件数
  - 未还款数
  - 案件回收率（%）

- ✅ **第二行数据**
  - 组内排名（金额）
  - 应催金额
  - 未还金额
  - 金额回收率（%）

- ✅ **看板功能**
  - 显示上次刷新时间
  - 手动刷新按钮
  - "更多数据"链接（跳转报表）

#### 搜索功能
- ✅ 搜索框
  - 提示文字："输入精准用户编号、贷款编号、手机号进行搜索"
  - 支持回车搜索
  - 支持失焦搜索
  - 精准匹配：用户编号、贷款编号、手机号

#### 过滤器 (Filter)
- ✅ **基础过滤**
  - 还款日期范围选择器
  - 用户回复（无/有）
  - 是否有PTP（无/今日/1-3日/3+）

- ✅ **自定义标签过滤**
  - 案件状态（多选）
  - 还款意向（多选）

- ✅ **更多筛选（可展开/收起）**
  - 产品（下拉单选）
  - App（下拉单选）
  - 首复借类型
  - 近期还款情况
  - 首期期限

- ✅ **视图功能**
  - 保存筛选器为视图
  - 重置筛选器

#### 案件列表
- ✅ **列表字段**
  - 贷款编号
  - 用户ID
  - 用户名
  - 逾期天数（带颜色：负数绿/当日橙/正数红）
  - 未还金额（支持排序）
  - 应还金额（支持排序）
  - 本人应答渠道数（支持排序）
  - 案件状态（支持排序）

- ✅ **更多字段（可展开/收起）**
  - 产品名字
  - App名字
  - 结清方式
  - 结清时间

- ✅ **交互功能**
  - 点击列头排序
  - 点击行选择案件
  - 选中行高亮显示
  - 全选/批量选择

- ✅ **批量操作**
  - 批量外呼
  - 批量发送IM消息
  - 显示选中数量

- ✅ **分页器**
  - 可选一页数量：30/50/100（默认50）
  - 显示总数
  - 上一页/下一页
  - 跳转页码

---

### 3. 案件详情区域 (右上 2/3宽 × 1/2高)

#### Tab标签页
- ✅ **客户信息 Tab**
  - 用户ID
  - 用户名
  - 手机号
  - 逾期天数（带颜色标签）

- ✅ **影像资料 Tab**
  - 预留位置（待实现）
  - 证件照片（正面/反面）
  - 活体照片
  - 标记证件信息功能

- ✅ **贷款信息 Tab**
  - 贷款编号
  - 产品名称
  - App名称
  - 贷款类型（单期/多期）

- ✅ **还款记录 Tab**
  - 预留位置（待实现）

#### 功能
- ✅ 选中案件自动显示详情
- ✅ 未选中时显示空状态提示
- ✅ 可滚动内容区域

---

### 4. 触达IM区域 (右下 2/3宽 × 1/2高)

- ✅ 预留区域
- ✅ 占位提示："触达IM功能开发中..."

---

## 🎨 设计特点

### 布局结构
```
┌──────────────────────────────────────────────────┐
│  顶部条 (60px高)                                  │
│  Logo | 通知 | 时区 | 语言 | 账号                 │
├───────────────┬──────────────────────────────────┤
│               │  案件详情 (上半部 50%高)          │
│  案件列表     │  - Tab页签                        │
│  (33.3%宽)    │  - 客户/影像/贷款/还款            │
│               ├──────────────────────────────────┤
│  - 看板        │  触达IM (下半部 50%高)            │
│  - 搜索        │  - 待实现                        │
│  - 过滤器      │                                  │
│  - 列表        │                                  │
│  - 分页        │                                  │
└───────────────┴──────────────────────────────────┘
```

### 颜色系统
- **主色**: #25D366 (WhatsApp绿)
- **成功**: #67C23A (绿色 - 负数逾期天数)
- **警告**: #E6A23C (橙色 - 当日逾期)
- **危险**: #F56C6C (红色 - 正数逾期天数、未还金额)
- **背景**: #f5f7fa, #ffffff

### 交互细节
- ✅ 悬停效果
- ✅ 点击反馈
- ✅ 加载状态
- ✅ 空状态提示
- ✅ 确认对话框
- ✅ Toast消息提示

---

## 📊 数据展示

### 看板数据（Mock）
```javascript
{
  teamRank: 2,          // 组内排名
  totalCases: 28,       // 应催案件
  unpaidCases: 15,      // 未还款数
  caseRecoveryRate: 46.4, // 案件回收率
  amountRank: 3,        // 组内排名（金额）
  totalAmount: 245000,  // 应催金额
  unpaidAmount: 131250, // 未还金额
  amountRecoveryRate: 46.4 // 金额回收率
}
```

### 案件数据来源
- ✅ 从后端API加载：`GET /api/v1/cases?tenant_id={tenantId}`
- ✅ 根据登录催员的机构ID自动筛选
- ✅ 实时数据更新

---

## 🔧 技术实现

### 核心技术
- **Vue 3 Composition API**
- **TypeScript**
- **Element Plus** (UI组件)
- **Day.js** (时间处理 + 时区)
- **Pinia** (状态管理)

### 关键功能实现

#### 1. 时区处理
```typescript
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'
import timezone from 'dayjs/plugin/timezone'

dayjs.extend(utc)
dayjs.extend(timezone)

// 根据机构设置时区
if (user.value?.tenantCode === 'BTQ') {
  timezone.value = 'America/Mexico_City'
} else if (user.value?.tenantCode === 'BTSK') {
  timezone.value = 'Asia/Kolkata'
}

// 显示当前时间
currentTime.value = dayjs().tz(timezone.value).format('HH:mm:ss')
```

#### 2. 搜索和过滤
```typescript
const filteredCases = computed(() => {
  let result = cases.value

  // 搜索过滤
  if (searchKeyword.value) {
    const keyword = searchKeyword.value.toLowerCase()
    result = result.filter((c: any) =>
      c.user_id?.toLowerCase().includes(keyword) ||
      c.loan_id?.toLowerCase().includes(keyword) ||
      c.mobile_number?.toLowerCase().includes(keyword)
    )
  }

  // 其他过滤器...
  return result
})
```

#### 3. 分页
```typescript
const paginatedCases = computed(() => {
  const start = (pagination.value.page - 1) * pagination.value.pageSize
  const end = start + pagination.value.pageSize
  return filteredCases.value.slice(start, end)
})
```

#### 4. 双重登出
```typescript
// 仅登出WhatsApp
if (command === 'logout-whatsapp') {
  // 只清除WhatsApp连接状态
}

// 登出催收账号（同时登出WhatsApp）
else if (command === 'logout-all') {
  await imUserStore.logout()  // 清除所有状态
  router.push('/im/login')
}
```

---

## 🚀 如何测试

### 1. 启动服务
```bash
# 后端
cd backend
python3 mock_server_full.py

# 前端
cd frontend
npm run dev
```

### 2. 登录系统
访问: http://localhost:5173/im/login

测试账号:
```
机构ID: 1
催员ID: BTQ001
密码: 123456
```

### 3. 测试功能
- ✅ 查看顶部实时时钟
- ✅ 切换语言
- ✅ 查看看板数据
- ✅ 搜索案件（输入用户ID/贷款ID/手机号）
- ✅ 应用过滤器
- ✅ 点击案件查看详情
- ✅ 批量选择案件
- ✅ 测试双重登出

---

## 📝 待实现功能

### 高优先级
1. ⏳ 影像资料展示
   - 证件照片上传/查看
   - 活体照片对比
   - 标记证件异常信息

2. ⏳ 触达IM功能
   - WhatsApp集成
   - 消息发送
   - 历史聊天记录
   - 快捷回复

3. ⏳ 还款记录详情
   - 历史还款列表
   - 还款时间线
   - 还款码查看

### 中优先级
4. ⏳ 批量操作完善
   - 批量外呼队列
   - 批量发送消息
   - 操作进度显示

5. ⏳ 视图保存功能
   - 保存筛选条件
   - 快速切换视图
   - 默认视图设置

6. ⏳ 更多报表数据
   - 跳转到报表页面
   - 催员业绩详情
   - 数据导出

### 低优先级
7. ⏳ 历史借款记录
8. ⏳ 合同放款凭证
9. ⏳ 借款分期信息详情

---

## 📂 文件结构

```
frontend/src/
├── views/im/
│   ├── Login.vue                    # 登录页面
│   ├── Workspace.vue                # 简单工作台（已弃用）
│   └── CollectorWorkspace.vue       # 催员工作台（新）★
├── layouts/
│   └── ImLayout.vue                 # IM端布局（简化为空布局）
├── stores/
│   └── imUser.ts                    # IM用户状态管理
├── api/
│   ├── im.ts                        # IM端API
│   └── case.ts                      # 案件API
└── router/
    └── index.ts                     # 路由配置（已更新）
```

---

## 🎯 性能优化

### 已实现
- ✅ 计算属性缓存（filteredCases, paginatedCases）
- ✅ 虚拟滚动（el-scrollbar）
- ✅ 按需加载（路由懒加载）
- ✅ 防抖搜索（失焦/回车触发）

### 待优化
- ⏳ 长列表虚拟滚动
- ⏳ 图片懒加载
- ⏳ API请求缓存
- ⏳ WebSocket实时通信

---

## 🐛 已知问题

1. ✅ 过滤器功能部分未完全实现（标记为TODO）
2. ✅ 批量操作目前仅显示提示消息
3. ✅ 影像资料、还款记录等Tab内容为占位
4. ✅ 触达IM部分为占位

---

## 📊 数据流

```
用户登录
  ↓
获取用户信息（tenantId, collectorId, permissions）
  ↓
加载案件列表（根据tenantId）
  ↓
应用搜索/过滤/排序/分页
  ↓
显示案件列表
  ↓
选择案件 → 显示详情
  ↓
进行操作（外呼/发消息/标记等）
```

---

*实现完成时间: 2025-11-05*  
*文件: `frontend/src/views/im/CollectorWorkspace.vue`*  
*行数: ~600行*

