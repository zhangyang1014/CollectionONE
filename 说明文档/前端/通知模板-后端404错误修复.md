# 通知模板 - 后端404错误修复指南

## 问题描述

访问通知模板页面时，前端显示以下错误：
```
GET http://localhost:8000/api/v1/notification-templates 404 (Not Found)
```

## 原因分析

1. **数据库表未创建**：`notification_templates` 表还不存在
2. **后端服务未重启**：新的API路由还没有加载

## 🚀 快速修复步骤

### 步骤1：创建数据库表

#### 方法A：使用SQL文件（推荐）

```bash
# 1. 进入backend目录
cd backend

# 2. 使用MySQL客户端执行SQL文件
mysql -u root -p cco_system < notification_templates.sql

# 或者使用其他MySQL客户端工具（如Navicat、MySQL Workbench）
# 打开 notification_templates.sql 文件并执行
```

#### 方法B：使用Python脚本

如果你的Python环境配置正确：

```bash
cd backend
python3 create_notification_template_table.py
```

**注意**：如果遇到模块导入错误，请使用方法A。

### 步骤2：重启后端服务

**重要**：必须重启后端服务才能加载新的API路由！

```bash
# 1. 停止当前运行的后端服务（Ctrl+C）

# 2. 重新启动后端服务
cd backend
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 步骤3：验证修复

1. **检查数据库表**：
   ```sql
   USE cco_system;
   SHOW TABLES LIKE 'notification_templates';
   SELECT COUNT(*) FROM notification_templates;
   ```
   应该看到4条示例数据。

2. **测试API**：
   ```bash
   curl http://localhost:8000/api/v1/notification-templates
   ```
   应该返回JSON数据，而不是404。

3. **访问前端**：
   - 打开：`http://localhost:5173/admin/login`
   - 登录后进入：系统管理 -> 通知配置 -> 通知模板
   - 应该可以看到4个示例模板

## 📋 示例数据说明

执行SQL后会自动创建4个示例模板：

1. **案件标签变化模板** (case_tag_change)
   - 优先级：中
   - 发送对象：机构

2. **案件还款模板** (case_payment)
   - 优先级：高
   - 发送对象：机构

3. **用户访问APP模板** (user_app_visit)
   - 优先级：中
   - 发送对象：催员

4. **用户访问还款页模板** (user_payment_page_visit)
   - 优先级：高
   - 发送对象：催员

## 🔍 故障排查

### 问题1：SQL执行失败

**错误信息**：`Table 'notification_templates' already exists`

**解决方案**：表已存在，直接进行步骤2重启后端服务。

---

**错误信息**：`Unknown database 'cco_system'`

**解决方案**：
```sql
CREATE DATABASE IF NOT EXISTS cco_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE cco_system;
-- 然后执行 notification_templates.sql
```

### 问题2：后端服务启动失败

**错误信息**：`ModuleNotFoundError: No module named 'xxx'`

**解决方案**：安装依赖
```bash
cd backend
pip install -r requirements.txt
```

### 问题3：仍然返回404

**检查清单**：
- ✅ 数据库表已创建
- ✅ 后端服务已重启（不是重新加载，是完全停止后重新启动）
- ✅ 后端服务运行在8000端口
- ✅ 前端配置的API地址正确

**验证后端路由**：
```bash
# 查看后端日志，应该看到类似这样的输出：
INFO:     Application startup complete.
# 访问API文档
open http://localhost:8000/docs
# 在文档中搜索 "notification-templates"
```

### 问题4：前端仍然报错

1. **清理浏览器缓存**：`Cmd/Ctrl + Shift + R`
2. **清理Vite缓存**：
   ```bash
   cd frontend
   rm -rf node_modules/.vite
   ```
3. **重启前端服务**

## 📝 验证清单

完成以下检查确保一切正常：

- [ ] 数据库表 `notification_templates` 已创建
- [ ] 表中有4条示例数据
- [ ] 后端服务已完全重启（不是热重载）
- [ ] 访问 `http://localhost:8000/api/v1/notification-templates` 返回JSON
- [ ] 前端页面可以正常加载通知模板列表
- [ ] 可以看到4个示例模板
- [ ] 没有404或其他错误

## 🎯 下一步

修复完成后，你可以：

1. 查看和编辑示例模板
2. 创建自定义模板
3. 配置发送对象和阅读机制
4. 测试模板功能

## 相关文档

- [通知模板功能说明](./通知模板功能说明.md)
- [通知模板快速启动指南](./通知模板快速启动指南.md)

---

**修复指南** | 版本 v1.0 | 更新时间：2025-11-19

