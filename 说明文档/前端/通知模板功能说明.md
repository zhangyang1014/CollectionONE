# 通知模板功能说明

## 功能概述

通知模板功能用于接收甲方核心系统推送的通知信息。甲方系统可以根据配置好的模板，向CCO系统推送各种业务通知（如案件标签变化、案件还款、用户访问等），系统会根据模板配置自动发送给指定的催员、小组或机构。

## 需求背景

甲方的核心系统需要向CCO系统推送各种业务通知，这些通知需要灵活配置：
- 支持变量参数的模板化内容
- 可配置发送对象（机构、小组、指定催员）
- 支持强制阅读和非强制阅读机制
- 支持点击跳转到指定页面
- 支持优先级和展示时长配置

## 主要功能

### 1. 模板管理

#### 1.1 模板基本信息
- **模板ID**：唯一标识，用于甲方系统调用（创建后不可修改）
- **模板名称**：便于管理的显示名称
- **模板类型**：预定义的通知类型
- **模板描述**：说明模板用途

#### 1.2 通知内容配置
- **通知正文模板**：支持变量参数，如 `{case_id}`、`{amount}` 等
- **跳转URL模板**：点击通知后跳转的页面，也支持变量

#### 1.3 发送对象配置
- **机构级别**：发送给指定机构或所有机构
- **小组级别**：发送给指定小组或所有小组
- **催员级别**：发送给指定催员

#### 1.4 阅读机制配置
- **强制阅读**：用户必须点击"已阅读"才能关闭
- **非强制阅读**：可配置
  - 重复提醒间隔（分钟）
  - 最大提醒次数
  - 通知时间范围（如仅工作时间显示）

#### 1.5 优先级和展示
- **优先级**：高/中/低
- **展示时长**：通知在屏幕上显示的秒数

### 2. 预置模板类型

系统预置了以下常用模板类型：

#### 2.1 案件标签变化 (case_tag_change)
**描述**：当案件标签发生变化时发送通知

**可用变量**：
- `{case_id}`: 案件ID
- `{case_number}`: 案件编号
- `{tag_name}`: 标签名称
- `{old_tag}`: 旧标签
- `{new_tag}`: 新标签
- `{operator}`: 操作人

**示例内容**：
```
案件 {case_number} 的标签已从 {old_tag} 更改为 {new_tag}，操作人：{operator}
```

#### 2.2 案件还款 (case_payment)
**描述**：当案件收到还款时发送通知

**可用变量**：
- `{case_id}`: 案件ID
- `{case_number}`: 案件编号
- `{amount}`: 还款金额
- `{payment_time}`: 还款时间
- `{payment_channel}`: 还款渠道
- `{debtor_name}`: 债务人姓名

**示例内容**：
```
案件 {case_number} 收到还款 ￥{amount}，还款时间：{payment_time}
```

#### 2.3 用户访问APP (user_app_visit)
**描述**：当用户访问APP时发送通知

**可用变量**：
- `{case_id}`: 案件ID
- `{case_number}`: 案件编号
- `{user_name}`: 用户姓名
- `{user_phone}`: 用户手机号
- `{visit_time}`: 访问时间
- `{device_type}`: 设备类型

**示例内容**：
```
用户 {user_name} ({user_phone}) 访问了APP，案件：{case_number}
```

#### 2.4 用户访问还款页 (user_payment_page_visit)
**描述**：当用户访问还款页面时发送通知

**可用变量**：
- `{case_id}`: 案件ID
- `{case_number}`: 案件编号
- `{user_name}`: 用户姓名
- `{user_phone}`: 用户手机号
- `{visit_time}`: 访问时间
- `{outstanding_amount}`: 待还金额

**示例内容**：
```
用户 {user_name} 访问了还款页面，待还金额：￥{outstanding_amount}
```

#### 2.5 案件分配 (case_assigned)
**描述**：当案件被分配给催员时发送通知

**可用变量**：
- `{case_id}`: 案件ID
- `{case_number}`: 案件编号
- `{collector_name}`: 催员姓名
- `{assign_time}`: 分配时间
- `{case_amount}`: 案件金额

#### 2.6 PTP提醒 (ptp_reminder)
**描述**：PTP到期前提醒

**可用变量**：
- `{case_id}`: 案件ID
- `{case_number}`: 案件编号
- `{ptp_date}`: PTP日期
- `{ptp_amount}`: 承诺金额
- `{debtor_name}`: 债务人姓名

## 技术实现

### 后端实现

#### 数据库表结构
```sql
CREATE TABLE notification_templates (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tenant_id INT NULL,
    template_id VARCHAR(100) NOT NULL UNIQUE,
    template_name VARCHAR(200) NOT NULL,
    template_type VARCHAR(50) NOT NULL,
    content_template TEXT NOT NULL,
    jump_url_template TEXT NULL,
    target_type VARCHAR(20) DEFAULT 'agency',
    target_agencies JSON NULL,
    target_teams JSON NULL,
    target_collectors JSON NULL,
    is_forced_read BOOLEAN DEFAULT FALSE,
    repeat_interval_minutes INT NULL,
    max_remind_count INT NULL,
    notify_time_start VARCHAR(5) NULL,
    notify_time_end VARCHAR(5) NULL,
    priority VARCHAR(20) DEFAULT 'medium',
    display_duration_seconds INT DEFAULT 5,
    is_enabled BOOLEAN DEFAULT TRUE,
    available_variables JSON NULL,
    total_sent INT DEFAULT 0,
    total_read INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by INT NULL
);
```

#### API接口

**基础路径**: `/api/v1/notification-templates`

1. **获取模板列表** - `GET /`
   - 查询参数：`tenant_id`, `template_type`, `is_enabled`

2. **获取单个模板** - `GET /{template_id}`

3. **创建模板** - `POST /`

4. **更新模板** - `PUT /{template_id}`

5. **删除模板** - `DELETE /{template_id}`

6. **获取模板类型列表** - `GET /types/list`

#### 相关文件
- 模型：`backend/app/models/notification_template.py`
- Schema：`backend/app/schemas/notification.py`
- API：`backend/app/api/notification_template.py`
- 迁移脚本：`backend/create_notification_template_table.py`

### 前端实现

#### 组件结构
- 主组件：`frontend/src/views/system/components/NotificationTemplateConfig.vue`
- 类型定义：`frontend/src/types/notification.ts`
- API封装：`frontend/src/api/notificationTemplate.ts`

#### 功能特性
1. **模板列表展示**
   - 显示模板名称、ID、类型、发送对象、优先级等
   - 支持启用/禁用切换
   - 显示发送和阅读统计

2. **模板编辑表单**
   - 分区块展示：基本信息、通知内容、发送对象、优先级、阅读机制
   - 变量提示：根据选择的模板类型显示可用变量
   - 变量插入：点击变量标签自动插入到正文模板

3. **表单验证**
   - 必填字段验证
   - 模板ID唯一性验证

## 使用指南

### 1. 数据库初始化

首次使用需要创建数据库表并插入示例模板：

```bash
cd backend
python3 create_notification_template_table.py
```

执行后会：
- 创建 `notification_templates` 表
- 插入4个示例模板（案件标签变化、案件还款、用户访问APP、用户访问还款页）

### 2. 访问通知模板配置

1. 登录CCO管理控台
2. 进入"系统管理" -> "通知配置"
3. 点击"通知模板"标签页

### 3. 创建新模板

1. 点击"添加通知模板"按钮
2. 填写基本信息：
   - 模板ID（唯一，不可修改）
   - 模板名称
   - 选择模板类型
3. 编写通知正文模板：
   - 输入文本内容
   - 点击变量标签插入变量
4. 配置发送对象：
   - 选择发送对象类型（机构/小组/催员）
   - 选择具体的目标对象
5. 配置阅读机制：
   - 选择是否强制阅读
   - 如非强制，配置重复提醒参数
6. 设置优先级和展示时长
7. 点击"保存"

### 4. 编辑模板

1. 在模板列表中点击"编辑"按钮
2. 修改需要更改的配置项
3. 点击"保存"

**注意**：模板ID创建后不可修改

### 5. 启用/禁用模板

在模板列表中直接切换"启用状态"开关即可。

禁用后，甲方系统推送该模板的通知将不会发送给用户。

## 甲方系统集成

### 推送通知接口（待实现）

甲方系统需要调用CCO系统的推送接口来发送通知：

```http
POST /api/v1/notifications/push
Content-Type: application/json

{
  "template_id": "case_payment",
  "variables": {
    "case_id": "12345",
    "case_number": "C2025001",
    "amount": "5000.00",
    "payment_time": "2025-11-19 14:30:00",
    "payment_channel": "支付宝",
    "debtor_name": "张三"
  },
  "target_override": {
    "type": "collector",
    "ids": [101, 102]
  }
}
```

**参数说明**：
- `template_id`: 模板ID
- `variables`: 变量值字典
- `target_override`: （可选）覆盖模板中配置的发送对象

## 统计功能

系统会自动统计每个模板的：
- **累计发送次数** (`total_sent`)
- **累计阅读次数** (`total_read`)

可以在模板列表中查看这些统计数据。

## 注意事项

1. **模板ID唯一性**：模板ID必须全局唯一，创建后不可修改
2. **变量格式**：变量使用 `{variable_name}` 格式
3. **发送对象**：不选择具体对象时，会发送给该类型的所有对象
4. **时间范围**：非强制阅读时可配置通知时间范围，避免非工作时间打扰
5. **优先级**：高优先级通知会更显眼地展示给用户

## 后续优化方向

1. **推送接口实现**：实现甲方系统调用的推送接口
2. **通知记录**：记录每次推送的详细信息
3. **阅读追踪**：追踪每个用户的阅读状态
4. **模板测试**：提供模板测试功能，预览渲染效果
5. **批量操作**：支持批量启用/禁用模板
6. **模板复制**：支持复制现有模板快速创建新模板
7. **权限控制**：细化模板管理权限

## 相关文档

- [公共通知优化说明](./公共通知优化说明.md)
- [通知配置系统设计](../后端/通知配置系统设计.md)

---

**更新时间**：2025-11-19  
**版本**：v1.0

