# 催员管理树状图 - 故障排查指南

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 1.0.0 | 2025-12-10 | 初始版本 | 大象 |

## 问题现象

树状图只显示机构层级，没有显示小组群、小组和催员。

```text
当前显示：
📍 测试机构1
📍 测试机构2

期望显示：
📍 测试机构1
  ├── 📊 小组群1
  │   ├── 👥 催收一组
  │   │   ├── 👤 张三
  │   │   └── 👤 李四
  │   └── 👥 催收二组
  └── 👥 独立小组
```

## 快速诊断步骤

### 步骤1：点击"诊断"按钮

1. 打开催员管理页面
2. 在左侧树状图顶部点击 **"诊断"** 按钮
3. 按 `F12` 打开浏览器控制台
4. 查看输出的诊断信息

### 步骤2：查看诊断信息

诊断信息会显示：
```json
{
  "机构数量": 2,
  "树根节点数": 2,
  "机构详情": [
    { "机构名称": "测试机构1", "机构ID": 1 },
    { "机构名称": "测试机构2", "机构ID": 2 }
  ],
  "树数据详情": [
    {
      "节点": "测试机构1",
      "类型": "agency",
      "子节点数": 0,        // ⚠️ 如果为0，说明没有加载到小组群
      "第一个子节点类型": "无",
      "第一个子节点名称": "无"
    }
  ]
}
```

### 步骤3：查看控制台日志

在控制台中搜索关键字：

**正常情况下的日志：**
```text
开始构建树状图，机构数量：2
加载小组群：http://localhost:8080/api/v1/team-groups?tenant_id=1&agency_id=1
机构 测试机构1 的小组群数量：2
加载小组：http://localhost:8080/api/v1/agencies/1/teams
小组群 测试小组群1 的小组数量：3
小组 催收一组 的催员数量：5
...
树状图构建完成，根节点数量：2
```

**异常情况下的日志：**
```text
开始构建树状图，机构数量：2
加载小组群：http://localhost:8080/api/v1/team-groups?tenant_id=1&agency_id=1
机构 测试机构1 的小组群数量：0  // ⚠️ 小组群数量为0
机构 测试机构1 没有小组群，直接加载小组
加载无小组群的小组：http://localhost:8080/api/v1/agencies/1/teams
机构 测试机构1 无小组群的小组数量：0  // ⚠️ 小组数量也为0
```

## 常见问题及解决方案

### 问题1：小组群数量为0

**原因**：该机构下没有创建小组群，或小组群API返回空数据。

**解决方案**：

1. **检查小组群管理页面**
   - 进入 **组织架构 > 小组群管理**
   - 查看是否有该机构的小组群
   - 如果没有，点击"创建小组群"

2. **检查API返回**
   - 在控制台查找小组群API的URL
   - 复制URL到浏览器地址栏访问
   - 检查返回的JSON数据是否为空数组

3. **检查筛选条件**
   - 小组群管理页面的筛选条件是否正确
   - `tenant_id` 和 `agency_id` 是否匹配

### 问题2：小组数量为0

**原因**：小组没有关联到小组群，或该小组群下没有小组。

**解决方案**：

1. **检查小组管理页面**
   - 进入 **组织架构 > 小组管理**
   - 查看该机构的小组列表
   - 检查小组的"所属小组群"字段

2. **修改小组归属**
   - 编辑小组信息
   - 选择正确的小组群
   - 保存后刷新催员管理页面

3. **创建新小组**
   - 在小组管理页面创建新小组
   - 确保选择了小组群

### 问题3：催员数量为0

**原因**：该小组下没有催员账号。

**解决方案**：

1. **在表格中创建催员**
   - 在右侧表格上方点击"创建催员"按钮
   - 选择机构和小组
   - 填写催员信息并保存

2. **从树状图创建催员**（推荐）
   - 在树状图中找到目标小组节点
   - hover到小组节点
   - 点击"创建催员"按钮
   - 机构和小组已自动填充

### 问题4：API返回404

**原因**：后端接口不存在或Java后端未启动。

**解决方案**：

1. **检查Java后端状态**
   ```bash
   # 检查8080端口
   lsof -i :8080
   ```

2. **启动Java后端**
   ```bash
   cd backend-java
   ./start.sh
   ```

3. **检查API路由**
   - 访问 `http://localhost:8080/api/v1/team-groups?tenant_id=1`
   - 应该返回JSON数据而不是404

### 问题5：数据加载慢

**原因**：层级较多，需要多次API调用。

**解决方案**：

- 等待几秒钟，观察控制台日志
- 如果长时间没有反应，点击"刷新"按钮
- 检查网络请求是否超时

## 数据完整性检查清单

在使用树状图之前，请确保：

- [ ] ✅ 至少有1个机构
- [ ] ✅ 每个机构至少有1个小组群
- [ ] ✅ 每个小组群至少有1个小组
- [ ] ✅ 每个小组至少有1个催员
- [ ] ✅ 小组的 `team_group_id` 字段正确关联到小组群
- [ ] ✅ 催员的 `team_id` 字段正确关联到小组

## 手动验证数据

### 1. 验证小组群数据

在浏览器访问：
```text
http://localhost:8080/api/v1/team-groups?tenant_id=1&agency_id=1
```

期望返回：
```json
[
  {
    "id": 1,
    "agency_id": 1,
    "group_name": "测试小组群1",
    "team_count": 2,
    ...
  }
]
```

### 2. 验证小组数据

在浏览器访问：
```text
http://localhost:8080/api/v1/agencies/1/teams
```

期望返回：
```json
[
  {
    "id": 1,
    "agency_id": 1,
    "team_group_id": 1,  // ⚠️ 必须有值
    "team_name": "催收一组",
    ...
  }
]
```

### 3. 验证催员数据

在浏览器访问：
```text
http://localhost:8080/api/v1/teams/1/collectors
```

期望返回：
```json
[
  {
    "id": 1,
    "team_id": 1,  // ⚠️ 必须有值
    "collector_name": "张三",
    ...
  }
]
```

## 调试技巧

### 技巧1：使用Vue DevTools

1. 安装 Vue DevTools 浏览器扩展
2. 打开催员管理页面
3. 在DevTools中找到 CollectorManagement 组件
4. 查看 `treeData` 的值

### 技巧2：监控网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签页
3. 刷新页面
4. 筛选 XHR 请求
5. 查看 `team-groups`、`teams`、`collectors` 的请求和响应

### 技巧3：在控制台手动执行

在控制台执行以下代码：
```javascript
// 获取树组件实例
const tree = document.querySelector('.org-tree').__vueParentComponent
console.log('树数据：', tree.props.data)

// 手动刷新树
// 在Vue组件上下文中执行
buildTreeData()
```

## 联系支持

如果按照以上步骤仍然无法解决问题，请提供以下信息：

1. 浏览器控制台的完整日志
2. "诊断"按钮输出的信息
3. 网络请求的响应数据
4. 数据库中的实际数据（机构、小组群、小组、催员的记录）

---

**最后更新**：2025-12-10  
**版本**：1.0.0
