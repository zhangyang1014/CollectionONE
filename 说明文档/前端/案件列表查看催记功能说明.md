# 案件列表查看催记功能说明

## 功能概述

在案件列表页面的操作列中新增"查看催记"按钮，点击后可以查看该案件的历史催记记录。该功能的样式和代码参考了 IM 端的催记查看弹窗。

## 实现内容

### 1. 操作列按钮

在案件列表的操作列中增加了"查看催记"按钮：

```vue
<el-table-column label="操作" width="200" fixed="right">
  <template #default="{ row }">
    <el-button link type="primary" @click="handleView(row)">查看详情</el-button>
    <el-button link type="primary" @click="handleViewNotes(row)">查看催记</el-button>
  </template>
</el-table-column>
```

### 2. 历史催记弹窗

实现了一个功能完整的历史催记弹窗，包含：

#### 搜索功能
- 支持按案件ID搜索催记记录
- 实时搜索，按回车键或点击搜索按钮触发

#### 筛选器
提供多维度筛选：
- **触达人筛选**：可选择特定的催员
- **触达渠道筛选**：WhatsApp、SMS、RCS、电话外呼
- **状态筛选**：可联、不存在、未响应
- **结果筛选**：承诺还款、拒绝还款、失联、持续跟进
- **日期范围筛选**：选择登记时间范围

#### 催记列表表格
显示完整的催记信息：
- 登记时间
- 案件ID
- 触达人
- 触达渠道
- 状态（带颜色标签）
- 结果
- 备注
- 下次跟进时间

### 3. 数据结构

历史催记数据结构：

```typescript
interface HistoryNote {
  id: number
  register_time: string      // 登记时间
  case_id: string            // 案件ID
  collector: string          // 触达人
  channel: string            // 触达渠道
  status: string             // 状态：reachable/not_exist/no_response
  result: string             // 结果
  remark: string             // 备注
  next_follow_up: string     // 下次跟进时间
}
```

### 4. 样式设计

采用了 IM 端的样式设计：
- 弹窗宽度：1200px
- 表格最大高度：500px（支持滚动）
- 条纹表格样式，提高可读性
- 响应式筛选器布局
- 统一的颜色主题和间距

## 核心功能

### 1. 查看催记功能

```typescript
const handleViewNotes = (row: any) => {
  currentCase.value = row
  historySearchKeyword.value = row.loan_id || ''
  historyNotes.value = generateMockNotes(row)
  showHistoryNotesDialog.value = true
}
```

### 2. 筛选计算

使用 Vue 的 computed 属性实现实时筛选：

```typescript
const filteredHistoryNotes = computed(() => {
  let result = historyNotes.value

  // 案件ID搜索
  if (historySearchKeyword.value) {
    const keyword = historySearchKeyword.value.toLowerCase()
    result = result.filter((note: any) => 
      note.case_id?.toLowerCase().includes(keyword)
    )
  }

  // 其他筛选条件...
  
  return result
})
```

### 3. 状态标签显示

根据不同状态显示不同颜色的标签：

```typescript
const getStatusTagType = (status: string) => {
  const types: Record<string, string> = {
    'reachable': 'success',      // 可联 - 绿色
    'not_exist': 'danger',       // 不存在 - 红色
    'no_response': 'warning'     // 未响应 - 橙色
  }
  return types[status] || ''
}
```

## Mock 数据

当前使用 Mock 数据展示功能，每个案件生成4条示例催记记录：

```typescript
const generateMockNotes = (caseData: any) => {
  return [
    {
      id: 1,
      register_time: '2025-01-15 10:30:25',
      case_id: caseData?.loan_id || '-',
      collector: '张三',
      channel: 'WhatsApp',
      status: 'reachable',
      result: 'promise_repay',
      remark: '客户承诺今天下午还款',
      next_follow_up: '2025-01-15 14:00:00'
    },
    // ... 更多记录
  ]
}
```

## 后续集成

### API 接口对接

需要创建后端 API 接口：

```typescript
// 获取案件催记列表
GET /api/v1/cases/{case_id}/notes

// 请求参数
interface NotesQueryParams {
  collector?: string
  channel?: string
  status?: string
  result?: string
  start_date?: string
  end_date?: string
  page?: number
  page_size?: number
}

// 响应数据
interface NotesResponse {
  data: HistoryNote[]
  total: number
  page: number
  page_size: number
}
```

### API 集成步骤

1. 在 `frontend/src/api/case.ts` 中添加催记查询接口：

```typescript
export const getCaseNotes = (caseId: string | number, params?: any) => {
  return request({
    url: `/api/v1/cases/${caseId}/notes`,
    method: 'get',
    params
  })
}
```

2. 修改 `handleViewNotes` 函数，使用真实 API：

```typescript
const handleViewNotes = async (row: any) => {
  currentCase.value = row
  historySearchKeyword.value = row.loan_id || ''
  showHistoryNotesDialog.value = true
  
  try {
    const response = await getCaseNotes(row.id)
    historyNotes.value = response.data || []
  } catch (error) {
    console.error('加载催记失败:', error)
    ElMessage.error('加载催记失败')
  }
}
```

## 功能特点

1. **用户体验优化**
   - 弹窗打开时自动填充案件ID作为搜索关键词
   - 支持多维度筛选，快速定位目标催记
   - 条纹表格提高数据可读性
   - 备注字段支持省略号显示，鼠标悬停显示完整内容

2. **性能优化**
   - 使用 computed 属性实现响应式筛选
   - 表格设置最大高度，支持虚拟滚动
   - 按需加载，只在打开弹窗时加载数据

3. **代码复用**
   - 参考 IM 端的成熟实现
   - 统一的样式规范和交互逻辑
   - 可扩展的筛选器设计

## 使用方法

1. 进入案件列表页面
2. 找到目标案件行
3. 点击"查看催记"按钮
4. 在弹出的对话框中：
   - 使用搜索框搜索案件ID
   - 使用筛选器按条件筛选
   - 查看催记列表
5. 点击对话框外部或关闭按钮关闭弹窗

## 文件修改

### 修改的文件

1. **frontend/src/views/case-management/CaseList.vue**
   - 添加"查看催记"按钮
   - 添加历史催记弹窗组件
   - 添加催记相关的状态管理
   - 添加催记筛选和搜索逻辑
   - 添加催记样式

### 代码统计

- 新增代码行数：约 250 行
- 新增函数：7 个
- 新增 computed 属性：1 个
- 新增 ref 变量：5 个

## 注意事项

1. **当前使用 Mock 数据**：需要后续对接真实 API 接口
2. **操作列宽度调整**：从 150px 调整为 200px 以容纳两个按钮
3. **日期筛选**：使用 dayjs 库处理日期比较
4. **样式一致性**：与 IM 端保持一致的视觉风格

## 下一步计划

1. **后端 API 开发**
   - 创建催记查询接口
   - 实现分页功能
   - 添加筛选和排序支持

2. **功能增强**
   - 添加催记详情展开功能
   - 支持导出催记记录
   - 添加催记统计图表

3. **性能优化**
   - 实现虚拟滚动支持大量数据
   - 添加缓存机制
   - 优化搜索性能

## 参考文档

- IM 端催记弹窗：`frontend/src/components/IMPanel.vue`
- 案件列表页面：`frontend/src/views/case-management/CaseList.vue`

## 总结

本次实现成功在案件列表页面添加了"查看催记"功能，采用了与 IM 端一致的设计和交互方式，为用户提供了便捷的催记查看入口。功能包含搜索、多维度筛选、状态标签等实用特性，提升了用户体验。后续需要对接后端 API 接口以实现真实数据展示。

