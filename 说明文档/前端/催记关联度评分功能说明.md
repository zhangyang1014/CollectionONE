# 催记关联度评分功能说明

## 功能概述

在催员IM端的催记（Case Note）功能中，新增了"关联度"星星评分功能，用于标记非本人联系人与客户本人的关系紧密程度。同时，在左侧联系人列表中会显示已标记的关联度星级。

## 功能特性

### 1. 显示规则

- **仅非本人联系人显示**：当选择的联系人关系为"本人"时，不显示关联度评分
- **其他联系人显示**：当选择配偶、朋友、父母等非本人联系人时，自动显示关联度评分组件

### 2. 评分标准

采用5星评分制度，标记联系人与客户本人的关系紧密程度：

- **1星**：很低 - 关系非常疏远，几乎没有联系
- **2星**：较低 - 关系一般，偶尔联系
- **3星**：中等 - 有一定联系，会定期沟通
- **4星**：较高 - 关系较好，经常联系
- **5星**：很高 - 关系非常紧密，如配偶、直系亲属等

### 3. UI展示

- **位置**：在催记表单中，位于"自动填充信息"区域之后，"沟通状态"之前
- **组件**：采用 Element Plus 的 Rate 评分组件
- **布局**：单行紧凑布局，星星评分和说明文字在同一行显示，节省空间
- **特性**：
  - 中等尺寸星星图标，易于点击
  - 显示文字提示（很低、较低、中等、较高、很高）
  - 渐变颜色显示（灰色→黄色→橙色）
  - 同行显示辅助说明文字

### 4. 数据处理

- **默认值**：0星（未评分）
- **数据字段**：`relation_level`
- **保存位置**：在提交催记时，关联度数据会随其他催记信息一起保存
- **自动重置**：
  - 切换联系人时自动重置为0星
  - 提交催记成功后自动重置为0星

## 技术实现

### 数据结构

```typescript
// 联系人数据结构
const contacts = ref([
  {
    id: 1,
    name: '张三',
    phone: '+91 98 7654 3210',
    phone_last4: '3210',
    relation: '配偶',
    channels: ['whatsapp', 'call'],
    relation_level: 0 // 关联度（0-5星）
  }
])

// 催记表单中添加的字段
const caseNoteForm = ref({
  // ... 其他字段
  relation_level: 0, // 关联度（1-5星）
  // ... 其他字段
})
```

### UI组件

**催记表单中的评分组件：**

```vue
<!-- 关联度（仅非本人时显示） -->
<el-form-item v-if="!isMainContact" label="关联度" class="relation-level-item">
  <div class="relation-level-row">
    <el-rate 
      v-model="caseNoteForm.relation_level" 
      :max="5"
      show-text
      :texts="['很低', '较低', '中等', '较高', '很高']"
      :colors="['#99A9BF', '#F7BA2A', '#FF9900']"
    />
    <span class="relation-level-hint">标记该联系人与客户本人的关系紧密程度</span>
  </div>
</el-form-item>
```

**联系人列表中的星级显示：**

```vue
<div class="contact-relation-row">
  <span class="contact-relation">{{ contact.relation }}</span>
  <span v-if="contact.relation !== '本人' && contact.relation_level > 0" class="contact-stars">
    <el-icon 
      v-for="star in contact.relation_level" 
      :key="star" 
      class="star-icon"
      :size="12"
    >
      <StarFilled />
    </el-icon>
  </span>
</div>
```

### 提交数据

```typescript
// 构建催记数据
const noteData = {
  // ... 其他字段
  relation_level: caseNoteForm.value.relation_level, // 关联度
  // ... 其他字段
}

// 提交成功后更新联系人的关联度（取最新值）
if (selectedContact.value && selectedContact.value.relation !== '本人' && caseNoteForm.value.relation_level > 0) {
  const contactIndex = contacts.value.findIndex(c => c.id === selectedContact.value?.id)
  if (contactIndex !== -1) {
    contacts.value[contactIndex].relation_level = caseNoteForm.value.relation_level
  }
}
```

## 使用场景

1. **催员在联系非本人联系人时**：
   - 联系配偶：可能标记为4-5星（关系紧密）
   - 联系朋友：可能标记为2-3星（关系一般）
   - 联系同事：可能标记为1-2星（关系疏远）

2. **帮助催员评估联系人价值**：
   - 高关联度的联系人更可能帮助催员联系到客户本人
   - 可以优先联系高关联度的联系人

3. **数据分析**：
   - 统计不同关联度联系人的催收成功率
   - 优化催收策略

## 联系人列表显示

### 显示规则

1. **仅显示非本人且已标记**：只有关系为非本人且关联度大于0的联系人才会显示星级
2. **小图标显示**：在联系人关系旁边显示小星星图标（12px）
3. **橙色标识**：星星使用橙色（#FF9900）显示，醒目但不突兀
4. **多次标记取最新**：如果对同一联系人多次标记关联度，显示最新的评分

### UI效果

在左侧联系人列表中：

```
┌────────────────────────────────┐
│ 👤  本人                        │
│     用户001           1514      │
├────────────────────────────────┤
│ 👤  配偶 ★★★★★                 │
│     张三              3210      │
├────────────────────────────────┤
│ 👤  朋友 ★★★                   │
│     李四              4321      │
└────────────────────────────────┘
```

## 注意事项

1. **不强制评分**：评分为可选项，催员可以不进行评分（保持0星）
2. **灵活调整**：催员可以在催记提交前随时调整评分
3. **数据记录**：评分数据会随催记一起保存，便于后续分析
4. **自动更新**：提交催记后，联系人列表的星级会自动更新

## 效果展示

当选择非本人联系人时，催记表单会显示：

```
┌─────────────────────────────────────────────────────────────┐
│ 联系方式：WhatsApp  联系人：张三  关系：朋友                 │
└─────────────────────────────────────────────────────────────┘

关联度
★★★★☆ 较高  标记该联系人与客户本人的关系紧密程度

沟通状态
○ 可联  ○ 不存在  ○ 未响应
```

## 更新日期

2025-11-20

## 相关文件

- `frontend/src/components/IMPanel.vue` - 催员IM面板组件

