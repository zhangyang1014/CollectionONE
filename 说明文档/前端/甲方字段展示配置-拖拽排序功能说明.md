# 甲方字段展示配置 - 拖拽排序功能说明

## 📋 功能概述

在"甲方字段展示配置"页面中实现了直观的拖拽排序功能，用户可以通过拖拽行来调整字段的显示顺序，无需手动输入排序数字。

## ✨ 功能特性

### 1. 拖拽交互
- ✅ 鼠标悬停拖拽图标时高亮显示
- ✅ 拖拽时行半透明显示
- ✅ 拖拽占位符显示
- ✅ 平滑的拖拽动画效果

### 2. 自动更新排序
- ✅ 拖拽完成后自动更新所有字段的 `sort_order`
- ✅ 按拖拽后的位置重新分配序号（1, 2, 3...）
- ✅ 提示用户点击"批量保存"保存更改

### 3. UI改进
- ✅ 添加"拖拽"列（显示拖拽图标）
- ✅ 移除了原来的"排序"数字输入列
- ✅ 使用 Element Plus 的 Rank 图标

## 🎨 界面变化

### 修改前
```
| 序号 | 字段名称 | 字段标识 | 是否显示 | 排序 | 显示宽度 | ...
|  1   | 案件编号 | case_code | ☑️ | [1] | 180px | ...
|  2   | 客户姓名 | user_name | ☑️ | [2] | 120px | ...
```
- 需要手动修改排序数字
- 不够直观

### 修改后
```
| 拖拽 | 序号 | 字段名称 | 字段标识 | 是否显示 | 显示宽度 | ...
| ≣   |  1   | 案件编号 | case_code | ☑️ | 180px | ...
| ≣   |  2   | 客户姓名 | user_name | ☑️ | 120px | ...
```
- 鼠标拖拽图标即可调整顺序
- 更加直观和易用

## 🔧 技术实现

### 1. 使用的库

**Sortablejs** - 已在项目中安装
```json
{
  "dependencies": {
    "sortablejs": "^1.15.6"
  }
}
```

### 2. 核心代码

#### 导入依赖
```typescript
import { ref, computed, onMounted, nextTick } from 'vue'
import { Rank } from '@element-plus/icons-vue'
import Sortable from 'sortablejs'
```

#### 表格添加拖拽列
```vue
<el-table
  ref="tableRef"
  :data="configs"
  border
  row-key="id"
>
  <el-table-column label="拖拽" width="60" align="center">
    <template #default>
      <el-icon class="drag-handle" style="cursor: move;">
        <Rank />
      </el-icon>
    </template>
  </el-table-column>
  <!-- 其他列... -->
</el-table>
```

#### 初始化拖拽功能
```typescript
const initDragSort = () => {
  nextTick(() => {
    const table = tableRef.value?.$el
    if (!table) return
    
    const tbody = table.querySelector('.el-table__body-wrapper tbody')
    if (!tbody) return
    
    Sortable.create(tbody, {
      handle: '.drag-handle',  // 只能通过拖拽图标拖动
      animation: 150,           // 动画时长
      onEnd: ({ oldIndex, newIndex }) => {
        if (oldIndex === newIndex) return
        
        // 重新排列数组
        const movedItem = configs.value.splice(oldIndex!, 1)[0]
        configs.value.splice(newIndex!, 0, movedItem)
        
        // 更新所有项的sort_order
        configs.value.forEach((config, index) => {
          config.sort_order = index + 1
        })
        
        ElMessage.success('拖拽成功，请点击"批量保存"保存更改')
      }
    })
  })
}
```

#### 样式定义
```css
.drag-handle {
  font-size: 16px;
  color: #909399;
  transition: color 0.3s;
}

.drag-handle:hover {
  color: #409eff;
}

:deep(.sortable-ghost) {
  opacity: 0.4;
  background: #f5f7fa;
}

:deep(.sortable-drag) {
  opacity: 0.8;
  background: #ecf5ff;
}
```

### 3. 集成点

#### 页面加载时初始化
```typescript
onMounted(() => {
  loadSceneTypes()
  if (currentTenantId.value) {
    loadConfigs()
  }
  initDragSort()
})
```

#### 加载数据后重新初始化
```typescript
const loadConfigs = async () => {
  // ... 加载数据
  configs.value = data
  
  // 初始化拖拽排序
  initDragSort()
}
```

#### 场景切换时重新初始化
```typescript
const handleSceneChange = () => {
  loadConfigs()
  initDragSort()
}
```

## 📖 使用说明

### 1. 拖拽排序

1. 找到要移动的字段行
2. 将鼠标悬停在该行最左侧的"≣"图标上
3. 按住鼠标左键并拖动到目标位置
4. 释放鼠标完成拖拽
5. 系统提示"拖拽成功，请点击'批量保存'保存更改"

### 2. 保存更改

拖拽完成后：
1. 点击页面顶部的"批量保存"按钮
2. 系统将保存所有字段的新排序
3. 页面刷新显示最新排序

### 3. 视觉反馈

- **拖拽图标悬停**：图标变为蓝色
- **拖拽中的行**：半透明（opacity: 0.8），背景浅蓝色
- **拖拽占位符**：更透明（opacity: 0.4），背景灰色

## 🎯 优势对比

### 原方案（手动输入排序数字）

**缺点：**
- ❌ 需要记住或查看每个字段的序号
- ❌ 调整顺序需要修改多个字段的数字
- ❌ 容易出现重复的序号
- ❌ 不够直观

**优点：**
- ✅ 可以精确指定序号

### 新方案（拖拽排序）

**优点：**
- ✅ 直观易用，所见即所得
- ✅ 快速调整顺序，无需思考
- ✅ 自动处理序号冲突
- ✅ 符合用户习惯
- ✅ 减少操作步骤

**缺点：**
- 无明显缺点

## 🔍 测试要点

### 功能测试

- [x] 拖拽图标可见且样式正确
- [x] 鼠标悬停图标时高亮
- [x] 可以拖动行到其他位置
- [x] 拖拽后序号自动更新
- [x] 拖拽后提示用户保存
- [x] 批量保存后排序生效
- [x] 场景切换后拖拽功能正常
- [x] 多次拖拽功能正常

### 兼容性测试

- [x] Chrome 浏览器
- [x] Firefox 浏览器
- [x] Safari 浏览器
- [x] Edge 浏览器

### 边界情况

- [x] 只有一条数据时不影响显示
- [x] 大量数据时拖拽流畅
- [x] 拖拽到第一行
- [x] 拖拽到最后一行
- [x] 连续多次拖拽

## 📝 相关文件

### 修改的文件
- `frontend/src/views/field-config/FieldDisplayConfig.vue` - 主要实现文件

### 使用的依赖
- `sortablejs` - 拖拽排序库（已在项目中）
- `@element-plus/icons-vue` - Rank 图标

### 相关功能
- 批量保存功能（已存在）
- 场景切换功能（已存在）
- 字段配置CRUD（已存在）

## 💡 扩展建议

### 1. 添加拖拽提示
可以在页面顶部添加提示信息：
```
💡 提示：拖动左侧"≣"图标可调整字段显示顺序
```

### 2. 自动保存选项
考虑添加"拖拽后自动保存"的选项：
- 优点：减少操作步骤
- 缺点：可能导致频繁的API请求

### 3. 批量拖拽
支持选中多行后一起拖拽（较复杂）

### 4. 拖拽预览
在拖拽时显示将要插入的位置（添加分隔线）

## 🐛 常见问题

### Q1: 拖拽后序号没有更新？
**A:** 检查是否正确调用了 `initDragSort()` 函数，确保在数据加载完成后调用。

### Q2: 无法拖拽？
**A:** 检查是否正确导入了 `sortablejs`，确保 `tableRef` 正确绑定到表格元素。

### Q3: 拖拽后没有保存？
**A:** 拖拽只是在前端调整顺序，需要点击"批量保存"按钮才能保存到后端。

### Q4: 场景切换后拖拽失效？
**A:** 确保在 `handleSceneChange` 函数中调用了 `initDragSort()`。

## ✅ 完成状态

- ✅ 拖拽功能实现
- ✅ 去除排序数字列
- ✅ 添加拖拽图标列
- ✅ 自动更新排序值
- ✅ 用户提示完善
- ✅ 样式美化
- ✅ 功能测试通过

**状态**：✅ 完成，可正常使用

---

**实现时间**：2025-11-20  
**实现人员**：系统开发  
**功能状态**：已上线，可用

