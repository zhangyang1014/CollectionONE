# CCO催收系统 v2.0 架构可视化

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend)                          │
│                     Vue 3 + TypeScript                           │
├─────────────────────────────────────────────────────────────────┤
│  催收工作台  │  甲方管理台  │  系统配置台  │  报表统计台        │
└────────┬──────────────┬────────────┬────────────┬───────────────┘
         │              │            │            │
         └──────────────┴────────────┴────────────┘
                        │
              ┌─────────▼─────────┐
              │   API Gateway     │
              │   (RESTful API)   │
              └─────────┬─────────┘
                        │
┌─────────────────────────────────────────────────────────────────┐
│                       后端层 (Backend)                            │
│                         FastAPI                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 组织架构管理  │  │ 案件管理     │  │ 字段配置     │         │
│  │              │  │              │  │              │         │
│  │ • 机构       │  │ • 队列分配   │  │ • 标准字段   │         │
│  │ • 小组       │  │ • 催员分配   │  │ • 自定义字段 │         │
│  │ • 催员       │  │ • 流转记录   │  │ • 字段联动   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ IM通讯       │  │ 权限管理     │  │ 数据同步     │         │
│  │              │  │              │  │              │         │
│  │ • 消息       │  │ • 角色       │  │ • 字段映射   │         │
│  │ • 会话       │  │ • 权限       │  │ • 数据推送   │         │
│  │ • 通知       │  │ • 审计       │  │ • 数据拉取   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                        │
         ┌──────────────┴──────────────┐
         │                             │
┌────────▼─────────┐          ┌───────▼──────┐
│   数据持久层      │          │  缓存层       │
│                  │          │              │
│  PostgreSQL/     │          │    Redis     │
│  MySQL           │          │              │
│                  │          │  • 字段配置  │
│  • 案件数据      │          │  • 字段映射  │
│  • 组织架构      │          │  • 会话信息  │
│  • 字段配置      │          │              │
│  • 历史记录      │          │              │
└──────────────────┘          └──────────────┘
```

---

## 📊 数据库 ER 图

### 核心实体关系

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   Tenant    │         │CollectionAgency        │CollectionTeam
│   甲方      │────1:N──│   催收机构   │────1:N──│   催收小组  │
│             │         │              │         │             │
│ • id        │         │ • id         │         │ • id        │
│ • name      │         │ • tenant_id  │         │ • agency_id │
│ • code      │         │ • code       │         │ • code      │
└─────────────┘         │ • name       │         │ • name      │
                        └──────────────┘         │ • leader_id │
                                                  └─────────────┘
                                                        │
                                                        │1:N
                                                        ▼
        ┌──────────────────┐                    ┌─────────────┐
        │   CaseQueue      │                    │  Collector  │
        │   案件队列       │                    │    催员     │
        │                  │                    │             │
        │ • id             │                    │ • id        │
        │ • tenant_id      │                    │ • team_id   │
        │ • code           │                    │ • code      │
        │ • name           │                    │ • name      │
        │ • overdue_days   │                    │ • level     │
        └──────────────────┘                    └─────────────┘
               │                                       │
               │1:N                                    │1:N
               ▼                                       ▼
        ┌──────────────────────────────────────────────────┐
        │                     Case                          │
        │                    案件                           │
        │                                                   │
        │ • id                                              │
        │ • case_id                                         │
        │ • tenant_id    ─────┐                            │
        │ • agency_id    ─────┼─── 组织关联                │
        │ • team_id      ─────┤                            │
        │ • collector_id ─────┘                            │
        │ • queue_id     ────── 队列关联                   │
        │ • overdue_days                                    │
        │ • status                                          │
        └───────────────────────────────────────────────────┘
                              │
                              │1:N
                              ▼
                ┌────────────────────────────┐
                │ CaseAssignmentHistory      │
                │   案件分配历史             │
                │                            │
                │ • id                       │
                │ • case_id                  │
                │ • from_agency_id           │
                │ • to_agency_id             │
                │ • from_team_id             │
                │ • to_team_id               │
                │ • from_collector_id        │
                │ • to_collector_id          │
                │ • assigned_at              │
                └────────────────────────────┘
```

### 字段配置关系

```
┌─────────────────┐
│  StandardField  │
│   标准字段      │
│                 │
│ • id            │
│ • field_key     │
│ • field_name    │
│ • field_type    │
└─────────────────┘
        │
        │M:N (通过tenant_field_configs)
        ▼
┌─────────────────┐         ┌──────────────────┐
│     Tenant      │────1:N──│TenantFieldConfig │
│     甲方        │         │ 甲方字段配置      │
│                 │         │                  │
└─────────────────┘         │ • tenant_id      │
                            │ • field_id       │
                            │ • is_visible     │
                            │ • is_required    │
                            │ • tenant_field_key  ✨ 映射
                            └──────────────────┘

┌─────────────────┐         ┌──────────────────┐
│   CaseQueue     │────1:N──│QueueFieldConfig  │
│   案件队列      │         │ 队列字段配置      │
│                 │         │                  │
└─────────────────┘         │ • queue_id       │
                            │ • field_id       │
                            │ • is_visible     │ ✨ 队列级别
                            │ • is_required    │
                            │ • is_readonly    │
                            └──────────────────┘

┌─────────────────┐         ┌──────────────────┐
│  StandardField  │────1:N──│FieldDependency   │
│   标准字段      │         │   字段联动       │
│                 │         │                  │
└─────────────────┘         │ • source_field   │
                            │ • target_field   │
                            │ • rule_type      │
                            │ • rule_config    │ ✨ 可配置
                            └──────────────────┘
```

---

## 🔄 业务流程图

### 1. 案件分配流程

```
┌─────────────┐
│ 案件导入     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 自动分配队列 │ (根据逾期天数)
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│         分配到组织层级            │
├─────────────────────────────────┤
│  方式1: 分配到机构               │
│  方式2: 分配到小组               │
│  方式3: 分配到催员               │
│  方式4: 自动分配（智能算法）      │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────┐
│ 记录分配历史 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 催员开始催收 │
└─────────────┘
```

### 2. 字段配置流程

```
┌────────────────┐
│ 系统标准字段    │ (默认配置)
└───────┬────────┘
        │
        ▼
┌────────────────┐
│ 甲方字段配置    │ (甲方级别覆盖)
│                │
│ • 选择需要的字段│
│ • 设置必填     │ ✨ 新增字段映射
│ • 映射甲方字段名│    tenant_field_key
└───────┬────────┘
        │
        ▼
┌────────────────┐
│ 队列字段配置    │ (队列级别覆盖) ✨ 新增
│                │
│ • M1队列: 基础字段    │
│ • M2队列: 更多字段    │
│ • M3+队列: 法务字段   │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│ 字段联动规则    │ ✨ 可配置化
│                │
│ • 条件: 字段A = 值1  │
│ • 动作: 显示字段B    │
│ • 动作: 字段C必填    │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│ 最终展示效果    │ (优先级: 队列 > 甲方 > 默认)
└────────────────┘
```

### 3. 数据同步流程

```
┌─────────────┐
│ 甲方系统     │
└──────┬──────┘
       │
       │ Push Data (使用甲方字段名)
       │
       ▼
┌─────────────────────────┐
│      API Gateway        │
│                         │
│  UID → user_id          │ ✨ 字段映射
│  UserName → user_name   │
└──────┬──────────────────┘
       │
       ▼
┌─────────────┐
│ 数据验证     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 存储到数据库 │ (统一的标准字段)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 自动分配队列 │ (根据业务规则)
└─────────────┘
```

---

## 🎯 模块依赖关系

```
                    ┌─────────────┐
                    │   主应用    │
                    │   (main.py) │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
    ┌──────▼─────┐  ┌─────▼──────┐  ┌────▼──────┐
    │  核心模块   │  │  API路由   │  │  数据模型 │
    │  (core)    │  │  (api)     │  │  (models) │
    └──────┬─────┘  └─────┬──────┘  └────┬──────┘
           │               │               │
    ┌──────▼──────────────▼───────────────▼──────┐
    │           依赖的外部服务                     │
    ├──────────────────────────────────────────────┤
    │  • 数据库 (PostgreSQL/MySQL)                │
    │  • 缓存 (Redis)                             │
    │  • IM服务 (WebSocket)                       │
    └──────────────────────────────────────────────┘
```

---

## 📱 前端页面结构

```
┌────────────────────────────────────────────────────────┐
│                      主布局                              │
│  ┌────────────┬──────────────────────────────────────┐ │
│  │            │          导航栏                       │ │
│  │            ├──────────────────────────────────────┤ │
│  │  侧边菜单   │                                       │ │
│  │            │                                       │ │
│  │ 催收工作台  │          内容区域                      │ │
│  │  • 我的案件 │                                       │ │
│  │  • IM沟通  │       <router-view>                   │ │
│  │            │                                       │ │
│  │ 系统管理   │                                       │ │
│  │  • 甲方管理 │                                       │ │
│  │  • 组织管理 ✨                                     │ │
│  │  • 队列管理 ✨                                     │ │
│  │  • 字段配置 │                                       │ │
│  │            │                                       │ │
│  │ 报表统计   │                                       │ │
│  │  • 案件统计 │                                       │ │
│  │  • 催收绩效 │                                       │ │
│  └────────────┴──────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
```

---

## 🚀 技术栈详情

### 后端技术栈
```
FastAPI (Web框架)
    │
    ├── SQLAlchemy (ORM)
    │   └── PostgreSQL / MySQL
    │
    ├── Pydantic (数据验证)
    │
    ├── Alembic (数据库迁移)
    │
    ├── Redis (缓存)
    │
    └── WebSocket (实时通讯)
```

### 前端技术栈
```
Vue 3 (框架)
    │
    ├── TypeScript (类型安全)
    │
    ├── Element Plus (UI组件库)
    │
    ├── Pinia (状态管理)
    │
    ├── Vue Router (路由)
    │
    ├── Axios (HTTP客户端)
    │
    └── Vue I18n (国际化)
```

---

## 📈 系统扩展性

### 水平扩展
```
┌────────┐   ┌────────┐   ┌────────┐
│ API-1  │   │ API-2  │   │ API-3  │
└───┬────┘   └───┬────┘   └───┬────┘
    └────────────┼────────────┘
                 │
         ┌───────▼───────┐
         │ Load Balancer │
         └───────┬───────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
┌───▼───┐   ┌───▼───┐   ┌───▼───┐
│ DB-1  │   │ DB-2  │   │ DB-3  │
│(主库) │───│(从库) │───│(从库) │
└───────┘   └───────┘   └───────┘
```

### 垂直扩展
```
┌─────────────────────────┐
│   应用层 (可独立部署)    │
├─────────────────────────┤
│ • 催收业务服务           │
│ • 配置管理服务           │
│ • IM通讯服务            │
│ • 报表统计服务           │
└─────────────────────────┘
```

---

## 🎨 UI设计规范

### 色彩体系
- **主色调**：#409EFF (Element Plus Primary)
- **成功色**：#67C23A
- **警告色**：#E6A23C
- **危险色**：#F56C6C
- **信息色**：#909399

### 布局规范
- **侧边栏宽度**：200px
- **内容区padding**：20px
- **卡片间距**：20px
- **表格行高**：48px
- **按钮间距**：10px

---

**文档版本**：v2.0  
**最后更新**：2024-11-11  
**维护团队**：CCO开发组

