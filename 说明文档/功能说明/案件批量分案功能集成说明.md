# 案件批量分案功能集成说明

## 功能概述

手动批量分案功能已完成开发，包括：
- ✅ 后端API（获取催员列表、队列限制检查、批量分案）
- ✅ 前端组件（批量分案弹窗、队列限制确认弹窗）
- ✅ 数据库表（案件分配历史记录表）

## 后端API

### 1. 获取催员列表
```
GET /api/v1/cases/collectors-for-assign
```

**参数：**
- `agency_id`（可选）：机构ID
- `team_id`（可选）：小组ID
- `queue_id`（可选）：队列ID
- `search_keyword`（可选）：搜索关键词（催员名或ID）

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "collectorName": "张三",
      "collectorCode": "C001",
      "agencyId": 1,
      "agencyName": "机构A",
      "teamId": 1,
      "teamName": "小组1",
      "queueId": 1,
      "queueName": "M1",
      "currentCaseCount": 50,
      "status": "active"
    }
  ]
}
```

### 2. 检查队列限制
```
POST /api/v1/cases/check-queue-limit
```

**请求体：**
```json
{
  "caseIds": [1, 2, 3],
  "collectorIds": [10, 11, 12]
}
```

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hasLimit": true,
    "unmatchedItems": [
      {
        "caseId": 1,
        "caseCode": "CASE001",
        "caseQueueId": 1,
        "caseQueueName": "M1",
        "collectorId": 10,
        "collectorName": "张三",
        "collectorTeamQueueId": 2,
        "collectorTeamQueueName": "M2"
      }
    ]
  }
}
```

### 3. 批量分配案件
```
POST /api/v1/cases/batch-assign
```

**请求体：**
```json
{
  "caseIds": [1, 2, 3],
  "collectorIds": [10, 11, 12],
  "ignoreQueueLimit": false
}
```

**响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "successCount": 100,
    "failureCount": 0,
    "assignments": [
      {
        "caseId": 1,
        "collectorId": 10,
        "status": "success"
      }
    ]
  }
}
```

## 前端组件

### 1. 批量分案弹窗组件
**位置：** `frontend/src/components/BatchAssignDialog.vue`

**使用方式：**
```vue
<template>
  <BatchAssignDialog
    v-model="showBatchAssignDialog"
    :selected-case-ids="selectedCaseIds"
    @success="handleAssignSuccess"
  />
</template>

<script setup>
import BatchAssignDialog from '@/components/BatchAssignDialog.vue'
import { ref } from 'vue'

const showBatchAssignDialog = ref(false)
const selectedCaseIds = ref([])

const handleAssignSuccess = () => {
  // 刷新案件列表
  loadCases()
}
</script>
```

### 2. 队列限制确认弹窗组件
**位置：** `frontend/src/components/QueueLimitConfirmDialog.vue`

此组件已在`BatchAssignDialog`中自动调用，无需单独使用。

## 集成到案件列表页面

### 方法1：在CaseList.vue中添加批量分案功能

1. **导入组件**
```vue
<script setup lang="ts">
import BatchAssignDialog from '@/components/BatchAssignDialog.vue'
</script>
```

2. **添加状态管理**
```vue
<script setup lang="ts">
const showBatchAssignDialog = ref(false)
const selectedCases = ref<any[]>([])
</script>
```

3. **添加批量分案按钮**
```vue
<template>
  <!-- 在表格上方添加批量操作工具栏 -->
  <div v-if="selectedCases.length > 0" class="batch-toolbar">
    <span>已选择 {{ selectedCases.length }} 个案件</span>
    <el-button type="primary" @click="handleBatchAssign">
      批量分案
    </el-button>
  </div>

  <!-- 案件表格 -->
  <el-table
    :data="cases"
    @selection-change="handleSelectionChange"
  >
    <el-table-column type="selection" width="55" />
    <!-- 其他列... -->
  </el-table>

  <!-- 批量分案弹窗 -->
  <BatchAssignDialog
    v-model="showBatchAssignDialog"
    :selected-case-ids="selectedCases.map(c => c.id)"
    @success="handleAssignSuccess"
  />
</template>
```

4. **添加方法**
```vue
<script setup lang="ts">
// 处理表格选择变化
const handleSelectionChange = (selection: any[]) => {
  selectedCases.value = selection
}

// 打开批量分案弹窗
const handleBatchAssign = () => {
  if (selectedCases.value.length === 0) {
    ElMessage.warning('请先选择案件')
    return
  }
  showBatchAssignDialog.value = true
}

// 分案成功后刷新列表
const handleAssignSuccess = () => {
  selectedCases.value = []
  loadCases() // 刷新案件列表的方法
}
</script>
```

## 数据库表

需要执行SQL创建案件分配记录表：

```sql
-- 位置：backend-java/src/main/resources/sql/case_assignments.sql

CREATE TABLE IF NOT EXISTS `case_assignments` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `case_id` BIGINT NOT NULL COMMENT '案件ID',
  `collector_id` BIGINT NOT NULL COMMENT '催员ID',
  `assigned_by` BIGINT NOT NULL COMMENT '分配人ID',
  `assigned_at` DATETIME NOT NULL COMMENT '分配时间',
  `ignore_queue_limit` TINYINT(1) DEFAULT 0 COMMENT '是否忽略队列限制',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_case_id` (`case_id`),
  KEY `idx_collector_id` (`collector_id`),
  KEY `idx_assigned_at` (`assigned_at`),
  KEY `idx_assigned_by` (`assigned_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案件分配记录表';
```

## 功能特性

1. **批量选择案件**
   - 支持单选、全选、反选
   - 支持跨页选择

2. **筛选催员**
   - 按机构筛选
   - 按小组筛选（依赖机构）
   - 按队列属性筛选（依赖小组）
   - 支持多条件组合筛选

3. **搜索催员**
   - 支持按催员名称搜索（模糊匹配）
   - 支持按催员ID搜索（精确匹配）

4. **催员信息展示**
   - 催员名称和ID
   - 所属机构和小组
   - 队列属性
   - 今日持案量（实时统计）

5. **平均分配算法**
   - 将案件平均分配给选中的催员
   - 如果不能整除，前N个催员多分配1个案件
   - 随机打乱案件顺序，避免按固定顺序分配

6. **队列限制检查**
   - 检测案件队列与催员小组队列是否匹配
   - 不匹配时弹窗二次确认
   - 支持突破队列限制分配

7. **分配历史记录**
   - 记录每次分配操作
   - 记录分配人、分配时间
   - 记录是否忽略队列限制

## 测试步骤

1. **启动后端服务**
```bash
cd backend-java
./start.sh
```

2. **启动前端服务**
```bash
cd frontend
npm run dev
```

3. **执行数据库表创建**
在MySQL中执行：
```sql
source backend-java/src/main/resources/sql/case_assignments.sql
```

4. **功能测试**
   - 登录系统
   - 进入案件列表页面
   - 选择多个案件
   - 点击"批量分案"按钮
   - 筛选/搜索催员
   - 选择催员
   - 点击"平均分案"
   - 如果队列不匹配，确认是否忽略限制
   - 查看分配结果

## 注意事项

1. **权限控制**
   - 不同角色只能分配权限范围内的案件
   - SuperAdmin：可以分配所有案件
   - TenantAdmin：只能分配本甲方的案件
   - AgencyAdmin：只能分配本机构的案件
   - TeamLeader：只能分配本小组的案件

2. **案件状态限制**
   - 只能选择未结清的案件（pending_repayment、partial_repayment）
   - 已结清的案件不能选择（normal_settlement、extension_settlement）

3. **催员状态限制**
   - 只显示启用状态的催员（is_active=1, status='active'）
   - 已禁用的催员不显示在列表中

4. **队列限制**
   - 队列限制检查默认启用
   - 检测到不匹配时需要用户二次确认
   - 用户可以选择忽略队列限制继续分配

5. **事务处理**
   - 批量分配使用事务处理
   - 如果部分案件分配失败，不会回滚（根据实际需求调整）
   - 分配成功后会更新案件的collector_id、team_id、agency_id、assigned_at字段

## 后续优化建议

1. **性能优化**
   - 大批量分配（>500个案件）时考虑异步处理
   - 催员列表分页加载
   - 队列限制检查优化（批量查询）

2. **功能增强**
   - 支持按金额分配
   - 支持按优先级分配
   - 支持按催员能力分配
   - 分配历史记录查询
   - 分配撤销功能
   - 分配通知功能（短信/邮件）

3. **用户体验**
   - 分配进度条显示
   - 分配结果详细报告
   - 支持导出分配结果

---

**最后更新：** 2025-11-27  
**版本：** v1.0.0



















