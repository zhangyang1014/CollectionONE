# 批量分案500错误修复说明

## 问题描述

点击"批量分案"后，获取催员列表接口返回500错误：
```
GET /api/v1/cases/collectors-for-assign?search_keyword=
500 Internal Server Error
```

## 问题原因

1. **CollectorMapper未注册**
   - `CollectorMapper`接口没有被注册到MyBatis的MapperConfig中
   - 导致Spring无法注入CollectorMapper，调用时抛出异常

2. **CaseAssignmentMapper未注册**
   - 同样的问题，CaseAssignmentMapper也没有注册

## 修复内容

### 1. 注册Mapper到MapperConfig

**文件：** `backend-java/src/main/java/com/cco/common/config/MapperConfig.java`

**添加内容：**
```java
/**
 * 手动注册CollectorMapper
 */
@Bean
public MapperFactoryBean<CollectorMapper> collectorMapper() {
    MapperFactoryBean<CollectorMapper> factoryBean = new MapperFactoryBean<>();
    factoryBean.setMapperInterface(CollectorMapper.class);
    factoryBean.setSqlSessionFactory(sqlSessionFactory);
    return factoryBean;
}

/**
 * 手动注册CaseAssignmentMapper
 */
@Bean
public MapperFactoryBean<CaseAssignmentMapper> caseAssignmentMapper() {
    MapperFactoryBean<CaseAssignmentMapper> factoryBean = new MapperFactoryBean<>();
    factoryBean.setMapperInterface(CaseAssignmentMapper.class);
    factoryBean.setSqlSessionFactory(sqlSessionFactory);
    return factoryBean;
}
```

### 2. 修复SQL查询格式

**文件：** `backend-java/src/main/resources/mapper/CollectorMapper.xml`

**修复内容：**
- 修复了where条件的格式，使用`<if test="true">`包裹固定条件
- 添加了`assigned_at IS NOT NULL`检查，避免NULL值导致的问题

## 修复步骤

### 1. 重启后端服务

```bash
cd backend-java

# 停止当前服务（如果正在运行）
# 按Ctrl+C或查找进程并kill

# 重新启动
./start.sh
```

### 2. 验证修复

1. 启动后端服务后，查看日志确认没有错误
2. 访问前端，进入案件列表
3. 选择案件，点击"批量分案"
4. 应该能正常打开分案弹窗并加载催员列表

### 3. 检查日志

如果还有问题，查看后端日志：
```bash
tail -f backend-java/backend-java.log
```

查找相关错误信息：
- `CollectorMapper`相关的错误
- SQL执行错误
- 表不存在错误

## 可能的问题排查

### 问题1：表不存在

如果报错"Table 'xxx' doesn't exist"，需要执行数据库初始化：

```sql
-- 检查表是否存在
SHOW TABLES LIKE 'collectors';
SHOW TABLES LIKE 'collection_agencies';
SHOW TABLES LIKE 'collection_teams';
SHOW TABLES LIKE 'case_queues';
SHOW TABLES LIKE 'cases';

-- 如果表不存在，执行初始化脚本
source backend-java/初始化批量分案功能.sql
```

### 问题2：字段不存在

如果报错"Unknown column 'xxx'"，检查表结构：

```sql
-- 检查collectors表结构
DESC collectors;

-- 检查collection_agencies表结构
DESC collection_agencies;

-- 检查collection_teams表结构
DESC collection_teams;

-- 检查case_queues表结构
DESC case_queues;
```

### 问题3：Mapper XML路径问题

确认XML文件路径正确：
- 文件位置：`backend-java/src/main/resources/mapper/CollectorMapper.xml`
- 配置位置：`application.yml`中的`mybatis-plus.mapper-locations: classpath*:mapper/**/*.xml`

## 验证SQL查询

可以手动执行SQL验证查询是否正确：

```sql
SELECT 
    c.id,
    c.collector_name AS collectorName,
    c.collector_code AS collectorCode,
    c.agency_id AS agencyId,
    ca.agency_name AS agencyName,
    c.team_id AS teamId,
    ct.team_name AS teamName,
    ct.queue_id AS queueId,
    cq.queue_name AS queueName,
    c.status,
    COALESCE(
        (SELECT COUNT(*) 
         FROM cases cs 
         WHERE cs.collector_id = c.id 
           AND cs.case_status NOT IN ('normal_settlement', 'extension_settlement')
           AND cs.assigned_at IS NOT NULL
           AND DATE(cs.assigned_at) = CURDATE()
        ), 0
    ) AS currentCaseCount
FROM collectors c
LEFT JOIN collection_agencies ca ON c.agency_id = ca.id
LEFT JOIN collection_teams ct ON c.team_id = ct.id
LEFT JOIN case_queues cq ON ct.queue_id = cq.id
WHERE c.is_active = 1
  AND c.status = 'active'
ORDER BY c.id ASC
LIMIT 10;
```

## 相关文件

- `backend-java/src/main/java/com/cco/common/config/MapperConfig.java` - Mapper注册配置
- `backend-java/src/main/java/com/cco/mapper/CollectorMapper.java` - CollectorMapper接口
- `backend-java/src/main/resources/mapper/CollectorMapper.xml` - CollectorMapper SQL映射
- `backend-java/src/main/java/com/cco/mapper/CaseAssignmentMapper.java` - CaseAssignmentMapper接口
- `backend-java/src/main/resources/mapper/CaseAssignmentMapper.xml` - CaseAssignmentMapper SQL映射

---

**修复时间：** 2025-11-27  
**状态：** ✅ 已修复


























