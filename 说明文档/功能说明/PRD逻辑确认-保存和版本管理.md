# PRD逻辑确认 - 保存和版本管理

## 📋 确认概述

**确认日期**：2024-12-08  
**PRD文档**：`PRD需求文档/CCO管理控台/字段管理/3-案件列表字段映射配置-PRD.md`  
**确认内容**：核心业务逻辑 - 保存条件和版本生成

---

## ✅ 核心逻辑确认

### 核心规则1：只有所有字段都映射完成后才能保存

**明确要求**：
> ⚠️ **只有所有标准字段都映射完成后，才能保存配置**

**PRD中的体现位置**：

#### 1. 第3.6.2节 - 保存条件检查

```markdown
**核心规则**：
> ⚠️ **只有所有标准字段都映射完成后，才能保存配置**  
> ✅ **保存成功后，系统自动生成新的配置版本号**

**严格的保存条件**（三个条件必须同时满足）：

1. ✅ **映射完成度 = 100%**（强制要求）
   - ❌ **不允许部分保存**：不能保存 10/15 或 14/15 的状态
   - ✅ **必须全部映射**：所有15个标准字段都必须映射到甲方字段
   - 🔒 **保存按钮控制**：未完成映射时，保存按钮强制禁用
   - 💡 **提示信息**：缺少映射时显示"请先完成所有标准字段的映射"
```

**强调点**：
- ❌ 不允许部分保存
- ✅ 必须全部映射（15/15）
- 🔒 保存按钮强制禁用

#### 2. 第5.1.6节 - 保存映射配置API业务规则

```markdown
**业务规则**：

**核心规则**：
> ⚠️ **只有所有标准字段都映射完成后，才允许保存**  
> ✅ **保存成功后，系统自动生成新的配置版本号**

**详细规则**：
1. **保存前验证**（必须满足，否则返回400错误）
   - ✅ 映射完成度必须 = 100%（mapped_count === total_count）
   - ✅ 所有15个标准字段都必须有映射关系
   - ❌ 不允许部分保存（如10/15、14/15都不允许）
```

**技术实现**：
- 前端：映射完成度 < 100% 时，保存按钮禁用
- 后端：接口验证 `mapped_count === total_count`，不满足返回400错误

#### 3. 错误响应设计

```json
{
  "code": 400,
  "message": "映射未完成，无法保存配置",
  "data": {
    "mapped_count": 12,
    "total_count": 15,
    "completion_rate": 80,
    "missing_fields": [
      {
        "field_key": "case_status",
        "field_name": "案件状态",
        "is_required": true
      }
    ],
    "error_type": "INCOMPLETE_MAPPING",
    "error_hint": "必须完成所有15个标准字段的映射后才能保存"
  }
}
```

**错误提示**：
- 明确告知缺少哪些字段
- 显示当前完成度（12/15）
- 给出明确的操作提示

---

### 核心规则2：保存后自动生成版本号

**明确要求**：
> ✅ **保存成功后，系统自动生成新的配置版本号**

**PRD中的体现位置**：

#### 1. 第3.6.3节 - 保存操作流程

```markdown
6. 保存成功后，系统自动完成以下操作：
   a) **自动生成新版本号**
      - 首次保存 → v1
      - 第二次保存 → v2
      - 第N次保存 → vN
      - 版本号由系统自动递增，不可手动指定
   
   b) **设置版本状态**
      - 新版本设为"生效中"（is_active = true）
      - 原生效版本改为"历史版本"（is_active = false）
   
   c) **更新页面显示**
      - 显示成功消息："配置保存成功！已生成版本 vN"
      - 更新"当前生效的映射配置版本"卡片
      - 清除"未保存修改"标记
      - 配置立即在线上生效
```

**版本生成示例**：

```
第1次保存配置
  ↓
生成版本 v1（生效中）
保存时间：2024-12-04 10:00:00
映射完成度：15/15

修改配置后，第2次保存
  ↓
生成版本 v2（生效中）
保存时间：2024-12-05 14:20:00
映射完成度：15/15
同时：v1 变为历史版本

再次修改后，第3次保存
  ↓
生成版本 v3（生效中）
保存时间：2024-12-06 16:30:00
映射完成度：15/15
同时：v2 变为历史版本
```

#### 2. 第5.1.6节 - API业务规则

```markdown
2. **版本号自动生成**（不可手动指定）
   - 首次保存 → 版本号 = 1
   - 后续保存 → 版本号 = 当前最大版本号 + 1
   - 版本号只增不减，不可跳号
   
3. **版本状态自动管理**
   - 新保存的版本 → 立即设为"生效中"（is_active = true）
   - 原生效版本 → 自动改为"历史版本"（is_active = false）
   - 同一甲方同一场景，只有1个生效版本
```

**自动化操作**：
- ✅ 版本号自动递增
- ✅ 版本状态自动管理
- ✅ 配置立即生效
- ❌ 不可手动指定版本号

#### 3. API响应数据

```json
{
  "code": 200,
  "message": "保存成功",
  "data": {
    "version": 5,                    // 自动生成的版本号
    "created_at": "2024-12-08T15:30:45Z",
    "created_by": 123,
    "created_by_name": "管理员",
    "mapped_count": 15,
    "total_count": 15,
    "completion_rate": 100,
    "is_active": true                // 自动设为生效版本
  }
}
```

---

## 📊 逻辑流程图

### 完整的保存流程

```
用户完成字段映射
    ↓
检查：映射完成度 = 15/15 ？
    ├─ NO → 保存按钮禁用，显示提示
    │        "还有N个字段未映射"
    │        ❌ 无法保存
    │
    └─ YES → 保存按钮可用
             ↓
        用户点击"保存"
             ↓
        显示确认对话框
        "即将保存当前映射配置，共映射 15 个标准字段。
         保存后将生成新版本并在线上生效。"
             ↓
        用户确认
             ↓
        调用API：POST /api/v1/field-mapping/save
             ↓
        后端验证：
        - mapped_count === total_count ？
        - 所有15个字段都有映射 ？
             ├─ NO → 返回400错误
             │        {
             │          "message": "映射未完成",
             │          "missing_fields": [...]
             │        }
             │
             └─ YES → 执行保存
                      ├─ 计算新版本号 = max(version) + 1
                      ├─ 保存映射配置数据
                      ├─ 设置新版本为生效版本 (is_active = true)
                      ├─ 旧版本改为历史版本 (is_active = false)
                      └─ 记录操作日志
                      ↓
                返回成功响应
                {
                  "version": N,
                  "is_active": true
                }
                      ↓
                前端更新显示
                - 显示成功消息："配置保存成功！已生成版本 vN"
                - 更新版本卡片
                - 清除"未保存修改"标记
                      ↓
                配置立即在线上生效
```

---

## 🎯 强化要点总结

### 1. 保存条件的严格性

**表述强化**：

| 位置 | 原表述 | 强化后表述 |
|------|--------|-----------|
| 3.6.2节 | 映射完成度 = 100% | ❌ 不允许部分保存 + ✅ 必须全部映射 |
| 5.1.6节 | 必须所有标准字段都已映射 | 详细规则列表，包含前端/后端验证 |
| 错误响应 | 简单错误消息 | 详细的错误信息，包含缺失字段列表 |

**示例场景**：

```
场景：部分映射（12/15）
├─ 前端表现
│   ├─ 状态标签：[映射进行中]（橙色）
│   ├─ 进度显示：已映射 12/15 个标准字段
│   ├─ 保存按钮：禁用（灰色）
│   └─ 鼠标悬停提示："还有3个字段未映射"
│
└─ 如果用户绕过前端限制直接调用API
    └─ 后端返回：400错误 + 缺失字段列表
```

### 2. 版本生成的自动化

**表述强化**：

| 位置 | 原表述 | 强化后表述 |
|------|--------|-----------|
| 3.6.3节 | 生成新版本号 | 详细的版本生成示例（v1→v2→v3） |
| 5.1.6节 | 自动生成版本号 | 6步详细流程：生成、设置、更新、生效 |
| API响应 | 返回version字段 | 返回完整版本信息（版本号、状态、时间） |

**版本状态变化**：

```
操作前：
v1（生效中）← 当前使用
v2（历史版本）
v3（历史版本）
    ↓
用户保存新配置
    ↓
操作后：
v1（历史版本）
v2（历史版本）
v3（历史版本）
v4（生效中）← 新生成，自动生效
```

---

## 📝 PRD更新位置清单

已强化的章节：

- [x] **3.6.2 保存条件检查**
  - 添加核心规则强调框
  - 添加示例场景说明
  - 强调不允许部分保存

- [x] **3.6.3 保存操作流程**
  - 详细说明版本生成过程
  - 添加版本生成示例
  - 说明版本状态变化

- [x] **5.1.6 保存映射配置API**
  - 强化核心规则说明
  - 详细列出6条业务规则
  - 添加多个错误响应示例
  - 添加错误码说明

---

## ✅ 确认结论

### 逻辑确认

1. ✅ **保存条件已明确**：
   - PRD明确要求映射完成度 = 100%
   - 不允许部分保存
   - 前后端双重验证

2. ✅ **版本生成已明确**：
   - 保存成功后自动生成版本号
   - 版本号自动递增，不可手动指定
   - 新版本自动设为生效版本

3. ✅ **错误处理已完善**：
   - 详细的错误响应设计
   - 明确的错误提示
   - 完整的缺失字段信息

### 实现要求

**前端实现**：
- [ ] 映射完成度实时计算
- [ ] 保存按钮根据完成度启用/禁用
- [ ] 显示明确的提示信息
- [ ] 保存成功后更新版本卡片

**后端实现**：
- [ ] 保存前验证映射完成度
- [ ] 自动生成版本号
- [ ] 自动管理版本状态
- [ ] 返回详细的错误信息

**测试验证**：
- [ ] 测试部分映射时无法保存
- [ ] 测试完整映射时可以保存
- [ ] 测试版本号自动递增
- [ ] 测试版本状态自动切换
- [ ] 测试错误响应格式

---

## 🎉 总结

**PRD逻辑已确认并强化**：

1. ✅ **核心规则1**：只有所有字段都映射完成后才能保存
   - 在3处位置明确说明
   - 提供详细的示例场景
   - 设计完善的错误处理

2. ✅ **核心规则2**：保存后自动生成版本号
   - 在2处位置详细说明
   - 提供版本生成示例
   - 说明版本状态管理

3. ✅ **强化效果**：
   - 逻辑更加清晰明确
   - 示例更加丰富
   - 错误处理更加完善
   - 便于开发和测试

**后续工作**：
- 根据PRD实现后端接口
- 前端对接真实API
- 编写测试用例
- 验收测试

---

**确认状态**：✅ 已确认  
**PRD版本**：v1.2.1  
**下次更新**：待定
