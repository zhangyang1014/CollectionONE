# 还款渠道配置功能说明

## 功能概述

还款渠道配置管理功能允许不同的甲方自定义配置多种第三方支付渠道（如印尼、墨西哥、印度、智利、菲律宾等国家的主流支付方式），催员可在IM端为案件请求还款码并跟踪还款状态。

## 主要特性

### 1. 管理控台功能

#### 1.1 渠道配置管理
- **支持多种支付类型**：VA码（虚拟账户）、H5链接、二维码
- **灵活的接口配置**：支持配置第三方API地址、认证方式、入参模板
- **拖拽排序**：可通过拖拽调整渠道显示顺序
- **启用/禁用控制**：随时控制渠道的启用状态

#### 1.2 接口参数配置
支持使用占位符配置接口入参，系统会自动替换为实际值：
- `{loan_id}` - 借款ID
- `{case_id}` - 案件ID
- `{installment_number}` - 期数
- `{amount}` - 还款金额
- `{customer_name}` - 客户姓名
- `{customer_phone}` - 客户手机号
- `{customer_id}` - 客户ID

### 2. 催员IM端功能

#### 2.1 请求还款码
- 选择支付渠道
- 选择还款期数
- 自动填充本期应还金额（可手动调整）
- 一键生成还款码

#### 2.2 还款码展示
根据支付类型不同，展示不同内容：
- **VA码**：显示虚拟账户号，支持复制
- **H5链接**：显示链接，支持复制和打开
- **二维码**：显示二维码图片，支持预览

#### 2.3 还款码管理
- 查看已请求的还款码列表
- 按状态筛选（全部/待支付/已支付/已过期）
- 实时显示有效期倒计时
- 查看详细信息

## 支持的支付渠道

### 印度尼西亚
- **VA码**：BCA VA、Mandiri VA、BNI VA、Permata VA
- **电子钱包**：OVO、DANA、LinkAja、GoPay
- **二维码**：QRIS

### 墨西哥
- **银行转账**：SPEI
- **现金支付**：OXXO Pay
- **电子钱包**：Mercado Pago

### 印度
- **UPI支付**：统一支付接口
- **电子钱包**：Paytm、PhonePe、Google Pay

### 智利
- **银行转账**：Webpay
- **电子钱包**：MACH、Tenpo
- **线下支付**：Servipag

### 菲律宾
- **电子钱包**：GCash、Maya、GrabPay
- **二维码**：QRPH
- **线下支付**：7-Eleven、Bayad Center

## 使用流程

### 管理员配置流程

1. **进入配置页面**
   - 登录管理控台
   - 进入"支付管理" -> "还款渠道配置"

2. **创建新渠道**
   - 点击"新增渠道"按钮
   - 填写基础信息（名称、图标、类型、服务商）
   - 配置接口信息（API地址、认证方式、入参模板）
   - 设置启用状态和排序
   - 保存

3. **管理已有渠道**
   - 编辑：修改渠道配置
   - 启用/禁用：控制渠道可用性
   - 排序：拖拽调整显示顺序
   - 删除：删除不需要的渠道

### 催员使用流程

1. **进入案件详情**
   - 在案件列表中选择案件
   - 进入案件详情页
   - 切换到"还款码"Tab

2. **请求还款码**
   - 点击"请求还款码"按钮
   - 选择支付渠道
   - 选择还款期数（自动填充本期应还金额）
   - 确认或调整还款金额
   - 点击"确认生成"

3. **使用还款码**
   - **VA码**：复制虚拟账户号，发送给客户
   - **H5链接**：复制链接或直接打开，分享给客户
   - **二维码**：保存或分享二维码图片给客户

4. **查看还款码**
   - 在"还款码"Tab查看所有已请求的还款码
   - 筛选不同状态的还款码
   - 查看详情和有效期

## 数据库设计

### payment_channels 表
存储还款渠道配置信息

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键ID |
| party_id | BIGINT | 甲方ID |
| channel_name | VARCHAR(100) | 支付名称 |
| channel_icon | VARCHAR(500) | 图标URL |
| channel_type | ENUM | 支付类型：VA/H5/QR |
| service_provider | VARCHAR(100) | 服务公司 |
| api_url | VARCHAR(500) | API地址 |
| auth_type | ENUM | 认证方式 |
| auth_config | JSON | 认证配置（加密） |
| request_params | JSON | 接口入参模板 |
| is_enabled | TINYINT(1) | 是否启用 |
| sort_order | INT | 排序权重 |

### payment_codes 表
存储还款码记录

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键ID |
| code_no | VARCHAR(100) | 还款码编号 |
| case_id | BIGINT | 案件ID |
| loan_id | BIGINT | 借款ID |
| collector_id | BIGINT | 催员ID |
| installment_number | INT | 期数 |
| amount | DECIMAL(15,2) | 还款金额 |
| payment_type | ENUM | 支付类型 |
| payment_code | VARCHAR(500) | 支付码内容 |
| status | ENUM | 状态：PENDING/PAID/EXPIRED |
| expired_at | TIMESTAMP | 过期时间 |
| paid_at | TIMESTAMP | 支付时间 |

## API接口

### 管理控台API

#### 1. 获取渠道列表
```
GET /api/admin/payment-channels
参数：party_id, is_enabled, page, page_size
```

#### 2. 创建渠道
```
POST /api/admin/payment-channels
```

#### 3. 更新渠道
```
PUT /api/admin/payment-channels/{id}
```

#### 4. 删除渠道
```
DELETE /api/admin/payment-channels/{id}
```

#### 5. 切换启用状态
```
POST /api/admin/payment-channels/{id}/toggle
```

#### 6. 更新排序
```
POST /api/admin/payment-channels/sort
```

### 催员IM端API

#### 1. 获取可用渠道
```
GET /api/im/payment-channels
参数：party_id
```

#### 2. 获取期数信息
```
GET /api/im/cases/{case_id}/installments
```

#### 3. 请求还款码
```
POST /api/im/payment-codes/request
```

#### 4. 查询还款码列表
```
GET /api/im/payment-codes
参数：case_id, status, page, page_size
```

#### 5. 查询还款码详情
```
GET /api/im/payment-codes/{code_no}
```

## 安全性说明

1. **密钥加密存储**
   - auth_config字段中的敏感信息会被加密存储
   - 仅授权人员可查看

2. **接口调用安全**
   - 所有第三方接口调用都通过后端代理
   - 记录所有调用日志
   - 设置超时限制

3. **权限控制**
   - 催员只能为自己负责的案件请求还款码
   - 催员只能查看自己请求的还款码

## 注意事项

1. **有效期管理**
   - 还款码的有效期由第三方接口返回，不在配置时定义
   - 系统会定时检查过期的还款码并更新状态

2. **状态同步**
   - 系统通过Webhook接收第三方支付通知
   - 定时任务主动查询支付状态

3. **配置建议**
   - 建议为每个国家配置多个支付渠道作为备选
   - 定期检查API接口可用性
   - 及时更新认证密钥

4. **用户体验**
   - 合理设置渠道排序，将常用渠道排在前面
   - 为渠道添加清晰的图标和描述
   - 及时处理支付状态变更

## 快速开始

### 1. 初始化数据库
```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend
mysql -u root -p cco_test < migrations/create_payment_channels_and_codes.sql
```

### 2. 配置测试渠道
登录管理控台，创建一个测试渠道进行验证。

### 3. 测试还款码请求
在IM端进入案件详情，测试请求还款码功能。

## 故障排查

### 问题1：无法加载可用渠道
- 检查该甲方是否已配置渠道
- 检查渠道是否已启用
- 查看后端日志

### 问题2：还款码生成失败
- 检查第三方API地址是否正确
- 检查认证配置是否有效
- 检查接口入参格式是否正确
- 查看后端错误日志

### 问题3：支付状态未更新
- 检查Webhook地址配置
- 查看Webhook日志
- 手动触发状态查询

## 技术支持

如有问题，请查看：
- 后端日志：`/Users/zhangyang/Documents/GitHub/CollectionONE/backend/backend.log`
- 前端日志：浏览器控制台
- 数据库日志：MySQL错误日志

## 版本历史

### v1.0.0 (2025-11-21)
- 初始版本
- 支持VA码、H5链接、二维码三种支付类型
- 支持期数选择和金额自动填充
- 支持还款码状态管理
- 支持有效期倒计时显示

