# å‚¬å‘˜ç™»å½•ç™½åå•IPç®¡ç†åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å‚¬å‘˜ç™»å½•ç™½åå•IPç®¡ç†åŠŸèƒ½ç”¨äºæ§åˆ¶å‚¬å‘˜ç™»å½•æ—¶çš„IPåœ°å€è®¿é—®æƒé™ã€‚ç®¡ç†å‘˜å¯ä»¥ä¸ºæ¯ä¸ªç”²æ–¹é…ç½®ç™½åå•IPåœ°å€ï¼Œåªæœ‰ç™½åå•ä¸­çš„IPåœ°å€æ‰èƒ½ç™»å½•ï¼Œå…¶ä»–IPåœ°å€å°†è¢«æ‹’ç»ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

1. **æŒ‰ç”²æ–¹ç®¡ç†**ï¼šæ¯ä¸ªç”²æ–¹ç‹¬ç«‹é…ç½®ç™½åå•IP
2. **å¼€å…³æ§åˆ¶**ï¼šå¯ä»¥å¯ç”¨/ç¦ç”¨ç™½åå•IPç™»å½•ç®¡ç†
3. **çµæ´»é…ç½®**ï¼šæ”¯æŒå•ä¸ªIPåœ°å€å’ŒCIDRç½‘æ®µæ ¼å¼
4. **å®æ—¶ç”Ÿæ•ˆ**ï¼šé…ç½®åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### collector_login_whitelist è¡¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | BIGINT | ä¸»é”®ID |
| tenant_id | BIGINT | æ‰€å±ç”²æ–¹ID |
| is_enabled | TINYINT(1) | æ˜¯å¦å¯ç”¨ç™½åå•IPç™»å½•ç®¡ç†ï¼ˆ0-å¦ï¼Œ1-æ˜¯ï¼‰ |
| ip_address | VARCHAR(50) | ç™½åå•IPåœ°å€ï¼ˆæ”¯æŒIPv4å’ŒCIDRæ ¼å¼ï¼‰ |
| description | VARCHAR(200) | IPåœ°å€æè¿°/å¤‡æ³¨ |
| is_active | TINYINT(1) | æ˜¯å¦å¯ç”¨ï¼ˆ0-å¦ï¼Œ1-æ˜¯ï¼‰ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_tenant_ip` (`tenant_id`, `ip_address`)
- KEY: `idx_tenant_id` (`tenant_id`)
- KEY: `idx_is_enabled` (`is_enabled`)
- KEY: `idx_is_active` (`is_active`)

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åˆ›å»ºæ•°æ®åº“è¡¨

æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼š

```bash
cd backend-java
chmod +x create_collector_login_whitelist_table.sh
./create_collector_login_whitelist_table.sh
```

æˆ–è€…æ‰‹åŠ¨æ‰§è¡ŒSQLï¼š

```bash
mysql -u root -p cco_system < src/main/resources/db/migration/create_collector_login_whitelist_table.sql
```

### 2. é‡å¯åç«¯æœåŠ¡

```bash
cd backend-java
./start.sh
```

### 3. å‰ç«¯è®¿é—®

è®¿é—®è·¯å¾„ï¼š`/tenants/collector-login-whitelist`

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. å¯ç”¨ç™½åå•IPç™»å½•ç®¡ç†

1. è¿›å…¥"å‚¬å‘˜ç™»å½•ç™½åå•IPç®¡ç†"é¡µé¢
2. ç‚¹å‡»å³ä¸Šè§’çš„"å¯ç”¨ç™½åå•"å¼€å…³
3. ç³»ç»Ÿä¼šæç¤º"ç™½åå•IPç™»å½•ç®¡ç†å·²å¯ç”¨"

### 2. æ·»åŠ ç™½åå•IPåœ°å€

1. ç‚¹å‡»"æ·»åŠ IPåœ°å€"æŒ‰é’®
2. å¡«å†™IPåœ°å€ï¼ˆæ”¯æŒæ ¼å¼ï¼‰ï¼š
   - å•ä¸ªIPï¼š`192.168.1.1`
   - CIDRç½‘æ®µï¼š`192.168.1.0/24`
3. å¡«å†™æè¿°/å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
4. é€‰æ‹©æ˜¯å¦å¯ç”¨
5. ç‚¹å‡»"ç¡®å®š"ä¿å­˜

### 3. ç¼–è¾‘ç™½åå•IPåœ°å€

1. åœ¨åˆ—è¡¨ä¸­ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
2. ä¿®æ”¹IPåœ°å€ã€æè¿°æˆ–å¯ç”¨çŠ¶æ€
3. ç‚¹å‡»"ç¡®å®š"ä¿å­˜

### 4. åˆ é™¤ç™½åå•IPåœ°å€

1. åœ¨åˆ—è¡¨ä¸­ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
2. ç¡®è®¤åˆ é™¤æ“ä½œ

### 5. ç¦ç”¨ç™½åå•IPç™»å½•ç®¡ç†

1. ç‚¹å‡»å³ä¸Šè§’çš„"ç¦ç”¨ç™½åå•"å¼€å…³
2. ç³»ç»Ÿä¼šæç¤º"ç™½åå•IPç™»å½•ç®¡ç†å·²ç¦ç”¨"
3. ç¦ç”¨åï¼Œæ‰€æœ‰IPåœ°å€éƒ½å¯ä»¥ç™»å½•

## ğŸ”’ å®‰å…¨æœºåˆ¶

### IPç™½åå•æ£€æŸ¥æµç¨‹

1. å‚¬å‘˜ç™»å½•æ—¶ï¼Œç³»ç»Ÿè·å–å®¢æˆ·ç«¯IPåœ°å€
2. æ£€æŸ¥è¯¥ç”²æ–¹æ˜¯å¦å¯ç”¨äº†ç™½åå•IPç™»å½•ç®¡ç†
3. å¦‚æœæœªå¯ç”¨ï¼Œå…è®¸æ‰€æœ‰IPç™»å½•
4. å¦‚æœå·²å¯ç”¨ï¼š
   - æ£€æŸ¥IPæ˜¯å¦åœ¨ç™½åå•ä¸­
   - å¦‚æœåœ¨ç™½åå•ä¸­ï¼Œå…è®¸ç™»å½•
   - å¦‚æœä¸åœ¨ç™½åå•ä¸­ï¼Œè¿”å›403é”™è¯¯ï¼š"Access denied: Login from this IP address is not allowed."

### IPåœ°å€è·å–

ç³»ç»Ÿä¼šæŒ‰ä»¥ä¸‹é¡ºåºè·å–å®¢æˆ·ç«¯çœŸå®IPåœ°å€ï¼š

1. `X-Forwarded-For` è¯·æ±‚å¤´
2. `X-Real-IP` è¯·æ±‚å¤´
3. `Proxy-Client-IP` è¯·æ±‚å¤´
4. `WL-Proxy-Client-IP` è¯·æ±‚å¤´
5. `HTTP_CLIENT_IP` è¯·æ±‚å¤´
6. `HTTP_X_FORWARDED_FOR` è¯·æ±‚å¤´
7. `request.getRemoteAddr()` æ–¹æ³•

### CIDRç½‘æ®µåŒ¹é…

ç³»ç»Ÿæ”¯æŒCIDRæ ¼å¼çš„ç½‘æ®µåŒ¹é…ï¼Œä¾‹å¦‚ï¼š
- `192.168.1.0/24` åŒ¹é… `192.168.1.1` åˆ° `192.168.1.254`
- `10.0.0.0/8` åŒ¹é… `10.0.0.0` åˆ° `10.255.255.255`

## ğŸ“¡ APIæ¥å£

### 1. è·å–ç™½åå•IPé…ç½®åˆ—è¡¨

```
GET /api/v1/collector-login-whitelist?tenant_id=1
```

### 2. åˆ›å»ºç™½åå•IPé…ç½®

```
POST /api/v1/collector-login-whitelist
Content-Type: application/json

{
  "tenantId": 1,
  "ipAddress": "192.168.1.1",
  "description": "åŠå…¬å®¤IP",
  "isActive": true,
  "isEnabled": false
}
```

### 3. æ›´æ–°ç™½åå•IPé…ç½®

```
PUT /api/v1/collector-login-whitelist/{id}
Content-Type: application/json

{
  "ipAddress": "192.168.1.1",
  "description": "åŠå…¬å®¤IPï¼ˆæ›´æ–°ï¼‰",
  "isActive": true
}
```

### 4. åˆ é™¤ç™½åå•IPé…ç½®

```
DELETE /api/v1/collector-login-whitelist/{id}
```

### 5. å¯ç”¨/ç¦ç”¨ç™½åå•IPç™»å½•ç®¡ç†

```
PUT /api/v1/collector-login-whitelist/enable?tenant_id=1&enabled=true
```

### 6. æ£€æŸ¥ç™½åå•æ˜¯å¦å¯ç”¨

```
GET /api/v1/collector-login-whitelist/check-enabled?tenant_id=1
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¯ç”¨ç™½åå•å**ï¼šåªæœ‰ç™½åå•ä¸­çš„IPåœ°å€å¯ä»¥ç™»å½•ï¼Œå…¶ä»–IPåœ°å€å°†è¢«æ‹’ç»
2. **ç¦ç”¨ç™½åå•å**ï¼šæ‰€æœ‰IPåœ°å€éƒ½å¯ä»¥ç™»å½•ï¼Œä¸å—é™åˆ¶
3. **IPåœ°å€æ ¼å¼**ï¼šå¿…é¡»ç¬¦åˆIPv4æ ¼å¼æˆ–CIDRæ ¼å¼ï¼Œå¦åˆ™ä¼šéªŒè¯å¤±è´¥
4. **é‡å¤IP**ï¼šåŒä¸€ç”²æ–¹ä¸‹ä¸èƒ½æ·»åŠ é‡å¤çš„IPåœ°å€
5. **å®æ—¶ç”Ÿæ•ˆ**ï¼šé…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡

## ğŸ› å¸¸è§é—®é¢˜

### Q1: å¯ç”¨ç™½åå•åï¼Œè‡ªå·±æ— æ³•ç™»å½•ï¼Ÿ

**A:** è¯·æ£€æŸ¥ï¼š
1. å½“å‰IPåœ°å€æ˜¯å¦åœ¨ç™½åå•ä¸­
2. ç™½åå•IPé…ç½®æ˜¯å¦å¯ç”¨ï¼ˆis_active = trueï¼‰
3. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤IPåœ°å€è·å–æ˜¯å¦æ­£ç¡®

### Q2: å¦‚ä½•æŸ¥çœ‹å½“å‰ç™»å½•IPåœ°å€ï¼Ÿ

**A:** æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç™»å½•æ—¶ä¼šè¾“å‡ºï¼š
```
å®¢æˆ·ç«¯IPåœ°å€ï¼š192.168.1.1
```

### Q3: æ”¯æŒIPv6å—ï¼Ÿ

**A:** å½“å‰ç‰ˆæœ¬ä»…æ”¯æŒIPv4æ ¼å¼ï¼ŒIPv6æ”¯æŒå°†åœ¨åç»­ç‰ˆæœ¬ä¸­æä¾›ã€‚

### Q4: å¦‚ä½•æ‰¹é‡æ·»åŠ IPåœ°å€ï¼Ÿ

**A:** å½“å‰ç‰ˆæœ¬éœ€è¦é€ä¸ªæ·»åŠ ï¼Œæ‰¹é‡å¯¼å…¥åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æä¾›ã€‚

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å‚¬å‘˜IMç«¯ç™»å½•åŠŸèƒ½PRD](../PRDéœ€æ±‚æ–‡æ¡£/CCOå‚¬å‘˜IMç«¯/å‚¬å‘˜IMç«¯ç™»å½•åŠŸèƒ½PRD.md)
- [åç«¯APIå¼€å‘è§„èŒƒ](../å¼€å‘è§„èŒƒ/APIæ¥å£å¼€å‘è§„èŒƒ.md)

---

**æœ€åæ›´æ–°**: 2025-01-22  
**ç‰ˆæœ¬**: 1.0.0



