# PRD更新说明 - 保存和版本管理功能

## 📋 更新概述

**更新日期**：2024-12-08  
**PRD文档**：`PRD需求文档/CCO管理控台/字段管理/3-案件列表字段映射配置-PRD.md`  
**更新原因**：基于已实现的保存和版本管理功能，补充完善PRD文档

---

## ✨ 主要更新内容

### 1. 修改第3.6节 - 步骤5：保存映射配置

**原标题**：验证与发布  
**新标题**：保存映射配置

**新增内容**：

#### 3.6.1 页面顶部状态栏
- 映射状态标签设计（未开始/进行中/完成）
- 映射完成度统计（X/15）
- 未保存修改提示
- 保存按钮状态说明

#### 3.6.2 保存条件检查
- 三个严格的保存条件
- 保存按钮状态表
- 按钮文本说明（"保存" vs "保存新版本"）

#### 3.6.3 保存操作流程
- 完整的保存流程图
- 确认对话框设计
- 保存成功后的效果

#### 3.6.4 保存数据结构
- 请求数据格式（JSON）
- 响应数据格式（JSON）
- 字段说明

#### 3.6.5 保存失败处理
- 4种常见失败场景
- 错误提示设计
- 建议操作

#### 3.6.6 配置生效机制
- 生效时机
- 生效范围
- 影响的功能模块

---

### 2. 新增第4.7节 - 映射配置版本管理

**新增章节**：完整的映射配置版本管理说明

#### 4.7.1 两种版本的区别
- 甲方字段版本 vs 映射配置版本
- 对比表格
- 版本关系示例
- 独立性说明

#### 4.7.2 映射配置版本信息
- 版本数据结构（JSON）
- 字段说明

#### 4.7.3 配置版本显示卡片
- 当前生效版本卡片设计
- 甲方字段版本卡片设计
- 卡片显示逻辑

#### 4.7.4 版本管理对话框
- 打开方式
- 对话框结构设计
- 版本列表字段说明

#### 4.7.5 查看版本详情
- 操作入口
- 详情对话框设计
- 显示内容

#### 4.7.6 恢复历史版本
- 操作流程图
- 确认对话框设计
- 恢复后的影响表

#### 4.7.7 版本变更追踪
- 未保存修改检测机制
- 触发条件
- 清除条件
- 显示效果

#### 4.7.8 版本审计日志
- 操作类型表
- 日志查询接口

---

### 3. 新增第5.1.6-5.1.9节 - API接口

#### 5.1.6 保存映射配置
```
POST /api/v1/field-mapping/save
```
- 请求数据结构
- 响应数据结构
- 错误响应处理
- 6条业务规则

#### 5.1.7 获取映射配置版本列表
```
GET /api/v1/field-mapping/versions
```
- 分页参数
- 响应数据结构
- 版本列表格式

#### 5.1.8 获取映射配置版本详情
```
GET /api/v1/field-mapping/versions/{version}
```
- 请求参数
- 完整的版本详情数据

#### 5.1.9 恢复历史版本
```
POST /api/v1/field-mapping/restore
```
- 请求数据结构
- 成功响应
- 错误响应（版本不存在）
- 5条业务规则

---

## 📊 更新统计

### 章节更新

| 章节 | 更新类型 | 更新内容 |
|------|---------|---------|
| 3.6 | 重写 | 从"验证与发布"改为"保存映射配置" |
| 4.7 | 新增 | 完整的映射配置版本管理章节 |
| 5.1.6 | 新增 | 保存映射配置API |
| 5.1.7 | 新增 | 获取版本列表API |
| 5.1.8 | 新增 | 获取版本详情API |
| 5.1.9 | 新增 | 恢复版本API |

### 内容统计

| 指标 | 数量 |
|------|------|
| 新增章节 | 8个小节 |
| 新增API接口 | 4个 |
| 新增表格 | 12个 |
| 新增代码示例 | 8个 |
| 新增流程图 | 3个 |
| 总新增字数 | ~4000字 |

---

## 🎯 更新要点

### 1. 明确区分两种版本

**重要澄清**：
- **甲方字段版本**：管理甲方上传的字段数据
- **映射配置版本**：管理字段映射关系配置

**在PRD中的体现**：
- 4.7.1 专门用一个小节说明两种版本的区别
- 4.7.3 设计了两张独立的版本卡片
- 两种版本各自独立管理，互不干扰

### 2. 强调保存条件的严格性

**100%映射要求**：
```
保存条件（三个必须同时满足）：
1. ✅ 映射完成度 = 100% （15/15）
2. ✅ 已选择甲方
3. ✅ 不在保存中
```

**在PRD中的体现**：
- 3.6.2 详细说明保存条件
- 3.6.5 说明未完成映射时的错误提示
- 表格展示不同状态下的按钮状态

### 3. 完整的版本管理流程

**版本管理功能**：
- 查看版本列表
- 查看版本详情
- 恢复历史版本
- 版本审计日志

**在PRD中的体现**：
- 4.7.4 版本管理对话框设计
- 4.7.5 查看版本详情
- 4.7.6 恢复历史版本
- 4.7.8 版本审计日志

### 4. 详细的API接口设计

**4个新增接口**：
1. 保存映射配置（生成新版本）
2. 获取版本列表（分页查询）
3. 获取版本详情（完整配置）
4. 恢复历史版本（版本切换）

**接口设计要点**：
- 完整的请求/响应数据结构
- 错误处理和响应
- 业务规则说明
- 参数验证规则

---

## 📐 设计亮点

### 1. 页面顶部状态栏设计

**实时状态反馈**：
```
[✓ 映射完成] 已映射 15/15 个标准字段  ⚠️ 有未保存的修改
```

**三种状态**：
- 未开始映射（灰色）
- 映射进行中（橙色）
- ✓ 映射完成（绿色）

### 2. 双卡片设计

**并列显示两种版本**：
```
┌─────────────────────────────────┐  ┌─────────────────────────────────┐
│ 当前生效的映射配置版本 [已生效]  │  │ 甲方字段数据版本      [数据源]  │
├─────────────────────────────────┤  ├─────────────────────────────────┤
│ 配置版本: v5                     │  │ 字段版本: v3                    │
│ 保存时间: 2024-12-08 15:30:45   │  │ 上传时间: 2024-12-07 10:20:30  │
│ 映射完成度: 15/15                │  │ 字段数量: 18                    │
│ 保存人: 管理员                   │  │ 上传人: 张三                    │
└─────────────────────────────────┘  └─────────────────────────────────┘
```

**清晰区分**：
- 左侧：映射配置版本（绿色"已生效"标签）
- 右侧：甲方字段版本（蓝色"数据源"标签）

### 3. 版本管理对话框设计

**功能完整**：
- 当前版本提示（顶部高亮）
- 历史版本列表（表格展示）
- 操作按钮（查看详情/恢复版本）
- 刷新按钮（重新加载）

**信息丰富**：
- 版本号（v1, v2, v3...）
- 保存时间
- 映射完成度（15/15）
- 完成率（100%）
- 保存人
- 状态（生效中/历史版本）

---

## 🔄 与现有功能的关联

### 1. 与甲方字段管理的关联

**数据源关系**：
```
甲方字段查看页面
    ↓ 上传JSON文件
甲方字段版本 v3
    ↓ 作为数据源
字段映射配置页面
    ↓ 配置映射关系
映射配置版本 v1, v2, v3...
```

### 2. 与标准字段管理的关联

**映射目标**：
```
标准字段管理
    ↓ 定义15个标准字段
案件列表标准字段
    ↓ 作为映射目标
字段映射配置
```

### 3. 与案件列表的关联

**配置应用**：
```
映射配置保存
    ↓ 配置立即生效
案件列表页面
    ↓ 根据映射关系
显示标准化数据
```

---

## ✅ 更新检查清单

PRD更新完成后，已补充以下内容：

- [x] 保存功能的详细说明
- [x] 保存条件的严格要求
- [x] 保存流程图
- [x] 保存数据结构
- [x] 保存失败处理
- [x] 配置生效机制
- [x] 两种版本的区别说明
- [x] 映射配置版本信息
- [x] 版本卡片设计
- [x] 版本管理对话框
- [x] 查看版本详情
- [x] 恢复历史版本
- [x] 版本变更追踪
- [x] 版本审计日志
- [x] 保存配置API
- [x] 版本列表API
- [x] 版本详情API
- [x] 恢复版本API

---

## 📝 后续待办

### 1. 数据库表设计

需要添加：
- `field_mapping_versions` 表（映射配置版本表）
- 字段：version, tenant_id, scene, created_at, created_by, mapped_count, total_count, is_active, config_data

### 2. 枚举值映射功能

PRD中已提及，但标记为"后续迭代实现"：
- 枚举值映射对话框
- 枚举值对应关系配置
- 枚举值验证

### 3. 版本对比功能

PRD中提及但未详细说明：
- 两个版本的差异对比
- 字段级别的变更展示
- 导出对比报告

---

## 🎉 总结

本次PRD更新全面补充了保存和版本管理功能的设计细节：

**核心价值**：
1. ✅ **明确了两种版本的区别**：避免概念混淆
2. ✅ **详细说明保存流程**：确保实现一致
3. ✅ **完整的版本管理设计**：支持版本追溯和恢复
4. ✅ **清晰的API接口设计**：指导后端开发

**文档质量**：
- 图文并茂，易于理解
- 流程清晰，步骤明确
- 数据结构完整，便于开发
- 业务规则详细，减少歧义

**后续工作**：
- 后端根据API设计实现接口
- 前端对接真实API
- 完善数据库表设计
- 补充测试用例

---

**更新状态**：✅ 已完成  
**PRD版本**：v1.2.0  
**下次更新计划**：添加枚举值映射功能详细设计
