# 甲方默认语言配置功能说明

## 一、功能概述

为甲方管理增加了默认语言配置功能，支持在创建和编辑甲方时选择默认语言。该语言将作为该甲方下所有催员登录IM端时的默认界面语言。

## 二、业务规则

### 2.1 甲方语言配置

- **必填项**：创建甲方时必须选择默认语言
- **数据来源**：从国际化配置管理中的"已启用语言"列表中选择
- **可修改**：甲方创建后可以修改默认语言
- **影响范围**：该甲方下所有催员的默认界面语言

### 2.2 IM端语言应用

- **默认语言**：催员登录IM端时，自动使用所属甲方的默认语言
- **个性化设置**：催员可在个人设置中切换为其他可用语言
- **优先级**：甲方默认语言 < 催员个人设置语言

### 2.3 数据流转

```
甲方管理员创建甲方
    ↓
选择默认语言（如：es-MX 西班牙语-墨西哥）
    ↓
保存到甲方表（tenants.default_language）
    ↓
催员登录IM端
    ↓
后端返回催员信息（包含defaultLanguage字段）
    ↓
IM端应用该语言设置
```

## 三、PRD更新内容

### 3.1 数据字段定义

在 `组织架构管理PRD.md` 中更新了甲方（Tenant）核心字段：

| 字段名 | 类型 | 说明 | 来源 | 更新频率 |
|--------|------|------|------|----------|
| **default_language** | **String(10)** | **默认语言（Locale）** | **从国际化配置中选择** | **可编辑** |

**业务规则**：
- 创建甲方时必须选择默认语言（必填项）
- 该语言将作为该甲方下所有催员的默认界面语言
- 催员登录IM端时，默认使用所属甲方的语言
- 催员可在个人设置中切换为其他可用语言，但优先显示甲方默认语言

### 3.2 数据库表结构

**tenants表**新增字段：

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| **default_language** | **VARCHAR(10)** | **NOT NULL** | **默认语言（Locale，如zh-CN）** |

### 3.3 必填字段更新

甲方必填字段：名称、编码、国家、时区、货币、**默认语言**、管理员密码、管理员确认密码

## 四、前端实现

### 4.1 甲方列表页面

**文件**: `frontend/src/views/tenant-management/TenantList.vue`

**更新内容**：

1. **列表展示**：新增"默认语言"列
   - 显示语言图标 + 名称（如：🇨🇳 简体中文）
   - 未设置时显示"未设置"

2. **创建/编辑表单**：新增"默认语言"选择器
   - 必填项，带红色星号标识
   - 下拉选择，显示国旗图标 + 语言名称 + Locale
   - 推荐语言带"推荐"标签
   - 支持搜索过滤

3. **语言列表数据来源**：
   - 调用 `getEnabledLanguages()` API获取已启用的语言列表
   - 失败时提供默认语言选项（zh-CN, en-US）

### 4.2 API调用

```typescript
import { getEnabledLanguages } from '@/api/i18n'

// 加载可用语言列表
const loadAvailableLanguages = async () => {
  try {
    const response = await getEnabledLanguages()
    availableLanguages.value = Array.isArray(response) ? response : (response.data || [])
  } catch (error) {
    // 提供默认语言选项
    availableLanguages.value = [
      { locale: 'zh-CN', name: '简体中文', flagIcon: '🇨🇳', isDefault: true },
      { locale: 'en-US', name: 'English', flagIcon: '🇺🇸', isDefault: false }
    ]
  }
}
```

### 4.3 表单验证

```typescript
default_language: [
  { required: true, message: '请选择默认语言', trigger: 'change' }
]
```

## 五、后端实现

### 5.1 Tenant实体类更新

**文件**: `backend-java/src/main/java/com/cco/model/entity/Tenant.java`

```java
/**
 * 默认语言（Locale，如zh-CN, en-US）
 * 该语言将作为该甲方下所有催员的默认界面语言
 */
private String defaultLanguage;
```

### 5.2 TenantController更新

**文件**: `backend-java/src/main/java/com/cco/controller/TenantController.java`

**创建甲方**：
```java
tenant.setDefaultLanguage((String) (request.get("default_language") != null ? 
    request.get("default_language") : request.get("defaultLanguage")));
```

**更新甲方**：
```java
if (request.containsKey("default_language") || request.containsKey("defaultLanguage")) {
    tenant.setDefaultLanguage((String) (request.get("default_language") != null ? 
        request.get("default_language") : request.get("defaultLanguage")));
}
```

### 5.3 IM端登录返回语言信息

**文件**: `backend-java/src/main/java/com/cco/controller/ImAuthController.java`

**登录响应增强**：
```java
// ✅ 添加甲方默认语言，IM端将使用此语言作为界面默认语言
userInfo.put("defaultLanguage", mockCollector.get("defaultLanguage"));
```

**Mock数据示例**：
```java
// 百腾企业 - 西班牙语（墨西哥）
collector.put("defaultLanguage", "es-MX");

// BTSK机构 - 简体中文
collector.put("defaultLanguage", "zh-CN");

// 默认 - 简体中文
collector.put("defaultLanguage", "zh-CN");
```

## 六、IM端应用说明

### 6.1 登录响应结构

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "collectorId": "BTQ001",
      "collectorName": "Carlos Méndez",
      "tenantId": "1",
      "tenantName": "百腾企业",
      "defaultLanguage": "es-MX",
      "role": "collector",
      ...
    }
  }
}
```

### 6.2 IM端语言应用逻辑

1. **登录时**：
   - 从登录响应中获取 `user.defaultLanguage`
   - 检查本地存储是否有用户个人语言设置
   - 如果有个人设置，使用个人设置；否则使用 `defaultLanguage`

2. **语言切换**：
   - 用户可在个人设置中切换语言
   - 切换后的语言保存到本地存储
   - 下次登录优先使用个人设置

3. **优先级**：
   ```
   用户个人语言设置 > 甲方默认语言 > 系统默认语言（zh-CN）
   ```

### 6.3 示例代码（IM端）

```typescript
// 登录成功后
const onLoginSuccess = (response: any) => {
  const user = response.data.user
  
  // 获取用户个人语言设置
  const personalLanguage = localStorage.getItem('user_language')
  
  // 确定最终使用的语言
  const finalLanguage = personalLanguage || user.defaultLanguage || 'zh-CN'
  
  // 应用语言设置
  i18n.global.locale = finalLanguage
  
  // 保存用户信息
  userStore.setUser(user)
}

// 语言切换
const changeLanguage = (locale: string) => {
  // 保存到本地存储
  localStorage.setItem('user_language', locale)
  
  // 应用语言
  i18n.global.locale = locale
  
  // 可选：同步到服务器
  updateUserPreference({ language: locale })
}
```

## 七、数据库迁移

### 7.1 迁移SQL

```sql
-- 添加default_language字段
ALTER TABLE tenants ADD COLUMN default_language VARCHAR(10) COMMENT '默认语言（Locale）';

-- 设置默认值（可选，根据实际情况调整）
UPDATE tenants SET default_language = 'zh-CN' WHERE default_language IS NULL;

-- 如果需要设置为NOT NULL（建议）
-- ALTER TABLE tenants MODIFY COLUMN default_language VARCHAR(10) NOT NULL COMMENT '默认语言（Locale）';
```

### 7.2 迁移注意事项

1. **数据兼容性**：现有甲方数据需要补充默认语言
2. **默认值选择**：建议根据甲方的国家代码设置合理的默认语言
3. **NOT NULL约束**：新字段建议设置为NOT NULL，确保数据完整性

## 八、测试要点

### 8.1 控台端测试

1. **创建甲方**：
   - [ ] 默认语言为必填项
   - [ ] 可以正确选择语言
   - [ ] 语言下拉列表正确显示图标和名称
   - [ ] 保存后语言信息正确

2. **编辑甲方**：
   - [ ] 可以修改默认语言
   - [ ] 修改后正确保存

3. **列表展示**：
   - [ ] 默认语言列正确显示
   - [ ] 显示格式：图标 + 名称

### 8.2 IM端测试

1. **登录测试**：
   - [ ] 催员登录成功后返回defaultLanguage字段
   - [ ] 不同甲方的催员返回不同的defaultLanguage

2. **语言应用测试**：
   - [ ] 首次登录使用甲方默认语言
   - [ ] 切换语言后下次登录使用个人设置
   - [ ] 清除个人设置后恢复为甲方默认语言

### 8.3 数据完整性测试

1. **必填验证**：
   - [ ] 创建甲方时未选择语言提示错误
   
2. **数据持久化**：
   - [ ] 语言信息正确保存到数据库
   - [ ] 重启服务后数据不丢失

## 九、Mock数据说明

### 9.1 已配置的Mock数据

| 催员ID | 甲方 | 默认语言 | 说明 |
|--------|------|----------|------|
| BTQ001 | 百腾企业 | es-MX | 西班牙语（墨西哥） |
| BTSK001 | BTSK机构 | zh-CN | 简体中文 |
| 其他 | 测试机构 | zh-CN | 简体中文 |

### 9.2 Mock数据位置

- **文件**: `backend-java/src/main/java/com/cco/controller/ImAuthController.java`
- **方法**: `getMockCollector(String collectorId)`

## 十、未来扩展

### 10.1 个人语言偏好设置

- 催员可在个人设置中永久修改语言偏好
- 语言偏好保存到数据库（collectors表新增preferred_language字段）
- 优先级：个人语言偏好 > 甲方默认语言

### 10.2 语言包管理

- 与国际化配置管理模块集成
- 支持动态加载语言包
- 支持语言包版本管理

### 10.3 多语言内容管理

- 甲方级别的多语言内容配置
- 催员工作台的多语言内容展示
- 案件备注的多语言支持

## 十一、相关文档

- [组织架构管理PRD](../../PRD需求文档/CCO管理控台/控台端：账号管理/组织架构管理PRD.md)
- [多语言配置管理PRD](../../PRD需求文档/CCO管理控台/多语言配置管理PRD.md)
- [多语言配置管理功能说明](./多语言配置管理功能说明.md)

## 十二、版本历史

| 版本 | 日期 | 作者 | 说明 |
|------|------|------|------|
| v1.0 | 2025-12-04 | CCO Team | 初始版本 |

---

**文档状态**：✅ 已完成  
**最后更新**：2025-12-04  
**审核状态**：待审核

