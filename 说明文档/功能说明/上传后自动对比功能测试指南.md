# 上传后自动对比功能测试指南

## 🎯 功能概述

"上传后显示与上一版本的对比"功能已完成开发，本文档将指导您测试该功能。

## 📋 前置条件

### 1. 确保Mock数据已导入

```bash
cd /Users/zhangyang/Documents/GitHub/CollectionONE/backend-java
./import-mock-versions.sh
```

验证数据：
```bash
mysql -u root -p cco_db -e "SELECT version, fields_count, uploaded_by_name, is_active FROM tenant_field_uploads WHERE tenant_id = '1' AND scene = 'list' ORDER BY version DESC;"
```

应该看到7个版本，版本7为当前使用版本。

### 2. 启动服务

**后端服务**：
```bash
cd backend-java
./start.sh
```

**前端服务**：
```bash
cd frontend
npm run dev
```

## 🧪 测试步骤

### 测试1：基本功能测试

#### 步骤1：访问页面
1. 打开浏览器访问 `http://localhost:5173`
2. 登录系统
3. 进入"字段管理" → "案件列表甲方字段查看"

#### 步骤2：打开上传弹窗
1. 点击页面右上角"上传JSON文件"按钮
2. 应该看到上传弹窗

#### 步骤3：查看上传选项
在上传弹窗底部，应该看到三个选项：
- ☑ 上传前验证JSON格式（默认勾选，禁用状态）
- ☑ 上传成功后自动设为当前使用版本（默认勾选）
- ☐ 上传后显示与上一版本的对比（默认不勾选）

#### 步骤4：准备测试文件

创建测试JSON文件 `test_upload_v8.json`：

```json
{
  "version": "1.0",
  "scene": "list",
  "tenant_id": "1",
  "tenant_name": "测试甲方公司",
  "updated_at": "2025-12-08T12:00:00",
  "description": "案件列表字段配置",
  "fields": [
    {
      "field_name": "案件编号",
      "field_key": "case_id",
      "field_type": "String",
      "enum_values": null,
      "is_required": true,
      "sort_order": 1,
      "description": "案件唯一标识"
    },
    {
      "field_name": "案件状态",
      "field_key": "case_status",
      "field_type": "Enum",
      "enum_values": ["待分配", "催收中", "已完成", "已关闭"],
      "is_required": true,
      "sort_order": 2,
      "description": "案件当前状态"
    },
    {
      "field_name": "风险等级",
      "field_key": "risk_level",
      "field_type": "Enum",
      "enum_values": ["低风险", "中风险", "高风险"],
      "is_required": false,
      "sort_order": 3,
      "description": "案件风险评级"
    },
    {
      "field_name": "借款金额",
      "field_key": "loan_amount",
      "field_type": "Number",
      "enum_values": null,
      "is_required": true,
      "sort_order": 4,
      "description": "借款本金，单位：元"
    },
    {
      "field_name": "借款人姓名",
      "field_key": "borrower_name",
      "field_type": "String",
      "enum_values": null,
      "is_required": true,
      "sort_order": 5,
      "description": "借款人真实姓名"
    },
    {
      "field_name": "紧急联系人",
      "field_key": "emergency_contact",
      "field_type": "String",
      "enum_values": null,
      "is_required": false,
      "sort_order": 6,
      "description": "紧急联系人姓名【新增字段】"
    }
  ]
}
```

#### 步骤5：上传文件（不勾选对比）

1. 拖拽或选择上传文件 `test_upload_v8.json`
2. **不勾选**"上传后显示与上一版本的对比"
3. 点击"确认上传"
4. 观察结果：
   - ✅ 应该显示："成功上传版本8，共 6 个字段"
   - ✅ 上传弹窗自动关闭
   - ✅ 页面刷新显示新版本数据
   - ❌ **不应该**弹出对比窗口

### 测试2：自动对比功能测试

#### 步骤1：准备新版本文件

创建 `test_upload_v9.json`（在v8基础上修改）：

```json
{
  "version": "1.0",
  "scene": "list",
  "tenant_id": "1",
  "tenant_name": "测试甲方公司",
  "updated_at": "2025-12-08T12:30:00",
  "description": "案件列表字段配置",
  "fields": [
    {
      "field_name": "案件编号",
      "field_key": "case_id",
      "field_type": "String",
      "enum_values": null,
      "is_required": true,
      "sort_order": 1,
      "description": "案件唯一标识"
    },
    {
      "field_name": "案件状态",
      "field_key": "case_status",
      "field_type": "Enum",
      "enum_values": ["待分配", "催收中", "已完成", "已关闭", "失败"],
      "is_required": true,
      "sort_order": 2,
      "description": "案件当前状态（新增失败状态）"
    },
    {
      "field_name": "风险等级",
      "field_key": "risk_level",
      "field_type": "Enum",
      "enum_values": ["低风险", "中风险", "高风险", "极高风险"],
      "is_required": true,
      "sort_order": 3,
      "description": "案件风险评级（修改为必填）"
    },
    {
      "field_name": "借款金额",
      "field_key": "loan_amount",
      "field_type": "Number",
      "enum_values": null,
      "is_required": true,
      "sort_order": 4,
      "description": "借款本金，单位：元"
    },
    {
      "field_name": "借款人姓名",
      "field_key": "borrower_name",
      "field_type": "String",
      "enum_values": null,
      "is_required": true,
      "sort_order": 5,
      "description": "借款人真实姓名"
    },
    {
      "field_name": "还款计划",
      "field_key": "repayment_plan",
      "field_type": "String",
      "enum_values": null,
      "is_required": false,
      "sort_order": 7,
      "description": "还款计划说明【新增字段】"
    }
  ]
}
```

注意变更：
- 删除了"紧急联系人"字段
- 新增了"还款计划"字段
- 修改了"案件状态"枚举值（新增"失败"）
- 修改了"风险等级"枚举值（新增"极高风险"）并改为必填

#### 步骤2：执行上传并对比

1. 点击"上传JSON文件"按钮
2. 选择文件 `test_upload_v9.json`
3. **勾选** ☑ "上传后显示与上一版本的对比"
4. 点击"确认上传"

#### 步骤3：验证上传成功提示

应该看到：
- ✅ Toast提示："成功上传版本9，共 6 个字段"
- ✅ 上传弹窗关闭
- ✅ 页面刷新（可能有短暂延迟）

#### 步骤4：验证自动对比弹窗

**约200ms后**，应该自动弹出对比窗口，验证以下内容：

**🔸 弹窗标题**：
```
自动版本对比：版本8 vs 版本9（新上传）
```

**🔸 顶部提示**：
蓝色info提示框：
```
💡 这是您刚刚上传的新版本与上一版本的对比结果
```

**🔸 版本卡片**：

左侧（版本8）：
- 标题：版本8（上一版本）
- 普通样式

右侧（版本9）：
- 标题：版本9（新上传，当前使用）
- **高亮样式**（蓝色渐变背景）

**🔸 变更摘要**：
```
• 新增字段：1个
• 删除字段：1个
• 修改字段：2个
• 未变更：3个
```

**🔸 详细对比**：

1. **🟢 新增字段（1个）**：
   ```
   + 还款计划 (repayment_plan)
     类型：String | 必填：否 | 排序：7
     说明：还款计划说明【新增字段】
   ```

2. **🔴 删除字段（1个）**：
   ```
   - 紧急联系人 (emergency_contact)
     类型：String
   ```

3. **🟡 修改字段（2个）**：
   
   ```
   ≈ 案件状态 (case_status)
     枚举值：
     - 版本8：["待分配", "催收中", "已完成", "已关闭"]
     + 版本9：["待分配", "催收中", "已完成", "已关闭", "失败"]
     
     描述：
     - 版本8：案件当前状态
     + 版本9：案件当前状态（新增失败状态）
   
   ≈ 风险等级 (risk_level)
     枚举值：
     - 版本8：["低风险", "中风险", "高风险"]
     + 版本9：["低风险", "中风险", "高风险", "极高风险"]
     
     是否必填：
     - 版本8：false
     + 版本9：true
   ```

4. **⚪ 未变更字段（3个）**：
   - 默认折叠
   - 点击可展开查看

**🔸 底部按钮**：
```
[导出对比报告] [下载版本8] [下载版本9] [确认并关闭]
```

注意："关闭"按钮文案变为"**确认并关闭**"（主按钮样式）

### 测试3：导出对比报告

#### 步骤1：点击"导出对比报告"按钮

#### 步骤2：检查下载的Markdown文件

文件名格式：
```
version_compare_v8_vs_v9_新上传_1733654400000.md
```

文件内容应包含：

```markdown
# 版本对比报告（新上传）

## 基本信息
- 对比版本：版本8 vs 版本9（新上传）
- 对比时间：2025-12-08 12:30:00
- 对比类型：自动对比（上传后触发）

## 版本信息
| 项目 | 版本8 | 版本9（新上传） |
|------|-------|----------------|
| 上传时间 | ... | ... |
| 字段数 | 6个 | 6个 |

## 变更摘要
- 新增字段：1个
- 删除字段：1个
- 修改字段：2个
- 未变更：3个

（后续详细内容...）
```

### 测试4：关闭对比窗口

#### 步骤1：点击"确认并关闭"按钮

验证：
- ✅ 对比窗口关闭
- ✅ 返回字段列表页面
- ✅ 页面显示版本9的数据

#### 步骤2：重新打开版本管理

1. 点击"版本管理"按钮
2. 应该看到版本9被标记为"当前使用"
3. 点击版本8或9的"对比"按钮

验证：
- ✅ 对比窗口打开
- ✅ 标题为："版本对比：版本8 vs 版本9"（**没有**"新上传"标识）
- ❌ **没有**蓝色提示框
- ❌ 版本9卡片**没有**高亮样式
- ✅ 底部按钮文案为"**关闭**"（不是"确认并关闭"）

### 测试5：异常场景测试

#### 测试5.1：首次上传时勾选对比

如果数据库为空（首次上传）：

1. 清空数据库：
   ```sql
   DELETE FROM tenant_field_uploads WHERE tenant_id = '1' AND scene = 'list';
   ```

2. 上传文件并勾选"显示对比"
3. 验证：
   - ✅ 上传成功
   - ✅ 显示提示："这是首次上传，无历史版本可对比"
   - ❌ **不弹出**对比窗口

#### 测试5.2：上传失败时

1. 上传一个格式错误的JSON文件
2. 勾选"显示对比"
3. 验证：
   - ✅ 显示验证错误
   - ❌ 不触发对比（因为上传失败）

## ✅ 验收标准

### 功能性验收

| 验收项 | 状态 | 说明 |
|--------|------|------|
| 上传选项存在 | ☐ | 上传弹窗中有"上传后显示与上一版本的对比"选项 |
| 默认不勾选 | ☐ | 该选项默认为未勾选状态 |
| 不勾选不触发 | ☐ | 不勾选时上传成功不弹出对比窗口 |
| 勾选后触发 | ☐ | 勾选后上传成功自动弹出对比窗口 |
| 首次上传提示 | ☐ | 首次上传时显示无法对比的提示 |
| 对比窗口标题 | ☐ | 自动对比的标题包含"新上传"标识 |
| 顶部提示 | ☐ | 显示蓝色info提示框 |
| 版本卡片高亮 | ☐ | 新上传版本卡片有蓝色渐变背景 |
| 按钮文案 | ☐ | 底部按钮为"确认并关闭" |
| 对比内容正确 | ☐ | 正确显示新增、删除、修改的字段 |
| 导出报告 | ☐ | 可导出包含"新上传"标识的对比报告 |
| 关闭重置 | ☐ | 关闭后再次手动对比无"新上传"标识 |

### 性能验收

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| 上传成功提示显示 | < 100ms | ____ | ☐ |
| 对比窗口弹出延迟 | ~200ms | ____ | ☐ |
| 对比数据加载 | < 1s | ____ | ☐ |
| 对比窗口渲染 | < 500ms | ____ | ☐ |
| 导出报告生成 | < 2s | ____ | ☐ |

### 用户体验验收

| 验收项 | 状态 |
|--------|------|
| 上传提示清晰明确 | ☐ |
| 对比窗口自动弹出流畅 | ☐ |
| 新旧版本区分明显 | ☐ |
| 变更类型一目了然 | ☐ |
| 操作逻辑符合直觉 | ☐ |
| 错误提示友好 | ☐ |

## 🐛 常见问题排查

### 问题1：对比窗口没有弹出

**排查步骤**：
1. 检查浏览器控制台是否有错误
2. 检查是否勾选了对比选项
3. 检查当前版本号是否 > 1
4. 查看网络请求是否成功

### 问题2：对比数据不正确

**排查步骤**：
1. 检查后端对比接口返回数据
2. 查看数据库中的版本记录
3. 确认版本号是否正确

### 问题3：样式显示异常

**排查步骤**：
1. 清除浏览器缓存
2. 检查CSS文件是否正确加载
3. 查看开发者工具样式面板

## 📝 测试报告模板

```markdown
# 上传后自动对比功能测试报告

## 测试信息
- 测试时间：
- 测试人员：
- 测试环境：
  - 前端版本：
  - 后端版本：
  - 浏览器：

## 测试结果

### 基本功能
- [ ] 上传选项显示正常
- [ ] 不勾选不触发对比
- [ ] 勾选后正常触发对比
- [ ] 首次上传提示正确

### 对比界面
- [ ] 窗口标题正确
- [ ] 顶部提示显示
- [ ] 版本卡片高亮
- [ ] 变更内容正确
- [ ] 按钮文案正确

### 导出功能
- [ ] 可正常导出报告
- [ ] 文件名包含标识
- [ ] 报告内容完整

### 异常处理
- [ ] 首次上传处理正确
- [ ] 上传失败不触发
- [ ] 网络异常有提示

## 发现的问题
1. 
2. 
3. 

## 总体评价
- 功能完整性：☆☆☆☆☆
- 用户体验：☆☆☆☆☆
- 性能表现：☆☆☆☆☆

## 建议和改进
1. 
2. 
3. 
```

---

**测试完成后，请填写测试报告并反馈给开发团队！** 📋
