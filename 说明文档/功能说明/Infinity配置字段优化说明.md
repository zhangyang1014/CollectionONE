# Infinity配置字段优化说明

## 📋 优化内容

根据Infinity接口文档和实际需求，对配置表单进行了以下优化：

### 1. ✅ 应用ID改为必填

**修改前**：应用ID为可选字段  
**修改后**：应用ID为必填字段

**原因**：Infinity系统要求每个应用必须有唯一的应用ID标识。

### 2. ✅ 新增回调地址字段

**字段名**：回调地址 (callback_url)

**用途**：Infinity系统在通话结束后，会向此URL推送通话记录数据。

**示例**：`http://your-domain.com/api/v1/infinity/callback/call-record`

**说明**：
- 通话结束后，Infinity会POST通话记录到此地址
- 包含通话时长、录音链接、通话结果等信息
- 系统会自动更新通信记录并释放分机

### 3. ✅ 字段说明完善

为以下字段添加了悬浮提示说明（❓图标）：

#### 默认主叫号码
```
外显给客户看到的号码，
留空则从主叫号码池中随机选择
```
**对应Infinity参数**：`disnumber`（可选）

#### 主叫号码池
```
可用于外显的号码列表，
系统会从池中选择号码作为主叫显示
```
**说明**：当未指定默认主叫号码时，系统会从号码池中随机选择一个。

#### 回调地址
```
Infinity系统通话结束后，
推送通话记录的回调URL地址
```
**对应Infinity参数**：需在Infinity系统管理后台配置

#### 最大并发呼叫数
```
系统允许的最大同时外呼数量，
超过此数量的外呼请求将被限制
```
**说明**：根据购买的Infinity并发数配置，防止超限。

#### 呼叫超时时间
```
发起呼叫后等待接听的超时时间，
超时后将自动挂断
```
**范围**：10-300秒  
**默认**：60秒

## 📝 配置表单完整字段列表

| 字段 | 必填 | 说明 | 提示 |
|------|------|------|------|
| API地址 | ✅ | Infinity API服务器地址 | - |
| 访问令牌 | ✅ | Infinity API访问令牌 | - |
| 应用ID | ✅ | Infinity应用标识 | - |
| 默认主叫号码 | ⭕ | 外显给客户的号码 | ❓ |
| 主叫号码池 | ⭕ | 可用主叫号码列表 | ❓ |
| 回调地址 | ⭕ | 通话记录回调URL | ❓ |
| 最大并发呼叫数 | ✅ | 最大同时外呼数量 | ❓ |
| 呼叫超时时间 | ✅ | 呼叫等待超时（秒） | ❓ |
| 是否启用 | ✅ | 配置开关 | - |

## 🔄 Infinity外呼流程

```
┌─────────────────────────────────────────────────────────┐
│  1. 催员发起外呼                                          │
│     - 选择案件和客户号码                                  │
│     - 点击"立即呼叫"按钮                                  │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│  2. CCO系统处理                                          │
│     - 分配空闲分机                                        │
│     - 获取催员回呼号码                                    │
│     - 选择主叫显示号码（默认主叫或从号码池选择）           │
│     - 创建通信记录                                        │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│  3. 调用Infinity MakeCall API                           │
│     POST {api_url}                                       │
│     {                                                    │
│       service: 'App.Sip_Call.MakeCall',                 │
│       token: {access_token},                            │
│       extnumber: '8001',        // 分配的分机号          │
│       destnumber: '13800138000', // 客户号码             │
│       disnumber: '4001234567'    // 主叫显示号码         │
│     }                                                    │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│  4. Infinity系统发起双向呼叫                              │
│     - 先呼叫催员回呼号码（如：13900139000）               │
│     - 催员接听后，再外呼客户（13800138000）               │
│     - 客户侧显示主叫号码：4001234567                      │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│  5. 通话进行中                                            │
│     - 通话录音                                            │
│     - 计算通话时长                                        │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│  6. 通话结束，Infinity推送回调                            │
│     POST {callback_url}                                  │
│     {                                                    │
│       call_uuid: 'xxx',                                  │
│       call_duration: 120,       // 通话时长（秒）         │
│       is_connected: true,       // 是否接通              │
│       call_record_url: 'http://...' // 录音下载链接      │
│     }                                                    │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│  7. CCO系统接收回调并处理                                 │
│     - 更新通信记录（时长、结果、录音链接）                 │
│     - 释放分机（状态改为 available）                      │
│     - 清除催员的当前分机号                                │
└─────────────────────────────────────────────────────────┘
```

## 🎯 配置示例

### 完整配置示例

```json
{
  "api_url": "http://192.168.1.100:8080",
  "access_token": "abcdef123456",
  "app_id": "CCO_SYSTEM",
  "default_caller_number": "4001234567",
  "caller_number_pool": [
    "4001234567",
    "4007654321",
    "4009876543"
  ],
  "callback_url": "http://cco.example.com/api/v1/infinity/callback/call-record",
  "max_concurrent_calls": 50,
  "call_timeout_seconds": 60,
  "is_active": true
}
```

### 最小配置示例

```json
{
  "api_url": "http://192.168.1.100:8080",
  "access_token": "abcdef123456",
  "app_id": "CCO_SYSTEM",
  "max_concurrent_calls": 100,
  "call_timeout_seconds": 60,
  "is_active": true
}
```

## 🔐 回调地址配置说明

### 1. 回调URL格式

推荐格式：`{您的域名}/api/v1/infinity/callback/call-record`

例如：
- 生产环境：`https://cco.example.com/api/v1/infinity/callback/call-record`
- 测试环境：`http://192.168.1.10:8000/api/v1/infinity/callback/call-record`

### 2. 在Infinity系统中配置

回调地址需要在Infinity系统管理后台配置：

1. 登录Infinity管理后台
2. 进入"系统设置" → "回调配置"
3. 填写CCO系统的回调URL
4. 保存并测试

### 3. 回调数据结构

Infinity推送的数据格式：

```json
{
  "call_uuid": "CALL_20251121143025_12345",
  "call_duration": 120,
  "is_connected": true,
  "call_record_url": "http://infinity.example.com/recordings/20251121/xxx.mp3",
  "contact_result": "connected",
  "remark": "通话正常结束",
  "custom_params": {
    "userid": "456",
    "memberid": "789",
    "case_id": "12345"
  }
}
```

## 📱 用户界面截图说明

您截图中的字段说明：

| 截图中的字段 | 对应字段 | 说明 |
|-------------|---------|------|
| 默认主叫号码 | default_caller_number | 外显给客户的号码，如400电话 |
| 主叫号码池 | caller_number_pool | 多个可用的外显号码 |
| 最大并发呼叫数 | max_concurrent_calls | 同时进行的呼叫数量限制 |
| 呼叫超时时间 | call_timeout_seconds | 等待接听的超时时间 |

这些字段现在都添加了❓悬浮提示，鼠标悬停即可查看详细说明。

## ✅ 修改的文件

### 前端文件
1. `frontend/src/views/channel-config/InfinityCallConfigContent.vue`
   - 添加回调地址字段
   - 应用ID改为必填
   - 添加字段说明tooltip

2. `frontend/src/views/channel-config/InfinityCallConfig.vue`
   - 同步上述修改（独立页面版本）

### 后端文件
3. `backend/app/schemas/infinity.py`
   - InfinityCallConfigBase中app_id改为必填
   - 更新字段描述

## 🎉 总结

通过本次优化：
1. ✅ 应用ID改为必填，确保配置完整性
2. ✅ 新增回调地址配置，支持通话记录自动更新
3. ✅ 所有字段都有清晰的说明，提升用户体验
4. ✅ 配置表单更加专业和易用

---

**更新时间**：2025-11-21  
**版本**：v1.0.2

