# 数据库初始化和运行指南

## 一、环境准备

### 1.1 Python环境要求

- Python 3.8+
- pip

### 1.2 创建虚拟环境（推荐）

```bash
cd backend
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# 或
venv\Scripts\activate  # Windows
```

### 1.3 安装依赖

```bash
pip install -r requirements.txt
```

如果遇到网络问题，可以使用国内镜像：

```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

## 二、数据库初始化

### 2.1 初始化脚本功能

`init_database.py` 脚本会完成以下工作：

1. ✅ **创建所有数据库表**
   - tenants (甲方表)
   - collection_agencies (催收机构表)
   - collection_teams (催收小组表)
   - collectors (催员表)
   - case_queues (案件队列表)
   - cases (案件表)
   - field_groups (字段分组表)
   - standard_fields (标准字段表)
   - tenant_field_configs (甲方字段配置表)
   - 以及其他相关表...

2. ✅ **初始化标准字段数据**
   - 84个标准字段（从 `mock_field_data.py` 导入）
   - 12个字段分组

3. ✅ **创建测试数据**
   - 2个甲方（示例甲方A、示例甲方B）
   - 每个甲方：
     - 2个催收机构
     - 每个机构2个小组
     - 每个小组3个催员
     - 5个默认案件队列（C, S0, S1, L1, M1）
     - **50个案件**（随机分配状态、队列、催员）

### 2.2 运行初始化脚本

```bash
cd backend
python3 init_database.py
```

### 2.3 预期输出

```
============================================================
CCO系统数据库初始化
============================================================
正在创建数据库表...
✅ 数据库表创建完成

正在初始化字段分组...
✅ 已创建 12 个字段分组

正在初始化标准字段...
✅ 已创建 84 个标准字段

正在创建测试数据...
✅ 已创建甲方: 示例甲方A (ID: 1)
  ✅ 已创建机构: 示例甲方A催收机构1 (ID: 1)
    ✅ 已创建小组: 示例甲方A催收机构1小组1 (ID: 1)
      ✅ 已创建 3 个催员
    ✅ 已创建小组: 示例甲方A催收机构1小组2 (ID: 2)
      ✅ 已创建 3 个催员
  ✅ 已创建机构: 示例甲方A催收机构2 (ID: 2)
    ✅ 已创建小组: 示例甲方A催收机构2小组1 (ID: 3)
      ✅ 已创建 3 个催员
    ✅ 已创建小组: 示例甲方A催收机构2小组2 (ID: 4)
      ✅ 已创建 3 个催员

  正在为 示例甲方A 创建50个案件...
  ✅ 已为 示例甲方A 创建50个案件
...

============================================================
数据库初始化摘要
============================================================
甲方数量: 2
催收机构数量: 4
催收小组数量: 8
催员数量: 24
案件数量: 100
字段分组数量: 12
标准字段数量: 84

甲方详情:
  - 示例甲方A (ID: 1)
    机构: 2, 案件: 50
  - 示例甲方B (ID: 2)
    机构: 2, 案件: 50

============================================================
✅ 数据库初始化完成！
============================================================
```

### 2.4 数据库文件位置

SQLite数据库文件会创建在：`backend/cco_test.db`

---

## 三、测试数据详情

### 3.1 甲方信息

| ID | 编码 | 名称 | 机构数 | 案件数 |
|----|------|------|--------|--------|
| 1 | TENANT001 | 示例甲方A | 2 | 50 |
| 2 | TENANT002 | 示例甲方B | 2 | 50 |

### 3.2 默认案件队列

每个甲方自动创建5个默认队列：

| 队列编码 | 队列名称 | 逾期天数范围 | 说明 |
|---------|---------|-------------|------|
| C | C队列 | ~ -1 | 未到期案件 |
| S0 | S0队列 | 0 | 刚到期案件 |
| S1 | S1队列 | 1-5 | 轻度逾期 |
| L1 | L1队列 | 6-90 | 中度逾期 |
| M1 | M1队列 | 91+ | 重度逾期 |

### 3.3 案件状态分布

案件随机分配以下状态之一：

- `pending_repayment` (待还款)
- `partial_repayment` (部分还款)
- `normal_settlement` (正常结清)
- `extension_settlement` (展期结清)

### 3.4 催员登录信息

所有催员的默认密码：`123456`（SHA256哈希存储）

催员登录ID格式：`collector{甲方ID}{机构ID}{小组ID}{催员序号}`

例如：
- `collector1111` (甲方1, 机构1, 小组1, 催员1)
- `collector1112` (甲方1, 机构1, 小组1, 催员2)
- `collector2231` (甲方2, 机构2, 小组3, 催员1)

---

## 四、启动后端服务

### 4.1 开发模式启动

```bash
cd backend
python3 -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 4.2 使用start.sh脚本（推荐）

```bash
cd backend
./start.sh
```

### 4.3 访问API文档

启动后访问：

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **健康检查**: http://localhost:8000/api/v1/health

---

## 五、验证数据

### 5.1 查询甲方列表

```bash
curl http://localhost:8000/api/v1/tenants
```

预期响应：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tenant_code": "TENANT001",
      "tenant_name": "示例甲方A",
      "is_active": true,
      "created_at": "2025-01-11T12:00:00"
    },
    {
      "id": 2,
      "tenant_code": "TENANT002",
      "tenant_name": "示例甲方B",
      "is_active": true,
      "created_at": "2025-01-11T12:00:00"
    }
  ]
}
```

### 5.2 查询案件列表

```bash
curl "http://localhost:8000/api/v1/cases?tenant_id=1&page=1&page_size=10"
```

### 5.3 查询标准字段

```bash
curl http://localhost:8000/api/v1/standard-fields
```

---

## 六、常见问题

### 6.1 数据库已存在，如何重新初始化？

删除数据库文件后重新运行：

```bash
cd backend
rm cco_test.db
python3 init_database.py
```

### 6.2 如何修改数据库连接？

编辑 `backend/.env` 文件或 `backend/app/core/config.py`：

```python
DATABASE_URL: str = "sqlite:///./cco_test.db"  # SQLite
# 或
DATABASE_URL: str = "postgresql://user:pass@localhost/dbname"  # PostgreSQL
# 或
DATABASE_URL: str = "mysql+pymysql://user:pass@localhost/dbname"  # MySQL
```

### 6.3 如何增加测试案件数量？

编辑 `init_database.py` 中的案件创建循环：

```python
# 原代码
for case_num in range(1, 51):  # 50个案件

# 修改为
for case_num in range(1, 101):  # 100个案件
```

### 6.4 初始化失败，如何查看详细错误？

脚本会自动打印完整的错误堆栈信息。常见问题：

- **ModuleNotFoundError**: 缺少依赖包，运行 `pip install -r requirements.txt`
- **IntegrityError**: 数据冲突，删除数据库文件重新初始化
- **FileNotFoundError**: 找不到 `mock_field_data.py`，确保在 `backend` 目录下运行

---

## 七、下一步

### 7.1 实现完整的API

目前已完成：
- ✅ 数据库表结构
- ✅ SQLAlchemy模型
- ✅ 测试数据初始化

待实现：
- ⏳ 甲方管理API（CRUD）
- ⏳ 机构管理API（创建含管理员账号）
- ⏳ 小组管理API（CRUD）
- ⏳ 催员管理API（CRUD + 密码管理）
- ⏳ 案件管理API（查询、筛选）
- ⏳ 字段管理API（标准字段、甲方字段）
- ⏳ 队列管理API（CRUD）

### 7.2 前端集成

完成API实现后：
1. 将前端的mock API调用替换为真实API
2. 测试所有CRUD操作
3. 验证数据联动性

### 7.3 测试

编写集成测试：
- 甲方CRUD测试
- 机构创建（含管理员）测试
- 案件查询和筛选测试
- 字段配置测试

---

## 八、技术栈

- **Web框架**: FastAPI
- **ORM**: SQLAlchemy 2.0
- **数据库**: SQLite (开发), PostgreSQL/MySQL (生产)
- **数据验证**: Pydantic
- **数据库迁移**: Alembic
- **密码哈希**: hashlib (开发), bcrypt (生产推荐)

---

## 九、联系与支持

如有问题，请查看：
- `CCO字段配置系统设计.md` - 系统设计文档
- `角色管理优化说明.md` - 角色体系说明
- `开发环境运行指南.md` - 完整运行指南

---

**祝您使用愉快！** 🎉

