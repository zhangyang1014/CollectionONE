# 项目部署指南

## 项目概述

这是一个前后端分离的催收管理系统：
- **前端**：Vue 3 + Vite + TypeScript + Element Plus
- **后端**：FastAPI + Python + SQLAlchemy

## 部署方案选择

### 方案一：简单预览部署（推荐用于演示）

适合快速预览，成本低，适合小团队或演示使用。

#### 1. 前端部署

**步骤：**

```bash
# 1. 进入前端目录
cd frontend

# 2. 安装依赖（如果还没安装）
npm install

# 3. 构建生产版本
npm run build

# 构建完成后会生成 dist 目录，包含所有静态文件
```

**部署选项：**

**A. 使用 Vercel（推荐，免费且简单）**
1. 访问 https://vercel.com
2. 注册/登录账号
3. 导入 GitHub/GitLab 仓库（或直接上传 dist 文件夹）
4. 设置构建命令：`cd frontend && npm install && npm run build`
5. 设置输出目录：`frontend/dist`
6. 部署完成，获得一个可访问的 URL

**B. 使用 Netlify（免费）**
1. 访问 https://www.netlify.com
2. 注册/登录账号
3. 拖拽 `frontend/dist` 文件夹到 Netlify 界面
4. 获得部署 URL

**C. 使用 Nginx（需要服务器）**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /path/to/frontend/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理（如果前后端在同一服务器）
    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 2. 后端部署

**步骤：**

```bash
# 1. 进入后端目录
cd backend

# 2. 创建虚拟环境（推荐）
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量（创建 .env 文件）
# DATABASE_URL=postgresql://user:password@localhost/dbname
# SECRET_KEY=your-secret-key

# 5. 运行数据库迁移（如果有）
# alembic upgrade head

# 6. 启动服务
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**使用 Gunicorn（生产环境推荐）：**

```bash
# 安装 gunicorn
pip install gunicorn

# 启动服务
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

**使用 systemd 管理服务（Linux）：**

创建 `/etc/systemd/system/cco-backend.service`：

```ini
[Unit]
Description=CCO Backend API
After=network.target

[Service]
User=www-data
WorkingDirectory=/path/to/backend
Environment="PATH=/path/to/backend/venv/bin"
ExecStart=/path/to/backend/venv/bin/gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 127.0.0.1:8000

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl enable cco-backend
sudo systemctl start cco-backend
```

### 方案二：Docker 部署（推荐用于生产环境）

#### 1. 创建 Dockerfile

**前端 Dockerfile (`frontend/Dockerfile`):**

```dockerfile
# 构建阶段
FROM node:18-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**前端 nginx 配置 (`frontend/nginx.conf`):**

```nginx
server {
    listen 80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**后端 Dockerfile (`backend/Dockerfile`):**

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 2. 创建 docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/cco_db
    depends_on:
      - db
    volumes:
      - ./backend:/app

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=cco_db
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

#### 3. 部署

```bash
# 构建并启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 环境配置

### 前端环境变量

创建 `frontend/.env.production`：

```env
VITE_API_BASE_URL=https://your-api-domain.com/api
```

修改 `vite.config.ts` 以支持环境变量：

```typescript
export default defineConfig({
  // ... 其他配置
  define: {
    'process.env.VITE_API_BASE_URL': JSON.stringify(process.env.VITE_API_BASE_URL || 'http://localhost:8000/api')
  }
})
```

### 后端环境变量

创建 `backend/.env`：

```env
DATABASE_URL=postgresql://user:password@localhost:5432/cco_db
SECRET_KEY=your-secret-key-here
DEBUG=False
```

## 服务器推荐

### 免费/低成本选项：

1. **Vercel**（前端）- 免费，自动 HTTPS
2. **Railway**（后端）- 免费额度，支持 Docker
3. **Render**（全栈）- 免费额度，支持 Docker
4. **Fly.io**（全栈）- 免费额度，全球部署

### 付费选项：

1. **阿里云/腾讯云** - 国内访问快
2. **AWS/Azure/GCP** - 全球部署
3. **DigitalOcean** - 简单易用，$6/月起

## 快速部署检查清单

- [ ] 前端构建成功（`npm run build`）
- [ ] 后端依赖安装完成
- [ ] 数据库配置正确
- [ ] 环境变量配置完成
- [ ] API 地址配置正确
- [ ] CORS 配置允许前端域名
- [ ] HTTPS 配置（生产环境）
- [ ] 域名解析配置
- [ ] 防火墙端口开放（80, 443, 8000）

## 常见问题

### 1. CORS 错误

在后端 `app/main.py` 中添加：

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://your-frontend-domain.com"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. 前端路由 404

确保 Nginx 配置了 `try_files $uri $uri/ /index.html;`

### 3. API 请求失败

检查：
- API 地址是否正确
- 后端服务是否运行
- 网络连接是否正常
- CORS 配置是否正确

## 安全建议

1. **生产环境必须使用 HTTPS**
2. **设置强密码和密钥**
3. **限制 API 访问频率**
4. **定期更新依赖**
5. **使用环境变量存储敏感信息**
6. **配置防火墙规则**
7. **定期备份数据库**

## 监控和维护

### 日志查看

```bash
# 后端日志
tail -f /var/log/cco-backend.log

# Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 性能监控

考虑使用：
- **Sentry** - 错误监控
- **Prometheus + Grafana** - 性能监控
- **Uptime Robot** - 服务可用性监控

## 联系支持

如有问题，请查看项目文档或联系开发团队。

