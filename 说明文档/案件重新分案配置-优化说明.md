# 案件重新分案配置 - 优化说明

## 变更记录

| 版本 | 日期 | 变更内容 | 变更人 |
|------|------|---------|--------|
| 1.0 | 2025-12-09 | 初始版本，优化生效小组展示和验证逻辑 | 大象 |
| 2.0 | 2025-12-09 | 重大改版：改为树形展示，队列作为父行，策略作为子行 | 大象 |

## 优化概述

本次优化主要针对"案件重新分案配置"功能，增强了生效小组的展示和验证能力。

## 优化内容

### 1. 前端优化

#### 1.1 表格增加"生效小组"列

**位置**: `frontend/src/views/case-management/CaseReassignConfig.vue`

**变更内容**:
- 在配置列表表格中新增"生效小组"列
- 如果配置的 `teamIds` 为空（针对所有小组），显示 `-`
- 如果有具体的小组ID，显示小组名称（用标签形式展示）

**实现逻辑**:

```typescript
// 查询配置列表时，加载所有小组信息
const allTeams: any[] = []
for (const agency of agencyList) {
  const teams = await getAgencyTeams(agency.id)
  allTeams.push(...teamList)
}

// 为每个配置解析并显示小组名称
for (const config of configList) {
  const teamIdsStr = config.teamIds || config.team_ids
  if (teamIdsStr) {
    const teamIds = JSON.parse(teamIdsStr)
    config.team_names = teamIds.map((id: number) => {
      const team = allTeams.find((t: any) => t.id === id)
      return team ? team.team_name : `小组${id}`
    })
  }
}
```

**显示效果**:

```vue
<el-table-column prop="team_names" label="生效小组" min-width="200">
  <template #default="{ row }">
    <span v-if="!row.team_names || row.team_names.length === 0">-</span>
    <el-tag v-else v-for="(name, index) in row.team_names" :key="index" size="small">
      {{ name }}
    </el-tag>
  </template>
</el-table-column>
```

#### 1.2 队列小组验证逻辑

**新增变量**:
- `queueHasNoTeams`: 标记当前选择的队列是否没有小组

**验证规则**:
1. 选择队列后，加载该队列下的所有小组
2. 如果队列下没有任何小组：
   - 设置 `queueHasNoTeams = true`
   - 显示警告提示："该队列下没有小组，无法创建重新分案配置"
   - 禁用"生效小组"选择框
   - 禁用"确定"提交按钮
3. 如果队列下有小组：
   - 用户可以不选择任何小组（表示针对所有小组）
   - 用户可以选择一个或多个具体小组

**代码实现**:

```typescript
const handleQueueChange = async (queueId: number | null) => {
  // ... 加载队列下的小组
  
  queueHasNoTeams.value = allTeams.length === 0
  
  if (queueHasNoTeams.value) {
    ElMessage.warning('该队列下没有小组，无法创建重新分案配置')
  }
}

const handleSubmit = async () => {
  // 检查队列是否有小组
  if (queueHasNoTeams.value) {
    ElMessage.error('该队列下没有小组，无法创建重新分案配置')
    return
  }
  // ... 继续提交
}
```

**表单UI调整**:

```vue
<!-- 生效小组选择框 -->
<el-select 
  v-model="form.team_ids" 
  :disabled="queueHasNoTeams"
  placeholder="请选择小组（不选则针对该队列下所有小组）"
>
  <!-- ... -->
</el-select>

<!-- 错误提示 -->
<el-alert 
  v-if="queueHasNoTeams" 
  title="该队列下没有小组，无法创建重新分案配置" 
  type="error" 
/>

<!-- 提交按钮 -->
<el-button 
  type="primary" 
  @click="handleSubmit" 
  :disabled="queueHasNoTeams"
>
  确定
</el-button>
```

#### 1.3 表格列宽优化

为了适应新增的"生效小组"列，调整了其他列的宽度：

| 列名 | 调整前 | 调整后 |
|------|--------|--------|
| ID | 80 | 80 |
| 队列名称 | 200 | 180 |
| 生效小组 | - | 200（新增，min-width） |
| 重新分案天数 | 120 | 130 |
| 生效日期 | 120 | 110 |
| 状态 | 100 | 80 |
| 创建时间 | 180 | 160 |
| 操作 | 200 | 150 |

### 2. 后端优化

#### 2.1 添加验证逻辑注释

**位置**: `backend-java/src/main/java/com/cco/controller/CaseReassignConfigController.java`

**内容**:
在创建配置时添加了TODO注释，说明连接真实数据库后需要添加的验证逻辑：

```java
// TODO: 连接真实数据库后，需要添加验证逻辑：
// 1. 验证队列是否存在
// 2. 验证队列下是否有小组（如果队列下没有小组，应拒绝创建配置）
// 3. 如果指定了teamIds，验证这些小组是否确实属于该队列
```

**说明**:
由于当前使用Mock数据，无法直接在后端验证队列是否有小组。但前端已经做了充分的验证，确保用户体验良好。当连接真实数据库后，应在后端添加完整的验证逻辑。

## 业务规则

### 队列小组配置规则

1. **队列必须有小组才能创建配置**
   - 如果队列下没有任何小组，不允许创建该队列的重新分案配置
   - 原因：重新分案配置是针对小组的，如果没有小组，配置无意义

2. **小组选择规则**
   - 不选择任何小组：配置针对该队列下**所有小组**生效
   - 选择具体小组：配置只针对**选中的小组**生效

3. **小组唯一性规则**
   - 同一个队列下，同一个小组不能有多个配置
   - 如果配置针对"所有小组"，则与该队列下任何配置都冲突
   - 如果配置针对具体小组，则检查是否与现有配置的小组有交集

### 冲突检测逻辑

已有的冲突检测逻辑（后端实现）：

```java
public List<CaseReassignConfig> checkConflictConfigs(Long tenantId, Long queueId, List<Long> teamIds) {
    // 查询该队列下的所有配置
    List<CaseReassignConfig> queueConfigs = ...;
    
    // 如果teamIds为空，表示针对所有小组，与任何配置都冲突
    if (teamIds == null || teamIds.isEmpty()) {
        return queueConfigs;
    }
    
    // 检查是否有配置与当前选择的小组冲突
    for (CaseReassignConfig config : queueConfigs) {
        // 如果配置的teamIds为空，表示针对所有小组，冲突
        if (configTeamIdsStr == null || configTeamIdsStr.isEmpty()) {
            conflicts.add(config);
        } else {
            // 检查是否有交集
            if (有交集) {
                conflicts.add(config);
            }
        }
    }
    
    return conflicts;
}
```

## 测试要点

### 前端测试

1. **表格展示测试**
   - [ ] 配置列表正确显示"生效小组"列
   - [ ] 如果配置针对所有小组（teamIds为空），显示 `-`
   - [ ] 如果配置针对具体小组，显示小组名称标签
   - [ ] 小组名称标签样式正确，多个小组时换行显示

2. **队列选择测试**
   - [ ] 选择有小组的队列时，正常加载小组列表
   - [ ] 选择没有小组的队列时：
     - [ ] 显示警告提示
     - [ ] 小组选择框被禁用
     - [ ] 确定按钮被禁用
   - [ ] 队列切换时，小组列表正确更新

3. **创建配置测试**
   - [ ] 不选择小组，成功创建配置（针对所有小组）
   - [ ] 选择一个小组，成功创建配置
   - [ ] 选择多个小组，成功创建配置
   - [ ] 选择没有小组的队列，无法提交

4. **冲突检测测试**
   - [ ] 创建针对"所有小组"的配置时，如果该队列已有配置，提示冲突
   - [ ] 创建针对具体小组的配置时，如果该小组已有配置，提示冲突
   - [ ] 用户确认替换后，旧配置被删除，新配置创建成功

### 后端测试

1. **API测试**
   - [ ] GET `/api/v1/case-reassign-configs` 正确返回配置列表
   - [ ] POST `/api/v1/case-reassign-configs` 创建配置成功
   - [ ] POST 时传入 `replace=true` 参数，能够替换冲突配置
   - [ ] PUT `/api/v1/case-reassign-configs/{id}` 更新配置成功
   - [ ] DELETE `/api/v1/case-reassign-configs/{id}` 删除配置成功

2. **冲突检测测试**
   - [ ] `checkConflictConfigs` 方法正确检测冲突
   - [ ] 返回409状态码和冲突信息
   - [ ] 冲突信息包含冲突配置的详细内容

## 使用示例

### 场景1：创建针对所有小组的配置

1. 点击"创建配置"按钮
2. 选择队列：C队列（该队列下有小组）
3. 不选择任何小组（保持为空）
4. 设置重新分案天数：7天
5. 点击"确定"
6. 结果：创建成功，配置针对C队列下所有小组生效

### 场景2：创建针对具体小组的配置

1. 点击"创建配置"按钮
2. 选择队列：C队列
3. 选择小组：催收1组、催收2组
4. 设置重新分案天数：10天
5. 点击"确定"
6. 结果：创建成功，配置只针对催收1组和催收2组生效

### 场景3：队列没有小组的情况

1. 点击"创建配置"按钮
2. 选择队列：X队列（该队列下没有小组）
3. 显示：
   - 警告提示："该队列下没有小组，无法创建重新分案配置"
   - 小组选择框被禁用
   - 确定按钮被禁用
4. 结果：无法创建配置

### 场景4：冲突检测和替换

1. 假设C队列已有配置：针对所有小组，重新分案天数7天
2. 创建新配置：C队列，选择催收1组，重新分案天数10天
3. 系统检测到冲突（旧配置针对所有小组，包含催收1组）
4. 弹出确认框，询问是否替换
5. 用户点击"替换"
6. 结果：旧配置被删除，新配置创建成功

## 注意事项

1. **Mock环境限制**
   - 当前后端使用Mock数据，队列和小组是硬编码的
   - Mock数据中：
     - 队列1（ID=1）：C队列，有小组
     - 队列2（ID=2）：S0队列，有小组
   - 实际使用时，队列和小组数据来自真实数据库

2. **前端验证优先**
   - 在Mock环境下，主要依赖前端验证逻辑
   - 连接真实数据库后，应在后端添加完整的验证逻辑

3. **小组名称显示**
   - 小组名称从小组数据的 `team_name` 或 `teamName` 字段获取
   - 如果找不到小组信息，显示为 `小组{ID}`

4. **性能考虑**
   - 查询配置列表时会加载所有机构和小组数据
   - 如果机构和小组数量很大，可能需要优化加载逻辑
   - 建议：只加载配置中涉及的小组信息

## 后续优化建议

1. **性能优化**
   - 优化小组数据加载逻辑，只加载必要的小组信息
   - 考虑添加缓存机制

2. **后端验证**
   - 连接真实数据库后，添加完整的队列和小组验证逻辑
   - 验证队列是否存在
   - 验证小组是否属于该队列

3. **用户体验优化**
   - 在表格中添加队列信息的Tooltip，显示队列下的所有小组
   - 在创建配置时，显示队列下的小组总数
   - 添加批量操作功能（批量删除、批量启用/禁用）

4. **数据展示优化**
   - 支持按队列分组显示配置
   - 支持按生效小组筛选配置
   - 添加配置统计信息（总配置数、启用数、禁用数）

## 相关文件

### 前端文件
- `frontend/src/views/case-management/CaseReassignConfig.vue` - 案件重新分案配置页面
- `frontend/src/api/case.ts` - 案件相关API定义

### 后端文件
- `backend-java/src/main/java/com/cco/controller/CaseReassignConfigController.java` - 配置控制器
- `backend-java/src/main/java/com/cco/service/impl/CaseReassignConfigServiceImpl.java` - 配置服务实现
- `backend-java/src/main/java/com/cco/model/entity/CaseReassignConfig.java` - 配置实体类

## v2.0 改版说明

### 改版概述

本次改版将配置列表从平铺展示改为**树形展示**，以队列为主体，策略作为子行，使得配置结构更加清晰直观。

### 核心改动

#### 1. 树形表格展示

**改动前**：
- 所有配置平铺展示，每个配置一行
- 队列信息通过"队列名称"列显示
- 需要手动筛选才能看到某个队列的所有配置

**改动后**：
- 队列作为父行，策略作为子行（树形结构）
- 支持展开/收起队列
- 一眼就能看到每个队列下有多少策略

**数据结构变化**：

```typescript
// v1.0 数据结构（平铺）
configs = [
  { id: 1, target_id: 1, team_ids: [1], reassign_days: 7, ... },
  { id: 2, target_id: 1, team_ids: [2], reassign_days: 10, ... }
]

// v2.0 数据结构（树形）
treeData = [
  {
    id: 'queue-1',
    type: 'queue',
    queue_id: 1,
    queue_name: 'C队列',
    children: [
      { id: 1, type: 'config', team_names: ['催收1组'], reassign_days: 7, ... },
      { id: 2, type: 'config', team_names: ['催收2组'], reassign_days: 10, ... }
    ]
  }
]
```

#### 2. 移除顶部"创建配置"按钮

**改动前**：
- 顶部有一个"创建配置"按钮
- 点击后需要选择队列、选择小组、设置天数

**改动后**：
- 移除了顶部按钮
- 每个队列行都有"添加策略"按钮
- 点击后队列已确定，只需选择小组和天数

#### 3. 简化对话框

**改动前**：
- 表单中有"队列"选择框
- 需要先选择队列，再加载小组

**改动后**：
- 表单中不再显示队列选择框
- 队列名称显示在对话框标题中（如"添加策略 - C队列"）
- 直接显示该队列下的小组列表

#### 4. 无策略队列的占位显示

**新增功能**：
- 没有策略的队列也会显示
- 显示占位行："(无策略)"
- 生效小组显示"-"，状态显示"停用"

#### 5. 操作列调整

**改动前**：
- 所有配置行都有"编辑"和"删除"按钮

**改动后**：
- **队列行（父行）**：显示"添加策略"按钮
- **策略行（子行）**：显示"编辑"和"删除"按钮
- **占位行**：不显示任何操作按钮

### 代码实现

#### 表格组件配置

```vue
<el-table 
  :data="treeData" 
  border 
  row-key="id"
  :tree-props="{ children: 'children', hasChildren: 'hasChildren' }"
  default-expand-all
>
```

#### 列显示逻辑

```vue
<el-table-column prop="name" label="队列名称" tree-node>
  <template #default="{ row }">
    <span v-if="row.type === 'queue'">{{ row.queue_name }}</span>
    <span v-else-if="row.type === 'placeholder'">(无策略)</span>
    <span v-else></span>
  </template>
</el-table-column>
```

#### 操作列逻辑

```vue
<el-table-column label="操作">
  <template #default="{ row }">
    <!-- 队列行 -->
    <el-button v-if="row.type === 'queue'" @click="handleAddStrategy(row)">
      添加策略
    </el-button>
    
    <!-- 策略行 -->
    <template v-else-if="row.type === 'config'">
      <el-button @click="handleEdit(row)">编辑</el-button>
      <el-button @click="handleDelete(row)">删除</el-button>
    </template>
  </template>
</el-table-column>
```

#### 数据加载逻辑

```typescript
const handleQuery = async () => {
  // 1. 加载所有队列
  const queueList = await getTenantQueues(currentTenantId.value)
  
  // 2. 加载所有配置
  const configList = await getCaseReassignConfigs(params)
  
  // 3. 加载所有小组
  const allTeams = await loadAllTeams()
  
  // 4. 构建树形数据
  const treeNodes = queueList.map(queue => {
    const queueConfigs = configList.filter(c => c.target_id === queue.id)
    
    const children = queueConfigs.length > 0
      ? queueConfigs.map(config => ({
          ...config,
          type: 'config',
          team_names: parseTeamNames(config, allTeams)
        }))
      : [{
          id: `placeholder-${queue.id}`,
          type: 'placeholder',
          is_placeholder: true
        }]
    
    return {
      id: `queue-${queue.id}`,
      type: 'queue',
      queue_id: queue.id,
      queue_name: queue.queue_name,
      children
    }
  })
  
  treeData.value = treeNodes
}
```

### 用户体验优化

1. **更清晰的结构**：树形展示让队列和策略的层级关系一目了然
2. **更快的操作**：点击队列行的"添加策略"，队列已确定，省去选择队列的步骤
3. **更好的视觉效果**：展开/收起队列，可以专注于当前关注的队列
4. **更完整的信息**：即使队列没有策略，也会显示在列表中

### 预期效果图

```
┌─────────────────────────────────────────────────────────────┐
│ 案件重新分案配置                                              │
│ [说明：系统将按配置的天数自动检查案件停留时间...]            │
├─────────────────────────────────────────────────────────────┤
│ [刷新]                                                       │
├─────────────────────────────────────────────────────────────┤
│ ▼ C队列              │   │     │     │     │     │添加策略│  │
│   ├─ 策略1 │催收1组  │7天  │12-10│启用 │12-09│编辑│删除│  │
│   └─ 策略2 │催收2组  │10天 │12-10│启用 │12-09│编辑│删除│  │
│ ▼ S0队列             │   │     │     │     │     │添加策略│  │
│   └─ (无策略)│-      │-    │-    │停用 │-    │    │    │  │
│ ▼ M1队列             │   │     │     │     │     │添加策略│  │
│   └─ 策略1 │全部     │5天  │12-10│启用 │12-09│编辑│删除│  │
└─────────────────────────────────────────────────────────────┘
```

### 测试要点

#### v2.0 新增测试

1. **树形展示测试**
   - [ ] 所有队列都作为父行展示
   - [ ] 每个队列可以展开/收起
   - [ ] 有策略的队列显示子行（策略列表）
   - [ ] 无策略的队列显示占位行
   - [ ] 默认所有队列都展开

2. **添加策略测试**
   - [ ] 点击队列行的"添加策略"按钮，弹出对话框
   - [ ] 对话框标题显示队列名称
   - [ ] 表单中不显示队列选择框
   - [ ] 自动加载该队列下的小组列表
   - [ ] 提交后策略显示为该队列的子行

3. **编辑/删除策略测试**
   - [ ] 只有策略行显示"编辑"和"删除"按钮
   - [ ] 点击编辑，对话框标题显示队列名称
   - [ ] 编辑后策略信息正确更新
   - [ ] 删除后策略从子行中移除

4. **占位行测试**
   - [ ] 无策略的队列显示占位行
   - [ ] 占位行显示"(无策略)"文字
   - [ ] 占位行各列显示正确（生效小组="-"，天数="-"，状态="停用"）
   - [ ] 占位行不显示操作按钮

## 总结

### v1.0 优化

1. ✅ 配置列表中增加了"生效小组"列，清晰显示每个配置针对哪些小组
2. ✅ 添加了队列小组验证逻辑，确保只有有小组的队列才能创建配置
3. ✅ 优化了表格布局，使得各列信息更加清晰
4. ✅ 增强了用户体验，提供了明确的错误提示和引导

### v2.0 改版

1. ✅ 改为树形展示，队列作为父行，策略作为子行
2. ✅ 移除顶部"创建配置"按钮，改为队列行"添加策略"按钮
3. ✅ 简化对话框，不再需要选择队列
4. ✅ 无策略队列显示占位行，确保所有队列都可见
5. ✅ 优化操作列，根据行类型显示不同操作

**改版后的功能更加符合业务逻辑，用户操作更加便捷，信息展示更加清晰直观。**
