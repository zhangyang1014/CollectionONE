# 催员登录人脸识别功能实现说明

## 📋 功能概述

实现了催员登录时的人脸识别功能，包括：
1. **IM端登录页**：登录时自动拍照并上传到人脸检测服务
2. **控台催员管理页**：查询并展示催员的登录人脸记录

---

## 🎯 功能详情

### 1. IM端登录页人脸识别

**文件位置**：`frontend/src/views/im/Login.vue`

#### 功能特性

- ✅ **摄像头启动**：点击"点击开始人脸识别"启动前置摄像头
- ✅ **自动拍照**：摄像头启动后 3 秒自动拍照
- ✅ **人脸检测**：拍照后自动上传到"催员人脸检测"服务，获取人脸ID
- ✅ **照片预览**：显示拍摄的照片，支持重拍
- ✅ **状态提示**：显示识别状态（识别中/成功/失败）
- ✅ **登录限制**：未完成人脸识别无法登录

#### 交互流程

```
1. 用户点击"点击开始人脸识别"
   ↓
2. 请求摄像头权限
   ↓
3. 显示实时视频流（镜像显示）
   ↓
4. 3秒后自动拍照
   ↓
5. 停止摄像头，显示照片预览
   ↓
6. 上传照片到人脸检测服务
   ↓
7. 获取人脸ID，显示成功状态
   ↓
8. 登录按钮启用，可以登录
```

#### API 调用

**人脸检测接口**：
```typescript
POST /api/v1/im/face/detect
Content-Type: multipart/form-data
Body: { image: File }
Response: { face_id: string }
```

**上传登录记录接口**：
```typescript
POST /api/v1/im/face/login-record
Body: {
  collector_id: string
  tenant_id: string
  face_image: string  // base64
  face_id: string
  login_time: string
}
```

#### Mock 数据

当前使用 Mock 数据，实际 API 调用已预留：
- 人脸检测：返回固定的人脸ID（如 `FACE_20251112_001`）
- 上传记录：仅记录日志，不影响登录流程

---

### 2. 控台催员管理页 - 登录人脸查询

**文件位置**：`frontend/src/views/organization/CollectorManagement.vue`

#### 功能特性

- ✅ **查询入口**：在催员列表操作列添加"登录人脸查询"按钮
- ✅ **弹窗展示**：点击后打开弹窗，展示该催员的所有登录人脸记录
- ✅ **时间轴展示**：按登录时间倒序展示，使用时间轴组件
- ✅ **信息展示**：
  - 登录时间
  - 人脸照片（150x150px）
  - 人脸ID（标签显示）
  - 记录创建时间
- ✅ **空状态处理**：无记录时显示空状态提示
- ✅ **加载状态**：加载时显示 loading 动画

#### 交互流程

```
1. 在催员列表点击"登录人脸查询"
   ↓
2. 打开弹窗，显示加载状态
   ↓
3. 调用API获取登录人脸记录
   ↓
4. 按时间倒序展示记录
   ↓
5. 每条记录显示：照片 + 时间 + 人脸ID
```

#### API 调用

**获取登录人脸记录接口**：
```typescript
GET /api/v1/collectors/{collector_id}/login-face-records
Response: Array<{
  id: number
  collector_id: number
  login_time: string
  face_image: string  // base64 或 URL
  face_id: string
  created_at: string
}>
```

#### Mock 数据

当前返回 3 条 Mock 记录：
- 2025-11-12 09:15:30
- 2025-11-11 08:30:20
- 2025-11-10 09:00:10

---

## 📁 文件清单

### 新增/修改的文件

1. **API 接口文件**
   - `frontend/src/api/im.ts` - 添加人脸检测和上传记录接口
   - `frontend/src/api/organization.ts` - 添加获取登录人脸记录接口

2. **页面组件**
   - `frontend/src/views/im/Login.vue` - IM端登录页（添加人脸识别）
   - `frontend/src/views/organization/CollectorManagement.vue` - 催员管理页（添加查询功能）

---

## 🎨 UI 设计

### IM端登录页

**人脸识别区域**：
- 320x240px 摄像头容器
- 居中显示，带边框和圆角
- 占位符：灰色背景 + 摄像头图标
- 视频流：镜像显示（更自然）
- 照片预览：显示拍摄的照片 + 重拍按钮
- 状态提示：识别中/成功/失败

**样式特点**：
- 响应式设计，适配移动端
- 加载动画（旋转图标）
- 错误提示（红色文字）
- 成功提示（绿色文字 + 人脸ID）

### 控台查询弹窗

**时间轴展示**：
- 每条记录一个时间轴节点
- 卡片式布局：照片 + 信息
- 照片：150x150px，圆角，带边框
- 信息：登录时间、人脸ID（标签）、记录时间

**样式特点**：
- 80% 宽度弹窗
- 时间轴蓝色节点
- 卡片 hover 效果
- 图片加载错误处理（显示占位图）

---

## 🔧 技术实现

### 摄像头访问

使用 `navigator.mediaDevices.getUserMedia()` API：
```typescript
const stream = await navigator.mediaDevices.getUserMedia({
  video: {
    width: { ideal: 640 },
    height: { ideal: 480 },
    facingMode: 'user' // 前置摄像头
  }
})
```

### 拍照实现

使用 Canvas API 捕获视频帧：
```typescript
const canvas = canvasRef.value
const ctx = canvas.getContext('2d')
canvas.width = video.videoWidth
canvas.height = video.videoHeight
ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
const imageData = canvas.toDataURL('image/jpeg', 0.8)
```

### 资源清理

组件卸载时自动停止摄像头：
```typescript
onUnmounted(() => {
  stopCamera() // 停止所有视频轨道
})
```

---

## 📊 数据流程

### 登录流程

```
IM端登录页
  ↓
启动摄像头
  ↓
自动拍照（3秒后）
  ↓
转换为 base64
  ↓
上传到人脸检测服务
  ↓
获取人脸ID
  ↓
用户点击登录
  ↓
登录成功后上传记录
  ↓
记录包含：催员ID、甲方ID、照片、人脸ID、登录时间
```

### 查询流程

```
控台催员管理页
  ↓
点击"登录人脸查询"
  ↓
调用API获取记录
  ↓
按登录时间倒序展示
  ↓
每条记录显示照片和信息
```

---

## 🚀 后续开发

### 后端 API 实现

需要实现以下接口：

1. **人脸检测服务**（可能为第三方服务）
   ```
   POST /api/v1/im/face/detect
   - 接收图片文件
   - 调用人脸检测服务
   - 返回人脸ID（相同人脸返回相同ID）
   ```

2. **上传登录记录**
   ```
   POST /api/v1/im/face/login-record
   - 保存登录记录到数据库
   - 存储人脸照片（base64 或上传到OSS）
   - 关联催员ID和甲方ID
   ```

3. **查询登录记录**
   ```
   GET /api/v1/collectors/{collector_id}/login-face-records
   - 查询该催员的所有登录记录
   - 按登录时间倒序返回
   - 包含照片、人脸ID、时间等信息
   ```

### 数据库设计建议

**表名**：`collector_login_face_records`

```sql
CREATE TABLE collector_login_face_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    collector_id BIGINT NOT NULL COMMENT '催员ID',
    tenant_id BIGINT NOT NULL COMMENT '甲方ID',
    login_time DATETIME NOT NULL COMMENT '登录时间',
    face_image TEXT COMMENT '人脸照片（base64或URL）',
    face_id VARCHAR(100) NOT NULL COMMENT '人脸ID',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_collector_login (collector_id, login_time DESC),
    INDEX idx_face_id (face_id)
) COMMENT='催员登录人脸记录表';
```

### 功能增强建议

1. **人脸比对**：登录时比对当前人脸与历史人脸，检测是否为同一人
2. **异常检测**：检测到不同人脸ID时发出告警
3. **批量查询**：支持按时间范围、人脸ID筛选
4. **导出功能**：导出登录记录为Excel
5. **统计报表**：统计登录次数、人脸ID分布等

---

## ⚠️ 注意事项

### 隐私与安全

1. **数据加密**：人脸照片建议加密存储
2. **访问权限**：仅管理员和机构管理员可查看
3. **数据保留**：建议设置数据保留期限（如90天）
4. **合规性**：遵守相关法律法规（如《个人信息保护法》）

### 性能优化

1. **图片压缩**：上传前压缩图片（当前使用 0.8 质量）
2. **分页加载**：记录较多时使用分页
3. **图片懒加载**：弹窗中的图片使用懒加载
4. **缓存策略**：人脸ID可以缓存，减少重复检测

### 浏览器兼容性

- **摄像头API**：需要 HTTPS 环境（localhost 除外）
- **浏览器支持**：Chrome、Firefox、Safari、Edge 均支持
- **移动端**：iOS Safari 需要用户主动触发（已实现点击触发）

---

## 📝 测试检查清单

### IM端登录页

- [ ] 摄像头权限请求正常
- [ ] 视频流显示正常（镜像）
- [ ] 自动拍照功能正常（3秒后）
- [ ] 照片预览显示正常
- [ ] 重拍功能正常
- [ ] 人脸检测API调用正常
- [ ] 识别成功/失败提示正常
- [ ] 登录按钮禁用/启用正常
- [ ] 登录后上传记录正常
- [ ] 组件卸载时摄像头正常关闭

### 控台查询页

- [ ] "登录人脸查询"按钮显示正常
- [ ] 点击后弹窗正常打开
- [ ] 加载状态显示正常
- [ ] 记录列表展示正常（时间轴）
- [ ] 照片显示正常
- [ ] 人脸ID标签显示正常
- [ ] 时间格式化正常
- [ ] 空状态显示正常
- [ ] 图片加载错误处理正常
- [ ] 关闭弹窗正常

---

## 🔗 相关文档

- [Web MediaDevices API](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia)
- [Canvas API](https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API)
- [Element Plus Timeline 组件](https://element-plus.org/zh-CN/component/timeline.html)

---

## 📞 联系方式

如有问题或建议，请联系开发团队。

**最后更新**：2025-11-12

