# 甲方字段管理重构说明

## 📋 概述

本次重构重新定义了"甲方自定义字段管理"的核心概念和交互模式，将其从单纯的自定义字段管理升级为统一的字段映射和配置中心。

**版本：** v2.1.0  
**日期：** 2024-11-11  
**状态：** ✅ 设计完成，前端实现完成，后端待实现

---

## 🎯 核心变更

### 1. 页面定位重新定义

**之前（v2.0）：**
- 仅管理甲方的自定义字段
- 标准字段在其他页面配置
- 映射关系分散在不同界面

**现在（v2.1）：**
- 统一管理标准字段映射 + 自定义字段
- 一个页面完成所有字段配置
- 清晰的字段来源标识（标准/自定义）

### 2. 表格列调整

| 变更类型 | 列名 | 说明 |
|---------|------|------|
| 🆕 新增 | 拖拽手柄 | ☰ 图标，支持拖拽排序 |
| 🆕 新增 | 甲方字段标识 | tenant_field_key，inline编辑 |
| 🆕 新增 | 甲方字段ID | tenant_field_id，inline编辑 |
| 🆕 新增 | 来源 | 标准/自定义，Tag显示 |
| 🆕 新增 | 队列可见性 | 配置字段在特定队列中隐藏 |
| ✏️ 修改 | 是否必填 | 标准字段不可编辑，自定义可编辑 |
| ✏️ 修改 | 排序 | 支持拖拽自动更新 |
| ✏️ 修改 | 操作 | 标准字段不能删除 |

### 3. 交互规则

#### 标准字段（field_source = 'standard'）

| 操作 | 是否允许 | 说明 |
|-----|---------|------|
| 编辑字段名称 | ❌ | 系统字段，不可修改 |
| 编辑字段标识 | ❌ | 系统字段，不可修改 |
| 编辑字段类型 | ❌ | 系统字段，不可修改 |
| 编辑甲方字段标识 | ✅ | 可配置映射关系 |
| 编辑甲方字段ID | ✅ | 可配置映射关系 |
| 编辑是否必填 | ❌ | 继承标准字段设置 |
| 配置队列可见性 | ✅ | 可隐藏特定队列 |
| 调整排序 | ✅ | 拖拽或手动调整 |
| 删除 | ❌ | 标准字段不可删除 |

#### 自定义字段（field_source = 'custom'）

| 操作 | 是否允许 | 说明 |
|-----|---------|------|
| 编辑所有属性 | ✅ | 完全控制权 |
| 删除 | ✅ | 可删除，带二次确认 |

---

## 📊 排序规则系统

### 规则1：新建甲方时自动继承

```
场景：创建新甲方"银行A"

步骤：
1. 系统自动为"银行A"创建所有标准字段的配置记录
2. 复制当前标准字段的 sort_order 到 tenant_field_configs.sort_order
3. 这是一个快照，后续不会自动更新

示例：
标准字段管理中：
  - 用户编号 (sort_order = 5)
  - 用户姓名 (sort_order = 10)
  - 性别 (sort_order = 15)

创建银行A后，其字段配置：
  - 用户编号 (sort_order = 5)  ← 快照继承
  - 用户姓名 (sort_order = 10) ← 快照继承
  - 性别 (sort_order = 15)      ← 快照继承
```

### 规则2：甲方调整排序后独立

```
场景：银行A调整字段顺序

操作：
1. 银行A将"性别"拖拽到第一位
2. 自动更新排序：性别(1), 用户编号(2), 用户姓名(3)
3. 这个排序只影响银行A
4. 其他甲方不受影响
5. 后续标准字段管理的排序变化不会影响银行A

结果：
银行A的字段配置：
  - 性别 (sort_order = 1)      ← 甲方自定义
  - 用户编号 (sort_order = 2)  ← 甲方自定义
  - 用户姓名 (sort_order = 3)  ← 甲方自定义

银行B仍保持原排序：
  - 用户编号 (sort_order = 5)
  - 用户姓名 (sort_order = 10)
  - 性别 (sort_order = 15)
```

### 规则3：新增标准字段自动追加

```
场景：系统新增标准字段"年龄"

步骤：
1. 系统自动为所有甲方创建该字段的配置记录
2. sort_order = MAX(current_sort_order) + 1
3. 即：排在该甲方所有现有字段的最后
4. 甲方可以自行调整该字段的位置

示例：
银行A当前最大排序为 100

新增"年龄"字段后：
银行A的字段配置：
  - ... (原有字段，排序 1-100)
  - 年龄 (sort_order = 101) ← 新增字段，排在最后

银行A可以将"年龄"拖拽到任意位置
```

### 规则4：排序优先级

```
字段显示顺序优先级（从高到低）：

1️⃣ 队列字段配置（queue_field_configs.sort_order）
   - 队列级别的排序设置
   - 最高优先级

2️⃣ 甲方字段配置（tenant_field_configs.sort_order）
   - 甲方级别的排序设置
   - 第二优先级

3️⃣ 标准字段默认排序（standard_fields.sort_order）
   - 系统默认排序
   - 兜底排序

示例：
某字段在不同配置层级的排序：
- 标准字段管理：sort_order = 10
- 银行A配置：sort_order = 5
- M1队列配置：sort_order = 1

最终显示：
- M1队列中：按 1 排序   ← 使用队列配置
- M2队列中：按 5 排序   ← 使用甲方配置
- 未配置队列：按 5 排序 ← 使用甲方配置
```

---

## 🎨 界面设计

### 页面布局

```
┌──────────────────────────────────────────────────────────────┐
│  甲方自定义字段管理    [选择甲方 ▼]  [添加自定义字段]      │
├──────────┬───────────────────────────────────────────────────┤
│ 字段分组  │  字段列表（标准字段+自定义字段）                 │
│          │                                                   │
│ ▼ 基础身份│  📢 提示：标准字段可配置映射关系和排序；        │
│   └ 教育  │        自定义字段可完全编辑。支持拖拽排序       │
│   └ 职业  │                                                   │
│ ▼ 贷款详情│  ┌──────────────────────────────────────────┐  │
│ □ 分期详情│  │ ☰ │名称│标识│甲方标识│甲方ID│类型│...  │  │
│ □ 还款记录│  ├──────────────────────────────────────────┤  │
│          │  │ ☰ │用户编号│user_id│UID│001│String│标准│  │  │
│          │  │ ☰ │用户姓名│name│Name│002│String│标准│   │  │
│          │  │ ☰ │客户等级│level│Lv│101│Enum│自定义│   │  │
│          │  └──────────────────────────────────────────┘  │
└──────────┴───────────────────────────────────────────────────┘
```

### 视觉元素

#### 字段来源标识

```
标准字段：
┌─────────────────────────────────────────────┐
│ ☰ 用户编号 │ user_id │ UID │ ... │ 标准 │  │
│                                     ^^^^     │
│                               蓝色Tag，表示标准字段
└─────────────────────────────────────────────┘

自定义字段：
┌─────────────────────────────────────────────┐
│ ☰ 客户等级 │ level │ Lv │ ... │ 自定义 │   │
│                                   ^^^^^^     │
│                             绿色Tag，表示自定义字段
└─────────────────────────────────────────────┘
```

#### 删除按钮状态

```
标准字段：
[编辑]  [删除❌]  ← 删除按钮禁用（灰色）

自定义字段：
[编辑]  [删除✓]   ← 删除按钮可用（红色）
```

#### 拖拽交互

```
1. 悬停状态：
   ┌─────────────────────────────────┐
   │ ☰ │ 用户编号 │ ...              │
   │ ^                                │
   │ └─ 手柄变蓝色，鼠标变为 move     │
   └─────────────────────────────────┘

2. 拖拽中：
   ┌─────────────────────────────────┐
   │ [拖拽的行 - 浅蓝色背景]         │  ← 正在拖动
   │ ☰ │ 用户姓名 │ ...              │
   │                                  │
   │ [目标位置 - 虚线边框]           │  ← 将要放置的位置
   └─────────────────────────────────┘

3. 完成后：
   ✅ 排序已更新（提示消息）
   表格行自动重排
```

---

## 💻 前端实现

### 文件位置

```
frontend/src/views/field-config/CustomFields.vue
```

### 关键技术

1. **左右布局**
   ```vue
   <el-row :gutter="20">
     <el-col :span="5">
       <!-- 左侧：字段分组树 -->
       <el-tree ... />
     </el-col>
     <el-col :span="19">
       <!-- 右侧：字段表格 -->
       <el-table ... />
     </el-col>
   </el-row>
   ```

2. **拖拽排序**
   ```typescript
   import Sortable from 'sortablejs'
   
   sortableInstance = Sortable.create(table, {
     handle: '.drag-handle',
     animation: 150,
     onEnd: (evt) => {
       // 更新排序
       fields.value.forEach((field, index) => {
         field.sort_order = index + 1
       })
     }
   })
   ```

3. **Inline编辑**
   ```vue
   <el-table-column prop="tenant_field_key" label="甲方字段标识">
     <template #default="{ row }">
       <el-input 
         v-model="row.tenant_field_key"
         @change="handleFieldUpdate(row)"
       />
     </template>
   </el-table-column>
   ```

4. **字段来源Tag**
   ```vue
   <el-tag :type="row.field_source === 'standard' ? 'primary' : 'success'">
     {{ row.field_source === 'standard' ? '标准' : '自定义' }}
   </el-tag>
   ```

5. **条件禁用**
   ```vue
   <!-- 是否必填：标准字段不可编辑 -->
   <el-switch 
     v-model="row.is_required"
     :disabled="row.field_source === 'standard'"
   />
   
   <!-- 删除按钮：标准字段不可删除 -->
   <el-button 
     type="danger"
     :disabled="row.field_source === 'standard'"
   >
     删除
   </el-button>
   ```

### Mock数据示例

```typescript
fields.value = [
  {
    id: 1,
    field_name: '用户编号',
    field_key: 'user_id',
    tenant_field_key: 'UID',
    tenant_field_id: 'user_id_001',
    field_type: 'String',
    field_source: 'standard',      // ← 标准字段
    is_required: true,
    sort_order: 1,
    hidden_queues: []
  },
  {
    id: 101,
    field_name: '客户等级',
    field_key: 'customer_level',
    tenant_field_key: 'Level',
    tenant_field_id: 'level_101',
    field_type: 'Enum',
    field_source: 'custom',        // ← 自定义字段
    is_required: false,
    sort_order: 3,
    hidden_queues: [1]             // ← 在M1队列中隐藏
  }
]
```

---

## 🔧 后端实现要点

### 1. 新建甲方时继承标准字段

```python
from sqlalchemy import func
from app.models import Tenant, StandardField, TenantFieldConfig

def create_tenant_with_standard_fields(db, tenant_data):
    """创建甲方并自动继承所有标准字段"""
    
    # 1. 创建甲方
    tenant = Tenant(**tenant_data)
    db.add(tenant)
    db.flush()  # 获取tenant.id
    
    # 2. 加载所有标准字段
    standard_fields = db.query(StandardField).filter(
        StandardField.is_active == True
    ).all()
    
    # 3. 为甲方创建字段配置（继承排序）
    for field in standard_fields:
        tenant_config = TenantFieldConfig(
            tenant_id=tenant.id,
            field_id=field.id,
            field_type='standard',
            sort_order=field.sort_order,  # 🔑 快照继承
            is_enabled=True,
            is_required=field.is_required,  # 继承必填设置
            is_visible=True
        )
        db.add(tenant_config)
    
    db.commit()
    return tenant
```

### 2. 新增标准字段时自动添加到所有甲方

```python
def add_standard_field_to_all_tenants(db, field_id):
    """新增标准字段时，自动添加到所有甲方（排在最后）"""
    
    # 1. 获取所有活跃甲方
    tenants = db.query(Tenant).filter(Tenant.is_active == True).all()
    
    # 2. 获取新字段信息
    new_field = db.query(StandardField).filter(
        StandardField.id == field_id
    ).first()
    
    if not new_field:
        raise ValueError("字段不存在")
    
    # 3. 为每个甲方添加该字段配置
    for tenant in tenants:
        # 获取该甲方当前最大排序
        max_sort_order = db.query(func.max(TenantFieldConfig.sort_order))\
            .filter(TenantFieldConfig.tenant_id == tenant.id)\
            .scalar() or 0
        
        # 创建字段配置（排在最后）
        tenant_config = TenantFieldConfig(
            tenant_id=tenant.id,
            field_id=field_id,
            field_type='standard',
            sort_order=max_sort_order + 1,  # 🔑 排在最后
            is_enabled=True,
            is_required=new_field.is_required
        )
        db.add(tenant_config)
    
    db.commit()
```

### 3. 获取甲方字段列表（含映射）

```python
@router.get("/{tenant_id}/fields")
def get_tenant_fields(
    tenant_id: int,
    field_group_id: Optional[int] = None,
    db: Session = Depends(get_db)
):
    """获取甲方的所有字段（标准+自定义）"""
    
    # 查询甲方字段配置（包含标准字段）
    query = db.query(
        TenantFieldConfig,
        StandardField
    ).outerjoin(
        StandardField,
        and_(
            TenantFieldConfig.field_id == StandardField.id,
            TenantFieldConfig.field_type == 'standard'
        )
    ).filter(
        TenantFieldConfig.tenant_id == tenant_id
    )
    
    if field_group_id:
        query = query.filter(StandardField.field_group_id == field_group_id)
    
    # 按sort_order排序
    query = query.order_by(TenantFieldConfig.sort_order)
    
    results = []
    for config, field in query.all():
        if config.field_type == 'standard':
            # 标准字段：使用StandardField + 映射信息
            results.append({
                'id': config.id,
                'field_name': field.field_name,
                'field_key': field.field_key,
                'tenant_field_key': config.tenant_field_key,  # 映射
                'tenant_field_id': config.tenant_field_id,    # 映射
                'field_type': field.field_type,
                'field_source': 'standard',
                'is_required': field.is_required,  # 标准字段的必填设置
                'sort_order': config.sort_order,
                'hidden_queues': []  # TODO: 从queue_field_configs查询
            })
        else:
            # 自定义字段：从custom_fields查询
            custom_field = db.query(CustomField).filter(
                CustomField.id == config.field_id
            ).first()
            
            results.append({
                'id': config.id,
                'field_name': custom_field.field_name,
                'field_key': custom_field.field_key,
                'tenant_field_key': config.tenant_field_key,
                'tenant_field_id': config.tenant_field_id,
                'field_type': custom_field.field_type,
                'field_source': 'custom',
                'is_required': config.is_required,  # 自定义字段的必填设置
                'sort_order': config.sort_order,
                'hidden_queues': []
            })
    
    return {'data': results}
```

### 4. 更新字段排序

```python
@router.put("/{tenant_id}/fields/sort")
def update_field_sort_order(
    tenant_id: int,
    sort_data: List[dict],  # [{'id': 1, 'sort_order': 1}, ...]
    db: Session = Depends(get_db)
):
    """批量更新字段排序"""
    
    for item in sort_data:
        config = db.query(TenantFieldConfig).filter(
            TenantFieldConfig.id == item['id'],
            TenantFieldConfig.tenant_id == tenant_id
        ).first()
        
        if config:
            config.sort_order = item['sort_order']
    
    db.commit()
    return {'message': '排序已更新'}
```

---

## 📝 设计文档更新

### 文件位置

```
CCO字段配置系统设计.md
```

### 更新内容

1. **版本历史（第3-24行）**
   - 新增 v2.1.0 版本说明
   - 添加甲方字段管理重构的核心变更
   - 添加排序规则系统说明

2. **甲方字段配置页面（第1050-1283行）**
   - 完全重写页面设计
   - 添加详细的表格列定义
   - 添加交互规则说明
   - 添加排序规则详细说明
   - 添加代码实现要点
   - 添加数据流示例

---

## ✅ 实现清单

### 已完成

- [x] 需求分析和设计
- [x] 设计文档更新（版本历史）
- [x] 设计文档更新（页面详细设计）
- [x] 前端页面重构（CustomFields.vue）
- [x] 左右布局实现
- [x] 字段分组树实现
- [x] 表格列调整
- [x] 字段来源标识
- [x] 拖拽排序功能
- [x] Inline编辑功能
- [x] 队列可见性配置UI
- [x] 添加自定义字段对话框
- [x] 编辑字段对话框
- [x] Mock数据示例
- [x] 样式优化

### 待实现（后端）

- [ ] 新建甲方时继承标准字段的逻辑
- [ ] 新增标准字段时自动添加到所有甲方
- [ ] 获取甲方字段列表API（含映射信息）
- [ ] 更新字段映射关系API
- [ ] 更新字段排序API
- [ ] 创建自定义字段API
- [ ] 更新自定义字段API
- [ ] 删除自定义字段API
- [ ] 队列可见性配置API
- [ ] 数据库迁移脚本

### 待实现（前端）

- [ ] 连接真实API（替换Mock数据）
- [ ] 搜索字段功能
- [ ] 批量导入映射配置
- [ ] 导出映射配置
- [ ] 更多的表单验证
- [ ] 错误处理优化
- [ ] 加载状态优化

---

## 🧪 测试场景

### 场景1：新建甲方

```
步骤：
1. 进入甲方管理页面
2. 点击"添加甲方"
3. 填写甲方信息（名称、编码等）
4. 点击保存

预期结果：
✅ 甲方创建成功
✅ 自动创建所有标准字段的配置记录
✅ 继承标准字段的当前排序
✅ 在甲方字段管理页面可以看到所有标准字段
✅ 所有字段均可正常配置映射关系
```

### 场景2：配置字段映射

```
步骤：
1. 进入甲方自定义字段管理页面
2. 选择甲方"银行A"
3. 选择分组"基础身份信息"
4. 找到字段"用户编号"
5. 在"甲方字段标识"列输入"UID"
6. 在"甲方字段ID"列输入"user_id_001"
7. 点击其他地方（失焦触发保存）

预期结果：
✅ 显示"已更新"提示
✅ 刷新页面后映射关系仍然存在
✅ 该甲方在数据同步时使用新的映射关系
```

### 场景3：拖拽调整排序

```
步骤：
1. 选择甲方"银行A"
2. 选择分组"基础身份信息"
3. 将"性别"字段拖拽到"用户编号"上方
4. 释放鼠标

预期结果：
✅ 表格行即时重排
✅ 显示"排序已更新"提示
✅ 排序列数字自动更新（性别=1，用户编号=2...）
✅ 刷新页面后排序保持不变
✅ 其他甲方的排序不受影响
```

### 场景4：添加自定义字段

```
步骤：
1. 选择甲方"银行A"
2. 点击"添加自定义字段"
3. 填写字段信息：
   - 字段名称：客户等级
   - 字段标识：customer_level
   - 甲方字段标识：Level
   - 字段类型：Enum
   - 所属分组：基础身份信息
   - 是否必填：是
4. 点击保存

预期结果：
✅ 自定义字段创建成功
✅ 在表格中显示，来源标识为"自定义"（绿色Tag）
✅ 可以完全编辑该字段
✅ 可以删除该字段
✅ 只有该甲方能看到此自定义字段
```

### 场景5：配置队列可见性

```
步骤：
1. 选择甲方"银行A"
2. 找到字段"客户等级"
3. 点击"配置队列"按钮
4. 勾选"M1队列"
5. 点击保存

预期结果：
✅ 配置保存成功
✅ 在M1队列的案件详情页中，"客户等级"字段隐藏
✅ 在M2、M3+队列中，"客户等级"字段正常显示
```

### 场景6：标准字段不可删除

```
步骤：
1. 选择任意甲方
2. 找到任意标准字段（蓝色"标准"Tag）
3. 查看"删除"按钮状态

预期结果：
✅ "删除"按钮显示为禁用状态（灰色）
✅ 鼠标悬停显示提示："标准字段不能删除"
✅ 点击无响应
```

### 场景7：新增标准字段自动同步

```
步骤：
1. 管理员在"标准字段管理"中新增字段"年龄"
2. 进入"甲方自定义字段管理"
3. 选择任意甲方

预期结果：
✅ 所有甲方都自动增加了"年龄"字段
✅ 该字段排在所有现有字段的最后
✅ 甲方可以调整该字段的排序
✅ 甲方可以配置映射关系
```

---

## 🎓 使用指南

### 甲方管理员操作流程

```
┌─────────────────────────────────────────────────────────────┐
│  1️⃣ 初次配置                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 登录系统                                                │
│  2. 进入：字段配置 → 甲方自定义字段管理                    │
│  3. 选择自己的甲方                                          │
│  4. 查看所有继承的标准字段                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  2️⃣ 配置字段映射                                            │
├─────────────────────────────────────────────────────────────┤
│  1. 逐个字段配置"甲方字段标识"和"甲方字段ID"               │
│  2. 示例：                                                  │
│     - 系统字段：user_id                                     │
│     - 甲方字段标识：UID                                     │
│     - 甲方字段ID：user_id_001                               │
│  3. 配置完成后，数据同步时会自动映射                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  3️⃣ 调整字段顺序                                            │
├─────────────────────────────────────────────────────────────┤
│  1. 将鼠标移到字段行的拖拽手柄（☰）                        │
│  2. 按住鼠标左键拖动                                        │
│  3. 释放到目标位置                                          │
│  4. 系统自动保存新排序                                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  4️⃣ 添加自定义字段                                          │
├─────────────────────────────────────────────────────────────┤
│  1. 点击"添加自定义字段"按钮                                │
│  2. 填写字段信息（名称、标识、类型等）                      │
│  3. 选择所属分组                                            │
│  4. 设置是否必填                                            │
│  5. 点击保存                                                │
│  6. 新字段出现在列表中，可以拖拽调整位置                    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  5️⃣ 配置队列可见性                                          │
├─────────────────────────────────────────────────────────────┤
│  1. 找到需要配置的字段                                      │
│  2. 点击"配置队列"按钮                                      │
│  3. 勾选需要隐藏该字段的队列                                │
│  4. 点击保存                                                │
│  5. 该字段在选中的队列中将不显示                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 📚 相关文档

- `CCO字段配置系统设计.md` - 系统设计文档
- `frontend/src/views/field-config/CustomFields.vue` - 前端实现
- `frontend/拖拽功能修复说明.md` - 拖拽功能说明
- `frontend/标准字段拖拽排序功能说明.md` - 标准字段拖拽说明

---

## 💡 技术亮点

1. **统一的字段管理中心**
   - 一个页面管理标准字段映射和自定义字段
   - 清晰的字段来源标识
   - 减少用户认知负担

2. **灵活的排序继承机制**
   - 新甲方自动继承标准字段排序
   - 甲方调整后独立，不受系统影响
   - 新字段自动追加，不破坏现有顺序

3. **友好的拖拽交互**
   - 直观的拖拽手柄
   - 实时视觉反馈
   - 自动保存

4. **细粒度的权限控制**
   - 标准字段只能配置映射，不能删除
   - 自定义字段完全控制权
   - 队列级别的可见性配置

5. **Inline编辑提升效率**
   - 甲方字段标识直接在表格中编辑
   - 失焦自动保存
   - 减少弹窗操作

---

**最后更新：** 2024-11-11  
**文档版本：** 1.0  
**状态：** ✅ 已完成

